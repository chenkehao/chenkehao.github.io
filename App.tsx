
import React, { useState, useMemo, useEffect, useRef, useCallback } from 'react';
import { HashRouter as Router, Routes, Route, Link, useParams, useNavigate, useLocation, Outlet } from 'react-router-dom';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import { 
  Users, Briefcase, Zap, ShieldCheck, 
  BarChart3, Plus, Sparkles, FileText, 
  CheckCircle2, Clock, TrendingUp, Users2, ArrowRight, Search, X,
  BrainCircuit, MessageCircleQuestion, Lightbulb, GraduationCap, ChevronLeft, Calendar,
  Download, Map, Send, Bot, User as UserIcon, Award, Globe, LineChart, Target, BookOpen, Lock, Mail, Github,
  Smartphone, ShieldEllipsis, MessageSquare, ExternalLink, Phone, MapPin, Share2, Loader2, Rocket, Terminal, Play, Square, Activity,
  Cpu, Coins, Fingerprint, Building2, Building, Layers, Eye, Compass, Info, Heart, LayoutDashboard, Settings, PieChart, CheckSquare, ListTodo, PenTool,
  History, Timer, ClipboardCheck, Filter, ChevronRight, ChevronDown, UserCircle2, Database, AlertCircle, Sparkle, Eraser, Milestone, Brain, Pin, Trash2, Edit3, Save, CreditCard, ArrowUpRight, TrendingDown, Wallet, Key, UserPlus, ShieldAlert, Laptop, Bell, Verified, Medal, Trophy, Landmark, CircleDollarSign, Gem, CreditCard as CreditCardIcon, Github as GithubIcon, MessageCircle, Tag, Instagram, Twitter, RotateCcw, GitBranch, ArrowRightCircle, Upload, Code, PlusCircle, Wand2, Link2, Linkedin, Gift, FileCheck, Moon, Sun, Inbox, AlertTriangle, Paperclip, Scan, IdCard, Camera, ImageIcon, CheckCircle, XCircle, Car, BadgeCheck,
  Settings2, Check, Shield, Star, Wrench,
  ScrollText, RefreshCw, Pencil, ArrowLeftRight, Pause, Menu
} from 'lucide-react';
import { analyzeResume, chatWithInterviewer } from './services/geminiService';
import { CandidateProfile, Job, SkillGap, AgentFeedback, AccountTier, TeamMember, CustomLLMConfig } from './types';
import RadarChart from './components/RadarChart';
import { 
  useRecommendedJobs, usePublicJobs, useFlows, useFlowStats, useFlow, useTalents, 
  useTokenStats, useQualifications, useMemories, useTodos, useTasks, useProfile 
} from './hooks/useApiData';
import { 
  createMemory, 
  chatWithAI, 
  updateUser, 
  changePassword,
  uploadAvatar,
  getSettings,
  updateSettings,
  getEnterpriseCertifications,
  getPersonalCertifications,
  getTeamMembers,
  inviteTeamMember,
  deleteTeamMember,
  transferAdmin,
  approveMember,
  getAIConfigs,
  createAIConfig,
  deleteAIConfig,
  getAPIKeys,
  createAPIKey,
  deleteAPIKey,
  toggleAPIKey,
  regenerateAPIKey,
  getAPIKeyUsage,
  getWebhooks,
  createWebhook,
  updateWebhook,
  deleteWebhook,
  testWebhook,
  getAuditLogs,
  getAuditLogStats,
  exportAuditLogs,
  getAccountTier,
  getMyJobs,
  deleteJob,
  updateJob,
  getJobDetail,
  upgradeAccountTier
} from './services/apiService';
import { AuthProvider, useAuth } from './contexts/AuthContext';
import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';

// åç«¯å­˜å‚¨ UTC æ—¶é—´ä½† isoformat() ä¸å¸¦ Z åç¼€ï¼Œéœ€è¦è¡¥ä¸Šè®©æµè§ˆå™¨æ­£ç¡®è½¬ä¸ºæœ¬åœ°æ—¶é—´
const parseUTC = (dateStr: string | null | undefined): Date => {
  if (!dateStr) return new Date(0);
  // å¦‚æœå·²ç»æœ‰ Z æˆ–æ—¶åŒºåç§»åˆ™ç›´æ¥è§£æ
  if (dateStr.endsWith('Z') || /[+-]\d{2}:\d{2}$/.test(dateStr)) return new Date(dateStr);
  // å¦åˆ™è¡¥ä¸Š Z æ ‡è®°ä¸º UTC
  return new Date(dateStr + 'Z');
};

interface TimelineItem {
  time: string;
  action: string;
  agent: string;
  tokens: number;
}

interface FlowData {
  id: number;
  candidate: string;
  candidateAvatar?: string;
  job: string;
  company: string;
  salary: string;
  location: string;
  tags: string[];
  description: string;
  status: string;
  matchScore: number;
  lastAction: string;
  nodes: string[];
  currentStep: number;
  tokensConsumed: number;
  stage: string;
  nextAction: string;
  nextSchedule: string;
  agents: string[];
  details: string;
  timeline: TimelineItem[];
}

const MOCK_FLOW_DATA: FlowData[] = [
  { 
    id: 1, 
    candidate: 'é™ˆä¼Ÿ', 
    job: 'é«˜çº§ AI å·¥ç¨‹å¸ˆ', 
    company: 'å¾—è‹¥æ™ºèƒ½ç§‘æŠ€',
    salary: 'Â¥50k - Â¥80k',
    location: 'ä¸Šæµ· (è¿œç¨‹)',
    tags: ['ç”Ÿæˆå¼ AI', 'Python', 'æ™ºèƒ½ä½“ååŒ'],
    description: 'è´Ÿè´£å¤šæ™ºèƒ½ä½“ç¼–æ’ç³»ç»Ÿçš„æ ¸å¿ƒç ”å‘ï¼Œæ„å»ºé«˜æ•ˆçš„äººæœºåä½œå·¥ä½œæµã€‚',
    status: 'é¢è¯•ä¸­', 
    matchScore: 98, 
    lastAction: 'AI é¢è¯•å®å½•ç”Ÿæˆ', 
    nodes: ['è§£æ', 'å¯¹æ ‡', 'åˆè¯•', 'å¤è¯•'], 
    currentStep: 3,
    tokensConsumed: 45200,
    stage: 'åˆè¯•é˜¶æ®µ',
    nextAction: 'ç­‰å¾…é¢è¯•å®˜åé¦ˆ',
    nextSchedule: '2026-02-18 14:00',
    agents: ['ç®€å†è§£ææ™ºèƒ½ä½“', 'é¢è¯•è¯„ä¼°æ™ºèƒ½ä½“'],
    details: 'å€™é€‰äººå·²å®ŒæˆæŠ€æœ¯åˆè¯•ï¼ŒAI é¢è¯•å®˜ç”Ÿæˆäº†è¯¦ç»†çš„é¢è¯•è¯„ä¼°æŠ¥å‘Šï¼ŒåŒ…æ‹¬æŠ€æœ¯èƒ½åŠ›ã€é¡¹ç›®ç»éªŒã€ç®—æ³•æ€ç»´ç­‰å¤šä¸ªç»´åº¦çš„è¯„åˆ†ã€‚ç›®å‰ç­‰å¾…ä¼ä¸šé¢è¯•å®˜è¿›è¡Œäººå·¥å¤æ ¸ã€‚',
    timeline: [
      { time: '2026-02-03 09:00', action: 'ç®€å†è§£æå®Œæˆ', agent: 'ç®€å†è§£ææ™ºèƒ½ä½“', tokens: 5200 },
      { time: '2026-02-03 09:15', action: 'å¤šç»´ç”»åƒæ„å»º', agent: 'ç”»åƒæ„å»ºæ™ºèƒ½ä½“', tokens: 3800 },
      { time: '2026-02-03 10:00', action: 'å²—ä½åŒ¹é…åˆ†æ', agent: 'åŒ¹é…è¯„ä¼°æ™ºèƒ½ä½“', tokens: 4500 },
      { time: '2026-02-04 14:00', action: 'AI æ¨¡æ‹Ÿé¢è¯•', agent: 'é¢è¯•è¯„ä¼°æ™ºèƒ½ä½“', tokens: 12500 },
      { time: '2026-02-05 16:00', action: 'é¢è¯•å®å½•ç”Ÿæˆ', agent: 'é¢è¯•è¯„ä¼°æ™ºèƒ½ä½“', tokens: 8200 },
      { time: '2026-02-08 10:00', action: 'è¿›å…¥åˆè¯•é˜¶æ®µ', agent: 'è·¯ç”±è°ƒåº¦æ™ºèƒ½ä½“', tokens: 2100 },
    ]
  },
  { 
    id: 2, 
    candidate: 'æèŠ³', 
    job: 'äº§å“è®¾è®¡ä¸»ç®¡', 
    company: 'Nexus åˆ›æ„å®éªŒå®¤',
    salary: 'Â¥40k - Â¥65k',
    location: 'åŒ—äº¬',
    tags: ['Figma', 'UX ç­–ç•¥', 'äººæœºäº¤äº’'],
    description: 'å¡‘é€ æœªæ¥äººæœºåä½œç•Œé¢ï¼Œå¼•é¢†è®¾è®¡å›¢é˜Ÿåˆ›æ–°ã€‚',
    status: 'å¾…å®¡æ ¸', 
    matchScore: 82, 
    lastAction: 'ç”»åƒå¤šç»´å¯¹æ¯”å®Œæˆ', 
    nodes: ['è§£æ', 'å¯¹æ ‡'], 
    currentStep: 2,
    tokensConsumed: 32100,
    stage: 'å¯¹æ ‡é˜¶æ®µ',
    nextAction: 'ç­‰å¾… HR ç¡®è®¤å¯¹æ ‡ç»“æœ',
    nextSchedule: '2026-02-17 11:00',
    agents: ['ç®€å†è§£ææ™ºèƒ½ä½“', 'å¸‚åœºåˆ†ææ™ºèƒ½ä½“'],
    details: 'å€™é€‰äººç®€å†å·²è§£æå®Œæˆï¼ŒAI å®Œæˆäº†å€™é€‰äººä¸ç›®æ ‡å²—ä½çš„å¤šç»´åº¦å¯¹æ¯”åˆ†æã€‚ç›®å‰ç³»ç»Ÿæ­£åœ¨ç­‰å¾… HR ç¡®è®¤å¯¹æ ‡ç»“æœï¼Œä»¥å†³å®šæ˜¯å¦æ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µã€‚',
    timeline: [
      { time: '2026-02-05 10:00', action: 'ç®€å†è§£æå®Œæˆ', agent: 'ç®€å†è§£ææ™ºèƒ½ä½“', tokens: 4800 },
      { time: '2026-02-05 10:30', action: 'å¸‚åœºè–ªèµ„å¯¹æ ‡', agent: 'å¸‚åœºåˆ†ææ™ºèƒ½ä½“', tokens: 6200 },
      { time: '2026-02-05 14:00', action: 'èƒ½åŠ›ç”»åƒå¯¹æ¯”', agent: 'ç”»åƒæ„å»ºæ™ºèƒ½ä½“', tokens: 5500 },
      { time: '2026-02-06 09:00', action: 'ç»¼åˆè¯„ä¼°æŠ¥å‘Š', agent: 'åŒ¹é…è¯„ä¼°æ™ºèƒ½ä½“', tokens: 4100 },
      { time: '2026-02-06 16:00', action: 'å¾… HR å®¡æ ¸', agent: 'è·¯ç”±è°ƒåº¦æ™ºèƒ½ä½“', tokens: 1500 },
    ]
  },
  { 
    id: 3, 
    candidate: 'å¼ å¼º', 
    job: 'åç«¯æ¶æ„å¸ˆ', 
    company: 'å¾—è‹¥æ™ºèƒ½ç§‘æŠ€',
    salary: 'Â¥55k - Â¥85k',
    location: 'æ­å·',
    tags: ['åˆ†å¸ƒå¼ç³»ç»Ÿ', 'Go', 'å¾®æœåŠ¡'],
    description: 'è®¾è®¡å¹¶å®ç°é«˜å¯ç”¨çš„åˆ†å¸ƒå¼æœåŠ¡æ¶æ„ã€‚',
    status: 'åˆç­›æˆåŠŸ', 
    matchScore: 75, 
    lastAction: 'Agent è·¯ç”±åˆ†å‘æˆåŠŸ', 
    nodes: ['è§£æ'], 
    currentStep: 1,
    tokensConsumed: 18500,
    stage: 'è§£æé˜¶æ®µ',
    nextAction: 'å®‰æ’æŠ€æœ¯é¢è¯•',
    nextSchedule: '2026-02-19 10:00',
    agents: ['ç®€å†è§£ææ™ºèƒ½ä½“'],
    details: 'å€™é€‰äººç®€å†å·²æˆåŠŸè§£æå¹¶é€šè¿‡åˆç­›ã€‚AI å®Œæˆäº†åŸºç¡€çš„èƒ½åŠ›è¯„ä¼°ï¼Œç›®å‰ç³»ç»Ÿå·²å°†ä»»åŠ¡åˆ†é…ç»™å¯¹åº”çš„æ‹›è˜æµç¨‹ï¼Œç­‰å¾…ä¸‹ä¸€æ­¥æŠ€æœ¯é¢è¯•çš„å®‰æ’ã€‚',
    timeline: [
      { time: '2026-02-07 08:00', action: 'ç®€å†ä¸Šä¼ ', agent: 'ç³»ç»Ÿ', tokens: 0 },
      { time: '2026-02-07 08:10', action: 'ç®€å†è§£æå®Œæˆ', agent: 'ç®€å†è§£ææ™ºèƒ½ä½“', tokens: 6500 },
      { time: '2026-02-07 09:00', action: 'åˆç­›é€šè¿‡', agent: 'ç­›é€‰è¯„ä¼°æ™ºèƒ½ä½“', tokens: 4200 },
      { time: '2026-02-07 09:30', action: 'è·¯ç”±åˆ†å‘æˆåŠŸ', agent: 'è·¯ç”±è°ƒåº¦æ™ºèƒ½ä½“', tokens: 2800 },
    ]
  },
  { 
    id: 4, 
    candidate: 'ç‹æ•', 
    job: 'ç®—æ³•ç ”ç©¶å‘˜', 
    company: 'å¾—è‹¥æ™ºèƒ½ç§‘æŠ€',
    salary: 'Â¥70k - Â¥120k',
    location: 'æ·±åœ³',
    tags: ['å¤§æ¨¡å‹', 'NLP', 'æ·±åº¦å­¦ä¹ '],
    description: 'ä»äº‹å¤§è¯­è¨€æ¨¡å‹çš„ç ”ç©¶ä¸è½åœ°åº”ç”¨ã€‚',
    status: 'Offer', 
    matchScore: 94, 
    lastAction: 'è–ªèµ„è‡ªåŠ¨å¯¹æ ‡é€šè¿‡', 
    nodes: ['è§£æ', 'å¯¹æ ‡', 'åˆè¯•', 'å¤è¯•'], 
    currentStep: 4,
    tokensConsumed: 78500,
    stage: 'å®Œæˆé˜¶æ®µ',
    nextAction: 'å‘æ”¾ Offer é€šçŸ¥',
    nextSchedule: '2026-02-20 09:00',
    agents: ['ç®€å†è§£ææ™ºèƒ½ä½“', 'é¢è¯•è¯„ä¼°æ™ºèƒ½ä½“', 'å¸‚åœºåˆ†ææ™ºèƒ½ä½“', 'è·¯ç”±è°ƒåº¦æ™ºèƒ½ä½“'],
    details: 'å€™é€‰äººå·²å®Œæˆæ‰€æœ‰é¢è¯•æµç¨‹ï¼Œç»¼åˆè¯„ä¼°ç»“æœä¼˜ç§€ã€‚AI è‡ªåŠ¨å®Œæˆäº†è–ªèµ„å¯¹æ ‡åˆ†æï¼Œå¹¶ç”Ÿæˆäº†è¯¦ç»†çš„ Offer å»ºè®®ã€‚ç›®å‰ç­‰å¾…ä¼ä¸šå‘æ”¾æ­£å¼ Offerã€‚',
    timeline: [
      { time: '2026-01-20 10:00', action: 'ç®€å†è§£æå®Œæˆ', agent: 'ç®€å†è§£ææ™ºèƒ½ä½“', tokens: 5800 },
      { time: '2026-01-20 11:00', action: 'å¸‚åœºè–ªèµ„å¯¹æ ‡', agent: 'å¸‚åœºåˆ†ææ™ºèƒ½ä½“', tokens: 7500 },
      { time: '2026-01-21 14:00', action: 'AI åˆè¯•å®Œæˆ', agent: 'é¢è¯•è¯„ä¼°æ™ºèƒ½ä½“', tokens: 15200 },
      { time: '2026-01-23 10:00', action: 'AI å¤è¯•å®Œæˆ', agent: 'é¢è¯•è¯„ä¼°æ™ºèƒ½ä½“', tokens: 18500 },
      { time: '2026-02-05 16:00', action: 'ç»¼åˆè¯„ä¼°å®Œæˆ', agent: 'åŒ¹é…è¯„ä¼°æ™ºèƒ½ä½“', tokens: 9500 },
      { time: '2026-02-06 14:00', action: 'è–ªèµ„å¯¹æ ‡é€šè¿‡', agent: 'å¸‚åœºåˆ†ææ™ºèƒ½ä½“', tokens: 6200 },
    ]
  },
  { 
    id: 5, 
    candidate: 'èµµç£Š', 
    job: 'å‰ç«¯å·¥ç¨‹ä¸»ç®¡', 
    company: 'æå®¢ç§‘æŠ€',
    salary: 'Â¥45k - Â¥70k',
    location: 'ä¸Šæµ·',
    tags: ['React', 'TypeScript', 'å·¥ç¨‹åŒ–'],
    description: 'å¸¦é¢†å‰ç«¯å›¢é˜Ÿæ„å»ºä¸‹ä¸€ä»£ Web åº”ç”¨ã€‚',
    status: 'è¯„ä¼°ä¸­', 
    matchScore: 88, 
    lastAction: 'ä»£ç é€»è¾‘æ‰«æå®Œæˆ', 
    nodes: ['è§£æ', 'å¯¹æ ‡'], 
    currentStep: 2,
    tokensConsumed: 38400,
    stage: 'å¯¹æ ‡é˜¶æ®µ',
    nextAction: 'å®ŒæˆæŠ€æœ¯èƒ½åŠ›è¯„ä¼°',
    nextSchedule: '2026-02-18 09:00',
    agents: ['ç®€å†è§£ææ™ºèƒ½ä½“', 'æŠ€æœ¯è¯„ä¼°æ™ºèƒ½ä½“'],
    details: 'å€™é€‰äººç®€å†å·²è§£æå®Œæˆï¼ŒAI æ­£åœ¨è¿›è¡Œæ·±åº¦çš„æŠ€æœ¯èƒ½åŠ›è¯„ä¼°ã€‚ä»£ç é€»è¾‘æ‰«æå·²å®Œæˆï¼Œç›®å‰æ­£åœ¨è¿›è¡ŒæŠ€æœ¯èƒ½åŠ›ç»¼åˆè¯„ä¼°ã€‚',
    timeline: [
      { time: '2026-02-06 11:00', action: 'ç®€å†è§£æå®Œæˆ', agent: 'ç®€å†è§£ææ™ºèƒ½ä½“', tokens: 5100 },
      { time: '2026-02-06 14:00', action: 'GitHub é¡¹ç›®æ‰«æ', agent: 'æŠ€æœ¯è¯„ä¼°æ™ºèƒ½ä½“', tokens: 8900 },
      { time: '2026-02-07 10:00', action: 'ä»£ç é€»è¾‘æ‰«æ', agent: 'æŠ€æœ¯è¯„ä¼°æ™ºèƒ½ä½“', tokens: 11200 },
      { time: '2026-02-08 09:00', action: 'æŠ€æœ¯èƒ½åŠ›ç”»åƒ', agent: 'ç”»åƒæ„å»ºæ™ºèƒ½ä½“', tokens: 7200 },
    ]
  },
  { 
    id: 6, 
    candidate: 'å­™å€©', 
    job: 'æ•°æ®ç§‘å­¦å®¶', 
    company: 'æ•°æ®æ™ºèƒ½æœ‰é™å…¬å¸',
    salary: 'Â¥35k - Â¥60k',
    location: 'åŒ—äº¬',
    tags: ['Python', 'æœºå™¨å­¦ä¹ ', 'æ•°æ®åˆ†æ'],
    description: 'åˆ©ç”¨æ•°æ®é©±åŠ¨ä¸šåŠ¡å¢é•¿ï¼Œæ„å»ºæ™ºèƒ½æ¨èç³»ç»Ÿã€‚',
    status: 'å¾…çº¦é¢', 
    matchScore: 91, 
    lastAction: 'å€™é€‰äººæ„å‘ç¡®è®¤', 
    nodes: ['è§£æ', 'å¯¹æ ‡', 'åˆè¯•'], 
    currentStep: 3,
    tokensConsumed: 52300,
    stage: 'åˆè¯•é˜¶æ®µ',
    nextAction: 'ç¡®è®¤é¢è¯•æ—¶é—´',
    nextSchedule: '2026-02-17 15:00',
    agents: ['ç®€å†è§£ææ™ºèƒ½ä½“', 'é¢è¯•è¯„ä¼°æ™ºèƒ½ä½“', 'æ²Ÿé€šåè°ƒæ™ºèƒ½ä½“'],
    details: 'å€™é€‰äººå·²å®Œæˆæ„å‘ç¡®è®¤ï¼ŒAI å·²ä¸å€™é€‰äººæ²Ÿé€šç¡®è®¤é¢è¯•æ„æ„¿ã€‚ç›®å‰æ­£åœ¨åè°ƒé¢è¯•å®˜æ—¶é—´ï¼Œç­‰å¾…æœ€ç»ˆé¢è¯•æ—¶é—´ç¡®è®¤ã€‚',
    timeline: [
      { time: '2026-02-04 09:00', action: 'ç®€å†è§£æå®Œæˆ', agent: 'ç®€å†è§£ææ™ºèƒ½ä½“', tokens: 4900 },
      { time: '2026-02-04 10:30', action: 'å¸‚åœºè–ªèµ„å¯¹æ ‡', agent: 'å¸‚åœºåˆ†ææ™ºèƒ½ä½“', tokens: 5800 },
      { time: '2026-02-05 14:00', action: 'AI åˆè¯•é¢„çº¦', agent: 'æ²Ÿé€šåè°ƒæ™ºèƒ½ä½“', tokens: 4200 },
      { time: '2026-02-06 11:00', action: 'å€™é€‰äººæ„å‘ç¡®è®¤', agent: 'æ²Ÿé€šåè°ƒæ™ºèƒ½ä½“', tokens: 2800 },
    ]
  },
];

// --- æ¨¡æ‹Ÿæ•°æ® ---
const MOCK_JOBS: Job[] = [
  {
    id: '1',
    title: 'é«˜çº§ AI å·¥ç¨‹å¸ˆ',
    company: 'å¾—è‹¥æ™ºèƒ½ç§‘æŠ€',
    location: 'ä¸Šæµ· (è¿œç¨‹)',
    salary: 'Â¥50k - Â¥80k',
    matchScore: 98,
    tags: ['ç”Ÿæˆå¼ AI', 'Python', 'æ™ºèƒ½ä½“ååŒ'],
    description: 'è´Ÿè´£å¤šæ™ºèƒ½ä½“ç¼–æ’ç³»ç»Ÿçš„æ ¸å¿ƒç ”å‘ã€‚'
  },
  {
    id: '2',
    title: 'äº§å“è®¾è®¡ä¸»ç®¡',
    company: 'Nexus åˆ›æ„å®éªŒå®¤',
    location: 'åŒ—äº¬',
    salary: 'Â¥40k - Â¥65k',
    matchScore: 82,
    tags: ['Figma', 'UX ç­–ç•¥', 'äººæœºäº¤äº’'],
    description: 'å¡‘é€ æœªæ¥äººæœºåä½œç•Œé¢ã€‚'
  },
  {
    id: '3',
    title: 'å…¨æ ˆå¼€å‘ä¸“å®¶ (Rust/React)',
    company: 'å¾—è‹¥æ™ºèƒ½ç§‘æŠ€',
    location: 'æ­å·',
    salary: 'Â¥45k - Â¥70k',
    matchScore: 92,
    tags: ['Rust', 'é«˜æ€§èƒ½è®¡ç®—', 'å‰ç«¯å·¥ç¨‹åŒ–'],
    description: 'æ‰“é€ æé€Ÿå“åº”çš„æ™ºèƒ½ä½“äº¤äº’ç»ˆç«¯ã€‚'
  },
  {
    id: '4',
    title: 'å¤§æ¨¡å‹ç®—æ³•ç§‘å­¦å®¶',
    company: 'å¾—è‹¥æ™ºèƒ½ç§‘æŠ€',
    location: 'æ·±åœ³',
    salary: 'Â¥70k - Â¥120k',
    matchScore: 85,
    tags: ['NLP', 'Transformer', 'æ¨¡å‹å¾®è°ƒ'],
    description: 'æ·±è€•å‚åŸŸæ¨¡å‹æ€§èƒ½è¾¹ç•Œã€‚'
  },
  {
    id: '5',
    title: 'AI è§£å†³æ–¹æ¡ˆæ¶æ„å¸ˆ',
    company: 'å¾—è‹¥æ™ºèƒ½ç§‘æŠ€',
    location: 'å…¨çƒè¿œç¨‹',
    salary: 'Â¥55k - Â¥90k',
    matchScore: 88,
    tags: ['Bç«¯èµ‹èƒ½', 'SAAS', 'æ•°å­—åŒ–è½¬å‹'],
    description: 'è¿æ¥æŠ€æœ¯å®ç°ä¸å•†ä¸šè½åœ°ã€‚'
  },
  {
    id: '6',
    title: 'èµ„æ·± DevOps å·¥ç¨‹å¸ˆ',
    company: 'å¾—è‹¥æ™ºèƒ½ç§‘æŠ€',
    location: 'æˆéƒ½',
    salary: 'Â¥35k - Â¥55k',
    matchScore: 78,
    tags: ['K8s', 'äº‘åŸç”Ÿ', 'æ™ºèƒ½è¿ç»´'],
    description: 'æ„å»ºç¨³å®šçš„å¤šæ™ºèƒ½ä½“äº‘ç«¯ç¯å¢ƒã€‚'
  }
];

const RECOMMENDED_JOBS = [
  {
    id: 1,
    title: 'é«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆ',
    company: 'å­—èŠ‚è·³åŠ¨',
    logo: 'ğŸ“±',
    location: 'åŒ—äº¬',
    salary: '40K-60KÂ·16è–ª',
    match: 92,
    tags: ['React', 'TypeScript', 'å¤§å‚'],
    aiIntro: 'å·²ä¸ºæ‚¨åŒ¹é…åˆ° 3 ä½è¯¥å…¬å¸çš„é¢è¯•å®˜æ™ºèƒ½ä½“ï¼Œå¯æä¾›æ¨¡æ‹Ÿé¢è¯•å’Œå†…æ¨æœºä¼š'
  },
  {
    id: 2,
    title: 'æŠ€æœ¯ä¸“å®¶ï¼ˆå‰ç«¯æ–¹å‘ï¼‰',
    company: 'é˜¿é‡Œå·´å·´',
    logo: 'ğŸ›’',
    location: 'æ­å·',
    salary: '45K-70KÂ·15è–ª',
    match: 88,
    tags: ['Vue', 'å·¥ç¨‹åŒ–', 'å›¢é˜Ÿç®¡ç†'],
    aiIntro: 'æ‚¨çš„æŠ€æœ¯æ ˆä¸è¯¥å²—ä½é«˜åº¦åŒ¹é…ï¼ŒAI é¢è¯•å®˜å¯å¸®åŠ©æ‚¨å‡†å¤‡æ¶æ„è®¾è®¡é¢è¯•'
  },
  {
    id: 3,
    title: 'èµ„æ·±å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ',
    company: 'è…¾è®¯ç§‘æŠ€',
    logo: 'ğŸ’¬',
    location: 'æ·±åœ³',
    salary: '35K-55KÂ·14è–ª',
    match: 85,
    tags: ['React', 'å°ç¨‹åº', 'æ€§èƒ½ä¼˜åŒ–'],
    aiIntro: 'æ¨èå¼€å¯ AI èŒä¸šè§„åˆ’æ¨¡å¼ï¼Œä¸ºæ‚¨å®šåˆ¶é¢è¯•å‡†å¤‡æ–¹æ¡ˆ'
  },
  {
    id: 4,
    title: 'Web å‰ç«¯æ¶æ„å¸ˆ',
    company: 'ç¾å›¢',
    logo: 'ğŸœ',
    location: 'åŒ—äº¬',
    salary: '50K-80KÂ·15è–ª',
    match: 78,
    tags: ['æ¶æ„è®¾è®¡', 'æ€§èƒ½ä¼˜åŒ–', 'å›¢é˜Ÿå»ºè®¾'],
    aiIntro: 'è¯¥å²—ä½å¯¹æ¶æ„èƒ½åŠ›è¦æ±‚è¾ƒé«˜ï¼ŒAI å¯¼å¸ˆå¯æä¾›ä¸“é¡¹èƒ½åŠ›æå‡æ–¹æ¡ˆ'
  }
];

const ENTERPRISE_MEMORIES = [
  { id: 1, type: 'æ–‡åŒ–', content: 'å´‡å°šæå®¢ç²¾ç¥ï¼Œæ‰å¹³åŒ–ç®¡ç†ï¼Œæ¯ä¸¤å‘¨ä¸€æ¬¡æŠ€æœ¯å†…éƒ¨åˆ†äº«ã€‚', date: '2026-01-10', importance: 'High', color: 'bg-rose-500/10 text-rose-400 border-rose-500/20' },
  { id: 2, type: 'æŠ€æœ¯', content: 'æ ¸å¿ƒæ¶æ„åŸºäº Go/Rustï¼Œå‰ç«¯åå¥½ React ç”Ÿæ€ï¼Œæå…¶çœ‹é‡ä»£ç çš„å¯æµ‹è¯•æ€§ã€‚', date: '2026-01-12', importance: 'Medium', color: 'bg-indigo-500/10 text-indigo-300 border-indigo-500/20' },
  { id: 3, type: 'è¦æ±‚', content: 'å¯»æ‰¾å…·æœ‰â€˜è‡ªé©±åŠ¨åŠ›â€™å’Œâ€˜å…¨çƒåŒ–ååŒç»éªŒâ€™çš„äººæ‰ï¼Œæœ‰å¼€æºè´¡çŒ®èƒŒæ™¯è€…ä¼˜å…ˆã€‚', date: '2026-01-15', importance: 'High', color: 'bg-amber-500/10 text-amber-400 border-amber-500/20' },
  { id: 4, type: 'ç­–ç•¥', content: 'ä¼˜å…ˆæ»¡è¶³ 100% è¿œç¨‹åŠå…¬éœ€æ±‚ï¼Œé‡ç‚¹è€ƒå¯Ÿå€™é€‰äººçš„å¼‚æ­¥æ²Ÿé€šèƒ½åŠ›ã€‚', date: '2026-01-18', importance: 'Medium', color: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' },
];

const CANDIDATE_MEMORIES = [
  { id: 1, type: 'æŠ€èƒ½', content: 'React ç”Ÿæ€ç²¾é€šï¼ŒTypeScript ä¸¥æ ¼æ¨¡å¼å®è·µè€…ï¼Œè¿½æ±‚ä»£ç å¯ç»´æŠ¤æ€§ã€‚', date: '2026-01-10', importance: 'High', color: 'bg-indigo-500/10 text-indigo-300 border-indigo-500/20' },
  { id: 2, type: 'ç»éªŒ', content: '5 å¹´+ å‰ç«¯æ¶æ„ç»éªŒï¼Œä¸»å¯¼è¿‡å¤šä¸ªç™¾ä¸‡çº§ç”¨æˆ·äº§å“é‡æ„é¡¹ç›®ã€‚', date: '2026-01-12', importance: 'Medium', color: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' },
  { id: 3, type: 'åå¥½', content: 'å€¾å‘äºæ‰å¹³åŒ–æ–‡åŒ–å›¢é˜Ÿï¼Œé‡è§†æŠ€æœ¯åˆ†äº«å’ŒæŒç»­å­¦ä¹ æ°›å›´ã€‚', date: '2026-01-15', importance: 'High', color: 'bg-rose-500/10 text-rose-400 border-rose-500/20' },
  { id: 4, type: 'ç›®æ ‡', content: 'å¯»æ±‚ AI æ–¹å‘è½¬å‹æœºä¼šï¼Œå¸Œæœ›åœ¨æ™ºèƒ½ä½“äº§å“é¢†åŸŸæ·±è€•ã€‚', date: '2026-01-18', importance: 'Medium', color: 'bg-amber-500/10 text-amber-400 border-amber-500/20' },
];

const MOCK_QUALIFICATIONS = [
  { id: 1, title: 'å›½å®¶é«˜æ–°æŠ€æœ¯ä¼ä¸š', description: 'è¿ç»­ä¸‰å¹´è·å¾—è®¤è¯ï¼Œåœ¨ AI ç®—æ³•é¢†åŸŸæ‹¥æœ‰æ ¸å¿ƒè‡ªä¸»çŸ¥è¯†äº§æƒã€‚', icon: Medal, color: 'text-amber-500', bg: 'bg-amber-50' },
  { id: 2, title: 'ISO 27001 ä¿¡æ¯å®‰å…¨è®¤è¯', description: 'è¾¾åˆ°å›½é™…é¡¶çº§æ•°æ®å®‰å…¨æ ‡å‡†ï¼Œç¡®ä¿äººæ‰æ•°æ®ä¸ä¼ä¸šæœºå¯†ä¸‡æ— ä¸€å¤±ã€‚', icon: ShieldCheck, color: 'text-blue-500', bg: 'bg-blue-50' },
  { id: 3, title: '2025 å¹´åº¦æœ€ä½³ AI é›‡ä¸»', description: 'ç”±è¡Œä¸šåª’ä½“è¯„é€‰ï¼Œè¡¨å½°æˆ‘ä»¬åœ¨äººæœºåä½œåŠå…¬æ¨¡å¼ä¸Šçš„å“è¶Šåˆ›æ–°ã€‚', icon: Trophy, color: 'text-indigo-600', bg: 'bg-indigo-50' },
  { id: 4, title: 'å¯ä¿¡äº‘æœåŠ¡è®¤è¯', description: 'æˆ‘ä»¬çš„æ™ºèƒ½ä½“éƒ¨ç½²ç¯å¢ƒç»è¿‡ä¸¥æ ¼çš„äº‘è®¡ç®—åˆè§„ä¸æ€§èƒ½æµ‹è¯•ã€‚', icon: Verified, color: 'text-emerald-500', bg: 'bg-emerald-50' },
  { id: 5, title: 'äº§å­¦ç ”åˆä½œåŸºåœ°', description: 'ä¸å›½å†… Top 3 é«˜æ ¡å»ºç«‹è”åˆå®éªŒå®¤ï¼ŒæŒç»­è¾“é€å‰æ²¿ AI ç ”ç©¶æˆæœã€‚', icon: Landmark, color: 'text-rose-500', bg: 'bg-rose-50' },
];

const MOCK_TOKEN_HISTORY = [
  { date: '2026-01-15', tokens: 42500, type: 'ç®€å†è§£æ', cost: 'Â¥4.25' },
  { date: '2026-02-06', tokens: 89000, type: 'å¤šæ™ºèƒ½ä½“é¢è¯•', cost: 'Â¥8.90' },
  { date: '2026-02-07', tokens: 12400, type: 'ç”»åƒè°ƒä¼˜', cost: 'Â¥1.24' },
  { date: '2026-01-18', tokens: 56000, type: 'ç®€å†è§£æ', cost: 'Â¥5.60' },
  { date: '2026-02-09', tokens: 92000, type: 'å¤šæ™ºèƒ½ä½“é¢è¯•', cost: 'Â¥9.20' },
  { date: '2026-02-10', tokens: 15000, type: 'å…¨å±€è·¯ç”±', cost: 'Â¥1.50' },
  { date: '2026-02-11', tokens: 34000, type: 'ç®€å†è§£æ', cost: 'Â¥3.40' },
];

const MOCK_USAGE_CHART = [
  { name: '05-15', value: 42500 },
  { name: '05-16', value: 89000 },
  { name: '05-17', value: 12400 },
  { name: '05-18', value: 56000 },
  { name: '05-19', value: 92000 },
  { name: '05-20', value: 15000 },
  { name: '05-21', value: 34000 },
];

interface TodoItem {
  id: string;
  task: string;
  description: string;
  type: 'candidate' | 'employer' | 'system';
  icon: any;
  priority: 'High' | 'Medium' | 'Low';
  aiAdvice: string;
  source: 'user' | 'agent';
  createdAt?: string;
  dueDate?: string;
  steps?: { name: string; done: boolean }[];
  progress?: number;
}

// MOCK_TODOS å·²åˆ é™¤ - ä½¿ç”¨åŠ¨æ€ API æ•°æ®

interface TalentInfo extends CandidateProfile {
  id: string;
  status: string;
  matchScore: number;
  tokensConsumed?: number;
  targetJobId?: string;
  recentActivity?: string;
  certifications?: {
    name: string;
    issuer: string;
    date: string;
    icon: any;
    color: string;
  }[];
  awards?: {
    name: string;
    org: string;
    year: string;
    description: string;
    icon: any;
    color: string;
  }[];
  credentials?: {
    name: string;
    authority: string;
    validUntil?: string;
    icon: any;
    color: string;
  }[];
}

const MOCK_TALENTS: TalentInfo[] = [
  {
    id: 't1',
    name: 'é™ˆä¼Ÿ',
    role: 'é«˜çº§å…¨æ ˆå·¥ç¨‹å¸ˆ',
    status: 'AI åˆè¯•ä¸­',
    matchScore: 96,
    tokensConsumed: 4250,
    targetJobId: '1',
    experienceYears: 8,
    summary: 'èµ„æ·±äº’è”ç½‘æ¶æ„å¸ˆï¼Œæ“…é•¿åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ with Generative AIã€‚æ‹¥æœ‰æ·±åšçš„å¤§æ¨¡å‹å¾®è°ƒåŠ RAG æ¶æ„å®æ“ç»éªŒã€‚',
    skills: ['React', 'Node.js', 'PyTorch', 'LangChain', 'Docker', 'K8s'],
    recentActivity: 'åˆšåˆšå®Œæˆ AI å‹åŠ›é¢è¯•ï¼Œè¡¨ç°è¯„çº§ï¼šA+',
    radarData: [
      { subject: 'ä¸“ä¸šæŠ€èƒ½', value: 98 },
      { subject: 'æ²Ÿé€šèƒ½åŠ›', value: 85 },
      { subject: 'é—®é¢˜è§£å†³', value: 95 },
      { subject: 'é¢†å¯¼åŠ›', value: 80 },
      { subject: 'é€‚åº”æ€§', value: 90 },
      { subject: 'æŠ€æœ¯æ·±åº¦', value: 97 },
    ],
    idealJobPersona: "å€¾å‘äºåœ¨æŠ€æœ¯é©±åŠ¨å‹å…¬å¸æ‹…ä»»æ ¸å¿ƒæ¶æ„è§’è‰²ã€‚åå¥½æç®€ä¸»ä¹‰çš„å·¥ä½œæµç¨‹ï¼Œè¿½æ±‚èƒ½å¤Ÿå¤§è§„æ¨¡è½åœ° AI æ™ºèƒ½ä½“çš„å¤æ‚ä¸šåŠ¡åœºæ™¯ã€‚",
    interviewQuestions: ["å¦‚ä½•è§£å†³å¤§è§„æ¨¡å¹¶å‘ä¸‹çš„æ¨¡å‹æ¨ç†å»¶è¿Ÿï¼Ÿ", "æè¿°ä¸€æ¬¡ä½ å¤„ç†å¤æ‚åˆ†å¸ƒå¼ç³»ç»Ÿå´©æºƒçš„ç»å†ã€‚", "ä½ å¯¹ AI Agent ååŒå·¥ä½œçš„æœªæ¥æ€ä¹ˆçœ‹ï¼Ÿ"],
    optimizationSuggestions: ["å¢åŠ åœ¨ç‰¹å®šå‚ç›´è¡Œä¸šçš„ LLM åº”ç”¨æ¡ˆä¾‹ã€‚", "æå‡å¯¹äºæ–°å‹å¤šæ¨¡æ€æ¨¡å‹çš„ç†è§£ã€‚", "åŠ å¼ºå¯¹äºäº‘åŸç”Ÿæ¶æ„çš„æ·±å…¥æŒæ¡ã€‚"],
    certifications: [
      { name: 'AWS Solutions Architect Professional', issuer: 'Amazon Web Services', date: '2026-01', icon: Award, color: 'bg-amber-100 text-amber-600' },
      { name: 'Google Cloud Professional Data Engineer', issuer: 'Google Cloud', date: '2025-11', icon: Trophy, color: 'bg-blue-100 text-blue-600' },
      { name: 'Kubernetes Administrator (CKA)', issuer: 'CNCF', date: '2025-08', icon: ShieldCheck, color: 'bg-indigo-100 text-indigo-600' },
    ],
    awards: [
      { name: 'å¹´åº¦æœ€ä½³æ¶æ„å¸ˆå¥–', org: 'ä¸­å›½äº’è”ç½‘åä¼š', year: '2026', description: 'ä¼˜ç§€åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡èƒ½åŠ›è¡¨å½°', icon: Trophy, color: 'bg-amber-100 text-amber-600' },
      { name: 'å¼€æºæ°å‡ºè´¡çŒ®è€…', org: 'Apache Foundation', year: '2025', description: 'Kubernetes ç¤¾åŒºæ ¸å¿ƒè´¡çŒ®è€…', icon: Medal, color: 'bg-red-100 text-red-600' },
    ],
    credentials: [
      { name: 'ä¿¡æ¯ç³»ç»Ÿå®‰å…¨ä¸“å®¶ (CISP)', authority: 'ä¸­å›½ä¿¡æ¯å®‰å…¨æµ‹è¯„ä¸­å¿ƒ', validUntil: '2026-12', icon: Verified, color: 'bg-emerald-100 text-emerald-600' },
      { name: 'PMP é¡¹ç›®ç®¡ç†ä¸“ä¸šè®¤è¯', authority: 'PMI', validUntil: '2025-06', icon: Award, color: 'bg-orange-100 text-orange-600' },
    ]
  },
  {
    id: 't2',
    name: 'æèŠ³',
    role: 'äº§å“è®¾è®¡ä¸“å®¶',
    status: 'ç®€å†ç­›é€‰',
    matchScore: 89,
    tokensConsumed: 2840,
    targetJobId: '2',
    experienceYears: 6,
    summary: 'å…·å¤‡æ•é”çš„ç”¨æˆ·æ´å¯ŸåŠ›ä¸è¶…å‰çš„è®¾è®¡ç¾å­¦ï¼Œæ“…é•¿å¤æ‚ Bç«¯äº§å“çš„äº¤äº’è®¾è®¡ä¸ä½“éªŒé‡å¡‘ã€‚',
    skills: ['Figma', 'UI/UX', 'Strategy', 'Prototyping', 'User Research'],
    recentActivity: 'ç®€å†è§£æå®Œæˆï¼ŒåŒ¹é…åˆ† 89%ï¼Œå»ºè®®ç›´æ¥è¿›å…¥äºŒé¢',
    radarData: [
      { subject: 'ä¸“ä¸šæŠ€èƒ½', value: 90 },
      { subject: 'æ²Ÿé€šèƒ½åŠ›', value: 95 },
      { subject: 'é—®é¢˜è§£å†³', value: 88 },
      { subject: 'é¢†å¯¼åŠ›', value: 75 },
      { subject: 'é€‚åº”æ€§', value: 92 },
      { subject: 'æŠ€æœ¯æ·±åº¦', value: 80 },
    ],
    idealJobPersona: "å¯»æ±‚å……æ»¡åˆ›æ„æ¿€æƒ…çš„è·¨èŒèƒ½å›¢é˜Ÿï¼Œåå¥½èƒ½å¤Ÿæ·±åº¦å‚ä¸äº§å“ç”Ÿå‘½å‘¨æœŸå¹¶ä¸»å¯¼ç”¨æˆ·ä½“éªŒç­–ç•¥çš„å²—ä½ã€‚ç†æƒ³å·¥ä½œç¯å¢ƒåº”å…·æœ‰é«˜åº¦çš„è®¾è®¡è‡ªç”±åº¦å’Œè·¨éƒ¨é—¨åä½œæ–‡åŒ–ã€‚",
    interviewQuestions: ["å¦‚ä½•å¹³è¡¡è®¾è®¡ç¾æ„Ÿä¸å®é™…ä¸šåŠ¡éœ€æ±‚çš„å†²çªï¼Ÿ", "åˆ†äº«ä¸€ä¸ªä½ ä¸»å¯¼çš„ä» 0 åˆ° 1 çš„è®¾è®¡æ¡ˆä¾‹ã€‚", "ä½ å¦‚ä½•çœ‹å¾… AI åœ¨ UI è®¾è®¡æµç¨‹ä¸­çš„æ›¿ä»£ä½œç”¨ï¼Ÿ"],
    optimizationSuggestions: ["æ›´å¤šåœ°å±•ç¤ºè®¾è®¡å†³ç­–èƒŒåçš„æ•°æ®æ”¯æ’‘ã€‚", "å­¦ä¹ åŸºç¡€çš„å‰ç«¯äº¤äº’ä»£ç å®ç°ã€‚", "å°è¯•è·¨é¢†åŸŸçš„ Cç«¯è®¾è®¡å°è¯•ã€‚"],
    certifications: [
      { name: 'Google UX Design Professional Certificate', issuer: 'Google', date: '2026-01', icon: Award, color: 'bg-blue-100 text-blue-600' },
      { name: 'Interaction Design Foundation Professional', issuer: 'IDEO', date: '2025-06', icon: Trophy, color: 'bg-pink-100 text-pink-600' },
    ],
    awards: [
      { name: 'çº¢ç‚¹è®¾è®¡å¤§å¥–', org: 'Design Zentrum Nordrhein Westfalen', year: '2025', description: 'ä¼ä¸šçº§ B2B SaaS äº§å“ç•Œé¢è®¾è®¡', icon: Medal, color: 'bg-red-100 text-red-600' },
    ],
    credentials: []
  }
];

// --- ä¸šåŠ¡ç»„ä»¶ ---

/**
 * ThinkingBlock â€” AI æ€è€ƒè¿‡ç¨‹æŠ˜å ç»„ä»¶
 * å‚è€ƒ ChatGPT thinking æ ·å¼ï¼Œé»˜è®¤æŠ˜å ï¼Œç‚¹å‡»å¯å±•å¼€æŸ¥çœ‹å®Œæ•´æ€è€ƒè¿‡ç¨‹
 */
const ThinkingBlock = ({ content }: { content: string }) => {
  const [isExpanded, setIsExpanded] = useState(false);
  
  return (
    <div className="my-2 rounded-lg border border-slate-200/80 overflow-hidden">
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className="w-full flex items-center gap-2 px-3 py-2 bg-slate-50/80 hover:bg-slate-100/80 transition-colors text-left group"
      >
        <div className="flex items-center gap-1.5 flex-1 min-w-0">
          <Sparkle size={13} className="text-slate-400 flex-shrink-0" />
          <span className="text-xs font-medium text-slate-500">æ·±åº¦åˆ†æè¿‡ç¨‹</span>
        </div>
        <ChevronDown
          size={14}
          className={`text-slate-400 transition-transform duration-200 flex-shrink-0 ${isExpanded ? 'rotate-180' : ''}`}
        />
      </button>
      {isExpanded && (
        <div className="px-3 py-2.5 text-xs leading-relaxed text-slate-600 bg-white border-t border-slate-100">
          <ReactMarkdown
            remarkPlugins={[remarkGfm]}
            components={{
              p: ({node, ...props}) => <p className="my-1 leading-relaxed" {...props} />,
              strong: ({node, ...props}) => <strong className="font-bold text-slate-700" {...props} />,
              ul: ({node, ...props}) => <ul className="my-1 ml-3 list-disc space-y-0.5" {...props} />,
              ol: ({node, ...props}) => <ol className="my-1 ml-3 list-decimal space-y-0.5" {...props} />,
              li: ({node, ...props}) => <li className="leading-relaxed" {...props} />,
              hr: ({node, ...props}) => <hr className="my-2 border-slate-100" {...props} />,
              h3: ({node, ...props}) => <h5 className="text-xs font-bold text-slate-700 mt-2 mb-1" {...props} />,
              a: ({node, ...props}) => (
                <a href={props.href || '#'} className="text-indigo-500 hover:underline">{props.children}</a>
              ),
            }}
          >
            {content}
          </ReactMarkdown>
        </div>
      )}
    </div>
  );
};

/**
 * StreamingMessage â€” å®æ—¶æ‰“å­—æœºæ•ˆæœç»„ä»¶
 * æ¨¡æ‹Ÿ AI é€å­—è¾“å‡ºçš„ä½“éªŒï¼Œå½“ targetText å˜åŒ–æ—¶åªæ‰“å‡ºæ–°å¢éƒ¨åˆ†
 */
const StreamingMessage = ({ targetText, speed = 18, onTyping }: { targetText: string; speed?: number; onTyping?: () => void }) => {
  const [displayedText, setDisplayedText] = useState('');
  const prevTargetRef = useRef('');
  const rafRef = useRef<number>(0);
  const charIdxRef = useRef(0);
  const baseTextRef = useRef('');
  const scrollTickRef = useRef(0);
  const onTypingRef = useRef(onTyping);
  onTypingRef.current = onTyping;
  
  useEffect(() => {
    // å½“ targetText å˜åŒ–æ—¶è®¡ç®—æ–°å¢éƒ¨åˆ†
    const prevTarget = prevTargetRef.current;
    prevTargetRef.current = targetText;
    
    // æ‰¾å…¬å…±å‰ç¼€é•¿åº¦ï¼ˆä¿ç•™å·²æ‰“å‡ºçš„éƒ¨åˆ†ï¼‰
    let commonLen = 0;
    const minLen = Math.min(prevTarget.length, targetText.length);
    for (let i = 0; i < minLen; i++) {
      if (prevTarget[i] === targetText[i]) commonLen = i + 1;
      else break;
    }
    
    // å¦‚æœæ–°æ–‡æœ¬å®Œå…¨ä¸åŒæˆ–æ˜¯å…¨æ–°çš„ï¼Œä»å…¬å…±éƒ¨åˆ†å¼€å§‹æ‰“
    baseTextRef.current = targetText.slice(0, commonLen);
    charIdxRef.current = commonLen;
    setDisplayedText(baseTextRef.current);
    
    // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»
    if (rafRef.current) cancelAnimationFrame(rafRef.current);
    
    let lastTime = 0;
    scrollTickRef.current = 0;
    const animate = (time: number) => {
      if (!lastTime) lastTime = time;
      const elapsed = time - lastTime;
      
      if (elapsed >= speed) {
        lastTime = time;
        // åŠ¨æ€è°ƒæ•´æ¯å¸§å­—ç¬¦æ•°ï¼šæ–‡æœ¬é‡å¤§æ—¶æ‰“å¾—æ›´å¿«
        const remaining = targetText.length - charIdxRef.current;
        const charsPerTick = remaining > 200 ? 6 : remaining > 80 ? 4 : remaining > 20 ? 3 : 1;
        charIdxRef.current = Math.min(charIdxRef.current + charsPerTick, targetText.length);
        setDisplayedText(targetText.slice(0, charIdxRef.current));
        
        // æ¯æ‰“å‡ æ¬¡è§¦å‘ä¸€æ¬¡æ»šåŠ¨ï¼ˆé¿å…è¿‡äºé¢‘ç¹ï¼‰
        scrollTickRef.current++;
        if (scrollTickRef.current % 5 === 0) {
          onTypingRef.current?.();
        }
      }
      
      if (charIdxRef.current < targetText.length) {
        rafRef.current = requestAnimationFrame(animate);
      } else {
        // æ‰“å®Œäº†ï¼Œæœ€åæ»šä¸€æ¬¡
        onTypingRef.current?.();
      }
    };
    
    if (charIdxRef.current < targetText.length) {
      rafRef.current = requestAnimationFrame(animate);
    }
    
    return () => {
      if (rafRef.current) cancelAnimationFrame(rafRef.current);
    };
  }, [targetText, speed]);
  
  const isTyping = displayedText.length < targetText.length;
  
  return (
    <div>
      <ReactMarkdown 
        remarkPlugins={[remarkGfm]}
        components={{
          h1: ({node, ...props}) => <h3 className="text-base font-bold text-slate-900 mt-3 mb-2" {...props} />,
          h2: ({node, ...props}) => <h4 className="text-sm font-bold text-slate-900 mt-3 mb-1.5" {...props} />,
          h3: ({node, ...props}) => <h5 className="text-sm font-bold text-slate-800 mt-2 mb-1" {...props} />,
          p: ({node, ...props}) => <p className="my-1.5 leading-relaxed" {...props} />,
          ul: ({node, ...props}) => <ul className="my-2 ml-4 list-disc space-y-1" {...props} />,
          ol: ({node, ...props}) => <ol className="my-2 ml-4 list-decimal space-y-1" {...props} />,
          li: ({node, ...props}) => <li className="leading-relaxed" {...props} />,
          strong: ({node, ...props}) => <strong className="font-bold text-slate-900" {...props} />,
          em: ({node, ...props}) => <em className="italic text-slate-500" {...props} />,
          code: ({node, inline, className, ...props}: any) => {
            const isInline = inline || !className;
            return isInline ? (
              <code className="bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded text-xs font-mono" {...props} />
            ) : (
              <code className="block bg-slate-800 text-slate-100 p-3 rounded-lg text-xs overflow-x-auto font-mono my-2" {...props} />
            );
          },
          hr: ({node, ...props}) => <hr className="my-3 border-slate-200" {...props} />,
        }}
      >
        {displayedText}
      </ReactMarkdown>
      {isTyping && (
        <span className="inline-block w-1.5 h-4 bg-indigo-500 rounded-sm animate-pulse ml-0.5 align-text-bottom" />
      )}
    </div>
  );
};

const MockInterviewConsole = ({ questions, profile }: { questions: string[], profile: CandidateProfile }) => {
  const [messages, setMessages] = useState<{ role: 'ai' | 'user', text: string }[]>([
    { role: 'ai', text: `ä½ å¥½ ${profile.name}ï¼Œæˆ‘æ˜¯ Devnors AI é¢è¯•å®˜ã€‚æˆ‘å·²ç»å®¡é˜…äº†ä½ çš„ç®€å†ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ã€‚ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š${questions[0]}` }
  ]);
  const [input, setInput] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const scrollRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    scrollRef.current?.scrollTo(0, scrollRef.current.scrollHeight);
  }, [messages, isTyping]);

  const handleSend = async () => {
    if (!input.trim() || isTyping) return;
    const userMsg = input;
    setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
    setInput('');
    setIsTyping(true);
    try {
      const history = messages.map(m => ({
        role: m.role === 'ai' ? 'model' : 'user',
        parts: [{ text: m.text }]
      }));
      const aiResponse = await chatWithInterviewer(history, userMsg);
      setMessages(prev => [...prev, { role: 'ai', text: aiResponse }]);
    } catch (err) {
      console.error(err);
    } finally {
      setIsTyping(false);
    }
  };

  return (
    <div className="bg-indigo-600 rounded-lg overflow-hidden border border-slate-800 flex flex-col h-[500px] shadow-2xl">
      <div className="bg-slate-800/50 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
        <div className="flex items-center gap-3">
          <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
          <span className="text-white font-bold text-sm tracking-wide">AI æ¨¡æ‹Ÿé¢è¯•å®å½•</span>
        </div>
      </div>
      <div ref={scrollRef} className="flex-1 overflow-y-auto p-6 space-y-6 scrollbar-hide">
        {messages.map((m, i) => (
          <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`flex gap-3 max-w-[85%] ${m.role === 'user' ? 'flex-row-reverse' : 'flex-row'}`}>
              <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${m.role === 'user' ? 'bg-indigo-600' : 'bg-slate-700'}`}>
                {m.role === 'user' ? <UserIcon size={14} className="text-white" /> : <Bot size={14} className="text-indigo-400" />}
              </div>
              <div className={`px-4 py-3 rounded text-sm leading-relaxed ${m.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 rounded-tl-none border border-slate-700'}`}>
                {m.text}
              </div>
            </div>
          </div>
        ))}
        {isTyping && <div className="text-slate-500 text-xs animate-pulse pl-12 font-mono font-black italic">AGENT IS THINKING...</div>}
      </div>
      <div className="p-4 bg-slate-800/30 border-t border-slate-800 flex gap-2">
        <input 
          type="text" value={input} onChange={(e) => setInput(e.target.value)} 
          onKeyDown={(e) => e.key === 'Enter' && handleSend()}
          className="flex-1 bg-indigo-600 border border-slate-700 rounded px-4 py-2 text-sm text-white focus:outline-none focus:ring-1 focus:ring-indigo-500" 
          placeholder="è¾“å…¥æ‚¨çš„å›ç­”..."
        />
        <button onClick={handleSend} className="bg-indigo-600 text-white p-2 rounded flex items-center justify-center">
          <Send size={18}/>
        </button>
      </div>
    </div>
  );
};

// --- åŸºç¡€å¸ƒå±€ç»„ä»¶ ---

const Navbar = ({ isDarkMode, toggleDarkMode }: { isDarkMode: boolean; toggleDarkMode: () => void }) => {
  const navigate = useNavigate();
  const { user, isLoggedIn, userRole, logout, setUserRole } = useAuth();
  const [showUserMenu, setShowUserMenu] = useState(false);
  const [showMobileMenu, setShowMobileMenu] = useState(false);
  const [isSwitching, setIsSwitching] = useState(false);
  const [switchOverlay, setSwitchOverlay] = useState<{ show: boolean; phase: 'switching' | 'done'; newRole: string } | null>(null);
  const [unreadNotifications, setUnreadNotifications] = useState(0);
  const [navTokenBalance, setNavTokenBalance] = useState<string>('--');
  const [tokenBalanceChanged, setTokenBalanceChanged] = useState(false);
  const prevTokenBalance = useRef<string>('--');
  const rawBalanceRef = useRef<number>(0);
  const animFrameRef = useRef<number>(0);
  const [enterpriseDisplayName, setEnterpriseDisplayName] = useState<string>('');

  // è·å–æœªè¯»é€šçŸ¥æ•°é‡ + Token ä½™é¢
  useEffect(() => {
    const fetchUnreadCount = async () => {
      if (!isLoggedIn || !user?.id) return;
      try {
        const { getUnreadNotificationCount } = await import('./services/apiService');
        const response = await getUnreadNotificationCount(user.id);
        setUnreadNotifications(response.unread_count || 0);
      } catch (error) {
        console.error('è·å–æœªè¯»é€šçŸ¥æ•°é‡å¤±è´¥:', error);
      }
    };
    const fetchTokenBalance = async () => {
      if (!isLoggedIn || !user?.id) return;
      try {
        const { getTokenStats } = await import('./services/apiService');
        const stats = await getTokenStats(user.id);
        const balance = stats?.balance || 0;
        const formatBalance = (val: number): string => {
          if (val >= 1000000) return `${(val / 1000000).toFixed(1).replace(/\.0$/, '')}M`;
          if (val >= 1000) return `${(val / 1000).toFixed(1).replace(/\.0$/, '')}K`;
          return Math.round(val).toLocaleString();
        };
        const oldBalance = rawBalanceRef.current;
        const newFormatted = formatBalance(balance);
        // é¦–æ¬¡åŠ è½½æˆ–æ•°å€¼æœªå˜åŒ–ï¼šç›´æ¥è®¾ç½®
        if (prevTokenBalance.current === '--' || oldBalance === balance) {
          rawBalanceRef.current = balance;
          prevTokenBalance.current = newFormatted;
          setNavTokenBalance(newFormatted);
        } else {
          // æ•°å€¼å˜åŒ–ï¼šæ»šåŠ¨åŠ¨ç”»
          setTokenBalanceChanged(true);
          cancelAnimationFrame(animFrameRef.current);
          const duration = 800; // åŠ¨ç”»æ—¶é•¿ ms
          const startTime = performance.now();
          const startVal = oldBalance;
          const diff = balance - oldBalance;
          const animate = (now: number) => {
            const elapsed = now - startTime;
            const progress = Math.min(elapsed / duration, 1);
            // easeOutCubic ç¼“åŠ¨
            const eased = 1 - Math.pow(1 - progress, 3);
            const current = startVal + diff * eased;
            setNavTokenBalance(formatBalance(current));
            if (progress < 1) {
              animFrameRef.current = requestAnimationFrame(animate);
            } else {
              rawBalanceRef.current = balance;
              prevTokenBalance.current = newFormatted;
              setNavTokenBalance(newFormatted);
              setTimeout(() => setTokenBalanceChanged(false), 400);
            }
          };
          animFrameRef.current = requestAnimationFrame(animate);
        }
      } catch (error) {
        console.error('è·å– Token ä½™é¢å¤±è´¥:', error);
      }
    };
    fetchUnreadCount();
    fetchTokenBalance();
    // æ¯ 30 ç§’åˆ·æ–°ä¸€æ¬¡
    const interval = setInterval(() => { fetchUnreadCount(); fetchTokenBalance(); }, 30000);
    return () => clearInterval(interval);
  }, [isLoggedIn, user?.id]);

  // è·å–ä¼ä¸šæ˜¾ç¤ºåç§°
  useEffect(() => {
    if (!isLoggedIn || !user?.id || userRole !== 'employer') { setEnterpriseDisplayName(''); return; }
    (async () => {
      try {
        const { getSettings } = await import('./services/apiService');
        const s = await getSettings(user.id);
        setEnterpriseDisplayName(s?.short_name || s?.display_name || '');
      } catch { /* ignore */ }
    })();
  }, [isLoggedIn, user?.id, userRole]);

  const handleLogout = () => {
    logout();
    setShowUserMenu(false);
    navigate('/');
  };

  return (
    <>
    <nav className={`fixed top-0 w-full z-50 bg-white/95 backdrop-blur-sm border-b border-slate-200/60 ${isLoggedIn ? 'px-2 md:px-4 py-2 md:py-2.5' : 'px-3 md:px-5 py-3 md:py-4'}`}>
      <div className={`${isLoggedIn ? 'max-w-full' : 'max-w-7xl'} mx-auto flex justify-between items-center relative`}>
        <Link to="/" className="flex items-center space-x-1.5 md:space-x-2" onClick={() => setShowMobileMenu(false)}>
          <div className={`${isLoggedIn ? 'w-8 h-8 md:w-9 md:h-9' : 'w-8 h-8 md:w-10 md:h-10'} bg-indigo-600 rounded-lg flex items-center justify-center shadow-sm transition-transform active:scale-95`}>
            <Zap className={`text-white ${isLoggedIn ? 'w-4 h-4 md:w-5 md:h-5' : 'w-5 h-5 md:w-6 md:h-6'}`} />
          </div>
          <span className={`${isLoggedIn ? 'text-xl md:text-xl' : 'text-xl md:text-2xl'} font-bold tracking-tight text-slate-900`}>Devnors <span className="text-indigo-600 text-xs font-normal">å¾—è‹¥</span></span>
        </Link>
        
        <div className={`hidden md:flex ${isLoggedIn ? 'space-x-6 text-sm' : 'space-x-8 text-sm'} font-medium text-slate-500 absolute left-1/2 -translate-x-1/2 z-10`}>
          {isLoggedIn && (
            <>
              <Link to="/ai-assistant" className="hover:text-indigo-600 transition-colors flex items-center gap-1.5 font-semibold"><Bot size={16}/> AI Agent</Link>
              <Link to="/workbench" className="hover:text-indigo-600 transition-colors flex items-center gap-1.5 font-semibold"><LayoutDashboard size={16}/> æ§åˆ¶é¢æ¿</Link>
            </>
          )}
          
          {!isLoggedIn && (
            <>
              <Link to="/products" className="hover:text-indigo-600 transition-colors">äº§å“</Link>
              <Link to="/solutions" className="hover:text-indigo-600 transition-colors">è§£å†³æ–¹æ¡ˆ</Link>
              <Link to="/models" className="hover:text-indigo-600 transition-colors">Agent</Link>
              <Link to="/pricing" className="hover:text-indigo-600 transition-colors">å®šä»·</Link>
            </>
          )}
        </div>
        
        <div className="flex items-center space-x-1.5 md:space-x-3">
          {isLoggedIn && (
            <>
              <Link to="/tokens" className="flex items-center gap-1 md:gap-1.5 px-2.5 md:px-3 py-1.5 bg-slate-50 text-slate-600 hover:bg-amber-50 hover:text-amber-600 rounded-lg border border-slate-200/60 transition-all group" title="Token èµ„äº§ç®¡ç†">
                <CircleDollarSign size={14} className="text-amber-500 group-hover:rotate-12 transition-transform" />
                <span className={`text-xs font-bold transition-all duration-500 ${tokenBalanceChanged ? 'text-amber-600 scale-110' : 'text-slate-700 scale-100'}`} style={{ display: 'inline-block' }}>{navTokenBalance}</span>
              </Link>
              <Link to="/notifications" className="relative p-2 text-slate-400 hover:text-indigo-600 hover:bg-slate-50 rounded-lg transition-all" title="æ¶ˆæ¯ä¸­å¿ƒ">
                <Bell size={17}/>
                {unreadNotifications > 0 && (
                  <span className="absolute -top-0.5 -right-0.5 min-w-[16px] h-[16px] bg-rose-500 text-white text-[9px] font-bold rounded-full flex items-center justify-center px-0.5">
                    {unreadNotifications > 99 ? '99+' : unreadNotifications}
                  </span>
                )}
              </Link>
              <Link to="/settings" className="hidden md:flex p-2 text-slate-400 hover:text-slate-700 hover:bg-slate-50 rounded-lg transition-all" title="ç³»ç»Ÿè®¾ç½®">
                <Settings size={17}/>
              </Link>
            </>
          )}
          
          {isLoggedIn ? (
            <div className="relative">
              <button 
                onClick={() => setShowUserMenu(!showUserMenu)}
                className="flex items-center gap-2 px-1.5 py-1 hover:bg-slate-50 rounded-full transition-all"
              >
                <div className="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-white text-xs font-bold overflow-hidden ring-2 ring-white shadow-sm">
                  {user?.avatar_url ? <img src={user.avatar_url} alt="" className="w-full h-full object-cover" /> : (user?.name?.charAt(0) || 'U')}
                </div>
                <div className="text-left hidden sm:block">
                  <div className="text-sm font-bold text-slate-800 truncate max-w-[100px] leading-tight">{user?.name || 'ç”¨æˆ·'}</div>
                  {userRole === 'employer' && (enterpriseDisplayName || user?.company_name) && (
                    <div className="text-xs text-slate-400 leading-tight truncate max-w-[100px]">
                      {enterpriseDisplayName || user?.company_name}
                    </div>
                  )}
                </div>
                <ChevronDown size={12} className="text-slate-300 hidden sm:block" />
              </button>
              
              {showUserMenu && (
                <div className="absolute right-0 mt-2 w-60 bg-white rounded-xl shadow-xl border border-slate-200 z-50 overflow-hidden">
                  {/* ç”¨æˆ·ä¿¡æ¯å¤´ */}
                  <div className="px-4 py-3 border-b border-slate-200 bg-slate-50">
                    <div className="flex items-center justify-between mb-2">
                      <div className="font-bold text-sm text-slate-900">{user?.name}</div>
                      <span className="text-[10px] text-slate-400 font-mono">#{user?.id}</span>
                    </div>
                    <Link
                      to="/pricing"
                      onClick={() => setShowUserMenu(false)}
                      className={`flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-xs font-bold transition-all whitespace-nowrap border ${
                        user?.account_tier === 'ULTRA'
                          ? 'bg-gradient-to-r from-rose-50 to-amber-50 text-rose-600 border-rose-200'
                          : user?.account_tier === 'PRO'
                          ? 'bg-gradient-to-r from-indigo-50 to-blue-50 text-indigo-600 border-indigo-200'
                          : 'bg-slate-100 text-slate-600 border-slate-200 hover:border-indigo-200 hover:text-indigo-600'
                      }`}
                    >
                      <Cpu size={12} className="flex-shrink-0" />
                      <span>
                        {user?.account_tier === 'ULTRA' ? 'Devnors 1.0 Ultra Â· æ——èˆ°ç‰ˆ' : user?.account_tier === 'PRO' ? 'Devnors 1.0 Pro Â· ä¸“ä¸šç‰ˆ' : 'Devnors 1.0 Â· åŸºç¡€ç‰ˆ'}
                      </span>
                      {user?.account_tier !== 'ULTRA' && <Zap size={10} className="text-amber-500 flex-shrink-0" />}
                    </Link>
                  </div>
                  {/* å¯¼èˆªé“¾æ¥ */}
                  <div>
                    <Link 
                      to="/settings" 
                      onClick={() => setShowUserMenu(false)}
                      className="flex items-center gap-3 px-4 h-10 text-sm text-slate-700 hover:bg-slate-100 transition-colors"
                    >
                      <Settings size={16} className="flex-shrink-0" /> ç³»ç»Ÿè®¾ç½®
                    </Link>
                    {userRole === 'candidate' && (
                      <Link 
                        to="/candidate/profile" 
                        onClick={() => setShowUserMenu(false)}
                        className="flex items-center gap-3 px-4 h-10 text-sm text-slate-700 hover:bg-slate-100 transition-colors"
                      >
                        <UserIcon size={16} className="flex-shrink-0" /> ä¸ªäººä¸»é¡µ
                      </Link>
                    )}
                    {userRole === 'employer' && (
                      <Link 
                        to="/employer/home" 
                        onClick={() => setShowUserMenu(false)}
                        className="flex items-center gap-3 px-4 h-10 text-sm text-slate-700 hover:bg-slate-100 transition-colors"
                      >
                        <Building2 size={16} className="flex-shrink-0" /> ä¼ä¸šä¸»é¡µ
                      </Link>
                    )}
                    <Link 
                      to="/feedback" 
                      onClick={() => setShowUserMenu(false)}
                      className="flex items-center gap-3 px-4 h-10 text-sm text-slate-700 hover:bg-slate-100 transition-colors"
                    >
                      <MessageSquare size={16} className="flex-shrink-0" /> åé¦ˆå·¥å•
                    </Link>
                  </div>
                  {/* æ·±è‰²æ¨¡å¼ */}
                  <div className="border-t border-slate-200">
                    <button
                      onClick={() => { toggleDarkMode(); }}
                      className="w-full flex items-center justify-between px-4 h-10 text-sm text-slate-700 hover:bg-slate-100 transition-colors relative overflow-hidden group/theme"
                    >
                      <div className="flex items-center gap-3">
                        <span className="flex-shrink-0 theme-icon-spin">
                          {isDarkMode ? <Moon size={16} /> : <Sun size={16} />}
                        </span>
                        <span>{isDarkMode ? 'æ·±è‰²æ¨¡å¼' : 'æµ…è‰²æ¨¡å¼'}</span>
                      </div>
                      <div className={`w-9 h-5 rounded-full relative transition-colors duration-300 flex-shrink-0 ${isDarkMode ? 'bg-indigo-600' : 'bg-slate-300'}`}>
                        <div className={`absolute top-0.5 w-4 h-4 rounded-full bg-white shadow-sm transition-all duration-300 ${isDarkMode ? 'translate-x-4' : 'translate-x-0.5'}`}></div>
                      </div>
                    </button>
                  </div>
                  {/* åˆ‡æ¢èº«ä»½ */}
                  <div className="border-t border-slate-200">
                    <button 
                      disabled={isSwitching}
                      onClick={async () => {
                        const newRole = userRole === 'candidate' ? 'employer' : 'candidate';
                        setShowUserMenu(false);
                        setIsSwitching(true);
                        // æ˜¾ç¤ºè¿‡æ¸¡å¼¹çª— - åˆ‡æ¢ä¸­
                        setSwitchOverlay({ show: true, phase: 'switching', newRole });
                        await setUserRole(newRole);
                        // åˆ‡æ¢å®Œæˆ
                        setSwitchOverlay({ show: true, phase: 'done', newRole });
                        setIsSwitching(false);
                        // åœç•™1.2ç§’å±•ç¤ºç»“æœåè·³è½¬
                        setTimeout(() => {
                          setSwitchOverlay(null);
                          navigate('/ai-assistant');
                        }, 1200);
                      }}
                      className="w-full flex items-center gap-3 px-4 h-10 text-sm text-indigo-600 hover:bg-indigo-50 transition-colors disabled:opacity-50"
                    >
                      {isSwitching ? (
                        <Loader2 size={16} className="animate-spin flex-shrink-0" />
                      ) : (
                        <RotateCcw size={16} className="flex-shrink-0" />
                      )}
                      {isSwitching ? 'åˆ‡æ¢ä¸­...' : `åˆ‡æ¢ä¸º${userRole === 'candidate' ? 'ä¼ä¸šæ–¹' : 'ä¸ªäºº'}`}
                    </button>
                  </div>
                  {/* é€€å‡ºç™»å½• */}
                  <div className="border-t border-slate-200">
                    <button 
                      onClick={handleLogout}
                      className="w-full flex items-center gap-3 px-4 h-10 text-sm text-rose-600 hover:bg-rose-50 transition-colors"
                    >
                      <ArrowRight size={16} className="flex-shrink-0" /> é€€å‡ºç™»å½•
                    </button>
                  </div>
                </div>
              )}
            </div>
          ) : (
            <Link to="/login" className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 md:px-5 py-1.5 md:py-2 rounded text-sm font-semibold shadow-sm hover:shadow transition-all active:scale-95">
              ç™»å½•
            </Link>
          )}
          {/* æ±‰å ¡èœå•æŒ‰é’® - ä»…ç§»åŠ¨ç«¯ */}
          <button onClick={() => setShowMobileMenu(!showMobileMenu)} className="md:hidden p-1.5 text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-lg transition-all ml-1">
            {showMobileMenu ? <X size={20} /> : <Menu size={20} />}
          </button>
        </div>
      </div>

      {/* ç§»åŠ¨ç«¯å¯¼èˆªèœå• */}
      {showMobileMenu && (
        <div className="md:hidden absolute top-full left-0 w-full bg-white border-b border-slate-200 shadow-lg z-50 animate-in slide-in-from-top-2 duration-200">
          <div className="px-4 py-3 space-y-1">
            {isLoggedIn && (
              <>
                <Link to="/ai-assistant" onClick={() => setShowMobileMenu(false)} className="flex items-center gap-2.5 px-3 py-2.5 text-sm font-semibold text-slate-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors"><Bot size={16}/> AI åŠ©æ‰‹</Link>
                <Link to="/workbench" onClick={() => setShowMobileMenu(false)} className="flex items-center gap-2.5 px-3 py-2.5 text-sm font-semibold text-slate-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors"><LayoutDashboard size={16}/> æ§åˆ¶é¢æ¿</Link>
              </>
            )}
            
            {isLoggedIn && (
              <Link to="/settings" onClick={() => setShowMobileMenu(false)} className="flex items-center gap-2.5 px-3 py-2.5 text-sm text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors"><Settings size={16}/> ç³»ç»Ÿè®¾ç½®</Link>
            )}
            {!isLoggedIn && (
              <>
                <Link to="/products" onClick={() => setShowMobileMenu(false)} className="flex items-center gap-2.5 px-3 py-2.5 text-sm text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors">äº§å“</Link>
                <Link to="/solutions" onClick={() => setShowMobileMenu(false)} className="flex items-center gap-2.5 px-3 py-2.5 text-sm text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors">è§£å†³æ–¹æ¡ˆ</Link>
                <Link to="/models" onClick={() => setShowMobileMenu(false)} className="flex items-center gap-2.5 px-3 py-2.5 text-sm text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors">Agent</Link>
                <Link to="/pricing" onClick={() => setShowMobileMenu(false)} className="flex items-center gap-2.5 px-3 py-2.5 text-sm text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors">å®šä»·</Link>
              </>
            )}
          </div>
        </div>
      )}

    </nav>

      {/* èº«ä»½åˆ‡æ¢å…¨å±è¿‡æ¸¡å¼¹çª— - å¿…é¡»åœ¨ nav å¤–éƒ¨ï¼Œå› ä¸º nav çš„ backdrop-blur ä¼šåˆ›å»ºæ–°çš„åŒ…å«å— */}
      {switchOverlay?.show && (
        <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-300">
          <div className="bg-white rounded-2xl shadow-2xl p-10 max-w-sm w-full mx-4 text-center animate-in zoom-in-95 duration-300">
            {switchOverlay.phase === 'switching' ? (
              <>
                <div className="w-16 h-16 mx-auto mb-5 rounded-full bg-indigo-50 flex items-center justify-center">
                  <Loader2 size={32} className="text-indigo-600 animate-spin" />
                </div>
                <h3 className="text-lg font-black text-slate-900 mb-2">æ­£åœ¨åˆ‡æ¢èº«ä»½</h3>
                <p className="text-sm text-slate-500">
                  æ­£åœ¨åˆ‡æ¢è‡³<span className="font-bold text-indigo-600">{switchOverlay.newRole === 'employer' ? 'ä¼ä¸šæ–¹' : 'ä¸ªäºº'}</span>æ¨¡å¼...
                </p>
              </>
            ) : (
              <>
                <div className="w-16 h-16 mx-auto mb-5 rounded-full bg-emerald-50 flex items-center justify-center">
                  {switchOverlay.newRole === 'employer' ? (
                    <Building2 size={32} className="text-emerald-600" />
                  ) : (
                    <UserIcon size={32} className="text-emerald-600" />
                  )}
                </div>
                <h3 className="text-lg font-black text-slate-900 mb-2">åˆ‡æ¢æˆåŠŸ</h3>
                <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-emerald-50 border border-emerald-100 mb-3">
                  <CheckCircle2 size={16} className="text-emerald-500" />
                  <span className="text-sm font-bold text-emerald-700">
                    å½“å‰èº«ä»½ï¼š{switchOverlay.newRole === 'employer' ? 'ä¼ä¸šæ–¹' : 'ä¸ªäºº'}
                  </span>
                </div>
                <p className="text-xs text-slate-400 mt-2">æ­£åœ¨è·³è½¬è‡³ AI åŠ©æ‰‹...</p>
              </>
            )}
          </div>
        </div>
      )}
    </>
  );
};

// æ•°å­—æ»šåŠ¨åŠ¨ç”»ç»„ä»¶
const AnimatedCounter = ({ end, suffix = '', duration = 2000, color = 'text-indigo-600' }: { end: number; suffix?: string; duration?: number; color?: string }) => {
  const [count, setCount] = useState(0);
  const [isVisible, setIsVisible] = useState(false);
  const ref = useRef<HTMLDivElement>(null);
  
  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting && !isVisible) {
          setIsVisible(true);
        }
      },
      { threshold: 0.3 }
    );
    
    if (ref.current) {
      observer.observe(ref.current);
    }
    
    return () => observer.disconnect();
  }, [isVisible]);
  
  useEffect(() => {
    if (!isVisible) return;
    
    let startTime: number;
    let animationFrame: number;
    
    const animate = (timestamp: number) => {
      if (!startTime) startTime = timestamp;
      const progress = Math.min((timestamp - startTime) / duration, 1);
      
      // ä½¿ç”¨ easeOutExpo ç¼“åŠ¨å‡½æ•°
      const easeOutExpo = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
      setCount(Math.floor(easeOutExpo * end));
      
      if (progress < 1) {
        animationFrame = requestAnimationFrame(animate);
      }
    };
    
    animationFrame = requestAnimationFrame(animate);
    return () => cancelAnimationFrame(animationFrame);
  }, [isVisible, end, duration]);
  
  return (
    <div ref={ref} className="text-3xl md:text-5xl font-black text-slate-900 mb-2 tracking-tighter">
      {count}{suffix}<span className={color}>+</span>
    </div>
  );
};

const LandingPage = () => {
  const [stats, setStats] = useState<{ candidates: number; enterprises: number; matches: number } | null>(null);

  useEffect(() => {
    import('./services/apiService').then(({ getPlatformStats }) => {
      getPlatformStats().then(setStats).catch(() => {});
    });
  }, []);

  return (
  <div className="pt-20">
    <Hero />

    {/* æ ¸å¿ƒç¤¾äº¤è¯æ˜æ¿å— (Market Presence) */}
    <section className="py-10 px-4 md:py-16 md:px-6 -mt-10 mb-10">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-md p-6 md:p-10 lg:p-16 border border-slate-100 shadow-2xl relative overflow-hidden group">
           <div className="absolute top-0 right-0 p-20 opacity-[0.02] pointer-events-none group-hover:scale-110 transition-transform duration-1000">
             <Globe size={400} className="text-indigo-600" />
           </div>
           <div className="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-12 relative z-10">
             <div className="text-center md:border-r border-slate-100">
                <div className="inline-flex p-3 bg-indigo-50 rounded text-indigo-600 mb-6 animate-in zoom-in duration-500">
                  <Users size={32} />
                </div>
                <AnimatedCounter end={stats?.candidates || 0} suffix="" color="text-indigo-600" />
                <div className="text-sm font-bold text-slate-400 uppercase tracking-widest">å…¨çƒå‚¨å¤‡äººæ‰</div>
             </div>
             <div className="text-center md:border-r border-slate-100">
                <div className="inline-flex p-3 bg-emerald-50 rounded text-emerald-600 mb-6 animate-in zoom-in duration-500 delay-150">
                  <Building2 size={32} />
                </div>
                <AnimatedCounter end={stats?.enterprises || 0} suffix="" color="text-emerald-600" duration={1500} />
                <div className="text-sm font-bold text-slate-400 uppercase tracking-widest">æ´»è·ƒå…¥é©»ä¼ä¸š</div>
             </div>
             <div className="text-center">
                <div className="inline-flex p-3 bg-rose-50 rounded text-rose-600 mb-6 animate-in zoom-in duration-500 delay-300">
                  <Sparkles size={32} />
                </div>
                <AnimatedCounter end={stats?.matches || 0} suffix="" color="text-rose-600" duration={2500} />
                <div className="text-sm font-bold text-slate-400 uppercase tracking-widest">AI æ™ºèƒ½æˆåŠŸå¯¹æ¥</div>
             </div>
           </div>
        </div>
      </div>
    </section>

    <section className="py-12 px-4 md:py-20 md:px-6">
      <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
        <FeatureCard 
          icon={Zap}
          title="æ™ºèƒ½ä½“å…¨æµç¨‹è‡ªæ²»"
          description="é¦–åˆ›â€œæ™ºèƒ½ä½“åŸç”Ÿâ€æ¨¡å¼ï¼Œç®€å†è‡ªæŠ•é€’ã€å²—ä½è‡ªæ¨èã€é¢è¯•è‡ªè°ƒåº¦ï¼Œå®ç°åŒå‘è‡ªåŠ¨åŒ–ã€‚"
        />
        <FeatureCard 
          icon={BarChart3}
          title="å¤šæ¨¡æ€äººæ‰è¯„ä¼°"
          description="èåˆå¾®è¡¨æƒ…åˆ†æã€è¯­éŸ³æƒ…æ„Ÿä¸æ–‡æœ¬é€»è¾‘ï¼Œæ„å»ºå…­ç»´åŠ¨æ€èƒ½åŠ›é›·è¾¾å›¾ï¼Œä¸€è‡´ç‡é«˜è¾¾ 90.1%ã€‚"
        />
        <FeatureCard 
          icon={ShieldCheck}
          title="æŠ—åè§å…¬å¹³ç®—æ³•"
          description="é€šè¿‡å¯¹æŠ—æ€§å»åæŠ€æœ¯æ¶ˆé™¤æ½œåœ¨æ­§è§†ï¼Œç¡®ä¿æ‹›è˜å›å½’èƒ½åŠ›æœ¬è´¨ï¼Œæå‡ 45% çš„æ‹›è˜å…¬å¹³æ€§ã€‚"
        />
      </div>
    </section>
    
    <section className="py-14 px-4 md:py-24 md:px-6 bg-indigo-600/5 border-y border-indigo-100/50">
      <div className="max-w-7xl mx-auto text-center">
        <h2 className="text-xl md:text-3xl font-bold mb-8 md:mb-16 text-slate-900">é‡åŒ–æ•ˆç‡æ ‡æ†</h2>
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
          <StatCard value={578} prefix="+" suffix="%" label="æ•ˆç‡è·¨è¶Šå¼æå‡" delay={0} />
          <StatCard value={82} prefix="+" suffix="%" label="åŒ¹é…ç²¾åº¦" delay={100} />
          <StatCard value={70} prefix="-" suffix="%" label="HR äººåŠ›æˆæœ¬é™ä½" delay={200} />
          <StatCard value={48} prefix="< " suffix="h" label="æ‹›è˜å‘¨æœŸ" delay={300} />
        </div>
      </div>
    </section>
  </div>
  );
};

const Hero = () => (
  <section className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 overflow-hidden">
    <div className="max-w-7xl mx-auto text-center relative">
      <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[400px] h-[400px] md:w-[600px] md:h-[600px] bg-indigo-500/5 blur-[120px] -z-10 rounded-full"></div>
      <div className="inline-flex items-center space-x-2 bg-indigo-50/80 border border-indigo-100 px-3 py-1 md:px-4 md:py-1.5 rounded-full text-indigo-600 text-xs md:text-sm font-medium mb-6 md:mb-8">
        <Sparkles size={14} />
        <span>æ•ˆç‡æå‡ 578%ï¼šå¤šæ™ºèƒ½ä½“é©±åŠ¨æ‹›è˜æ–°çºªå…ƒ</span>
      </div>
      <h1 className="text-3xl md:text-5xl lg:text-7xl font-extrabold mb-6 md:mb-8 leading-tight text-slate-900 tracking-tight">
        é‡å¡‘ <span className="gradient-text">AI é©±åŠ¨</span> çš„ <br />
        äººæ‰æ‹›è˜æ–°èŒƒå¼
      </h1>
      <p className="text-base md:text-xl text-slate-600 max-w-3xl mx-auto mb-8 md:mb-12 leading-relaxed ">
        ä»â€œäººå²—åŒ¹é…â€åˆ°â€œæ™ºèƒ½ä½“è‡ªä¸»ååŒâ€ã€‚Devnors éƒ¨ç½²å¤šæ™ºèƒ½ä½“ç³»ç»Ÿï¼ˆMASï¼‰ï¼Œ
        å®ç°ä»ç®€å†æ·±åº¦è§£æã€å¤šæ¨¡æ€è¯„ä¼°åˆ°é¢è¯•è‡ªè°ƒåº¦çš„å…¨é“¾è·¯é—­ç¯ã€‚
      </p>
      <HeroButtons />
    </div>
  </section>
);

// Hero æŒ‰é’®ç»„ä»¶ï¼ˆéœ€è¦ hooksï¼‰
const HeroButtons = () => {
  const navigate = useNavigate();
  const { isLoggedIn, userRole } = useAuth();

  const handleAuthAction = (targetPath: string, defaultRole: 'candidate' | 'employer') => {
    if (isLoggedIn) {
      navigate(targetPath);
    } else {
      navigate(`/login?role=${defaultRole}`, { state: { from: targetPath } });
    }
  };

  return (
    <div className="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4">
      <button 
        onClick={() => handleAuthAction('/candidate', 'candidate')}
        className="w-full sm:w-auto bg-indigo-600 text-white px-8 py-4 rounded font-bold hover:bg-indigo-700 transition-all flex items-center justify-center space-x-2 shadow-xl shadow-indigo-200"
      >
        <span>{isLoggedIn && (userRole === 'candidate' || !userRole) ? 'å¼€å§‹æ±‚èŒ' : 'ä½œä¸ºäººæ‰åŠ å…¥'}</span>
        <ArrowRight size={18} />
      </button>
      <button 
        onClick={() => handleAuthAction('/employer', 'employer')}
        className="w-full sm:w-auto bg-white border border-slate-200 text-slate-900 px-8 py-4 rounded font-bold hover:bg-slate-50 transition-all flex items-center justify-center space-x-2 shadow-sm"
      >
        <span>{isLoggedIn && (userRole === 'employer' || userRole === 'recruiter' || userRole === 'admin') ? 'å¼€å§‹æ‹›è˜' : 'ä¼ä¸šå¼€å§‹æ‹›è˜'}</span>
        <Briefcase size={18} />
      </button>
    </div>
  );
};

const FeatureCard = ({ icon: Icon, title, description }: any) => (
  <div className="bg-white p-8 rounded hover:translate-y-[-4px] transition-all border border-slate-100 card-shadow group">
    <div className="w-12 h-12 bg-indigo-50 rounded flex items-center justify-center mb-6 group-hover:bg-indigo-600 transition-colors">
      <Icon className="text-indigo-600 w-6 h-6 group-hover:text-white transition-colors" />
    </div>
    <h3 className="text-xl font-bold mb-4 text-slate-900">{title}</h3>
    <p className="text-slate-500 leading-relaxed">{description}</p>
  </div>
);

// ç»Ÿè®¡å¡ç‰‡ç»„ä»¶ï¼ˆå¸¦æ•°å­—æ»šåŠ¨åŠ¨ç”»ï¼‰
const StatCard = ({ value, suffix = '', prefix = '', label, delay = 0 }: { value: number; suffix?: string; prefix?: string; label: string; delay?: number }) => {
  const [count, setCount] = useState(0);
  const [isVisible, setIsVisible] = useState(false);
  const ref = useRef<HTMLDivElement>(null);
  
  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting && !isVisible) {
          setTimeout(() => setIsVisible(true), delay);
        }
      },
      { threshold: 0.3 }
    );
    
    if (ref.current) {
      observer.observe(ref.current);
    }
    
    return () => observer.disconnect();
  }, [isVisible, delay]);
  
  useEffect(() => {
    if (!isVisible) return;
    
    let startTime: number;
    let animationFrame: number;
    const duration = 1800;
    
    const animate = (timestamp: number) => {
      if (!startTime) startTime = timestamp;
      const progress = Math.min((timestamp - startTime) / duration, 1);
      
      // easeOutExpo ç¼“åŠ¨
      const easeOutExpo = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
      setCount(Math.floor(easeOutExpo * value));
      
      if (progress < 1) {
        animationFrame = requestAnimationFrame(animate);
      }
    };
    
    animationFrame = requestAnimationFrame(animate);
    return () => cancelAnimationFrame(animationFrame);
  }, [isVisible, value]);
  
  return (
    <div 
      ref={ref} 
      className={`p-8 bg-white rounded border border-indigo-50/50 card-shadow transition-all duration-500 ${
        isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'
      }`}
    >
      <div className="text-3xl md:text-5xl font-extrabold text-indigo-600 mb-2">
        {prefix}{count}{suffix}
      </div>
      <div className="text-slate-500 font-semibold">{label}</div>
    </div>
  );
};

// é€šç”¨åŠ¨ç”»ç»Ÿè®¡é¡¹ç»„ä»¶ï¼ˆç”¨äºå„é¡µé¢çš„æ•°æ®å±•ç¤ºï¼‰
const AnimatedStatItem = ({ 
  value, 
  label, 
  icon: Icon, 
  color = 'text-indigo-600', 
  bg = 'bg-indigo-50',
  delay = 0,
  size = 'normal'
}: { 
  value: string; 
  label: string; 
  icon?: any; 
  color?: string; 
  bg?: string;
  delay?: number;
  size?: 'small' | 'normal' | 'large';
}) => {
  const [isVisible, setIsVisible] = useState(false);
  const [displayValue, setDisplayValue] = useState('0');
  const ref = useRef<HTMLDivElement>(null);
  
  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting && !isVisible) {
          setTimeout(() => setIsVisible(true), delay);
        }
      },
      { threshold: 0.2 }
    );
    
    if (ref.current) {
      observer.observe(ref.current);
    }
    
    return () => observer.disconnect();
  }, [isVisible, delay]);
  
  useEffect(() => {
    if (!isVisible) return;
    
    // è§£ææ•°å€¼
    const numMatch = value.match(/[\d.]+/);
    if (!numMatch) {
      setDisplayValue(value);
      return;
    }
    
    const targetNum = parseFloat(numMatch[0]);
    const prefix = value.slice(0, value.indexOf(numMatch[0]));
    const suffix = value.slice(value.indexOf(numMatch[0]) + numMatch[0].length);
    
    let startTime: number;
    const duration = 1500;
    
    const animate = (timestamp: number) => {
      if (!startTime) startTime = timestamp;
      const progress = Math.min((timestamp - startTime) / duration, 1);
      const easeOut = 1 - Math.pow(1 - progress, 3);
      
      const currentNum = targetNum * easeOut;
      const formatted = numMatch[0].includes('.') 
        ? currentNum.toFixed(1) 
        : Math.floor(currentNum).toString();
      
      setDisplayValue(`${prefix}${formatted}${suffix}`);
      
      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        setDisplayValue(value);
      }
    };
    
    requestAnimationFrame(animate);
  }, [isVisible, value]);
  
  const sizeClasses = {
    small: { value: 'text-xl', label: 'text-xs', icon: 16, iconBox: 'w-8 h-8' },
    normal: { value: 'text-2xl', label: 'text-xs', icon: 20, iconBox: 'w-10 h-10' },
    large: { value: 'text-3xl', label: 'text-sm', icon: 24, iconBox: 'w-12 h-12' },
  };
  
  const s = sizeClasses[size];
  
  return (
    <div 
      ref={ref}
      className={`transition-all duration-700 ${isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-3'}`}
    >
      {Icon ? (
        <div className="flex items-center gap-4">
          <div className={`${s.iconBox} rounded-lg flex items-center justify-center ${bg}`}>
            <Icon className={color} size={s.icon} />
          </div>
          <div>
            <div className={`text-slate-400 ${s.label} font-bold uppercase tracking-wider`}>{label}</div>
            <div className={`${s.value} font-black text-slate-900`}>{displayValue}</div>
          </div>
        </div>
      ) : (
        <div className="text-center">
          <div className={`${s.value} font-black ${color}`}>{displayValue}</div>
          <div className={`${s.label} text-slate-500 mt-1`}>{label}</div>
        </div>
      )}
    </div>
  );
};

// --- è®¾ç½®ä¸ç®¡ç†é¡µé¢ ---
const SettingsManagementView = ({ isDarkMode, toggleDarkMode }: { isDarkMode: boolean; toggleDarkMode: () => void }) => {
  const navigate = useNavigate();
  const location = useLocation();
  const { user, userRole, refreshUser } = useAuth();
  const userId = user?.id || 0;
  const isEmployer = userRole === 'employer' || userRole === 'recruiter' || userRole === 'admin';
  
  const [activeTab, setActiveTab] = useState<'General' | 'AccountInfo' | 'Verification' | 'PersonalVerification' | 'AIEngine' | 'API' | 'Team' | 'Audit'>('AccountInfo');
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  
  // è´¦å·ä¿¡æ¯çŠ¶æ€
  const [accountInfo, setAccountInfo] = useState({
    name: '',
    phone: '',
    email: '',
    avatar_url: '',
  });
  const [accountEditing, setAccountEditing] = useState(false);
  const [accountSaving, setAccountSaving] = useState(false);
  const [accountErrors, setAccountErrors] = useState<Record<string, string>>({});
  // å¯†ç ä¿®æ”¹
  const [passwordForm, setPasswordForm] = useState({ oldPassword: '', newPassword: '', confirmPassword: '' });
  const [passwordChanging, setPasswordChanging] = useState(false);
  const [showPasswordForm, setShowPasswordForm] = useState(false);
  // å¤´åƒä¸Šä¼ 
  const avatarInputRef = useRef<HTMLInputElement>(null);
  const [avatarUploading, setAvatarUploading] = useState(false);
  // ä¼ä¸šLogoä¸Šä¼ 
  const logoInputRef = useRef<HTMLInputElement>(null);
  const [logoUploading, setLogoUploading] = useState(false);
  // äºŒæ¬¡éªŒè¯å¼¹çª—çŠ¶æ€ï¼ˆæ‰‹æœº/é‚®ç®±ä¿®æ”¹ï¼‰
  const [verifyModal, setVerifyModal] = useState<{show: boolean; type: 'phone' | 'email'; newValue: string; step: 'old' | 'new'}>({show: false, type: 'phone', newValue: '', step: 'old'});
  const [showEmailInput, setShowEmailInput] = useState(false);
  const [newEmailValue, setNewEmailValue] = useState('');
  const [verifyCode, setVerifyCode] = useState('');
  const [verifySending, setVerifySending] = useState(false);
  const [verifyCountdown, setVerifyCountdown] = useState(0);
  const [verifySubmitting, setVerifySubmitting] = useState(false);
  
  // ä» URL å‚æ•°è¯»å– tab
  useEffect(() => {
    const searchParams = new URLSearchParams(location.search);
    const tabParam = searchParams.get('tab');
    if (tabParam && ['General', 'AccountInfo', 'Verification', 'PersonalVerification', 'AIEngine', 'API', 'Team', 'Audit'].includes(tabParam)) {
      setActiveTab(tabParam as any);
    }
  }, [location.search]);
  
  // åŠ¨æ€æ•°æ®çŠ¶æ€
  const [settings, setSettings] = useState<any>({});
  const [enterpriseCerts, setEnterpriseCerts] = useState<any[]>([]);
  const [personalCerts, setPersonalCerts] = useState<any[]>([]);
  const [teamMembers, setTeamMembers] = useState<any[]>([]);
  const [teamInfo, setTeamInfo] = useState<{is_admin: boolean; enterprise_id: number | null; enterprise_name: string | null}>({is_admin: false, enterprise_id: null, enterprise_name: null});
  const [showInviteModal, setShowInviteModal] = useState(false);
  const [inviteForm, setInviteForm] = useState({phone: '', email: '', role: 'viewer', inviteType: 'phone' as 'phone' | 'email'});
  const [inviteLoading, setInviteLoading] = useState(false);
  const [showTransferModal, setShowTransferModal] = useState(false);
  const [transferTargetId, setTransferTargetId] = useState<number | null>(null);
  const [llmConfigs, setLlmConfigs] = useState<any[]>([]);
  const [showLLMConnectModal, setShowLLMConnectModal] = useState(false);
  const [connectingModel, setConnectingModel] = useState<{name: string; provider: string} | null>(null);
  const [llmConnectForm, setLlmConnectForm] = useState({ apiKey: '', baseUrl: '' });
  const [llmConnecting, setLlmConnecting] = useState(false);
  const [apiKeys, setApiKeys] = useState<any[]>([]);
  const [webhooks, setWebhooks] = useState<any[]>([]);
  const [apiKeyUsage, setApiKeyUsage] = useState<any>({ today: 0, week: 0 });
  const [showNewKeyModal, setShowNewKeyModal] = useState(false);
  const [newKeyForm, setNewKeyForm] = useState({ name: 'Production Key', environment: 'production' });
  const [showWebhookModal, setShowWebhookModal] = useState(false);
  const [editingWebhook, setEditingWebhook] = useState<any>(null);
  const [webhookForm, setWebhookForm] = useState({ url: '', events: '*', description: '' });
  const [auditLogs, setAuditLogs] = useState<any[]>([]);
  const [auditStats, setAuditStats] = useState<any>({ total: 0, auth: 0, data: 0, ai: 0, api: 0, system: 0 });
  const [auditCategory, setAuditCategory] = useState<string | null>(null);
  const [auditExporting, setAuditExporting] = useState(false);
  const [accountTierInfo, setAccountTierInfo] = useState<any>({ tier: 'free', tierName: 'Devnors 1.0', privileges: [] });

  // åŠ è½½æ‰€æœ‰è®¾ç½®æ•°æ®
  useEffect(() => {
    const loadAllSettings = async () => {
      if (!userId) {
        setLoading(false);
        return;
      }
      
      setLoading(true);
      try {
        const [
          settingsData,
          enterpriseCertsData,
          personalCertsData,
          teamMembersData,
          aiConfigsData,
          apiKeysData,
          webhooksData,
          apiKeyUsageData,
          auditLogsData,
          auditStatsData,
          accountTierData
        ] = await Promise.all([
          getSettings(userId).catch(() => ({})),
          getEnterpriseCertifications(userId).catch(() => []),
          getPersonalCertifications(userId).catch(() => []),
          getTeamMembers(userId).catch(() => []),
          getAIConfigs(userId).catch(() => []),
          getAPIKeys(userId).catch(() => []),
          getWebhooks(userId).catch(() => []),
          getAPIKeyUsage(userId).catch(() => ({ today: 0, week: 0 })),
          getAuditLogs(userId).catch(() => []),
          getAuditLogStats(userId).catch(() => ({ total: 0, auth: 0, data: 0, ai: 0, api: 0, system: 0 })),
          getAccountTier(userId).catch(() => ({ tier: 'free', tierName: 'Devnors 1.0', privileges: [] }))
        ]);
        
        setSettings(settingsData);
        setEnterpriseCerts(enterpriseCertsData);
        setPersonalCerts(personalCertsData);
        // å¤„ç†å›¢é˜Ÿæˆå‘˜æ•°æ®
        if (teamMembersData && teamMembersData.members) {
          setTeamMembers(teamMembersData.members);
          setTeamInfo({
            is_admin: teamMembersData.is_admin,
            enterprise_id: teamMembersData.enterprise_id,
            enterprise_name: teamMembersData.enterprise_name
          });
        } else if (Array.isArray(teamMembersData)) {
          setTeamMembers(teamMembersData);
        }
        setLlmConfigs(aiConfigsData);
        setApiKeys(apiKeysData);
        setWebhooks(webhooksData);
        setApiKeyUsage(apiKeyUsageData);
        setAuditLogs(auditLogsData);
        setAuditStats(auditStatsData);
        setAccountTierInfo(accountTierData);
        // åˆå§‹åŒ–è´¦å·ä¿¡æ¯
        setAccountInfo({
          name: user?.name || '',
          phone: user?.phone || '',
          email: user?.email || '',
          avatar_url: user?.avatar_url || '',
        });
      } catch (error) {
        console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
      } finally {
        setLoading(false);
      }
    };
    
    loadAllSettings();
  }, [userId]);

  // Toast æç¤º
  const [toast, setToast] = useState<{show: boolean; message: string; type: 'success' | 'error' | 'warning'}>({show: false, message: '', type: 'success'});
  const showToast = (message: string, type: 'success' | 'error' | 'warning' = 'success') => {
    setToast({show: true, message, type});
    setTimeout(() => setToast(prev => ({...prev, show: false})), 3000);
  };

  // æ ¡éªŒé”™è¯¯
  const [fieldErrors, setFieldErrors] = useState<Record<string, string>>({});

  // å­—æ®µæ ¡éªŒ
  const validateField = (key: string, value: any): string => {
    if (!value || (typeof value === 'string' && value.trim() === '')) return '';
    const v = typeof value === 'string' ? value.trim() : value;
    
    switch(key) {
      case 'hr_phone':
      case 'contact_phone': {
        const phone = v.replace(/[\s\-]/g, '');
        if (!/^1[3-9]\d{9}$/.test(phone) && !/^0\d{2,3}\d{7,8}$/.test(phone)) {
          return 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ï¼ˆå¦‚ 13812345678ï¼‰æˆ–å›ºè¯ï¼ˆå¦‚ 02112345678ï¼‰';
        }
        return '';
      }
      case 'contact_email':
      case 'hr_email': {
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) {
          return 'è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼ï¼ˆå¦‚ example@company.comï¼‰';
        }
        return '';
      }
      case 'website': {
        if (v && !/^https?:\/\/.+\..+/.test(v) && !/^[a-zA-Z0-9][-a-zA-Z0-9]*\.[a-zA-Z]{2,}/.test(v)) {
          return 'è¯·è¾“å…¥æ­£ç¡®çš„ç½‘å€ï¼ˆå¦‚ https://www.example.comï¼‰';
        }
        return '';
      }
      case 'display_name': {
        if (v.length < 2) return 'ä¼ä¸šå…¨ç§°ä¸èƒ½å°‘äº2ä¸ªå­—';
        if (v.length > 100) return 'ä¼ä¸šå…¨ç§°ä¸èƒ½è¶…è¿‡100ä¸ªå­—';
        return '';
      }
      case 'short_name': {
        if (v.length > 20) return 'ä¼ä¸šç®€ç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—';
        return '';
      }
      case 'description': {
        if (v.length > 1000) return 'ä¼ä¸šç®€ä»‹ä¸èƒ½è¶…è¿‡1000å­—';
        return '';
      }
      case 'contact_name': {
        if (v.length > 20) return 'å§“åä¸èƒ½è¶…è¿‡20ä¸ªå­—';
        return '';
      }
      case 'detail_address': {
        if (v.length > 200) return 'åœ°å€ä¸èƒ½è¶…è¿‡200ä¸ªå­—';
        return '';
      }
      default:
        return '';
    }
  };

  // å¸¦æ ¡éªŒçš„ setSettings
  const updateField = (key: string, value: any) => {
    setSettings((prev: any) => ({...prev, [key]: value}));
    const error = validateField(key, value);
    setFieldErrors(prev => ({...prev, [key]: error}));
  };

  // ä¿å­˜è®¾ç½®
  const handleSaveSettings = async () => {
    // ä¿å­˜å‰å…¨é‡æ ¡éªŒ
    const fieldsToValidate = ['display_name', 'short_name', 'hr_phone', 'contact_phone', 'contact_email', 'hr_email', 'website', 'description', 'contact_name', 'detail_address'];
    const errors: Record<string, string> = {};
    let hasError = false;
    for (const key of fieldsToValidate) {
      if (settings[key]) {
        const err = validateField(key, settings[key]);
        if (err) { errors[key] = err; hasError = true; }
      }
    }
    setFieldErrors(errors);
    if (hasError) {
      showToast('è¯·ä¿®æ­£æ ‡çº¢çš„é”™è¯¯å­—æ®µåå†ä¿å­˜', 'error');
      return;
    }

    setSaving(true);
    try {
      // åªå‘é€åç«¯æ¥å—çš„å­—æ®µ
      const allowedKeys = [
        'display_name', 'short_name', 'enterprise_type', 'industry', 'company_size',
        'founding_year', 'funding_stage', 'province', 'city', 'district',
        'detail_address', 'address', 'contact_phone', 'contact_email', 'website',
        'contact_name', 'hr_position', 'hr_phone', 'hr_email', 'slogan',
        'description', 'work_time', 'rest_type', 'benefits', 'company_photos',
        'notification_enabled', 'dark_mode'
      ];
      const cleanData: any = {};
      for (const key of allowedKeys) {
        if (settings[key] !== undefined && settings[key] !== null) {
          cleanData[key] = settings[key];
        }
      }
      await updateSettings(cleanData, userId);
      showToast('è®¾ç½®å·²ä¿å­˜æˆåŠŸ', 'success');
    } catch (error) {
      console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
      showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    } finally {
      setSaving(false);
    }
  };

  // å¤åˆ¶API Key
  const handleCopyAPIKey = (key: string) => {
    navigator.clipboard.writeText(key);
    showToast('API Key å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
  };

  const isCandidate = userRole === 'candidate';
  const navItems = [
    { id: 'AccountInfo', label: 'è´¦å·ä¿¡æ¯', icon: IdCard },
    ...(isEmployer ? [{ id: 'General', label: 'ä¼ä¸šåŸºç¡€ä¿¡æ¯', icon: UserCircle2 }] : []),
    ...(isEmployer ? [{ id: 'Verification', label: 'ä¼ä¸šè®¤è¯ä¿¡æ¯', icon: ShieldCheck }] : []),
    ...(isCandidate ? [{ id: 'PersonalVerification', label: 'ä¸ªäººè®¤è¯ä¿¡æ¯', icon: Fingerprint }] : []),
    { id: 'AIEngine', label: 'è‡ªå®šä¹‰å¤§æ¨¡å‹', icon: Cpu },
    { id: 'API', label: 'API ä¸é›†æˆ', icon: Key },
    ...(isEmployer ? [{ id: 'Team', label: 'äººå‘˜ä¸æƒé™', icon: Users2 }] : []),
    { id: 'Audit', label: 'ç³»ç»Ÿå®‰å…¨æ—¥å¿—', icon: Laptop },
  ];

  const renderContent = () => {
    if (loading) {
      return (
        <div className="flex items-center justify-center py-20">
          <Loader2 className="animate-spin text-indigo-600" size={40} />
          <span className="ml-3 text-slate-500 font-bold">åŠ è½½è®¾ç½®ä¸­...</span>
        </div>
      );
    }

    switch (activeTab) {
      case 'General':
        // ç¦åˆ©æ ‡ç­¾é€‰é¡¹
        const benefitOptions = [
          'äº”é™©ä¸€é‡‘', 'å¹´ç»ˆå¥–', 'å¸¦è–ªå¹´å‡', 'å¼¹æ€§å·¥ä½œ', 'é¤è¡¥', 'äº¤é€šè¡¥è´´', 'å‘˜å·¥åŸ¹è®­', 'èŠ‚æ—¥ç¦åˆ©'
        ];
        // å½“å‰é€‰ä¸­çš„ç¦åˆ©
        const selectedBenefits = (() => {
          try {
            return JSON.parse(settings.benefits || '[]');
          } catch {
            return [];
          }
        })();
        // åˆ‡æ¢ç¦åˆ©æ ‡ç­¾
        const toggleBenefit = (benefit: string) => {
          const newBenefits = selectedBenefits.includes(benefit)
            ? selectedBenefits.filter((b: string) => b !== benefit)
            : [...selectedBenefits, benefit];
          setSettings({...settings, benefits: JSON.stringify(newBenefits)});
        };
        
        return (
          <div className="space-y-6 animate-in fade-in duration-500">
            <h3 className="text-2xl font-black text-slate-900">åŸºç¡€ä¿¡æ¯è®¾ç½®</h3>
            
            {/* ä¼ä¸šLogo */}
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h4 className="text-sm font-bold text-slate-700 mb-4">ä¼ä¸šLogo</h4>
              <div className="flex items-center gap-6">
                <div 
                  onClick={() => logoInputRef.current?.click()}
                  className="w-24 h-24 rounded-2xl border-2 border-dashed border-slate-200 hover:border-indigo-300 flex items-center justify-center cursor-pointer transition-all group overflow-hidden bg-slate-50 hover:bg-indigo-50/50 flex-shrink-0"
                >
                  {logoUploading ? (
                    <Loader2 className="animate-spin text-indigo-600" size={24} />
                  ) : user?.company_logo ? (
                    <img src={user.company_logo.startsWith('/') ? `${window.location.origin}${user.company_logo}` : user.company_logo} alt="Logo" className="w-full h-full object-contain p-2" />
                  ) : (
                    <div className="text-center">
                      <ImageIcon size={24} className="mx-auto text-slate-300 group-hover:text-indigo-400 transition-colors" />
                      <span className="text-[10px] text-slate-400 mt-1 block">ä¸Šä¼ Logo</span>
                    </div>
                  )}
                </div>
                <input 
                  ref={logoInputRef}
                  type="file"
                  accept="image/*"
                  className="hidden"
                  onChange={async (e) => {
                    const file = e.target.files?.[0];
                    if (!file) return;
                    if (file.size > 5 * 1024 * 1024) {
                      showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB', 'error');
                      return;
                    }
                    setLogoUploading(true);
                    try {
                      const { uploadCompanyLogo } = await import('./services/apiService');
                      await uploadCompanyLogo(file);
                      await refreshUser();
                      showToast('ä¼ä¸šLogoæ›´æ–°æˆåŠŸ', 'success');
                      navigate('/settings?tab=General', { replace: true });
                    } catch (err: any) {
                      showToast(err.message || 'Logoä¸Šä¼ å¤±è´¥', 'error');
                    } finally {
                      setLogoUploading(false);
                      e.target.value = '';
                    }
                  }}
                />
                <div className="text-sm text-slate-500">
                  <p className="font-medium text-slate-700 mb-1">ç‚¹å‡»ä¸Šä¼ ä¼ä¸šLogo</p>
                  <p className="text-xs text-slate-400">æ”¯æŒ JPGã€PNGã€WEBPã€SVG æ ¼å¼ï¼Œä¸è¶…è¿‡ 5MB</p>
                  <p className="text-xs text-slate-400 mt-0.5">å»ºè®®ä½¿ç”¨æ­£æ–¹å½¢é€æ˜åº•å›¾ç‰‡ï¼Œæ˜¾ç¤ºæ•ˆæœæ›´ä½³</p>
                  {user?.company_logo && (
                    <button 
                      onClick={() => logoInputRef.current?.click()} 
                      className="mt-2 text-xs text-indigo-600 font-bold hover:underline"
                    >
                      æ›´æ¢Logo
                    </button>
                  )}
                </div>
              </div>
            </div>

            {/* ä¼ä¸šä¿¡æ¯ */}
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div className="md:col-span-2">
                  <label className="text-xs font-bold text-slate-500 block mb-1.5">ä¼ä¸šå…¨ç§°</label>
                  <input 
                    type="text" 
                    value={settings.display_name || ''} 
                    onChange={(e) => updateField('display_name', e.target.value)}
                    placeholder="ä¸è¥ä¸šæ‰§ç…§ä¸€è‡´çš„ä¼ä¸šåç§°"
                    className={`w-full bg-slate-50 border rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 ${fieldErrors.display_name ? 'border-red-300 bg-red-50' : 'border-slate-200 focus:border-indigo-300'}`} 
                  />
                  {fieldErrors.display_name && <p className="text-xs text-red-500 mt-1 flex items-center gap-1"><AlertCircle size={12} /> {fieldErrors.display_name}</p>}
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1.5">ä¼ä¸šç®€ç§°</label>
                  <input 
                    type="text" 
                    value={settings.short_name || ''} 
                    onChange={(e) => updateField('short_name', e.target.value)}
                    placeholder="å¦‚ï¼šå­—èŠ‚ã€é˜¿é‡Œ"
                    className={`w-full bg-slate-50 border rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 ${fieldErrors.short_name ? 'border-red-300 bg-red-50' : 'border-slate-200 focus:border-indigo-300'}`} 
                  />
                  {fieldErrors.short_name && <p className="text-xs text-red-500 mt-1 flex items-center gap-1"><AlertCircle size={12} /> {fieldErrors.short_name}</p>}
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1.5">æ‰€å±è¡Œä¸š</label>
                  <select 
                    value={settings.industry || ''}
                    onChange={(e) => updateField('industry', e.target.value)}
                    className="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-300"
                  >
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="äº’è”ç½‘/IT">äº’è”ç½‘/IT</option>
                    <option value="äººå·¥æ™ºèƒ½">äººå·¥æ™ºèƒ½</option>
                    <option value="é‡‘è/æŠ•èµ„">é‡‘è/æŠ•èµ„</option>
                    <option value="æ•™è‚²åŸ¹è®­">æ•™è‚²åŸ¹è®­</option>
                    <option value="åŒ»ç–—å¥åº·">åŒ»ç–—å¥åº·</option>
                    <option value="åˆ¶é€ ä¸š">åˆ¶é€ ä¸š</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1.5">ä¼ä¸šè§„æ¨¡</label>
                  <select 
                    value={settings.company_size || ''}
                    onChange={(e) => updateField('company_size', e.target.value)}
                    className="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-300"
                  >
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="0-20äºº">0-20äºº</option>
                    <option value="20-99äºº">20-99äºº</option>
                    <option value="100-499äºº">100-499äºº</option>
                    <option value="500-999äºº">500-999äºº</option>
                    <option value="1000äººä»¥ä¸Š">1000äººä»¥ä¸Š</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1.5">èèµ„é˜¶æ®µ</label>
                  <select 
                    value={settings.funding_stage || ''}
                    onChange={(e) => updateField('funding_stage', e.target.value)}
                    className="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-300"
                  >
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="æœªèèµ„">æœªèèµ„</option>
                    <option value="å¤©ä½¿è½®">å¤©ä½¿è½®</option>
                    <option value="Aè½®">Aè½®</option>
                    <option value="Bè½®">Bè½®</option>
                    <option value="Cè½®åŠä»¥ä¸Š">Cè½®åŠä»¥ä¸Š</option>
                    <option value="å·²ä¸Šå¸‚">å·²ä¸Šå¸‚</option>
                    <option value="ä¸éœ€è¦èèµ„">ä¸éœ€è¦èèµ„</option>
                  </select>
                </div>
              </div>
            </div>

            {/* è”ç³»æ–¹å¼ */}
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h4 className="text-sm font-bold text-slate-700 mb-4">è”ç³»æ–¹å¼</h4>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div className="md:col-span-2">
                  <label className="text-xs font-bold text-slate-500 block mb-1.5">å…¬å¸åœ°å€</label>
                  <input 
                    type="text" 
                    value={settings.detail_address || ''} 
                    onChange={(e) => updateField('detail_address', e.target.value)}
                    placeholder="å¦‚ï¼šæµ™æ±Ÿçœæ­å·å¸‚è¥¿æ¹–åŒºæ–‡ä¸‰è·¯XXXå·"
                    className={`w-full bg-slate-50 border rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 ${fieldErrors.detail_address ? 'border-red-300 bg-red-50' : 'border-slate-200 focus:border-indigo-300'}`} 
                  />
                  {fieldErrors.detail_address && <p className="text-xs text-red-500 mt-1 flex items-center gap-1"><AlertCircle size={12} /> {fieldErrors.detail_address}</p>}
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1.5">HRå§“å</label>
                  <input 
                    type="text" 
                    value={settings.contact_name || ''} 
                    onChange={(e) => updateField('contact_name', e.target.value)}
                    placeholder="è”ç³»äººå§“å"
                    className={`w-full bg-slate-50 border rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 ${fieldErrors.contact_name ? 'border-red-300 bg-red-50' : 'border-slate-200 focus:border-indigo-300'}`} 
                  />
                  {fieldErrors.contact_name && <p className="text-xs text-red-500 mt-1 flex items-center gap-1"><AlertCircle size={12} /> {fieldErrors.contact_name}</p>}
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1.5">è”ç³»ç”µè¯</label>
                  <input 
                    type="tel" 
                    value={settings.hr_phone || ''} 
                    onChange={(e) => updateField('hr_phone', e.target.value)}
                    placeholder="æ‰‹æœºå·æˆ–åº§æœº"
                    className={`w-full bg-slate-50 border rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 ${fieldErrors.hr_phone ? 'border-red-300 bg-red-50' : 'border-slate-200 focus:border-indigo-300'}`} 
                  />
                  {fieldErrors.hr_phone && <p className="text-xs text-red-500 mt-1 flex items-center gap-1"><AlertCircle size={12} /> {fieldErrors.hr_phone}</p>}
                </div>
              </div>
            </div>

            {/* ä¼ä¸šç®€ä»‹ */}
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h4 className="text-sm font-bold text-slate-700 mb-4">ä¼ä¸šç®€ä»‹</h4>
              <textarea 
                rows={3} 
                value={settings.description || ''} 
                onChange={(e) => updateField('description', e.target.value)}
                placeholder="ç®€è¦ä»‹ç»ä¼ä¸šä¸šåŠ¡ã€æ–‡åŒ–ç­‰"
                className={`w-full bg-slate-50 border rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 resize-none ${fieldErrors.description ? 'border-red-300 bg-red-50' : 'border-slate-200 focus:border-indigo-300'}`} 
              />
              <div className="flex justify-between mt-1">
                {fieldErrors.description ? <p className="text-xs text-red-500 flex items-center gap-1"><AlertCircle size={12} /> {fieldErrors.description}</p> : <span></span>}
                <span className="text-xs text-slate-400">{(settings.description || '').length}/1000</span>
              </div>
            </div>

            {/* ç¦åˆ©æ ‡ç­¾ */}
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h4 className="text-sm font-bold text-slate-700 mb-4">ä¼ä¸šç¦åˆ©</h4>
              <div className="flex flex-wrap gap-2">
                {benefitOptions.map(benefit => (
                  <button
                    key={benefit}
                    type="button"
                    onClick={() => toggleBenefit(benefit)}
                    className={`px-3 py-1.5 rounded-full text-xs font-medium transition-all ${
                      selectedBenefits.includes(benefit)
                        ? 'bg-indigo-600 text-white'
                        : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                    }`}
                  >
                    {selectedBenefits.includes(benefit) && <Check size={12} className="inline mr-1" />}
                    {benefit}
                  </button>
                ))}
              </div>
            </div>

            {/* ä¿å­˜æŒ‰é’® */}
            <div className="flex justify-end">
              <button 
                onClick={handleSaveSettings}
                disabled={saving}
                className="bg-indigo-600 text-white px-8 py-2.5 rounded-lg font-bold text-sm hover:bg-indigo-700 transition-all flex items-center gap-2 disabled:opacity-50"
              >
                {saving ? <Loader2 size={16} className="animate-spin" /> : <Save size={16} />} 
                {saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
              </button>
            </div>
          </div>
        );
      case 'Verification': {
        const qualificationCerts = enterpriseCerts.filter((c: any) => c.category === 'qualification');
        return (
          <div className="space-y-8 animate-in fade-in duration-500">
            <h3 className="text-2xl font-black text-slate-900 flex items-center gap-3">ä¼ä¸šè®¤è¯ä¿¡æ¯</h3>
            
            <div className="bg-white rounded-lg p-10 border border-slate-100 shadow-sm space-y-8">
              <div>
                <h4 className="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
                  <Award size={20} className="text-amber-500" /> èµ„è´¨è®¤è¯
                </h4>
                {qualificationCerts.length === 0 ? (
                  <div className="text-center py-8 text-slate-400">
                    <Medal size={32} className="mx-auto mb-2 opacity-50" />
                    <p className="text-sm">æš‚æ— èµ„è´¨è®¤è¯ä¿¡æ¯</p>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {qualificationCerts.map((cert: any, idx: number) => {
                      const isBusinessLicense = cert.name?.includes('è¥ä¸šæ‰§ç…§');
                      const isLegalPersonId = cert.name?.includes('æ³•äººèº«ä»½è¯') && !cert.name?.includes('æ­£é¢') && !cert.name?.includes('èƒŒé¢');
                      const isFullWidth = isBusinessLicense;
                      
                      return (
                        <div key={idx} className={`p-5 rounded-lg border ${cert.color || 'bg-amber-50 border-amber-200'} flex items-start gap-4 ${isFullWidth ? 'col-span-2' : ''} relative`}>
                          <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm">
                            {isBusinessLicense ? <Building2 size={24} className="text-indigo-600" /> : 
                             isLegalPersonId ? <Fingerprint size={24} className="text-blue-600" /> :
                             <Medal size={24} className="text-amber-500" />}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center justify-between">
                              <h5 className="font-black text-slate-900 text-base">{isLegalPersonId ? 'æ³•äººèº«ä»½è¯' : cert.name}</h5>
                              <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded text-xs font-bold flex-shrink-0">
                                {cert.status === 'valid' ? 'å·²è®¤è¯' : cert.status}
                              </span>
                            </div>
                            {isBusinessLicense && !isLegalPersonId && (
                              <p className="text-xs text-slate-500 mt-1">æ³•å®šä»£è¡¨äººï¼š{cert.organization}</p>
                            )}
                            {isBusinessLicense && (
                              <div className="mt-3 space-y-1 text-xs text-slate-600 bg-slate-50 p-3 rounded-lg">
                                {cert.credit_code && (
                                  <p><span className="font-bold">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ï¼š</span>{cert.credit_code}</p>
                                )}
                                {cert.valid_period && (
                                  <p><span className="font-bold">æœ‰æ•ˆæœŸï¼š</span>{cert.valid_period}</p>
                                )}
                                {cert.business_address && (
                                  <p><span className="font-bold">ä½æ‰€ï¼š</span>{cert.business_address}</p>
                                )}
                                {cert.registered_capital && (
                                  <p><span className="font-bold">æ³¨å†Œèµ„æœ¬ï¼š</span>{cert.registered_capital}</p>
                                )}
                                {cert.business_scope && (
                                  <p className="line-clamp-2"><span className="font-bold">ç»è¥èŒƒå›´ï¼š</span>{cert.business_scope}</p>
                                )}
                              </div>
                            )}
                            {isLegalPersonId && cert.id_card_name && (
                              <p className="text-sm text-slate-600 mt-1">å§“å: {cert.id_card_name}</p>
                            )}
                            {isLegalPersonId && cert.id_card_number && (
                              <p className="text-xs text-slate-500 mt-1 font-mono">{cert.id_card_number.replace(/^(.{6})(.*)(.{4})$/, '$1****$3')}</p>
                            )}
                            {isLegalPersonId && cert.id_card_authority && (
                              <p className="text-xs text-slate-500 mt-1">å‘è¯æœºå…³: {cert.id_card_authority}</p>
                            )}
                            {isLegalPersonId && cert.id_card_valid_period && (
                              <p className="text-xs text-slate-400 mt-1">æœ‰æ•ˆæœŸ: {cert.id_card_valid_period}</p>
                            )}
                            <div className="flex items-center gap-2 mt-3 flex-wrap">
                              <span className="text-xs text-slate-400">è®¤è¯æ—¥æœŸ: {cert.date}</span>
                              {isBusinessLicense && cert.image_data && (
                                <button 
                                  onClick={() => {
                                    const win = window.open('', '_blank');
                                    if (win) {
                                      win.document.write(`<html><head><title>è¥ä¸šæ‰§ç…§åŸä»¶</title></head><body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f1f5f9;"><img src="data:image/jpeg;base64,${cert.image_data}" style="max-width:100%;max-height:100vh;box-shadow:0 4px 12px rgba(0,0,0,0.1);"/></body></html>`);
                                      win.document.close();
                                    }
                                  }}
                                  className="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs font-bold hover:bg-indigo-200 transition-colors"
                                >
                                  æŸ¥çœ‹åŸä»¶
                                </button>
                              )}

                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>

            </div>
          </div>
        );
      }
      case 'PersonalVerification': {
        // æŒ‰ç±»åˆ«åˆ†ç»„è®¤è¯æ•°æ®
        const identityCerts = personalCerts.filter(c => c.category === 'identity');
        const educationCerts = personalCerts.filter(c => c.category === 'education');
        const skillCerts = personalCerts.filter(c => c.category === 'skill');  // æŠ€èƒ½è®¤è¯ï¼šé©¾é©¶è¯ã€èŒä¸šè¯ä¹¦
        const workCerts = personalCerts.filter(c => c.category === 'work');    // å·¥ä½œè¯æ˜ï¼šè¿‡å¾€å·¥ä½œç»å†è®¤è¯
        const creditCerts = personalCerts.filter(c => c.category === 'credit');
        const awardCerts = personalCerts.filter(c => c.category === 'award');
        
        // çŠ¶æ€æ˜¾ç¤ºæ˜ å°„
        const getStatusDisplay = (status: string) => {
          const statusMap: Record<string, string> = {
            'valid': 'å·²è®¤è¯',
            'expired': 'å·²è¿‡æœŸ',
            'pending': 'å¾…å®¡æ ¸',
            'verified': 'å·²è®¤è¯'
          };
          return statusMap[status] || status;
        };
        
        // é¢œè‰²æ ·å¼æ˜ å°„
        const getColorClass = (color: string | undefined, defaultColor: string) => {
          // é¢œè‰²åç§°åˆ° CSS ç±»åçš„æ˜ å°„
          const colorMap: Record<string, string> = {
            'blue': 'bg-blue-50 border-blue-200',
            'green': 'bg-green-50 border-green-200',
            'indigo': 'bg-indigo-50 border-indigo-200',
            'purple': 'bg-purple-50 border-purple-200',
            'amber': 'bg-amber-50 border-amber-200',
            'orange': 'bg-orange-50 border-orange-200',
            'red': 'bg-red-50 border-red-200',
            'gray': 'bg-gray-50 border-gray-200'
          };
          return color ? (colorMap[color] || defaultColor) : defaultColor;
        };
        
        return (
          <div className="space-y-8 animate-in fade-in duration-500">
            <h3 className="text-2xl font-black text-slate-900 flex items-center gap-3">ä¸ªäººè®¤è¯ä¿¡æ¯</h3>
            
            <div className="bg-white rounded-lg p-10 border border-slate-100 shadow-sm space-y-8">
              {/* èº«ä»½è®¤è¯ */}
              <div>
                <h4 className="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
                  <Fingerprint size={20} className="text-blue-500" /> èº«ä»½è®¤è¯
                </h4>
                {identityCerts.length > 0 ? (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {identityCerts.map((identity, idx) => {
                      // ä» "å®åè®¤è¯ - é™ˆæŸ¯å¥½" ä¸­æå–å§“å
                      const displayName = identity.name?.replace(/^å®åè®¤è¯\s*[-â€“â€”]\s*/, '') || 'å·²è®¤è¯';
                      return (
                        <div key={identity.id || idx} className={`p-5 rounded-lg border ${getColorClass(identity.color, 'bg-blue-50 border-blue-200')} flex items-start gap-4`}>
                          <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm">
                            {identity.icon === 'Scan' ? <Scan size={24} className="text-blue-600" /> : <Fingerprint size={24} className="text-blue-600" />}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-2">
                                <h5 className="font-black text-slate-900 text-base">{displayName}</h5>
                                {identity.major && (
                                  <span className="text-xs text-slate-500">{identity.major}</span>
                                )}
                              </div>
                              <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded text-xs font-bold flex-shrink-0">{getStatusDisplay(identity.status)}</span>
                            </div>
                            {identity.level && (
                              <p className="text-sm text-slate-600 mt-2 font-mono">{identity.level}</p>
                            )}
                            {identity.degree && (
                              <p className="text-xs text-slate-500 mt-1">{identity.degree}</p>
                            )}
                            {identity.organization && (
                              <p className="text-xs text-slate-400 mt-2">{identity.organization}</p>
                            )}
                            {identity.date && (
                              <p className="text-xs text-slate-400 mt-1">æœ‰æ•ˆæœŸ: {identity.date}</p>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <div className="text-center py-8 text-slate-400">
                    <Fingerprint size={32} className="mx-auto mb-2 opacity-50" />
                    <p className="text-sm">æš‚æ— èº«ä»½è®¤è¯ä¿¡æ¯</p>
                    <button className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 transition-colors">
                      ç«‹å³è®¤è¯
                    </button>
                  </div>
                )}
              </div>

              {/* å­¦å†è®¤è¯ */}
              <div>
                <h4 className="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
                  <GraduationCap size={20} className="text-indigo-500" /> å­¦å†è®¤è¯
                </h4>
                {educationCerts.length > 0 ? (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {educationCerts.map((edu, idx) => (
                      <div key={edu.id || idx} className={`p-5 rounded-lg border ${getColorClass(edu.color, 'bg-indigo-50 border-indigo-200')} flex items-start gap-4`}>
                        <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm">
                          <GraduationCap size={24} className="text-indigo-600" />
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center justify-between">
                            <h5 className="font-black text-slate-900 text-base">{edu.name || 'å­¦å†è®¤è¯'}</h5>
                            <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded text-xs font-bold flex-shrink-0">{getStatusDisplay(edu.status)}</span>
                          </div>
                          <p className="text-sm text-slate-600 mt-1">{edu.organization}</p>
                          <p className="text-xs text-slate-500 mt-1">{edu.degree} Â· {edu.major}</p>
                          <p className="text-xs text-slate-400 mt-2">æ¯•ä¸šæ—¶é—´: {edu.date}</p>
                          {edu.cert_number && <p className="text-xs text-slate-400 font-mono mt-1">è¯ä¹¦ç¼–å·: {edu.cert_number}</p>}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-8 text-slate-400">
                    <GraduationCap size={32} className="mx-auto mb-2 opacity-50" />
                    <p className="text-sm">æš‚æ— å­¦å†è®¤è¯ä¿¡æ¯</p>
                  </div>
                )}
              </div>

              {/* æŠ€èƒ½è®¤è¯ */}
              <div>
                <h4 className="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
                  <Award size={20} className="text-purple-500" /> æŠ€èƒ½è®¤è¯
                </h4>
                {skillCerts.length > 0 ? (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {skillCerts.map((cert, idx) => (
                      <div key={cert.id || idx} className={`p-5 rounded-lg border ${getColorClass(cert.color, 'bg-purple-50 border-purple-200')} flex items-start gap-4`}>
                        <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm">
                          {cert.icon === 'Car' ? <Car size={24} className="text-purple-600" /> : <Award size={24} className="text-purple-600" />}
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center justify-between">
                            <h5 className="font-black text-slate-900 text-base">{cert.name}</h5>
                            <span className={`px-2 py-0.5 rounded text-xs font-bold flex-shrink-0 ${cert.name === 'é©¾é©¶è¯' ? 'bg-emerald-100 text-emerald-700' : 'bg-blue-100 text-blue-700'}`}>
                              {cert.name === 'é©¾é©¶è¯' ? getStatusDisplay(cert.status) : 'å·²ä¸Šä¼ '}
                            </span>
                          </div>
                          {cert.name === 'é©¾é©¶è¯' ? (
                            <>
                              {cert.organization && <p className="text-sm text-slate-600 mt-1">å§“å: {cert.organization}</p>}
                              {cert.level && <p className="text-xs text-slate-500 mt-1">å‡†é©¾è½¦å‹: {cert.level}</p>}
                              {cert.cert_number && <p className="text-xs text-slate-400 font-mono mt-1">è¯ä¹¦ç¼–å·: {cert.cert_number}</p>}
                              <p className="text-xs text-slate-400 mt-1">æœ‰æ•ˆæœŸ: {cert.date || 'é•¿æœŸæœ‰æ•ˆ'}</p>
                            </>
                          ) : (
                            <>
                              {cert.major && <p className="text-sm text-slate-600 mt-1">å§“å: {cert.major}</p>}
                              {cert.cert_number && <p className="text-xs text-slate-400 font-mono mt-1">è¯ä¹¦ç¼–å·: {cert.cert_number}</p>}
                              {cert.organization && <p className="text-xs text-slate-500 mt-1">å‘è¯æœºæ„: {cert.organization}</p>}
                              {cert.level && <p className="text-xs text-slate-500 mt-1">ç­‰çº§: {cert.level}</p>}
                            </>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-8 text-slate-400">
                    <Award size={32} className="mx-auto mb-2 opacity-50" />
                    <p className="text-sm">æš‚æ— æŠ€èƒ½è®¤è¯ä¿¡æ¯</p>
                    <p className="text-xs mt-1">æ”¯æŒé©¾é©¶è¯ã€èŒä¸šèµ„æ ¼è¯ä¹¦ç­‰</p>
                  </div>
                )}
              </div>

              {/* å·¥ä½œè¯æ˜ */}
              <div>
                <h4 className="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
                  <Briefcase size={20} className="text-amber-500" /> å·¥ä½œè¯æ˜
                </h4>
                {workCerts.length > 0 ? (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {workCerts.map((work, idx) => (
                      <div key={work.id || idx} className={`p-5 rounded-lg border ${getColorClass(work.color, 'bg-amber-50 border-amber-200')} flex items-start gap-4`}>
                        <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm">
                          <Briefcase size={24} className="text-amber-600" />
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center justify-between mb-1">
                            <h5 className="font-black text-slate-900 text-base truncate">{work.name}</h5>
                            <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-bold flex-shrink-0 ml-2">å·²ä¸Šä¼ </span>
                          </div>
                          <p className="text-sm text-amber-700 font-medium">
                            {work.organization}{work.degree && ` Â· ${work.degree}`}
                          </p>
                          <div className="flex items-center gap-3 mt-2 text-xs text-slate-500">
                            {work.major && <span>è®¤è¯æ–¹å¼: {work.major}</span>}
                            {work.date && <span>åœ¨èŒæ—¶é—´: {work.date}</span>}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-8 text-slate-400">
                    <Briefcase size={32} className="mx-auto mb-2 opacity-50" />
                    <p className="text-sm">æš‚æ— å·¥ä½œè¯æ˜</p>
                    <p className="text-xs mt-1">æ”¯æŒå·¥ç‰Œã€ä¼ä¸šé‚®ç®±ã€åœ¨èŒ/ç¦»èŒè¯æ˜ç­‰</p>
                  </div>
                )}
              </div>

              {/* å¾ä¿¡è®¤è¯ */}
              <div>
                <h4 className="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
                  <FileCheck size={20} className="text-orange-500" /> å¾ä¿¡è®¤è¯
                </h4>
                {creditCerts.length > 0 ? (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {creditCerts.map((credit, idx) => (
                      <div key={credit.id || idx} className={`p-5 rounded-lg border ${getColorClass(credit.color, 'bg-orange-50 border-orange-200')} flex items-start gap-4`}>
                        <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm">
                          {credit.name === 'å…¬ç§¯é‡‘è¯æ˜' ? <Building size={24} className="text-orange-600" /> : <ShieldCheck size={24} className="text-orange-600" />}
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center justify-between">
                            <h5 className="font-black text-slate-900 text-base">{credit.name}</h5>
                            <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-bold flex-shrink-0">å·²ä¸Šä¼ </span>
                          </div>
                          {credit.organization && <p className="text-sm text-slate-600 mt-1">å§“å: {credit.organization}</p>}
                          {credit.level && <p className="text-xs text-slate-500 mt-1">{credit.name === 'å…¬ç§¯é‡‘è¯æ˜' ? 'ç¼´å­˜åŸºæ•°' : 'å‚ä¿ç±»å‹'}: {credit.level}</p>}
                          {credit.major && <p className="text-xs text-slate-500">{credit.name === 'å…¬ç§¯é‡‘è¯æ˜' ? 'ç¼´å­˜çŠ¶æ€' : 'ç¼´çº³çŠ¶æ€'}: {credit.major}</p>}
                          {credit.date && <p className="text-xs text-slate-400 mt-2">{credit.name === 'å…¬ç§¯é‡‘è¯æ˜' ? 'ç¼´å­˜æ—¶é—´' : 'ç¼´çº³æ—¶é—´'}: {credit.date}</p>}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-8 text-slate-400">
                    <FileCheck size={32} className="mx-auto mb-2 opacity-50" />
                    <p className="text-sm">æš‚æ— å¾ä¿¡è®¤è¯ä¿¡æ¯</p>
                    <p className="text-xs mt-1">æ”¯æŒå…¬ç§¯é‡‘è¯æ˜ã€ç¤¾ä¿è¯æ˜</p>
                  </div>
                )}
              </div>

            </div>
          </div>
        );
      }
      case 'AccountInfo': {
        // è´¦å·ä¿¡æ¯æ ¡éªŒ
        const validateAccountField = (key: string, value: string): string => {
          if (key === 'name') {
            if (!value.trim()) return 'å§“åä¸èƒ½ä¸ºç©º';
            if (value.trim().length < 2) return 'å§“åè‡³å°‘ 2 ä¸ªå­—ç¬¦';
            if (value.trim().length > 20) return 'å§“åä¸èƒ½è¶…è¿‡ 20 ä¸ªå­—ç¬¦';
          }
          if (key === 'phone' && value) {
            const mobileReg = /^1[3-9]\d{9}$/;
            const landlineReg = /^0\d{2,3}\d{7,8}$/;
            if (!mobileReg.test(value) && !landlineReg.test(value)) return 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ';
          }
          if (key === 'email') {
            if (!value.trim()) return 'é‚®ç®±ä¸èƒ½ä¸ºç©º';
            const emailReg = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailReg.test(value)) return 'è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±åœ°å€';
          }
          return '';
        };

        const handleAccountSave = async () => {
          const errors: Record<string, string> = {};
          const err = validateAccountField('name', accountInfo.name);
          if (err) errors['name'] = err;
          setAccountErrors(errors);
          if (Object.keys(errors).length > 0) {
            showToast('è¯·ä¿®æ­£æ ‡çº¢çš„å­—æ®µåå†ä¿å­˜', 'error');
            return;
          }
          setAccountSaving(true);
          try {
            await updateUser({ name: accountInfo.name });
            await refreshUser();
            showToast('å§“åå·²æ›´æ–°', 'success');
            setAccountEditing(false);
          } catch (error: any) {
            showToast(error.message || 'ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
          } finally {
            setAccountSaving(false);
          }
        };

        // å‘é€éªŒè¯ç 
        const handleSendVerifyCode = async () => {
          setVerifySending(true);
          try {
            await new Promise(r => setTimeout(r, 800));
            const targetEmail = verifyModal.type === 'email' && verifyModal.step === 'old' ? user?.email : verifyModal.newValue;
            showToast(`éªŒè¯ç å·²å‘é€è‡³ ${targetEmail}`, 'success');
            setVerifyCountdown(60);
            const timer = setInterval(() => {
              setVerifyCountdown(prev => {
                if (prev <= 1) { clearInterval(timer); return 0; }
                return prev - 1;
              });
            }, 1000);
          } catch (e: any) {
            showToast('éªŒè¯ç å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
          } finally {
            setVerifySending(false);
          }
        };

        // æäº¤éªŒè¯
        const handleVerifySubmit = async () => {
          if (!verifyCode || verifyCode.length !== 6) {
            showToast('è¯·è¾“å…¥ 6 ä½éªŒè¯ç ', 'error');
            return;
          }
          setVerifySubmitting(true);
          try {
            await new Promise(r => setTimeout(r, 600));
            
            // é‚®ç®±åŒé‡éªŒè¯ï¼šå…ˆéªŒè¯åŸé‚®ç®±ï¼Œå†éªŒè¯æ–°é‚®ç®±
            if (verifyModal.type === 'email' && verifyModal.step === 'old') {
              // åŸé‚®ç®±éªŒè¯é€šè¿‡ï¼Œè¿›å…¥æ–°é‚®ç®±éªŒè¯
              setVerifyModal(prev => ({ ...prev, step: 'new' }));
              setVerifyCode('');
              setVerifyCountdown(0);
              setVerifySubmitting(false);
              showToast('åŸé‚®ç®±éªŒè¯é€šè¿‡ï¼Œè¯·ç»§ç»­éªŒè¯æ–°é‚®ç®±', 'success');
              return;
            }
            
            if (verifyModal.type === 'phone') {
              await updateUser({ phone: verifyModal.newValue });
            }
            // é‚®ç®±ä¿®æ”¹æˆåŠŸï¼ˆå®é™…éœ€è¦åç«¯æ”¯æŒï¼‰
            await refreshUser();
            showToast(`${verifyModal.type === 'phone' ? 'æ‰‹æœºå·' : 'é‚®ç®±'}ä¿®æ”¹æˆåŠŸ`, 'success');
            setVerifyModal({show: false, type: 'phone', newValue: '', step: 'old'});
            setVerifyCode('');
            setVerifyCountdown(0);
          } catch (e: any) {
            showToast(e.message || 'éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
          } finally {
            setVerifySubmitting(false);
          }
        };

        const openPhoneVerify = () => {
          const phone = accountInfo.phone || '';
          const phoneErr = validateAccountField('phone', phone);
          if (!phone) { showToast('è¯·å…ˆè¾“å…¥æ–°æ‰‹æœºå·', 'error'); return; }
          if (phoneErr) { showToast(phoneErr, 'error'); return; }
          if (phone === (user?.phone || '')) { showToast('æ–°æ‰‹æœºå·ä¸å½“å‰æ‰‹æœºå·ç›¸åŒ', 'warning'); return; }
          setVerifyModal({show: true, type: 'phone', newValue: phone, step: 'old'});
          setVerifyCode(''); setVerifyCountdown(0);
        };

        const openEmailVerify = () => {
          const email = accountInfo.email || '';
          const emailErr = validateAccountField('email', email);
          if (!email) { showToast('è¯·å…ˆè¾“å…¥æ–°é‚®ç®±', 'error'); return; }
          if (emailErr) { showToast(emailErr, 'error'); return; }
          if (email === (user?.email || '')) { showToast('æ–°é‚®ç®±ä¸å½“å‰é‚®ç®±ç›¸åŒ', 'warning'); return; }
          setVerifyModal({show: true, type: 'email', newValue: email, step: 'old'});
          setVerifyCode(''); setVerifyCountdown(0);
        };

        const handlePasswordChange = async () => {
          if (!passwordForm.oldPassword) { showToast('è¯·è¾“å…¥å½“å‰å¯†ç ', 'error'); return; }
          if (!passwordForm.newPassword) { showToast('è¯·è¾“å…¥æ–°å¯†ç ', 'error'); return; }
          if (passwordForm.newPassword.length < 6) { showToast('æ–°å¯†ç è‡³å°‘ 6 ä½', 'error'); return; }
          if (passwordForm.newPassword !== passwordForm.confirmPassword) { showToast('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´', 'error'); return; }
          setPasswordChanging(true);
          try {
            await changePassword(passwordForm.oldPassword, passwordForm.newPassword);
            showToast('å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
            setPasswordForm({ oldPassword: '', newPassword: '', confirmPassword: '' });
            setShowPasswordForm(false);
          } catch (error: any) {
            showToast(error.message || 'å¯†ç ä¿®æ”¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥å½“å‰å¯†ç æ˜¯å¦æ­£ç¡®', 'error');
          } finally {
            setPasswordChanging(false);
          }
        };

        const thirdPartyLogins = [
          { key: 'wechat', name: 'å¾®ä¿¡', icon: MessageCircle, color: 'text-green-500', bgColor: 'bg-green-50', connected: false },
          { key: 'github', name: 'GitHub', icon: GithubIcon, color: 'text-slate-800', bgColor: 'bg-slate-50', connected: false },

          { key: 'google', name: 'Google', icon: Globe, color: 'text-red-500', bgColor: 'bg-red-50', connected: false },
        ];

        const maskPhone = (phone: string) => phone ? phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2') : '';
        const maskEmail = (email: string) => {
          if (!email) return '';
          const [local, domain] = email.split('@');
          if (local.length <= 2) return `${local[0]}***@${domain}`;
          return `${local[0]}${local[1]}***@${domain}`;
        };
        const formatUID = (id: number) => `UID: ${id}`;

        return (
          <div className="space-y-6 animate-in fade-in duration-500">
            <div className="flex items-center justify-between">
              <h3 className="text-2xl font-black text-slate-900">è´¦å·ä¿¡æ¯</h3>
              {!accountEditing ? (
                <button
                  onClick={() => { setAccountEditing(true); setAccountInfo({ name: user?.name || '', phone: user?.phone || '', email: user?.email || '', avatar_url: user?.avatar_url || '' }); }}
                  className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 transition-all"
                >
                  <Edit3 size={14} /> ç¼–è¾‘
                </button>
              ) : (
                <div className="flex items-center gap-2">
                  <button onClick={() => { setAccountEditing(false); setAccountErrors({}); setAccountInfo({ name: user?.name || '', phone: user?.phone || '', email: user?.email || '', avatar_url: user?.avatar_url || '' }); }} className="px-4 py-2 border border-slate-200 text-slate-600 rounded-lg text-sm font-bold hover:bg-slate-50 transition-all">å–æ¶ˆ</button>
                  <button onClick={handleAccountSave} disabled={accountSaving} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 transition-all disabled:opacity-50">
                    {accountSaving ? <Loader2 size={14} className="animate-spin" /> : <Save size={14} />} ä¿å­˜
                  </button>
                </div>
              )}
            </div>

            {/* ä¸ªäººä¿¡æ¯ */}
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h4 className="text-sm font-bold text-slate-700 mb-4">ä¸ªäººä¿¡æ¯</h4>
              <div className="flex items-center gap-5 mb-5 pb-5 border-b border-slate-100">
                <div className="relative group flex-shrink-0">
                  <div className="w-14 h-14 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-lg font-black overflow-hidden">
                    {user?.avatar_url ? <img src={user.avatar_url} alt="" className="w-full h-full object-cover" /> : (user?.name?.charAt(0)?.toUpperCase() || 'U')}
                  </div>
                  <input
                    ref={avatarInputRef}
                    type="file"
                    accept="image/jpeg,image/png,image/webp,image/gif"
                    className="hidden"
                    onChange={async (e) => {
                      const file = e.target.files?.[0];
                      if (!file) return;
                      if (file.size > 5 * 1024 * 1024) {
                        showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB', 'error');
                        return;
                      }
                      setAvatarUploading(true);
                      try {
                        await uploadAvatar(file);
                        await refreshUser();
                        showToast('å¤´åƒæ›´æ–°æˆåŠŸ', 'success');
                      } catch (err: any) {
                        showToast(err.message || 'å¤´åƒä¸Šä¼ å¤±è´¥', 'error');
                      } finally {
                        setAvatarUploading(false);
                        if (avatarInputRef.current) avatarInputRef.current.value = '';
                      }
                    }}
                  />
                  <button
                    onClick={() => avatarInputRef.current?.click()}
                    disabled={avatarUploading}
                    className="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer disabled:cursor-wait"
                  >
                    {avatarUploading ? <Loader2 size={14} className="text-white animate-spin" /> : <Camera size={14} className="text-white" />}
                  </button>
                </div>
                <div className="flex-1 min-w-0">
                  <div className="text-base font-black text-slate-900">{user?.name || 'æœªè®¾ç½®å§“å'}</div>
                  <div className="flex items-center gap-2 mt-1 flex-wrap text-xs text-slate-500">
                    <span className="font-mono select-all bg-slate-100 px-1.5 py-0.5 rounded text-slate-600">{formatUID(user?.id || 0)}</span>
                    <span className="text-slate-300">Â·</span>
                    <span className="flex items-center gap-1.5">
                      {(() => {
                        const hasPersonalCert = personalCerts.some((c: any) => c.category === 'identity' && c.status === 'valid');
                        const hasEnterpriseCert = enterpriseCerts.some((c: any) => c.status === 'valid');
                        const roles: string[] = [];
                        if (hasPersonalCert) roles.push('æ±‚èŒè€…');
                        if (hasEnterpriseCert) roles.push('æ‹›è˜æ–¹');
                        if (roles.length === 0) roles.push(userRole === 'employer' ? 'æ‹›è˜æ–¹' : 'æ±‚èŒè€…');
                        return roles.map((r, i) => (
                          <span key={r} className="flex items-center gap-1">
                            {i > 0 && <span className="text-slate-300">/</span>}
                            <span className={`inline-flex items-center gap-0.5 ${roles.length > 1 ? 'bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded' : ''}`}>
                              {r}
                              {((r === 'æ±‚èŒè€…' && hasPersonalCert) || (r === 'æ‹›è˜æ–¹' && hasEnterpriseCert)) && (
                                <Verified size={12} className="text-indigo-500" />
                              )}
                            </span>
                          </span>
                        ));
                      })()}
                    </span>
                    <span className="text-slate-300">Â·</span>
                    <span>{user?.account_tier === 'ULTRA' ? 'Devnors 1.0 Ultra Â· æ——èˆ°ç‰ˆ' : user?.account_tier === 'PRO' ? 'Devnors 1.0 Pro Â· ä¸“ä¸šç‰ˆ' : 'Devnors 1.0 Â· åŸºç¡€ç‰ˆ'}</span>
                    <span className="text-slate-300">Â·</span>
                    <span>æ³¨å†Œäº {user?.created_at ? parseUTC(user.created_at).toLocaleDateString('zh-CN') : 'æœªçŸ¥'}</span>
                  </div>
                </div>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="text-xs font-bold text-slate-500 block mb-1.5">å§“å / æ˜µç§°</label>
                  {accountEditing ? (
                    <div>
                      <input type="text" value={accountInfo.name} onChange={e => { setAccountInfo(p => ({ ...p, name: e.target.value })); setAccountErrors(p => ({ ...p, name: validateAccountField('name', e.target.value) })); }}
                        className={`w-full bg-slate-50 border rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 ${accountErrors.name ? 'border-red-300 bg-red-50' : 'border-slate-200 focus:border-indigo-300'}`}
                        placeholder="è¯·è¾“å…¥å§“åæˆ–æ˜µç§°" />
                      {accountErrors.name && <p className="text-xs text-red-500 mt-1 flex items-center gap-1"><AlertCircle size={12} /> {accountErrors.name}</p>}
                    </div>
                  ) : (
                    <div className="px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-800">{user?.name || 'æœªè®¾ç½®'}</div>
                  )}
                </div>
                <div>
                  <div className="flex items-center justify-between mb-1.5">
                    <label className="text-xs font-bold text-slate-500">æ‰‹æœºå·ç </label>
                    <span className="text-xs text-amber-600 flex items-center gap-1"><ShieldCheck size={10} /> ä¿®æ”¹éœ€éªŒè¯</span>
                  </div>
                  {accountEditing ? (
                    <div>
                      <div className="flex gap-2">
                        <input type="tel" value={accountInfo.phone} onChange={e => { setAccountInfo(p => ({ ...p, phone: e.target.value })); setAccountErrors(p => ({ ...p, phone: validateAccountField('phone', e.target.value) })); }}
                          className={`flex-1 bg-slate-50 border rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 ${accountErrors.phone ? 'border-red-300 bg-red-50' : 'border-slate-200 focus:border-indigo-300'}`}
                          placeholder="è¯·è¾“å…¥æ‰‹æœºå·" />
                        <button onClick={openPhoneVerify} className="flex-shrink-0 text-xs font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 px-3 py-2.5 rounded-lg border border-indigo-200 transition-all">éªŒè¯ç»‘å®š</button>
                      </div>
                      {accountErrors.phone && <p className="text-xs text-red-500 mt-1 flex items-center gap-1"><AlertCircle size={12} /> {accountErrors.phone}</p>}
                    </div>
                  ) : (
                    <div className="px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-800 flex items-center justify-between">
                      <span>{user?.phone ? maskPhone(user.phone) : <span className="text-slate-400">æœªç»‘å®š</span>}</span>
                      {user?.phone && <span className="text-xs text-emerald-500 flex items-center gap-1"><CheckCircle2 size={11} /> å·²ç»‘å®š</span>}
                    </div>
                  )}
                </div>

              </div>
            </div>

            {/* å®‰å…¨è®¾ç½® */}
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h4 className="text-sm font-bold text-slate-700 mb-4">å®‰å…¨è®¾ç½®</h4>
              <div className="space-y-3">
                <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                  <div>
                    <h5 className="text-sm font-medium text-slate-800">ç™»å½•å¯†ç </h5>
                    <p className="text-xs text-slate-500">å®šæœŸä¿®æ”¹å¯†ç æœ‰åŠ©äºä¿æŠ¤è´¦å·å®‰å…¨</p>
                  </div>
                  <button onClick={() => setShowPasswordForm(!showPasswordForm)} className="text-sm font-bold text-indigo-600 hover:text-indigo-700">{showPasswordForm ? 'æ”¶èµ·' : 'ä¿®æ”¹å¯†ç '}</button>
                </div>
                {showPasswordForm && (
                  <div className="p-4 bg-slate-50 rounded-lg border border-slate-200 space-y-3 animate-in fade-in duration-300">
                    <div>
                      <label className="block text-xs font-bold text-slate-500 mb-1.5">å½“å‰å¯†ç </label>
                      <input type="password" value={passwordForm.oldPassword} onChange={e => setPasswordForm(p => ({ ...p, oldPassword: e.target.value }))} className="w-full bg-white border border-slate-200 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-300" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " />
                    </div>
                    <div>
                      <label className="block text-xs font-bold text-slate-500 mb-1.5">æ–°å¯†ç </label>
                      <input type="password" value={passwordForm.newPassword} onChange={e => setPasswordForm(p => ({ ...p, newPassword: e.target.value }))} className="w-full bg-white border border-slate-200 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-300" placeholder="è‡³å°‘ 6 ä½å­—ç¬¦" />
                    </div>
                    <div>
                      <label className="block text-xs font-bold text-slate-500 mb-1.5">ç¡®è®¤æ–°å¯†ç </label>
                      <input type="password" value={passwordForm.confirmPassword} onChange={e => setPasswordForm(p => ({ ...p, confirmPassword: e.target.value }))} className="w-full bg-white border border-slate-200 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-300" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " />
                    </div>
                    <div className="flex justify-end gap-2 pt-1">
                      <button onClick={() => { setShowPasswordForm(false); setPasswordForm({ oldPassword: '', newPassword: '', confirmPassword: '' }); }} className="px-4 py-2 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-100 transition-all">å–æ¶ˆ</button>
                      <button onClick={handlePasswordChange} disabled={passwordChanging} className="flex items-center gap-1.5 px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 transition-all disabled:opacity-50">
                        {passwordChanging ? <Loader2 size={13} className="animate-spin" /> : <ShieldCheck size={13} />} ç¡®è®¤ä¿®æ”¹
                      </button>
                    </div>
                  </div>
                )}
                <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                  <div>
                    <h5 className="text-sm font-medium text-slate-800">å®‰å…¨é‚®ç®±</h5>
                    <p className="text-xs text-slate-500">{user?.email}</p>
                  </div>
                  <div className="flex items-center gap-3">
                    <span className="text-xs font-bold text-emerald-500 flex items-center gap-1"><CheckCircle2 size={12} /> å·²ç»‘å®š</span>
                    <button 
                      onClick={() => {
                        setShowEmailInput(true);
                      }}
                      className="text-xs font-bold text-indigo-600 hover:text-indigo-700"
                    >
                      ä¿®æ”¹
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* ç¬¬ä¸‰æ–¹è´¦å·ç»‘å®š */}
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h4 className="text-sm font-bold text-slate-700 mb-1">ç¬¬ä¸‰æ–¹è´¦å·ç»‘å®š</h4>
              <p className="text-xs text-slate-400 mb-4">ç»‘å®šåå¯ä½¿ç”¨ç¬¬ä¸‰æ–¹è´¦å·å¿«é€Ÿç™»å½•</p>
              <div className="space-y-3">
                {thirdPartyLogins.map(item => (
                  <div key={item.key} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                    <div className="flex items-center gap-3">
                      <div className={`w-8 h-8 rounded-lg ${item.bgColor} flex items-center justify-center`}>
                        <item.icon size={16} className={item.color} />
                      </div>
                      <div>
                        <div className="text-sm font-medium text-slate-800">{item.name}</div>
                        <div className="text-xs text-slate-400">{item.connected ? 'å·²ç»‘å®š' : 'æœªç»‘å®š'}</div>
                      </div>
                    </div>
                    <button onClick={() => showToast(`${item.name} ç¬¬ä¸‰æ–¹ç™»å½•åŠŸèƒ½å³å°†ä¸Šçº¿`, 'warning')}
                      className="text-xs font-bold text-indigo-600 hover:text-indigo-700">{item.connected ? 'è§£ç»‘' : 'ç»‘å®š'}</button>
                  </div>
                ))}
              </div>
            </div>



            {/* é‚®ç®±è¾“å…¥å¼¹çª— */}
            {showEmailInput && (
              <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40" onClick={() => { setShowEmailInput(false); setNewEmailValue(''); }}>
                <div className="bg-white rounded-xl shadow-xl w-full max-w-sm mx-4 p-6 animate-in fade-in duration-200" onClick={e => e.stopPropagation()}>
                  <h4 className="text-lg font-black text-slate-900 mb-1">ä¿®æ”¹å®‰å…¨é‚®ç®±</h4>
                  <p className="text-xs text-slate-500 mb-5">è¯·è¾“å…¥æ–°çš„é‚®ç®±åœ°å€</p>
                  
                  <div className="mb-4">
                    <label className="text-xs font-bold text-slate-500 block mb-1.5">å½“å‰é‚®ç®±</label>
                    <div className="px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium text-slate-500">{user?.email}</div>
                  </div>
                  
                  <div className="mb-5">
                    <label className="text-xs font-bold text-slate-500 block mb-1.5">æ–°é‚®ç®±åœ°å€</label>
                    <input 
                      type="email" 
                      value={newEmailValue}
                      onChange={e => setNewEmailValue(e.target.value)}
                      className="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-300"
                      placeholder="è¯·è¾“å…¥æ–°çš„é‚®ç®±åœ°å€"
                    />
                  </div>

                  <div className="flex gap-3">
                    <button onClick={() => { setShowEmailInput(false); setNewEmailValue(''); }} className="flex-1 px-4 py-2.5 border border-slate-200 text-slate-600 rounded-lg text-sm font-bold hover:bg-slate-50 transition-all">å–æ¶ˆ</button>
                    <button 
                      onClick={() => {
                        if (!newEmailValue) {
                          showToast('è¯·è¾“å…¥æ–°é‚®ç®±åœ°å€', 'error');
                          return;
                        }
                        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmailValue)) {
                          showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
                          return;
                        }
                        if (newEmailValue === user?.email) {
                          showToast('æ–°é‚®ç®±ä¸å½“å‰é‚®ç®±ç›¸åŒ', 'warning');
                          return;
                        }
                        setShowEmailInput(false);
                        setVerifyModal({ show: true, type: 'email', newValue: newEmailValue, step: 'old' });
                        setNewEmailValue('');
                      }} 
                      className="flex-1 px-4 py-2.5 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 transition-all"
                    >
                      ä¸‹ä¸€æ­¥
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* äºŒæ¬¡éªŒè¯å¼¹çª— */}
            {verifyModal.show && (
              <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40" onClick={() => { setVerifyModal({show: false, type: 'phone', newValue: '', step: 'old'}); setVerifyCode(''); }}>
                <div className="bg-white rounded-xl shadow-xl w-full max-w-sm mx-4 p-6 animate-in fade-in duration-200" onClick={e => e.stopPropagation()}>
                  <h4 className="text-lg font-black text-slate-900 mb-1">å®‰å…¨éªŒè¯</h4>
                  <p className="text-xs text-slate-500 mb-5">
                    {verifyModal.type === 'email' 
                      ? (verifyModal.step === 'old' ? 'è¯·å…ˆéªŒè¯å½“å‰ç»‘å®šçš„é‚®ç®±' : 'è¯·éªŒè¯æ–°é‚®ç®±åœ°å€')
                      : 'ä¿®æ”¹æ‰‹æœºå·éœ€è¦éªŒè¯èº«ä»½'}
                  </p>

                  {/* é‚®ç®±ä¿®æ”¹è¿›åº¦æŒ‡ç¤º */}
                  {verifyModal.type === 'email' && (
                    <div className="flex items-center gap-2 mb-4">
                      <div className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold ${verifyModal.step === 'old' ? 'bg-indigo-100 text-indigo-700' : 'bg-emerald-100 text-emerald-700'}`}>
                        <span className="w-4 h-4 rounded-full bg-current text-white flex items-center justify-center text-[10px]">1</span>
                        éªŒè¯åŸé‚®ç®±
                      </div>
                      <ChevronRight size={14} className="text-slate-300" />
                      <div className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold ${verifyModal.step === 'new' ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-400'}`}>
                        <span className="w-4 h-4 rounded-full bg-current text-white flex items-center justify-center text-[10px]">2</span>
                        éªŒè¯æ–°é‚®ç®±
                      </div>
                    </div>
                  )}

                  <div className="mb-4">
                    <label className="text-xs font-bold text-slate-500 block mb-1.5">
                      {verifyModal.type === 'phone' ? 'æ–°æ‰‹æœºå·' : (verifyModal.step === 'old' ? 'å½“å‰é‚®ç®±' : 'æ–°é‚®ç®±')}
                    </label>
                    <div className="px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium text-slate-800">
                      {verifyModal.type === 'email' && verifyModal.step === 'old' ? user?.email : verifyModal.newValue}
                    </div>
                  </div>

                  <div className="text-xs text-amber-700 bg-amber-50 p-3 rounded-lg mb-4 flex items-start gap-2">
                    <Info size={13} className="mt-0.5 flex-shrink-0 text-amber-500" />
                    <span>
                      {verifyModal.type === 'email' 
                        ? (verifyModal.step === 'old' 
                            ? `éªŒè¯ç å°†å‘é€è‡³å½“å‰é‚®ç®± ${user?.email}` 
                            : `éªŒè¯ç å°†å‘é€è‡³æ–°é‚®ç®± ${verifyModal.newValue}`)
                        : `éªŒè¯ç å°†å‘é€è‡³æ–°æ‰‹æœºå· ${verifyModal.newValue}`}
                    </span>
                  </div>

                  <div className="mb-5">
                    <label className="text-xs font-bold text-slate-500 block mb-1.5">éªŒè¯ç </label>
                    <div className="flex gap-2">
                      <input type="text" maxLength={6} value={verifyCode} onChange={e => setVerifyCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
                        className="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm text-center font-mono tracking-widest focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-300"
                        placeholder="6 ä½éªŒè¯ç " />
                      <button onClick={handleSendVerifyCode} disabled={verifySending || verifyCountdown > 0}
                        className="flex-shrink-0 px-4 py-2.5 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 transition-all disabled:opacity-50 min-w-[90px]">
                        {verifySending ? <Loader2 size={14} className="animate-spin mx-auto" /> : verifyCountdown > 0 ? `${verifyCountdown}s` : 'å‘é€'}
                      </button>
                    </div>
                  </div>

                  <div className="flex gap-3">
                    <button onClick={() => { setVerifyModal({show: false, type: 'phone', newValue: '', step: 'old'}); setVerifyCode(''); }} className="flex-1 px-4 py-2.5 border border-slate-200 text-slate-600 rounded-lg text-sm font-bold hover:bg-slate-50 transition-all">å–æ¶ˆ</button>
                    <button onClick={handleVerifySubmit} disabled={verifySubmitting || verifyCode.length !== 6} className="flex-1 px-4 py-2.5 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 transition-all disabled:opacity-50">
                      {verifySubmitting ? <Loader2 size={14} className="animate-spin mx-auto" /> : 'ç¡®è®¤'}
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }
      case 'AIEngine':
        return (
          <div className="space-y-8 animate-in fade-in duration-500">
            {/* ===== è‡ªå®šä¹‰å¤§æ¨¡å‹æ¥å…¥ï¼ˆUltra ä¸“å±ï¼‰ ===== */}
            <div className="flex items-center gap-3">
              <h3 className="text-2xl font-black text-slate-900">è‡ªå®šä¹‰å¤§æ¨¡å‹æ¥å…¥</h3>
              <span className="px-2 py-0.5 text-[10px] font-black uppercase tracking-widest bg-gradient-to-r from-rose-500 to-amber-500 text-white rounded">Ultra ä¸“å±</span>
            </div>
            <p className="text-slate-500 font-medium -mt-4">æ¥å…¥æ‚¨è‡ªæœ‰çš„ç¬¬ä¸‰æ–¹å¤§æ¨¡å‹ APIï¼Œç”¨äºé©±åŠ¨å¹³å°ä¸­çš„ AI ä»»åŠ¡å¼•æ“ã€‚å¹³å°ä»…æ”¶å–æ¨¡å‹æœåŠ¡æ–¹ Token è´¹ç”¨çš„ <span className="text-indigo-600 font-black">20%</span> ä½œä¸ºé€šé“æœåŠ¡è´¹ã€‚</p>

            {accountTierInfo.tier === 'ultra' ? (
              <>
                <div className="bg-white rounded-lg border border-slate-100 shadow-sm overflow-hidden divide-y divide-slate-100">
                  {[
                    { name: 'GPT-4o', provider: 'OpenAI', desc: 'æ——èˆ°å¤šæ¨¡æ€æ¨¡å‹ï¼Œ128K ä¸Šä¸‹æ–‡', color: 'bg-emerald-500', letter: 'G' },
                    { name: 'GPT-o3', provider: 'OpenAI', desc: 'æœ€å¼ºæ¨ç†æ¨¡å‹ï¼Œå¤æ‚é€»è¾‘ä¸ä»£ç ', color: 'bg-emerald-600', letter: 'O' },
                    { name: 'Claude 4 Opus', provider: 'Anthropic', desc: 'è¶…é•¿ä¸Šä¸‹æ–‡ï¼Œæ·±åº¦åˆ†æä¸å†™ä½œ', color: 'bg-amber-500', letter: 'C' },
                    { name: 'Gemini 2.5 Pro', provider: 'Google', desc: 'ç™¾ä¸‡çº§ä¸Šä¸‹æ–‡ï¼ŒåŸç”Ÿå¤šæ¨¡æ€', color: 'bg-blue-500', letter: 'G' },
                    { name: 'DeepSeek R1', provider: 'DeepSeek', desc: 'é¡¶çº§æ¨ç†ï¼Œä¸­æ–‡åœºæ™¯ä¼˜åŒ–', color: 'bg-indigo-500', letter: 'D' },
                    { name: 'Qwen 3', provider: 'Alibaba', desc: 'ä¸­æ–‡èƒ½åŠ›å‡ºè‰²ï¼Œä¼ä¸šçº§ç¨³å®š', color: 'bg-violet-500', letter: 'Q' },
                    { name: 'Grok 3', provider: 'xAI', desc: 'å®æ—¶ä¿¡æ¯æ¥å…¥ï¼Œåˆ›æ„ä¸åˆ†æ', color: 'bg-slate-700', letter: 'X' },
                  ].map((model, i) => {
                    const connectedConfig = llmConfigs.find((c: any) => c.modelName === model.name || (c.model_name === model.name));
                    const connected = !!connectedConfig;
                    return (
                      <div key={i} className="flex items-center gap-4 px-5 py-4 hover:bg-slate-50/50 transition-colors">
                        <div className={`w-9 h-9 ${model.color} rounded-lg flex items-center justify-center flex-shrink-0`}>
                          <span className="text-white text-xs font-black">{model.letter}</span>
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2">
                            <span className="text-sm font-black text-slate-900">{model.name}</span>
                            <span className="text-[10px] font-bold text-slate-400">{model.provider}</span>
                          </div>
                          <p className="text-xs text-slate-400 truncate">{model.desc}</p>
                        </div>
                        {connected ? (
                          <div className="flex items-center gap-2">
                            <span className="flex items-center gap-1.5 text-xs font-bold text-emerald-600 bg-emerald-50 px-2.5 py-1 rounded-full">
                              <span className="w-1.5 h-1.5 bg-emerald-400 rounded-full" /> å·²æ¥å…¥
                            </span>
                            <button 
                              onClick={async () => {
                                if (!confirm(`ç¡®è®¤æ–­å¼€ ${model.name} çš„æ¥å…¥ï¼Ÿ`)) return;
                                try {
                                  await deleteAIConfig(connectedConfig.id || connectedConfig.config_id, userId);
                                  setLlmConfigs(await getAIConfigs(userId));
                                  showToast(`${model.name} å·²æ–­å¼€`, 'success');
                                } catch { showToast('æ“ä½œå¤±è´¥', 'error'); }
                              }}
                              className="text-[10px] font-bold text-slate-400 hover:text-rose-500 transition-colors"
                              title="æ–­å¼€æ¥å…¥"
                            >
                              æ–­å¼€
                            </button>
                          </div>
                        ) : (
                          <button 
                            onClick={() => {
                              setConnectingModel({ name: model.name, provider: model.provider });
                              setLlmConnectForm({ apiKey: '', baseUrl: '' });
                              setShowLLMConnectModal(true);
                            }}
                            className="text-xs font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded-lg transition-colors"
                          >
                            æ¥å…¥
                          </button>
                        )}
                      </div>
                    );
                  })}
                </div>

                {/* æ¥å…¥æ¨¡å‹æ¨¡æ€æ¡† */}
                {showLLMConnectModal && connectingModel && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowLLMConnectModal(false)}>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden" onClick={e => e.stopPropagation()}>
                      <div className="px-6 py-5 border-b border-slate-100">
                        <h4 className="text-lg font-black text-slate-900">æ¥å…¥ {connectingModel.name}</h4>
                        <p className="text-xs text-slate-400 mt-1">é…ç½® {connectingModel.provider} çš„ API å¯†é’¥ä»¥å¯ç”¨æ¨¡å‹è°ƒç”¨</p>
                      </div>
                      <div className="px-6 py-5 space-y-4">
                        <div>
                          <label className="block text-xs font-bold text-slate-600 mb-1.5">API Key <span className="text-rose-500">*</span></label>
                          <input
                            type="password"
                            value={llmConnectForm.apiKey}
                            onChange={e => setLlmConnectForm({ ...llmConnectForm, apiKey: e.target.value })}
                            placeholder={`è¾“å…¥ ${connectingModel.provider} API Key`}
                            className="w-full px-3.5 py-2.5 rounded-lg border border-slate-200 text-sm focus:border-indigo-300 focus:ring-2 focus:ring-indigo-100 outline-none transition-all"
                          />
                          <p className="text-[10px] text-slate-400 mt-1">å¯†é’¥å°†åŠ å¯†å­˜å‚¨ï¼Œä»…ç”¨äºå¹³å°ä»£ç†è°ƒç”¨</p>
                        </div>
                        <div>
                          <label className="block text-xs font-bold text-slate-600 mb-1.5">è‡ªå®šä¹‰ Base URL <span className="text-slate-400 font-normal">(å¯é€‰)</span></label>
                          <input
                            type="text"
                            value={llmConnectForm.baseUrl}
                            onChange={e => setLlmConnectForm({ ...llmConnectForm, baseUrl: e.target.value })}
                            placeholder="https://api.openai.com/v1"
                            className="w-full px-3.5 py-2.5 rounded-lg border border-slate-200 text-sm focus:border-indigo-300 focus:ring-2 focus:ring-indigo-100 outline-none transition-all"
                          />
                          <p className="text-[10px] text-slate-400 mt-1">å¦‚ä½¿ç”¨ä»£ç†æˆ–è‡ªå»ºæœåŠ¡ï¼Œå¯å¡«å†™è‡ªå®šä¹‰ç«¯ç‚¹åœ°å€</p>
                        </div>
                        <div className="bg-amber-50 rounded-lg p-3 border border-amber-100">
                          <div className="flex items-start gap-2">
                            <Info size={14} className="text-amber-500 flex-shrink-0 mt-0.5" />
                            <p className="text-[11px] text-amber-700">æ¥å…¥åï¼Œè¯¥æ¨¡å‹å°†å‡ºç°åœ¨ AI åŠ©æ‰‹çš„æ¨¡å‹é€‰æ‹©åˆ—è¡¨ä¸­ã€‚è°ƒç”¨è´¹ç”¨ = æœåŠ¡å•†åŸå§‹ Token è´¹ç”¨ Ã— 1.2</p>
                          </div>
                        </div>
                      </div>
                      <div className="px-6 py-4 border-t border-slate-100 flex justify-end gap-3">
                        <button 
                          onClick={() => setShowLLMConnectModal(false)} 
                          className="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700 transition-colors"
                        >
                          å–æ¶ˆ
                        </button>
                        <button 
                          disabled={!llmConnectForm.apiKey.trim() || llmConnecting}
                          onClick={async () => {
                            setLlmConnecting(true);
                            try {
                              await createAIConfig({
                                task: 'custom',
                                model_name: connectingModel.name,
                                provider: connectingModel.provider,
                                api_key: llmConnectForm.apiKey.trim(),
                              }, userId);
                              setLlmConfigs(await getAIConfigs(userId));
                              setShowLLMConnectModal(false);
                              showToast(`${connectingModel.name} æ¥å…¥æˆåŠŸ`, 'success');
                            } catch {
                              showToast('æ¥å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®', 'error');
                            } finally {
                              setLlmConnecting(false);
                            }
                          }}
                          className="px-5 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors disabled:opacity-50 flex items-center gap-2"
                        >
                          {llmConnecting ? <><Loader2 size={14} className="animate-spin" /> éªŒè¯ä¸­...</> : 'ç¡®è®¤æ¥å…¥'}
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                <div className="bg-slate-50 rounded-lg p-4 border border-slate-100">
                  <div className="flex items-start gap-3">
                    <Info size={16} className="text-slate-400 flex-shrink-0 mt-0.5" />
                    <div className="text-xs text-slate-500 space-y-1">
                      <p className="font-bold text-slate-600">è´¹ç‡è¯´æ˜</p>
                      <p>è‡ªå®šä¹‰æ¨¡å‹è°ƒç”¨è´¹ç”¨ = æ¨¡å‹æœåŠ¡å•†åŸå§‹ Token è´¹ç”¨ Ã— 1.2ï¼ˆå³åŠ æ”¶ 20% é€šé“æœåŠ¡è´¹ï¼‰ã€‚å¹³å°é»˜è®¤æ¨¡å‹ä¸å¦æ”¶é€šé“è´¹ï¼Œå·²åŒ…å«åœ¨æ–¹æ¡ˆå¥—é¤ä¸­ã€‚</p>
                    </div>
                  </div>
                </div>
              </>
            ) : (
              <div className="bg-gradient-to-br from-slate-50 to-indigo-50/30 rounded-xl border border-slate-200 p-10 text-center">
                <div className="w-16 h-16 bg-white rounded-2xl border border-slate-100 shadow-sm flex items-center justify-center mx-auto mb-5">
                  <Cpu size={28} className="text-indigo-400" />
                </div>
                <h4 className="text-lg font-black text-slate-900 mb-2">å‡çº§ Ultra æ——èˆ°ç‰ˆè§£é”</h4>
                <p className="text-sm text-slate-500 max-w-md mx-auto mb-6">Ultra ç”¨æˆ·å¯æ¥å…¥ OpenAIã€Claudeã€Geminiã€DeepSeek ç­‰è‡ªæœ‰å¤§æ¨¡å‹ APIï¼Œçµæ´»é©±åŠ¨å¹³å° AI ä»»åŠ¡å¼•æ“ã€‚é€šé“æœåŠ¡è´¹ä»…ä¸ºæ¨¡å‹ Token è´¹ç”¨çš„ 20%ã€‚</p>
                <button 
                  onClick={() => navigate('/pricing')}
                  className="inline-flex items-center gap-2 bg-indigo-600 text-white px-6 py-3 rounded-lg font-black text-sm shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all"
                >
                  æŸ¥çœ‹ Ultra æ–¹æ¡ˆ <ArrowUpRight size={16} />
                </button>
              </div>
            )}
          </div>
        );
      case 'API':
        // --- äº‹ä»¶åæ˜ å°„ ---
        const WEBHOOK_EVENTS: Record<string,string> = {
          '*': 'å…¨éƒ¨äº‹ä»¶',
          'flow.stage_changed': 'æµç¨‹é˜¶æ®µå˜æ›´',
          'flow.completed': 'æµç¨‹å®Œæˆ',
          'candidate.matched': 'å€™é€‰äººåŒ¹é…',
          'job.created': 'å²—ä½åˆ›å»º',
          'job.updated': 'å²—ä½æ›´æ–°',
        };
        const allEventKeys = Object.keys(WEBHOOK_EVENTS).filter(k => k !== '*');

        // --- handlers ---
        const handleCreateKey = async () => {
          try {
            await createAPIKey(newKeyForm.name, newKeyForm.environment, userId);
            const keys = await getAPIKeys(userId);
            setApiKeys(keys);
            setShowNewKeyModal(false);
            setNewKeyForm({ name: 'Production Key', environment: 'production' });
            showToast('API Key å·²ç”Ÿæˆ', 'success');
          } catch { showToast('ç”Ÿæˆå¤±è´¥', 'error'); }
        };
        const handleToggleKey = async (id: number) => {
          try {
            await toggleAPIKey(id, userId);
            setApiKeys(await getAPIKeys(userId));
          } catch {}
        };
        const handleRegenKey = async (id: number) => {
          if (!confirm('é‡æ–°ç”Ÿæˆå°†ä½¿æ—§å¯†é’¥ç«‹å³å¤±æ•ˆï¼Œç¡®è®¤ï¼Ÿ')) return;
          try {
            await regenerateAPIKey(id, userId);
            setApiKeys(await getAPIKeys(userId));
            showToast('å¯†é’¥å·²é‡æ–°ç”Ÿæˆ', 'success');
          } catch { showToast('æ“ä½œå¤±è´¥', 'error'); }
        };
        const handleDeleteKey = async (id: number) => {
          if (!confirm('ç¡®è®¤åˆ é™¤è¯¥ API Keyï¼Ÿ')) return;
          try {
            await deleteAPIKey(id, userId);
            setApiKeys(await getAPIKeys(userId));
            showToast('å·²åˆ é™¤', 'success');
          } catch {}
        };

        const openWebhookModal = (hook?: any) => {
          if (hook) {
            setEditingWebhook(hook);
            setWebhookForm({ url: hook.url, events: hook.events || '*', description: hook.description || '' });
          } else {
            setEditingWebhook(null);
            setWebhookForm({ url: '', events: '*', description: '' });
          }
          setShowWebhookModal(true);
        };
        const handleSaveWebhook = async () => {
          if (!webhookForm.url) { showToast('è¯·è¾“å…¥ URL', 'error'); return; }
          try {
            if (editingWebhook) {
              await updateWebhook(editingWebhook.id, webhookForm, userId);
            } else {
              await createWebhook(webhookForm, userId);
            }
            setWebhooks(await getWebhooks(userId));
            setShowWebhookModal(false);
            showToast(editingWebhook ? 'Webhook å·²æ›´æ–°' : 'Webhook å·²åˆ›å»º', 'success');
          } catch { showToast('æ“ä½œå¤±è´¥', 'error'); }
        };
        const handleDeleteWebhook = async (id: number) => {
          if (!confirm('ç¡®è®¤åˆ é™¤è¯¥ Webhookï¼Ÿ')) return;
          try {
            await deleteWebhook(id, userId);
            setWebhooks(await getWebhooks(userId));
            showToast('å·²åˆ é™¤', 'success');
          } catch {}
        };
        const handleTestWebhook = async (id: number) => {
          try {
            const res = await testWebhook(id, userId);
            setWebhooks(await getWebhooks(userId));
            if (res.success) {
              showToast(`æµ‹è¯•æˆåŠŸ (${res.status_code})`, 'success');
            } else {
              showToast(`æµ‹è¯•å¤±è´¥: ${res.error || res.status_code}`, 'error');
            }
          } catch { showToast('æµ‹è¯•è¯·æ±‚å¤±è´¥', 'error'); }
        };
        const handleToggleWebhook = async (hook: any) => {
          try {
            await updateWebhook(hook.id, { is_active: !hook.is_active }, userId);
            setWebhooks(await getWebhooks(userId));
          } catch {}
        };

        // toggle event in webhook form
        const toggleWebhookEvent = (ev: string) => {
          const current = webhookForm.events === '*' ? [] : webhookForm.events.split(',').filter(Boolean);
          let next: string[];
          if (current.includes(ev)) {
            next = current.filter(e => e !== ev);
          } else {
            next = [...current, ev];
          }
          setWebhookForm({ ...webhookForm, events: next.length === 0 || next.length === allEventKeys.length ? '*' : next.join(',') });
        };
        const isEventSelected = (ev: string) => {
          if (webhookForm.events === '*') return true;
          return webhookForm.events.split(',').includes(ev);
        };

        const maskKey = (key: string) => {
          if (!key || key.length < 16) return key;
          return key.slice(0, 16) + 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
        };

        return (
          <div className="space-y-8 animate-in fade-in duration-500">
            {/* ===== API ä¸ Webhooks é›†æˆ ===== */}
            <div className="flex justify-between items-end">
              <div>
                <h3 className="text-2xl font-black text-slate-900">API ä¸ Webhooks é›†æˆ</h3>
                <p className="text-slate-500 font-medium mt-1">å°† Devnors æ™ºèƒ½æ‹›è˜èƒ½åŠ›æ·±åº¦åµŒå…¥æ‚¨çš„ä¸šåŠ¡æµç¨‹ä¸­ã€‚</p>
              </div>
              <div className="flex items-center gap-4 text-right">
                <div>
                  <div className="text-xl font-black text-slate-900">{apiKeyUsage.today}</div>
                  <div className="text-[10px] text-slate-400 font-bold">ä»Šæ—¥è°ƒç”¨</div>
                </div>
                <div className="w-px h-8 bg-slate-200" />
                <div>
                  <div className="text-xl font-black text-slate-900">{apiKeyUsage.week}</div>
                  <div className="text-[10px] text-slate-400 font-bold">è¿‘ 7 å¤©</div>
                </div>
              </div>
            </div>

            {/* === åŒºå— 1: API Key ç®¡ç† === */}
            <div className="bg-white rounded-lg border border-slate-100 shadow-sm overflow-hidden">
              <div className="flex items-center justify-between px-6 py-4 border-b border-slate-100">
                <h4 className="text-sm font-black text-slate-900 flex items-center gap-2"><Key size={15} className="text-indigo-600" /> API å¯†é’¥</h4>
                <button onClick={() => setShowNewKeyModal(true)} className="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors">
                  <Plus size={13} /> ç”Ÿæˆæ–° Key
                </button>
              </div>
              {apiKeys.length === 0 ? (
                <div className="text-center py-12 text-slate-400">
                  <Key size={28} className="mx-auto mb-2 opacity-40" />
                  <p className="text-sm font-medium">æš‚æ—  API Key</p>
                  <p className="text-xs mt-1">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆç¬¬ä¸€ä¸ªå¯†é’¥</p>
                </div>
              ) : (
                <div className="divide-y divide-slate-50">
                  {apiKeys.map((k: any) => (
                    <div key={k.id} className={`px-6 py-4 flex items-center gap-4 ${!k.isActive ? 'opacity-50' : ''}`}>
                      {/* çŠ¶æ€æŒ‡ç¤º */}
                      <span className={`w-2 h-2 rounded-full shrink-0 ${k.isActive ? 'bg-emerald-400' : 'bg-slate-300'}`} />
                      {/* åç§° + ç¯å¢ƒ */}
                      <div className="min-w-0 flex-1">
                        <div className="flex items-center gap-2">
                          <span className="text-sm font-bold text-slate-900 truncate">{k.name}</span>
                          <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${k.environment === 'production' ? 'bg-amber-50 text-amber-600' : 'bg-sky-50 text-sky-600'}`}>
                            {k.environment === 'production' ? 'PROD' : 'DEV'}
                          </span>
                        </div>
                        <div className="font-mono text-xs text-slate-400 mt-0.5 truncate">{maskKey(k.key)}</div>
                      </div>
                      {/* æ“ä½œæŒ‰é’® */}
                      <div className="flex items-center gap-1.5 shrink-0">
                        <button onClick={() => { handleCopyAPIKey(k.key); }} title="å¤åˆ¶" className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors"><ClipboardCheck size={14} /></button>
                        <button onClick={() => handleRegenKey(k.id)} title="é‡æ–°ç”Ÿæˆ" className="p-1.5 text-slate-400 hover:text-amber-600 hover:bg-amber-50 rounded transition-colors"><RotateCcw size={14} /></button>
                        <button onClick={() => handleToggleKey(k.id)} title={k.isActive ? 'ç¦ç”¨' : 'å¯ç”¨'} className={`p-1.5 rounded transition-colors ${k.isActive ? 'text-emerald-500 hover:text-red-500 hover:bg-red-50' : 'text-slate-400 hover:text-emerald-500 hover:bg-emerald-50'}`}>
                          {k.isActive ? <Eye size={14} /> : <Lock size={14} />}
                        </button>
                        <button onClick={() => handleDeleteKey(k.id)} title="åˆ é™¤" className="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors"><Trash2 size={14} /></button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* === åŒºå— 2: Webhook ç«¯ç‚¹é…ç½® === */}
            <div className="bg-white rounded-lg border border-slate-100 shadow-sm overflow-hidden">
              <div className="flex items-center justify-between px-6 py-4 border-b border-slate-100">
                <h4 className="text-sm font-black text-slate-900 flex items-center gap-2"><Globe size={15} className="text-indigo-600" /> äº‹ä»¶é€šçŸ¥ Webhooks</h4>
                <button onClick={() => openWebhookModal()} className="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors">
                  <Plus size={13} /> æ·»åŠ  Webhook
                </button>
              </div>
              <p className="px-6 pt-3 text-xs text-slate-500">å½“ç³»ç»Ÿå†…å‘ç”Ÿå…³é”®æ‹›è˜èŠ‚ç‚¹å˜åŒ–æ—¶ï¼ˆå¦‚é¢è¯•é€šè¿‡ï¼‰ï¼Œä¸»åŠ¨å‘æ‚¨çš„æœåŠ¡å™¨ POST æ•°æ®ã€‚</p>
              {webhooks.length === 0 ? (
                <div className="text-center py-12 text-slate-400">
                  <Globe size={28} className="mx-auto mb-2 opacity-40" />
                  <p className="text-sm font-medium">æš‚æ—  Webhook</p>
                  <p className="text-xs mt-1">æ·»åŠ ä¸€ä¸ªç«¯ç‚¹æ¥æ¥æ”¶äº‹ä»¶æ¨é€</p>
                </div>
              ) : (
                <div className="divide-y divide-slate-50 mt-3">
                  {webhooks.map((h: any) => (
                    <div key={h.id} className={`px-6 py-4 ${!h.is_active ? 'opacity-50' : ''}`}>
                      <div className="flex items-center gap-3">
                        <span className={`w-2 h-2 rounded-full shrink-0 ${h.is_active ? 'bg-emerald-400' : 'bg-slate-300'}`} />
                        <span className="text-sm font-bold text-slate-900 truncate flex-1">{h.url}</span>
                        {h.last_status_code ? (
                          <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${h.last_status_code >= 200 && h.last_status_code < 300 ? 'bg-emerald-50 text-emerald-600' : 'bg-red-50 text-red-600'}`}>
                            {h.last_status_code}
                          </span>
                        ) : null}
                        <div className="flex items-center gap-1 shrink-0">
                          <button onClick={() => handleTestWebhook(h.id)} title="å‘é€æµ‹è¯•" className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors"><Send size={13} /></button>
                          <button onClick={() => openWebhookModal(h)} title="ç¼–è¾‘" className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors"><Edit3 size={13} /></button>
                          <button onClick={() => handleToggleWebhook(h)} title={h.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'} className={`p-1.5 rounded transition-colors ${h.is_active ? 'text-emerald-500 hover:text-red-500 hover:bg-red-50' : 'text-slate-400 hover:text-emerald-500 hover:bg-emerald-50'}`}>
                            {h.is_active ? <Eye size={13} /> : <Lock size={13} />}
                          </button>
                          <button onClick={() => handleDeleteWebhook(h.id)} title="åˆ é™¤" className="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors"><Trash2 size={13} /></button>
                        </div>
                      </div>
                      <div className="flex flex-wrap gap-1.5 mt-2 ml-5">
                        {(h.events === '*' ? ['å…¨éƒ¨äº‹ä»¶'] : (h.events || '').split(',').filter(Boolean)).map((ev: string) => (
                          <span key={ev} className="text-[10px] font-bold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded">
                            {WEBHOOK_EVENTS[ev] || ev}
                          </span>
                        ))}
                        {h.description ? <span className="text-[10px] text-slate-400 ml-2">{h.description}</span> : null}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* === æ–°å»º Key æ¨¡æ€æ¡† === */}
            {showNewKeyModal && (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
                <div className="bg-white rounded-lg w-full max-w-md p-6 shadow-xl animate-in fade-in zoom-in-95 duration-200">
                  <h4 className="text-lg font-black text-slate-900 mb-4">ç”Ÿæˆæ–° API Key</h4>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-xs font-bold text-slate-600 mb-1">åç§°</label>
                      <input value={newKeyForm.name} onChange={e => setNewKeyForm({...newKeyForm, name: e.target.value})} className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ Production Key" />
                    </div>
                    <div>
                      <label className="block text-xs font-bold text-slate-600 mb-1">ç¯å¢ƒ</label>
                      <div className="flex gap-3">
                        {(['production', 'development'] as const).map(env => (
                          <button key={env} onClick={() => setNewKeyForm({...newKeyForm, environment: env})} className={`flex-1 py-2 text-xs font-bold rounded-lg border-2 transition-all ${newKeyForm.environment === env ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-500 hover:border-slate-300'}`}>
                            {env === 'production' ? 'Production' : 'Development'}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>
                  <div className="flex justify-end gap-3 mt-6">
                    <button onClick={() => setShowNewKeyModal(false)} className="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700">å–æ¶ˆ</button>
                    <button onClick={handleCreateKey} className="px-5 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors">ç”Ÿæˆ</button>
                  </div>
                </div>
              </div>
            )}

            {/* === Webhook ç¼–è¾‘æ¨¡æ€æ¡† === */}
            {showWebhookModal && (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
                <div className="bg-white rounded-lg w-full max-w-lg p-6 shadow-xl animate-in fade-in zoom-in-95 duration-200">
                  <h4 className="text-lg font-black text-slate-900 mb-4">{editingWebhook ? 'ç¼–è¾‘ Webhook' : 'æ·»åŠ  Webhook'}</h4>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-xs font-bold text-slate-600 mb-1">å›è°ƒ URL</label>
                      <input value={webhookForm.url} onChange={e => setWebhookForm({...webhookForm, url: e.target.value})} className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="https://your-server.com/webhook" />
                    </div>
                    <div>
                      <label className="block text-xs font-bold text-slate-600 mb-1">è®¢é˜…äº‹ä»¶</label>
                      <div className="flex flex-wrap gap-2">
                        {allEventKeys.map(ev => (
                          <button key={ev} onClick={() => toggleWebhookEvent(ev)} className={`text-xs font-bold px-2.5 py-1 rounded-lg border transition-all ${isEventSelected(ev) ? 'border-indigo-400 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-500 hover:border-slate-300'}`}>
                            {WEBHOOK_EVENTS[ev]}
                          </button>
                        ))}
                      </div>
                      <p className="text-[10px] text-slate-400 mt-1">{webhookForm.events === '*' ? 'å½“å‰è®¢é˜…ï¼šå…¨éƒ¨äº‹ä»¶' : `å·²é€‰ ${webhookForm.events.split(',').length} ä¸ªäº‹ä»¶`}</p>
                    </div>
                    <div>
                      <label className="block text-xs font-bold text-slate-600 mb-1">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                      <input value={webhookForm.description} onChange={e => setWebhookForm({...webhookForm, description: e.target.value})} className="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šæ¥å…¥é£ä¹¦æœºå™¨äºº" />
                    </div>
                  </div>
                  <div className="flex justify-end gap-3 mt-6">
                    <button onClick={() => setShowWebhookModal(false)} className="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700">å–æ¶ˆ</button>
                    <button onClick={handleSaveWebhook} className="px-5 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors">
                      {editingWebhook ? 'ä¿å­˜' : 'åˆ›å»º'}
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      case 'Team':
        const handleInviteMember = async () => {
          if (!inviteForm.phone) {
            alert('è¯·è¾“å…¥æ‰‹æœºå·');
            return;
          }
          if (!/^1\d{10}$/.test(inviteForm.phone)) {
            alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
            return;
          }
          
          setInviteLoading(true);
          try {
            await inviteTeamMember({
              phone: inviteForm.phone,
              role: inviteForm.role
            }, userId);
            
            // é‡æ–°åŠ è½½å›¢é˜Ÿæˆå‘˜
            const teamData = await getTeamMembers(userId);
            if (teamData && teamData.members) {
              setTeamMembers(teamData.members);
              setTeamInfo({
                is_admin: teamData.is_admin,
                enterprise_id: teamData.enterprise_id,
                enterprise_name: teamData.enterprise_name
              });
            }
            
            setShowInviteModal(false);
            setInviteForm({phone: '', email: '', role: 'viewer', inviteType: 'phone'});
          } catch (err: any) {
            alert(err.message || 'æ·»åŠ å¤±è´¥');
          } finally {
            setInviteLoading(false);
          }
        };
        
        const handleDeleteMember = async (memberId: number) => {
          if (!confirm('ç¡®å®šè¦ç§»é™¤è¯¥æˆå‘˜å—ï¼Ÿ')) return;
          try {
            await deleteTeamMember(memberId, userId);
            setTeamMembers(prev => prev.filter(m => m.id !== String(memberId)));
          } catch (err: any) {
            alert(err.message || 'ç§»é™¤å¤±è´¥');
          }
        };
        
        const handleTransferAdmin = async () => {
          if (!transferTargetId) return;
          if (!confirm('ç¡®å®šè¦å°†ç®¡ç†å‘˜æƒé™ç§»äº¤ç»™è¯¥æˆå‘˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
          try {
            await transferAdmin(transferTargetId, userId);
            // é‡æ–°åŠ è½½
            const teamData = await getTeamMembers(userId);
            if (teamData && teamData.members) {
              setTeamMembers(teamData.members);
              setTeamInfo({
                is_admin: teamData.is_admin,
                enterprise_id: teamData.enterprise_id,
                enterprise_name: teamData.enterprise_name
              });
            }
            setShowTransferModal(false);
            setTransferTargetId(null);
          } catch (err: any) {
            alert(err.message || 'ç§»äº¤å¤±è´¥');
          }
        };
        
        const handleApproveMember = async (memberId: number, approve: boolean) => {
          try {
            await approveMember(memberId, approve, userId);
            // é‡æ–°åŠ è½½
            const teamData = await getTeamMembers(userId);
            if (teamData && teamData.members) {
              setTeamMembers(teamData.members);
            }
          } catch (err: any) {
            alert(err.message || 'æ“ä½œå¤±è´¥');
          }
        };
        
        const pendingMembers = teamMembers.filter(m => m.status?.toLowerCase() === 'pending_approval');
        const activeMembers = teamMembers.filter(m => m.status?.toLowerCase() !== 'pending_approval');
        
        return (
          <div className="space-y-8 animate-in fade-in duration-500">
            {/* å¤´éƒ¨ */}
            <div className="flex justify-between items-center">
              <div>
                <h3 className="text-2xl font-black text-slate-900">å›¢é˜Ÿæˆå‘˜ä¸æƒé™æ§åˆ¶</h3>
                {teamInfo.enterprise_name && (
                  <p className="text-sm text-slate-500 mt-1">
                    ä¼ä¸šï¼š{teamInfo.enterprise_name}
                    {teamInfo.is_admin && <span className="ml-2 px-2 py-0.5 bg-amber-100 text-amber-700 rounded text-xs font-bold">ä¸»ç®¡ç†å‘˜</span>}
                  </p>
                )}
              </div>
              <div className="flex gap-3">
                {teamInfo.is_admin && (
                  <button 
                    onClick={() => setShowTransferModal(true)}
                    className="bg-white text-slate-700 px-5 py-2.5 rounded border border-slate-200 font-bold text-sm flex items-center gap-2 hover:border-amber-400 hover:text-amber-600 transition-all"
                  >
                    <ShieldAlert size={16} /> ç§»äº¤ç®¡ç†å‘˜
                  </button>
                )}
                <button 
                  onClick={() => setShowInviteModal(true)}
                  className="bg-indigo-600 text-white px-5 py-2.5 rounded font-bold text-sm flex items-center gap-2 shadow-lg shadow-indigo-100 active:scale-95 transition-all"
                >
                  <UserPlus size={16} /> æ·»åŠ æˆå‘˜
                </button>
              </div>
            </div>
            
            {/* å¾…å®¡æ‰¹ç”³è¯· */}
            {pendingMembers.length > 0 && teamInfo.is_admin && (
              <div className="bg-amber-50 rounded-xl border border-amber-200 p-6">
                <h4 className="text-base font-bold text-amber-800 mb-4 flex items-center gap-2">
                  <Clock size={18} /> å¾…å®¡æ‰¹çš„åŠ å…¥ç”³è¯· ({pendingMembers.length})
                </h4>
                <div className="space-y-3">
                  {pendingMembers.map((member: any) => (
                    <div key={member.id} className="flex items-center justify-between bg-white rounded-lg p-4 border border-amber-100">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center font-bold text-amber-600">
                          {member.name?.charAt(0) || member.phone?.charAt(0) || '?'}
                        </div>
                        <div>
                          <div className="text-sm font-bold text-slate-900">{member.name || member.phone || member.email}</div>
                          <div className="text-xs text-slate-500">{member.phone || member.email}</div>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button 
                          onClick={() => handleApproveMember(Number(member.id), false)}
                          className="px-4 py-2 text-sm font-bold text-slate-600 bg-slate-100 rounded hover:bg-slate-200 transition-colors"
                        >
                          æ‹’ç»
                        </button>
                        <button 
                          onClick={() => handleApproveMember(Number(member.id), true)}
                          className="px-4 py-2 text-sm font-bold text-white bg-emerald-500 rounded hover:bg-emerald-600 transition-colors"
                        >
                          æ‰¹å‡†
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            {/* æˆå‘˜åˆ—è¡¨ */}
            <div className="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden">
               {activeMembers.length === 0 ? (
                 <div className="text-center py-16 text-slate-400">
                   <Users2 size={48} className="mx-auto mb-4 opacity-50" />
                   <p className="text-base font-bold">æš‚æ— å›¢é˜Ÿæˆå‘˜</p>
                   <p className="text-sm mt-2">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ æ–°æˆå‘˜åŠ å…¥</p>
                 </div>
               ) : (
                 <div className="overflow-x-auto">
                    <table className="w-full text-left">
                       <thead>
                          <tr className="bg-slate-50 border-b border-slate-100 text-xs uppercase font-black tracking-wider text-slate-500">
                             <th className="py-4 pl-8">æˆå‘˜ä¿¡æ¯</th>
                             <th className="py-4">è§’è‰²</th>
                             <th className="py-4">çŠ¶æ€</th>
                             <th className="py-4 text-right pr-8">æ“ä½œ</th>
                          </tr>
                       </thead>
                       <tbody className="divide-y divide-slate-100">
                          {activeMembers.map((member: any) => (
                            <tr key={member.id} className="group hover:bg-slate-50/50 transition-colors">
                               <td className="py-5 pl-8">
                                  <div className="flex items-center gap-4">
                                     <div className="w-11 h-11 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center font-bold text-indigo-600 border-2 border-white shadow">
                                       {member.name?.charAt(0) || member.phone?.charAt(0) || member.email?.charAt(0) || '?'}
                                     </div>
                                     <div>
                                        <div className="text-sm font-bold text-slate-900 flex items-center gap-2">
                                          {member.name || member.phone || member.email?.split('@')[0]}
                                          {member.is_admin && <span className="px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded text-[10px] font-bold">ç®¡ç†å‘˜</span>}
                                        </div>
                                        <div className="text-xs text-slate-400 mt-0.5">
                                          {member.phone && <span className="mr-3">{member.phone}</span>}
                                          {member.email && <span>{member.email}</span>}
                                        </div>
                                     </div>
                                  </div>
                               </td>
                               <td className="py-5">
                                  <span className={`px-3 py-1.5 rounded-lg text-xs font-bold ${
                                     member.role?.toLowerCase() === 'admin' ? 'bg-rose-50 text-rose-600' : 
                                     member.role?.toLowerCase() === 'recruiter' ? 'bg-blue-50 text-blue-600' :
                                     'bg-slate-100 text-slate-600'
                                  }`}>
                                     {member.role === 'admin' ? 'ç®¡ç†å‘˜' : member.role === 'recruiter' ? 'æ‹›è˜å®˜' : 'æŸ¥çœ‹è€…'}
                                  </span>
                               </td>
                               <td className="py-5">
                                  <div className="flex items-center gap-2">
                                     <div className={`w-2 h-2 rounded-full ${
                                       member.status?.toLowerCase() === 'active' ? 'bg-emerald-500' : 
                                       member.status?.toLowerCase() === 'invited' ? 'bg-amber-400' : 'bg-slate-300'
                                     }`}></div>
                                     <span className="text-xs font-bold text-slate-600">
                                       {member.status?.toLowerCase() === 'active' ? 'å·²åŠ å…¥' : 
                                        member.status?.toLowerCase() === 'invited' ? 'å¾…æ¥å—' : member.status}
                                     </span>
                                  </div>
                               </td>
                               <td className="py-5 text-right pr-8">
                                  {teamInfo.is_admin && !member.is_admin && (
                                    <div className="flex justify-end gap-1">
                                       <button 
                                         onClick={() => {
                                           setTransferTargetId(member.member_id);
                                           setShowTransferModal(true);
                                         }}
                                         className="p-2 text-slate-400 hover:text-amber-600 transition-colors"
                                         title="è®¾ä¸ºç®¡ç†å‘˜"
                                       >
                                         <ShieldAlert size={18} />
                                       </button>
                                       <button 
                                         onClick={() => handleDeleteMember(Number(member.id))}
                                         className="p-2 text-slate-400 hover:text-rose-600 transition-colors"
                                         title="ç§»é™¤æˆå‘˜"
                                       >
                                         <Trash2 size={18} />
                                       </button>
                                    </div>
                                  )}
                               </td>
                            </tr>
                          ))}
                       </tbody>
                    </table>
                 </div>
               )}
            </div>
            
            {/* é‚€è¯·æˆå‘˜å¼¹çª— */}
            {showInviteModal && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg p-8 w-full max-w-md shadow-2xl">
                  <h3 className="text-xl font-black text-slate-900 mb-6">æ·»åŠ å›¢é˜Ÿæˆå‘˜</h3>
                  
                  {/* æ‰‹æœºå·è¾“å…¥ */}
                  <div className="mb-4">
                    <label className="block text-sm font-bold text-slate-700 mb-2">æ‰‹æœºå·</label>
                    <div className="flex">
                      <span className="px-4 py-3 bg-slate-100 border border-r-0 border-slate-200 rounded-l-lg text-sm text-slate-500">+86</span>
                      <input
                        type="tel"
                        value={inviteForm.phone}
                        onChange={(e) => setInviteForm(prev => ({...prev, phone: e.target.value}))}
                        placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
                        className="flex-1 px-4 py-3 border border-slate-200 rounded-r-lg text-sm focus:outline-none focus:border-indigo-500"
                      />
                    </div>
                  </div>
                  
                  {/* è§’è‰²é€‰æ‹© */}
                  <div className="mb-6">
                    <label className="block text-sm font-bold text-slate-700 mb-2">æˆå‘˜è§’è‰²</label>
                    <select
                      value={inviteForm.role}
                      onChange={(e) => setInviteForm(prev => ({...prev, role: e.target.value}))}
                      className="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-indigo-500 bg-white"
                    >
                      <option value="viewer">æŸ¥çœ‹è€… - åªèƒ½æŸ¥çœ‹ä¿¡æ¯</option>
                      <option value="recruiter">æ‹›è˜å®˜ - å¯ä»¥ç®¡ç†æ‹›è˜æµç¨‹</option>
                      <option value="admin">ç®¡ç†å‘˜ - æ‹¥æœ‰å…¨éƒ¨æƒé™</option>
                    </select>
                  </div>
                  
                  {/* æç¤ºä¿¡æ¯ */}
                  <div className="bg-blue-50 rounded-lg p-4 mb-6">
                    <p className="text-xs text-blue-700">
                      å¦‚æœè¯¥æ‰‹æœºå·å·²æ³¨å†Œè´¦å·ï¼Œå°†ç›´æ¥åŠ å…¥å›¢é˜Ÿï¼›å¦åˆ™å°†åˆ›å»ºé‚€è¯·è®°å½•ï¼Œå¾…å¯¹æ–¹æ³¨å†Œåè‡ªåŠ¨åŠ å…¥ã€‚
                    </p>
                  </div>
                  
                  {/* æŒ‰é’® */}
                  <div className="flex gap-3">
                    <button
                      onClick={() => {
                        setShowInviteModal(false);
                        setInviteForm({phone: '', email: '', role: 'viewer', inviteType: 'phone'});
                      }}
                      className="flex-1 py-3 bg-slate-100 text-slate-700 rounded-lg font-bold text-sm hover:bg-slate-200 transition-colors"
                    >
                      å–æ¶ˆ
                    </button>
                    <button
                      onClick={handleInviteMember}
                      disabled={inviteLoading}
                      className="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700 transition-colors disabled:opacity-50"
                    >
                      {inviteLoading ? 'æ·»åŠ ä¸­...' : 'ç¡®è®¤æ·»åŠ '}
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            {/* ç§»äº¤ç®¡ç†å‘˜å¼¹çª— */}
            {showTransferModal && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg p-8 w-full max-w-md shadow-2xl">
                  <h3 className="text-xl font-black text-slate-900 mb-2">ç§»äº¤ç®¡ç†å‘˜æƒé™</h3>
                  <p className="text-sm text-slate-500 mb-6">å°†ä¸»ç®¡ç†å‘˜æƒé™ç§»äº¤ç»™å…¶ä»–æˆå‘˜åï¼Œæ‚¨å°†å¤±å»ç®¡ç†å‘˜æƒé™ã€‚</p>
                  
                  <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                    <p className="text-sm text-amber-800 font-medium flex items-center gap-2">
                      <AlertTriangle size={16} />
                      æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œ
                    </p>
                  </div>
                  
                  {/* é€‰æ‹©æ–°ç®¡ç†å‘˜ */}
                  <div className="mb-6">
                    <label className="block text-sm font-bold text-slate-700 mb-2">é€‰æ‹©æ–°ç®¡ç†å‘˜</label>
                    <select
                      value={transferTargetId || ''}
                      onChange={(e) => setTransferTargetId(Number(e.target.value))}
                      className="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-indigo-500 bg-white"
                    >
                      <option value="">è¯·é€‰æ‹©æˆå‘˜</option>
                      {activeMembers.filter(m => !m.is_admin && m.member_id).map((member: any) => (
                        <option key={member.id} value={member.member_id}>
                          {member.name || member.phone || member.email}
                        </option>
                      ))}
                    </select>
                  </div>
                  
                  {/* æŒ‰é’® */}
                  <div className="flex gap-3">
                    <button
                      onClick={() => {
                        setShowTransferModal(false);
                        setTransferTargetId(null);
                      }}
                      className="flex-1 py-3 bg-slate-100 text-slate-700 rounded-lg font-bold text-sm hover:bg-slate-200 transition-colors"
                    >
                      å–æ¶ˆ
                    </button>
                    <button
                      onClick={handleTransferAdmin}
                      disabled={!transferTargetId}
                      className="flex-1 py-3 bg-amber-500 text-white rounded-lg font-bold text-sm hover:bg-amber-600 transition-colors disabled:opacity-50"
                    >
                      ç¡®è®¤ç§»äº¤
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      case 'Audit':
        const auditCategoryTabs = [
          { key: null, label: 'å…¨éƒ¨æ—¥å¿—', icon: Layers, color: 'indigo' },
          { key: 'auth', label: 'è®¤è¯å®‰å…¨', icon: Lock, color: 'blue' },
          { key: 'data', label: 'æ•°æ®å˜æ›´', icon: Database, color: 'emerald' },
          { key: 'ai', label: 'AI æ™ºèƒ½ä½“', icon: BrainCircuit, color: 'violet' },
          { key: 'api', label: 'API è°ƒç”¨', icon: Key, color: 'amber' },
          { key: 'system', label: 'ç³»ç»Ÿ', icon: Settings2, color: 'slate' },
        ] as const;

        const riskDot = (level: string) => {
          if (level === 'danger') return 'bg-red-500';
          if (level === 'warning') return 'bg-amber-400';
          return 'bg-emerald-400';
        };

        const handleAuditCategoryChange = async (cat: string | null) => {
          // ç‚¹å‡»å·²é€‰ä¸­çš„å¡ç‰‡åˆ™å–æ¶ˆé€‰ä¸­å›åˆ°å…¨éƒ¨
          const next = auditCategory === cat ? null : cat;
          setAuditCategory(next);
          try {
            // 'ai_api' æ˜¯å‰ç«¯ç»„åˆç­›é€‰ï¼Œéœ€åˆ†åˆ«è¯·æ±‚å†åˆå¹¶
            if (next === 'ai_api') {
              const [aiData, apiData] = await Promise.all([
                getAuditLogs(userId, 50, 'ai'),
                getAuditLogs(userId, 50, 'api'),
              ]);
              const merged = [...aiData, ...apiData].sort((a: any, b: any) => (b.id || 0) - (a.id || 0)).slice(0, 50);
              setAuditLogs(merged);
            } else {
              const data = await getAuditLogs(userId, 50, next || undefined);
              setAuditLogs(data);
            }
          } catch {}
        };

        const handleExportCSV = async () => {
          setAuditExporting(true);
          try { await exportAuditLogs(userId); } catch {} finally { setAuditExporting(false); }
        };

        return (
          <div className="space-y-6 animate-in fade-in duration-500">
            <div className="flex items-center justify-between">
              <h3 className="text-2xl font-black text-slate-900 flex items-center gap-3">
                <Shield size={22} className="text-indigo-600" /> ç³»ç»Ÿå®‰å…¨æ—¥å¿—
              </h3>
              <button
                onClick={handleExportCSV}
                disabled={auditExporting}
                className="inline-flex items-center gap-2 px-4 py-2 text-sm font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors disabled:opacity-50"
              >
                <Download size={15} />
                {auditExporting ? 'å¯¼å‡ºä¸­...' : 'å¯¼å‡º CSV'}
              </button>
            </div>

            {/* ç»Ÿè®¡å¡ç‰‡ */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              {[
                { label: 'å…¨éƒ¨æ—¥å¿—', value: auditStats.total, icon: Layers, cat: null, color: 'indigo' },
                { label: 'è®¤è¯å®‰å…¨', value: auditStats.auth, icon: Lock, cat: 'auth', color: 'blue' },
                { label: 'æ•°æ®å˜æ›´', value: auditStats.data, icon: Database, cat: 'data', color: 'emerald' },
                { label: 'AI / API', value: (auditStats.ai || 0) + (auditStats.api || 0), icon: BrainCircuit, cat: 'ai_api', color: 'violet' },
              ].map((s) => {
                const Icon = s.icon;
                const isActive = auditCategory === s.cat;
                return (
                  <button
                    key={s.label}
                    onClick={() => handleAuditCategoryChange(s.cat)}
                    className={`p-4 rounded-lg border-2 text-left transition-all ${
                      isActive
                        ? 'border-indigo-400 bg-indigo-50 shadow-md'
                        : 'border-slate-100 bg-white hover:border-slate-200 hover:shadow-sm'
                    }`}
                  >
                    <div className="flex items-center gap-2 mb-2">
                      <Icon size={16} className={isActive ? 'text-indigo-600' : 'text-slate-400'} />
                      <span className={`text-xs font-bold ${isActive ? 'text-indigo-600' : 'text-slate-500'}`}>{s.label}</span>
                    </div>
                    <div className={`text-2xl font-black ${isActive ? 'text-indigo-700' : 'text-slate-900'}`}>{s.value}</div>
                  </button>
                );
              })}
            </div>

            {/* åˆ†ç±»ç­›é€‰ Tabs */}
            <div className="flex items-center gap-1 bg-slate-50 p-1 rounded-lg overflow-x-auto">
              {auditCategoryTabs.map((tab) => {
                const isActive = auditCategory === tab.key;
                const Icon = tab.icon;
                return (
                  <button
                    key={tab.label}
                    onClick={() => handleAuditCategoryChange(tab.key)}
                    className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-bold whitespace-nowrap transition-all ${
                      isActive
                        ? 'bg-white text-indigo-700 shadow-sm'
                        : 'text-slate-500 hover:text-slate-700 hover:bg-white/60'
                    }`}
                  >
                    <Icon size={13} />
                    {tab.label}
                  </button>
                );
              })}
            </div>

            {/* æ—¥å¿—åˆ—è¡¨ */}
            <div className="bg-white rounded-lg border border-slate-100 overflow-hidden">
              {auditLogs.length === 0 ? (
                <div className="text-center py-16 text-slate-400">
                  <Shield size={36} className="mx-auto mb-3 opacity-40" />
                  <p className="text-sm font-medium">æš‚æ— å®‰å…¨æ—¥å¿—</p>
                </div>
              ) : auditLogs.map((log: any, idx: number) => {
                const isDanger = log.risk_level === 'danger';
                const isWarning = log.risk_level === 'warning';
                return (
                  <div
                    key={log.id || idx}
                    className={`flex items-center justify-between px-5 py-4 border-b border-slate-50 last:border-0 group transition-colors ${
                      isDanger ? 'bg-red-50/60 hover:bg-red-50' : 'hover:bg-slate-50'
                    }`}
                  >
                    <div className="flex items-center gap-3 min-w-0 flex-1">
                      {/* é£é™©ç­‰çº§åœ†ç‚¹ */}
                      <span className={`w-2 h-2 rounded-full shrink-0 ${riskDot(log.risk_level)}`} />
                      {/* æ“ä½œæè¿° */}
                      <span className={`text-sm font-bold truncate ${isDanger ? 'text-red-700' : 'text-slate-900'}`}>
                        {log.action}
                      </span>
                      {/* åˆ†ç±»æ ‡ç­¾ */}
                      <span className={`shrink-0 text-[10px] font-bold uppercase px-1.5 py-0.5 rounded ${
                        log.category === 'auth' ? 'bg-blue-50 text-blue-600'
                          : log.category === 'data' ? 'bg-emerald-50 text-emerald-600'
                          : log.category === 'ai' ? 'bg-violet-50 text-violet-600'
                          : log.category === 'api' ? 'bg-amber-50 text-amber-600'
                          : 'bg-slate-100 text-slate-500'
                      }`}>
                        {log.category || 'system'}
                      </span>
                      {/* æ‰§è¡Œè€… */}
                      <span className="shrink-0 text-[10px] font-bold text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded">
                        BY {log.user}
                      </span>
                    </div>
                    <div className="flex items-center gap-5 text-xs font-medium text-slate-400 shrink-0 ml-4">
                      <span className="font-mono">{log.ip}</span>
                      <span className="w-16 text-right">{log.time}</span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      default:
        return null;
    }
  };

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto min-h-screen animate-in fade-in duration-700">
      {/* Toast æç¤º */}
      {toast.show && (
        <div className={`fixed top-16 right-3 md:top-24 md:right-6 z-[9999] px-4 py-2.5 md:px-5 md:py-3 rounded-xl shadow-2xl font-bold text-sm flex items-center gap-2 animate-in slide-in-from-right duration-300 ${
          toast.type === 'success' ? 'bg-emerald-500 text-white' : 
          toast.type === 'error' ? 'bg-red-500 text-white' : 
          'bg-amber-500 text-white'
        }`}>
          {toast.type === 'success' ? <CheckCircle size={18} /> : toast.type === 'error' ? <XCircle size={18} /> : <AlertCircle size={18} />}
          {toast.message}
        </div>
      )}
      <div className="mb-12">
         <h1 className="text-2xl md:text-4xl font-black text-slate-900 flex items-center gap-2 md:gap-4">
           <div className="p-3 bg-indigo-600 text-white rounded shadow-xl"><Settings size={32} /></div>
           ç³»ç»Ÿè®¾ç½®
         </h1>
         <p className="text-slate-500 font-medium mt-2">åœ¨è¿™é‡Œä¸ªæ€§åŒ–æ‚¨çš„æ™ºèƒ½æ‹›è˜ä½“éªŒï¼Œç®¡ç†åº•å±‚å¼•æ“ä¸å›¢é˜Ÿæƒé™</p>
      </div>

      {/* Tab å¯¼èˆª */}
      <div className="flex flex-wrap gap-2 mb-8 bg-white rounded-xl p-2 border border-slate-100 shadow-sm">
        {navItems.map((item) => (
          <button
            key={item.id}
            onClick={() => setActiveTab(item.id as any)}
            className={`flex items-center gap-2 px-4 py-2.5 rounded-lg font-bold text-sm transition-all ${
              activeTab === item.id 
              ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' 
              : 'text-slate-500 hover:bg-slate-50 hover:text-indigo-600'
            }`}
          >
            <item.icon size={16} className={activeTab === item.id ? 'text-white' : 'text-slate-400'} />
            {item.label}
          </button>
        ))}
      </div>

      {/* å†…å®¹åŒº */}
      <div className="relative">
        {renderContent()}
      </div>
    </div>
  );
};


// å›¾æ ‡æ˜ å°„ï¼ˆç§»åˆ°ç»„ä»¶å¤–éƒ¨é¿å…é‡å¤åˆ›å»ºï¼‰
const notificationIconMap: Record<string, any> = {
  'Target': Target,
  'Calendar': Calendar,
  'Bell': Bell,
  'MessageSquare': MessageSquare,
  'Eye': Eye,
  'AlertCircle': AlertCircle,
  'CheckCircle2': CheckCircle2,
  'Users': Users,
  'Zap': Zap,
  'Briefcase': Briefcase,
};

// --- æ¶ˆæ¯ä¸­å¿ƒé¡µé¢ ---
const NotificationCenterView = () => {
  const navigate = useNavigate();
  const { user, isLoggedIn } = useAuth();
  const userId = user?.id || 0;
  const [activeTab, setActiveTab] = useState<'all' | 'system' | 'match' | 'interview' | 'message'>('all');
  const [notifications, setNotifications] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [total, setTotal] = useState(0);
  const [unreadCount, setUnreadCount] = useState(0);
  const [markingRead, setMarkingRead] = useState(false);
  const [notificationEnabled, setNotificationEnabled] = useState(true);

  // åŠ è½½é€šçŸ¥æ¨é€è®¾ç½®
  useEffect(() => {
    const loadNotificationSetting = async () => {
      if (!userId) return;
      try {
        const { getSettings } = await import('./services/apiService');
        const data = await getSettings(userId);
        setNotificationEnabled(data.notification_enabled ?? true);
      } catch (e) { /* ignore */ }
    };
    loadNotificationSetting();
  }, [userId]);

  const toggleNotificationEnabled = async () => {
    const newVal = !notificationEnabled;
    setNotificationEnabled(newVal);
    try {
      const { updateSettings } = await import('./services/apiService');
      await updateSettings({ user_id: userId, notification_enabled: newVal });
    } catch (e) {
      setNotificationEnabled(!newVal); // rollback
    }
  };

  // åŠ è½½é€šçŸ¥æ•°æ®
  const loadNotifications = async () => {
    if (!userId) {
      setLoading(false);
      return;
    }
    
    setLoading(true);
    try {
      const { getNotifications } = await import('./services/apiService');
      const response = await getNotifications(userId, {
        type: activeTab === 'all' ? undefined : activeTab,
      });
      
      // å¤„ç†è¿”å›çš„æ•°æ®ï¼Œå°† icon å­—ç¬¦ä¸²æ˜ å°„ä¸ºç»„ä»¶
      const processedNotifications = (response.notifications || []).map((n: any) => ({
        ...n,
        icon: notificationIconMap[n.icon] || Bell,
      }));
      
      setNotifications(processedNotifications);
      setTotal(response.total || 0);
      setUnreadCount(response.unread_count || 0);
    } catch (error) {
      console.error('åŠ è½½é€šçŸ¥å¤±è´¥:', error);
      setNotifications([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadNotifications();
  }, [userId, activeTab]);

  // æ ‡è®°å…¨éƒ¨å·²è¯» - ä½¿ç”¨æ–°æ•°ç»„ç¡®ä¿ React æ£€æµ‹åˆ°å˜åŒ–
  const markAllAsRead = async () => {
    if (markingRead || notifications.length === 0) return;
    setMarkingRead(true);
    try {
      const { markNotificationRead } = await import('./services/apiService');
      await markNotificationRead(userId);
      // åˆ›å»ºå…¨æ–°çš„æ•°ç»„å’Œå¯¹è±¡ï¼Œç¡®ä¿ React æ£€æµ‹åˆ°çŠ¶æ€å˜åŒ–
      const updatedNotifications = notifications.map(n => {
        return { ...n, read: true };
      });
      setNotifications(updatedNotifications);
      setUnreadCount(0);
    } catch (error) {
      console.error('æ ‡è®°å·²è¯»å¤±è´¥:', error);
    } finally {
      setMarkingRead(false);
    }
  };

  // æ ‡è®°å•æ¡å·²è¯»
  const markAsRead = async (id: number) => {
    try {
      const { markNotificationRead } = await import('./services/apiService');
      await markNotificationRead(userId, id);
      const updatedNotifications = notifications.map(n => 
        n.id === id ? { ...n, read: true } : n
      );
      setNotifications(updatedNotifications);
      setUnreadCount(prev => Math.max(0, prev - 1));
    } catch (error) {
      console.error('æ ‡è®°å·²è¯»å¤±è´¥:', error);
    }
  };

  // åˆ é™¤é€šçŸ¥
  const handleDelete = async (e: React.MouseEvent, id: number) => {
    e.stopPropagation();
    try {
      const { deleteNotification } = await import('./services/apiService');
      await deleteNotification(userId, id);
      setNotifications(prev => prev.filter(n => n.id !== id));
      setTotal(prev => prev - 1);
    } catch (error) {
      console.error('åˆ é™¤é€šçŸ¥å¤±è´¥:', error);
    }
  };

  const tabs = [
    { id: 'all', label: 'å…¨éƒ¨', count: total },
    { id: 'system', label: 'ç³»ç»Ÿé€šçŸ¥', icon: Bell },
    { id: 'match', label: 'åŒ¹é…åŠ¨æ€', icon: Target },
    { id: 'interview', label: 'é¢è¯•ç›¸å…³', icon: Calendar },
    { id: 'message', label: 'æ¶ˆæ¯äº’åŠ¨', icon: MessageSquare },
  ];

  if (!isLoggedIn) {
    return (
      <div className="pt-20 text-center">
        <Bell className="mx-auto text-slate-300 mb-4" size={64} />
        <p className="text-slate-500 font-bold mb-4">è¯·å…ˆç™»å½•æŸ¥çœ‹æ¶ˆæ¯</p>
        <button onClick={() => navigate('/login')} className="bg-indigo-600 text-white px-8 py-3 rounded font-black">
          å»ç™»å½•
        </button>
      </div>
    );
  }

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-500">
      {/* Header */}
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-xl md:text-3xl font-black text-slate-900 mb-2">æ¶ˆæ¯ä¸­å¿ƒ</h1>
          <p className="text-slate-500">
            {unreadCount > 0 ? `æ‚¨æœ‰ ${unreadCount} æ¡æœªè¯»æ¶ˆæ¯` : 'æš‚æ— æœªè¯»æ¶ˆæ¯'}
          </p>
        </div>
        <div className="flex items-center gap-3">
          {unreadCount > 0 && (
            <button 
              onClick={markAllAsRead}
              disabled={markingRead}
              className="text-indigo-600 hover:text-indigo-700 font-bold text-sm flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {markingRead ? (
                <Loader2 size={16} className="animate-spin" />
              ) : (
                <CheckCircle2 size={16} />
              )}
              {markingRead ? 'å¤„ç†ä¸­...' : 'å…¨éƒ¨å·²è¯»'}
            </button>
          )}
          <button 
            onClick={loadNotifications}
            disabled={loading}
            className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all disabled:opacity-50"
            title="åˆ·æ–°"
          >
            <RotateCcw size={18} className={loading ? 'animate-spin' : ''} />
          </button>
        </div>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id as any)}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap transition-all ${
              activeTab === tab.id 
                ? 'bg-indigo-600 text-white' 
                : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
            }`}
          >
            {tab.icon && <tab.icon size={16} />}
            {tab.label}
            {tab.id === 'all' && (
              <span className={`px-2 py-0.5 rounded-full text-xs ${
                activeTab === tab.id ? 'bg-white/20' : 'bg-slate-200'
              }`}>
                {tab.count}
              </span>
            )}
          </button>
        ))}
      </div>

      {/* Notifications List */}
      {loading ? (
        <div className="flex items-center justify-center py-20">
          <Loader2 className="animate-spin text-indigo-600" size={32} />
        </div>
      ) : notifications.length === 0 ? (
        <div className="text-center py-20">
          <Inbox className="mx-auto text-slate-300 mb-4" size={64} />
          <p className="text-slate-500 font-bold">æš‚æ— ç›¸å…³æ¶ˆæ¯</p>
        </div>
      ) : (
        <div className="space-y-3">
          {notifications.map((notification, index) => (
            <div
              key={`notification-${notification.id}-${notification.read}`}
              onClick={() => {
                if (!notification.read) {
                  markAsRead(notification.id);
                }
                navigate(notification.link);
              }}
              className={`bg-white rounded-xl border p-5 cursor-pointer transition-all hover:shadow-lg group ${
                notification.importance === 'critical' && !notification.read
                  ? 'border-rose-200 bg-rose-50/30 ring-1 ring-rose-100'
                  : notification.read === true ? 'border-slate-100' : 'border-indigo-200 bg-indigo-50/30'
              }`}
            >
              <div className="flex gap-4">
                <div className={`w-12 h-12 ${notification.bgColor} rounded-xl flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform relative`}>
                  {notification.icon && <notification.icon size={24} className={notification.color} />}
                  {notification.importance === 'critical' && !notification.read && (
                    <span className="absolute -top-1 -right-1 w-3 h-3 bg-rose-500 rounded-full animate-pulse" />
                  )}
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex items-start justify-between gap-4">
                    <div className="flex items-center gap-2">
                      {notification.importance === 'critical' && (
                        <span className="px-1.5 py-0.5 bg-rose-100 text-rose-600 text-[10px] font-black rounded">é‡è¦</span>
                      )}
                      <h3 className={`font-bold ${notification.read === true ? 'text-slate-700' : 'text-slate-900'}`}>
                        {notification.title}
                      </h3>
                      {notification.read !== true && (
                        <span className="w-2 h-2 bg-indigo-600 rounded-full"></span>
                      )}
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="text-xs text-slate-400 whitespace-nowrap">{notification.time}</span>
                      <button
                        onClick={(e) => handleDelete(e, notification.id)}
                        className="p-1 text-slate-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-all"
                        title="åˆ é™¤"
                      >
                        <X size={14} />
                      </button>
                    </div>
                  </div>
                  <p className={`mt-1 text-sm ${notification.read === true ? 'text-slate-500' : 'text-slate-600'}`}>
                    {notification.content}
                  </p>
                  {notification.sender && notification.sender !== 'ç³»ç»Ÿ' && (
                    <span className="inline-block mt-1.5 text-[10px] text-slate-400 bg-slate-100 px-2 py-0.5 rounded font-bold">via {notification.sender}</span>
                  )}
                </div>
                <ArrowRight size={18} className="text-slate-300 group-hover:text-indigo-600 group-hover:translate-x-1 transition-all flex-shrink-0 mt-3" />
              </div>
            </div>
          ))}
        </div>
      )}

      {/* é€šçŸ¥è®¾ç½® */}
      <div className="mt-8 bg-white rounded-xl border border-slate-100 p-5">
        <div className="flex items-center justify-between">
          <div>
            <h4 className="text-sm font-bold text-slate-800">æ™ºèƒ½æ¶ˆæ¯æ¨é€</h4>
            <p className="text-xs text-slate-500 mt-0.5">ç®€å†åˆç­›æˆ–çº¦é¢æˆåŠŸæ—¶é€šè¿‡é‚®ä»¶é€šçŸ¥</p>
          </div>
          <button 
            onClick={toggleNotificationEnabled}
            className={`w-11 h-6 rounded-full relative transition-colors ${notificationEnabled ? 'bg-indigo-600' : 'bg-slate-300'}`}
          >
            <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${notificationEnabled ? 'right-1' : 'left-1'}`}></div>
          </button>
        </div>
      </div>
    </div>
  );
};

// --- Token ä¸èµ„é‡‘ç®¡ç†é¡µé¢ ---
const TokenManagementView = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const userId = user?.id || 0;
  const [selectedPkg, setSelectedPkg] = useState<string | null>(null);
  const [showCustomAmount, setShowCustomAmount] = useState(false);
  const [customAmount, setCustomAmount] = useState<string>('');
  const [showInviteCode, setShowInviteCode] = useState(false);
  const [historyPage, setHistoryPage] = useState(0);
  
  // åŠ¨æ€æ•°æ®çŠ¶æ€
  const [tokenStats, setTokenStats] = useState<any>(null);
  const [tokenHistory, setTokenHistory] = useState<any[]>([]);
  const [historyTotal, setHistoryTotal] = useState(0);
  const [agentStats, setAgentStats] = useState<any[]>([]);
  const [agentTotal, setAgentTotal] = useState(0);
  const [packagesData, setPackagesData] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [codeCopiedT, setCodeCopiedT] = useState(false);
  const [linkCopiedT, setLinkCopiedT] = useState(false);
  
  // åŠ è½½æ•°æ®
  useEffect(() => {
    const loadData = async () => {
      if (!userId) return;
      setLoading(true);
      try {
        const { getTokenStats, getTokenHistory, getTokenPackages, getTokenStatsByAgent } = await import('./services/apiService');
        
        const [statsRes, historyRes, packagesRes, agentRes] = await Promise.all([
          getTokenStats(userId),
          getTokenHistory(userId, 10, 0),
          getTokenPackages(),
          getTokenStatsByAgent(userId).catch(() => ({ agents: [], total_tokens: 0 }))
        ]);
        
        setTokenStats(statsRes);
        setTokenHistory(historyRes.items || []);
        setHistoryTotal(historyRes.total || 0);
        setPackagesData(packagesRes);
        setAgentStats(agentRes.agents || []);
        setAgentTotal(agentRes.total_tokens || 0);
      } catch (error) {
        console.error('åŠ è½½ Token æ•°æ®å¤±è´¥:', error);
        setTokenStats({ balance: 50000, balance_display: '50,000', today_usage: 0, today_usage_display: '0', estimated_days: 999 });
        setPackagesData({
          exchange_rate: 'Â¥1 = 10,000 Tokens',
          packages: [
            { id: 'starter', name: 'å…¥é—¨ç‰ˆ', tokens: 500000, tokens_display: '500K', price: 39.9, unit_price: 'Â¥0.08/ä¸‡', discount: 'çƒ­é”€' },
            { id: 'standard', name: 'æ ‡å‡†ç‰ˆ', tokens: 2000000, tokens_display: '2M', price: 129, unit_price: 'Â¥0.065/ä¸‡', discount: 'æ€§ä»·æ¯”æœ€é«˜', popular: true },
            { id: 'pro', name: 'ä¸“ä¸šç‰ˆ', tokens: 5000000, tokens_display: '5M', price: 299, unit_price: 'Â¥0.06/ä¸‡', discount: 'çœ 40%' },
            { id: 'enterprise', name: 'ä¼ä¸šç‰ˆ', tokens: 20000000, tokens_display: '20M', price: 899, unit_price: 'Â¥0.045/ä¸‡', discount: 'çœ 55%' },
          ],
          invite_reward: { inviter: 50000, invitee: 20000 }
        });
      } finally {
        setLoading(false);
      }
    };
    loadData();
  }, [userId]);

  // åŠ è½½æ›´å¤šå†å²
  const loadMoreHistory = async () => {
    try {
      const { getTokenHistory } = await import('./services/apiService');
      const nextPage = historyPage + 1;
      const res = await getTokenHistory(userId, 10, nextPage * 10);
      setTokenHistory(prev => [...prev, ...(res.items || [])]);
      setHistoryPage(nextPage);
    } catch (e) { console.error(e); }
  };

  // åº•å±‚æ¨¡å‹å â†’ Devnors å“ç‰Œåæ˜ å°„
  const modelDisplayName = (raw: string | undefined): string => {
    if (!raw) return '';
    const map: Record<string, string> = {
      'abab6.5s-chat': 'Devnors 1.0',
      'abab6.5s': 'Devnors 1.0',
      'gemini-2.0-flash': 'Devnors 1.0 Pro',
      'gemini-2.0-flash-lite': 'Devnors 1.0',
      'gemini-2.5-pro': 'Devnors 1.0 Ultra',
      'gemini-2.5-flash': 'Devnors 1.0 Pro',
    };
    return map[raw] || raw;
  };

  const agentColors = ['bg-indigo-600', 'bg-emerald-500', 'bg-amber-500', 'bg-rose-500', 'bg-cyan-500', 'bg-purple-500', 'bg-pink-500'];
  const agentNameMap: Record<string, string> = {
    'CHAT': 'AI å¯¹è¯', 'RESUME_PARSE': 'ç®€å†è§£ææ™ºèƒ½ä½“', 'JOB_MATCH': 'èŒä½åŒ¹é…æ™ºèƒ½ä½“',
    'INTERVIEW': 'é¢è¯•è¯„ä¼°æ™ºèƒ½ä½“', 'MARKET_ANALYSIS': 'å¸‚åœºåˆ†ææ™ºèƒ½ä½“', 'ROUTE_DISPATCH': 'è·¯ç”±è°ƒåº¦æ™ºèƒ½ä½“',
    'OTHER': 'å…¶ä»–æœåŠ¡', 'INVITE_REWARD': 'é‚€è¯·å¥–åŠ±',
  };
  const actionTypeMap: Record<string, string> = {
    'CHAT': 'AI å¯¹è¯', 'RESUME_PARSE': 'ç®€å†è§£æ', 'JOB_MATCH': 'èŒä½åŒ¹é…',
    'INTERVIEW': 'é¢è¯•è¯„ä¼°', 'MARKET_ANALYSIS': 'å¸‚åœºåˆ†æ', 'ROUTE_DISPATCH': 'è·¯ç”±è°ƒåº¦',
    'OTHER': 'å…¶ä»–', 'INVITE_REWARD': 'é‚€è¯·å¥–åŠ±',
  };
  // å„åŠŸèƒ½å¹³å‡æ¯æ¬¡æ¶ˆè€— token æ•°ï¼ˆåŸºäºå®é™…åç«¯è®°å½•ï¼‰
  const TOKEN_PER_ACTION: Record<string, number> = {
    'CHAT': 800, 'RESUME_PARSE': 4000, 'JOB_MATCH': 1500,
    'INTERVIEW': 2000, 'MARKET_ANALYSIS': 6000, 'RECRUIT': 4000, 'ROUTE_DISPATCH': 1500, 'OTHER': 1500,
  };
  // å°† token æ•°ç¿»è¯‘æˆç”¨æˆ·èƒ½ç†è§£çš„åŠŸèƒ½æ¬¡æ•°
  const tokenToUsage = (tokens: number) => {
    const chat = Math.floor(tokens / TOKEN_PER_ACTION.CHAT);
    const resume = Math.floor(tokens / TOKEN_PER_ACTION.RESUME_PARSE);
    const interview = Math.floor(tokens / TOKEN_PER_ACTION.INTERVIEW);
    const recruit = Math.floor(tokens / TOKEN_PER_ACTION.RECRUIT);
    return { chat, resume, interview, recruit };
  };

  const packages = packagesData?.packages || [];
  const inviteReward = packagesData?.invite_reward || { inviter: 50000, invitee: 20000 };
  
  if (loading) {
    return (
      <div className="pt-20 text-center">
        <Loader2 className="mx-auto text-indigo-600 animate-spin mb-4" size={40} />
        <p className="text-slate-400 text-sm">åŠ è½½ä¸­...</p>
      </div>
    );
  }

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-500">
      {/* é¡µé¢æ ‡é¢˜ */}
      <div className="flex items-center justify-between mb-10">
        <div>
          <h1 className="text-2xl font-bold text-slate-900 mb-1">èµ„é‡‘è´¦æˆ·</h1>
          <p className="text-slate-400 text-sm">ç®¡ç† Token ä½™é¢ã€å……å€¼ä¸æ¶ˆè€—ç»Ÿè®¡</p>
        </div>
        <button onClick={() => navigate('/pricing')} className="text-sm text-indigo-600 font-bold hover:underline flex items-center gap-1">
          æŸ¥çœ‹å®šä»·æ–¹æ¡ˆ <ChevronRight size={14} />
        </button>
      </div>

      {/* ä½™é¢å¡ç‰‡ */}
      {(() => {
        const balance = tokenStats?.balance || 0;
        const usage = tokenToUsage(balance);
        return (
          <div className="mb-8 bg-white rounded-lg border border-slate-200 p-6 shadow-sm">
            <div className="flex items-start justify-between">
              <div>
                <p className="text-slate-400 text-xs font-medium mb-2">å¯ç”¨ä½™é¢</p>
                <div className="flex items-end gap-3 mb-2">
                  <span className="text-2xl md:text-4xl font-black text-slate-900 leading-none">{tokenStats?.balance_display || balance.toLocaleString()}</span>
                  <span className="text-slate-400 text-sm font-medium pb-0.5">Tokens</span>
                </div>
                <div className="flex items-center gap-4 text-xs text-slate-400">
                  <span className="flex items-center gap-1">
                    <Coins size={12} className="text-slate-300" /> â‰ˆ Â¥{(balance / 10000).toFixed(1)}
                  </span>
                  <span className="text-slate-200">|</span>
                  <span>ä»Šæ—¥æ¶ˆè€— <span className="font-bold text-slate-600">{tokenStats?.today_usage_display || (tokenStats?.today_usage || 0).toLocaleString()}</span></span>
                  {agentTotal > 0 && (
                    <>
                      <span className="text-slate-200">|</span>
                      <span>ç´¯è®¡ <span className="font-bold text-slate-600">{agentTotal.toLocaleString()}</span></span>
                    </>
                  )}
                </div>
              </div>
              <div className="flex items-center gap-2">
                <Gem size={28} className="text-indigo-100" />
              </div>
            </div>
            {/* ä½™é¢èƒ½åšä»€ä¹ˆ â€” è®©ç”¨æˆ·ç›´è§‚ç†è§£ */}
            {balance > 0 && (
              <div className="mt-4 pt-4 border-t border-slate-100">
                <p className="text-[11px] text-slate-400 mb-2">å½“å‰ä½™é¢çº¦å¯ä½¿ç”¨</p>
                <div className="flex flex-wrap gap-2">
                  <span className="inline-flex items-center gap-1 px-2.5 py-1 bg-indigo-50 text-indigo-600 rounded-full text-[11px] font-bold">
                    <MessageSquare size={11} /> {usage.chat.toLocaleString()} æ¬¡ AI å¯¹è¯
                  </span>
                  <span className="inline-flex items-center gap-1 px-2.5 py-1 bg-emerald-50 text-emerald-600 rounded-full text-[11px] font-bold">
                    <FileText size={11} /> {usage.resume.toLocaleString()} æ¬¡ç®€å†è§£æ
                  </span>
                  <span className="inline-flex items-center gap-1 px-2.5 py-1 bg-amber-50 text-amber-600 rounded-full text-[11px] font-bold">
                    <GraduationCap size={11} /> {usage.interview.toLocaleString()} æ¬¡æ¨¡æ‹Ÿé¢è¯•
                  </span>
                  <span className="inline-flex items-center gap-1 px-2.5 py-1 bg-rose-50 text-rose-600 rounded-full text-[11px] font-bold">
                    <Rocket size={11} /> {usage.recruit.toLocaleString()} æ¬¡æ™ºèƒ½æ‹›è˜
                  </span>
                </div>
              </div>
            )}
          </div>
        );
      })()}

      {/* å……å€¼ */}
      <div className="mb-10 bg-white rounded-lg border border-slate-200 p-6 shadow-sm">
        <div className="flex items-center justify-between mb-5">
          <h2 className="text-base font-bold text-slate-900 flex items-center gap-2">
            <CreditCard size={16} className="text-indigo-500" /> å……å€¼ Token
          </h2>
          <span className="text-[11px] text-slate-400 bg-slate-50 px-2.5 py-1 rounded-full">Â¥1 = 10,000 Tokens</span>
        </div>

        {/* é‡‘é¢è¾“å…¥åŒº */}
        <div className="mb-4">
          <div className="relative">
            <span className="absolute left-5 top-1/2 -translate-y-1/2 text-2xl font-black text-slate-300">Â¥</span>
            <input
              type="number"
              value={customAmount || (selectedPkg ? String(packages.find((p: any) => p.id === selectedPkg)?.price || '') : '')}
              onChange={(e) => { setCustomAmount(e.target.value); setSelectedPkg(null); }}
              onFocus={() => { if (selectedPkg) { setCustomAmount(String(packages.find((p: any) => p.id === selectedPkg)?.price || '')); setSelectedPkg(null); } }}
              placeholder="è¾“å…¥å……å€¼é‡‘é¢"
              min="1"
              className="w-full pl-12 pr-4 py-4 text-2xl font-black text-slate-900 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 focus:bg-white transition-all [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
            />
            {(() => {
              const selectedPkgData = selectedPkg ? packages.find((p: any) => p.id === selectedPkg) : null;
              const amt = Number(customAmount || (selectedPkgData ? selectedPkgData.price : 0));
              const tokens = selectedPkgData ? (selectedPkgData.tokens || amt * 10000) : amt * 10000;
              const u = tokenToUsage(tokens);
              return amt > 0 ? (
                <div className="absolute right-4 top-1/2 -translate-y-1/2 text-right">
                  <span className="text-sm font-bold text-indigo-500">{tokens.toLocaleString()} Tokens</span>
                  <span className="block text-[10px] text-slate-400 mt-0.5">â‰ˆ {u.chat.toLocaleString()} æ¬¡å¯¹è¯ / {u.resume.toLocaleString()} æ¬¡ç®€å†è§£æ</span>
                </div>
              ) : null;
            })()}
          </div>
        </div>

        {/* å¿«æ·å¥—é¤ */}
        <div className="flex flex-wrap gap-1.5 mb-5">
          {packages.map((pkg: any, i: number) => {
            const isSelected = selectedPkg === pkg.id;
            const pkgUsage = tokenToUsage(pkg.tokens || 0);
            return (
              <button
                key={pkg.id || i}
                onClick={() => { setSelectedPkg(pkg.id); setCustomAmount(''); }}
                className={`px-3.5 py-1.5 rounded-full text-xs transition-all flex items-center gap-1 ${
                  isSelected
                    ? 'bg-indigo-600 shadow-sm'
                    : 'bg-slate-100 hover:bg-indigo-50'
                }`}
              >
                <span className={`font-black ${isSelected ? 'text-white' : 'text-indigo-600'}`}>Â¥{pkg.price}</span>
                <span className={`${isSelected ? 'text-indigo-300' : 'text-slate-300'}`}>/</span>
                <span className={`font-medium ${isSelected ? 'text-indigo-200' : 'text-slate-400'}`}>{(pkg.tokens || 0).toLocaleString()} tokens</span>
              </button>
            );
          })}
        </div>

        {/* å……å€¼æŒ‰é’® */}
        {(() => {
          const amt = Number(customAmount || (selectedPkg ? packages.find((p: any) => p.id === selectedPkg)?.price : 0));
          const tokens = amt * 10000;
          return (
            <button
              disabled={amt <= 0}
              className={`w-full py-3.5 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 ${
                amt > 0
                  ? 'bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg shadow-indigo-200/50'
                  : 'bg-slate-100 text-slate-400 cursor-not-allowed'
              }`}
            >
              <Wallet size={16} />
              {amt > 0
                ? `ç«‹å³å……å€¼ Â¥${amt}`
                : 'é€‰æ‹©æˆ–è¾“å…¥å……å€¼é‡‘é¢'
              }
            </button>
          );
        })()}
      </div>

      {/* é‚€è¯·å¥½å‹ */}
      {(() => {
        const myInviteCode = user?.invite_code || '';
        const myInviteLink = myInviteCode ? `${window.location.origin}${window.location.pathname}#/login?ref=${myInviteCode}` : '';
        const doCopy = (text: string, setFlag: (v: boolean) => void) => {
          try {
            navigator.clipboard.writeText(text).then(() => {
              setFlag(true);
              setTimeout(() => setFlag(false), 2000);
            }).catch(() => {
              const ta = document.createElement('textarea');
              ta.value = text;
              ta.style.position = 'fixed';
              ta.style.opacity = '0';
              document.body.appendChild(ta);
              ta.select();
              document.execCommand('copy');
              document.body.removeChild(ta);
              setFlag(true);
              setTimeout(() => setFlag(false), 2000);
            });
          } catch {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            setFlag(true);
            setTimeout(() => setFlag(false), 2000);
          }
        };
        return (
          <div className="mb-10 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-8 border border-indigo-100">
            <div className="flex items-center justify-between mb-5">
              <div>
                <h3 className="text-lg font-black text-slate-900 mb-2 flex items-center gap-2">
                  <Gift size={20} className="text-indigo-500" /> é‚€è¯·å¥½å‹ï¼ŒåŒæ–¹è·èµ  Token
                </h3>
                <p className="text-sm text-slate-600">
                  æ¯é‚€è¯·ä¸€ä½å¥½å‹æ³¨å†Œï¼Œæ‚¨è·å¾— <span className="font-bold text-indigo-600">{inviteReward.inviter?.toLocaleString()} tokens</span>ï¼Œå¥½å‹è·å¾— <span className="font-bold text-indigo-600">{inviteReward.invitee?.toLocaleString()} tokens</span>
                </p>
              </div>
              <button 
                onClick={() => navigate('/invite')}
                className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 transition-all whitespace-nowrap shadow-lg shadow-indigo-200"
              >
                æŸ¥çœ‹é‚€è¯·è®°å½•
              </button>
            </div>

            {/* é‚€è¯·ç  + é‚€è¯·é“¾æ¥ */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {/* é‚€è¯·ç  */}
              <div className="rounded-lg p-4 flex items-center justify-between border border-indigo-200">
                <div>
                  <p className="text-[11px] text-indigo-400 font-medium mb-1">é‚€è¯·ç </p>
                  <div className="text-xl font-black text-slate-900 tracking-[0.2em]">{myInviteCode || '------'}</div>
                  <p className="text-[10px] text-slate-400 mt-0.5">å¥½å‹æ³¨å†Œæ—¶å¡«å†™æ­¤é‚€è¯·ç </p>
                </div>
                <button 
                  onClick={() => doCopy(myInviteCode, setCodeCopiedT)}
                  className={`px-3 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-1 ${codeCopiedT ? 'bg-emerald-500 text-white' : 'bg-indigo-600 text-white hover:bg-indigo-700'}`}
                >
                  {codeCopiedT ? <><CheckCircle2 size={12} /> å·²å¤åˆ¶</> : <><Link2 size={12} /> å¤åˆ¶</>}
                </button>
              </div>
              {/* é‚€è¯·é“¾æ¥ */}
              <div className="rounded-lg p-4 flex items-center justify-between border border-indigo-200">
                <div className="min-w-0 flex-1 mr-3">
                  <p className="text-[11px] text-indigo-400 font-medium mb-1">é‚€è¯·é“¾æ¥</p>
                  <div className="text-xs font-mono text-slate-600 truncate">{myInviteLink || '------'}</div>
                  <p className="text-[10px] text-slate-400 mt-0.5">å¥½å‹ç‚¹å‡»é“¾æ¥ç›´æ¥æ³¨å†Œ</p>
                </div>
                <button 
                  onClick={() => doCopy(myInviteLink, setLinkCopiedT)}
                  className={`px-3 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-1 whitespace-nowrap ${linkCopiedT ? 'bg-emerald-500 text-white' : 'bg-indigo-600 text-white hover:bg-indigo-700'}`}
                >
                  {linkCopiedT ? <><CheckCircle2 size={12} /> å·²å¤åˆ¶</> : <><Share2 size={12} /> å¤åˆ¶</>}
                </button>
              </div>
            </div>
          </div>
        );
      })()}

      {/* Token æ¶ˆè€—å…¨æ™¯ */}
      <div className="mb-8">
        <h2 className="text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
          <PieChart className="text-amber-500" size={15} /> Token æ¶ˆè€—å…¨æ™¯
        </h2>
        <div className="bg-white rounded-xl border border-slate-200 p-5 shadow-sm">
          {agentStats.length > 0 ? (
            <>
              {/* å æ¯”æ¡ */}
              <div className="mb-4">
                <div className="flex items-center justify-between mb-1.5">
                  <span className="text-[11px] text-slate-400">å„æ™ºèƒ½ä½“æ¶ˆè€—å æ¯”</span>
                  <span className="text-[11px] font-bold text-slate-500">æ€»è®¡ {agentTotal.toLocaleString()} tokens</span>
                </div>
                <div className="relative h-2.5 bg-slate-100 rounded-full overflow-hidden flex">
                  {agentStats.map((a: any, i: number) => (
                    <div key={i} className={`h-full ${agentColors[i % agentColors.length]} transition-all duration-1000`} style={{ width: `${a.percentage || 0}%` }} title={`${agentNameMap[a.action] || agentNameMap[a.action?.toUpperCase()] || a.name || a.action}: ${a.percentage}%`}></div>
                  ))}
                </div>
              </div>
              {/* æ˜ç»†å¡ç‰‡ */}
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                {agentStats.map((a: any, i: number) => (
                  <div key={i} className="p-3 bg-slate-50 rounded-lg border border-slate-100">
                    <div className="flex items-center gap-1.5 mb-1.5">
                      <div className={`w-2 h-2 rounded-full ${agentColors[i % agentColors.length]}`}></div>
                      <span className="text-[11px] font-bold text-slate-500 truncate">{agentNameMap[a.action] || agentNameMap[a.action?.toUpperCase()] || a.name || a.action}</span>
                      <span className="text-[11px] font-black text-indigo-600 ml-auto">{(a.percentage || 0).toFixed(0)}%</span>
                    </div>
                    <div className="text-lg font-black text-slate-900">{(a.total_tokens || 0).toLocaleString()}</div>
                    <div className="text-[10px] text-slate-400">{a.count || 0} æ¬¡è°ƒç”¨</div>
                  </div>
                ))}
              </div>
            </>
          ) : (
            <div className="text-center py-6 text-slate-400">
              <PieChart size={28} className="mx-auto mb-2 opacity-20" />
              <p className="text-xs">æš‚æ— æ¶ˆè€—æ•°æ®ï¼Œä½¿ç”¨ AI åŠŸèƒ½åå°†åœ¨æ­¤å±•ç¤ºç»Ÿè®¡</p>
            </div>
          )}
        </div>
      </div>

      {/* æ¶ˆè´¹è®°å½• */}
      <div>
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-bold text-slate-900">æ¶ˆè´¹è®°å½•</h2>
          <span className="text-xs text-slate-400">å…± {historyTotal} æ¡</span>
        </div>
        <div className="bg-white rounded-xl border border-slate-100 overflow-hidden">
          {tokenHistory.length > 0 ? tokenHistory.map((h: any, i: number) => {
            const isReward = (h.tokens_used || h.tokens || 0) < 0;
            return (
              <div key={i} className={`flex items-center justify-between px-5 py-4 ${i > 0 ? 'border-t border-slate-50' : ''}`}>
                <div className="flex items-center gap-3">
                  <div className={`w-9 h-9 rounded-lg flex items-center justify-center ${isReward ? 'bg-emerald-50' : 'bg-slate-100'}`}>
                    {isReward ? <Gift size={16} className="text-emerald-500" /> : <Zap size={16} className="text-slate-500" />}
                  </div>
                  <div>
                    <p className="text-sm font-medium text-slate-900">{h.description || actionTypeMap[h.action] || actionTypeMap[h.action?.toUpperCase()] || h.type || h.action || 'æœªçŸ¥'}{h.action ? <span className="ml-1.5 text-[10px] text-slate-500 font-mono bg-slate-100 px-1.5 py-0.5 rounded">{h.action}</span> : null}</p>
                    <p className="text-xs text-slate-400">{h.created_at ? parseUTC(h.created_at).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : h.date || ''}</p>
                  </div>
                </div>
                <div className="text-right">
                  <p className={`text-sm font-bold ${isReward ? 'text-emerald-600' : 'text-slate-900'}`}>
                    {isReward ? '+' : '-'}{Math.abs(h.tokens_used || h.tokens || 0).toLocaleString()}
                  </p>
                  <p className="text-xs text-slate-400">
                    {modelDisplayName(h.model_name)}
                  </p>
                </div>
              </div>
            );
          }) : (
            <div className="text-center py-8 text-slate-400">
              <History size={28} className="mx-auto mb-2 opacity-30" />
              <p className="text-sm">æš‚æ— æ¶ˆè´¹è®°å½•</p>
            </div>
          )}
        </div>
        {tokenHistory.length > 0 && tokenHistory.length < historyTotal && (
          <button onClick={loadMoreHistory} className="w-full mt-3 py-3 text-sm text-indigo-600 font-bold hover:bg-indigo-50 rounded-xl transition-all">
            åŠ è½½æ›´å¤š
          </button>
        )}
      </div>
    </div>
  );
};

// --- å·¥ä½œå°é¡µé¢ ---
const WorkbenchView = () => {
  const navigate = useNavigate();
  const { user, isLoggedIn, userRole } = useAuth();
  
  // ä½¿ç”¨å½“å‰ç™»å½•ç”¨æˆ·çš„ ID è·å–æ•°æ®ï¼ˆçº¯åŠ¨æ€æ•°æ®ï¼‰
  const userId = user?.id || 0;
  const { data: flowsData, loading: flowsLoading } = useFlows(20, userId || undefined);
  const { data: flowStats } = useFlowStats(userId || undefined);
  const { data: todosData, loading: todosLoading } = useTodos(userId);

  const isEmployer = userRole === 'employer' || userRole === 'recruiter';
  const isCandidate = userRole === 'candidate';

  // é˜Ÿåˆ—ç­›é€‰çŠ¶æ€
  const [queueFilter, setQueueFilter] = useState<string | null>(null);

  // è½¬æ¢ flows æ•°æ®ä¸ºå‰ç«¯éœ€è¦çš„æ ¼å¼ â€” åç«¯å·²æŒ‰è§’è‰²è¿”å›å¯¹åº”è§†è§’
  const allMatchingData = (flowsData || []).map((flow: any) => ({
    id: flow.id,
    candidate: flow.candidateName || 'æœªçŸ¥å€™é€‰äºº',
    candidateId: flow.candidateId,
    job: flow.role || 'æœªçŸ¥èŒä½',
    jobId: flow.jobId,
    company: flow.company || 'æœªçŸ¥å…¬å¸',
    salary: flow.salary || 'é¢è®®',
    matchScore: flow.matchScore || 0,
    currentStep: flow.currentStep || 1,
    totalSteps: flow.totalSteps || 4,
    nodes: flow.nodes || (isCandidate ? ['æŠ•é€’', 'åŒ¹é…', 'ç­›é€‰', 'ç»“æœ'] : ['é‚€è¯·', 'åŒ¹é…', 'ç­›é€‰', 'ç»“æœ']),
    lastAction: flow.lastAction || flow.timeline?.[0]?.action || 'æµç¨‹è¿›è¡Œä¸­',
    queueType: flow.queueType || (isCandidate ? 'delivery' : 'recruit'),
    rawStatus: flow.status,
    status: flow.status === 'completed' ? 'å·²é€šè¿‡' : flow.status === 'rejected' ? 'æœªé€šè¿‡' : flow.status === 'screening' ? 'ç­›é€‰ä¸­' : 'è¿›è¡Œä¸­',
    statusColor: flow.status === 'completed' ? 'bg-emerald-50 text-emerald-600' : flow.status === 'rejected' ? 'bg-red-50 text-red-500' : flow.status === 'screening' ? 'bg-amber-50 text-amber-600' : 'bg-indigo-50 text-indigo-600',
  }));

  // æ ¹æ®ç­›é€‰æ¡ä»¶è¿‡æ»¤
  const matchingData = useMemo(() => {
    if (!queueFilter) return allMatchingData;
    if (queueFilter === 'passed') return allMatchingData.filter((d: any) => d.rawStatus === 'completed');
    if (queueFilter === 'pending') return allMatchingData.filter((d: any) => !['completed', 'rejected'].includes(d.rawStatus));
    if (queueFilter === 'rejected') return allMatchingData.filter((d: any) => d.rawStatus === 'rejected');
    return allMatchingData;
  }, [allMatchingData, queueFilter]);

  const tokenStats = [
    { agent: 'ç®€å†è§£ææ™ºèƒ½ä½“', tokens: '420,500', share: '35%', rawTokens: 420500, perCall: 4000 },
    { agent: 'é¢è¯•è¯„ä¼°æ™ºèƒ½ä½“', tokens: '312,200', share: '26%', rawTokens: 312200, perCall: 2000 },
    { agent: 'å¸‚åœºåˆ†ææ™ºèƒ½ä½“', tokens: '288,400', share: '24%', rawTokens: 288400, perCall: 6000 },
    { agent: 'è·¯ç”±è°ƒåº¦æ™ºèƒ½ä½“', tokens: '180,900', share: '15%', rawTokens: 180900, perCall: 1500 },
  ];
  
  // è½¬æ¢ todos æ•°æ® - æ ¹æ®å­—ç¬¦ä¸² icon æ˜ å°„åˆ°ç»„ä»¶
  const getIconComponent = (iconName: string) => {
    switch (iconName) {
      case 'UserIcon': return UserIcon;
      case 'Building2': return Building2;
      case 'Calendar': return Calendar;
      case 'Zap': return Zap;
      default: return Calendar;
    }
  };
  
  // æ ¹æ®ç”¨æˆ·è§’è‰²è¿‡æ»¤ä»»åŠ¡
  const roleFilteredTodos = useMemo(() => {
    if (!todosData || todosData.length === 0) return [];
    const recruitKeywords = ['æ™ºèƒ½æ‹›è˜', 'ä¼ä¸šè®¤è¯', 'ä¼ä¸šèµ„æ–™', 'ç­›é€‰å€™é€‰äºº', 'å®‰æ’é¢è¯•', 'äººæ‰åˆ†æ'];
    const candidateKeywords = ['ä¸ªäººè®¤è¯', 'ç®€å†', 'æ±‚èŒ', 'èŒä½æ¨è'];
    return todosData.filter((todo: any) => {
      const todoType = (todo.todo_type || todo.type || '').toUpperCase();
      const title = todo.title || todo.task || '';
      if (userRole === 'candidate') {
        if (todoType === 'RECRUIT' || todoType === 'EMPLOYER') return false;
        if (recruitKeywords.some(kw => title.includes(kw))) return false;
      } else if (userRole === 'employer' || userRole === 'recruiter') {
        if (todoType === 'CANDIDATE') return false;
        if (candidateKeywords.some(kw => title.includes(kw))) return false;
      }
      return true;
    });
  }, [todosData, userRole]);
  
  const todosWithIcons = roleFilteredTodos.map((todo: any) => {
    const priorityLower = (todo.priority || '').toLowerCase();
    return {
      ...todo,
      task: todo.title || todo.task,
      icon: getIconComponent(todo.icon),
      priority: priorityLower === 'high' ? 'High' : priorityLower === 'medium' ? 'Medium' : 'Low',
    };
  });

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-700">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
        <div>
          <h1 className="text-2xl md:text-4xl font-black text-slate-900 mb-2 ">æ™ºèƒ½å·¥ä½œå°</h1>
          <p className="text-slate-500 font-medium ">ç”± Devnors MAS å¤šæ™ºèƒ½ä½“ç³»ç»Ÿé©±åŠ¨çš„å…¨å±€æ‹›è˜æ¦‚è§ˆ</p>
        </div>
        <div className="flex gap-3">
          <button 
            onClick={() => navigate('/invite')}
            className="bg-white border border-slate-200 text-slate-600 px-6 py-3.5 rounded font-black text-sm flex items-center gap-2 shadow-sm hover:bg-slate-50 transition-all active:scale-95    "
          >
            <Users2 size={20} className="text-emerald-500" /> é‚€è¯·
          </button>
          <button 
            onClick={() => navigate('/tokens')}
            className="bg-white border border-slate-200 text-slate-600 px-6 py-3.5 rounded font-black text-sm flex items-center gap-2 shadow-sm hover:bg-slate-50 transition-all active:scale-95    "
          >
            <CircleDollarSign size={20} className="text-amber-500" /> èµ„é‡‘è´¦æˆ·
          </button>
          <button 
            onClick={() => navigate(`/workbench/todo/${todosWithIcons[0]?.id || '1'}`)}
            className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3.5 rounded font-black text-sm flex items-center gap-2 shadow-xl shadow-indigo-100 transition-all active:scale-95 "
          >
            <Bot size={20} /> AIåŠ©æ‰‹
          </button>
        </div>
      </div>

      <div className="mb-10 bg-white p-8 rounded-lg border border-slate-100 card-shadow  ">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-black text-slate-900 flex items-center gap-3 ">
            <ListTodo className="text-indigo-600" /> ä»»åŠ¡ä¸­å¿ƒ
          </h2>
          <button 
            onClick={() => navigate('/workbench/todos')}
            className="flex items-center gap-2 text-sm font-black text-indigo-600 hover:text-indigo-700 transition-colors  "
          >
            æŸ¥çœ‹å…¨éƒ¨ <ArrowRight size={16} />
          </button>
        </div>
        {todosLoading ? (
          <div className="flex justify-center py-8"><Loader2 className="animate-spin text-indigo-600" size={32} /></div>
        ) : !isLoggedIn ? (
          <div className="flex flex-col items-center justify-center py-12 text-center">
            <UserIcon size={48} className="text-slate-200 mb-4" />
            <p className="text-slate-400 text-sm font-medium mb-2">è¯·å…ˆç™»å½•</p>
            <p className="text-slate-300 text-xs mb-4">ç™»å½•åå¯æŸ¥çœ‹æ‚¨çš„ä»»åŠ¡</p>
            <button 
              onClick={() => navigate('/login')}
              className="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-500 transition-colors"
            >
              ç«‹å³ç™»å½•
            </button>
          </div>
        ) : todosWithIcons.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-12 text-center">
            <ListTodo size={48} className="text-slate-200 mb-4" />
            <p className="text-slate-400 text-sm font-medium mb-2">æš‚æ— ä»»åŠ¡</p>
            <p className="text-slate-300 text-xs">AI åŠ©æ‰‹ä¼šè‡ªåŠ¨ä¸ºæ‚¨ç”Ÿæˆä»»åŠ¡</p>
          </div>
        ) : (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {todosWithIcons.slice(0, 3).map((todo: any) => {
            const TodoIconComp = todo.icon;
            return (
            <div 
              key={todo.id} 
              onClick={() => navigate(`/workbench/todo/${todo.id}`)}
              className="group cursor-pointer p-6 bg-slate-50 rounded border border-slate-100 flex items-center gap-4 hover:bg-white hover:border-indigo-200 transition-all   "
            >
              <div className="w-12 h-12 bg-white rounded flex items-center justify-center text-indigo-600 border border-slate-100 group-hover:bg-indigo-600 group-hover:text-white transition-all">
                <TodoIconComp size={20} />
              </div>
              <div className="flex-1">
                <div className="text-xs font-black text-slate-400 uppercase tracking-widest mb-1 ">
                  {todo.priority === 'High' ? 'æ ¸å¿ƒä»»åŠ¡' : todo.priority === 'Medium' ? 'å¸¸è§„ä»»åŠ¡' : 'å»ºè®®ä»»åŠ¡'}
                </div>
                <div className="text-sm font-bold text-slate-700 group-hover:text-indigo-600 ">{todo.task}</div>
              </div>
              <ArrowRight size={16} className="text-slate-300 group-hover:text-indigo-600" />
            </div>
          )})}
        </div>
        )}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-10">
        <div className="lg:col-span-12 space-y-8">
          <div className="bg-white p-8 rounded-lg border border-slate-100 card-shadow overflow-hidden">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-slate-900 flex items-center gap-3">
                <Activity className="text-indigo-600" size={24} /> {isCandidate ? 'æ™ºèƒ½æŠ•é€’é˜Ÿåˆ—' : 'æ™ºèƒ½æ‹›è˜é˜Ÿåˆ—'}
              </h2>
              {queueFilter && (
                <button
                  onClick={() => setQueueFilter(null)}
                  className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium text-slate-500 hover:text-slate-700 bg-slate-100 hover:bg-slate-200 transition-all"
                >
                  <X size={12} /> æ¸…é™¤ç­›é€‰
                </button>
              )}
            </div>

            {/* ç»Ÿè®¡æŒ‡æ ‡æ¡ + ç­›é€‰ */}
            {isLoggedIn && !flowsLoading && (
              <div className="flex items-center gap-2 mb-6 flex-wrap">
                {/* å…¨éƒ¨ pill */}
                <button
                  onClick={() => setQueueFilter(null)}
                  className={`group flex items-center gap-2 px-3.5 py-2 rounded-lg text-xs font-bold transition-all duration-200 border ${
                    queueFilter === null
                      ? 'bg-indigo-600 text-white border-indigo-600 shadow-md shadow-indigo-200'
                      : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300 hover:bg-slate-50'
                  }`}
                >
                  <Activity size={13} className={queueFilter === null ? 'text-white' : 'text-slate-400 group-hover:text-slate-500'} />
                  å…¨éƒ¨
                  <span className={`ml-0.5 tabular-nums ${queueFilter === null ? 'text-white/80' : 'text-slate-400'}`}>{flowStats?.total || allMatchingData.length}</span>
                </button>

                {isCandidate ? (
                  <>
                    {/* å·²æ‰«æ â€” çº¯å±•ç¤º */}
                    <div className="flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium bg-blue-50/80 text-blue-600 border border-blue-100/80">
                      <Eye size={12} />
                      <span>æ‰«æ</span>
                      <span className="font-black tabular-nums">{(flowStats?.viewed || 0).toLocaleString()}</span>
                    </div>
                    {/* å·²æŠ•é€’ â€” çº¯å±•ç¤º */}
                    <div className="flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium bg-indigo-50/80 text-indigo-600 border border-indigo-100/80">
                      <Send size={12} />
                      <span>æŠ•é€’</span>
                      <span className="font-black tabular-nums">{flowStats?.applied || 0}</span>
                    </div>
                  </>
                ) : (
                  <div className="flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium bg-indigo-50/80 text-indigo-600 border border-indigo-100/80">
                    <Users2 size={12} />
                    <span>å·²é‚€è¯·</span>
                    <span className="font-black tabular-nums">{flowStats?.invited || 0}</span>
                  </div>
                )}

                {/* åˆ†éš”çº¿ */}
                <div className="w-px h-5 bg-slate-200 mx-0.5" />

                {/* å·²é€šè¿‡ â€” å¯ç‚¹å‡»ç­›é€‰ */}
                <button
                  onClick={() => setQueueFilter(queueFilter === 'passed' ? null : 'passed')}
                  className={`group flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs font-bold transition-all duration-200 border ${
                    queueFilter === 'passed'
                      ? 'bg-emerald-500 text-white border-emerald-500 shadow-md shadow-emerald-500/20'
                      : 'bg-emerald-50/80 text-emerald-600 border-emerald-100/80 hover:bg-emerald-100/80 hover:border-emerald-200'
                  }`}
                >
                  <CheckCircle2 size={12} />
                  å·²é€šè¿‡
                  <span className={`tabular-nums ${queueFilter === 'passed' ? 'text-white/80' : 'text-emerald-500'}`}>{flowStats?.passed || 0}</span>
                </button>

                {/* è¿›è¡Œä¸­ â€” å¯ç‚¹å‡»ç­›é€‰ */}
                <button
                  onClick={() => setQueueFilter(queueFilter === 'pending' ? null : 'pending')}
                  className={`group flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs font-bold transition-all duration-200 border ${
                    queueFilter === 'pending'
                      ? 'bg-amber-500 text-white border-amber-500 shadow-md shadow-amber-500/20'
                      : 'bg-amber-50/80 text-amber-600 border-amber-100/80 hover:bg-amber-100/80 hover:border-amber-200'
                  }`}
                >
                  <Loader2 size={12} />
                  {isCandidate ? 'è¿›è¡Œä¸­' : 'ç­›é€‰ä¸­'}
                  <span className={`tabular-nums ${queueFilter === 'pending' ? 'text-white/80' : 'text-amber-500'}`}>{flowStats?.pending || 0}</span>
                </button>

                {/* æœªé€šè¿‡ â€” å¯ç‚¹å‡»ç­›é€‰ */}
                <button
                  onClick={() => setQueueFilter(queueFilter === 'rejected' ? null : 'rejected')}
                  className={`group flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs font-bold transition-all duration-200 border ${
                    queueFilter === 'rejected'
                      ? 'bg-red-500 text-white border-red-500 shadow-md shadow-red-500/20'
                      : 'bg-red-50/80 text-red-500 border-red-100/80 hover:bg-red-100/80 hover:border-red-200'
                  }`}
                >
                  <X size={12} />
                  æœªé€šè¿‡
                  <span className={`tabular-nums ${queueFilter === 'rejected' ? 'text-white/80' : 'text-red-400'}`}>{flowStats?.rejected || 0}</span>
                </button>

                {/* åˆ†éš”çº¿ */}
                <div className="w-px h-5 bg-slate-200 mx-0.5" />

                {/* å¹³å‡åŒ¹é… â€” çº¯å±•ç¤º */}
                <div className="flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium bg-slate-50 text-slate-600 border border-slate-200/80">
                  <Sparkles size={12} className="text-indigo-500" />
                  <span>åŒ¹é…åº¦</span>
                  <span className="font-black tabular-nums text-indigo-600">{flowStats?.avgMatch || 0}%</span>
                </div>
              </div>
            )}

            {flowsLoading ? (
              <div className="flex justify-center py-12"><Loader2 className="animate-spin text-indigo-600" size={32} /></div>
            ) : !isLoggedIn ? (
              <div className="flex flex-col items-center justify-center py-12 text-center">
                <Activity size={48} className="text-slate-200 mb-4" />
                <p className="text-slate-400 text-sm font-medium mb-2">è¯·å…ˆç™»å½•æŸ¥çœ‹æ•°æ®</p>
                <button onClick={() => navigate('/login')} className="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-500 transition-colors">ç«‹å³ç™»å½•</button>
              </div>
            ) : matchingData.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-12 text-center">
                <Activity size={48} className="text-slate-200 mb-4" />
                <p className="text-slate-400 text-sm font-medium mb-2">{isCandidate ? 'æš‚æ— æŠ•é€’è®°å½•' : 'æš‚æ— æ‹›è˜æµç¨‹'}</p>
                <p className="text-slate-300 text-xs">{isCandidate ? 'å‰å¾€ AI åŠ©æ‰‹å¼€å§‹æ™ºèƒ½æ±‚èŒæŠ•é€’' : 'å‰å¾€ AI åŠ©æ‰‹å¼€å§‹æ™ºèƒ½æ‹›è˜'}</p>
              </div>
            ) : (
            <div className="overflow-x-auto">
              <table className="w-full text-left min-w-[900px]">
                <thead>
                  <tr className="border-b border-slate-50 text-xs uppercase font-black tracking-widest text-slate-400">
                    <th className="pb-4 pl-2">{isCandidate ? 'ç›®æ ‡ä¼ä¸šä¸å²—ä½' : 'å€™é€‰äººä¸ç›®æ ‡å²—ä½'}</th>
                    <th className="pb-4 text-center">åŒ¹é…åº¦</th>
                    <th className="pb-4">è–ªèµ„èŒƒå›´</th>
                    <th className="pb-4">æµç¨‹è¿›åº¦</th>
                    <th className="pb-4">æœ€æ–°åŠ¨æ€</th>
                    <th className="pb-4 text-right pr-2">çŠ¶æ€</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-50">
                  {matchingData.length === 0 && (
                    <tr>
                      <td colSpan={7} className="py-12 text-center">
                        <div className="text-slate-400 text-sm">
                          {queueFilter ? (
                            <>
                              <span className="block mb-2">å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æš‚æ— æ•°æ®</span>
                              <button onClick={() => setQueueFilter(null)} className="text-indigo-500 hover:text-indigo-600 font-medium text-xs">
                                æ¸…é™¤ç­›é€‰æŸ¥çœ‹å…¨éƒ¨
                              </button>
                            </>
                          ) : 'æš‚æ— æŠ•é€’æ•°æ®'}
                        </div>
                      </td>
                    </tr>
                  )}
                  {matchingData.map((item: any) => (
                    <tr 
                      key={item.id} 
                      onClick={() => navigate(`/workbench/flow/${item.id}`)}
                      className="group hover:bg-slate-50/50 transition-colors cursor-pointer"
                    >
                      <td className="py-5 pl-2">
                        <div className="flex items-center gap-4">
                           {isCandidate ? (
                             <div className="w-10 h-10 rounded bg-slate-100 text-slate-600 flex items-center justify-center font-bold shadow-sm border border-slate-200">
                               {(item.company || '?').charAt(0)}
                             </div>
                           ) : (
                             <div className="w-10 h-10 rounded bg-indigo-600 text-white flex items-center justify-center font-bold shadow-lg ring-4 ring-indigo-50">
                               {(item.candidate || '?').charAt(0)}
                             </div>
                           )}
                           <div>
                             {isCandidate ? (
                               <>
                                 <div className="font-black text-slate-900 text-sm">{item.company}</div>
                                 <div className="text-xs font-bold text-indigo-600 mt-0.5 flex items-center gap-1">
                                   <Briefcase size={10} /> {item.job}
                                 </div>
                               </>
                             ) : (
                               <>
                                 <div className="font-black text-slate-900 text-sm">{item.candidate}</div>
                                 <div className="text-xs font-bold text-indigo-600 mt-0.5">{item.company}</div>
                                 <div className="text-xs text-slate-500 mt-0.5 flex items-center gap-1">
                                   <Briefcase size={10} /> {item.job}
                                 </div>
                               </>
                             )}
                           </div>
                        </div>
                      </td>
                      <td className="py-5">
                         <div className="flex flex-col items-center gap-1">
                           <div className={`px-3 py-1 rounded-full text-[11px] font-black shadow-sm ${item.matchScore >= 90 ? 'bg-indigo-600 text-white' : 'bg-indigo-50 text-indigo-600'}`}>
                             {item.matchScore}%
                           </div>
                         </div>
                      </td>
                      <td className="py-5">
                        <div className="text-sm font-bold text-slate-700">{item.salary}</div>
                      </td>
                      <td className="py-5">
                         <div className="flex items-center gap-1.5">
                            {(item.nodes || []).map((node: string, nIdx: number) => (
                              <div key={nIdx} className="flex items-center">
                                <div 
                                  className={`w-2 h-2 rounded-full transition-all duration-500 ${nIdx < item.currentStep ? 'bg-indigo-600' : 'bg-slate-200'}`}
                                  title={node}
                                ></div>
                                {nIdx < (item.nodes || []).length - 1 && (
                                  <div className={`w-3 h-0.5 ${nIdx < item.currentStep - 1 ? 'bg-indigo-600' : 'bg-slate-100'}`} />
                                )}
                              </div>
                            ))}
                            <span className="ml-2 text-xs font-bold text-slate-500">{(item.nodes || [])[Math.min(item.currentStep - 1, (item.nodes || []).length - 1)] || ''}</span>
                         </div>
                      </td>
                      <td className="py-5">
                         <div className="flex items-center gap-2 max-w-[220px]">
                            <Bot size={12} className="text-indigo-400 flex-shrink-0" />
                            <span className="text-xs text-slate-600 font-medium truncate" title={item.lastAction}>{item.lastAction}</span>
                         </div>
                      </td>
                      <td className="py-5 text-right pr-2">
                         <span className={`inline-block px-3 py-1 rounded-lg text-xs font-black ${item.statusColor}`}>
                           {item.status}
                         </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            )}
          </div>
        </div>
      </div>

    </div>
  );
};

// --- å¾…åŠäº‹é¡¹åˆ—è¡¨é¡µ ---
const TodoListView = () => {
  const navigate = useNavigate();
  const [filter, setFilter] = useState<'all' | 'user' | 'agent' | 'completed'>('all');
  
  const { user, isLoggedIn, userRole } = useAuth();
  const userId = user?.id || 0;
  
  // ä½¿ç”¨ API è·å–å¾…åŠäº‹é¡¹æ•°æ®ï¼ˆçº¯åŠ¨æ€æ•°æ®ï¼‰
  const { data: todosData, loading: todosLoading } = useTodos(userId);
  
  // æ ¹æ®ç”¨æˆ·è§’è‰²è¿‡æ»¤ä»»åŠ¡
  const allTodos = useMemo(() => {
    if (!todosData || todosData.length === 0) return [];
    const recruitKeywords = ['æ™ºèƒ½æ‹›è˜', 'ä¼ä¸šè®¤è¯', 'ä¼ä¸šèµ„æ–™', 'ç­›é€‰å€™é€‰äºº', 'å®‰æ’é¢è¯•', 'äººæ‰åˆ†æ'];
    const candidateKeywords = ['ä¸ªäººè®¤è¯', 'ç®€å†', 'æ±‚èŒ', 'èŒä½æ¨è'];
    return todosData.filter((todo: any) => {
      const todoType = (todo.todo_type || todo.type || '').toUpperCase();
      const title = todo.title || todo.task || '';
      if (userRole === 'candidate') {
        if (todoType === 'RECRUIT' || todoType === 'EMPLOYER') return false;
        if (recruitKeywords.some(kw => title.includes(kw))) return false;
      } else if (userRole === 'employer' || userRole === 'recruiter') {
        if (todoType === 'CANDIDATE') return false;
        if (candidateKeywords.some(kw => title.includes(kw))) return false;
      }
      return true;
    });
  }, [todosData, userRole]);
  
  const filteredTodos = useMemo(() => {
    if (filter === 'all') return allTodos;
    if (filter === 'completed') return allTodos.filter((todo: any) => (todo.progress || 0) === 100);
    return allTodos.filter((todo: any) => todo.source === filter);
  }, [filter, allTodos]);

  const stats = useMemo(() => ({
    total: allTodos.length,
    userCreated: allTodos.filter((t: any) => t.source === 'user').length,
    agentAssigned: allTodos.filter((t: any) => t.source === 'agent').length,
    completed: allTodos.filter((t: any) => (t.progress || 0) === 100).length,
  }), [allTodos]);

  return (
    <div className="py-6 px-6 md:py-8 md:px-8 max-w-7xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-500">
      <button onClick={() => navigate('/workbench')} className="flex items-center gap-2 text-slate-500 hover:text-indigo-600 mb-8 font-black transition-colors">
        <ChevronLeft size={20} /> è¿”å›
      </button>

      <div className="mb-10">
        <h1 className="text-xl md:text-3xl font-black text-slate-900 mb-2">ä»»åŠ¡ä¸­å¿ƒ</h1>
        <p className="text-slate-500 font-medium">ç®¡ç†æ‚¨æ‰€æœ‰çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬ Agent åˆ†å‘å’Œè‡ªè¡Œåˆ›å»ºçš„ä»»åŠ¡</p>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
        {[
          { key: 'all' as const, label: 'å…¨éƒ¨ä»»åŠ¡', count: stats.total, sub: `å…± ${stats.total} ä¸ª`, icon: ListTodo },
          { key: 'agent' as const, label: 'Agent åˆ†å‘', count: stats.agentAssigned, sub: 'ç³»ç»Ÿæ™ºèƒ½æ¨è', icon: Sparkles },
          { key: 'user' as const, label: 'æˆ‘åˆ›å»ºçš„', count: stats.userCreated, sub: 'æ‰‹åŠ¨æ·»åŠ ', icon: UserCircle2 },
          { key: 'completed' as const, label: 'å·²å®Œæˆ', count: stats.completed, sub: stats.total > 0 ? `å®Œæˆåº¦ ${Math.round(stats.completed / stats.total * 100)}%` : '0%', icon: CheckCircle2 },
        ].map((item) => {
          const isActive = filter === item.key;
          const ItemIcon = item.icon;
          return (
            <button
              key={item.key}
              onClick={() => setFilter(item.key)}
              className={`bg-white rounded p-5 border text-left transition-all cursor-pointer hover:shadow-md active:scale-[0.98] ${
                isActive ? 'border-indigo-300 bg-indigo-50/50 shadow-sm' : 'border-slate-100 hover:border-slate-200'
              }`}
            >
              <div className="flex items-center justify-between mb-2">
                <span className={`text-[11px] font-black uppercase tracking-widest ${isActive ? 'text-indigo-600' : 'text-slate-400'}`}>{item.label}</span>
                <ItemIcon size={16} className={isActive ? 'text-indigo-500' : 'text-slate-300'} />
              </div>
              <div className={`text-3xl font-black ${isActive ? 'text-indigo-600' : 'text-slate-900'}`}>{item.count}</div>
              <div className={`text-[11px] mt-1 ${isActive ? 'text-indigo-400' : 'text-slate-400'}`}>{item.sub}</div>
            </button>
          );
        })}
      </div>

      <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
        {todosLoading ? (
          <div className="col-span-2 flex items-center justify-center py-20">
            <Loader2 className="animate-spin text-indigo-600" size={32} />
          </div>
        ) : filteredTodos.map((todo: any) => {
          // è·å–å›¾æ ‡ç»„ä»¶
          const IconComponent = todo.icon === 'UserIcon' ? UserIcon : 
                               todo.icon === 'Building2' ? Building2 : Calendar;
          // å…¼å®¹é™æ€æ•°æ®çš„ task å­—æ®µå’ŒåŠ¨æ€æ•°æ®çš„ title å­—æ®µ
          const todoTitle = todo.title || todo.task;
          const priority = (todo.priority || 'medium').toLowerCase();
          const priorityDisplay = priority.charAt(0).toUpperCase() + priority.slice(1);
          
          return (
          <div 
            key={todo.id}
            onClick={() => navigate(`/workbench/todo/${todo.id}`)}
            className="group bg-white rounded p-6 border border-slate-100 shadow-lg hover:shadow-xl hover:border-indigo-200 cursor-pointer transition-all animate-in fade-in slide-in-from-bottom-4"
          >
            <div className="flex items-start justify-between mb-4">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 bg-indigo-50 rounded flex items-center justify-center text-indigo-600 border border-indigo-100 group-hover:bg-indigo-600 group-hover:text-white transition-all">
                  {typeof todo.icon === 'function' ? <todo.icon size={24} /> : <IconComponent size={24} />}
                </div>
                <div>
                  <h3 className="text-lg font-black text-slate-900 group-hover:text-indigo-600 transition-colors">{todoTitle}</h3>
                  <div className="flex items-center gap-2 mt-1">
                    <span className={`px-2 py-0.5 rounded-full text-xs font-black uppercase tracking-widest ${
                      priority === 'high' ? 'bg-rose-50 text-rose-600' : 
                      priority === 'medium' ? 'bg-amber-50 text-amber-600' : 'bg-indigo-50 text-indigo-600'
                    }`}>
                      {priorityDisplay}
                    </span>
                    <span className={`px-2 py-0.5 rounded-full text-xs font-black uppercase tracking-widest ${
                      todo.source === 'agent' ? 'bg-purple-50 text-purple-600' : 'bg-emerald-50 text-emerald-600'
                    }`}>
                      {todo.source === 'agent' ? 'Agent' : 'æˆ‘åˆ›å»º'}
                    </span>
                    <span className="text-xs font-medium text-slate-400">
                      {todo.type === 'candidate' ? 'äººæ‰ç«¯' : todo.type === 'employer' ? 'ä¼ä¸šç«¯' : 'ç³»ç»Ÿ'}
                    </span>
                  </div>
                </div>
              </div>
              <div className="text-right">
                <div className="text-2xl font-black text-indigo-600">{todo.progress || 0}%</div>
                <div className="text-xs font-bold text-slate-400">å®Œæˆåº¦</div>
              </div>
            </div>
            
            <p className="text-sm text-slate-500 leading-relaxed font-medium mb-4 line-clamp-2">{todo.description}</p>
            
            <div className="flex items-center justify-between pt-4 border-t border-slate-50">
              <div className="flex items-center gap-4 text-xs text-slate-400">
                <span className="flex items-center gap-1">
                  <Calendar size={12} />
                  {todo.dueDate ? `æˆªæ­¢: ${todo.dueDate}` : todo.createdAt}
                </span>
              </div>
              <div className="flex items-center gap-2 text-xs font-black text-indigo-600 group-hover:translate-x-1 transition-transform">
                æŸ¥çœ‹è¯¦æƒ… <ArrowRight size={14} />
              </div>
            </div>
          </div>
        )})}
      </div>

      {filteredTodos.length === 0 && (
        <div className="text-center py-20">
          <div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <CheckCircle2 size={40} className="text-slate-300" />
          </div>
          <h3 className="text-xl font-black text-slate-900 mb-2">æš‚æ— ä»»åŠ¡</h3>
          <p className="text-slate-500 font-medium">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å¾…åŠäº‹é¡¹</p>
        </div>
      )}
    </div>
  );
};

// --- å¾…åŠè¯¦æƒ…é¡µï¼ˆé‡å®šå‘åˆ° AI åŠ©æ‰‹ï¼‰ ---
const TodoDetailView = () => {
  const { todoId } = useParams();
  const navigate = useNavigate();
  
  useEffect(() => {
    // é‡å®šå‘åˆ° AI åŠ©æ‰‹é¡µé¢å¹¶å¸¦ä¸Šä»»åŠ¡ ID å‚æ•°
    navigate(`/ai-assistant?taskId=${todoId}`, { replace: true });
  }, [todoId, navigate]);
  
  return (
    <div className="pt-20 text-center">
      <Loader2 className="mx-auto text-indigo-600 animate-spin mb-4" size={48} />
      <p className="text-slate-500">æ­£åœ¨è·³è½¬åˆ° AI åŠ©æ‰‹...</p>
    </div>
  );
};

// --- AI å¯¹æ¥æµç¨‹è¯¦æƒ…é¡µ ---
const FlowDetailView = () => {
  const { flowId } = useParams();
  const navigate = useNavigate();
  const { data: flow, loading } = useFlow(flowId ? parseInt(flowId) : null);
  const [talent, setTalent] = useState<any>(null);
  const [talentLoading, setTalentLoading] = useState(false);

  // å½“ flow åŠ è½½å®Œæˆåï¼Œè·å–å…³è”å€™é€‰äººçš„è¯¦ç»†ç”»åƒ
  useEffect(() => {
    if (!flow?.candidateId) return;
    setTalentLoading(true);
    fetch(`/api/v1/public/talents/${flow.candidateId}`)
      .then(r => r.ok ? r.json() : null)
      .then(d => setTalent(d))
      .catch(() => {})
      .finally(() => setTalentLoading(false));
  }, [flow?.candidateId]);

  const stageNameMap: Record<string, string> = {
    parse: 'ç®€å†è§£æ', benchmark: 'æ™ºèƒ½ç­›é€‰', first_interview: 'AI åˆè¯•',
    second_interview: 'å¤è¯•é˜¶æ®µ', final: 'åŒæ–¹é€šè¿‡',
  };
  const statusNameMap: Record<string, { text: string; color: string }> = {
    pending: { text: 'ç­‰å¾…ä¸­', color: 'bg-slate-100 text-slate-600' },
    screening: { text: 'ç­›é€‰ä¸­', color: 'bg-blue-50 text-blue-600' },
    evaluating: { text: 'è¯„ä¼°ä¸­', color: 'bg-amber-50 text-amber-600' },
    interview: { text: 'é¢è¯•ä¸­', color: 'bg-indigo-50 text-indigo-600' },
    passed: { text: 'å·²é€šè¿‡', color: 'bg-emerald-50 text-emerald-600' },
    rejected: { text: 'æœªé€šè¿‡', color: 'bg-red-50 text-red-600' },
    completed: { text: 'å·²å®Œæˆ', color: 'bg-emerald-50 text-emerald-600' },
    active: { text: 'è¿›è¡Œä¸­', color: 'bg-blue-50 text-blue-600' },
  };
  const defaultNodes = ['é‚€è¯·', 'åŒ¹é…', 'ç­›é€‰', 'é¢è¯•', 'ç»“æœ'];

  if (loading) return (
    <div className="pt-20 text-center">
      <Loader2 className="mx-auto animate-spin text-indigo-600 mb-4" size={32} />
      <p className="text-slate-500 font-medium">åŠ è½½ä¸­...</p>
    </div>
  );

  if (!flow) return (
    <div className="pt-20 text-center">
      <AlertCircle className="mx-auto text-slate-300 mb-4" size={64} />
      <p className="text-slate-500 font-black">å¯¹æ¥ä»»åŠ¡ä¸å­˜åœ¨</p>
      <button onClick={() => navigate('/workbench')} className="mt-8 bg-indigo-600 text-white px-8 py-3 rounded font-black">è¿”å›å·¥ä½œå°</button>
    </div>
  );

  const nodes = flow.nodes?.length > 0 ? flow.nodes : defaultNodes;
  const currentStep = flow.currentStep || 0;
  const statusInfo = statusNameMap[flow.status] || { text: flow.status, color: 'bg-slate-100 text-slate-600' };
  const timeline = flow.timeline || [];
  const agents = flow.agentsUsed?.length > 0 ? flow.agentsUsed : ['AI æ™ºèƒ½ä½“'];

  return (
    <div className="py-6 px-6 md:py-8 md:px-8 max-w-7xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-500">
      <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-slate-500 hover:text-indigo-600 mb-8 font-black transition-colors group">
        <ChevronLeft size={20} className="group-hover:-translate-x-1 transition-transform" /> è¿”å›
      </button>

      {/* å¤´éƒ¨ä¿¡æ¯ â€” å€™é€‰äºº + æµç¨‹çŠ¶æ€ */}
      <div className="bg-white rounded-lg p-8 border border-slate-100 shadow-sm mb-8">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-6">
          <div className="flex items-center gap-5">
            <div
              onClick={() => flow.candidateId && navigate(`/candidate/profile/${flow.candidateId}`)}
              className="w-16 h-16 bg-indigo-600 text-white flex items-center justify-center text-2xl font-black rounded-lg shadow-lg ring-4 ring-indigo-50 cursor-pointer hover:ring-indigo-200 transition-all"
            >
              {(talent?.name || flow.candidateName || '?').charAt(0)}
            </div>
            <div>
              <h1
                onClick={() => flow.candidateId && navigate(`/candidate/profile/${flow.candidateId}`)}
                className="text-2xl font-black text-slate-900 cursor-pointer hover:text-indigo-600 transition-colors"
              >{talent?.name || flow.candidateName}</h1>
              <p className="text-sm text-slate-500 font-medium">
                {talent?.role || flow.role}{talent?.experienceYears ? ` Â· ${talent.experienceYears} å¹´ç»éªŒ` : ''} Â· {flow.company}
              </p>
              {talent?.skills && talent.skills.length > 0 && (
                <div className="flex flex-wrap gap-1.5 mt-2">
                  {talent.skills.slice(0, 6).map((s: string, i: number) => (
                    <span key={i} className="px-2 py-0.5 bg-slate-50 text-slate-500 text-[10px] font-bold rounded border border-slate-100">{s}</span>
                  ))}
                </div>
              )}
            </div>
          </div>
          <div className="flex flex-wrap items-center gap-3">
            <span className={`px-3 py-1.5 rounded-lg text-xs font-black ${statusInfo.color}`}>{statusInfo.text}</span>
            <span className="text-sm text-slate-500 font-medium flex items-center gap-1">
              <Clock size={14} /> {stageNameMap[flow.stage] || flow.stage}
            </span>
            {flow.matchScore > 0 && (
              <span className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-black flex items-center gap-1">
                <Target size={12} /> {flow.matchScore}% åŒ¹é…
              </span>
            )}
            {flow.salary && (
              <span className="text-sm text-slate-500 flex items-center gap-1"><CircleDollarSign size={14} className="text-emerald-500" /> {flow.salary}</span>
            )}
          </div>
        </div>
      </div>

      {/* åŒ¹é…å²—ä½ä¿¡æ¯ */}
      <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm mb-8">
        <h3 className="text-sm font-black text-slate-900 mb-4 flex items-center gap-2">
          <Briefcase size={16} className="text-indigo-600" /> åŒ¹é…å²—ä½
        </h3>
        <div
          onClick={() => flow.jobId && navigate(`/candidate/job/${flow.jobId}`)}
          className="flex items-center gap-4 p-4 bg-slate-50 rounded-lg border border-slate-100 cursor-pointer hover:border-indigo-200 hover:bg-indigo-50/30 transition-all group"
        >
          <div className="w-12 h-12 bg-white rounded-lg border border-slate-200 flex items-center justify-center shrink-0 shadow-sm overflow-hidden">
            {flow.jobLogo ? (
              <img src={flow.jobLogo} alt="" className="w-full h-full object-cover" />
            ) : (
              <Building2 size={20} className="text-slate-400" />
            )}
          </div>
          <div className="flex-1 min-w-0">
            <p className="text-base font-black text-slate-900 group-hover:text-indigo-600 transition-colors truncate">{flow.role}</p>
            <p className="text-sm text-slate-500 font-medium flex items-center gap-2 mt-0.5">
              <span>{flow.company}</span>
              {flow.jobLocation && <><span className="text-slate-300">Â·</span><span className="flex items-center gap-1"><MapPin size={12} />{flow.jobLocation}</span></>}
              {flow.salary && <><span className="text-slate-300">Â·</span><span className="flex items-center gap-1"><CircleDollarSign size={12} className="text-emerald-500" />{flow.salary}</span></>}
            </p>
          </div>
          <ChevronRight size={18} className="text-slate-300 group-hover:text-indigo-400 transition-colors shrink-0" />
        </div>
      </div>

      {/* é˜¶æ®µè¿›åº¦ */}
      <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm mb-8">
        <h3 className="text-sm font-black text-slate-900 mb-5 flex items-center gap-2">
          <Clock size={16} className="text-indigo-600" /> é˜¶æ®µè¿›åº¦
        </h3>
        <div className="flex items-center gap-2 overflow-x-auto pb-2">
          {nodes.map((node: string, idx: number) => (
            <div key={idx} className="flex items-center shrink-0">
              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-black transition-all duration-500 ${
                idx < currentStep ? 'bg-indigo-600 text-white' : 
                idx === currentStep ? 'bg-amber-500 text-white animate-pulse' : 'bg-slate-100 text-slate-400'
              }`}>
                {idx < currentStep ? <CheckCircle2 size={14} /> : idx + 1}
              </div>
              {idx < nodes.length - 1 && (
                <div className={`w-10 h-1 rounded ${idx < currentStep ? 'bg-indigo-600' : 'bg-slate-100'}`}></div>
              )}
            </div>
          ))}
        </div>
        <div className="flex gap-2 mt-3 overflow-x-auto">
          {nodes.map((node: string, idx: number) => (
            <span key={idx} className={`px-3 py-1 rounded text-xs font-bold shrink-0 ${
              idx < currentStep ? 'bg-indigo-50 text-indigo-600' : 
              idx === currentStep ? 'bg-amber-50 text-amber-600' : 'bg-slate-50 text-slate-400'
            }`}>
              {node}
            </span>
          ))}
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
        {/* å·¦ä¾§ä¸»å†…å®¹ */}
        <div className="lg:col-span-8 space-y-8">
          {/* AI æ™ºèƒ½ç”»åƒç»¼è¿° */}
          {talent?.summary && (
            <div className="bg-indigo-50 rounded-lg p-6 border border-indigo-100 shadow-sm relative overflow-hidden">
              <Sparkles className="absolute -right-4 -bottom-4 w-28 h-28 text-indigo-200" />
              <h3 className="text-sm font-black text-indigo-900 mb-3 flex items-center gap-2 relative z-10">
                <Bot size={16} className="text-indigo-600" /> AI æ™ºèƒ½ç”»åƒç»¼è¿°
              </h3>
              <p className="text-sm leading-relaxed text-indigo-800 font-medium relative z-10">"{talent.summary}"</p>
              <div className="mt-4 pt-3 border-t border-indigo-200 flex flex-wrap gap-5 relative z-10">
                {talent.salaryRange && (
                  <div>
                    <div className="text-[10px] font-bold text-indigo-400 uppercase mb-0.5">æœŸæœ›è–ªèµ„</div>
                    <div className="text-xs font-black text-indigo-700">{talent.salaryRange}</div>
                  </div>
                )}
                {talent.idealJobPersona && (
                  <div>
                    <div className="text-[10px] font-bold text-indigo-400 uppercase mb-0.5">ç†æƒ³å²—ä½</div>
                    <div className="text-xs font-black text-indigo-700 max-w-xs truncate">{talent.idealJobPersona}</div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* æ‰§è¡Œæ—¶é—´çº¿ */}
          {timeline.length > 0 && (
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h3 className="text-sm font-black text-slate-900 mb-4 flex items-center gap-2">
                <GitBranch size={16} className="text-indigo-600" /> æ‰§è¡Œæ—¶é—´çº¿
              </h3>
              <div className="space-y-4">
                {timeline.map((item: any, idx: number) => (
                  <div key={idx} className="flex items-start gap-4 relative">
                    {idx < timeline.length - 1 && (
                      <div className="absolute left-[7px] top-8 w-0.5 h-full bg-slate-100"></div>
                    )}
                    <div className="w-4 h-4 rounded-full bg-indigo-600 shrink-0 mt-1 relative z-10"></div>
                    <div className="flex-1 pb-4">
                      <div className="flex items-center justify-between mb-1">
                        <span className="text-sm font-bold text-slate-900">{item.action}</span>
                        <span className="text-xs text-slate-400">{item.time ? parseUTC(item.time).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : ''}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        {item.agent && <span className="text-xs text-indigo-600 font-medium">{item.agent}</span>}
                        {item.tokens > 0 && <span className="text-xs text-slate-400 bg-slate-50 px-2 py-0.5 rounded">{item.tokens.toLocaleString()} tokens</span>}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* æ— æ—¶é—´çº¿æ—¶çš„æç¤º */}
          {timeline.length === 0 && (
            <div className="bg-white rounded-lg p-8 border border-slate-100 shadow-sm text-center">
              <GitBranch size={32} className="mx-auto text-slate-300 mb-3" />
              <p className="text-sm text-slate-400 font-medium">æš‚æ— æ‰§è¡Œè®°å½•ï¼Œæµç¨‹æ¨è¿›åå°†åœ¨æ­¤å±•ç¤º</p>
            </div>
          )}

        </div>

        {/* å³ä¾§è¾¹æ  */}
        <div className="lg:col-span-4 space-y-6">
          {/* èƒ½åŠ›é›·è¾¾å›¾ */}
          {talent?.radarData && talent.radarData.length > 0 && (
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h3 className="text-sm font-black text-slate-900 mb-4 flex items-center gap-2">
                <BarChart3 size={16} className="text-indigo-600" /> æ ¸å¿ƒç«äº‰åŠ›
              </h3>
              <RadarChart data={talent.radarData} />
            </div>
          )}

          {/* èµ„æºæ¶ˆè€— */}
          <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
            <h3 className="text-sm font-black text-slate-900 mb-4 flex items-center gap-2">
              <Cpu size={16} className="text-indigo-600" /> èµ„æºæ¶ˆè€—
            </h3>
            <div className="text-center py-4">
              <div className="text-2xl md:text-4xl font-black text-indigo-600">{(flow.tokensConsumed || 0).toLocaleString()}</div>
              <div className="text-xs text-slate-400 font-bold uppercase tracking-wider mt-1">Total Tokens</div>
            </div>
          </div>

          {/* å‚ä¸æ™ºèƒ½ä½“ */}
          <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
            <h3 className="text-sm font-black text-slate-900 mb-4 flex items-center gap-2">
              <Bot size={16} className="text-indigo-600" /> å‚ä¸æ™ºèƒ½ä½“
            </h3>
            <div className="space-y-2">
              {agents.map((agent: string, idx: number) => (
                <div key={idx} className="flex items-center gap-3 p-2 bg-slate-50 rounded-lg">
                  <div className="w-8 h-8 bg-indigo-100 rounded flex items-center justify-center text-indigo-600">
                    <Bot size={14} />
                  </div>
                  <span className="text-sm font-medium text-slate-700">{agent}</span>
                </div>
              ))}
            </div>
          </div>

        </div>
      </div>
    </div>
  );
};

// --- å…³äºæˆ‘ä»¬é¡µé¢ ---
const AboutUsView = () => (
  <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 max-w-5xl mx-auto">
    {/* é¡µé¢å¤´éƒ¨ */}
    <div className="mb-10 px-8 md:px-12">
      <div className="text-center mb-6">
        <div className="inline-flex items-center gap-2 bg-indigo-50 text-indigo-600 px-4 py-2 rounded-full text-sm font-bold border border-indigo-100">
          <Info size={16} /> å…³äº Devnors å¾—è‹¥
        </div>
      </div>
      <h1 className="text-xl md:text-2xl font-black text-slate-800 mb-3 tracking-tight text-center">å…¨åœºæ™¯AIåŸç”Ÿæ™ºèƒ½æ‹›è˜å¹³å°</h1>
      <p className="text-base text-slate-600 font-medium leading-relaxed">
        <span className="text-indigo-500 font-bold">å¾—è‹¥ Devnors Hire Agent</span> â€” æˆ‘ä»¬é€šè¿‡é«˜æ•ˆçš„AIåŒ¹é…ç³»ç»Ÿï¼Œä¸ºä¼ä¸šç²¾å‡†æ¨èå…¨çƒç²¾è‹±ï¼ŒåŠ©åŠ›äººæ‰å®ç°èŒä¸šæ¢¦æƒ³ã€‚å¾—è‹¥ï¼Œæ‰¾åˆ°ä½ çš„æ­æ¡£ï¼Œè®©æ¯ä¸€æ¬¡é€‰æ‹©åŒ¹é…éƒ½æˆä¸ºæœºé‡ã€‚
      </p>
    </div>

    {/* ä½¿å‘½ä¸æ„¿æ™¯ */}
    <div className="bg-slate-50 rounded-lg p-8 md:p-12 border border-slate-100 relative overflow-hidden mb-10">
      <div className="absolute top-0 right-0 p-24 opacity-5">
        <Zap size={160} className="text-indigo-600" />
      </div>
      <div className="relative z-10">
        <h2 className="text-xl font-black text-slate-900 mb-4 flex items-center gap-3">
          <Sparkles size={22} className="text-indigo-600" /> ä½¿å‘½ä¸æ„¿æ™¯
        </h2>
        <p className="text-base text-slate-600 leading-relaxed font-medium">
          å¾—è‹¥ Devnors Multiâ€‘Agent Synergy å¤šæ™ºèƒ½ä½“ååŒç³»ç»Ÿï¼Œä»¥AIå¤šæ™ºèƒ½ä½“ååŒæŠ€æœ¯ä¸ºæ ¸å¿ƒï¼Œè‡´åŠ›äºä¸ºä¸ªäººæä¾›èŒä¸šå‘å±•ã€ç”Ÿæ´»æœåŠ¡ã€å©šæ‹ç¤¾äº¤ã€å¿ƒç†é™ªä¼´ç­‰å…¨åŸŸæ™ºèƒ½æœåŠ¡ï¼Œå¹¶ä¸ºä¼ä¸šæ‰“é€ æ‹›è˜ã€äººäº‹ã€è´¢åŠ¡ã€ç¨åŠ¡ã€æ³•å¾‹ã€é”€å”®ã€å®¢æœç­‰ä¸€ä½“åŒ–å…¨æ ˆæ™ºèƒ½ Agent è§£å†³æ–¹æ¡ˆã€‚
        </p>
      </div>
    </div>

    {/* æ ¸å¿ƒèƒ½åŠ› */}
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
      <div className="bg-white rounded-lg p-8 border border-slate-100 shadow-lg hover:shadow-xl transition-all group">
        <div className="w-14 h-14 bg-indigo-50 rounded-lg flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
          <Brain size={28} className="text-indigo-600" />
        </div>
        <h3 className="text-lg font-black text-slate-900 mb-2">AI æ™ºèƒ½åŒ¹é…</h3>
        <p className="text-sm text-slate-500 font-medium leading-relaxed">åŸºäºæ·±åº¦å­¦ä¹ ç®—æ³•ï¼Œå®ç°äººæ‰ä¸å²—ä½çš„ç²¾å‡†åŒ¹é…ï¼Œæå‡æ‹›è˜æ•ˆç‡ã€‚</p>
      </div>
      <div className="bg-white rounded-lg p-8 border border-slate-100 shadow-lg hover:shadow-xl transition-all group">
        <div className="w-14 h-14 bg-emerald-50 rounded-lg flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
          <Globe size={28} className="text-emerald-600" />
        </div>
        <h3 className="text-lg font-black text-slate-900 mb-2">å…¨çƒåŒ–è§†é‡</h3>
        <p className="text-sm text-slate-500 font-medium leading-relaxed">æ‰“ç ´åœ°åŸŸé™åˆ¶ï¼Œè®©ä¼˜ç§€äººæ‰ä¸ä¼ä¸šå®ç°æ— å›½ç•Œå¯¹æ¥ã€‚</p>
      </div>
      <div className="bg-white rounded-lg p-8 border border-slate-100 shadow-lg hover:shadow-xl transition-all group">
        <div className="w-14 h-14 bg-amber-50 rounded-lg flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
          <Users size={28} className="text-amber-600" />
        </div>
        <h3 className="text-lg font-black text-slate-900 mb-2">å¤šæ™ºèƒ½ä½“åä½œ</h3>
        <p className="text-sm text-slate-500 font-medium leading-relaxed">å¤šä¸ª AI æ™ºèƒ½ä½“ååŒå·¥ä½œï¼Œå…¨æ–¹ä½æœåŠ¡æ‹›è˜å…¨æµç¨‹ã€‚</p>
      </div>
    </div>

    {/* æ ¸å¿ƒä»·å€¼è§‚ */}
    <div className="bg-white rounded-lg p-8 md:p-10 border border-slate-100 shadow-lg mb-10">
      <h3 className="text-xl font-black text-slate-900 mb-6 flex items-center gap-3">
        <Award size={22} className="text-amber-500" /> æ ¸å¿ƒä»·å€¼è§‚
      </h3>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
        <div className="flex items-start gap-4 p-5 bg-slate-50 rounded-lg">
          <div className="w-11 h-11 bg-indigo-50 rounded-lg flex items-center justify-center flex-shrink-0">
            <CheckCircle2 size={22} className="text-indigo-600" />
          </div>
          <div>
            <h4 className="text-base font-black text-slate-900 mb-1">æŠ€æœ¯åˆ›æ–°</h4>
            <p className="text-slate-500 font-medium text-sm">æŒç»­æŠ•å…¥ AI æŠ€æœ¯ç ”å‘ï¼Œä¿æŒè¡Œä¸šé¢†å…ˆåœ°ä½</p>
          </div>
        </div>
        <div className="flex items-start gap-4 p-5 bg-slate-50 rounded-lg">
          <div className="w-11 h-11 bg-emerald-50 rounded-lg flex items-center justify-center flex-shrink-0">
            <Heart size={22} className="text-emerald-600" />
          </div>
          <div>
            <h4 className="text-base font-black text-slate-900 mb-1">ç”¨æˆ·ä½“éªŒ</h4>
            <p className="text-slate-500 font-medium text-sm">ä»¥ç”¨æˆ·ä¸ºä¸­å¿ƒï¼Œæ‰“é€ æè‡´çš„æ‹›è˜æ±‚èŒä½“éªŒ</p>
          </div>
        </div>
        <div className="flex items-start gap-4 p-5 bg-slate-50 rounded-lg">
          <div className="w-11 h-11 bg-amber-50 rounded-lg flex items-center justify-center flex-shrink-0">
            <ShieldCheck size={22} className="text-amber-600" />
          </div>
          <div>
            <h4 className="text-base font-black text-slate-900 mb-1">æ•°æ®å®‰å…¨</h4>
            <p className="text-slate-500 font-medium text-sm">ä¸¥æ ¼ä¿æŠ¤ç”¨æˆ·éšç§ï¼Œç¡®ä¿æ•°æ®å®‰å…¨å¯é </p>
          </div>
        </div>
        <div className="flex items-start gap-4 p-5 bg-slate-50 rounded-lg">
          <div className="w-11 h-11 bg-rose-50 rounded-lg flex items-center justify-center flex-shrink-0">
            <TrendingUp size={22} className="text-rose-600" />
          </div>
          <div>
            <h4 className="text-base font-black text-slate-900 mb-1">æŒç»­æˆé•¿</h4>
            <p className="text-slate-500 font-medium text-sm">å¸®åŠ©æ¯ä¸€ä½ç”¨æˆ·åœ¨èŒä¸šé“è·¯ä¸Šä¸æ–­è¿›æ­¥</p>
          </div>
        </div>
      </div>
    </div>

    {/* è”ç³»æˆ‘ä»¬ */}
    <div className="bg-white rounded-lg p-8 md:p-10 border border-slate-100 shadow-lg">
      <h3 className="text-xl font-black text-slate-900 mb-6 flex items-center gap-3">
        <Mail size={22} className="text-indigo-500" /> è”ç³»æˆ‘ä»¬
      </h3>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
        <a href="mailto:admin@tvey.com" className="flex items-center gap-4 p-5 bg-slate-50 rounded-lg hover:bg-indigo-50 transition-all group">
          <div className="w-11 h-11 bg-indigo-100 rounded-lg flex items-center justify-center group-hover:bg-indigo-200 transition-colors">
            <Mail size={22} className="text-indigo-600" />
          </div>
          <div>
            <h4 className="text-sm font-black text-slate-900">å•†åŠ¡åˆä½œ</h4>
            <p className="text-xs text-slate-500">admin@tvey.com</p>
          </div>
        </a>
        <div className="flex items-center gap-4 p-5 bg-slate-50 rounded-lg hover:bg-amber-50 transition-all group">
          <div className="w-11 h-11 bg-amber-100 rounded-lg flex items-center justify-center group-hover:bg-amber-200 transition-colors">
            <MapPin size={22} className="text-amber-600" />
          </div>
          <div>
            <h4 className="text-sm font-black text-slate-900">å…¬å¸åœ°å€</h4>
            <p className="text-xs text-slate-500">ä¸­å›½æµ™æ±Ÿæ­å·</p>
          </div>
        </div>
        <Link to="/feedback" className="flex items-center gap-4 p-5 bg-slate-50 rounded-lg hover:bg-rose-50 transition-all group">
          <div className="w-11 h-11 bg-rose-100 rounded-lg flex items-center justify-center group-hover:bg-rose-200 transition-colors">
            <MessageCircle size={22} className="text-rose-600" />
          </div>
          <div>
            <h4 className="text-sm font-black text-slate-900">åœ¨çº¿å®¢æœ</h4>
            <p className="text-xs text-slate-500">å·¥å•åœ¨çº¿æœåŠ¡</p>
          </div>
        </Link>
      </div>
    </div>
  </div>
);

// ============ éç™»å½•çŠ¶æ€å±•ç¤ºé¡µé¢ ============

// --- äº§å“é¡µé¢ (Hire Agent æ ¸å¿ƒäº§å“) ---
const ProductsPage = () => {
  const navigate = useNavigate();
  const { isLoggedIn, userRole } = useAuth();

  // å¤„ç†éœ€è¦ç™»å½•çš„æ“ä½œ
  const handleAuthAction = (targetPath: string, defaultRole?: 'candidate' | 'employer') => {
    if (isLoggedIn) {
      // å·²ç™»å½•ï¼Œæ ¹æ®è§’è‰²è·³è½¬åˆ°å¯¹åº”é¡µé¢
      if (targetPath === '/ai-assistant') {
        navigate('/ai-assistant');
      } else if (userRole === 'employer' || userRole === 'recruiter' || userRole === 'admin') {
        navigate('/employer');
      } else {
        navigate('/candidate');
      }
    } else {
      // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢å¹¶è®°å½•ç›®æ ‡
      const roleParam = defaultRole ? `?role=${defaultRole}` : '';
      navigate(`/login${roleParam}`, { state: { from: targetPath } });
    }
  };

  const coreFeatures = [
    {
      category: 'Hire',
      title: 'æ™ºèƒ½æ‹›è˜',
      description: 'ä»èŒä½å‘å¸ƒåˆ°äººæ‰è·å–ï¼ŒAI å…¨ç¨‹èµ‹èƒ½',
      icon: Briefcase,
      color: 'from-indigo-500 to-violet-500',
      features: [
        { icon: FileText, name: 'JD æ™ºèƒ½ç”Ÿæˆ', desc: 'è¾“å…¥æ‹›è˜éœ€æ±‚ï¼ŒAI ç§’çº§ç”Ÿæˆä¸“ä¸šèŒä½æè¿°' },
        { icon: Target, name: 'äººæ‰ç²¾å‡†åŒ¹é…', desc: 'è¯­ä¹‰çº§åŒ¹é…ç®—æ³•ï¼Œæ‰¾åˆ°æœ€å¥‘åˆçš„äººæ‰' },
        { icon: Search, name: 'ä¸»åŠ¨äººæ‰è§¦è¾¾', desc: 'æ™ºèƒ½ç­›é€‰å¹¶ä¸»åŠ¨è”ç³»åŒ¹é…å€™é€‰äºº' },
        { icon: Users, name: 'äººæ‰åº“æ²‰æ·€', desc: 'æ„å»ºä¼ä¸šä¸“å±äººæ‰æ± ï¼ŒæŒç»­å¤ç”¨' },
      ]
    },
    {
      category: 'Interview',
      title: 'æ™ºèƒ½é¢è¯•',
      description: 'ä»é¢è¯•å‡†å¤‡åˆ°è¯„ä¼°åé¦ˆï¼Œæå‡æ¯ä¸€åœºé¢è¯•æ•ˆç‡',
      icon: MessageSquare,
      color: 'from-emerald-500 to-teal-500',
      features: [
        { icon: Bot, name: 'AI æ¨¡æ‹Ÿé¢è¯•', desc: 'é’ˆå¯¹å²—ä½è¿›è¡Œå…¨çœŸæ¨¡æ‹Ÿè®­ç»ƒ' },
        { icon: ClipboardCheck, name: 'é¢è¯•è¯„ä¼°æŠ¥å‘Š', desc: 'å¤šç»´åº¦è¯„ä¼°ï¼Œç”Ÿæˆç»“æ„åŒ–æŠ¥å‘Š' },
        { icon: Brain, name: 'æ™ºèƒ½é—®é¢˜æ¨è', desc: 'æ ¹æ®å²—ä½æ™ºèƒ½æ¨èé¢è¯•é—®é¢˜' },
        { icon: TrendingUp, name: 'é¢è¯•æ•°æ®æ´å¯Ÿ', desc: 'åˆ†æé€šè¿‡ç‡ï¼Œä¼˜åŒ–é¢è¯•æµç¨‹' },
      ]
    }
  ];

  const upcomingProducts = [
    { name: 'Onboard Agent', desc: 'å…¥èŒæµç¨‹è‡ªåŠ¨åŒ–', icon: ArrowRightCircle, status: 'è§„åˆ’ä¸­' },
    { name: 'Grow Agent', desc: 'äººæ‰å‘å±•ä¸åŸ¹è®­', icon: TrendingUp, status: 'è§„åˆ’ä¸­' },
    { name: 'Engage Agent', desc: 'å‘˜å·¥æ•¬ä¸šåº¦ç®¡ç†', icon: Heart, status: 'è§„åˆ’ä¸­' },
  ];

  const stats = [
    { value: '-60%', label: 'æ‹›è˜å‘¨æœŸ' },
    { value: '10x', label: 'ç­›é€‰æ•ˆç‡' },
    { value: '95%+', label: 'åŒ¹é…å‡†ç¡®ç‡' },
    { value: '98%', label: 'ç”¨æˆ·æ»¡æ„åº¦' },
  ];

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-white">
      {/* Hero Section */}
      <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6">
        <div className="max-w-5xl mx-auto text-center">
          <div className="inline-flex items-center gap-2 bg-indigo-50 text-indigo-600 px-4 py-2 rounded-full text-sm font-bold mb-8">
            <Bot size={16} /> AI åŸç”Ÿæ‹›è˜äº§å“
          </div>
          <h1 className="text-3xl md:text-5xl lg:text-6xl font-black text-slate-900 mb-4 md:mb-6 tracking-tight">
            <span className="text-indigo-600">Hire Agent</span>
            <br />è¦†ç›–æ‹›è˜å…¨æµç¨‹
          </h1>
          <p className="text-xl text-slate-500 max-w-2xl mx-auto leading-relaxed mb-12">
            Hire Agent æ˜¯ Devnors çš„æ ¸å¿ƒäº§å“ï¼Œé›†æˆæ™ºèƒ½æ‹›è˜ï¼ˆHireï¼‰å’Œæ™ºèƒ½é¢è¯•ï¼ˆInterviewï¼‰
            ä¸¤å¤§æ ¸å¿ƒèƒ½åŠ›ï¼Œç«¯åˆ°ç«¯è¦†ç›–æ‹›è˜å…¨æµç¨‹ã€‚æœªæ¥å°†æŒç»­æ¨å‡ºæ›´å¤š Agent äº§å“ã€‚
          </p>
          
          {/* Stats */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-3xl mx-auto">
            {stats.map((stat, i) => (
              <div key={i} className="bg-white rounded-lg p-6 shadow-sm border border-slate-100">
                <AnimatedStatItem value={stat.value} label={stat.label} color="text-indigo-600" delay={i * 100} size="large" />
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Core Features */}
      <div className="max-w-7xl mx-auto px-4 md:px-6 pb-12 md:pb-20">
        <div className="text-center mb-16">
          <h2 className="text-3xl font-black text-slate-900 mb-4">æ ¸å¿ƒèƒ½åŠ›</h2>
          <p className="text-slate-500">Hire Agent çš„ä¸¤å¤§æ ¸å¿ƒæ¨¡å—</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {coreFeatures.map((module, idx) => (
            <div key={idx} className="bg-white rounded-3xl border border-slate-200 overflow-hidden hover:shadow-xl transition-all">
              <div className={`bg-gradient-to-r ${module.color} px-8 py-6`}>
                <div className="flex items-center gap-4">
                  <div className="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center">
                    <module.icon size={28} className="text-white" />
                  </div>
                  <div>
                    <div className="text-white/70 text-sm font-bold">{module.category}</div>
                    <h3 className="text-2xl font-black text-white">{module.title}</h3>
                  </div>
                </div>
                <p className="text-white/80 mt-3">{module.description}</p>
              </div>
              <div className="p-8">
                <div className="space-y-4">
                  {module.features.map((feature, i) => (
                    <div key={i} className="flex gap-4 p-4 bg-slate-50 rounded-xl">
                      <div className="w-10 h-10 bg-white rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm">
                        <feature.icon size={20} className="text-indigo-600" />
                      </div>
                      <div>
                        <h4 className="font-bold text-slate-900">{feature.name}</h4>
                        <p className="text-sm text-slate-500">{feature.desc}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Workflow */}
      <div className="bg-slate-50 py-20 px-6">
        <div className="max-w-5xl mx-auto">
          <div className="text-center mb-12">
            <h2 className="text-3xl font-black text-slate-900 mb-4">æ‹›è˜å…¨æµç¨‹è¦†ç›–</h2>
            <p className="text-slate-500">ä»éœ€æ±‚åˆ°å…¥èŒï¼Œä¸€ç«™å¼å®Œæˆ</p>
          </div>
          <div className="flex flex-wrap justify-center items-center gap-4">
            {[
              { step: 'éœ€æ±‚åˆ†æ', icon: FileText },
              { step: 'èŒä½å‘å¸ƒ', icon: Send },
              { step: 'äººæ‰åŒ¹é…', icon: Target },
              { step: 'ç®€å†ç­›é€‰', icon: Filter },
              { step: 'é¢è¯•å®‰æ’', icon: Calendar },
              { step: 'é¢è¯•è¯„ä¼°', icon: ClipboardCheck },
              { step: 'Offer å‘æ”¾', icon: CheckCircle2 },
            ].map((item, i) => (
              <div key={i} className="flex items-center gap-3">
                <div className="bg-white rounded-xl px-5 py-3 shadow-sm border border-slate-100 flex items-center gap-3">
                  <item.icon size={18} className="text-indigo-600" />
                  <span className="font-bold text-slate-700">{item.step}</span>
                </div>
                {i < 6 && <ArrowRight size={18} className="text-slate-300" />}
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Upcoming Products */}
      <div className="max-w-5xl mx-auto px-4 md:px-6 py-12 md:py-20">
        <div className="text-center mb-12">
          <h2 className="text-3xl font-black text-slate-900 mb-4">æ›´å¤š Agent å³å°†æ¨å‡º</h2>
          <p className="text-slate-500">æˆ‘ä»¬æ­£åœ¨æ„å»ºå®Œæ•´çš„äººæ‰ç®¡ç† Agent ç”Ÿæ€</p>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {upcomingProducts.map((product, i) => (
            <div key={i} className="bg-white rounded-lg border border-dashed border-slate-300 p-6 text-center opacity-60">
              <div className="w-14 h-14 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <product.icon size={24} className="text-slate-400" />
              </div>
              <h4 className="font-bold text-slate-700 mb-1">{product.name}</h4>
              <p className="text-sm text-slate-400 mb-3">{product.desc}</p>
              <span className="inline-block px-3 py-1 bg-slate-100 text-slate-500 text-xs font-bold rounded-full">
                {product.status}
              </span>
            </div>
          ))}
        </div>
      </div>

      {/* CTA Section */}
      <div className="max-w-4xl mx-auto px-4 md:px-6 pb-12 md:pb-20">
        <div className="bg-gradient-to-r from-indigo-500 to-violet-500 rounded-3xl p-6 md:p-12 text-white text-center">
          <h2 className="text-3xl font-black mb-4">ä½“éªŒ Hire Agent</h2>
          <p className="text-indigo-100 mb-8 max-w-xl mx-auto">
            {isLoggedIn ? 'ç«‹å³è¿›å…¥æ§åˆ¶å°ï¼Œå¼€å§‹ AI é©±åŠ¨çš„æ™ºèƒ½æ‹›è˜ä¹‹æ—…' : 'æ³¨å†Œå³å¯è·å¾—å…è´¹ Tokenï¼Œå¼€å§‹ AI é©±åŠ¨çš„æ™ºèƒ½æ‹›è˜ä¹‹æ—…'}
          </p>
          <div className="flex justify-center gap-4">
            <button
              onClick={() => handleAuthAction('/ai-assistant')}
              className="bg-white text-indigo-600 px-8 py-4 rounded-xl font-black hover:bg-indigo-50 transition-all"
            >
              {isLoggedIn ? 'è¿›å…¥æ§åˆ¶å°' : 'å…è´¹å¼€å§‹'}
            </button>
            <button
              onClick={() => navigate('/pricing')}
              className="bg-indigo-400 text-white px-8 py-4 rounded-xl font-black hover:bg-indigo-300 transition-all"
            >
              æŸ¥çœ‹å®šä»·
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// --- è§£å†³æ–¹æ¡ˆé¡µé¢ (æµ…è‰²ç‰ˆ) ---
const SolutionsPage = () => {
  const navigate = useNavigate();
  const { isLoggedIn, userRole } = useAuth();

  // å¤„ç†éœ€è¦ç™»å½•çš„æ“ä½œ
  const handleAuthAction = (targetPath: string, defaultRole?: 'candidate' | 'employer') => {
    if (isLoggedIn) {
      // å·²ç™»å½•ï¼Œæ ¹æ®è§’è‰²è·³è½¬åˆ°å¯¹åº”é¡µé¢
      if (userRole === 'employer' || userRole === 'recruiter' || userRole === 'admin') {
        navigate('/employer');
      } else {
        navigate('/candidate');
      }
    } else {
      // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
      const roleParam = defaultRole ? `?role=${defaultRole}` : '';
      navigate(`/login${roleParam}`, { state: { from: targetPath } });
    }
  };

  const solutions = [
    {
      id: 'talent',
      title: 'äººæ‰æ±‚èŒè§£å†³æ–¹æ¡ˆ',
      subtitle: 'For Job Seekers',
      description: 'ä»ç®€å†ä¼˜åŒ–åˆ°é¢è¯•å‡†å¤‡ï¼ŒAI å…¨ç¨‹é™ªä¼´æ‚¨çš„æ±‚èŒä¹‹æ—…',
      icon: UserIcon,
      color: 'bg-emerald-500',
      lightColor: 'bg-emerald-50',
      textColor: 'text-emerald-600',
      features: [
        { icon: FileText, name: 'AI ç®€å†ä¼˜åŒ–', desc: 'æ™ºèƒ½åˆ†æç®€å†ï¼Œç»™å‡ºé’ˆå¯¹æ€§ä¼˜åŒ–å»ºè®®' },
        { icon: Target, name: 'èŒä½ç²¾å‡†åŒ¹é…', desc: 'åŸºäºæŠ€èƒ½å›¾è°±ï¼Œç§’çº§æ¨èæœ€åŒ¹é…æœºä¼š' },
        { icon: MessageSquare, name: 'é¢è¯•æ¨¡æ‹Ÿè®­ç»ƒ', desc: 'AI é¢è¯•å®˜è¿›è¡Œå…¨çœŸæ¨¡æ‹Ÿè®­ç»ƒ' },
        { icon: TrendingUp, name: 'è–ªèµ„è°ˆåˆ¤æŒ‡å¯¼', desc: 'å¸‚åœºæ•°æ®æ”¯æ’‘ï¼Œè°ˆåˆ¤æ›´æœ‰åº•æ°”' },
        { icon: BookOpen, name: 'èŒä¸šå‘å±•è§„åˆ’', desc: 'åˆ†ææŠ€èƒ½ä¼˜åŠ¿ï¼Œè§„åˆ’æˆé•¿è·¯å¾„' },
        { icon: Bell, name: 'èŒä½åŠ¨æ€æé†’', desc: 'å¿ƒä»ªå…¬å¸æ–°èŒä½ç¬¬ä¸€æ—¶é—´æ¨é€' },
      ],
      stats: [
        { value: '85%', label: 'ç®€å†é€šè¿‡ç‡æå‡' },
        { value: '3x', label: 'é¢è¯•é‚€çº¦å¢åŠ ' },
        { value: '28å¤©', label: 'å¹³å‡æ±‚èŒå‘¨æœŸ' },
      ],
      cta: 'å¼€å§‹æ±‚èŒ',
      link: '/register?role=candidate'
    },
    {
      id: 'enterprise',
      title: 'ä¼ä¸šæ‹›è˜è§£å†³æ–¹æ¡ˆ',
      subtitle: 'For Enterprises',
      description: 'ä»éœ€æ±‚å‘å¸ƒåˆ° Offer å‘æ”¾ï¼Œæ‰“é€ é«˜æ•ˆæ‹›è˜é—­ç¯',
      icon: Building2,
      color: 'bg-indigo-500',
      lightColor: 'bg-indigo-50',
      textColor: 'text-indigo-600',
      features: [
        { icon: PenTool, name: 'JD æ™ºèƒ½ç”Ÿæˆ', desc: 'AI ç§’çº§ç”Ÿæˆä¸“ä¸šèŒä½æè¿°' },
        { icon: Search, name: 'äººæ‰ä¸»åŠ¨è§¦è¾¾', desc: 'ä¸»åŠ¨è”ç³»åŒ¹é…äººæ‰ï¼Œå˜è¢«åŠ¨ä¸ºä¸»åŠ¨' },
        { icon: Brain, name: 'å¤šç»´åº¦è¯„ä¼°', desc: 'æŠ€èƒ½ã€æ–‡åŒ–ã€æ½œåŠ›å¤šç»´åº¦ç»¼åˆè¯„åˆ†' },
        { icon: BarChart3, name: 'æ‹›è˜æ•°æ®åˆ†æ', desc: 'å®æ—¶è¿½è¸ªæ‹›è˜æ¼æ–—ï¼Œä¼˜åŒ–ç­–ç•¥' },
        { icon: Users, name: 'åä½œæ‹›è˜', desc: 'å¤šè§’è‰²åä½œï¼Œä¿¡æ¯åŒæ­¥é«˜æ•ˆ' },
        { icon: Database, name: 'äººæ‰åº“æ²‰æ·€', desc: 'æ„å»ºä¸“å±äººæ‰æ± ï¼ŒäºŒæ¬¡æ¿€æ´»å¤ç”¨' },
      ],
      stats: [
        { value: '-60%', label: 'æ‹›è˜å‘¨æœŸç¼©çŸ­' },
        { value: '10x', label: 'ç­›é€‰æ•ˆç‡æå‡' },
        { value: '-50%', label: 'æ‹›è˜æˆæœ¬é™ä½' },
      ],
      cta: 'å¼€å§‹æ‹›è˜',
      link: '/register?role=employer'
    }
  ];

  const industries = [
    { name: 'äº’è”ç½‘ç§‘æŠ€', icon: Code, desc: 'æŠ€æœ¯äººæ‰å¿«é€Ÿæ‰©å¼ ', color: 'bg-blue-100', textColor: 'text-blue-600' },
    { name: 'é‡‘èæœåŠ¡', icon: Landmark, desc: 'é«˜ç«¯äººæ‰ç²¾å‡†çŒè˜', color: 'bg-amber-100', textColor: 'text-amber-600' },
    { name: 'åŒ»ç–—å¥åº·', icon: Heart, desc: 'ä¸“ä¸šäººæ‰åˆè§„æ‹›è˜', color: 'bg-rose-100', textColor: 'text-rose-600' },
    { name: 'æ•™è‚²åŸ¹è®­', icon: GraduationCap, desc: 'å¸ˆèµ„äººæ‰é«˜æ•ˆåŒ¹é…', color: 'bg-emerald-100', textColor: 'text-emerald-600' },
    { name: 'ç”µå•†é›¶å”®', icon: Tag, desc: 'è¿è¥äººæ‰è§„æ¨¡æ‹›è˜', color: 'bg-orange-100', textColor: 'text-orange-600' },
    { name: 'åˆ¶é€ ä¸š', icon: Settings, desc: 'æŠ€æœ¯å·¥äººæ‰¹é‡æ‹›è˜', color: 'bg-slate-100', textColor: 'text-slate-600' },
    { name: 'æ¸¸æˆå¨±ä¹', icon: Play, desc: 'åˆ›æ„äººæ‰ç²¾å‡†åŒ¹é…', color: 'bg-purple-100', textColor: 'text-purple-600' },
    { name: 'å’¨è¯¢æœåŠ¡', icon: Lightbulb, desc: 'ä¸“ä¸šé¡¾é—®å¿«é€Ÿç»„å»º', color: 'bg-cyan-100', textColor: 'text-cyan-600' },
  ];

  const scenarios = [
    { title: 'æ ¡å›­æ‹›è˜', desc: 'æ‰¹é‡å¤„ç†æµ·é‡ç®€å†ï¼Œé«˜æ•ˆå®Œæˆç§‹æ‹›æ˜¥æ‹›', icon: GraduationCap },
    { title: 'ç¤¾ä¼šæ‹›è˜', desc: 'ç²¾å‡†åŒ¹é…æœ‰ç»éªŒçš„ä¸“ä¸šäººæ‰', icon: Users },
    { title: 'é«˜ç®¡çŒè˜', desc: 'AI è¾…åŠ©é«˜ç«¯äººæ‰æœç´¢ä¸èƒŒè°ƒ', icon: Award },
    { title: 'å¤–åŒ…æ´¾é£', desc: 'å¿«é€Ÿå“åº”æ‰¹é‡éœ€æ±‚ï¼Œçµæ´»ç”¨å·¥', icon: ArrowRightCircle },
  ];

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-white">
      {/* Hero */}
      <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6">
        <div className="max-w-5xl mx-auto text-center">
          <div className="inline-flex items-center gap-2 bg-indigo-50 text-indigo-600 px-4 py-2 rounded-full text-sm font-bold mb-8">
            <Rocket size={16} /> å…¨åœºæ™¯è§£å†³æ–¹æ¡ˆ
          </div>
          <h1 className="text-3xl md:text-5xl lg:text-6xl font-black text-slate-900 mb-4 md:mb-6 tracking-tight">
            é¢å‘æœªæ¥çš„<br /><span className="text-indigo-600">æ™ºèƒ½æ‹›è˜è§£å†³æ–¹æ¡ˆ</span>
          </h1>
          <p className="text-xl text-slate-500 max-w-2xl mx-auto">
            æ— è®ºæ‚¨æ˜¯å¯»æ‰¾æ¢¦æƒ³å·¥ä½œçš„äººæ‰ï¼Œè¿˜æ˜¯å¯»è§…ä¼˜ç§€äººæ‰çš„ä¼ä¸šï¼Œ
            æˆ‘ä»¬éƒ½æœ‰ä¸“å±çš„ AI è§£å†³æ–¹æ¡ˆ
          </p>
        </div>
      </div>

      {/* Solutions Cards */}
      <div className="max-w-7xl mx-auto px-4 md:px-6 pb-12 md:pb-20">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {solutions.map((solution) => (
            <div key={solution.id} className="bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden">
              {/* Header */}
              <div className={`${solution.lightColor} px-8 py-8 border-b border-slate-100`}>
                <div className="flex items-center gap-4 mb-4">
                  <div className={`w-14 h-14 ${solution.color} rounded-2xl flex items-center justify-center`}>
                    <solution.icon size={28} className="text-white" />
                  </div>
                  <div>
                    <p className={`${solution.textColor} text-sm font-bold`}>{solution.subtitle}</p>
                    <h3 className="text-2xl font-black text-slate-900">{solution.title}</h3>
                  </div>
                </div>
                <p className="text-slate-600">{solution.description}</p>
                {/* Stats */}
                <div className="grid grid-cols-3 gap-4 mt-6">
                  {solution.stats.map((stat, i) => (
                    <div key={i} className="bg-white rounded-lg p-3 text-center shadow-sm">
                      <AnimatedStatItem value={stat.value} label={stat.label} color={solution.textColor} delay={i * 100} size="normal" />
                    </div>
                  ))}
                </div>
              </div>
              {/* Features */}
              <div className="p-8">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-8">
                  {solution.features.map((feature, i) => (
                    <div key={i} className="flex gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition-all">
                      <div className="w-9 h-9 bg-white rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm">
                        <feature.icon size={16} className={solution.textColor} />
                      </div>
                      <div>
                        <h4 className="font-bold text-slate-900 text-sm">{feature.name}</h4>
                        <p className="text-xs text-slate-500">{feature.desc}</p>
                      </div>
                    </div>
                  ))}
                </div>
                <button
                  onClick={() => handleAuthAction(solution.id === 'talent' ? '/candidate' : '/employer', solution.id === 'talent' ? 'candidate' : 'employer')}
                  className={`w-full ${solution.color} text-white py-4 rounded-xl font-black hover:opacity-90 transition-all flex items-center justify-center gap-2`}
                >
                  {isLoggedIn ? 'è¿›å…¥æ§åˆ¶å°' : solution.cta} <ArrowRight size={18} />
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Recruitment Scenarios */}
      <div className="bg-slate-50 py-20 px-6">
        <div className="max-w-7xl mx-auto">
          <div className="text-center mb-12">
            <h2 className="text-3xl font-black text-slate-900 mb-4">æ‹›è˜åœºæ™¯å…¨è¦†ç›–</h2>
            <p className="text-slate-500">æ— è®ºä½•ç§æ‹›è˜éœ€æ±‚ï¼Œæˆ‘ä»¬éƒ½æœ‰ä¸“ä¸šè§£å†³æ–¹æ¡ˆ</p>
          </div>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
            {scenarios.map((item, i) => (
              <div key={i} className="text-center p-8 bg-white rounded-lg shadow-sm border border-slate-100 hover:shadow-lg transition-all group">
                <div className="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                  <item.icon size={28} className="text-indigo-600" />
                </div>
                <h4 className="font-black text-slate-900 mb-2">{item.title}</h4>
                <p className="text-sm text-slate-500">{item.desc}</p>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Industries */}
      <div className="py-12 px-4 md:py-20 md:px-6">
        <div className="max-w-7xl mx-auto">
          <div className="text-center mb-12">
            <h2 className="text-3xl font-black text-slate-900 mb-4">è¦†ç›–å¤šä¸ªè¡Œä¸š</h2>
            <p className="text-slate-500">æ·±è€•å‚ç›´é¢†åŸŸï¼Œæä¾›ä¸“ä¸šåŒ–çš„æ‹›è˜è§£å†³æ–¹æ¡ˆ</p>
          </div>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {industries.map((item, i) => (
              <div key={i} className={`${item.color} rounded-lg p-6 hover:shadow-md transition-all group`}>
                <div className="w-12 h-12 bg-white rounded-xl flex items-center justify-center mb-4 shadow-sm group-hover:scale-110 transition-transform">
                  <item.icon size={24} className={item.textColor} />
                </div>
                <h4 className="font-bold text-slate-900 mb-1">{item.name}</h4>
                <p className="text-xs text-slate-500">{item.desc}</p>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* CTA */}
      <div className="max-w-4xl mx-auto px-4 md:px-6 pb-12 md:pb-20">
        <div className="bg-gradient-to-r from-indigo-500 to-violet-500 rounded-3xl p-6 md:p-12 text-center">
          <h2 className="text-3xl font-black text-white mb-4">{isLoggedIn ? 'ç«‹å³è¿›å…¥æ§åˆ¶å°' : 'æ‰¾åˆ°é€‚åˆæ‚¨çš„è§£å†³æ–¹æ¡ˆ'}</h2>
          <p className="text-indigo-100 mb-8">{isLoggedIn ? 'å¼€å§‹ä½¿ç”¨ AI é©±åŠ¨çš„æ™ºèƒ½æ‹›è˜æœåŠ¡' : 'ç«‹å³å¼€å§‹ï¼Œä½“éªŒ AI é©±åŠ¨çš„æ™ºèƒ½æ‹›è˜'}</p>
          <div className="flex justify-center gap-4 flex-wrap">
            <button
              onClick={() => handleAuthAction('/candidate', 'candidate')}
              className="bg-white text-indigo-600 px-8 py-4 rounded-xl font-black hover:bg-indigo-50 transition-all"
            >
              {isLoggedIn && (userRole === 'candidate' || !userRole) ? 'è¿›å…¥æ±‚èŒæ§åˆ¶å°' : 'æˆ‘æ˜¯æ±‚èŒè€…'}
            </button>
            <button
              onClick={() => handleAuthAction('/employer', 'employer')}
              className="bg-indigo-400 text-white px-8 py-4 rounded-xl font-black hover:bg-indigo-300 transition-all"
            >
              {isLoggedIn && (userRole === 'employer' || userRole === 'recruiter' || userRole === 'admin') ? 'è¿›å…¥æ‹›è˜æ§åˆ¶å°' : 'æˆ‘æ˜¯æ‹›è˜æ–¹'}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// --- Agent é¡µé¢ (æµ…è‰²ç‰ˆ - çº¯æŠ€æœ¯ä»‹ç») ---
const ModelsPage = () => {
  const navigate = useNavigate();
  const { isLoggedIn, userRole } = useAuth();

  // å¤„ç†éœ€è¦ç™»å½•çš„æ“ä½œ
  const handleAuthAction = () => {
    if (isLoggedIn) {
      // å·²ç™»å½•ï¼Œæ ¹æ®è§’è‰²è·³è½¬åˆ°å¯¹åº”é¡µé¢
      if (userRole === 'employer' || userRole === 'recruiter' || userRole === 'admin') {
        navigate('/employer');
      } else {
        navigate('/candidate');
      }
    } else {
      // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
      navigate('/login', { state: { from: '/ai-assistant' } });
    }
  };

  const agents = [
    {
      name: 'å¯¹è¯ç†è§£ Agent',
      desc: 'è‡ªç„¶è¯­è¨€ç†è§£ä¸å¤šè½®å¯¹è¯èƒ½åŠ›ï¼Œç²¾å‡†è¯†åˆ«ç”¨æˆ·æ„å›¾',
      icon: Bot,
      color: 'bg-indigo-500',
      lightColor: 'bg-indigo-50',
      textColor: 'text-indigo-600',
      capabilities: ['æ„å›¾è¯†åˆ«', 'å¤šè½®å¯¹è¯', 'ä¸Šä¸‹æ–‡è®°å¿†', 'æƒ…æ„Ÿåˆ†æ'],
    },
    {
      name: 'ç®€å†è§£æ Agent',
      desc: 'æ·±åº¦è§£æç®€å†å†…å®¹ï¼Œæå–æŠ€èƒ½ã€ç»éªŒã€é¡¹ç›®ç­‰å…³é”®ä¿¡æ¯',
      icon: FileText,
      color: 'bg-emerald-500',
      lightColor: 'bg-emerald-50',
      textColor: 'text-emerald-600',
      capabilities: ['ç»“æ„åŒ–æå–', 'æŠ€èƒ½è¯†åˆ«', 'ç»éªŒåˆ†æ', 'æ•™è‚²èƒŒæ™¯'],
    },
    {
      name: 'äººæ‰åŒ¹é… Agent',
      desc: 'è¯­ä¹‰çº§æ™ºèƒ½åŒ¹é…ï¼Œæ‰¾åˆ°æŠ€èƒ½ä¸æ–‡åŒ–éƒ½å¥‘åˆçš„æœ€ä½³å€™é€‰äºº',
      icon: Target,
      color: 'bg-violet-500',
      lightColor: 'bg-violet-50',
      textColor: 'text-violet-600',
      capabilities: ['è¯­ä¹‰åŒ¹é…', 'æ–‡åŒ–å¥‘åˆåº¦', 'æŠ€èƒ½å›¾è°±', 'åŒå‘æ¨è'],
    },
    {
      name: 'é¢è¯•è¯„ä¼° Agent',
      desc: 'å¤šç»´åº¦è¯„ä¼°å€™é€‰äººè¡¨ç°ï¼Œç”Ÿæˆç»“æ„åŒ–çš„é¢è¯•è¯„ä¼°æŠ¥å‘Š',
      icon: ClipboardCheck,
      color: 'bg-amber-500',
      lightColor: 'bg-amber-50',
      textColor: 'text-amber-600',
      capabilities: ['è¡¨ç°è¯„ä¼°', 'èƒ½åŠ›é›·è¾¾å›¾', 'é£é™©é¢„è­¦', 'å½•ç”¨å»ºè®®'],
    },
    {
      name: 'è–ªèµ„åˆ†æ Agent',
      desc: 'åŸºäºå¸‚åœºå¤§æ•°æ®è¿›è¡Œè–ªèµ„åˆ†æï¼Œç»™å‡ºåˆç†çš„è–ªèµ„å»ºè®®',
      icon: TrendingUp,
      color: 'bg-rose-500',
      lightColor: 'bg-rose-50',
      textColor: 'text-rose-600',
      capabilities: ['å¸‚åœºæ•°æ®', 'è–ªèµ„é¢„æµ‹', 'è°ˆåˆ¤ç­–ç•¥', 'ç«äº‰åŠ›åˆ†æ'],
    },
    {
      name: 'è·¯ç”±è°ƒåº¦ Agent',
      desc: 'æ™ºèƒ½åè°ƒå¤šä¸ª Agent çš„åä½œï¼Œç¡®ä¿ä»»åŠ¡æœ€ä¼˜åˆ†é…',
      icon: GitBranch,
      color: 'bg-cyan-500',
      lightColor: 'bg-cyan-50',
      textColor: 'text-cyan-600',
      capabilities: ['ä»»åŠ¡åˆ†è§£', 'è´Ÿè½½å‡è¡¡', 'ä¼˜å…ˆçº§è°ƒåº¦', 'ç»“æœèšåˆ'],
    },
  ];

  const techStack = [
    { name: 'LLM å¤§è¯­è¨€æ¨¡å‹', desc: 'åŸºäº GPT-4ã€Claude 3.5 ç­‰é¡¶çº§å¤§æ¨¡å‹', icon: Brain },
    { name: 'RAG æ£€ç´¢å¢å¼º', desc: 'ç»“åˆçŸ¥è¯†åº“å®ç°ç²¾å‡†ã€å¯é çš„å›ç­”', icon: Search },
    { name: 'Multi-Agent æ¶æ„', desc: 'å¤šæ™ºèƒ½ä½“åä½œï¼Œå„å¸å…¶èŒé«˜æ•ˆååŒ', icon: Users },
    { name: 'Vector Search', desc: 'å‘é‡æ£€ç´¢æŠ€æœ¯ï¼Œæ¯«ç§’çº§è¯­ä¹‰åŒ¹é…', icon: Database },
  ];

  const advantages = [
    { title: 'æ¯«ç§’çº§å“åº”', value: '<100ms', desc: 'å®æ—¶å“åº”ç”¨æˆ·è¯·æ±‚' },
    { title: 'é«˜å‡†ç¡®ç‡', value: '95%+', desc: 'äººæ‰åŒ¹é…å‡†ç¡®ç‡' },
    { title: 'é«˜å¯ç”¨æ€§', value: '99.9%', desc: 'ç³»ç»Ÿç¨³å®šè¿è¡Œ' },
    { title: 'æŒç»­å­¦ä¹ ', value: '24/7', desc: 'æ¨¡å‹æŒç»­ä¼˜åŒ–' },
  ];

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-white">
      {/* Hero */}
      <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6">
        <div className="max-w-5xl mx-auto text-center">
          <div className="inline-flex items-center gap-2 bg-indigo-50 text-indigo-600 px-4 py-2 rounded-full text-sm font-bold mb-8">
            <Bot size={16} /> Multi-Agent System
          </div>
          <h1 className="text-3xl md:text-5xl lg:text-6xl font-black text-slate-900 mb-4 md:mb-6 tracking-tight">
            <span className="text-indigo-600">å¤šæ™ºèƒ½ä½“åä½œ</span>
            <br />é©±åŠ¨ä¸‹ä¸€ä»£æ‹›è˜
          </h1>
          <p className="text-xl text-slate-500 max-w-2xl mx-auto">
            æˆ‘ä»¬æ„å»ºäº†ä¸“ä¸šçš„æ‹›è˜é¢†åŸŸ AI Agent é›†ç¾¤ï¼Œ
            æ¯ä¸ª Agent ä¸“æ³¨äºç‰¹å®šä»»åŠ¡ï¼ŒååŒå·¥ä½œä»¥æä¾›æœ€ä½³æœåŠ¡
          </p>
        </div>
      </div>

      {/* Performance Stats */}
      <div className="max-w-5xl mx-auto px-4 md:px-6 pb-10 md:pb-16">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          {advantages.map((item, i) => (
            <div key={i} className="bg-white rounded-lg p-6 shadow-sm border border-slate-100 text-center">
              <AnimatedStatItem value={item.value} label={item.title} color="text-indigo-600" delay={i * 100} size="large" />
              <div className="text-xs text-slate-400 mt-1">{item.desc}</div>
            </div>
          ))}
        </div>
      </div>

      {/* Agents Grid */}
      <div className="max-w-7xl mx-auto px-4 md:px-6 pb-12 md:pb-20">
        <div className="text-center mb-12">
          <h2 className="text-3xl font-black text-slate-900 mb-4">Agent èƒ½åŠ›çŸ©é˜µ</h2>
          <p className="text-slate-500">æ¯ä¸ª Agent ä¸“æ³¨äºç‰¹å®šä»»åŠ¡ï¼ŒååŒå·¥ä½œæä¾›æœ€ä½³æœåŠ¡</p>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {agents.map((agent, i) => (
            <div key={i} className="bg-white rounded-lg border border-slate-100 p-6 hover:shadow-lg transition-all group">
              <div className="flex items-center gap-4 mb-4">
                <div className={`w-14 h-14 ${agent.color} rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform`}>
                  <agent.icon size={28} className="text-white" />
                </div>
                <div>
                  <h3 className="font-black text-slate-900">{agent.name}</h3>
                </div>
              </div>
              <p className="text-slate-500 text-sm mb-4">{agent.desc}</p>
              <div className="flex flex-wrap gap-2">
                {agent.capabilities.map((cap, j) => (
                  <span key={j} className={`px-3 py-1 ${agent.lightColor} ${agent.textColor} text-xs font-bold rounded-full`}>
                    {cap}
                  </span>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Tech Architecture */}
      <div className="bg-slate-50 py-20 px-6">
        <div className="max-w-5xl mx-auto">
          <div className="text-center mb-12">
            <h2 className="text-3xl font-black text-slate-900 mb-4">åº•å±‚æŠ€æœ¯æ¶æ„</h2>
            <p className="text-slate-500">åŸºäºæœ€å‰æ²¿çš„ AI æŠ€æœ¯æ„å»ºæ‹›è˜åŸºç¡€è®¾æ–½</p>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {techStack.map((tech, i) => (
              <div key={i} className="bg-white rounded-lg p-6 shadow-sm border border-slate-100 flex gap-4">
                <div className="w-12 h-12 bg-indigo-50 rounded-xl flex items-center justify-center flex-shrink-0">
                  <tech.icon size={24} className="text-indigo-600" />
                </div>
                <div>
                  <h4 className="font-bold text-slate-900 mb-1">{tech.name}</h4>
                  <p className="text-sm text-slate-500">{tech.desc}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* How It Works */}
      <div className="py-12 px-4 md:py-20 md:px-6">
        <div className="max-w-5xl mx-auto">
          <div className="text-center mb-12">
            <h2 className="text-3xl font-black text-slate-900 mb-4">Agent åä½œæµç¨‹</h2>
            <p className="text-slate-500">å¤šæ™ºèƒ½ä½“ååŒå·¥ä½œï¼Œå®Œæˆå¤æ‚æ‹›è˜ä»»åŠ¡</p>
          </div>
          <div className="flex flex-wrap justify-center items-center gap-4">
            {[
              { step: 'ç”¨æˆ·è¾“å…¥', icon: MessageSquare },
              { step: 'æ„å›¾è¯†åˆ«', icon: Bot },
              { step: 'ä»»åŠ¡åˆ†å‘', icon: GitBranch },
              { step: 'Agent æ‰§è¡Œ', icon: Zap },
              { step: 'ç»“æœèšåˆ', icon: Layers },
              { step: 'è¾“å‡ºå“åº”', icon: CheckCircle2 },
            ].map((item, i) => (
              <div key={i} className="flex items-center gap-3">
                <div className="bg-white rounded-xl px-5 py-3 shadow-sm border border-slate-100 flex items-center gap-3">
                  <item.icon size={18} className="text-indigo-600" />
                  <span className="font-bold text-slate-700">{item.step}</span>
                </div>
                {i < 5 && <ArrowRight size={18} className="text-slate-300" />}
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* CTA */}
      <div className="max-w-4xl mx-auto px-4 md:px-6 pb-12 md:pb-20">
        <div className="bg-gradient-to-r from-indigo-500 to-violet-500 rounded-3xl p-6 md:p-12 text-center">
          <h2 className="text-3xl font-black text-white mb-4">ä½“éªŒ AI Agent çš„å¼ºå¤§èƒ½åŠ›</h2>
          <p className="text-indigo-100 mb-8">{isLoggedIn ? 'è¿›å…¥æ§åˆ¶å°ï¼Œå¼€å§‹æ™ºèƒ½æ‹›è˜ä¹‹æ—…' : 'ç«‹å³æ³¨å†Œï¼Œå¼€å§‹æ™ºèƒ½æ‹›è˜ä¹‹æ—…'}</p>
          <button
            onClick={handleAuthAction}
            className="bg-white text-indigo-600 px-8 py-4 rounded-xl font-black hover:bg-indigo-50 transition-all"
          >
            {isLoggedIn ? 'è¿›å…¥æ§åˆ¶å°' : 'å…è´¹å¼€å§‹'}
          </button>
        </div>
      </div>
    </div>
  );
};

// --- å®šä»·æ–¹æ¡ˆé¡µé¢ ---
const PricingView = () => {
  const navigate = useNavigate();
  const { user, isLoggedIn, userRole, refreshUser } = useAuth();
  const [upgrading, setUpgrading] = useState(false);
  const [upgradeSuccess, setUpgradeSuccess] = useState<string | null>(null);

  // å¤„ç†éœ€è¦ç™»å½•çš„æ“ä½œ
  const handleAuthAction = (plan: string) => {
    if (isLoggedIn) {
      // å·²ç™»å½•ï¼Œè·³è½¬åˆ° tokens é¡µé¢è´­ä¹°
      navigate('/tokens');
    } else {
      // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
      navigate('/login', { state: { from: '/tokens', plan } });
    }
  };
  
  // å¤„ç†å‡çº§æ“ä½œ
  const handleUpgrade = async (tierName: string) => {
    if (!isLoggedIn || !user?.id) {
      navigate('/login', { state: { from: '/pricing', plan: tierName } });
      return;
    }
    const tierMap: Record<string, string> = {
      'Devnors 1.0': 'FREE',
      'Devnors 1.0 Pro': 'PRO',
      'Devnors 1.0 Ultra': 'ULTRA',
    };
    const tier = tierMap[tierName] || 'FREE';
    setUpgrading(true);
    try {
      await upgradeAccountTier(user.id, tier, billingCycle);
      await refreshUser();
      setUpgradeSuccess(tierName);
      setTimeout(() => setUpgradeSuccess(null), 4000);
    } catch (e) {
      console.error('å‡çº§å¤±è´¥', e);
    } finally {
      setUpgrading(false);
    }
  };
  
  const [billingCycle, setBillingCycle] = useState<'monthly' | 'annual'>('annual');

  const currentTier = user?.account_tier || 'FREE';
  const tierOrder: Record<string, number> = { FREE: 0, PRO: 1, ULTRA: 2 };
  
  const plans = [
    {
      name: 'Devnors 1.0',
      tier: 'FREE',
      price: 'Â¥0',
      period: '/æœˆ',
      description: 'åŸºç¡€ç‰ˆ Â· å…¥é—¨ä½“éªŒ',
      tokenQuota: '50,000',
      tokenValue: 'â‰ˆ 62 æ¬¡å¯¹è¯ / 12 æ¬¡ç®€å†è§£æ',
      features: [
        { name: 'æ¯æœˆå…è´¹ Token', value: '50,000', included: true },
        { name: 'ä¸Šä¸‹æ–‡é•¿åº¦', value: '32K tokens', included: true },
        { name: 'è¯·æ±‚é¢‘ç‡é™åˆ¶', value: '10 RPM', included: true },
        { name: 'å¹¶å‘è¯·æ±‚æ•°', value: '1', included: true },
        { name: 'åŸºç¡€æ¨¡å‹èƒ½åŠ›', value: 'âœ“', included: true },
        { name: 'é«˜çº§æ¨ç†èƒ½åŠ›', value: '-', included: false },
        { name: 'ä¸“å±æŠ€æœ¯æ”¯æŒ', value: '-', included: false },
        { name: 'é«˜é˜¶å¯¹æ¥ç®—æ³•', value: '-', included: false },
        { name: 'è‡ªå®šä¹‰å¤§æ¨¡å‹æ¥å…¥', value: '-', included: false },
        { name: 'æ±‚èŒäº‘ç«¯è½®å·¡å‘¨æœŸ', value: '1 å¤©', included: true },
        { name: 'åŒæ—¶è¿›è¡Œçš„æ‹›è˜ä»»åŠ¡', value: '1 ä¸ª', included: true },
        { name: 'é‚€è¯·å¥½å‹å¥–åŠ±', value: '50,000 tokens/äºº', included: true },
      ],
      cta: 'å…è´¹ä½¿ç”¨',
      color: 'border-slate-200',
      btnColor: 'bg-slate-100 text-slate-600 hover:bg-slate-200',
    },
    {
      name: 'Devnors 1.0 Pro',
      tier: 'PRO',
      price: billingCycle === 'annual' ? 'Â¥159' : 'Â¥199',
      period: '/æœˆ',
      description: 'ä¸“ä¸šç‰ˆ Â· æ€§èƒ½å¹³è¡¡',
      popular: true,
      tokenQuota: '2,000,000',
      tokenValue: 'â‰ˆ 2,500 æ¬¡å¯¹è¯ / 500 æ¬¡ç®€å†è§£æ',
      features: [
        { name: 'æ¯æœˆå…è´¹ Token', value: '2,000,000', included: true },
        { name: 'ä¸Šä¸‹æ–‡é•¿åº¦', value: '128K tokens', included: true },
        { name: 'è¯·æ±‚é¢‘ç‡é™åˆ¶', value: '100 RPM', included: true },
        { name: 'å¹¶å‘è¯·æ±‚æ•°', value: '10', included: true },
        { name: 'åŸºç¡€æ¨¡å‹èƒ½åŠ›', value: 'âœ“', included: true },
        { name: 'é«˜çº§æ¨ç†èƒ½åŠ›', value: 'âœ“', included: true },
        { name: 'ä¸“å±æŠ€æœ¯æ”¯æŒ', value: 'å·¥å•', included: true },
        { name: 'é«˜é˜¶å¯¹æ¥ç®—æ³•', value: '-', included: false },
        { name: 'è‡ªå®šä¹‰å¤§æ¨¡å‹æ¥å…¥', value: '-', included: false },
        { name: 'æ±‚èŒäº‘ç«¯è½®å·¡å‘¨æœŸ', value: '7 å¤©', included: true },
        { name: 'åŒæ—¶è¿›è¡Œçš„æ‹›è˜ä»»åŠ¡', value: '3 ä¸ª', included: true },
        { name: 'é‚€è¯·å¥½å‹å¥–åŠ±', value: '50,000 tokens/äºº', included: true },
      ],
      cta: 'ç«‹å³å‡çº§',
      color: 'border-indigo-200 shadow-xl',
      btnColor: 'bg-indigo-600 text-white hover:bg-indigo-700',
    },
    {
      name: 'Devnors 1.0 Ultra',
      tier: 'ULTRA',
      price: billingCycle === 'annual' ? 'Â¥1,437' : 'Â¥1,797',
      period: '/æœˆ',
      description: 'æ——èˆ°ç‰ˆ Â· æ— é™å¯èƒ½',
      tokenQuota: '30,000,000',
      tokenValue: 'â‰ˆ 37,500 æ¬¡å¯¹è¯ / 7,500 æ¬¡ç®€å†è§£æ',
      features: [
        { name: 'æ¯æœˆå…è´¹ Token', value: '30,000,000', included: true },
        { name: 'ä¸Šä¸‹æ–‡é•¿åº¦', value: '1M+ tokens', included: true },
        { name: 'è¯·æ±‚é¢‘ç‡é™åˆ¶', value: '800 RPM', included: true },
        { name: 'å¹¶å‘è¯·æ±‚æ•°', value: '100', included: true },
        { name: 'åŸºç¡€æ¨¡å‹èƒ½åŠ›', value: 'âœ“', included: true },
        { name: 'é«˜çº§æ¨ç†èƒ½åŠ›', value: 'âœ“', included: true },
        { name: 'ä¸“å±æŠ€æœ¯æ”¯æŒ', value: '1v1 ä¸“å±', included: true },
        { name: 'é«˜é˜¶å¯¹æ¥ç®—æ³•', value: 'âœ“', included: true },
        { name: 'å®šåˆ¶åŒ–å¾®è°ƒ', value: 'âœ“', included: true },
        { name: 'è‡ªå®šä¹‰å¤§æ¨¡å‹æ¥å…¥', value: 'Token +20%', included: true },
        { name: 'æ±‚èŒäº‘ç«¯è½®å·¡å‘¨æœŸ', value: '30 å¤©', included: true },
        { name: 'åŒæ—¶è¿›è¡Œçš„æ‹›è˜ä»»åŠ¡', value: '10 ä¸ª', included: true },
        { name: 'é‚€è¯·å¥½å‹å¥–åŠ±', value: '50,000 tokens/äºº', included: true },
      ],
      cta: 'ç«‹å³å‡çº§',
      color: 'border-rose-200 shadow-xl',
      btnColor: 'bg-rose-600 text-white hover:bg-rose-700',
    },
  ];

  const getButtonLabel = (plan: typeof plans[0]) => {
    if (!isLoggedIn) return plan.cta;
    if (plan.tier === currentTier) return 'å½“å‰æ–¹æ¡ˆ';
    if (tierOrder[plan.tier] > tierOrder[currentTier]) return 'ç«‹å³å‡çº§';
    return 'åˆ‡æ¢æ–¹æ¡ˆ';
  };

  const isCurrentPlan = (plan: typeof plans[0]) => isLoggedIn && plan.tier === currentTier;

  return (
    <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 max-w-7xl mx-auto animate-in fade-in duration-500">
      {/* å‡çº§æˆåŠŸæç¤º */}
      {upgradeSuccess && (
        <div className="fixed top-16 md:top-24 left-1/2 -translate-x-1/2 z-50 bg-emerald-500 text-white px-4 py-2.5 md:px-6 md:py-3 rounded-xl shadow-xl flex items-center gap-2 animate-in fade-in slide-in-from-top-4 duration-300 max-w-[90vw]">
          <CheckCircle2 size={18} />
          <span className="font-bold">å·²æˆåŠŸå‡çº§åˆ° {upgradeSuccess}ï¼</span>
        </div>
      )}
      
      {/* å½“å‰æ–¹æ¡ˆ banner */}
      {isLoggedIn && (
        <div className={`mb-8 p-4 rounded-xl border flex items-center justify-between ${
          currentTier === 'ULTRA'
            ? 'bg-gradient-to-r from-rose-50 to-amber-50 border-rose-100'
            : currentTier === 'PRO'
            ? 'bg-gradient-to-r from-indigo-50 to-blue-50 border-indigo-100'
            : 'bg-slate-50 border-slate-200'
        }`}>
          <div className="flex items-center gap-3">
            <Cpu size={18} className={
              currentTier === 'ULTRA' ? 'text-rose-600' : currentTier === 'PRO' ? 'text-indigo-600' : 'text-slate-500'
            } />
            <div>
              <span className="font-bold text-slate-900">å½“å‰æ–¹æ¡ˆï¼š</span>
              <span className={`font-black ${
                currentTier === 'ULTRA' ? 'text-rose-600' : currentTier === 'PRO' ? 'text-indigo-600' : 'text-slate-600'
              }`}>
                {currentTier === 'ULTRA' ? 'Devnors 1.0 Ultra Â· æ——èˆ°ç‰ˆ' : currentTier === 'PRO' ? 'Devnors 1.0 Pro Â· ä¸“ä¸šç‰ˆ' : 'Devnors 1.0 Â· åŸºç¡€ç‰ˆ'}
              </span>
            </div>
          </div>
          {currentTier !== 'ULTRA' && (
            <div className="flex items-center gap-1 text-xs text-amber-600 font-bold">
              <Zap size={12} /> å‡çº§è§£é”æ›´å¤šèƒ½åŠ›
            </div>
          )}
        </div>
      )}
      
      <div className="text-center mb-12">
        <div className="inline-flex items-center gap-2 bg-indigo-50 text-indigo-600 px-4 py-2 rounded-full text-sm font-bold mb-6 border border-indigo-100">
          <Sparkle size={16} /> æ¨¡å‹å®šä»·
        </div>
        <h1 className="text-2xl md:text-4xl lg:text-5xl font-black text-slate-900 mb-4 md:mb-6 tracking-tight">é€‰æ‹©æ‚¨çš„ç®—åŠ›æ–¹æ¡ˆ</h1>
        <p className="text-lg text-slate-600 font-medium max-w-2xl mx-auto mb-3">
          ä»å…¥é—¨åˆ°ä¼ä¸šçº§ï¼Œæ»¡è¶³ä¸åŒè§„æ¨¡çš„ AI æ¨ç†éœ€æ±‚
        </p>
        <div className="inline-flex items-center gap-2 bg-amber-50 text-amber-700 px-4 py-2 rounded-full text-sm font-bold border border-amber-100">
          <Coins size={16} /> å…‘æ¢æ¯”ä¾‹ï¼šÂ¥1 = 10,000 Tokens
        </div>
      </div>

      <div className="flex justify-center mb-12">
        <div className="bg-slate-100 p-1.5 rounded-xl inline-flex">
          <button
            onClick={() => setBillingCycle('monthly')}
            className={`px-6 py-2.5 rounded-lg text-sm font-bold transition-all ${
              billingCycle === 'monthly' 
                ? 'bg-white text-indigo-600 shadow-lg' 
                : 'text-slate-500 hover:text-slate-700'
            }`}
          >
            æœˆä»˜
          </button>
          <button
            onClick={() => setBillingCycle('annual')}
            className={`px-6 py-2.5 rounded-lg text-sm font-bold transition-all ${
              billingCycle === 'annual' 
                ? 'bg-white text-indigo-600 shadow-lg' 
                : 'text-slate-500 hover:text-slate-700'
            }`}
          >
            å¹´ä»˜ <span className="text-xs text-emerald-600 ml-1">çœ 23%</span>
          </button>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
        {plans.map((plan, idx) => (
          <div 
            key={idx}
            className={`relative bg-white rounded-lg p-8 border-2 ${isCurrentPlan(plan) ? 'ring-2 ring-indigo-400 ' : ''}${plan.color} flex flex-col`}
          >
            {plan.popular && (
              <div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-indigo-600 text-white px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-widest">
                æœ€å…·æ€§ä»·æ¯”
              </div>
            )}
            {isCurrentPlan(plan) && (
              <div className="absolute -top-4 right-4 bg-emerald-500 text-white px-3 py-1 rounded-full text-xs font-bold">
                å½“å‰æ–¹æ¡ˆ
              </div>
            )}
            
            <div className="text-center mb-6">
              <h3 className="text-xl font-black text-slate-900 mb-2">{plan.name}</h3>
              <p className="text-sm text-slate-500 font-medium">{plan.description}</p>
            </div>

            <div className="text-center mb-6">
              <div className="flex items-baseline justify-center gap-1">
                <span className="text-2xl md:text-4xl font-black text-slate-900">{plan.price}</span>
                <span className="text-slate-500 font-medium">{plan.period}</span>
              </div>
              <div className="mt-3 py-2 px-3 bg-slate-50 rounded-lg inline-block">
                <span className="text-sm font-bold text-slate-700">{plan.tokenQuota} Tokens/æœˆ</span>
                <span className="block text-[11px] text-slate-400 mt-0.5">{plan.tokenValue}</span>
              </div>
            </div>

            <div className="flex-1 space-y-4 mb-8">
              {plan.features.map((feature, fIdx) => (
                <div key={fIdx} className="flex items-start gap-3">
                  <CheckCircle2 
                    size={18} 
                    className={feature.included ? 'text-emerald-500 flex-shrink-0 mt-0.5' : 'text-slate-300 flex-shrink-0 mt-0.5'} 
                  />
                  <div className="flex-1">
                    <span className={`text-sm font-medium ${feature.included ? 'text-slate-700' : 'text-slate-400'}`}>
                      {feature.name}
                    </span>
                    {feature.value && (
                      <span className={`text-xs ml-1 ${feature.included ? 'text-indigo-600 font-semibold' : 'text-slate-400'}`}>
                        {feature.value}
                      </span>
                    )}
                  </div>
                </div>
              ))}
            </div>

            <button
              onClick={() => isCurrentPlan(plan) ? undefined : handleUpgrade(plan.name)}
              disabled={isCurrentPlan(plan) || upgrading}
              className={`w-full py-4 rounded-xl font-bold text-sm transition-all ${
                isCurrentPlan(plan) 
                  ? 'bg-slate-100 text-slate-400 cursor-not-allowed' 
                  : upgrading 
                  ? 'bg-slate-200 text-slate-400 cursor-wait' 
                  : plan.btnColor
              }`}
            >
              {upgrading ? (
                <span className="flex items-center justify-center gap-2"><Loader2 size={16} className="animate-spin" /> å¤„ç†ä¸­...</span>
              ) : getButtonLabel(plan)}
            </button>
          </div>
        ))}
      </div>

      {/* é‚€è¯·å¥–åŠ± */}
      <div className="mt-8 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-8 border border-indigo-100">
        <div className="flex items-center justify-between">
          <div>
            <h3 className="text-lg font-black text-slate-900 mb-2 flex items-center gap-2">
              <Gift size={20} className="text-indigo-500" /> é‚€è¯·å¥½å‹ï¼ŒåŒæ–¹è·èµ  Token
            </h3>
            <p className="text-sm text-slate-600">
              æ¯æˆåŠŸé‚€è¯·ä¸€ä½å¥½å‹æ³¨å†Œï¼Œæ‚¨è·å¾— <span className="font-bold text-indigo-600">50,000 tokens</span>ï¼Œå¥½å‹è·å¾— <span className="font-bold text-indigo-600">20,000 tokens</span>
            </p>
          </div>
          <button 
            onClick={() => navigate('/invite')}
            className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 transition-all whitespace-nowrap shadow-lg shadow-indigo-200"
          >
            æŸ¥çœ‹é‚€è¯·ç 
          </button>
        </div>
      </div>

      <div className="mt-8 bg-slate-50 rounded-lg p-8 border border-slate-100">
        <h3 className="text-xl font-black text-slate-900 mb-6 text-center">å¸¸è§é—®é¢˜</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {[
            { q: 'å¦‚ä½•è®¡ç®— Token ç”¨é‡ï¼Ÿ', a: 'Token æŒ‰ç…§è¾“å…¥å’Œè¾“å‡ºçš„æ€»å­—ç¬¦æ•°è®¡ç®—ï¼Œçº¦ 4 ä¸ªå­—ç¬¦ç­‰äº 1 ä¸ª Tokenã€‚æ¯æ¬¡ AI å¯¹è¯çº¦æ¶ˆè€— 500-2,000 tokensï¼Œç®€å†è§£æçº¦ 3,000-5,000 tokensã€‚' },
            { q: 'è¶…å‡ºå…è´¹é¢åº¦æ€ä¹ˆåŠï¼Ÿ', a: 'è¶…å‡ºå…è´¹é¢åº¦åå¯ä»¥è´­ä¹°å……å€¼å¥—é¤ç»§ç»­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥é‚€è¯·å¥½å‹è·å¾—å…è´¹ Token å¥–åŠ±ã€‚' },
            { q: 'å……å€¼çš„ Token ä¼šè¿‡æœŸå—ï¼Ÿ', a: 'å……å€¼è´­ä¹°çš„ Token æ°¸ä¸è¿‡æœŸã€‚æ¯æœˆå…è´¹é¢åº¦åœ¨æœˆåº•é‡ç½®ï¼Œä¸ç´¯ç§¯åˆ°ä¸‹æœˆã€‚' },
            { q: 'Â¥1 èƒ½åšä»€ä¹ˆï¼Ÿ', a: 'Â¥1 = 10,000 tokensï¼Œçº¦å¯è¿›è¡Œ 12 æ¬¡ AI å¯¹è¯ï¼Œæˆ– 2 æ¬¡ç®€å†è§£æï¼Œæˆ– 5 æ¬¡èŒä½åŒ¹é…ï¼Œæˆ– 1 æ¬¡å®Œæ•´çš„å¸‚åœºè–ªèµ„åˆ†æã€‚' },
            { q: 'é‚€è¯·å¥–åŠ±æœ‰ä¸Šé™å—ï¼Ÿ', a: 'æ²¡æœ‰ä¸Šé™ï¼æ¯é‚€è¯·ä¸€ä½å¥½å‹æˆåŠŸæ³¨å†Œï¼Œæ‚¨è·å¾— 50,000 tokensï¼Œå¥½å‹è·å¾— 20,000 tokensï¼Œé‚€è¯·è¶Šå¤šå¥–åŠ±è¶Šå¤šã€‚' },
            { q: 'æ”¯æŒç§æœ‰åŒ–éƒ¨ç½²å—ï¼Ÿ', a: 'æš‚ä¸æ”¯æŒç§æœ‰éƒ¨ç½²ï¼ŒUltra ç‰ˆæœ¬æ”¯æŒæ¨¡å‹å®šåˆ¶åŒ–å¾®è°ƒï¼Œæ»¡è¶³ä¼ä¸šä¸ªæ€§åŒ–éœ€æ±‚ã€‚' },
          ].map((faq, i) => (
            <div key={i} className="bg-white rounded-lg p-6 border border-slate-100">
              <h4 className="font-bold text-slate-900 mb-2">{faq.q}</h4>
              <p className="text-sm text-slate-600 font-medium">{faq.a}</p>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

// --- äººæ‰ç«¯ä¸»å·¥ä½œå° ---
const CandidateView = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const userId = user?.id || 0;
  
  // ä½¿ç”¨ API è·å–æ•°æ®
  const { data: recommendedJobs, loading: jobsLoading } = useRecommendedJobs(5);
  const { data: memories, loading: memoriesLoading } = useMemories(userId, 'candidate');
  const { data: candidateFlows } = useFlows(100, userId || undefined);
  const { data: candidateTokenStats } = useTokenStats(userId);


  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
        <div>
          <h1 className="text-2xl md:text-4xl font-black text-slate-900 tracking-tight leading-tight">äººæ‰æ–¹</h1>
          <p className="text-slate-500 font-medium">AI æ±‚èŒæ™ºèƒ½ä½“æ­£åœ¨ä¸ºæ‚¨å…¨å¤©å€™å·¥ä½œ</p>
        </div>
        <div className="flex gap-4">
          <button 
            onClick={() => navigate('/candidate/profile')} 
            className="bg-white border border-slate-200 text-slate-900 px-6 py-3.5 rounded font-black text-sm flex items-center gap-2 hover:bg-slate-50 transition-all shadow-sm"
          >
            <UserCircle2 size={20} className="text-indigo-600" /> äººæ‰ä¸»é¡µ
          </button>
          <button 
            onClick={() => navigate('/candidate/apply')}
            className="bg-indigo-600 text-white px-8 py-3.5 rounded font-black text-sm flex items-center gap-2 shadow-xl shadow-indigo-200 active:scale-95 transition-all"
          >
            <Rocket size={20}/> å¼€å§‹æ±‚èŒ
          </button>
        </div>
      </div>

      <div className="w-full bg-white p-8 rounded-lg border border-slate-100 card-shadow relative overflow-hidden mb-12">
        <div className="absolute top-0 right-0 p-8 opacity-5"><Brain size={120} /></div>
        <div className="flex justify-between items-center mb-6 relative z-10">
            <h3 className="text-xl font-black flex items-center gap-3 text-slate-900">
              <Database size={20} className="text-indigo-500" /> ä¸ªäººè®°å¿† Memory
            </h3>
            <button 
              onClick={() => navigate('/candidate/memory')}
              className="px-3 py-1.5 bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 rounded text-xs font-black text-indigo-600 flex items-center gap-1.5 transition-all active:scale-95 group"
            >
              <Pin size={12} className="group-hover:rotate-45 transition-transform" /> è®°å¿†ç®¡ç†
            </button>
          </div>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 relative z-10">
          {memoriesLoading ? (
            <div className="col-span-4 flex justify-center py-4"><Loader2 className="animate-spin text-indigo-600" size={24} /></div>
          ) : memories.length === 0 ? (
            <div className="col-span-4 text-center py-8 text-slate-400">
              <Database size={32} className="mx-auto mb-2 opacity-50" />
              <p className="text-sm font-medium">æš‚æ— ä¸ªäººè®°å¿†</p>
              <button 
                onClick={() => navigate('/candidate/memory')}
                className="mt-2 text-indigo-600 text-xs font-bold hover:underline"
              >
                ç‚¹å‡»æ·»åŠ ç¬¬ä¸€æ¡è®°å¿†
              </button>
            </div>
          ) : memories.map((memory: any) => {
            const tagColors: Record<string, string> = {
              'åå¥½': 'bg-purple-100 text-purple-700', 'ç»éªŒ': 'bg-amber-100 text-amber-700', 'æŠ€èƒ½': 'bg-emerald-100 text-emerald-700',
              'æŠ€æœ¯': 'bg-indigo-100 text-indigo-700', 'æ–‡åŒ–': 'bg-rose-100 text-rose-700', 'è¦æ±‚': 'bg-orange-100 text-orange-700',
              'ç­–ç•¥': 'bg-fuchsia-100 text-fuchsia-700', 'ç¦åˆ©': 'bg-cyan-100 text-cyan-700', 'åŠ¨ä½œ': 'bg-violet-100 text-violet-700',
              'è–ªé…¬': 'bg-green-100 text-green-700', 'åœ°ç‚¹': 'bg-sky-100 text-sky-700', 'ç›®æ ‡': 'bg-rose-100 text-rose-700',
              'æ±‡æŠ¥': 'bg-violet-100 text-violet-700', 'å›¢é˜Ÿ': 'bg-teal-100 text-teal-700', 'é¡¹ç›®': 'bg-amber-100 text-amber-700',
              'å…¬å¸': 'bg-blue-100 text-blue-700',
            };
            const tagColor = tagColors[memory.type] || 'bg-slate-100 text-slate-600';
            return (
            <div key={memory.id} className="p-4 rounded-lg border border-slate-200 bg-slate-50">
              <div className="flex justify-between items-center mb-2">
                <span className={`text-xs font-black uppercase tracking-wider px-2 py-0.5 rounded ${tagColor}`}>{memory.type}</span>
                <span className="text-xs text-slate-400 font-mono">{memory.date}</span>
              </div>
              <p className="text-sm text-slate-600 leading-relaxed line-clamp-2" title={memory.content}>{memory.content}</p>
            </div>
            );
          })}
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-12">
        <div className="lg:col-span-8 space-y-10">
          <div className="bg-white p-8 rounded-lg border border-slate-100 card-shadow">
            <h2 className="text-2xl font-black mb-6 flex items-center gap-3 text-slate-900">
              <div className="p-2 bg-indigo-100 rounded-lg text-indigo-600"><Briefcase size={20} /></div>
              ä¼ä¸šå²—ä½åº“æ¨è
            </h2>
            <p className="text-slate-500 text-sm font-medium mb-6">åŸºäºæ‚¨çš„èŒä¸šç”»åƒï¼ŒAI æ™ºèƒ½ä½“ä¸ºæ‚¨åŒ¹é…äº†ä»¥ä¸‹ä¼˜è´¨å²—ä½</p>
              
              <div className="space-y-4">
                {jobsLoading ? (
                  <div className="flex justify-center py-8"><Loader2 className="animate-spin text-indigo-600" size={32} /></div>
                ) : recommendedJobs.map((job: any) => (
                  <div key={job.id} onClick={() => navigate(`/candidate/job/${job.id}`)} className="group p-6 bg-slate-50 hover:bg-indigo-50/50 rounded border border-slate-100 hover:border-indigo-200 transition-all cursor-pointer">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                      <div className="flex items-start gap-4">
                        <div className="w-14 h-14 bg-white rounded flex items-center justify-center shadow-sm border border-slate-100 text-2xl font-bold">
                          {job.logo || 'ğŸ’¼'}
                        </div>
                        <div>
                          <h3 className="text-lg font-black text-slate-900 group-hover:text-indigo-700 transition-colors">{job.title}</h3>
                          <p className="text-slate-600 font-medium">{job.company} Â· {job.location || 'å…¨å›½'}</p>
                          <div className="flex flex-wrap gap-2 mt-2">
                            <span className="px-3 py-1 bg-white rounded-lg text-xs font-bold text-slate-600 border border-slate-200">{job.salary || 'é¢è®®'}</span>
                            <span className="px-3 py-1 bg-indigo-100 rounded-lg text-xs font-bold text-indigo-700">{job.match || 85}% åŒ¹é…åº¦</span>
                            {(job.tags || []).map((tag: string, i: number) => (
                              <span key={i} className="px-3 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-500">{tag}</span>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                    <div className="mt-4 pt-4 border-t border-slate-100">
                      <p className="text-sm text-slate-500 font-medium flex items-center gap-2">
                        <Zap size={14} className="text-amber-500" />
                        AI æ™ºèƒ½ä½“å¯¹æ¥è¯´æ˜ï¼š{job.aiIntro || 'AI æ™ºèƒ½ä½“æ­£åœ¨åˆ†æèŒä½åŒ¹é…åº¦'}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
              
              <button 
                onClick={() => navigate('/candidate/jobs')}
                className="w-full mt-6 bg-slate-50 hover:bg-slate-100 text-slate-600 py-4 rounded font-black text-sm flex items-center justify-center gap-2 transition-all border border-slate-200 border-dashed"
              >
                <ArrowRight size={18} /> æŸ¥çœ‹å…¨éƒ¨æ¨èå²—ä½
              </button>
            </div>

        </div>

        <div className="lg:col-span-4 space-y-10">
          <div className="mb-12">
            <div className="bg-white rounded-lg border border-slate-100 card-shadow overflow-hidden">
              <div className="grid grid-cols-1 divide-y divide-slate-100">
                {[
                  { label: 'AIæŠ•é€’', value: `${(candidateFlows || []).length} æ¬¡`, icon: Send, color: 'text-indigo-600', bg: 'bg-indigo-50' },
                  { label: 'æ¨èå²—ä½', value: `${recommendedJobs.length} ä¸ª`, icon: Briefcase, color: 'text-indigo-600', bg: 'bg-indigo-50' },
                  { label: 'Token ä½™é¢', value: candidateTokenStats?.balance_display || '0', icon: Cpu, color: 'text-amber-500', bg: 'bg-amber-50' }
                ].map((card, i) => (
                  <div key={i} className="p-6">
                    <AnimatedStatItem 
                      value={card.value} 
                      label={card.label} 
                      icon={card.icon} 
                      color={card.color} 
                      bg={card.bg} 
                      delay={i * 150} 
                    />
                  </div>
                ))}
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  );
};

// --- äººæ‰ä¸ªäººä¸»é¡µ (CandidateHomeView) ---
const CandidateHomeView = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const profile = location.state?.profile as CandidateProfile;

  if (!profile) return (
    <div className="pt-20 text-center animate-in fade-in">
       <Loader2 className="animate-spin mx-auto text-indigo-600 mb-4" size={48} />
       <p className="text-slate-500 font-black">æ­£åœ¨åŠ è½½æ‚¨çš„ä¸ªæ€§åŒ–ä¸»é¡µ...</p>
       <button onClick={() => navigate('/candidate')} className="mt-8 bg-indigo-600 text-white px-8 py-3 rounded font-black">è¿”å›æ§åˆ¶å°</button>
    </div>
  );

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-7xl mx-auto animate-in fade-in duration-500">
      <div className="flex items-center justify-between mb-12">
        <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-slate-500 hover:text-indigo-600 font-black transition-colors">
          <ChevronLeft size={20} /> è¿”å›æ§åˆ¶å°
        </button>
        <button className="bg-indigo-600 text-white px-6 py-3 rounded font-black flex items-center gap-2 shadow-xl active:scale-95 transition-all">
          <Share2 size={18} /> åˆ†äº«æˆ‘çš„ä¸ªäººä¸»é¡µ
        </button>
      </div>

      <div className="mb-8">
        <button onClick={() => navigate('/candidate/memory')} className="group w-full bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white px-8 py-6 rounded-lg font-black text-xl flex items-center justify-center gap-3 shadow-2xl shadow-indigo-200 active:scale-98 transition-all">
          <Brain size={28} /> ä¸ªäººè®°å¿† Memory
          <ChevronRight size={24} className="group-hover:translate-x-1 transition-transform" />
        </button>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-12">
        <div className="lg:col-span-8 space-y-12">
          {/* é¡¶æ ä¸ªäººä¿¡æ¯ */}
          <div className="bg-white rounded p-6 md:p-12 border border-slate-100 card-shadow flex flex-col md:flex-row gap-6 md:gap-10 items-center">
            <div className="w-40 h-40 bg-indigo-600 text-white flex items-center justify-center text-5xl font-black rounded-lg shadow-2xl ring-8 ring-indigo-50">
              {profile.name.charAt(0)}
            </div>
            <div className="flex-1 text-center md:text-left">
              <h1 className="text-5xl font-black text-slate-900 tracking-tight mb-2">{profile.name}</h1>
              <p className="text-2xl text-indigo-600 font-black mb-6">{profile.role} Â· {profile.experienceYears} å¹´å®æˆ˜ç»éªŒ</p>
              <div className="flex flex-wrap gap-2 justify-center md:justify-start">
                {profile.skills.map((s, i) => (
                  <span key={i} className="px-4 py-2 bg-slate-50 text-slate-500 text-xs font-bold rounded border border-slate-100">{s}</span>
                ))}
              </div>
            </div>
          </div>

          {/* èŒä¸šæ¦‚è§ˆä¸ç†æƒ³ç”»åƒ */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div className="bg-indigo-600 text-white rounded p-10 shadow-2xl">
              <h3 className="text-xl font-black mb-6 flex items-center gap-2"><Sparkles size={20} /> èŒä¸šç»¼è¿°</h3>
              <p className="text-lg leading-relaxed text-indigo-50 font-medium italic">â€œ{profile.summary}â€</p>
            </div>
            <div className="bg-white rounded p-10 border border-slate-100 card-shadow">
              <h3 className="text-xl font-black text-indigo-600 mb-6 flex items-center gap-2"><Eye size={20} /> ç†æƒ³å·¥ä½œç”»åƒ</h3>
              <p className="text-lg leading-relaxed text-slate-700 font-bold italic">â€œ{profile.idealJobPersona}â€</p>
            </div>
          </div>

          {/* è¯¦ç»†æŠ€èƒ½ä¸æ™‹å‡è·¯å¾„ */}
          <div className="bg-white rounded p-6 md:p-12 border border-slate-100 card-shadow">
            <h3 className="text-2xl font-black text-slate-900 mb-10 flex items-center gap-3"><TrendingUp className="text-indigo-600" /> AI å»ºè®®çš„èŒä¸šæ™‹å‡è·¯å¾„</h3>
            <div className="space-y-8 relative before:absolute before:left-[19px] before:top-4 before:bottom-4 before:w-0.5 before:bg-slate-100">
               {profile.careerPath?.map((step, i) => (
                  <div key={i} className="relative pl-12">
                     <div className="absolute left-0 top-1 w-10 h-10 rounded-full bg-white border-4 border-indigo-600 flex items-center justify-center text-indigo-600 font-black z-10">{i + 1}</div>
                     <h4 className="text-xl font-black text-slate-900 mb-2">{step.role} <span className="text-sm font-bold text-slate-400 ml-4">{step.timeframe}</span></h4>
                     <p className="text-slate-500 font-medium">{step.requirement}</p>
                  </div>
               ))}
            </div>
          </div>
        </div>

        <div className="lg:col-span-4 space-y-12">
           {/* é›·è¾¾å›¾ */}
           <div className="bg-white rounded p-10 border border-slate-100 card-shadow">
              <h3 className="text-xl font-black text-slate-900 mb-8 flex items-center gap-2"><BarChart3 className="text-indigo-600" /> æ ¸å¿ƒç«äº‰åŠ›é›·è¾¾å›¾</h3>
              <RadarChart data={profile.radarData} />
           </div>

           {/* æ™ºèƒ½ä½“åé¦ˆ */}
           <div className="bg-indigo-600 text-white rounded p-10 shadow-2xl">
              <h3 className="text-xl font-black mb-8 flex items-center gap-2"><Users className="text-indigo-400" /> å¤šæ™ºèƒ½ä½“ä¸“å®¶è¯„ä»·</h3>
              <div className="space-y-8">
                 {profile.agentFeedbacks?.map((fb, i) => (
                    <div key={i} className="space-y-2">
                       <div className="flex justify-between items-center">
                          <span className="text-xs font-black text-indigo-300 uppercase tracking-widest">{fb.agentName}</span>
                          <span className="text-lg font-black">{fb.score}</span>
                       </div>
                       <p className="text-sm text-slate-400 leading-relaxed font-medium italic">â€œ{fb.comment}â€</p>
                    </div>
                 ))}
              </div>
           </div>
        </div>
      </div>
    </div>
  );
};

// --- ä¼ä¸šè®°å¿† Memory è¯¦æƒ…é¡µ ---
const EnterpriseMemoryView = () => {
  const navigate = useNavigate();
  const { user, isLoggedIn, userRole } = useAuth();
  const [activeCategory, setActiveCategory] = useState('å…¨éƒ¨');
  const [deleteConfirm, setDeleteConfirm] = useState<{show: boolean; memoryId: number | null; content: string}>({show: false, memoryId: null, content: ''});
  const [deleting, setDeleting] = useState(false);
  
  // æ·»åŠ /ç¼–è¾‘å¼¹çª—
  const [memoryModal, setMemoryModal] = useState<{show: boolean; mode: 'add' | 'edit'; id?: number; type: string; content: string; importance: string}>({
    show: false, mode: 'add', type: 'requirement', content: '', importance: 'Medium'
  });
  const [saving, setSaving] = useState(false);
  
  // è®°å¿†ç±»å‹é€‰é¡¹ï¼ˆä¼ä¸šç”»åƒï¼‰
  const memoryTypeOptions: { id: string; label: string; icon: React.ReactNode; color: string }[] = [
    { id: 'culture', label: 'æ–‡åŒ–', icon: <Building2 size={18} />, color: 'text-rose-500' },
    { id: 'tech', label: 'æŠ€æœ¯', icon: <Code size={18} />, color: 'text-indigo-500' },
    { id: 'requirement', label: 'è¦æ±‚', icon: <ClipboardCheck size={18} />, color: 'text-orange-500' },
    { id: 'strategy', label: 'ç­–ç•¥', icon: <Target size={18} />, color: 'text-fuchsia-500' },
    { id: 'benefit', label: 'ç¦åˆ©', icon: <Gift size={18} />, color: 'text-cyan-500' },
    { id: 'action', label: 'åŠ¨ä½œ', icon: <Zap size={18} />, color: 'text-violet-500' },
    { id: 'preference', label: 'åå¥½', icon: <Star size={18} />, color: 'text-purple-500' },
    { id: 'experience', label: 'ç»éªŒ', icon: <Briefcase size={18} />, color: 'text-amber-500' },
  ];
  
  // ä¸­æ–‡ç±»å‹å â†’ è‹±æ–‡ type çš„åå‘æ˜ å°„
  const typeNameToId: Record<string, string> = {};
  memoryTypeOptions.forEach(t => { typeNameToId[t.label] = t.id; });
  
  // ä½¿ç”¨ API è·å–ä¼ä¸šç”»åƒè®°å¿†æ•°æ® (scope = 'employer')
  const userId = user?.id || 1;
  const { data: memoriesData, loading: memoriesLoading, refetch: refetchMemories } = useMemories(userId, 'employer');

  // å¦‚æœæœªç™»å½•æˆ–ä¸æ˜¯ä¼ä¸šæ–¹ï¼Œæ˜¾ç¤ºæç¤º
  useEffect(() => {
    if (isLoggedIn && userRole !== 'employer') {
      // éä¼ä¸šç”¨æˆ·è®¿é—®ä¼ä¸šç”»åƒï¼Œå¯é€‰æ‹©è·³è½¬
    }
  }, [isLoggedIn, userRole]);

  const filteredMemories = useMemo(() => {
    if (activeCategory === 'å…¨éƒ¨') return memoriesData;
    return memoriesData.filter((m: any) => m.type === activeCategory || m.type?.toUpperCase() === activeCategory.toUpperCase());
  }, [activeCategory, memoriesData]);
  
  // ä¿å­˜è®°å¿†ï¼ˆæ·»åŠ /ç¼–è¾‘ï¼‰
  const handleSaveMemory = async () => {
    if (!memoryModal.content.trim()) return;
    setSaving(true);
    try {
      if (memoryModal.mode === 'edit' && memoryModal.id) {
        const { updateMemory } = await import('./services/apiService');
        await updateMemory(memoryModal.id, {
          type: memoryModal.type,
          content: memoryModal.content.trim(),
          importance: memoryModal.importance,
          scope: 'employer',
        });
      } else {
        const { createMemory } = await import('./services/apiService');
        await createMemory({
          type: memoryModal.type,
          content: memoryModal.content.trim(),
          importance: memoryModal.importance,
          scope: 'employer',
        }, userId);
      }
      refetchMemories();
      setMemoryModal({ show: false, mode: 'add', type: 'requirement', content: '', importance: 'Medium' });
    } catch (e) {
      console.error('ä¿å­˜è®°å¿†å¤±è´¥:', e);
    } finally {
      setSaving(false);
    }
  };
  
  // åˆ é™¤è®°å¿†
  const handleDeleteMemory = async () => {
    if (!deleteConfirm.memoryId) return;
    setDeleting(true);
    try {
      const { deleteMemory } = await import('./services/apiService');
      await deleteMemory(deleteConfirm.memoryId);
      refetchMemories();
      setDeleteConfirm({show: false, memoryId: null, content: ''});
    } catch (e) {
      console.error('åˆ é™¤è®°å¿†å¤±è´¥:', e);
    } finally {
      setDeleting(false);
    }
  };
  
  // è®°å¿†ä¼˜åŒ–
  const [optimizing, setOptimizing] = useState(false);
  const [optimizeResult, setOptimizeResult] = useState<{show: boolean; message: string; actions: any[]; summary: any} | null>(null);
  
  const handleOptimizeMemories = async () => {
    setOptimizing(true);
    try {
      const { optimizeMemories } = await import('./services/apiService');
      const result = await optimizeMemories(userId, 'employer');
      setOptimizeResult({
        show: true,
        message: result.message,
        actions: result.actions || [],
        summary: result.summary || {}
      });
      refetchMemories();
    } catch (e) {
      console.error('è®°å¿†ä¼˜åŒ–å¤±è´¥:', e);
      setOptimizeResult({
        show: true,
        message: 'è®°å¿†ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
        actions: [],
        summary: {}
      });
    } finally {
      setOptimizing(false);
    }
  };

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-500">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
        <div>
           <h1 className="text-3xl font-black text-slate-900 flex items-center gap-4">
             <div className="p-3 bg-indigo-600 text-white rounded shadow-xl shadow-indigo-100"><Brain size={28} /></div>
             ä¼ä¸šè®°å¿† Memory
           </h1>
           <p className="text-slate-500 font-medium mt-2">Devnors Agent æŒç»­å­¦ä¹ å¹¶å›ºåŒ–çš„ä¼ä¸šæ‹›è˜åå¥½ä¸æ–‡åŒ–åŸºå› </p>
        </div>
        <div className="flex gap-3">
          <button 
            onClick={handleOptimizeMemories}
            disabled={optimizing || memoriesLoading}
            className="bg-amber-500 text-white px-6 py-3 rounded text-sm font-black flex items-center gap-2 shadow-lg hover:bg-amber-600 transition-all active:scale-95 disabled:opacity-50"
          >
            {optimizing ? <Loader2 className="animate-spin" size={18} /> : <Wand2 size={18} />}
            {optimizing ? 'AI ä¼˜åŒ–ä¸­...' : 'è®°å¿†ä¼˜åŒ–'}
          </button>
          <button 
            onClick={() => setMemoryModal({ show: true, mode: 'add', type: 'requirement', content: '', importance: 'Medium' })}
            className="bg-indigo-600 text-white px-6 py-3 rounded text-sm font-black flex items-center gap-2 shadow-lg hover:bg-indigo-700 transition-all active:scale-95"
          >
             <Plus size={18} /> æ·»åŠ æ–°è®°å¿†
          </button>
        </div>
      </div>

      {/* åŠ è½½çŠ¶æ€ */}
      {memoriesLoading && (
        <div className="flex items-center justify-center py-12">
          <Loader2 className="animate-spin text-indigo-600" size={32} />
          <span className="ml-3 text-slate-500 font-medium">åŠ è½½ä¼ä¸šè®°å¿†ä¸­...</span>
        </div>
      )}

      {/* åˆ†ç±» Tab */}
      <div className="flex flex-wrap gap-2 mb-6 bg-white rounded-xl p-2 border border-slate-100 shadow-sm">
        {['å…¨éƒ¨', 'æ–‡åŒ–', 'æŠ€æœ¯', 'è¦æ±‚', 'ç­–ç•¥', 'åŠ¨ä½œ', 'ç¦åˆ©', 'åå¥½'].map((cat) => (
          <button 
            key={cat}
            onClick={() => setActiveCategory(cat)}
            className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${activeCategory === cat ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-50 hover:text-indigo-600'}`}
          >
            {cat}
          </button>
        ))}
      </div>

      <div>
           {!memoriesLoading && filteredMemories.length === 0 ? (
              <div className="bg-white rounded-lg border border-dashed border-slate-200 p-16 flex flex-col items-center justify-center text-center">
                <div className="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center mb-5">
                  <Brain size={32} className="text-indigo-400" />
                </div>
                <h3 className="text-lg font-bold text-slate-700 mb-2">æš‚æ— ä¼ä¸šè®°å¿†</h3>
                <p className="text-sm text-slate-400 mb-6 max-w-sm leading-relaxed">AI Agent ä¼šåœ¨æ‹›è˜å¯¹è¯ä¸­è‡ªåŠ¨æç‚¼è®°å¿†ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ·»åŠ æ‹›è˜åå¥½ã€ä¼ä¸šæ–‡åŒ–ç­‰ä¿¡æ¯ï¼Œè®© Agent æ›´æ‡‚æ‚¨çš„éœ€æ±‚</p>
                <div className="flex gap-3">
                  <button
                    onClick={() => setMemoryModal({ show: true, mode: 'add', type: 'requirement', content: '', importance: 'Medium' })}
                    className="bg-indigo-600 text-white px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-indigo-700 transition-all active:scale-95"
                  >
                    <Plus size={16} /> æ‰‹åŠ¨æ·»åŠ è®°å¿†
                  </button>
                </div>
              </div>
           ) : (
           <div className="grid grid-cols-1 gap-6">
              {filteredMemories.map((memory) => {
                const tagColors: Record<string, string> = {
                  'åå¥½': 'bg-purple-100 text-purple-700', 'ç»éªŒ': 'bg-amber-100 text-amber-700', 'æŠ€èƒ½': 'bg-emerald-100 text-emerald-700',
                  'æŠ€æœ¯': 'bg-indigo-100 text-indigo-700', 'æ–‡åŒ–': 'bg-rose-100 text-rose-700', 'è¦æ±‚': 'bg-orange-100 text-orange-700',
                  'ç­–ç•¥': 'bg-fuchsia-100 text-fuchsia-700', 'ç¦åˆ©': 'bg-cyan-100 text-cyan-700', 'åŠ¨ä½œ': 'bg-violet-100 text-violet-700',
                  'è–ªé…¬': 'bg-green-100 text-green-700', 'åœ°ç‚¹': 'bg-sky-100 text-sky-700', 'ç›®æ ‡': 'bg-rose-100 text-rose-700',
                  'æ±‡æŠ¥': 'bg-violet-100 text-violet-700', 'å›¢é˜Ÿ': 'bg-teal-100 text-teal-700', 'é¡¹ç›®': 'bg-amber-100 text-amber-700',
                  'å…¬å¸': 'bg-blue-100 text-blue-700',
                };
                const tagColor = tagColors[memory.type] || 'bg-slate-100 text-slate-600';
                return (
                <div key={memory.id} className="bg-white p-6 rounded-lg border border-slate-100 card-shadow group hover:border-indigo-200 transition-all">
                   <div className="flex items-center gap-2.5 mb-3">
                      <span className={`px-3 py-1 rounded-full text-xs font-black uppercase tracking-wider ${tagColor}`}>
                        {memory.type}
                      </span>
                      <span className="text-xs font-bold text-slate-400">{memory.date} å›ºåŒ–</span>
                      <span className={`px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1 ${(memory.emphasis_count || 1) > 1 ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-500'}`} title="è®°å¿†å¼ºåº¦ï¼šæåŠæ¬¡æ•°è¶Šå¤šï¼Œè®°å¿†è¶Šæ·±åˆ»">
                        <Zap size={10} /> å¼ºåº¦ Ã—{memory.emphasis_count || 1}
                      </span>
                   </div>
                   <p className="text-sm text-slate-700 font-normal leading-relaxed mb-4">
                     {memory.content}
                   </p>
                   <div className="bg-slate-50 rounded-lg p-4 border border-slate-100 mb-4">
                      <h5 className="text-xs font-black text-slate-400 uppercase tracking-wider mb-1.5 flex items-center gap-1.5">
                        <Brain size={12} className="text-indigo-400" /> Agent æ¨ç†é€»è¾‘
                      </h5>
                      <p className="text-xs text-slate-500 font-normal leading-relaxed">
                        {memory.ai_reasoning || ({
                          requirement: 'åŸºäºç”¨æˆ·åœ¨å¯¹è¯ä¸­æ˜ç¡®æå‡ºçš„æ‹›è˜è¦æ±‚å›ºåŒ–ï¼Œåç»­ç”Ÿæˆå²—ä½ã€ç­›é€‰å€™é€‰äººæ—¶å°†è‡ªåŠ¨éµå¾ªæ­¤è§„åˆ™ã€‚',
                          culture: 'ä»ç”¨æˆ·æè¿°ä¸­æå–çš„ä¼ä¸šæ–‡åŒ–ä¸å·¥ä½œæ–¹å¼åå¥½ï¼Œå°†å½±å“å²—ä½æè¿°ä¸­çš„å›¢é˜Ÿæ°›å›´å’Œå·¥ä½œç¯å¢ƒéƒ¨åˆ†ã€‚',
                          tech: 'ç”¨æˆ·æŒ‡å®šçš„æŠ€æœ¯æ ˆåå¥½æˆ–æŠ€æœ¯è¦æ±‚ï¼Œåç»­å²—ä½ç”Ÿæˆå’Œå€™é€‰äººåŒ¹é…æ—¶å°†ä¼˜å…ˆåŒ¹é…æ­¤æŠ€æœ¯æ–¹å‘ã€‚',
                          strategy: 'ä»ç”¨æˆ·æ“ä½œä¸­æç‚¼çš„æ‹›è˜ç­–ç•¥ä¸é¢è¯•æ–¹æ³•è®ºï¼Œå°†æŒ‡å¯¼ Agent åç»­çš„æ‹›è˜æµç¨‹å’Œå€™é€‰äººè¯„ä¼°ã€‚',
                          benefit: 'ç”¨æˆ·è®¾å®šçš„ç¦åˆ©å¾…é‡æ ‡å‡†ï¼Œç”Ÿæˆå²—ä½æ—¶å°†è‡ªåŠ¨é™„å¸¦æ­¤ç¦åˆ©ä¿¡æ¯ï¼Œæå‡å²—ä½å¸å¼•åŠ›ã€‚',
                          action: 'åŸºäºç”¨æˆ·æ“ä½œè¡Œä¸ºå’ŒæŒ‡ä»¤è®°å½•çš„åŠ¨ä½œåå¥½ï¼ŒAgent åç»­æ‰§è¡Œç›¸ä¼¼ä»»åŠ¡æ—¶å°†å‚è€ƒæ­¤æ¨¡å¼ã€‚',
                          preference: 'ç”¨æˆ·çš„é€šç”¨æ‹›è˜åå¥½ï¼Œè´¯ç©¿æ‰€æœ‰å²—ä½ç”Ÿæˆå’Œå€™é€‰äººç­›é€‰ç¯èŠ‚ã€‚',
                          experience: 'ç”¨æˆ·å¯¹å€™é€‰äººç»éªŒçš„è¦æ±‚æ ‡å‡†ï¼ŒåŒ¹é…å€™é€‰äººæ—¶å°†ä»¥æ­¤ä½œä¸ºæ ¸å¿ƒç­›é€‰ç»´åº¦ã€‚',
                        } as Record<string, string>)[memory.raw_type] || 'ç‚¹å‡»ã€Œè®°å¿†ä¼˜åŒ–ã€ä¸ºæ­¤æ¡è®°å¿†ç”Ÿæˆ Agent æ¨ç†é€»è¾‘ã€‚'}
                      </p>
                      {memory.version_history && memory.version_history.length > 0 && (
                        <div className="mt-2 pt-2 border-t border-slate-200 flex items-center gap-3 flex-wrap">
                          <span className="text-xs font-black text-slate-400 uppercase tracking-wider flex items-center gap-1">
                            <History size={10} /> ç‰ˆæœ¬è®°å½• ({memory.version_history.length})
                          </span>
                          {memory.version_history.slice(-3).map((v: any, vi: number) => (
                            <span key={vi} className="text-xs text-slate-400">
                              <span className="font-bold text-slate-500">v{v.version}</span>
                              <span className="mx-1">Â·</span>
                              <span>{v.date}</span>
                            </span>
                          ))}
                        </div>
                      )}
                   </div>
                   <div className="flex items-center gap-3 text-xs font-bold text-slate-400 uppercase tracking-wider">
                      <button 
                        onClick={() => {
                          const typeId = memory.raw_type || typeNameToId[memory.type] || 'preference';
                          setMemoryModal({
                            show: true,
                            mode: 'edit',
                            id: memory.id,
                            type: typeId,
                            content: memory.content,
                            importance: memory.importance || 'Medium',
                          });
                        }}
                        className="flex items-center gap-1.5 hover:text-indigo-600 transition-colors"
                      >
                        <Edit3 size={12} /> ç¼–è¾‘
                      </button>
                      <button 
                        onClick={() => setDeleteConfirm({show: true, memoryId: memory.id, content: memory.content})}
                        className="flex items-center gap-1.5 hover:text-rose-600 transition-colors"
                      >
                        <Trash2 size={12} /> åˆ é™¤
                      </button>
                   </div>
                </div>
                );
              })}
           </div>
           )}
      </div>
      
      {/* æ·»åŠ /ç¼–è¾‘è®°å¿†å¼¹çª— */}
      {memoryModal.show && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-in fade-in duration-200">
          <div className="bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-2xl animate-in zoom-in-95 duration-200 max-h-[85vh] overflow-y-auto">
            <div className="flex items-center gap-3 mb-5">
              <div className="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                {memoryModal.mode === 'add' ? <Plus className="text-indigo-600" size={20} /> : <Edit3 className="text-indigo-600" size={20} />}
              </div>
              <h3 className="text-lg font-black text-slate-900">{memoryModal.mode === 'add' ? 'æ·»åŠ æ–°è®°å¿†' : 'ç¼–è¾‘è®°å¿†'}</h3>
            </div>
            
            {/* ç±»å‹é€‰æ‹© */}
            <div className="mb-4">
              <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">è®°å¿†ç±»å‹</label>
              <div className="grid grid-cols-4 gap-2">
                {memoryTypeOptions.map(opt => (
                  <button
                    key={opt.id}
                    onClick={() => setMemoryModal(prev => ({ ...prev, type: opt.id }))}
                    className={`p-2.5 rounded-lg border-2 transition-all text-center flex flex-col items-center gap-1 ${
                      memoryModal.type === opt.id 
                        ? 'border-indigo-600 bg-indigo-50' 
                        : 'border-slate-100 hover:border-slate-200'
                    }`}
                  >
                    <div className={memoryModal.type === opt.id ? 'text-indigo-600' : opt.color}>{opt.icon}</div>
                    <div className="text-xs font-bold text-slate-700">{opt.label}</div>
                  </button>
                ))}
              </div>
            </div>
            
            {/* å†…å®¹ */}
            <div className="mb-4">
              <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">è®°å¿†å†…å®¹</label>
              <textarea
                value={memoryModal.content}
                onChange={(e) => setMemoryModal(prev => ({ ...prev, content: e.target.value }))}
                placeholder="è¯·è¾“å…¥è®°å¿†å†…å®¹ï¼Œä¾‹å¦‚ï¼šæ‹›è˜è–ªèµ„èŒƒå›´ç»Ÿä¸€ä¸º15-30K..."
                className="w-full h-28 bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-300 transition-all resize-none"
              />
            </div>
            
            <div className="flex gap-3">
              <button 
                onClick={() => setMemoryModal({ show: false, mode: 'add', type: 'requirement', content: '', importance: 'Medium' })}
                className="flex-1 px-4 py-2.5 border border-slate-200 rounded-lg font-bold text-slate-600 hover:bg-slate-50 transition-colors"
                disabled={saving}
              >
                å–æ¶ˆ
              </button>
              <button 
                onClick={handleSaveMemory}
                disabled={saving || !memoryModal.content.trim()}
                className="flex-1 px-4 py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
              >
                {saving ? <Loader2 className="animate-spin" size={16} /> : <Check size={16} />}
                {saving ? 'ä¿å­˜ä¸­...' : memoryModal.mode === 'add' ? 'æ·»åŠ è®°å¿†' : 'ä¿å­˜ä¿®æ”¹'}
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* åˆ é™¤ç¡®è®¤å¼¹çª— */}
      {deleteConfirm.show && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-in fade-in duration-200">
          <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl animate-in zoom-in-95 duration-200">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-10 h-10 bg-rose-100 rounded-full flex items-center justify-center">
                <AlertTriangle className="text-rose-600" size={20} />
              </div>
              <h3 className="text-lg font-black text-slate-900">ç¡®è®¤åˆ é™¤è®°å¿†</h3>
            </div>
            <p className="text-slate-600 mb-2">æ‚¨ç¡®å®šè¦åˆ é™¤ä»¥ä¸‹è®°å¿†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
            <div className="bg-slate-50 rounded-lg p-3 mb-6">
              <p className="text-sm text-slate-700 italic">"{deleteConfirm.content?.substring(0, 100)}{(deleteConfirm.content?.length || 0) > 100 ? '...' : ''}"</p>
            </div>
            <div className="flex gap-3">
              <button 
                onClick={() => setDeleteConfirm({show: false, memoryId: null, content: ''})}
                className="flex-1 px-4 py-2.5 border border-slate-200 rounded-lg font-bold text-slate-600 hover:bg-slate-50 transition-colors"
                disabled={deleting}
              >
                å–æ¶ˆ
              </button>
              <button 
                onClick={handleDeleteMemory}
                disabled={deleting}
                className="flex-1 px-4 py-2.5 bg-rose-600 text-white rounded-lg font-bold hover:bg-rose-700 transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
              >
                {deleting ? <Loader2 className="animate-spin" size={16} /> : <Trash2 size={16} />}
                {deleting ? 'åˆ é™¤ä¸­...' : 'ç¡®è®¤åˆ é™¤'}
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* è®°å¿†ä¼˜åŒ–ç»“æœå¼¹çª— */}
      {optimizeResult?.show && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-in fade-in duration-200">
          <div className="bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-2xl animate-in zoom-in-95 duration-200 max-h-[80vh] overflow-y-auto">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center">
                <Wand2 className="text-amber-600" size={20} />
              </div>
              <h3 className="text-lg font-black text-slate-900">è®°å¿†ä¼˜åŒ–å®Œæˆ</h3>
            </div>
            <p className="text-slate-600 mb-4">{optimizeResult.message}</p>
            
            {optimizeResult.summary && (
              <div className="grid grid-cols-3 gap-2 mb-4">
                <div className="bg-indigo-50 rounded-lg p-2 text-center">
                  <div className="text-lg font-black text-indigo-600">{optimizeResult.summary.merged || 0}</div>
                  <div className="text-[10px] text-indigo-500 font-medium">åˆå¹¶</div>
                </div>
                <div className="bg-emerald-50 rounded-lg p-2 text-center">
                  <div className="text-lg font-black text-emerald-600">{optimizeResult.summary.reclassified || 0}</div>
                  <div className="text-[10px] text-emerald-500 font-medium">é‡åˆ†ç±»</div>
                </div>
                <div className="bg-purple-50 rounded-lg p-2 text-center">
                  <div className="text-lg font-black text-purple-600">{optimizeResult.summary.reasoning_updated || 0}</div>
                  <div className="text-[10px] text-purple-500 font-medium">æ¨ç†æ›´æ–°</div>
                </div>
              </div>
            )}
            
            {optimizeResult.actions && optimizeResult.actions.length > 0 && (
              <div className="bg-slate-50 rounded-lg p-3 mb-4 max-h-48 overflow-y-auto">
                <h4 className="text-xs font-black text-slate-400 uppercase mb-2">ä¼˜åŒ–è¯¦æƒ…</h4>
                <div className="space-y-2">
                  {optimizeResult.actions.map((action: any, idx: number) => (
                    <div key={idx} className="text-xs text-slate-600 flex items-start gap-2">
                      <span className={`px-1.5 py-0.5 rounded text-white font-bold ${
                        action.action === 'merge' ? 'bg-indigo-500' :
                        action.action === 'reclassify' ? 'bg-emerald-500' : 'bg-purple-500'
                      }`}>
                        {action.action === 'merge' ? 'åˆå¹¶' :
                         action.action === 'reclassify' ? 'é‡åˆ†ç±»' : 'æ¨ç†'}
                      </span>
                      <span className="flex-1">{action.reason}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {(!optimizeResult.actions || optimizeResult.actions.length === 0) && (
              <div className="bg-slate-50 rounded-lg p-4 mb-4 text-center">
                <p className="text-sm text-slate-500">æ‰€æœ‰è®°å¿†å·²æ˜¯æœ€ä¼˜çŠ¶æ€ï¼Œæ— éœ€è°ƒæ•´ã€‚</p>
              </div>
            )}
            
            <button 
              onClick={() => setOptimizeResult(null)}
              className="w-full px-4 py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors"
            >
              å®Œæˆ
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

// --- ä¸ªäººè®°å¿† Memory è¯¦æƒ…é¡µ ---
const CandidateMemoryView = () => {
  const navigate = useNavigate();
  const { user, isLoggedIn, userRole } = useAuth();
  const [activeCategory, setActiveCategory] = useState('å…¨éƒ¨');
  const [deleteConfirm, setDeleteConfirm] = useState<{show: boolean; memoryId: number | null; content: string}>({show: false, memoryId: null, content: ''});
  const [deleting, setDeleting] = useState(false);
  
  // æ·»åŠ /ç¼–è¾‘å¼¹çª—
  const [memoryModal, setMemoryModal] = useState<{show: boolean; mode: 'add' | 'edit'; id?: number; type: string; content: string; importance: string}>({
    show: false, mode: 'add', type: 'skill', content: '', importance: 'Medium'
  });
  const [saving, setSaving] = useState(false);
  
  // è®°å¿†ç±»å‹é€‰é¡¹ï¼ˆäººæ‰ç”»åƒï¼‰
  const memoryTypeOptions: { id: string; label: string; icon: React.ReactNode; color: string }[] = [
    { id: 'skill', label: 'æŠ€èƒ½', icon: <Wrench size={18} />, color: 'text-emerald-500' },
    { id: 'experience', label: 'ç»éªŒ', icon: <Briefcase size={18} />, color: 'text-amber-500' },
    { id: 'preference', label: 'åå¥½', icon: <Star size={18} />, color: 'text-purple-500' },
    { id: 'goal', label: 'ç›®æ ‡', icon: <Target size={18} />, color: 'text-rose-500' },
    { id: 'salary', label: 'è–ªé…¬', icon: <Coins size={18} />, color: 'text-green-500' },
    { id: 'location', label: 'åœ°ç‚¹', icon: <MapPin size={18} />, color: 'text-sky-500' },
    { id: 'tech', label: 'æŠ€æœ¯', icon: <Code size={18} />, color: 'text-indigo-500' },
    { id: 'culture', label: 'æ–‡åŒ–', icon: <Building2 size={18} />, color: 'text-rose-500' },
  ];
  
  const typeNameToId: Record<string, string> = {};
  memoryTypeOptions.forEach(t => { typeNameToId[t.label] = t.id; });

  // ä½¿ç”¨ API è·å–äººæ‰ç”»åƒè®°å¿†æ•°æ® (scope = 'candidate')
  const userId = user?.id || 1;
  const { data: memoriesData, loading: memoriesLoading, refetch: refetchMemories } = useMemories(userId, 'candidate');
  
  // ä¿å­˜è®°å¿†ï¼ˆæ·»åŠ /ç¼–è¾‘ï¼‰
  const handleSaveMemory = async () => {
    if (!memoryModal.content.trim()) return;
    setSaving(true);
    try {
      if (memoryModal.mode === 'edit' && memoryModal.id) {
        const { updateMemory } = await import('./services/apiService');
        await updateMemory(memoryModal.id, {
          type: memoryModal.type,
          content: memoryModal.content.trim(),
          importance: memoryModal.importance,
          scope: 'candidate',
        });
      } else {
        const { createMemory } = await import('./services/apiService');
        await createMemory({
          type: memoryModal.type,
          content: memoryModal.content.trim(),
          importance: memoryModal.importance,
          scope: 'candidate',
        }, userId);
      }
      refetchMemories();
      setMemoryModal({ show: false, mode: 'add', type: 'skill', content: '', importance: 'Medium' });
    } catch (e) {
      console.error('ä¿å­˜è®°å¿†å¤±è´¥:', e);
    } finally {
      setSaving(false);
    }
  };
  
  // åˆ é™¤è®°å¿†
  const handleDeleteMemory = async () => {
    if (!deleteConfirm.memoryId) return;
    setDeleting(true);
    try {
      const { deleteMemory } = await import('./services/apiService');
      await deleteMemory(deleteConfirm.memoryId);
      refetchMemories();
      setDeleteConfirm({show: false, memoryId: null, content: ''});
    } catch (e) {
      console.error('åˆ é™¤è®°å¿†å¤±è´¥:', e);
    } finally {
      setDeleting(false);
    }
  };
  
  // è®°å¿†ä¼˜åŒ–
  const [optimizing, setOptimizing] = useState(false);
  const [optimizeResult, setOptimizeResult] = useState<{show: boolean; message: string; actions: any[]; summary: any} | null>(null);
  
  const handleOptimizeMemories = async () => {
    setOptimizing(true);
    try {
      const { optimizeMemories } = await import('./services/apiService');
      const result = await optimizeMemories(userId, 'candidate');
      setOptimizeResult({
        show: true,
        message: result.message,
        actions: result.actions || [],
        summary: result.summary || {}
      });
      refetchMemories();
    } catch (e) {
      console.error('è®°å¿†ä¼˜åŒ–å¤±è´¥:', e);
      setOptimizeResult({
        show: true,
        message: 'è®°å¿†ä¼˜åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
        actions: [],
        summary: {}
      });
    } finally {
      setOptimizing(false);
    }
  };

  const filteredMemories = useMemo(() => {
    if (activeCategory === 'å…¨éƒ¨') return memoriesData;
    return memoriesData.filter((m: any) => m.type === activeCategory || m.type?.toUpperCase() === activeCategory.toUpperCase());
  }, [activeCategory, memoriesData]);

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-500">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
        <div>
           <h1 className="text-3xl font-black text-slate-900 flex items-center gap-4">
             <div className="p-3 bg-indigo-600 text-white rounded shadow-xl shadow-indigo-100"><Brain size={28} /></div>
             ä¸ªäººè®°å¿† Memory
           </h1>
           <p className="text-slate-500 font-medium mt-2">Devnors Agent æŒç»­å­¦ä¹ å¹¶å›ºåŒ–çš„äººæ‰èƒ½åŠ›ã€æŠ€èƒ½åå¥½ä¸èŒä¸šå‘å±•è½¨è¿¹</p>
        </div>
        <div className="flex gap-3">
          <button 
            onClick={handleOptimizeMemories}
            disabled={optimizing || memoriesLoading}
            className="bg-amber-500 text-white px-6 py-3 rounded text-sm font-black flex items-center gap-2 shadow-lg hover:bg-amber-600 transition-all active:scale-95 disabled:opacity-50"
          >
            {optimizing ? <Loader2 className="animate-spin" size={18} /> : <Wand2 size={18} />}
            {optimizing ? 'AI ä¼˜åŒ–ä¸­...' : 'è®°å¿†ä¼˜åŒ–'}
          </button>
          <button 
            onClick={() => setMemoryModal({ show: true, mode: 'add', type: 'skill', content: '', importance: 'Medium' })}
            className="bg-indigo-600 text-white px-6 py-3 rounded text-sm font-black flex items-center gap-2 shadow-lg hover:bg-indigo-700 transition-all active:scale-95"
          >
             <Plus size={18} /> æ·»åŠ æ–°è®°å¿†
          </button>
        </div>
      </div>

      {/* åŠ è½½çŠ¶æ€ */}
      {memoriesLoading && (
        <div className="flex items-center justify-center py-12">
          <Loader2 className="animate-spin text-indigo-600" size={32} />
          <span className="ml-3 text-slate-500 font-medium">åŠ è½½äººæ‰è®°å¿†ä¸­...</span>
        </div>
      )}

      {/* åˆ†ç±» Tab */}
      <div className="flex flex-wrap gap-2 mb-6 bg-white rounded-xl p-2 border border-slate-100 shadow-sm">
        {['å…¨éƒ¨', 'æŠ€èƒ½', 'ç»éªŒ', 'åå¥½', 'ç›®æ ‡', 'è–ªé…¬', 'åœ°ç‚¹', 'æŠ€æœ¯'].map((cat) => (
          <button 
            key={cat}
            onClick={() => setActiveCategory(cat)}
            className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${activeCategory === cat ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-50 hover:text-indigo-600'}`}
          >
            {cat}
          </button>
        ))}
      </div>

      <div>
           {!memoriesLoading && filteredMemories.length === 0 ? (
              <div className="bg-white rounded-lg border border-dashed border-slate-200 p-16 flex flex-col items-center justify-center text-center">
                <div className="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center mb-5">
                  <Brain size={32} className="text-indigo-400" />
                </div>
                <h3 className="text-lg font-bold text-slate-700 mb-2">æš‚æ— ä¸ªäººè®°å¿†</h3>
                <p className="text-sm text-slate-400 mb-6 max-w-sm leading-relaxed">AI Agent ä¼šåœ¨ä¸æ‚¨å¯¹è¯çš„è¿‡ç¨‹ä¸­è‡ªåŠ¨æç‚¼è®°å¿†ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ·»åŠ æŠ€èƒ½ã€åå¥½ç­‰ä¿¡æ¯ï¼Œå¸®åŠ© Agent æ›´ç²¾å‡†åœ°ç†è§£æ‚¨</p>
                <div className="flex gap-3">
                  <button
                    onClick={() => setMemoryModal({ show: true, mode: 'add', type: 'skill', content: '', importance: 'Medium' })}
                    className="bg-indigo-600 text-white px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-indigo-700 transition-all active:scale-95"
                  >
                    <Plus size={16} /> æ‰‹åŠ¨æ·»åŠ è®°å¿†
                  </button>
                </div>
              </div>
           ) : (
           <div className="grid grid-cols-1 gap-6">
              {filteredMemories.map((memory) => {
                const tagColors: Record<string, string> = {
                  'åå¥½': 'bg-purple-100 text-purple-700', 'ç»éªŒ': 'bg-amber-100 text-amber-700', 'æŠ€èƒ½': 'bg-emerald-100 text-emerald-700',
                  'æŠ€æœ¯': 'bg-indigo-100 text-indigo-700', 'æ–‡åŒ–': 'bg-rose-100 text-rose-700', 'è¦æ±‚': 'bg-orange-100 text-orange-700',
                  'ç­–ç•¥': 'bg-fuchsia-100 text-fuchsia-700', 'ç¦åˆ©': 'bg-cyan-100 text-cyan-700', 'åŠ¨ä½œ': 'bg-violet-100 text-violet-700',
                  'è–ªé…¬': 'bg-green-100 text-green-700', 'åœ°ç‚¹': 'bg-sky-100 text-sky-700', 'ç›®æ ‡': 'bg-rose-100 text-rose-700',
                  'æ±‡æŠ¥': 'bg-violet-100 text-violet-700', 'å›¢é˜Ÿ': 'bg-teal-100 text-teal-700', 'é¡¹ç›®': 'bg-amber-100 text-amber-700',
                  'å…¬å¸': 'bg-blue-100 text-blue-700',
                };
                const tagColor = tagColors[memory.type] || 'bg-slate-100 text-slate-600';
                return (
                <div key={memory.id} className="bg-white p-6 rounded-lg border border-slate-100 card-shadow group hover:border-indigo-200 transition-all">
                   <div className="flex items-center gap-2.5 mb-3">
                      <span className={`px-3 py-1 rounded-full text-xs font-black uppercase tracking-wider ${tagColor}`}>
                        {memory.type}
                      </span>
                      <span className="text-xs font-bold text-slate-400">{memory.date} å›ºåŒ–</span>
                      <span className={`px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1 ${(memory.emphasis_count || 1) > 1 ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-500'}`} title="è®°å¿†å¼ºåº¦ï¼šæåŠæ¬¡æ•°è¶Šå¤šï¼Œè®°å¿†è¶Šæ·±åˆ»">
                        <Zap size={10} /> å¼ºåº¦ Ã—{memory.emphasis_count || 1}
                      </span>
                   </div>
                   <p className="text-sm text-slate-700 font-normal leading-relaxed mb-4">
                     {memory.content}
                   </p>
                   <div className="bg-slate-50 rounded-lg p-4 border border-slate-100 mb-4">
                      <h5 className="text-xs font-black text-slate-400 uppercase tracking-wider mb-1.5 flex items-center gap-1.5">
                        <Brain size={12} className="text-indigo-400" /> Agent æ¨ç†é€»è¾‘
                      </h5>
                      <p className="text-xs text-slate-500 font-normal leading-relaxed">
                        {memory.ai_reasoning || ({
                          skill: 'ä»ç”¨æˆ·ç®€å†æˆ–å¯¹è¯ä¸­è¯†åˆ«çš„æ ¸å¿ƒæŠ€èƒ½ï¼Œå°†ç”¨äºå²—ä½åŒ¹é…æ—¶çš„èƒ½åŠ›è¯„ä¼°å’Œæ¨èæ’åºã€‚',
                          experience: 'ç”¨æˆ·çš„å·¥ä½œç»å†è®°å½•ï¼ŒåŒ¹é…å²—ä½æ—¶å°†å¯¹ç…§ç»éªŒå¹´é™å’Œè¡Œä¸šèƒŒæ™¯è¿›è¡Œç²¾å‡†æ¨èã€‚',
                          preference: 'ç”¨æˆ·è¡¨è¾¾çš„æ±‚èŒåå¥½ï¼Œè¿‡æ»¤æ¨èå²—ä½æ—¶ä¼˜å…ˆæ»¡è¶³è¿™äº›æ¡ä»¶ã€‚',
                          goal: 'ç”¨æˆ·çš„èŒä¸šå‘å±•ç›®æ ‡ï¼Œæ¨èå²—ä½æ—¶å°†è€ƒè™‘å²—ä½çš„æˆé•¿ç©ºé—´æ˜¯å¦åŒ¹é…ç”¨æˆ·é•¿æœŸè§„åˆ’ã€‚',
                          salary: 'ç”¨æˆ·çš„è–ªé…¬æœŸæœ›åŒºé—´ï¼Œæ¨èå²—ä½æ—¶è‡ªåŠ¨è¿‡æ»¤è–ªèµ„ä¸åŒ¹é…çš„æœºä¼šã€‚',
                          location: 'ç”¨æˆ·çš„å·¥ä½œåœ°ç‚¹åå¥½ï¼Œæ¨èå²—ä½æ—¶ä¼˜å…ˆæ¨èç¬¦åˆåœ°ç‚¹è¦æ±‚çš„æœºä¼šã€‚',
                          tech: 'ç”¨æˆ·æŒæ¡çš„æŠ€æœ¯æ ˆï¼ŒåŒ¹é…å²—ä½æ—¶å°†ä»¥æŠ€æœ¯å¥‘åˆåº¦ä½œä¸ºæ ¸å¿ƒæ¨èä¾æ®ã€‚',
                          culture: 'ç”¨æˆ·åå¥½çš„å·¥ä½œæ–‡åŒ–ä¸å›¢é˜Ÿæ°›å›´ï¼Œæ¨èæ—¶å€¾å‘åŒ¹é…æ–‡åŒ–å¥‘åˆçš„ä¼ä¸šã€‚',
                        } as Record<string, string>)[memory.raw_type] || 'ç‚¹å‡»ã€Œè®°å¿†ä¼˜åŒ–ã€ä¸ºæ­¤æ¡è®°å¿†ç”Ÿæˆ Agent æ¨ç†é€»è¾‘ã€‚'}
                      </p>
                      {memory.version_history && memory.version_history.length > 0 && (
                        <div className="mt-2 pt-2 border-t border-slate-200 flex items-center gap-3 flex-wrap">
                          <span className="text-xs font-black text-indigo-500 uppercase tracking-wider flex items-center gap-1">
                            <History size={10} /> ç‰ˆæœ¬è®°å½• ({memory.version_history.length})
                          </span>
                          {memory.version_history.slice(-3).map((v: any, vi: number) => (
                            <span key={vi} className="text-xs text-slate-400">
                              <span className="font-bold text-slate-500">v{v.version}</span>
                              <span className="mx-1">Â·</span>
                              <span>{v.date}</span>
                            </span>
                          ))}
                        </div>
                      )}
                   </div>
                   <div className="flex items-center gap-3 text-xs font-bold text-slate-400 uppercase tracking-wider">
                      <button 
                        onClick={() => {
                          const typeId = memory.raw_type || typeNameToId[memory.type] || 'preference';
                          setMemoryModal({
                            show: true,
                            mode: 'edit',
                            id: memory.id,
                            type: typeId,
                            content: memory.content,
                            importance: memory.importance || 'Medium',
                          });
                        }}
                        className="flex items-center gap-1.5 hover:text-indigo-600 transition-colors"
                      >
                        <Edit3 size={12} /> ç¼–è¾‘
                      </button>
                      <button 
                        onClick={() => setDeleteConfirm({show: true, memoryId: memory.id, content: memory.content})}
                        className="flex items-center gap-1.5 hover:text-rose-600 transition-colors"
                      >
                        <Trash2 size={12} /> åˆ é™¤
                      </button>
                   </div>
                </div>
                );
              })}
           </div>
           )}
      </div>
      
      {/* æ·»åŠ /ç¼–è¾‘è®°å¿†å¼¹çª— */}
      {memoryModal.show && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-in fade-in duration-200">
          <div className="bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-2xl animate-in zoom-in-95 duration-200 max-h-[85vh] overflow-y-auto">
            <div className="flex items-center gap-3 mb-5">
              <div className="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                {memoryModal.mode === 'add' ? <Plus className="text-indigo-600" size={20} /> : <Edit3 className="text-indigo-600" size={20} />}
              </div>
              <h3 className="text-lg font-black text-slate-900">{memoryModal.mode === 'add' ? 'æ·»åŠ æ–°è®°å¿†' : 'ç¼–è¾‘è®°å¿†'}</h3>
            </div>
            
            <div className="mb-4">
              <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">è®°å¿†ç±»å‹</label>
              <div className="grid grid-cols-4 gap-2">
                {memoryTypeOptions.map(opt => (
                  <button
                    key={opt.id}
                    onClick={() => setMemoryModal(prev => ({ ...prev, type: opt.id }))}
                    className={`p-2.5 rounded-lg border-2 transition-all text-center flex flex-col items-center gap-1 ${
                      memoryModal.type === opt.id 
                        ? 'border-indigo-600 bg-indigo-50' 
                        : 'border-slate-100 hover:border-slate-200'
                    }`}
                  >
                    <div className={memoryModal.type === opt.id ? 'text-indigo-600' : opt.color}>{opt.icon}</div>
                    <div className="text-xs font-bold text-slate-700">{opt.label}</div>
                  </button>
                ))}
              </div>
            </div>
            
            <div className="mb-4">
              <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">è®°å¿†å†…å®¹</label>
              <textarea
                value={memoryModal.content}
                onChange={(e) => setMemoryModal(prev => ({ ...prev, content: e.target.value }))}
                placeholder="è¯·è¾“å…¥è®°å¿†å†…å®¹ï¼Œä¾‹å¦‚ï¼šç†Ÿç»ƒæŒæ¡Reactå’ŒTypeScript..."
                className="w-full h-28 bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-300 transition-all resize-none"
              />
            </div>
            
            <div className="flex gap-3">
              <button 
                onClick={() => setMemoryModal({ show: false, mode: 'add', type: 'skill', content: '', importance: 'Medium' })}
                className="flex-1 px-4 py-2.5 border border-slate-200 rounded-lg font-bold text-slate-600 hover:bg-slate-50 transition-colors"
                disabled={saving}
              >
                å–æ¶ˆ
              </button>
              <button 
                onClick={handleSaveMemory}
                disabled={saving || !memoryModal.content.trim()}
                className="flex-1 px-4 py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
              >
                {saving ? <Loader2 className="animate-spin" size={16} /> : <Check size={16} />}
                {saving ? 'ä¿å­˜ä¸­...' : memoryModal.mode === 'add' ? 'æ·»åŠ è®°å¿†' : 'ä¿å­˜ä¿®æ”¹'}
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* åˆ é™¤ç¡®è®¤å¼¹çª— */}
      {deleteConfirm.show && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-in fade-in duration-200">
          <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl animate-in zoom-in-95 duration-200">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-10 h-10 bg-rose-100 rounded-full flex items-center justify-center">
                <AlertTriangle className="text-rose-600" size={20} />
              </div>
              <h3 className="text-lg font-black text-slate-900">ç¡®è®¤åˆ é™¤è®°å¿†</h3>
            </div>
            <p className="text-slate-600 mb-2">æ‚¨ç¡®å®šè¦åˆ é™¤ä»¥ä¸‹è®°å¿†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
            <div className="bg-slate-50 rounded-lg p-3 mb-6">
              <p className="text-sm text-slate-700 italic">"{deleteConfirm.content?.substring(0, 100)}{(deleteConfirm.content?.length || 0) > 100 ? '...' : ''}"</p>
            </div>
            <div className="flex gap-3">
              <button 
                onClick={() => setDeleteConfirm({show: false, memoryId: null, content: ''})}
                className="flex-1 px-4 py-2.5 border border-slate-200 rounded-lg font-bold text-slate-600 hover:bg-slate-50 transition-colors"
                disabled={deleting}
              >
                å–æ¶ˆ
              </button>
              <button 
                onClick={handleDeleteMemory}
                disabled={deleting}
                className="flex-1 px-4 py-2.5 bg-rose-600 text-white rounded-lg font-bold hover:bg-rose-700 transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
              >
                {deleting ? <Loader2 className="animate-spin" size={16} /> : <Trash2 size={16} />}
                {deleting ? 'åˆ é™¤ä¸­...' : 'ç¡®è®¤åˆ é™¤'}
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* è®°å¿†ä¼˜åŒ–ç»“æœå¼¹çª— */}
      {optimizeResult?.show && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-in fade-in duration-200">
          <div className="bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-2xl animate-in zoom-in-95 duration-200 max-h-[80vh] overflow-y-auto">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center">
                <Wand2 className="text-amber-600" size={20} />
              </div>
              <h3 className="text-lg font-black text-slate-900">è®°å¿†ä¼˜åŒ–å®Œæˆ</h3>
            </div>
            <p className="text-slate-600 mb-4">{optimizeResult.message}</p>
            
            {optimizeResult.summary && (
              <div className="grid grid-cols-3 gap-2 mb-4">
                <div className="bg-indigo-50 rounded-lg p-2 text-center">
                  <div className="text-lg font-black text-indigo-600">{optimizeResult.summary.merged || 0}</div>
                  <div className="text-[10px] text-indigo-500 font-medium">åˆå¹¶</div>
                </div>
                <div className="bg-emerald-50 rounded-lg p-2 text-center">
                  <div className="text-lg font-black text-emerald-600">{optimizeResult.summary.reclassified || 0}</div>
                  <div className="text-[10px] text-emerald-500 font-medium">é‡åˆ†ç±»</div>
                </div>
                <div className="bg-purple-50 rounded-lg p-2 text-center">
                  <div className="text-lg font-black text-purple-600">{optimizeResult.summary.reasoning_updated || 0}</div>
                  <div className="text-[10px] text-purple-500 font-medium">æ¨ç†æ›´æ–°</div>
                </div>
              </div>
            )}
            
            {optimizeResult.actions && optimizeResult.actions.length > 0 && (
              <div className="bg-slate-50 rounded-lg p-3 mb-4 max-h-48 overflow-y-auto">
                <h4 className="text-xs font-black text-slate-400 uppercase mb-2">ä¼˜åŒ–è¯¦æƒ…</h4>
                <div className="space-y-2">
                  {optimizeResult.actions.map((action: any, idx: number) => (
                    <div key={idx} className="text-xs text-slate-600 flex items-start gap-2">
                      <span className={`px-1.5 py-0.5 rounded text-white font-bold ${
                        action.action === 'merge' ? 'bg-indigo-500' :
                        action.action === 'reclassify' ? 'bg-emerald-500' : 'bg-purple-500'
                      }`}>
                        {action.action === 'merge' ? 'åˆå¹¶' :
                         action.action === 'reclassify' ? 'é‡åˆ†ç±»' : 'æ¨ç†'}
                      </span>
                      <span className="flex-1">{action.reason}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {(!optimizeResult.actions || optimizeResult.actions.length === 0) && (
              <div className="bg-slate-50 rounded-lg p-4 mb-4 text-center">
                <p className="text-sm text-slate-500">æ‰€æœ‰è®°å¿†å·²æ˜¯æœ€ä¼˜çŠ¶æ€ï¼Œæ— éœ€è°ƒæ•´ã€‚</p>
              </div>
            )}
            
            <button 
              onClick={() => setOptimizeResult(null)}
              className="w-full px-4 py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-colors"
            >
              å®Œæˆ
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

// --- å²—ä½è¯¦æƒ…é¡µ ---
const JobDetailView = () => {
  const { jobId } = useParams();
  const navigate = useNavigate();
  const loc = useLocation();
  const { user } = useAuth();
  const userId = user?.id || 0;
  
  const passedJob = loc.state?.job as Job | undefined;
  
  const recommendedJob = RECOMMENDED_JOBS.find(j => j.id === Number(jobId));
  const mockJob = MOCK_JOBS.find(j => j.id === jobId);
  
  const isMockJob = !!passedJob || (!recommendedJob && !!mockJob);
  const displayJob = passedJob || mockJob || recommendedJob || RECOMMENDED_JOBS[0];

  // AI æŠ•é€’çŠ¶æ€
  const [applying, setApplying] = useState(false);
  const [applied, setApplied] = useState(false);
  const [applyDetail, setApplyDetail] = useState<any>(null);
  const [applyResult, setApplyResult] = useState<any>(null);

  useEffect(() => {
    if (!userId || !jobId) return;
    fetch(`/api/v1/public/my-applies?user_id=${userId}`)
      .then(r => r.ok ? r.json() : null)
      .then(data => {
        if (data?.success && data.applies) {
          const detail = data.applies[String(jobId)];
          if (detail) {
            setApplied(true);
            setApplyDetail(detail);
          }
        }
      })
      .catch(() => {});
  }, [userId, jobId]);

  const handleApply = async () => {
    if (applied || applying) return;
    setApplying(true);
    setApplyResult(null);
    try {
      const res = await fetch('/api/v1/public/quick-apply', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ job_id: Number(jobId), user_id: userId }),
      });
      const data = await res.json();
      if (data.success) {
        setApplied(true);
        setApplyDetail({ job_id: Number(jobId), flow_id: data.flow_id, job_title: data.job_title, match_score: data.match_score, details: data.ai_reason || '' });
        setApplyResult({ success: true, ...data });
      } else {
        setApplyResult({ success: false, message: data.error || 'æŠ•é€’å¤±è´¥' });
      }
    } catch {
      setApplyResult({ success: false, message: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•' });
    }
    setApplying(false);
    setTimeout(() => setApplyResult(null), 5000);
  };
  
  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-500">
      <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-slate-500 hover:text-emerald-600 font-black transition-colors mb-8">
        <ChevronLeft size={20} /> è¿”å›
      </button>
      
      <div className="bg-white rounded-lg border border-slate-100 card-shadow overflow-hidden">
        <div className={`p-10 text-white ${isMockJob ? 'bg-indigo-600' : 'bg-gradient-to-r from-emerald-600 to-teal-600'}`}>
          <div className="flex items-start gap-6">
            {isMockJob ? (
              <div className="w-20 h-20 bg-white rounded-lg flex items-center justify-center text-indigo-600 shadow-lg">
                <Building2 size={40} />
              </div>
            ) : (
              <div className="w-20 h-20 bg-white rounded flex items-center justify-center text-4xl shadow-lg">
                {'logo' in displayJob ? displayJob.logo : 'ğŸ’¼'}
              </div>
            )}
            <div className="flex-1">
              <h1 className="text-3xl font-black mb-2">{displayJob.title}</h1>
              <p className={`${isMockJob ? 'text-indigo-200' : 'text-emerald-100'} text-xl font-medium mb-4`}>
                {('company' in displayJob ? (displayJob as Job).company : (displayJob as any).company)} Â· {displayJob.location}
              </p>
              <div className="flex flex-wrap gap-3">
                <span className="px-4 py-2 bg-white/20 backdrop-blur-sm rounded font-bold">{displayJob.salary}</span>
                <span className="px-4 py-2 bg-white/20 backdrop-blur-sm rounded font-bold">
                  {'match' in displayJob ? displayJob.match : ('matchScore' in displayJob ? displayJob.matchScore : 95)}% åŒ¹é…åº¦
                </span>
              </div>
            </div>
            {applied ? (
              <div className="relative group/apply">
                <span className="bg-white/20 backdrop-blur-sm text-white px-8 py-4 rounded font-black flex items-center gap-2 shadow-xl cursor-default">
                  <CheckCircle2 size={20} /> å·²æŠ•é€’
                </span>
                {applyDetail && (
                  <div
                    onClick={() => navigate(`/workbench/flow/${applyDetail.flow_id}`)}
                    className="absolute right-0 top-full mt-2 w-64 bg-slate-900 text-white rounded-xl shadow-2xl p-4 z-50 opacity-0 invisible group-hover/apply:opacity-100 group-hover/apply:visible transition-all duration-200 text-xs cursor-pointer hover:bg-slate-800"
                  >
                    <div className="flex items-center gap-1.5 font-bold mb-2 text-emerald-300">
                      <CheckCircle2 size={12} /> AI æŠ•é€’è¯¦æƒ…
                    </div>
                    <p className="text-slate-300 mb-1">å²—ä½ï¼š<span className="text-indigo-300 font-bold">{applyDetail.job_title}</span></p>
                    <span className="bg-emerald-500/20 text-emerald-300 px-1.5 py-0.5 rounded text-[10px] font-bold">åŒ¹é…åº¦ {applyDetail.match_score}%</span>
                    {applyDetail.details && <p className="text-slate-400 mt-1.5">{applyDetail.details}</p>}
                    <p className="text-indigo-400 mt-2 font-bold flex items-center gap-1">æŸ¥çœ‹æŠ•é€’è¯¦æƒ… <ChevronRight size={11} /></p>
                    <div className="absolute -top-1.5 right-6 w-3 h-3 bg-slate-900 rotate-45"></div>
                  </div>
                )}
              </div>
            ) : (
              <button
                onClick={handleApply}
                disabled={applying}
                className={`${isMockJob ? 'bg-white text-indigo-600' : 'bg-white text-emerald-600'} px-8 py-4 rounded font-black flex items-center gap-2 shadow-xl hover:scale-105 transition-all disabled:opacity-60`}
              >
                {applying ? <Loader2 size={20} className="animate-spin" /> : <Rocket size={20} />} {applying ? 'AI åˆ†æä¸­...' : 'AI æŠ•é€’'}
              </button>
            )}
          </div>
        </div>
        
        <div className="p-10">
          <div className="mb-10">
            <h3 className="text-xl font-black text-slate-900 mb-4 flex items-center gap-2">
              <Briefcase size={20} className="text-emerald-600" /> èŒä½æè¿°
            </h3>
            <div className="bg-slate-50 rounded p-6 border border-slate-100">
              <p className="text-slate-700 leading-relaxed font-medium">
                {'description' in displayJob && displayJob.description ? displayJob.description : `æˆ‘ä»¬æ­£åœ¨å¯»æ‰¾ä¸€ä½èµ„æ·± ${displayJob.title} åŠ å…¥æˆ‘ä»¬çš„å›¢é˜Ÿã€‚ä½œä¸º ${('company' in displayJob ? (displayJob as Job).company : (displayJob as any).company)} çš„æ ¸å¿ƒæˆå‘˜ï¼Œæ‚¨å°†å‚ä¸é‡è¦é¡¹ç›®çš„è®¾è®¡ä¸å¼€å‘ï¼Œæ¨åŠ¨æŠ€æœ¯åˆ›æ–°ã€‚`}
              </p>
            </div>
          </div>
          
          {'aiIntro' in displayJob && displayJob.aiIntro && (
            <div className="mb-10">
              <h3 className="text-xl font-black text-slate-900 mb-4 flex items-center gap-2">
                <Zap size={20} className="text-amber-500" /> AI æ™ºèƒ½ä½“å¯¹æ¥è¯´æ˜
              </h3>
              <div className="bg-amber-50 rounded p-6 border border-amber-100">
                <p className="text-slate-700 leading-relaxed font-medium">{displayJob.aiIntro}</p>
              </div>
            </div>
          )}
          
          <div className="mb-10">
            <h3 className="text-xl font-black text-slate-900 mb-4 flex items-center gap-2">
              <Tag size={20} className="text-indigo-600" /> æŠ€èƒ½è¦æ±‚
            </h3>
            <div className="flex flex-wrap gap-3">
              {displayJob.tags.map((tag, i) => (
                <span key={i} className="px-4 py-2 bg-indigo-100 text-indigo-700 rounded font-bold">{tag}</span>
              ))}
            </div>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="bg-slate-50 rounded p-6 border border-slate-100">
              <h4 className="font-black text-slate-900 mb-2 flex items-center gap-2">
                <Clock size={18} className="text-emerald-600" /> å‘å¸ƒæ—¶é—´
              </h4>
              <p className="text-slate-600 font-medium">2026-02-10</p>
            </div>
            <div className="bg-slate-50 rounded p-6 border border-slate-100">
              <h4 className="font-black text-slate-900 mb-2 flex items-center gap-2">
                <MapPin size={18} className="text-indigo-600" /> å·¥ä½œåœ°ç‚¹
              </h4>
              <p className="text-slate-600 font-medium">{displayJob.location}</p>
            </div>
          </div>
        </div>
      </div>

      {/* AI æŠ•é€’ç»“æœ Toast */}
      {applyResult && (
        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 animate-in fade-in slide-in-from-bottom-4 duration-300">
          {applyResult.success ? (
            <div className="bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl text-sm max-w-md">
              <div className="flex items-center gap-2 font-bold mb-2">
                <Rocket size={15} className="text-indigo-400" />
                <span>AI æ™ºèƒ½æŠ•é€’å®Œæˆ</span>
              </div>
              <div className="space-y-1 text-slate-300 text-xs">
                <p>å·²æŠ•é€’ã€Œ<span className="text-indigo-300 font-bold">{applyResult.job_title}</span>ã€{applyResult.company && <span className="text-slate-400"> Â· {applyResult.company}</span>}</p>
                <div className="flex items-center gap-3 mt-1.5">
                  <span className="bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded text-xs font-bold">åŒ¹é…åº¦ {applyResult.match_score}%</span>
                  <span className="bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded text-xs font-bold">åŠ å…¥{applyResult.ai_queue || 'AIç­›é€‰é˜Ÿåˆ—'}</span>
                </div>
                {applyResult.ai_reason && <p className="text-slate-400 mt-1">ğŸ’¡ {applyResult.ai_reason}</p>}
                {applyResult.ai_suggestion && <p className="text-amber-400 mt-0.5">ğŸ“ {applyResult.ai_suggestion}</p>}
                {applyResult.tokens_used > 0 && <p className="text-slate-500 mt-1 text-[10px]">æ¶ˆè€— {applyResult.tokens_used} tokens Â· {applyResult.model_name || 'AI'}</p>}
              </div>
            </div>
          ) : (
            <div className="bg-slate-900 text-white px-6 py-3 rounded-xl shadow-2xl text-sm font-bold flex items-center gap-2">
              <XCircle size={16} className="text-red-400" />
              {applyResult.message}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// --- äººæ‰ä¸»é¡µè¯¦æƒ…é¡µ ---
const CandidateProfileView = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const userId = user?.id || 0;
  
  // ä½¿ç”¨åŠ¨æ€æ•°æ®
  const { data: profileData, loading: profileLoading, refetch: refetchProfile } = useProfile(userId, 'candidate');
  
  // è·å– memories æ•°æ®æ¥è¡¥å……æŠ€èƒ½ç­‰ä¿¡æ¯
  const { data: memoriesData } = useMemories(userId, 'candidate');
  
  // è·å–è®¤è¯æ•°æ®ï¼ˆæŠ€èƒ½è®¤è¯ã€å­¦å†è®¤è¯ã€å·¥ä½œè¯æ˜ï¼‰
  const [skillCertifications, setSkillCertifications] = useState<any[]>([]);
  const [educationCertifications, setEducationCertifications] = useState<any[]>([]);
  const [workCertifications, setWorkCertifications] = useState<any[]>([]);
  useEffect(() => {
    if (userId) {
      getPersonalCertifications(userId).then((certs: any[]) => {
        const skillCerts = certs.filter(c => c.category === 'skill');
        const eduCerts = certs.filter(c => c.category === 'education');
        const workCerts = certs.filter(c => c.category === 'work');
        setSkillCertifications(skillCerts);
        setEducationCertifications(eduCerts);
        setWorkCertifications(workCerts);
      }).catch(() => {
        setSkillCertifications([]);
        setEducationCertifications([]);
        setWorkCertifications([]);
      });
    }
  }, [userId]);
  
  // ä» memories ä¸­æå–æŠ€èƒ½
  const skillsFromMemory = useMemo(() => {
    if (!memoriesData) return [];
    return memoriesData
      .filter((m: any) => m.type?.toUpperCase() === 'SKILL' || m.type === 'æŠ€èƒ½')
      .map((m: any) => m.content);
  }, [memoriesData]);
  
  // åˆå¹¶æ•°æ®
  const candidateData = profileData?.candidate_data || {};
  const displayProfile = {
    name: profileData?.display_name || user?.name || 'æœªè®¾ç½®å§“å',
    role: profileData?.title || candidateData?.current_role || 'æœªè®¾ç½®èŒä½',
    experienceYears: candidateData?.experience_years || 0,
    skills: candidateData?.skills?.length > 0 ? candidateData.skills : skillsFromMemory,
    radarData: candidateData?.radar_data || [],
    summary: profileData?.summary || candidateData?.summary || '',
    idealJobPersona: candidateData?.ideal_job || '',
    careerPath: candidateData?.career_path || [],
    // ä» AI åŠ©æ‰‹ä¿å­˜çš„æ•°æ®
    experience: candidateData?.experience || [],  // å·¥ä½œç»å†
    projects: candidateData?.projects || [],      // é¡¹ç›®ç»å†
    education: candidateData?.education || [],    // æ•™è‚²èƒŒæ™¯
    expectedSalary: candidateData?.expected_salary || '',
    expectedLocation: candidateData?.expected_location || '',
    agentFeedbacks: candidateData?.agent_feedbacks || [],
    awards: candidateData?.awards || [],
    certifications: candidateData?.certifications || [],
    credentials: candidateData?.credentials || [],
  };
  
  // åˆ¤æ–­èµ„æ–™æ˜¯å¦ä¸ºç©º
  const isProfileEmpty = profileData?.is_empty || (!displayProfile.summary && displayProfile.skills.length === 0);
  
  // è·³è½¬åˆ° AI åŠ©æ‰‹ç¼–è¾‘èµ„æ–™
  const handleEditProfile = (field: string) => {
    navigate(`/ai-assistant?editType=candidate&editField=${field}`);
  };

  // åŠ è½½çŠ¶æ€
  if (profileLoading) {
    return (
      <div className="pt-20 text-center">
        <Loader2 className="mx-auto text-indigo-600 animate-spin mb-4" size={48} />
        <p className="text-slate-500">åŠ è½½èµ„æ–™ä¸­...</p>
      </div>
    );
  }

  // ç©ºçŠ¶æ€å¼•å¯¼
  if (isProfileEmpty) {
    return (
      <div className="py-6 px-4 md:py-8 md:px-6 max-w-3xl mx-auto animate-in fade-in duration-500">
        <div className="bg-white rounded-lg p-6 md:p-12 border border-slate-100 shadow-xl text-center">
          <div className="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <UserIcon size={48} className="text-indigo-600" />
          </div>
          <h2 className="text-2xl font-black text-slate-900 mb-4">å®Œå–„æ‚¨çš„èŒä¸šç”»åƒ</h2>
          <p className="text-slate-500 mb-8 max-w-md mx-auto">
            æ‚¨è¿˜æ²¡æœ‰è®¾ç½®èŒä¸šç”»åƒä¿¡æ¯ã€‚é€šè¿‡ AI åŠ©æ‰‹å¿«é€Ÿå®Œå–„æ‚¨çš„èµ„æ–™ï¼Œè®©æ›´å¤šæ‹›è˜æ–¹å‘ç°æ‚¨çš„æ‰èƒ½ã€‚
          </p>
          <div className="grid grid-cols-2 gap-4 max-w-lg mx-auto mb-8">
            <button 
              onClick={() => handleEditProfile('skill')}
              className="p-4 bg-indigo-50 hover:bg-indigo-100 rounded-lg text-left transition-all group"
            >
              <Zap className="text-indigo-600 mb-2" size={24} />
              <div className="font-bold text-slate-900">æ·»åŠ æŠ€èƒ½</div>
              <div className="text-xs text-slate-500">æè¿°æ‚¨çš„ä¸“ä¸šæŠ€èƒ½</div>
            </button>
            <button 
              onClick={() => handleEditProfile('experience')}
              className="p-4 bg-emerald-50 hover:bg-emerald-100 rounded-lg text-left transition-all group"
            >
              <Briefcase className="text-emerald-600 mb-2" size={24} />
              <div className="font-bold text-slate-900">å·¥ä½œç»å†</div>
              <div className="text-xs text-slate-500">æ·»åŠ æ‚¨çš„å·¥ä½œç»éªŒ</div>
            </button>
            <button 
              onClick={() => handleEditProfile('goal')}
              className="p-4 bg-amber-50 hover:bg-amber-100 rounded-lg text-left transition-all group"
            >
              <Target className="text-amber-600 mb-2" size={24} />
              <div className="font-bold text-slate-900">èŒä¸šç›®æ ‡</div>
              <div className="text-xs text-slate-500">è®¾å®šæ‚¨çš„æ±‚èŒç›®æ ‡</div>
            </button>
            <button 
              onClick={() => navigate('/ai-assistant?taskType=apply')}
              className="p-4 bg-rose-50 hover:bg-rose-100 rounded-lg text-left transition-all group"
            >
              <FileText className="text-rose-600 mb-2" size={24} />
              <div className="font-bold text-slate-900">ä¸Šä¼ ç®€å†</div>
              <div className="text-xs text-slate-500">AI è‡ªåŠ¨è§£æç®€å†</div>
            </button>
          </div>
          <button 
            onClick={() => navigate('/ai-assistant?taskType=apply')}
            className="bg-indigo-600 text-white px-8 py-4 rounded font-black shadow-xl hover:bg-indigo-700 transition-all"
          >
            å¼€å§‹å®Œå–„èµ„æ–™
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-500">
      {/* é¡¶éƒ¨å¯¼èˆª */}
      <div className="flex items-center justify-end mb-8">
        <div className="flex gap-3">
          <button 
            onClick={() => navigate('/ai-assistant?taskType=apply')}
            className="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 hover:bg-slate-50 transition-all"
          >
            <Edit3 size={16} /> ç¼–è¾‘
          </button>
          <button className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 hover:bg-indigo-700 transition-all">
            <Share2 size={16} /> åˆ†äº«
          </button>
        </div>
      </div>

      {/* ä¸ªäººä¿¡æ¯å¤´éƒ¨ */}
      <div className="bg-gradient-to-r from-indigo-600 to-indigo-500 rounded-lg p-8 mb-8 text-white relative overflow-hidden">
        <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/2"></div>
        <div className="flex items-center gap-6 relative z-10">
          <div className="w-24 h-24 bg-white/20 backdrop-blur text-white flex items-center justify-center text-4xl font-black rounded-xl">
            {displayProfile.name.charAt(0)}
          </div>
          <div className="flex-1">
            <h1 className="text-3xl font-black mb-1">{displayProfile.name}</h1>
            <p className="text-indigo-200 font-medium mb-3">{displayProfile.role || 'æš‚æœªè®¾ç½®èŒä½'}</p>
            <div className="flex flex-wrap gap-2">
              {displayProfile.skills.slice(0, 5).map((skill: string, i: number) => (
                <span key={i} className="px-3 py-1 bg-white/20 backdrop-blur text-white text-xs font-medium rounded-full">{skill}</span>
              ))}
              {displayProfile.skills.length === 0 && (
                <span className="text-indigo-200 text-sm">ç‚¹å‡»ç¼–è¾‘æ·»åŠ æŠ€èƒ½æ ‡ç­¾</span>
              )}
            </div>
          </div>
          <div className="text-right hidden md:block">
            <div className="text-4xl font-black">{displayProfile.experienceYears || 0}<span className="text-lg">å¹´</span></div>
            <div className="text-indigo-200 text-sm">å·¥ä½œç»éªŒ</div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* å·¦ä¾§è¾¹æ  */}
        <div className="space-y-6">
          {/* å…³äºæˆ‘ */}
          {displayProfile.summary && (
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">å…³äºæˆ‘</h3>
              <p className="text-slate-700 text-sm leading-relaxed">{displayProfile.summary}</p>
            </div>
          )}

          {/* æŠ€èƒ½è®¤è¯ */}
          {skillCertifications.length > 0 && (
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">æŠ€èƒ½è®¤è¯</h3>
              <div className="space-y-3">
                {skillCertifications.map((cert, i) => (
                  <div key={cert.id || i} className="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
                    <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                      {cert.name === 'é©¾é©¶è¯' ? <Car size={18} className="text-purple-600" /> : <Award size={18} className="text-purple-600" />}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <span className="font-bold text-slate-900 text-sm truncate">{cert.name}</span>
                        <span className={`px-1.5 py-0.5 text-xs font-bold rounded ${cert.name === 'é©¾é©¶è¯' ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-100 text-blue-600'}`}>
                          {cert.name === 'é©¾é©¶è¯' ? 'å·²è®¤è¯' : 'å·²ä¸Šä¼ '}
                        </span>
                      </div>
                      <p className="text-sm text-slate-500 truncate">
                        {cert.name === 'é©¾é©¶è¯' ? `å‡†é©¾è½¦å‹: ${cert.level || '-'}` : cert.organization || '-'}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        {/* å³ä¾§ä¸»è¦å†…å®¹ */}
        <div className="lg:col-span-2 space-y-6">
          {/* æ•™è‚²èƒŒæ™¯ */}
          <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
            <div className="flex items-center justify-between mb-5">
              <h3 className="text-lg font-black text-slate-900 flex items-center gap-2">
                <GraduationCap size={18} className="text-emerald-600" /> æ•™è‚²èƒŒæ™¯
              </h3>
              <button onClick={() => handleEditProfile('education')} className="text-sm text-emerald-600 hover:underline font-medium">+ æ·»åŠ </button>
            </div>
            
            <div className="space-y-3">
              {/* å·²è®¤è¯çš„å­¦å† */}
              {educationCertifications.map((cert, i) => (
                <div key={cert.id || i} className="flex gap-4 p-4 bg-emerald-50/50 rounded-lg border border-emerald-100">
                  <div className="w-11 h-11 bg-emerald-600 rounded-lg flex items-center justify-center flex-shrink-0">
                    <GraduationCap size={20} className="text-white" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                      <h4 className="font-bold text-slate-900 text-base">{cert.organization || 'å­¦æ ¡åç§°'}</h4>
                      <span className="px-2 py-0.5 bg-emerald-100 text-emerald-600 text-xs font-bold rounded flex items-center gap-1">
                        <BadgeCheck size={12} /> å·²è®¤è¯
                      </span>
                    </div>
                    <p className="text-sm text-emerald-600 font-medium">
                      {cert.major}{(cert.degree || cert.level) && ` Â· ${cert.degree || cert.level}`}
                    </p>
                    {cert.date && <p className="text-sm text-slate-500 mt-1">æ¯•ä¸šæ—¶é—´: {cert.date}</p>}
                  </div>
                </div>
              ))}
              
              {/* ç”¨æˆ·å¡«å†™çš„æ•™è‚²èƒŒæ™¯ */}
              {displayProfile.education?.map((edu: any, i: number) => (
                <div key={i} className="flex gap-4 p-4 bg-slate-50 rounded-lg">
                  <div className="w-11 h-11 bg-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0">
                    <GraduationCap size={20} className="text-white" />
                  </div>
                  <div className="flex-1 min-w-0">
                    {typeof edu === 'string' ? (
                      <p className="text-sm text-slate-700 whitespace-pre-wrap">{edu}</p>
                    ) : (
                      <>
                        <h4 className="font-bold text-slate-900 text-base mb-1">{edu.school || 'å­¦æ ¡åç§°'}</h4>
                        <p className="text-sm text-indigo-600 font-medium">
                          {edu.major}{edu.degree && ` Â· ${edu.degree}`}
                        </p>
                        {edu.period && <p className="text-sm text-slate-500 mt-1">{edu.period}</p>}
                      </>
                    )}
                  </div>
                </div>
              ))}
              
              {educationCertifications.length === 0 && (!displayProfile.education || displayProfile.education.length === 0) && (
                <div className="text-center py-8 text-slate-400">
                  <GraduationCap size={24} className="mx-auto mb-2 opacity-40" />
                  <p className="text-sm">æš‚æ— æ•™è‚²èƒŒæ™¯</p>
                </div>
              )}
            </div>
          </div>

          {/* å·¥ä½œç»å† */}
          <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
            <div className="flex items-center justify-between mb-5">
              <h3 className="text-lg font-black text-slate-900 flex items-center gap-2">
                <Briefcase size={18} className="text-indigo-600" /> å·¥ä½œç»å†
              </h3>
              <button onClick={() => handleEditProfile('experience')} className="text-sm text-indigo-600 hover:underline font-medium">+ æ·»åŠ </button>
            </div>
            
            <div className="space-y-3">
              {/* å·²ä¸Šä¼ çš„å·¥ä½œè¯æ˜ */}
              {workCertifications.map((cert, i) => (
                <div key={cert.id || i} className="flex gap-4 p-4 bg-blue-50/50 rounded-lg border border-blue-100">
                  <div className="w-11 h-11 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                    <Briefcase size={20} className="text-white" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                      <h4 className="font-bold text-slate-900 text-base">{cert.degree || 'åœ¨èŒå‘˜å·¥'}</h4>
                      <span className="px-2 py-0.5 bg-blue-100 text-blue-600 text-xs font-bold rounded">å·²ä¸Šä¼ </span>
                    </div>
                    <p className="text-sm text-blue-600 font-medium">{cert.name || 'å…¬å¸åç§°'}</p>
                    <div className="flex items-center gap-3 mt-1 text-sm text-slate-500">
                      {cert.date && <span>{cert.date}</span>}
                      {cert.major && <span>Â· {cert.major}</span>}
                    </div>
                  </div>
                </div>
              ))}
              
              {/* ç”¨æˆ·å¡«å†™çš„å·¥ä½œç»å† */}
              {displayProfile.experience?.map((exp: any, i: number) => (
                <div key={i} className="flex gap-4 p-4 bg-slate-50 rounded-lg">
                  <div className="w-11 h-11 bg-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0">
                    <Briefcase size={20} className="text-white" />
                  </div>
                  <div className="flex-1 min-w-0">
                    {typeof exp === 'string' ? (
                      <p className="text-sm text-slate-700 whitespace-pre-wrap">{exp}</p>
                    ) : (
                      <>
                        <h4 className="font-bold text-slate-900 text-base mb-1">{exp.position || exp.role || 'èŒä½'}</h4>
                        <p className="text-sm text-indigo-600 font-medium">{exp.company}</p>
                        {exp.period && <p className="text-sm text-slate-500 mt-1">{exp.period}</p>}
                        {exp.description && <p className="text-sm text-slate-500 mt-2 line-clamp-2">{exp.description}</p>}
                      </>
                    )}
                  </div>
                </div>
              ))}
              
              {workCertifications.length === 0 && (!displayProfile.experience || displayProfile.experience.length === 0) && (
                <div className="text-center py-8 text-slate-400">
                  <Briefcase size={24} className="mx-auto mb-2 opacity-40" />
                  <p className="text-sm">æš‚æ— å·¥ä½œç»å†</p>
                </div>
              )}
            </div>
          </div>

          {/* é¡¹ç›®ç»éªŒ */}
          {(displayProfile.projects?.length > 0) && (
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <div className="flex items-center justify-between mb-5">
                <h3 className="text-lg font-black text-slate-900 flex items-center gap-2">
                  <Rocket size={18} className="text-amber-500" /> é¡¹ç›®ç»éªŒ
                </h3>
                <button onClick={() => handleEditProfile('projects')} className="text-sm text-amber-600 hover:underline font-medium">+ æ·»åŠ </button>
              </div>
              <div className="space-y-3">
                {displayProfile.projects.map((proj: any, i: number) => (
                  <div key={i} className="flex gap-4 p-4 bg-amber-50/50 rounded-lg">
                    <div className="w-11 h-11 bg-amber-500 rounded-lg flex items-center justify-center flex-shrink-0">
                      <Rocket size={20} className="text-white" />
                    </div>
                    <div className="flex-1 min-w-0">
                      {typeof proj === 'string' ? (
                        <p className="text-sm text-slate-700 whitespace-pre-wrap">{proj}</p>
                      ) : (
                        <>
                          <h4 className="font-bold text-slate-900 text-base mb-1">{proj.name || 'é¡¹ç›®åç§°'}</h4>
                          {proj.role && <p className="text-sm text-amber-600 font-medium">{proj.role}</p>}
                          {proj.description && <p className="text-sm text-slate-500 mt-2 line-clamp-2">{proj.description}</p>}
                        </>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// --- å…¬å¼€å€™é€‰äººä¸ªäººä¸»é¡µï¼ˆä¼ä¸šæ–¹æŸ¥çœ‹ï¼‰ ---
const PublicCandidateProfileView = () => {
  const { candidateId } = useParams();
  const navigate = useNavigate();
  const [profileData, setProfileData] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!candidateId) return;
    (async () => {
      try {
        const res = await fetch(`/api/v1/public/talents/${candidateId}`);
        if (res.ok) setProfileData(await res.json());
      } catch (e) { console.error(e); }
      finally { setLoading(false); }
    })();
  }, [candidateId]);

  if (loading) return (
    <div className="pt-40 text-center">
      <Loader2 className="mx-auto text-indigo-600 animate-spin mb-4" size={48} />
      <p className="text-slate-500">åŠ è½½ä¸ªäººä¸»é¡µ...</p>
    </div>
  );

  if (!profileData) return (
    <div className="pt-40 text-center">
      <AlertCircle className="mx-auto text-slate-300 mb-4" size={48} />
      <p className="text-slate-500 font-bold">å€™é€‰äººèµ„æ–™æœªæ‰¾åˆ°</p>
      <button onClick={() => navigate(-1)} className="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold">è¿”å›</button>
    </div>
  );

  const dp = {
    name: profileData.name || 'æœªçŸ¥',
    role: profileData.role || 'æœªè®¾ç½®èŒä½',
    experienceYears: profileData.experienceYears || 0,
    skills: profileData.skills || [],
    summary: profileData.summary || '',
    idealJobPersona: profileData.idealJobPersona || '',
    radarData: profileData.radarData || [],
    education: profileData.education || [],
    experience: profileData.experience || [],
    projects: profileData.projects || [],
    certifications: profileData.certifications || [],
    awards: profileData.awards || [],
    interviewQuestions: profileData.interviewQuestions || [],
    optimizationSuggestions: profileData.optimizationSuggestions || [],
    email: profileData.email,
    phone: profileData.phone,
    wechat: profileData.wechat,
    salaryRange: profileData.salaryRange || '',
    matchScore: profileData.matchScore || 0,
  };

  return (
    <div className="pt-20 pb-12 px-4 md:pt-28 md:pb-16 md:px-6 max-w-6xl mx-auto animate-in fade-in duration-500">
      {/* é¡¶éƒ¨å¯¼èˆª */}
      <div className="flex items-center justify-between mb-8">
        <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-slate-400 hover:text-indigo-600 font-medium text-sm transition-colors">
          <ChevronLeft size={18} /> è¿”å›
        </button>
        {dp.matchScore > 0 && (
          <span className="inline-flex items-center gap-1.5 px-4 py-1.5 bg-indigo-50 text-indigo-600 rounded-full text-sm font-black border border-indigo-100">
            <Zap size={14} /> åŒ¹é…åˆ† {dp.matchScore}%
          </span>
        )}
      </div>

      {/* ä¸ªäººä¿¡æ¯å¤´éƒ¨ */}
      <div className="bg-gradient-to-r from-indigo-600 to-indigo-500 rounded-lg p-8 mb-8 text-white relative overflow-hidden">
        <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/2"></div>
        <div className="flex items-center gap-6 relative z-10">
          <div className="w-24 h-24 bg-white/20 backdrop-blur text-white flex items-center justify-center text-4xl font-black rounded-xl">
            {dp.name.charAt(0)}
          </div>
          <div className="flex-1">
            <h1 className="text-3xl font-black mb-1">{dp.name}</h1>
            <p className="text-indigo-200 font-medium mb-3">{dp.role}{dp.salaryRange ? ` Â· ${dp.salaryRange}` : ''}</p>
            <div className="flex flex-wrap gap-2">
              {dp.skills.slice(0, 6).map((skill: string, i: number) => (
                <span key={i} className="px-3 py-1 bg-white/20 backdrop-blur text-white text-xs font-medium rounded-full">{skill}</span>
              ))}
            </div>
          </div>
          <div className="text-right hidden md:block">
            <div className="text-4xl font-black">{dp.experienceYears}<span className="text-lg">å¹´</span></div>
            <div className="text-indigo-200 text-sm">å·¥ä½œç»éªŒ</div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* å·¦ä¾§è¾¹æ  */}
        <div className="space-y-6">
          {/* å…³äºæˆ‘ */}
          {dp.summary && (
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">å…³äºæˆ‘</h3>
              <p className="text-slate-700 text-sm leading-relaxed">{dp.summary}</p>
            </div>
          )}

          {/* è”ç³»æ–¹å¼ */}
          <div className="bg-emerald-50 rounded-lg p-6 border border-emerald-100 shadow-sm">
            <h3 className="text-sm font-bold text-emerald-700 uppercase tracking-wider mb-4 flex items-center gap-2">
              <Phone size={14} /> è”ç³»æ–¹å¼
            </h3>
            <div className="space-y-3">
              {dp.phone && (
                <div className="flex items-center gap-3 p-3 bg-white rounded-lg border border-emerald-100">
                  <Smartphone size={16} className="text-emerald-500 flex-shrink-0" />
                  <div>
                    <div className="text-[10px] text-emerald-500 font-bold uppercase">æ‰‹æœº</div>
                    <div className="text-sm font-bold text-slate-800">{dp.phone}</div>
                  </div>
                </div>
              )}
              {dp.email && (
                <div className="flex items-center gap-3 p-3 bg-white rounded-lg border border-emerald-100">
                  <Mail size={16} className="text-emerald-500 flex-shrink-0" />
                  <div>
                    <div className="text-[10px] text-emerald-500 font-bold uppercase">é‚®ç®±</div>
                    <div className="text-sm font-bold text-slate-800">{dp.email}</div>
                  </div>
                </div>
              )}
              {dp.wechat && (
                <div className="flex items-center gap-3 p-3 bg-white rounded-lg border border-emerald-100">
                  <MessageCircle size={16} className="text-emerald-500 flex-shrink-0" />
                  <div>
                    <div className="text-[10px] text-emerald-500 font-bold uppercase">å¾®ä¿¡</div>
                    <div className="text-sm font-bold text-slate-800">{dp.wechat}</div>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* èƒ½åŠ›é›·è¾¾å›¾ */}
          {dp.radarData.length > 0 && (
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                <BarChart3 size={14} /> æ ¸å¿ƒç«äº‰åŠ›
              </h3>
              <RadarChart data={dp.radarData} />
            </div>
          )}

          {/* è®¤è¯ */}
          {dp.certifications?.length > 0 && (
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                <Award size={14} /> ä¸“ä¸šè®¤è¯
              </h3>
              <div className="space-y-3">
                {dp.certifications.map((cert: any, i: number) => (
                  <div key={i} className="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
                    <div className="w-9 h-9 bg-amber-100 rounded-lg flex items-center justify-center flex-shrink-0">
                      <Award size={16} className="text-amber-600" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="font-bold text-slate-900 text-sm truncate">{cert.name}</div>
                      <div className="text-xs text-slate-500">{cert.issuer}{cert.date ? ` Â· ${cert.date}` : ''}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* è·å¥– */}
          {dp.awards?.length > 0 && (
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                <Trophy size={14} /> è·å¥–ç»å†
              </h3>
              <div className="space-y-3">
                {dp.awards.map((award: any, i: number) => (
                  <div key={i} className="flex items-center gap-3 p-3 bg-slate-50 rounded-lg">
                    <div className="w-9 h-9 bg-rose-100 rounded-lg flex items-center justify-center flex-shrink-0">
                      <Trophy size={16} className="text-rose-600" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="font-bold text-slate-900 text-sm truncate">{award.name}</div>
                      <div className="text-xs text-slate-500">{award.org}{award.year ? ` Â· ${award.year}` : ''}</div>
                      {award.description && <div className="text-xs text-slate-400 mt-1">{award.description}</div>}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        {/* å³ä¾§ä¸»è¦å†…å®¹ */}
        <div className="lg:col-span-2 space-y-6">
          {/* æ•™è‚²èƒŒæ™¯ */}
          <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
            <h3 className="text-lg font-black text-slate-900 flex items-center gap-2 mb-5">
              <GraduationCap size={18} className="text-emerald-600" /> æ•™è‚²èƒŒæ™¯
            </h3>
            <div className="space-y-3">
              {dp.education.length > 0 ? dp.education.map((edu: any, i: number) => (
                <div key={i} className="flex gap-4 p-4 bg-slate-50 rounded-lg">
                  <div className="w-11 h-11 bg-emerald-600 rounded-lg flex items-center justify-center flex-shrink-0">
                    <GraduationCap size={20} className="text-white" />
                  </div>
                  <div className="flex-1 min-w-0">
                    {typeof edu === 'string' ? (
                      <p className="text-sm text-slate-700">{edu}</p>
                    ) : (
                      <>
                        <h4 className="font-bold text-slate-900 text-base mb-1">{edu.school || 'å­¦æ ¡åç§°'}</h4>
                        <p className="text-sm text-emerald-600 font-medium">{edu.major}{edu.degree && ` Â· ${edu.degree}`}</p>
                        {edu.period && <p className="text-sm text-slate-500 mt-1">{edu.period}</p>}
                      </>
                    )}
                  </div>
                </div>
              )) : (
                <div className="text-center py-8 text-slate-400">
                  <GraduationCap size={24} className="mx-auto mb-2 opacity-40" />
                  <p className="text-sm">æš‚æ— æ•™è‚²èƒŒæ™¯</p>
                </div>
              )}
            </div>
          </div>

          {/* å·¥ä½œç»å† */}
          <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
            <h3 className="text-lg font-black text-slate-900 flex items-center gap-2 mb-5">
              <Briefcase size={18} className="text-indigo-600" /> å·¥ä½œç»å†
            </h3>
            <div className="space-y-3">
              {dp.experience.length > 0 ? dp.experience.map((exp: any, i: number) => (
                <div key={i} className="flex gap-4 p-4 bg-slate-50 rounded-lg">
                  <div className="w-11 h-11 bg-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0">
                    <Briefcase size={20} className="text-white" />
                  </div>
                  <div className="flex-1 min-w-0">
                    {typeof exp === 'string' ? (
                      <p className="text-sm text-slate-700">{exp}</p>
                    ) : (
                      <>
                        <h4 className="font-bold text-slate-900 text-base mb-1">{exp.position || exp.role || 'èŒä½'}</h4>
                        <p className="text-sm text-indigo-600 font-medium">{exp.company}</p>
                        {exp.period && <p className="text-sm text-slate-500 mt-1">{exp.period}</p>}
                        {exp.description && <p className="text-sm text-slate-500 mt-2">{exp.description}</p>}
                      </>
                    )}
                  </div>
                </div>
              )) : (
                <div className="text-center py-8 text-slate-400">
                  <Briefcase size={24} className="mx-auto mb-2 opacity-40" />
                  <p className="text-sm">æš‚æ— å·¥ä½œç»å†</p>
                </div>
              )}
            </div>
          </div>

          {/* é¡¹ç›®ç»éªŒ */}
          {dp.projects.length > 0 && (
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h3 className="text-lg font-black text-slate-900 flex items-center gap-2 mb-5">
                <Rocket size={18} className="text-amber-500" /> é¡¹ç›®ç»éªŒ
              </h3>
              <div className="space-y-3">
                {dp.projects.map((proj: any, i: number) => (
                  <div key={i} className="flex gap-4 p-4 bg-amber-50/50 rounded-lg">
                    <div className="w-11 h-11 bg-amber-500 rounded-lg flex items-center justify-center flex-shrink-0">
                      <Rocket size={20} className="text-white" />
                    </div>
                    <div className="flex-1 min-w-0">
                      {typeof proj === 'string' ? (
                        <p className="text-sm text-slate-700">{proj}</p>
                      ) : (
                        <>
                          <h4 className="font-bold text-slate-900 text-base mb-1">{proj.name || 'é¡¹ç›®åç§°'}</h4>
                          {proj.role && <p className="text-sm text-amber-600 font-medium">{proj.role}</p>}
                          {proj.description && <p className="text-sm text-slate-500 mt-2">{proj.description}</p>}
                        </>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* AI é¢è¯•é—®é¢˜ */}
          {dp.interviewQuestions?.length > 0 && (
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h3 className="text-lg font-black text-slate-900 flex items-center gap-2 mb-5">
                <Bot size={18} className="text-indigo-600" /> AI æ¨èé¢è¯•é¢˜
              </h3>
              <div className="space-y-3">
                {dp.interviewQuestions.map((q: string, i: number) => (
                  <div key={i} className="flex gap-3 p-3 bg-indigo-50/50 rounded-lg">
                    <div className="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center text-indigo-600 font-black text-xs flex-shrink-0">Q{i+1}</div>
                    <p className="text-sm text-slate-700 font-medium leading-relaxed">{q}</p>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* AI ä¼˜åŒ–å»ºè®® */}
          {dp.optimizationSuggestions?.length > 0 && (
            <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
              <h3 className="text-lg font-black text-slate-900 flex items-center gap-2 mb-5">
                <Sparkles size={18} className="text-violet-600" /> AI ä¼˜åŒ–å»ºè®®
              </h3>
              <div className="space-y-2">
                {dp.optimizationSuggestions.map((s: string, i: number) => (
                  <div key={i} className="flex items-start gap-3 p-3 bg-violet-50/50 rounded-lg">
                    <div className="w-6 h-6 bg-violet-100 rounded flex items-center justify-center text-violet-600 text-xs font-bold flex-shrink-0 mt-0.5">{i+1}</div>
                    <p className="text-sm text-slate-700">{s}</p>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// --- ä¼ä¸šå·¥ä½œå° ---
const EmployerDashboard = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const userId = user?.id || 0;
  
  // ä½¿ç”¨ API è·å–åŠ¨æ€æ•°æ®
  const { data: memories, loading: memoriesLoading } = useMemories(userId, 'employer');
  
  // æ‹›è˜å‰ç½®æ£€æŸ¥çŠ¶æ€
  const [recruitCheckModal, setRecruitCheckModal] = useState<{
    show: boolean;
    checking: boolean;
    certCompleted: boolean;
    profileCompleted: boolean;
    missingFields: string[];
  }>({ show: false, checking: false, certCompleted: false, profileCompleted: false, missingFields: [] });

  // æ£€æŸ¥æ‹›è˜å‰ç½®æ¡ä»¶
  const handleStartRecruit = async () => {
    setRecruitCheckModal({ show: true, checking: true, certCompleted: false, profileCompleted: false, missingFields: [] });
    
    try {
      const { getEnterpriseCertifications, getSettings, getTasks } = await import('./services/apiService');
      
      // å¹¶è¡Œæ£€æŸ¥è®¤è¯å’Œèµ„æ–™
      const [certifications, settingsData, tasks] = await Promise.all([
        getEnterpriseCertifications(userId).catch(() => []),
        getSettings(userId).catch(() => ({})),
        getTasks(userId).catch(() => []),
      ]);
      
      // æ£€æŸ¥ä¼ä¸šè®¤è¯ - éœ€è¦æœ‰è¥ä¸šæ‰§ç…§è®¤è¯
      const hasBusinessLicense = certifications.some((c: any) => 
        c.category === 'qualification' && c.name?.includes('è¥ä¸šæ‰§ç…§')
      );
      // æˆ–è€…æ£€æŸ¥è®¤è¯ä»»åŠ¡æ˜¯å¦å·²å®Œæˆ
      const certTask = tasks.find((t: any) => 
        t.title === 'å®Œæˆä¼ä¸šè®¤è¯' || (t.title?.includes('ä¼ä¸š') && t.title?.includes('è®¤è¯'))
      );
      const certCompleted = hasBusinessLicense || certTask?.status?.toLowerCase() === 'completed';
      
      // æ£€æŸ¥ä¼ä¸šèµ„æ–™å®Œå–„åº¦ - æ£€æŸ¥å…³é”®å­—æ®µ
      const requiredFields = [
        { key: 'display_name', label: 'ä¼ä¸šå…¨ç§°' },
        { key: 'industry', label: 'æ‰€å±è¡Œä¸š' },
        { key: 'company_size', label: 'ä¼ä¸šè§„æ¨¡' },
        { key: 'detail_address', label: 'å…¬å¸åœ°å€' },
        { key: 'description', label: 'ä¼ä¸šç®€ä»‹' },
      ];
      
      const hasValue = (val: any) => {
        if (!val) return false;
        if (typeof val === 'string') {
          const trimmed = val.trim();
          return trimmed !== '' && trimmed !== '[]' && trimmed !== '{}';
        }
        return true;
      };
      
      const missingFields = requiredFields.filter(f => !hasValue(settingsData[f.key])).map(f => f.label);
      const profileCompleted = missingFields.length === 0;
      
      setRecruitCheckModal({ show: true, checking: false, certCompleted, profileCompleted, missingFields });
      
      // å¦‚æœå…¨éƒ¨é€šè¿‡ï¼Œåˆ›å»ºæ‹›è˜ä»»åŠ¡å¹¶è·³è½¬åˆ° AI æ‹›è˜åŠ©æ‰‹
      if (certCompleted && profileCompleted) {
        try {
          const { createTodo } = await import('./services/apiService');
          
          // æ£€æŸ¥æ˜¯å¦å·²æœ‰æœªå®Œæˆçš„æ‹›è˜ä»»åŠ¡ï¼ˆPENDING / IN_PROGRESS / RUNNINGï¼‰
          let recruitTask = tasks.find((t: any) => 
            (t.todo_type?.toUpperCase() === 'RECRUIT' || t.title?.includes('æ™ºèƒ½æ‹›è˜')) &&
            (t.status?.toUpperCase() === 'PENDING' || t.status?.toUpperCase() === 'RUNNING' || t.status?.toUpperCase() === 'IN_PROGRESS' || t.status === 'running')
          );
          
          if (!recruitTask) {
            // æ²¡æœ‰æœªå®Œæˆçš„ä»»åŠ¡ï¼Œåˆ›å»ºæ–°çš„
            const taskShortId = `RC${Date.now().toString().slice(-6)}`;
            recruitTask = await createTodo({
              title: `æ™ºèƒ½æ‹›è˜ #${taskShortId}`,
              description: 'AI æ™ºèƒ½æ‹›è˜åŠ©æ‰‹ â€” æè¿°æ‚¨çš„æ‹›è˜éœ€æ±‚ï¼ŒAI è‡ªåŠ¨ç”Ÿæˆå²—ä½å¹¶å‘å¸ƒ',
              priority: 'HIGH',
              source: 'AGENT',
              todo_type: 'RECRUIT',
              ai_advice: 'å‘Šè¯‰ AI åŠ©æ‰‹æ‚¨çš„æ‹›è˜éœ€æ±‚ï¼ŒAI å°†ä¸ºæ‚¨è‡ªåŠ¨ç”Ÿæˆå²—ä½ã€åŒ¹é…å€™é€‰äººã€ç­›é€‰è¯„ä¼°ç›´åˆ°åŒæ–¹å»ºç«‹è”ç³»ã€‚',
              steps: [
                { step: 1, title: 'æè¿°æ‹›è˜éœ€æ±‚', status: 'pending' },
                { step: 2, title: 'AI ç”Ÿæˆå²—ä½', status: 'pending' },
                { step: 3, title: 'ç¡®è®¤å¹¶å‘å¸ƒ', status: 'pending' },
                { step: 4, title: 'æ™ºèƒ½é‚€è¯·æŠ•é€’', status: 'pending' },
                { step: 5, title: 'æ™ºèƒ½ç­›é€‰è¯„ä¼°', status: 'pending' },
              ],
            }, userId);
            if (typeof refetchTasks === 'function') refetchTasks();
          }
          
          // ç›´æ¥è·³è½¬åˆ° AI åŠ©æ‰‹å¹¶é€‰ä¸­è¯¥æ‹›è˜ä»»åŠ¡
          const targetTask = recruitTask;
          setTimeout(() => {
            setRecruitCheckModal(prev => ({ ...prev, show: false }));
            // å…ˆå¯¼èˆªåˆ° AI åŠ©æ‰‹é¡µé¢
            navigate('/ai-assistant');
            // ç„¶åé€‰ä¸­è¯¥æ‹›è˜ä»»åŠ¡
            setTimeout(() => {
              if (targetTask) {
                setSelectedTask(targetTask);
              }
            }, 300);
          }, 1200);
        } catch (e) {
          console.error('åˆ›å»ºæ‹›è˜ä»»åŠ¡å¤±è´¥:', e);
        }
      }
    } catch (error) {
      console.error('æ£€æŸ¥æ‹›è˜å‰ç½®æ¡ä»¶å¤±è´¥:', error);
      setRecruitCheckModal(prev => ({ ...prev, checking: false }));
    }
  };

  const [myJobs, setMyJobs] = useState<any[]>([]);
  const [myJobsLoading, setMyJobsLoading] = useState(true);
  
  // çœŸå®æ•°æ®: æ¨èäººæ‰ã€æ‹›è˜æµç¨‹ã€Tokenç»Ÿè®¡
  const { data: realTalents, loading: talentsLoading } = useTalents(5);
  const { data: realFlows, loading: flowsLoading } = useFlows(10, userId || undefined);
  const { data: tokenStatsData } = useTokenStats(userId);

  useEffect(() => {
    if (userId) {
      setMyJobsLoading(true);
      getMyJobs(userId).then(data => setMyJobs(data || [])).catch(() => setMyJobs([])).finally(() => setMyJobsLoading(false));
    }
  }, [userId]);

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-700">
      {/* æ‹›è˜å‰ç½®æ£€æŸ¥å¼¹çª— */}
      {recruitCheckModal.show && (
        <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40" onClick={() => !recruitCheckModal.checking && setRecruitCheckModal(prev => ({ ...prev, show: false }))}>
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 p-6 animate-in fade-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
            {recruitCheckModal.checking ? (
              <div className="text-center py-8">
                <Loader2 size={40} className="animate-spin text-indigo-600 mx-auto mb-4" />
                <h3 className="text-lg font-black text-slate-900">æ­£åœ¨æ£€æŸ¥æ‹›è˜èµ„è´¨...</h3>
                <p className="text-sm text-slate-500 mt-1">ç¡®è®¤ä¼ä¸šè®¤è¯å’Œèµ„æ–™å®Œå–„çŠ¶æ€</p>
              </div>
            ) : recruitCheckModal.certCompleted && recruitCheckModal.profileCompleted ? (
              <div className="text-center py-8">
                <div className="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <CheckCircle2 size={32} className="text-emerald-600" />
                </div>
                <h3 className="text-lg font-black text-slate-900">èµ„è´¨æ£€æŸ¥é€šè¿‡ï¼</h3>
                <p className="text-sm text-slate-500 mt-1">æ­£åœ¨è·³è½¬åˆ° AI æ‹›è˜åŠ©æ‰‹...</p>
              </div>
            ) : (
              <div>
                <h3 className="text-lg font-black text-slate-900 mb-1">æ‹›è˜èµ„è´¨æ£€æŸ¥</h3>
                <p className="text-sm text-slate-500 mb-5">å¼€å§‹æ‹›è˜å‰éœ€è¦å®Œæˆä»¥ä¸‹å‡†å¤‡å·¥ä½œ</p>
                
                <div className="space-y-3">
                  {/* ä¼ä¸šè®¤è¯çŠ¶æ€ */}
                  <div className={`flex items-center gap-3 p-4 rounded-lg border ${recruitCheckModal.certCompleted ? 'bg-emerald-50 border-emerald-200' : 'bg-amber-50 border-amber-200'}`}>
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${recruitCheckModal.certCompleted ? 'bg-emerald-100' : 'bg-amber-100'}`}>
                      {recruitCheckModal.certCompleted ? <CheckCircle2 size={18} className="text-emerald-600" /> : <AlertCircle size={18} className="text-amber-600" />}
                    </div>
                    <div className="flex-1">
                      <h4 className="text-sm font-bold text-slate-800">ä¼ä¸šè®¤è¯</h4>
                      <p className="text-xs text-slate-500">{recruitCheckModal.certCompleted ? 'å·²å®Œæˆä¼ä¸šè®¤è¯' : 'è¯·å…ˆå®Œæˆä¼ä¸šè®¤è¯ï¼ˆè¥ä¸šæ‰§ç…§ç­‰ï¼‰'}</p>
                    </div>
                    {!recruitCheckModal.certCompleted && (
                      <button 
                        onClick={() => { setRecruitCheckModal(prev => ({ ...prev, show: false })); navigate('/settings?tab=Verification'); }}
                        className="text-xs font-bold text-indigo-600 hover:text-indigo-700 whitespace-nowrap"
                      >
                        å»è®¤è¯ â†’
                      </button>
                    )}
                  </div>
                  
                  {/* ä¼ä¸šèµ„æ–™å®Œå–„çŠ¶æ€ */}
                  <div className={`flex items-center gap-3 p-4 rounded-lg border ${recruitCheckModal.profileCompleted ? 'bg-emerald-50 border-emerald-200' : 'bg-amber-50 border-amber-200'}`}>
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${recruitCheckModal.profileCompleted ? 'bg-emerald-100' : 'bg-amber-100'}`}>
                      {recruitCheckModal.profileCompleted ? <CheckCircle2 size={18} className="text-emerald-600" /> : <AlertCircle size={18} className="text-amber-600" />}
                    </div>
                    <div className="flex-1">
                      <h4 className="text-sm font-bold text-slate-800">ä¼ä¸šèµ„æ–™</h4>
                      {recruitCheckModal.profileCompleted ? (
                        <p className="text-xs text-slate-500">ä¼ä¸šèµ„æ–™å·²å®Œå–„</p>
                      ) : (
                        <p className="text-xs text-slate-500">ä»¥ä¸‹ä¿¡æ¯æœªå¡«å†™ï¼š{recruitCheckModal.missingFields.join('ã€')}</p>
                      )}
                    </div>
                    {!recruitCheckModal.profileCompleted && (
                      <button 
                        onClick={() => { setRecruitCheckModal(prev => ({ ...prev, show: false })); navigate('/ai-assistant?task=enterprise_profile'); }}
                        className="text-xs font-bold text-indigo-600 hover:text-indigo-700 whitespace-nowrap"
                      >
                        å»å®Œå–„ â†’
                      </button>
                    )}
                  </div>
                </div>
                
                <div className="mt-5 flex justify-end">
                  <button 
                    onClick={() => setRecruitCheckModal(prev => ({ ...prev, show: false }))}
                    className="px-4 py-2 text-sm font-bold text-slate-600 hover:text-slate-800"
                  >
                    æˆ‘çŸ¥é“äº†
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
        <div>
          <h1 className="text-2xl md:text-4xl font-black text-slate-900 tracking-tight leading-tight">ä¼ä¸šæ–¹</h1>
          <p className="text-slate-500 font-medium">AI çŒå¤´æ™ºèƒ½ä½“æ­£åœ¨ä¸ºæ‚¨å…¨å¤©å€™å·¥ä½œ</p>
        </div>
        <div className="flex gap-4">
          <button 
            onClick={() => navigate('/employer/home')} 
            className="bg-white border border-slate-200 text-slate-900 px-6 py-3.5 rounded font-black text-sm flex items-center gap-2 hover:bg-slate-50 transition-all shadow-sm"
          >
            <Building2 size={20} className="text-indigo-600" /> ä¼ä¸šä¸»é¡µ
          </button>
          <button 
            onClick={handleStartRecruit}
            className="bg-indigo-600 text-white px-8 py-3.5 rounded font-black text-sm flex items-center gap-2 shadow-xl shadow-indigo-200 active:scale-95 transition-all"
          >
            <Plus size={20}/> å¼€å§‹æ‹›è˜
          </button>
        </div>
      </div>

      <div className="w-full bg-white p-8 rounded-lg border border-slate-100 card-shadow relative overflow-hidden mb-12">
        <div className="absolute top-0 right-0 p-8 opacity-5"><Brain size={120} /></div>
        <div className="flex justify-between items-center mb-6 relative z-10">
           <h3 className="text-xl font-black flex items-center gap-3 text-slate-900">
             <Database size={20} className="text-indigo-500" /> ä¼ä¸šè®°å¿† Memory
           </h3>
           <button 
             onClick={() => navigate('/employer/memory')}
             className="px-3 py-1.5 bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 rounded text-xs font-black text-indigo-600 flex items-center gap-1.5 transition-all active:scale-95 group"
           >
             <Pin size={12} className="group-hover:rotate-45 transition-transform" /> è®°å¿†ç®¡ç†
           </button>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 relative z-10">
           {memoriesLoading ? (
              <div className="col-span-4 flex justify-center py-4"><Loader2 className="animate-spin text-indigo-600" size={24} /></div>
           ) : memories.length === 0 ? (
              <div className="col-span-4 text-center py-8 text-slate-400">
                <Database size={32} className="mx-auto mb-2 opacity-50" />
                <p className="text-sm font-medium">æš‚æ— ä¼ä¸šè®°å¿†</p>
                <button 
                  onClick={() => navigate('/memory/input', { state: { scope: 'employer' } })}
                  className="mt-2 text-indigo-600 text-xs font-bold hover:underline"
                >
                  ç‚¹å‡»æ·»åŠ ç¬¬ä¸€æ¡è®°å¿†
                </button>
              </div>
           ) : memories.map((memory: any) => {
            const tagColors: Record<string, string> = {
              'åå¥½': 'bg-purple-100 text-purple-700', 'ç»éªŒ': 'bg-amber-100 text-amber-700', 'æŠ€èƒ½': 'bg-emerald-100 text-emerald-700',
              'æŠ€æœ¯': 'bg-indigo-100 text-indigo-700', 'æ–‡åŒ–': 'bg-rose-100 text-rose-700', 'è¦æ±‚': 'bg-orange-100 text-orange-700',
              'ç­–ç•¥': 'bg-fuchsia-100 text-fuchsia-700', 'ç¦åˆ©': 'bg-cyan-100 text-cyan-700', 'åŠ¨ä½œ': 'bg-violet-100 text-violet-700',
              'è–ªé…¬': 'bg-green-100 text-green-700', 'åœ°ç‚¹': 'bg-sky-100 text-sky-700', 'ç›®æ ‡': 'bg-rose-100 text-rose-700',
              'æ±‡æŠ¥': 'bg-violet-100 text-violet-700', 'å›¢é˜Ÿ': 'bg-teal-100 text-teal-700', 'é¡¹ç›®': 'bg-amber-100 text-amber-700',
              'å…¬å¸': 'bg-blue-100 text-blue-700',
            };
            const tagColor = tagColors[memory.type] || 'bg-slate-100 text-slate-600';
            return (
              <div key={memory.id} className="p-4 rounded-lg border border-slate-200 bg-slate-50">
                 <div className="flex justify-between items-center mb-2">
                    <span className={`text-xs font-black uppercase tracking-wider px-2 py-0.5 rounded ${tagColor}`}>{memory.type}</span>
                    <span className="text-xs text-slate-400 font-mono">{memory.date}</span>
                 </div>
                 <p className="text-sm text-slate-600 leading-relaxed line-clamp-2" title={memory.content}>{memory.content}</p>
              </div>
            );
           })}
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-12">
        <div className="lg:col-span-8 space-y-10">
          
          {/* ä¿®æ”¹ï¼šèŒä½ç®¡ç† */}
          <div className="bg-white rounded-lg p-10 border border-slate-100 card-shadow relative overflow-hidden">
             <div className="flex items-center justify-between mb-8">
               <h2 className="text-2xl font-black text-slate-900 flex items-center gap-3">
                 <Briefcase className="text-indigo-600" /> èŒä½ç®¡ç†
               </h2>
               <button onClick={() => navigate("/employer/post")} className="text-sm text-indigo-600 hover:text-indigo-700 font-medium flex items-center gap-1">
                 å…¨éƒ¨ <ArrowRight size={14} />
               </button>
             </div>
             {myJobsLoading ? (
               <div className="text-center py-8"><Loader2 className="mx-auto animate-spin text-indigo-400" size={24} /></div>
             ) : myJobs.length === 0 ? (
               <div className="text-center py-8">
                 <Briefcase className="mx-auto text-slate-300 mb-3" size={36} />
                 <p className="text-sm text-slate-400 mb-4">è¿˜æ²¡æœ‰å‘å¸ƒè¿‡å²—ä½</p>
                 <button onClick={() => navigate('/ai-assistant?taskType=post')} className="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition-colors inline-flex items-center gap-2">
                   <Sparkles size={14} /> å‘å¸ƒå²—ä½
                 </button>
               </div>
             ) : (
               <div className="space-y-4">
                  {myJobs.slice(0, 5).map((job) => (
                    <div 
                      key={job.id} 
                      onClick={() => navigate(`/employer/post/${job.id}`)}
                      className="flex flex-col md:flex-row items-center justify-between p-6 bg-slate-50 rounded border border-slate-100 group hover:border-indigo-300 transition-all cursor-pointer"
                    >
                      <div className="flex items-center gap-5 w-full md:w-auto">
                         <div className={`w-14 h-14 flex items-center justify-center text-xl font-black rounded shadow-lg ring-4 transition-transform group-hover:scale-105 flex-shrink-0 ${
                           job.status === 'active' ? 'bg-indigo-600 text-white ring-indigo-50' : 'bg-slate-400 text-white ring-slate-100'
                         }`}>
                            <Briefcase size={24} />
                         </div>
                         <div>
                            <div className="text-base font-semibold text-slate-900">{job.title}</div>
                            <div className="text-sm text-slate-500 mt-0.5">{job.location}</div>
                            <div className="flex items-center gap-2 mt-2">
                               <span className="text-xs font-medium text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">
                                 {job.salary_min && job.salary_max ? `${(job.salary_min/1000).toFixed(0)}k-${(job.salary_max/1000).toFixed(0)}k` : 'é¢è®®'}
                               </span>
                               <span className={`text-xs font-medium px-2 py-0.5 rounded ${job.status === 'active' ? 'text-emerald-600 bg-emerald-50' : 'text-slate-400 bg-slate-100'}`}>
                                 {job.status === 'active' ? 'æ‹›è˜ä¸­' : 'å·²å…³é—­'}
                               </span>
                            </div>
                         </div>
                      </div>
                      <div className="flex items-center gap-4 mt-4 md:mt-0 w-full md:w-auto justify-between md:justify-end">
                         <div className="flex items-center gap-3">
                           <div className="text-center px-3 py-2 bg-white rounded-lg border border-slate-100 min-w-[60px]">
                             <div className="text-xl font-bold text-indigo-600">{job.view_count || 0}</div>
                             <div className="text-xs text-slate-400">æµè§ˆ</div>
                           </div>
                           <div className="text-center px-3 py-2 bg-white rounded-lg border border-slate-100 min-w-[60px]">
                             <div className="text-xl font-bold text-emerald-600">{job.apply_count || 0}</div>
                             <div className="text-xs text-slate-400">æŠ•é€’</div>
                           </div>
                         </div>
                         <div className="p-3 bg-white text-indigo-600 rounded border border-indigo-100 hover:bg-indigo-600 hover:text-white transition-all shadow-sm active:scale-95">
                           <ChevronRight size={18} />
                         </div>
                      </div>
                    </div>
                  ))}
                  {myJobs.length > 5 && (
                    <button onClick={() => navigate("/employer/post")} className="text-center py-3 text-sm text-indigo-600 hover:text-indigo-700 font-medium">
                      æŸ¥çœ‹å…¨éƒ¨ {myJobs.length} ä¸ªå²—ä½ â†’
                    </button>
                  )}
               </div>
             )}
          </div>

          {/* æ¨èäººæ‰åˆ—è¡¨ - çœŸå® API æ•°æ® */}
          <div className="bg-white rounded-lg p-10 border border-slate-100 card-shadow overflow-hidden">
             <h2 className="text-2xl font-black text-slate-900 mb-8 flex items-center gap-3">
               <Users2 className="text-indigo-600" /> æ¨èäººæ‰
             </h2>
             <div className="space-y-4">
                {talentsLoading ? (
                  <div className="text-center py-8"><Loader2 className="mx-auto animate-spin text-indigo-400" size={24} /></div>
                ) : realTalents.length === 0 ? (
                  <div className="text-center py-8">
                    <Users2 className="mx-auto text-slate-300 mb-3" size={36} />
                    <p className="text-sm text-slate-400">æš‚æ— æ¨èäººæ‰ï¼Œå‘å¸ƒå²—ä½å AI å°†è‡ªåŠ¨åŒ¹é…</p>
                  </div>
                ) : realTalents.map((talent: any) => (
                  <div key={talent.id} onClick={() => navigate(`/candidate/profile/${talent.id}`)} className="flex flex-col md:flex-row items-center justify-between p-6 bg-slate-50 rounded border border-slate-100 group hover:border-indigo-300 transition-all cursor-pointer">
                    <div className="flex items-center gap-5 w-full md:w-auto">
                       <div className="w-14 h-14 bg-indigo-600 text-white flex items-center justify-center text-xl font-black rounded shadow-lg ring-4 ring-indigo-50 group-hover:scale-105 transition-transform">
                          {(talent.name || '?').charAt(0)}
                       </div>
                       <div>
                          <div className="text-base font-black text-slate-900 tracking-tight">{talent.name}</div>
                          <div className="text-xs font-bold text-slate-500 mt-0.5">{talent.role} Â· {talent.experienceYears || 0}å¹´ç»éªŒ</div>
                          <div className="flex items-center gap-2 mt-2">
                             <span className="text-xs font-black uppercase text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-lg flex items-center gap-1">
                               <Zap size={10} /> {talent.matchScore || 0}% åŒ¹é…
                             </span>
                             {talent.skills?.slice(0, 3).map((s: string, si: number) => (
                               <span key={si} className="text-[10px] text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">{s}</span>
                             ))}
                          </div>
                       </div>
                    </div>
                    <div className="flex items-center gap-6 mt-4 md:mt-0 w-full md:w-auto justify-between md:justify-end">
                       <div className="text-right">
                          <div className="flex items-center gap-2 justify-end">
                             <div className={`w-2 h-2 rounded-full ${talent.status === 'active' ? 'bg-emerald-500 animate-pulse' : 'bg-slate-300'}`}></div>
                             <span className="text-xs font-black text-slate-700">{talent.status === 'active' ? 'æ´»è·ƒå€™é€‰äºº' : 'å¾…æ¿€æ´»'}</span>
                          </div>
                          <div className="text-xs text-slate-400 font-medium mt-1">{talent.salary_range || 'è–ªèµ„é¢è®®'}</div>
                       </div>
                       <div className="p-3 text-indigo-600 group-hover:translate-x-1 transition-transform">
                         <ChevronRight size={18} />
                       </div>
                    </div>
                  </div>
                ))}
                <div className="flex justify-center pt-4">
                  <button 
                    onClick={() => navigate('/employer/talent-pool')}
                    className="w-full bg-slate-50 hover:bg-slate-100 text-slate-600 py-4 rounded font-black text-sm flex items-center justify-center gap-2 transition-all border border-slate-200 border-dashed"
                  >
                    <ArrowRight size={18} /> æŸ¥çœ‹å…¨éƒ¨æ¨èäººæ‰
                  </button>
                </div>
             </div>
          </div>

        </div>

        <div className="lg:col-span-4 space-y-10">
           <div className="bg-white rounded-lg border border-slate-100 card-shadow overflow-hidden">
             <div className="grid grid-cols-1 divide-y divide-slate-100">
               {[
                 { label: 'æ´»è·ƒå²—ä½æ•°', value: `${myJobs.filter(j => j.status === 'active').length} ä¸ª`, icon: Briefcase, color: 'text-indigo-600', bg: 'bg-indigo-50' },
                 { label: 'å€™é€‰äººæ€»æ•°', value: `${realTalents.length} äºº`, icon: Users2, color: 'text-emerald-600', bg: 'bg-emerald-50' },
                 { label: 'æ‹›è˜æµç¨‹', value: `${(realFlows || []).length} ä¸ª`, icon: TrendingUp, color: 'text-cyan-600', bg: 'bg-cyan-50' },
                 { label: 'Token ä½™é¢', value: tokenStatsData?.balance_display || '0', icon: Cpu, color: 'text-amber-500', bg: 'bg-amber-50' },
               ].map((card, i) => (
                 <div key={i} className="p-6">
                   <AnimatedStatItem 
                     value={card.value} 
                     label={card.label} 
                     icon={card.icon} 
                     color={card.color} 
                     bg={card.bg} 
                     delay={i * 150}
                     size="large"
                   />
                 </div>
               ))}
             </div>
           </div>
        </div>
      </div>
    </div>
  );
};

// --- ä¼ä¸šä¸»é¡µé¡µé¢ ---
const EnterpriseHomeView = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const userId = user?.id || 0;
  
  const { data: profileData, loading: profileLoading } = useProfile(userId, 'employer');
  const { data: memoriesData } = useMemories(userId, 'employer');
  
  // ä» user_settings è·å–ä¼ä¸šåŸºç¡€ä¿¡æ¯
  const [settingsData, setSettingsData] = useState<any>(null);
  const [settingsLoading, setSettingsLoading] = useState(true);
  const [certData, setCertData] = useState<any>(null);
  const [jobList, setJobList] = useState<any[]>([]);
  const [jobsLoading, setJobsLoading] = useState(true);
  
  useEffect(() => {
    if (userId) {
      import('./services/apiService').then(m => {
        m.getSettings(userId)
          .then(data => { setSettingsData(data); setSettingsLoading(false); })
          .catch(() => setSettingsLoading(false));
        // è·å–è®¤è¯ä¿¡æ¯
        m.getEnterpriseCertifications(userId)
          .then(data => setCertData(data))
          .catch(() => {});
      });
      // è·å–å²—ä½åˆ—è¡¨
      getMyJobs(userId)
        .then(data => setJobList(data || []))
        .catch(() => setJobList([]))
        .finally(() => setJobsLoading(false));
    }
  }, [userId]);
  
  // è§£æç¦åˆ©æ•°æ®
  const parseBenefits = (val: any): string[] => {
    if (!val) return [];
    if (Array.isArray(val)) return val;
    if (typeof val === 'string') {
      try { const parsed = JSON.parse(val); return Array.isArray(parsed) ? parsed : []; } catch { return []; }
    }
    return [];
  };
  
  // åˆå¹¶æ•°æ®
  const employerData = profileData?.employer_data || {};
  const dc = {
    name: settingsData?.display_name || employerData?.company_name || user?.company_name || 'æœªè®¾ç½®å…¬å¸åç§°',
    shortName: settingsData?.short_name || '',
    slogan: settingsData?.slogan || profileData?.title || employerData?.slogan || '',
    description: settingsData?.description || profileData?.summary || '',
    benefits: parseBenefits(settingsData?.benefits),
    industry: settingsData?.industry || employerData?.industry || '',
    size: settingsData?.company_size || employerData?.size || '',
    fundingStage: settingsData?.funding_stage || '',
    location: settingsData?.detail_address || settingsData?.address || employerData?.location || '',
    contactName: settingsData?.contact_name || '',
    hrPhone: settingsData?.hr_phone || '',
    contactEmail: settingsData?.contact_email || user?.email || '',
    website: settingsData?.website || '',
    isCertified: certData && certData.length > 0 && certData.some((c: any) => c.status === 'approved'),
    certInfo: certData?.[0] || null,
  };
  
  // èµ„æ–™å®Œå–„åº¦
  const profileCompleteness = useMemo(() => {
    const fields = [dc.name, dc.description, dc.industry, dc.size, dc.fundingStage, dc.location, dc.contactName, dc.hrPhone, dc.contactEmail];
    const filled = fields.filter(f => f && f !== 'æœªè®¾ç½®å…¬å¸åç§°').length;
    return Math.round((filled / fields.length) * 100);
  }, [dc]);

  const isProfileEmpty = !settingsData?.display_name && !settingsData?.description;
  
  if (profileLoading || settingsLoading) {
    return (
      <div className="pt-20 text-center">
        <Loader2 className="mx-auto text-indigo-600 animate-spin mb-4" size={48} />
        <p className="text-slate-500 font-medium">åŠ è½½ä¼ä¸šèµ„æ–™ä¸­...</p>
      </div>
    );
  }
  
  // ç©ºçŠ¶æ€å¼•å¯¼
  if (isProfileEmpty) {
    return (
      <div className="py-6 px-4 md:py-8 md:px-6 max-w-3xl mx-auto animate-in fade-in duration-500">
        <button onClick={() => navigate('/employer')} className="flex items-center gap-2 text-slate-500 hover:text-indigo-600 font-bold transition-colors group mb-8">
          <ChevronLeft size={20} className="group-hover:-translate-x-1 transition-transform" /> è¿”å›
        </button>
        <div className="bg-white rounded-lg p-6 md:p-12 border border-slate-100 shadow-xl text-center">
          <div className="w-24 h-24 bg-gradient-to-br from-indigo-100 to-violet-100 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
            <Building2 size={48} className="text-indigo-600" />
          </div>
          <h2 className="text-2xl font-black text-slate-900 mb-4">å®Œå–„æ‚¨çš„ä¼ä¸šä¸»é¡µ</h2>
          <p className="text-slate-500 mb-8 max-w-md mx-auto leading-relaxed">
            æ‚¨è¿˜æ²¡æœ‰è®¾ç½®ä¼ä¸šä¸»é¡µä¿¡æ¯ã€‚å®Œå–„ä¼ä¸šèµ„æ–™å¯ä»¥å±•ç¤ºä¼ä¸šå®åŠ›ï¼Œå¸å¼•æ›´å¤šä¼˜ç§€äººæ‰ã€‚
          </p>
          <div className="flex gap-4 justify-center">
            <button onClick={() => navigate('/settings?tab=General')} className="bg-indigo-600 text-white px-8 py-3.5 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all hover:shadow-xl flex items-center gap-2">
              <Edit3 size={18} /> å®Œå–„åŸºç¡€ä¿¡æ¯
            </button>
            <button onClick={() => navigate('/settings?tab=Verification')} className="bg-white text-indigo-600 border-2 border-indigo-200 px-8 py-3.5 rounded-xl font-bold hover:bg-indigo-50 transition-all flex items-center gap-2">
              <Shield size={18} /> ä¼ä¸šè®¤è¯
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-700">
      {/* é¡¶éƒ¨ Banner */}
      <div className="bg-white rounded-lg shadow-sm overflow-hidden border border-slate-100 relative mb-8">
        <div className="relative overflow-hidden">
          <div className="absolute inset-0 bg-gradient-to-br from-indigo-50 via-violet-50 to-slate-50">
            <div className="absolute inset-0">
              <div className="absolute top-4 left-16 w-48 h-48 bg-indigo-100/60 rounded-full blur-3xl"></div>
              <div className="absolute -bottom-10 right-16 w-72 h-72 bg-violet-100/40 rounded-full blur-3xl"></div>
              <div className="absolute inset-0 opacity-[0.04]" style={{backgroundImage: 'radial-gradient(circle at 1px 1px, #6366f1 1px, transparent 0)', backgroundSize: '32px 32px'}}></div>
            </div>
          </div>
          <div className="relative p-8 md:p-10 flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
            <div className="flex items-center gap-6">
              <div className="w-20 h-20 bg-white rounded-2xl shadow-lg flex-shrink-0 ring-1 ring-slate-100 overflow-hidden flex items-center justify-center">
                {user?.company_logo ? (
                  <img src={user.company_logo.startsWith('/') ? `${window.location.origin}${user.company_logo}` : user.company_logo} alt="Logo" className="w-full h-full object-cover" />
                ) : (
                  <Building2 className="text-indigo-600" size={32} />
                )}
              </div>
              <div>
                <div className="flex items-center gap-3 mb-2">
                  {dc.industry && (
                    <span className="inline-flex items-center gap-1.5 bg-indigo-50 px-3 py-1 rounded-full text-indigo-600 text-xs font-bold border border-indigo-100">
                      <Briefcase size={12} /> {dc.industry}
                    </span>
                  )}
                  {dc.isCertified && (
                    <span className="inline-flex items-center gap-1.5 bg-emerald-50 px-3 py-1 rounded-full text-emerald-600 text-xs font-bold border border-emerald-100">
                      <CheckCircle size={12} /> å·²è®¤è¯
                    </span>
                  )}
                </div>
                <h1 className="text-2xl md:text-3xl font-black text-slate-900 tracking-tight leading-tight">{dc.name}</h1>
                {dc.shortName && <p className="text-slate-500 font-medium mt-1">{dc.shortName}</p>}
              </div>
            </div>
            <div className="flex gap-3">
              <button onClick={() => navigate('/settings?tab=General')} className="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-sm active:scale-95 flex items-center gap-2 text-sm">
                <Edit3 size={16} /> ç¼–è¾‘èµ„æ–™
              </button>
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
        {/* å·¦ä¾§ä¸»å†…å®¹ */}
        <div className="lg:col-span-8 space-y-8">
          
          {/* ä¼ä¸šç®€ä»‹ */}
          <div className="bg-white rounded-lg border border-slate-100 shadow-sm p-8 hover:shadow-md transition-shadow">
            <h2 className="text-xl font-black text-slate-900 mb-5 flex items-center gap-3">
              <div className="w-10 h-10 bg-indigo-50 rounded-xl flex items-center justify-center"><FileText size={20} className="text-indigo-600" /></div>
              ä¼ä¸šç®€ä»‹
            </h2>
            {dc.description ? (
              <p className="text-slate-600 leading-relaxed whitespace-pre-line text-[15px]">{dc.description}</p>
            ) : (
              <div className="text-center py-8">
                <p className="text-slate-400 italic mb-4">æš‚æœªå¡«å†™ä¼ä¸šç®€ä»‹</p>
                <button onClick={() => navigate('/settings?tab=General')} className="text-indigo-600 font-bold text-sm hover:underline">å»å®Œå–„</button>
              </div>
            )}
          </div>

          {/* ä¼ä¸šæ ‡ç­¾ */}
          {(dc.industry || dc.size || dc.fundingStage) && (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {dc.industry && (
                <div className="bg-white rounded-lg border border-slate-100 shadow-sm p-6 hover:shadow-md transition-all hover:border-indigo-200 group">
                  <div className="w-10 h-10 bg-amber-50 rounded-xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                    <Briefcase size={20} className="text-amber-600" />
                  </div>
                  <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">æ‰€å±è¡Œä¸š</p>
                  <p className="text-lg font-black text-slate-900">{dc.industry}</p>
                </div>
              )}
              {dc.size && (
                <div className="bg-white rounded-lg border border-slate-100 shadow-sm p-6 hover:shadow-md transition-all hover:border-indigo-200 group">
                  <div className="w-10 h-10 bg-indigo-50 rounded-xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                    <Users size={20} className="text-indigo-600" />
                  </div>
                  <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">ä¼ä¸šè§„æ¨¡</p>
                  <p className="text-lg font-black text-slate-900">{dc.size}</p>
                </div>
              )}
              {dc.fundingStage && (
                <div className="bg-white rounded-lg border border-slate-100 shadow-sm p-6 hover:shadow-md transition-all hover:border-indigo-200 group">
                  <div className="w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                    <TrendingUp size={20} className="text-emerald-600" />
                  </div>
                  <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">èèµ„é˜¶æ®µ</p>
                  <p className="text-lg font-black text-slate-900">{dc.fundingStage}</p>
                </div>
              )}
            </div>
          )}

          {/* ä¼ä¸šç¦åˆ© */}
          {dc.benefits.length > 0 && (
            <div className="bg-white rounded-lg border border-slate-100 shadow-sm p-8 hover:shadow-md transition-shadow">
              <h2 className="text-xl font-black text-slate-900 mb-5 flex items-center gap-3">
                <div className="w-10 h-10 bg-amber-50 rounded-xl flex items-center justify-center"><Gift size={20} className="text-amber-600" /></div>
                ä¼ä¸šç¦åˆ©
              </h2>
              <div className="flex flex-wrap gap-3">
                {dc.benefits.map((b: string, i: number) => (
                  <span key={i} className="inline-flex items-center gap-2 bg-gradient-to-r from-indigo-50 to-violet-50 text-indigo-700 px-5 py-2.5 rounded-xl text-sm font-bold border border-indigo-100/50 hover:shadow-sm transition-all">
                    <CheckCircle size={14} className="text-indigo-400" /> {b}
                  </span>
                ))}
              </div>
            </div>
          )}

          {/* æ‹›è˜ä¸­çš„å²—ä½ */}
          <div className="bg-white rounded-lg border border-slate-100 shadow-sm p-8 hover:shadow-md transition-shadow">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-black text-slate-900 flex items-center gap-3">
                <div className="w-10 h-10 bg-indigo-50 rounded-xl flex items-center justify-center"><Briefcase size={20} className="text-indigo-600" /></div>
                æ‹›è˜ä¸­çš„å²—ä½
                {jobList.filter(job => job.status === 'active').length > 0 && (
                  <span className="text-sm font-bold text-indigo-600 bg-indigo-50 px-2.5 py-1 rounded-full">{jobList.filter(job => job.status === 'active').length}</span>
                )}
              </h2>
              <button onClick={() => navigate('/employer/post')} className="text-sm text-indigo-600 hover:text-indigo-700 font-medium flex items-center gap-1 hover:gap-2 transition-all">
                å…¨éƒ¨ <ChevronRight size={16} />
              </button>
            </div>
            {jobsLoading ? (
              <div className="text-center py-8">
                <Loader2 className="animate-spin mx-auto text-indigo-600 mb-2" size={24} />
                <p className="text-sm text-slate-400">åŠ è½½ä¸­...</p>
              </div>
            ) : jobList.length === 0 ? (
              <div className="text-center py-10">
                <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Briefcase size={28} className="text-slate-400" />
                </div>
                <p className="text-slate-400 mb-4">æš‚æ— å‘å¸ƒçš„å²—ä½</p>
                <button onClick={() => navigate('/employer/post')} className="text-indigo-600 font-bold text-sm hover:underline">
                  å‘å¸ƒç¬¬ä¸€ä¸ªå²—ä½
                </button>
              </div>
            ) : (
              <div className="space-y-4">
                {jobList.filter(job => job.status === 'active').slice(0, 5).map((job) => (
                  <div
                    key={job.id}
                    onClick={() => navigate(`/employer/post/${job.id}`)}
                    className="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-100 hover:border-indigo-200 hover:shadow-sm transition-all cursor-pointer group"
                  >
                    <div className="flex items-center gap-4 min-w-0 flex-1">
                      <div className="w-11 h-11 bg-indigo-100 rounded-xl flex items-center justify-center flex-shrink-0 group-hover:bg-indigo-600 transition-colors">
                        <Briefcase size={20} className="text-indigo-600 group-hover:text-white transition-colors" />
                      </div>
                      <div className="min-w-0 flex-1">
                        <div className="text-base font-semibold text-slate-900 group-hover:text-indigo-600 transition-colors truncate">{job.title}</div>
                        <div className="text-sm text-slate-500 mt-1 truncate">{job.location}</div>
                      </div>
                    </div>
                    <div className="flex items-center gap-3 flex-shrink-0 ml-4">
                      <span className="text-base font-bold text-indigo-600">
                        {job.salary_min && job.salary_max ? `${(job.salary_min/1000).toFixed(0)}k-${(job.salary_max/1000).toFixed(0)}k` : 'é¢è®®'}
                      </span>
                      <div className="w-8 h-8 bg-white rounded-lg flex items-center justify-center border border-slate-200 group-hover:border-indigo-300 group-hover:bg-indigo-50 transition-colors">
                        <ChevronRight size={16} className="text-slate-400 group-hover:text-indigo-600 transition-colors" />
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
            {!jobsLoading && jobList.filter(job => job.status === 'active').length > 5 && (
              <button onClick={() => navigate('/employer/post')} className="w-full mt-5 py-3 text-sm text-indigo-600 font-medium bg-indigo-50 hover:bg-indigo-100 rounded-xl transition-colors">
                æŸ¥çœ‹å…¨éƒ¨ {jobList.filter(job => job.status === 'active').length} ä¸ªå²—ä½ â†’
              </button>
            )}
          </div>

          {/* è®¤è¯ä¿¡æ¯ */}
          {dc.isCertified && dc.certInfo && (
            <div className="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg border border-emerald-100 p-8">
              <h2 className="text-xl font-black text-slate-900 mb-5 flex items-center gap-3">
                <div className="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center"><Shield size={20} className="text-emerald-600" /></div>
                ä¼ä¸šè®¤è¯
                <span className="text-xs bg-emerald-500 text-white px-2.5 py-1 rounded-full font-bold">å·²è®¤è¯</span>
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {dc.certInfo.company_name && (
                  <div className="bg-white/80 backdrop-blur rounded-lg p-4 border border-emerald-100/50">
                    <p className="text-xs font-bold text-emerald-600 uppercase tracking-wider mb-1">æ³¨å†Œä¼ä¸šåç§°</p>
                    <p className="text-sm font-bold text-slate-800">{dc.certInfo.company_name}</p>
                  </div>
                )}
                {dc.certInfo.credit_code && (
                  <div className="bg-white/80 backdrop-blur rounded-lg p-4 border border-emerald-100/50">
                    <p className="text-xs font-bold text-emerald-600 uppercase tracking-wider mb-1">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </p>
                    <p className="text-sm font-bold text-slate-800">{dc.certInfo.credit_code}</p>
                  </div>
                )}
                {dc.certInfo.legal_person && (
                  <div className="bg-white/80 backdrop-blur rounded-lg p-4 border border-emerald-100/50">
                    <p className="text-xs font-bold text-emerald-600 uppercase tracking-wider mb-1">æ³•å®šä»£è¡¨äºº</p>
                    <p className="text-sm font-bold text-slate-800">{dc.certInfo.legal_person}</p>
                  </div>
                )}
                {dc.certInfo.registered_capital && (
                  <div className="bg-white/80 backdrop-blur rounded-lg p-4 border border-emerald-100/50">
                    <p className="text-xs font-bold text-emerald-600 uppercase tracking-wider mb-1">æ³¨å†Œèµ„æœ¬</p>
                    <p className="text-sm font-bold text-slate-800">{dc.certInfo.registered_capital}</p>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

        {/* å³ä¾§ä¿¡æ¯æ  */}
        <div className="lg:col-span-4 space-y-6">
          
          {/* èµ„æ–™å®Œå–„åº¦ - 100%æ—¶éšè— */}
          {profileCompleteness < 100 && (
          <div className="bg-white rounded-lg border border-slate-100 shadow-sm p-6">
            <h3 className="text-base font-black text-slate-900 mb-4 flex items-center gap-2">
              <Activity size={18} className="text-indigo-600" /> èµ„æ–™å®Œå–„åº¦
            </h3>
            <div className="mb-3">
              <div className="flex justify-between text-sm mb-2">
                <span className="text-slate-500 font-medium">å®Œå–„è¿›åº¦</span>
                <span className="font-black text-indigo-600">{profileCompleteness}%</span>
              </div>
              <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                <div className="bg-gradient-to-r from-indigo-500 to-violet-500 h-full rounded-full transition-all duration-700" style={{width: `${profileCompleteness}%`}}></div>
              </div>
            </div>
            <button onClick={() => navigate('/settings?tab=General')} className="w-full mt-3 py-2.5 text-sm font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-xl transition-all flex items-center justify-center gap-2">
              <Edit3 size={14} /> ç»§ç»­å®Œå–„
            </button>
          </div>
          )}
          
          {/* è”ç³»ä¿¡æ¯ */}
          <div className="bg-white rounded-lg p-6 shadow-sm border border-slate-200 relative overflow-hidden">
            <div className="absolute -top-6 -right-6 w-24 h-24 bg-indigo-50 rounded-full blur-xl"></div>
            <h3 className="text-base font-black mb-5 flex items-center gap-2 relative z-10 text-slate-900">
              <Phone size={18} className="text-indigo-600" /> è”ç³»ä¿¡æ¯
            </h3>
            <div className="space-y-4 relative z-10">
              {dc.contactName && (
                <div className="flex items-center gap-3">
                  <div className="w-8 h-8 bg-indigo-50 rounded-lg flex items-center justify-center"><UserIcon size={14} className="text-indigo-600" /></div>
                  <div>
                    <p className="text-xs text-slate-400 font-medium">è”ç³»äºº</p>
                    <p className="font-bold text-slate-800">{dc.contactName}</p>
                  </div>
                </div>
              )}
              {dc.hrPhone && (
                <div className="flex items-center gap-3">
                  <div className="w-8 h-8 bg-indigo-50 rounded-lg flex items-center justify-center"><Phone size={14} className="text-indigo-600" /></div>
                  <div>
                    <p className="text-xs text-slate-400 font-medium">ç”µè¯</p>
                    <p className="font-bold text-slate-800">{dc.hrPhone}</p>
                  </div>
                </div>
              )}
              {dc.contactEmail && (
                <div className="flex items-center gap-3">
                  <div className="w-8 h-8 bg-indigo-50 rounded-lg flex items-center justify-center"><Mail size={14} className="text-indigo-600" /></div>
                  <div>
                    <p className="text-xs text-slate-400 font-medium">é‚®ç®±</p>
                    <p className="font-bold text-sm break-all text-slate-800">{dc.contactEmail}</p>
                  </div>
                </div>
              )}
              {dc.website && (
                <div className="flex items-center gap-3">
                  <div className="w-8 h-8 bg-indigo-50 rounded-lg flex items-center justify-center"><Globe size={14} className="text-indigo-600" /></div>
                  <div>
                    <p className="text-xs text-slate-400 font-medium">å®˜ç½‘</p>
                    <p className="font-bold text-sm break-all text-slate-800">{dc.website}</p>
                  </div>
                </div>
              )}
              {!dc.contactName && !dc.hrPhone && !dc.contactEmail && (
                <p className="text-slate-400 text-sm italic text-center py-2">æš‚æœªè®¾ç½®è”ç³»ä¿¡æ¯</p>
              )}
            </div>
          </div>

          {/* å…¬å¸åœ°å€ */}
          <div className="bg-white rounded-lg border border-slate-100 shadow-sm p-6">
            <h3 className="text-base font-black text-slate-900 mb-4 flex items-center gap-2">
              <MapPin size={18} className="text-indigo-600" /> å…¬å¸åœ°å€
            </h3>
            {dc.location ? (
              <p className="text-sm text-slate-600 leading-relaxed font-medium">{dc.location}</p>
            ) : (
              <p className="text-sm text-slate-400 italic">æš‚æœªè®¾ç½®å…¬å¸åœ°å€</p>
            )}
          </div>

          {/* å¿«æ·æ“ä½œ */}
          <div className="bg-white rounded-lg border border-slate-100 shadow-sm p-6">
            <h3 className="text-base font-black text-slate-900 mb-4">å¿«æ·æ“ä½œ</h3>
            <div className="space-y-2.5">
              <button onClick={() => navigate('/settings?tab=General')} className="w-full py-3 px-4 bg-indigo-50 hover:bg-indigo-100 rounded-xl text-indigo-700 font-bold text-sm transition-all flex items-center gap-2.5">
                <Edit3 size={16} /> ç¼–è¾‘åŸºç¡€ä¿¡æ¯
              </button>
              <button onClick={() => navigate('/settings?tab=Verification')} className="w-full py-3 px-4 bg-emerald-50 hover:bg-emerald-100 rounded-xl text-emerald-700 font-bold text-sm transition-all flex items-center gap-2.5">
                <Shield size={16} /> ä¼ä¸šè®¤è¯ç®¡ç†
              </button>
              <button onClick={() => navigate('/ai-assistant')} className="w-full py-3 px-4 bg-violet-50 hover:bg-violet-100 rounded-xl text-violet-700 font-bold text-sm transition-all flex items-center gap-2.5">
                <Zap size={16} /> AI åŠ©æ‰‹
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};


// TalentDetailView â€” è‡ªåŠ¨æŸ¥æ‰¾å€™é€‰äººæœ€æ–° flow å¹¶è·³è½¬è‡³æµç¨‹è¯¦æƒ…é¡µ
const TalentDetailView = () => {
  const { talentId } = useParams();
  const navigate = useNavigate();
  const [checking, setChecking] = useState(true);

  useEffect(() => {
    if (!talentId) return;
    (async () => {
      try {
        const res = await fetch(`/api/v1/public/flows?candidate_id=${talentId}&limit=1`);
        if (res.ok) {
          const data = await res.json();
          const flows = Array.isArray(data) ? data : data.items || [];
          if (flows.length > 0 && flows[0].id) {
            navigate(`/workbench/flow/${flows[0].id}`, { replace: true });
            return;
          }
        }
      } catch {}
      setChecking(false);
    })();
  }, [talentId, navigate]);

  if (checking) {
    return (
      <div className="pt-20 text-center animate-pulse">
        <Loader2 className="animate-spin mx-auto text-indigo-600 mb-4" size={48} />
        <p className="text-slate-500 font-bold">æ­£åœ¨è°ƒå–å€™é€‰äººæ¡£æ¡ˆ...</p>
      </div>
    );
  }

  return (
    <div className="pt-20 text-center">
      <AlertCircle className="mx-auto text-slate-300 mb-4" size={48} />
      <p className="text-slate-500 font-bold">è¯¥å€™é€‰äººæš‚æ— æ‹›è˜æµç¨‹è®°å½•</p>
      <button onClick={() => navigate(-1)} className="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-all">è¿”å›</button>
    </div>
  );
};

// --- èŒä½è¯¦æƒ…é¡µ (JobPostDetailView) ---
const JobPostDetailView = () => {
  const navigate = useNavigate();
  const { postId } = useParams();
  const { user } = useAuth();
  const userId = user?.id || 0;

  const [loading, setLoading] = useState(true);
  const [jobData, setJobData] = useState<any>(null);
  const [applications, setApplications] = useState<any[]>([]);
  const [stats, setStats] = useState<any>({});
  const [statusFilter, setStatusFilter] = useState('all');
  const [sortBy, setSortBy] = useState<'score' | 'time'>('time');
  const [showDesc, setShowDesc] = useState(false);
  const [activeTab, setActiveTab] = useState<'applicants' | 'logs'>('applicants');
  const [jobLogs, setJobLogs] = useState<any[]>([]);
  const [logsLoading, setLogsLoading] = useState(false);
  const [feedbackModal, setFeedbackModal] = useState<{ open: boolean; candidate: any }>({ open: false, candidate: null });
  const [feedbackRating, setFeedbackRating] = useState<'good' | 'neutral' | 'bad'>('good');
  const [feedbackText, setFeedbackText] = useState('');
  const [feedbackSubmitting, setFeedbackSubmitting] = useState(false);

  useEffect(() => {
    window.scrollTo(0, 0);
  }, [postId]);

  useEffect(() => {
    if (postId && userId) {
      setLoading(true);
      getJobDetail(Number(postId), userId)
        .then(data => {
          setJobData(data.job);
          setApplications(data.applications || []);
          setStats(data.stats || {});
        })
        .catch(e => {
          console.error('åŠ è½½å²—ä½è¯¦æƒ…å¤±è´¥:', e);
        })
        .finally(() => setLoading(false));
    }
  }, [postId, userId]);

  // åŠ è½½å²—ä½æ—¥å¿—
  useEffect(() => {
    if (activeTab === 'logs' && postId) {
      setLogsLoading(true);
      (async () => {
        try {
          const { getJobLogs } = await import('./services/apiService');
          const result = await getJobLogs(Number(postId));
          setJobLogs(result.logs || []);
        } catch (e) {
          console.error('åŠ è½½å²—ä½æ—¥å¿—å¤±è´¥:', e);
        } finally {
          setLogsLoading(false);
        }
      })();
    }
  }, [activeTab, postId]);

  const formatSalary = (min?: number, max?: number) => {
    if (!min && !max) return 'é¢è®®';
    if (min && max) return `${(min / 1000).toFixed(0)}k - ${(max / 1000).toFixed(0)}k`;
    if (min) return `${(min / 1000).toFixed(0)}k èµ·`;
    return `æœ€é«˜ ${((max || 0) / 1000).toFixed(0)}k`;
  };

  const statusLabelMap: Record<string, { text: string; color: string }> = {
    parsing: { text: 'ç®€å†è§£æä¸­', color: 'bg-blue-100 text-blue-700' },
    benchmarking: { text: 'å¯¹æ ‡åˆ†æä¸­', color: 'bg-purple-100 text-purple-700' },
    screening: { text: 'é‚€è¯·/ç­›é€‰ä¸­', color: 'bg-amber-100 text-amber-700' },
    interviewing: { text: 'é¢è¯•ä¸­', color: 'bg-orange-100 text-orange-700' },
    evaluating: { text: 'ç­›é€‰é€šè¿‡', color: 'bg-indigo-100 text-indigo-700' },
    offer: { text: 'Offeré˜¶æ®µ', color: 'bg-emerald-100 text-emerald-700' },
    accepted: { text: 'å·²é€šè¿‡', color: 'bg-green-100 text-green-700' },
    rejected: { text: 'æœªé€šè¿‡', color: 'bg-red-100 text-red-600' },
    withdrawn: { text: 'å·²æ’¤å›', color: 'bg-slate-100 text-slate-500' },
  };

  const stageLabelMap: Record<string, { text: string; color: string }> = {
    parse: { text: 'å·²é‚€è¯·', color: 'text-blue-600' },
    benchmark: { text: 'å·²ç­›é€‰', color: 'text-purple-600' },
    first_interview: { text: 'åˆè¯•', color: 'text-indigo-600' },
    second_interview: { text: 'å¤è¯•', color: 'text-orange-600' },
    final: { text: 'åŒæ–¹é€šè¿‡', color: 'text-emerald-600' },
  };

  const getStatusLabel = (s: string) => statusLabelMap[s] || { text: s, color: 'bg-slate-100 text-slate-600' };
  const getStageLabel = (s: string) => stageLabelMap[s] || { text: s, color: 'text-slate-500' };

  // è¿‡æ»¤å’Œæ’åºï¼ˆç­›é€‰é€šè¿‡çš„å€™é€‰äººä¼˜å…ˆæ˜¾ç¤ºï¼‰
  const statusPriority = (app: any): number => {
    if (app.screen_result?.both_pass) return 0;              // ç­›é€‰é€šè¿‡ â†’ æœ€ä¼˜å…ˆ
    if (app.status === 'accepted' || app.status === 'evaluating') return 1; // å·²é€šè¿‡/ç­›é€‰é€šè¿‡çŠ¶æ€
    if (app.status === 'offer') return 2;                    // Offer é˜¶æ®µ
    if (app.status === 'screening') return 3;                // é‚€è¯·/ç­›é€‰ä¸­
    if (app.status === 'rejected' || app.status === 'withdrawn') return 5; // æœªé€šè¿‡/å·²æ’¤å› â†’ æœ€å
    return 4;                                                 // å…¶ä»–
  };
  const filteredApps = applications
    .filter(a => statusFilter === 'all' || a.status === statusFilter)
    .sort((a, b) => {
      // å…ˆæŒ‰çŠ¶æ€ä¼˜å…ˆçº§æ’åº
      const priorityDiff = statusPriority(a) - statusPriority(b);
      if (priorityDiff !== 0) return priorityDiff;
      // åŒä¼˜å…ˆçº§å†…å†æŒ‰ç”¨æˆ·é€‰æ‹©çš„æ’åºæ–¹å¼
      if (sortBy === 'score') return (b.match_score || 0) - (a.match_score || 0);
      return parseUTC(b.created_at || 0).getTime() - parseUTC(a.created_at || 0).getTime();
    });

  const acceptedCount = applications.filter(a => a.status === 'accepted').length;

  if (loading) {
    return (
      <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto">
        <div className="text-center py-20">
          <Loader2 className="mx-auto animate-spin text-indigo-600 mb-3" size={24} />
          <p className="text-sm text-slate-400">åŠ è½½å²—ä½è¯¦æƒ…...</p>
        </div>
      </div>
    );
  }

  if (!jobData) {
    return (
      <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto">
        <div className="text-center py-20">
          <AlertCircle className="mx-auto text-slate-300 mb-3" size={40} />
          <p className="text-slate-900 font-black mb-2">å²—ä½ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®</p>
          <button onClick={() => navigate("/employer/post")} className="bg-indigo-600 text-white px-6 py-3 rounded font-black text-sm mt-4 shadow-xl shadow-indigo-200">
            è¿”å›èŒä½ç®¡ç†
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-700">
      {/* é¡µé¢å¤´éƒ¨ */}
      <button onClick={() => navigate("/employer/post")} className="flex items-center gap-2 text-slate-500 hover:text-indigo-600 mb-8 font-black transition-colors group text-sm">
        <ChevronLeft size={18} className="group-hover:-translate-x-1 transition-transform" /> è¿”å›èŒä½ç®¡ç†
      </button>

      <div className="bg-white rounded-lg p-8 border border-slate-100 card-shadow mb-10">
        <div className="flex flex-col md:flex-row md:items-start justify-between gap-6">
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-3">
              <span className={`px-3 py-1 rounded text-xs font-black uppercase ${
                jobData.status === 'active' ? 'bg-indigo-50 text-indigo-600' : 'bg-slate-100 text-slate-500'
              }`}>
                {jobData.status === 'active' ? 'æ‹›è˜ä¸­' : 'å·²å…³é—­'}
              </span>
              <span className="text-xs text-slate-400 font-mono">ID: {postId}</span>
            </div>
            <h1 className="text-3xl font-black text-slate-900 mb-3">{jobData.title}</h1>
            <div className="flex flex-wrap items-center gap-4 text-sm text-slate-500 mb-4">
              <span className="flex items-center gap-1.5"><Building2 size={14} className="text-slate-400" /> {jobData.company}</span>
              <span className="flex items-center gap-1.5"><MapPin size={14} className="text-slate-400" /> {jobData.location}</span>
              <span className="font-black text-indigo-600">{formatSalary(jobData.salary_min, jobData.salary_max)}</span>
              <span className="flex items-center gap-1.5 text-slate-400"><Calendar size={14} /> {jobData.created_at ? parseUTC(jobData.created_at).toLocaleDateString('zh-CN') : '-'}</span>
            </div>
            {jobData.tags && jobData.tags.length > 0 && (
              <div className="flex flex-wrap gap-2 mb-4">
                {jobData.tags.map((tag: string) => (
                  <span key={tag} className="px-2 py-0.5 bg-indigo-50 text-indigo-500/80 rounded text-xs font-black uppercase">{tag}</span>
                ))}
              </div>
            )}
            {jobData.description && (
              <div className="mt-4 p-5 bg-slate-50 rounded-lg border border-slate-100">
                <div className="flex items-center gap-2 mb-3 text-slate-700">
                  <FileText size={16} className="text-indigo-600" />
                  <span className="font-semibold">å²—ä½æè¿°</span>
                </div>
                <div className={`text-sm text-slate-600 leading-relaxed whitespace-pre-wrap ${!showDesc && jobData.description.length > 300 ? 'line-clamp-4' : ''}`}>
                  {jobData.description}
                </div>
                {jobData.description.length > 300 && (
                  <button onClick={() => setShowDesc(!showDesc)} className="mt-3 text-sm text-indigo-600 hover:text-indigo-700 font-medium flex items-center gap-1 transition-colors">
                    {showDesc ? 'æ”¶èµ·' : 'å±•å¼€å…¨æ–‡'}
                    {showDesc ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                  </button>
                )}
              </div>
            )}
          </div>
          {/* ç»Ÿè®¡ */}
          <div className="flex gap-3">
            <div className="bg-white rounded-lg px-4 py-3 text-center min-w-[80px] border border-slate-100">
              <div className="text-xl font-bold text-indigo-600">{stats.total || 0}</div>
              <div className="text-xs text-slate-400">æŠ•é€’</div>
            </div>
            <div className="bg-white rounded-lg px-4 py-3 text-center min-w-[80px] border border-slate-100">
              <div className="text-xl font-bold text-emerald-600">{acceptedCount}</div>
              <div className="text-xs text-slate-400">å½•ç”¨</div>
            </div>
            <div className="bg-white rounded-lg px-4 py-3 text-center min-w-[80px] border border-slate-100">
              <div className="text-xl font-bold text-slate-900">{jobData.view_count || 0}</div>
              <div className="text-xs text-slate-400">æµè§ˆ</div>
            </div>
          </div>
        </div>
      </div>

      {/* Tab åˆ‡æ¢ */}
      <div className="flex gap-2 mb-6">
        <button
          onClick={() => setActiveTab('applicants')}
          className={`px-5 py-2.5 rounded-lg font-black text-sm transition-all flex items-center gap-2 ${
            activeTab === 'applicants' 
              ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' 
              : 'bg-white text-slate-600 border border-slate-200 hover:border-indigo-300'
          }`}
        >
          <Users size={16} /> æ±‚èŒè€…åˆ—è¡¨
          {applications.length > 0 && <span className={`text-xs px-1.5 py-0.5 rounded-full ${activeTab === 'applicants' ? 'bg-white/20' : 'bg-indigo-50 text-indigo-600'}`}>{applications.length}</span>}
        </button>
        <button
          onClick={() => setActiveTab('logs')}
          className={`px-5 py-2.5 rounded-lg font-black text-sm transition-all flex items-center gap-2 ${
            activeTab === 'logs' 
              ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' 
              : 'bg-white text-slate-600 border border-slate-200 hover:border-indigo-300'
          }`}
        >
          <ScrollText size={16} /> å²—ä½æ—¥å¿—
          {jobLogs.length > 0 && <span className={`text-xs px-1.5 py-0.5 rounded-full ${activeTab === 'logs' ? 'bg-white/20' : 'bg-amber-50 text-amber-600'}`}>{jobLogs.length}</span>}
        </button>
      </div>

      {/* æŠ•é€’åˆ—è¡¨ */}
      {activeTab === 'applicants' && (
      <div className="bg-white rounded-lg border border-slate-100 card-shadow overflow-hidden">
        <div className="p-6 border-b border-slate-100 flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
          <h2 className="text-xl font-black text-slate-900 flex items-center gap-3">
            <Users size={22} className="text-indigo-600" /> æ±‚èŒè€…åˆ—è¡¨
            {applications.length > 0 && <span className="text-sm font-medium text-slate-400">({applications.length})</span>}
          </h2>
          <div className="flex items-center gap-3">
            <select
              value={statusFilter}
              onChange={e => setStatusFilter(e.target.value)}
              className="bg-slate-50 border border-slate-200 rounded px-3 py-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500/30"
            >
              <option value="all">å…¨éƒ¨çŠ¶æ€</option>
              <option value="screening">é‚€è¯·/ç­›é€‰ä¸­</option>
              <option value="evaluating">ç­›é€‰é€šè¿‡</option>
              <option value="accepted">å·²é€šè¿‡</option>
              <option value="rejected">æœªé€šè¿‡</option>
            </select>
            <select
              value={sortBy}
              onChange={e => setSortBy(e.target.value as any)}
              className="bg-slate-50 border border-slate-200 rounded px-3 py-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500/30"
            >
              <option value="time">æœ€æ–°æŠ•é€’</option>
              <option value="score">åŒ¹é…åˆ†æœ€é«˜</option>
            </select>
          </div>
        </div>

        {filteredApps.length === 0 ? (
          <div className="text-center py-20">
            <Inbox className="mx-auto text-slate-300 mb-4" size={40} />
            <p className="text-slate-900 font-black mb-1">
              {applications.length === 0 ? 'æš‚æ— å€™é€‰äººæŠ•é€’' : 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æŠ•é€’'}
            </p>
            <p className="text-sm text-slate-500 font-medium">
              {applications.length === 0 ? 'å²—ä½å‘å¸ƒåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºæ‚¨åŒ¹é…åˆé€‚çš„å€™é€‰äºº' : 'å°è¯•æ›´æ¢ç­›é€‰æ¡ä»¶'}
            </p>
          </div>
        ) : (
          <div className="space-y-4 p-6">
            {filteredApps.map((app, appIdx) => {
              const stLabel = getStatusLabel(app.status);
              const sgLabel = getStageLabel(app.current_stage);
              const avatarChar = (app.candidate_name || '?').charAt(0);
              const isSimulated = app.source === 'ai_simulated';
              const sr = app.screen_result;
              return (
                <div key={app.flow_id || `sim-${appIdx}`} className="flex flex-col p-6 bg-slate-50 rounded border border-slate-100 group hover:border-indigo-300 transition-all">
                  <div className="flex flex-col md:flex-row items-start md:items-center justify-between">
                    <div 
                      className="flex items-center gap-5 w-full md:w-auto cursor-pointer"
                      onClick={() => { if (app.candidate_id) navigate(`/candidate/profile/${app.candidate_id}`); }}
                      title={app.candidate_id ? 'ç‚¹å‡»æŸ¥çœ‹ä¸ªäººä¸»é¡µ' : ''}
                    >
                      {/* å¤´åƒ */}
                      {app.candidate_avatar ? (
                        <img src={app.candidate_avatar} alt="" className="w-14 h-14 rounded shadow-lg ring-4 ring-indigo-50 object-cover flex-shrink-0 group-hover:scale-105 transition-transform" />
                      ) : (
                        <div className={`w-14 h-14 ${isSimulated ? 'bg-gradient-to-br from-violet-500 to-indigo-600' : 'bg-indigo-600'} text-white flex items-center justify-center text-xl font-black rounded shadow-lg ring-4 ring-indigo-50 group-hover:scale-105 transition-transform flex-shrink-0`}>
                          {avatarChar}
                        </div>
                      )}
                      <div>
                        <div className="flex items-center gap-2">
                          <span className={`text-base font-black tracking-tight ${app.candidate_id ? 'text-indigo-700 hover:text-indigo-900 hover:underline' : 'text-slate-900'}`}>{app.candidate_name}</span>
                          {isSimulated && (
                            <span className="text-[10px] font-bold text-violet-600 bg-violet-50 px-1.5 py-0.5 rounded border border-violet-100">AI æ¨è</span>
                          )}
                          {app.source === 'real' && (
                            <span className="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded border border-emerald-100">æ•°æ®åº“</span>
                          )}
                        </div>
                        {app.candidate_role && <div className="text-xs font-bold text-slate-500 mt-0.5">{app.candidate_role}{app.candidate_experience ? ` Â· ${app.candidate_experience}å¹´ç»éªŒ` : ''}</div>}
                        <div className="flex items-center gap-2 mt-2 flex-wrap">
                          {app.match_score > 0 && (
                            <span className="text-xs font-black uppercase text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-lg flex items-center gap-1">
                              <Zap size={10} /> {app.match_score}% åŒ¹é…
                            </span>
                          )}
                          <span className={`text-xs font-black uppercase px-2 py-0.5 rounded-lg ${stLabel.color}`}>{stLabel.text}</span>
                          <span className={`text-xs font-black uppercase px-2 py-0.5 rounded-lg bg-white border border-slate-100 ${sgLabel.color}`}>{sgLabel.text}</span>
                        </div>
                      </div>
                    </div>
                    <div className="flex items-center gap-4 mt-4 md:mt-0 w-full md:w-auto justify-between md:justify-end">
                      <div className="text-right">
                        <div className="text-xs text-slate-400 font-bold">{app.created_at ? parseUTC(app.created_at).toLocaleDateString('zh-CN') : '-'}</div>
                        {app.last_action && <div className="text-xs text-slate-400 font-bold mt-1 max-w-[180px] truncate">{app.last_action}</div>}
                      </div>
                      {/* åé¦ˆè¯„ä»·æŒ‰é’®å·²ç§»è‡³è”ç³»æ–¹å¼åŒºåŸŸ */}
                      {app.flow_id ? (
                        <button onClick={() => navigate(`/workbench/flow/${app.flow_id}`)} className="p-3 bg-white text-indigo-600 rounded border border-indigo-100 hover:bg-indigo-600 hover:text-white transition-all shadow-sm active:scale-95">
                          <ChevronRight size={18} />
                        </button>
                      ) : app.candidate_id ? (
                        <button onClick={() => navigate(`/employer/talent/${app.candidate_id}`)} className="p-3 bg-white text-indigo-600 rounded border border-indigo-100 hover:bg-indigo-600 hover:text-white transition-all shadow-sm active:scale-95">
                          <ChevronRight size={18} />
                        </button>
                      ) : (
                        <div className="p-3 text-slate-300"><ChevronRight size={18} /></div>
                      )}
                    </div>
                  </div>
                  {/* ç­›é€‰ç»“æœè¯¦æƒ… */}
                  {sr && (sr.employer_pass !== undefined || sr.candidate_pass !== undefined) && (
                    <div className="mt-3 pt-3 border-t border-slate-100 flex flex-wrap items-center gap-3 text-xs">
                      {sr.employer_score !== undefined && (
                        <span className={`font-bold px-2 py-0.5 rounded ${sr.employer_pass ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-600'}`}>
                          ğŸ¢ ä¼ä¸šè¯„åˆ† {sr.employer_score}åˆ† {sr.employer_pass ? 'âœ“' : 'âœ—'}
                        </span>
                      )}
                      {sr.candidate_interest !== undefined && (
                        <span className={`font-bold px-2 py-0.5 rounded ${sr.candidate_pass ? 'bg-emerald-50 text-emerald-700' : 'bg-orange-50 text-orange-600'}`}>
                          ğŸ‘¤ å€™é€‰äººæ„å‘ {sr.candidate_interest}åˆ† {sr.candidate_pass ? 'âœ“' : 'âœ—'}
                        </span>
                      )}
                      {sr.final_status && (
                        <span className={`font-black px-2 py-0.5 rounded ${sr.both_pass ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600'}`}>
                          â†’ {sr.final_status}
                        </span>
                      )}
                      {sr.strengths && sr.strengths.length > 0 && (
                        <span className="text-slate-500 font-medium">ä¼˜åŠ¿: {sr.strengths.join('ã€')}</span>
                      )}
                    </div>
                  )}
                  {/* åŒæ–¹é€šè¿‡ â€” è”ç³»æ–¹å¼ + æŸ¥çœ‹ç®€å† */}
                  {sr?.both_pass && (
                    <div className="mt-3 pt-3 border-t border-dashed border-emerald-200 bg-emerald-50/50 rounded-lg p-3">
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2 text-xs font-bold text-emerald-700">
                          <Phone size={13} /> è”ç³»æ–¹å¼ï¼ˆç­›é€‰é€šè¿‡ï¼‰
                        </div>
                        <button
                          onClick={() => { setFeedbackModal({ open: true, candidate: app }); setFeedbackRating('good'); setFeedbackText(''); }}
                          className="flex items-center gap-1.5 px-3 py-1.5 bg-amber-500 text-white rounded-lg text-xs font-bold hover:bg-amber-600 transition-all active:scale-95 shadow-sm"
                        >
                          <MessageSquare size={12} /> åé¦ˆè¯„ä»·
                        </button>
                      </div>
                      <div className="flex flex-wrap items-center gap-4 text-xs">
                        {app.candidate_phone && (
                          <span className="flex items-center gap-1.5 bg-white px-3 py-1.5 rounded-lg border border-emerald-100 font-bold text-slate-800">
                            <Smartphone size={12} className="text-emerald-500" /> {app.candidate_phone}
                          </span>
                        )}
                        {app.candidate_email && (
                          <span className="flex items-center gap-1.5 bg-white px-3 py-1.5 rounded-lg border border-emerald-100 font-bold text-slate-800">
                            <Mail size={12} className="text-emerald-500" /> {app.candidate_email}
                          </span>
                        )}
                        {(app.candidate_wechat || app.candidate_phone) && (
                          <span className="flex items-center gap-1.5 bg-white px-3 py-1.5 rounded-lg border border-emerald-100 font-bold text-slate-800">
                            <MessageCircle size={12} className="text-emerald-500" /> {app.candidate_wechat || app.candidate_phone}
                          </span>
                        )}
                        {!app.candidate_phone && !app.candidate_email && (
                          <span className="text-slate-400 font-medium">è”ç³»æ–¹å¼æš‚æœªæä¾›</span>
                        )}
                      </div>
                      <div className="text-xs text-slate-400 font-medium mt-2">
                        è¯·å°½å¿«è”ç³»ï¼Œè”ç³»åé€šè¿‡ã€Œåé¦ˆè¯„ä»·ã€å‘Šè¯‰æˆ‘ä»¬å®é™…ä½“éªŒï¼Œå¸®åŠ© AI æ”¹è¿›ã€‚
                      </div>
                    </div>
                  )}
                  {/* AI åˆ†æè¯¦æƒ… */}
                  {app.details && !sr && (
                    <div className="mt-3 pt-3 border-t border-slate-100 text-xs text-slate-500 font-medium line-clamp-2">
                      {app.details}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {/* åº•éƒ¨ */}
        {filteredApps.length > 0 && (
          <div className="p-6 border-t border-slate-100 flex items-center justify-between">
            <div className="text-sm text-slate-500">
              å…± <span className="font-black text-slate-900">{filteredApps.length}</span> ä½æ±‚èŒè€…
            </div>
          </div>
        )}
      </div>
      )}

      {/* å²—ä½æ—¥å¿— */}
      {activeTab === 'logs' && (
      <div className="bg-white rounded-lg border border-slate-100 card-shadow overflow-hidden">
        <div className="p-6 border-b border-slate-100 flex items-center justify-between">
          <h2 className="text-xl font-black text-slate-900 flex items-center gap-3">
            <ScrollText size={22} className="text-amber-600" /> å²—ä½æ—¥å¿—
            {jobLogs.length > 0 && <span className="text-sm font-medium text-slate-400">({jobLogs.length})</span>}
          </h2>
          <button
            onClick={() => {
              setLogsLoading(true);
              (async () => {
                try {
                  const { getJobLogs } = await import('./services/apiService');
                  const result = await getJobLogs(Number(postId));
                  setJobLogs(result.logs || []);
                } catch { /* ignore */ } finally { setLogsLoading(false); }
              })();
            }}
            className="text-sm text-indigo-600 hover:text-indigo-700 font-medium flex items-center gap-1"
          >
            <RefreshCw size={14} className={logsLoading ? 'animate-spin' : ''} /> åˆ·æ–°
          </button>
        </div>

        {logsLoading ? (
          <div className="text-center py-16">
            <Loader2 className="mx-auto animate-spin text-indigo-600 mb-3" size={24} />
            <p className="text-sm text-slate-400">åŠ è½½æ—¥å¿—ä¸­...</p>
          </div>
        ) : jobLogs.length === 0 ? (
          <div className="text-center py-16">
            <ScrollText className="mx-auto text-slate-300 mb-4" size={40} />
            <p className="text-slate-900 font-black mb-1">æš‚æ— æ—¥å¿—è®°å½•</p>
            <p className="text-sm text-slate-500">å²—ä½çš„å‘å¸ƒã€é‚€è¯·ã€ç­›é€‰ç­‰æ“ä½œå°†è‡ªåŠ¨è®°å½•åœ¨æ­¤</p>
          </div>
        ) : (
          <div className="p-6">
            {/* æ—¥å¿—æ—¶é—´çº¿ */}
            <div className="relative">
              {/* æ—¶é—´çº¿ç«–çº¿ */}
              <div className="absolute left-5 top-2 bottom-2 w-px bg-gradient-to-b from-indigo-200 via-amber-200 to-slate-200" />
              
              <div className="space-y-0">
                {jobLogs.map((log, idx) => {
                  const actionConfig: Record<string, { icon: React.ReactNode; color: string; bgColor: string }> = {
                    publish: { icon: <Rocket size={14} />, color: 'text-indigo-600', bgColor: 'bg-indigo-100' },
                    update: { icon: <Pencil size={14} />, color: 'text-blue-600', bgColor: 'bg-blue-100' },
                    pause: { icon: <Pause size={14} />, color: 'text-amber-600', bgColor: 'bg-amber-100' },
                    resume: { icon: <Play size={14} />, color: 'text-green-600', bgColor: 'bg-green-100' },
                    close: { icon: <XCircle size={14} />, color: 'text-red-600', bgColor: 'bg-red-100' },
                    invite_start: { icon: <Send size={14} />, color: 'text-purple-600', bgColor: 'bg-purple-100' },
                    invite_match: { icon: <Users size={14} />, color: 'text-purple-600', bgColor: 'bg-purple-100' },
                    invite_send: { icon: <Mail size={14} />, color: 'text-purple-600', bgColor: 'bg-purple-100' },
                    screen_start: { icon: <Search size={14} />, color: 'text-orange-600', bgColor: 'bg-orange-100' },
                    screen_result: { icon: <BarChart3 size={14} />, color: 'text-orange-600', bgColor: 'bg-orange-100' },
                    exchange_request: { icon: <ArrowLeftRight size={14} />, color: 'text-emerald-600', bgColor: 'bg-emerald-100' },
                    exchange_confirm: { icon: <CheckCircle size={14} />, color: 'text-emerald-600', bgColor: 'bg-emerald-100' },
                    ai_analysis: { icon: <Sparkles size={14} />, color: 'text-violet-600', bgColor: 'bg-violet-100' },
                    user_action: { icon: <UserIcon size={14} />, color: 'text-slate-600', bgColor: 'bg-slate-100' },
                    system: { icon: <Settings size={14} />, color: 'text-slate-500', bgColor: 'bg-slate-100' },
                  };
                  const cfg = actionConfig[log.action] || actionConfig.system;
                  const actorLabel = log.actor_type === 'ai' 
                    ? <><Bot size={11} className="inline -mt-0.5" /> AI</>
                    : log.actor_type === 'system' 
                    ? <><Settings2 size={11} className="inline -mt-0.5" /> ç³»ç»Ÿ</>
                    : <><UserIcon size={11} className="inline -mt-0.5" /> ç”¨æˆ·</>;
                  const timeStr = log.created_at ? parseUTC(log.created_at).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
                  
                  return (
                    <div key={log.id} className="relative pl-12 pb-6 group">
                      {/* æ—¶é—´çº¿èŠ‚ç‚¹ */}
                      <div className={`absolute left-2.5 top-1 w-5 h-5 rounded-full flex items-center justify-center ${cfg.bgColor} ${cfg.color} ring-4 ring-white shadow-sm`}>
                        {cfg.icon}
                      </div>
                      
                      <div className="bg-slate-50 rounded-lg p-4 border border-slate-100 group-hover:border-indigo-200 transition-all">
                        <div className="flex items-center justify-between mb-2">
                          <div className="flex items-center gap-2">
                            <span className="font-black text-slate-900 text-sm">{log.title}</span>
                            <span className={`text-xs px-2 py-0.5 rounded-full font-bold ${cfg.bgColor} ${cfg.color}`}>
                              {actorLabel}
                            </span>
                          </div>
                          <span className="text-xs text-slate-400 font-mono">{timeStr}</span>
                        </div>
                        <p className="text-sm text-slate-600 leading-relaxed">{log.content}</p>
                        {log.extra_data && Object.keys(log.extra_data).length > 0 && (
                          <div className="mt-3 pt-3 border-t border-slate-100">
                            {log.extra_data.candidates_count && (
                              <span className="text-xs bg-purple-50 text-purple-600 px-2 py-1 rounded font-bold">
                                åŒ¹é…å€™é€‰äºº: {log.extra_data.candidates_count} äºº
                              </span>
                            )}
                            {log.extra_data.screened_count && (
                              <span className="text-xs bg-orange-50 text-orange-600 px-2 py-1 rounded font-bold">
                                ç­›é€‰æ¨è: {log.extra_data.screened_count} äºº
                              </span>
                            )}
                            {log.extra_data.candidates && Array.isArray(log.extra_data.candidates) && (
                              <div className="mt-2 flex flex-wrap gap-2">
                                {log.extra_data.candidates.map((c: any, ci: number) => (
                                  <span key={ci} className="text-xs bg-white border border-slate-200 px-2 py-1 rounded-lg">
                                    {c.name} {c.match_score ? `${c.match_score}%` : ''} {c.recommendation || ''}
                                  </span>
                                ))}
                              </div>
                            )}
                            {log.extra_data.screened && Array.isArray(log.extra_data.screened) && (
                              <div className="mt-2 flex flex-wrap gap-2">
                                {log.extra_data.screened.map((c: any, ci: number) => (
                                  <span key={ci} className="text-xs bg-white border border-slate-200 px-2 py-1 rounded-lg">
                                    {c.name} {c.match_score ? `${c.match_score}%` : ''} {c.recommendation || ''}
                                  </span>
                                ))}
                              </div>
                            )}
                            {log.extra_data.tags && Array.isArray(log.extra_data.tags) && (
                              <div className="mt-2 flex flex-wrap gap-1">
                                {log.extra_data.tags.map((t: string, ti: number) => (
                                  <span key={ti} className="text-xs bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded">{t}</span>
                                ))}
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}
      </div>
      )}

      {/* ===== åé¦ˆè¯„ä»·æ¨¡æ€æ¡† ===== */}
      {feedbackModal.open && feedbackModal.candidate && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 animate-in fade-in duration-200" onClick={() => setFeedbackModal({ open: false, candidate: null })}>
          <div className="bg-white rounded-lg shadow-2xl w-full max-w-md mx-4 animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
            <div className="p-6 border-b border-slate-100">
              <h3 className="text-lg font-black text-slate-900 flex items-center gap-2">
                <MessageSquare size={20} className="text-amber-500" />
                åé¦ˆè¯„ä»·
              </h3>
              <p className="text-sm text-slate-500 mt-1">
                å¯¹å€™é€‰äºº <span className="font-bold text-slate-900">{feedbackModal.candidate.candidate_name}</span> çš„å®é™…è”ç³»ä½“éªŒ
              </p>
            </div>
            <div className="p-6 space-y-5">
              {/* è¯„ä»·é€‰æ‹© */}
              <div>
                <label className="text-sm font-bold text-slate-700 mb-3 block">æ•´ä½“è¯„ä»·</label>
                <div className="grid grid-cols-3 gap-3">
                  {([
                    { value: 'good' as const, emoji: 'ğŸ˜Š', label: 'æ»¡æ„', desc: 'ç¬¦åˆé¢„æœŸ', color: 'border-emerald-300 bg-emerald-50 text-emerald-700', activeColor: 'ring-2 ring-emerald-400 border-emerald-400 bg-emerald-100' },
                    { value: 'neutral' as const, emoji: 'ğŸ˜', label: 'ä¸€èˆ¬', desc: 'åŸºæœ¬ç¬¦åˆ', color: 'border-slate-200 bg-slate-50 text-slate-700', activeColor: 'ring-2 ring-slate-400 border-slate-400 bg-slate-100' },
                    { value: 'bad' as const, emoji: 'ğŸ˜', label: 'ä¸æ»¡æ„', desc: 'éœ€è¦æ”¹è¿›', color: 'border-red-200 bg-red-50 text-red-700', activeColor: 'ring-2 ring-red-400 border-red-400 bg-red-100' },
                  ]).map(opt => (
                    <button
                      key={opt.value}
                      onClick={() => setFeedbackRating(opt.value)}
                      className={`p-4 rounded-xl border-2 text-center transition-all active:scale-95 ${feedbackRating === opt.value ? opt.activeColor : opt.color} hover:shadow-md`}
                    >
                      <div className="text-2xl mb-1">{opt.emoji}</div>
                      <div className="text-sm font-black">{opt.label}</div>
                      <div className="text-[10px] mt-0.5 opacity-70">{opt.desc}</div>
                    </button>
                  ))}
                </div>
              </div>
              {/* è¯¦ç»†è¯„ä»· */}
              <div>
                <label className="text-sm font-bold text-slate-700 mb-2 block">
                  å…·ä½“è¯„ä»· <span className="text-slate-400 font-medium">{feedbackRating === 'bad' ? '(è¯·æè¿°åŸå› ï¼Œå¸®åŠ© AI æ”¹è¿›)' : '(é€‰å¡«)'}</span>
                </label>
                <textarea
                  value={feedbackText}
                  onChange={e => setFeedbackText(e.target.value)}
                  placeholder={feedbackRating === 'bad' ? 'è¯·æè¿°ä¸æ»¡æ„çš„åŸå› ï¼Œå¦‚ï¼šæ²Ÿé€šèƒ½åŠ›ä¸è¶³ã€æŠ€æœ¯æ°´å¹³ä¸æè¿°ä¸ç¬¦...' : feedbackRating === 'good' ? 'å¯ä»¥æè¿°æ»¡æ„çš„æ–¹é¢ï¼Œå¦‚ï¼šæŠ€æœ¯æ‰å®ã€æ²Ÿé€šé¡ºç•…...' : 'å¯ä»¥è¡¥å……æ‚¨çš„æ„Ÿå—...'}
                  className="w-full h-24 p-3 text-sm border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 outline-none resize-none bg-slate-50"
                />
              </div>
              {/* æç¤º */}
              <div className="bg-amber-50 rounded-lg p-3 flex items-start gap-2">
                <Info size={14} className="text-amber-500 mt-0.5 flex-shrink-0" />
                <p className="text-xs text-amber-700 font-medium">
                  {feedbackRating === 'bad'
                    ? 'ä¸æ»¡æ„çš„è¯„ä»·å°†å†™å…¥ä¼ä¸šè®°å¿†ï¼ŒAI åç»­åŒ¹é…æ—¶ä¼šè‡ªåŠ¨è§„é¿ç±»ä¼¼é—®é¢˜ã€‚'
                    : feedbackRating === 'good'
                    ? 'æ»¡æ„çš„è¯„ä»·å°†å¸®åŠ© AI äº†è§£æ‚¨çš„äººæ‰åå¥½ï¼Œä¼˜åŒ–åç»­åŒ¹é…ã€‚'
                    : 'æ‚¨çš„åé¦ˆå°†è®°å½•åœ¨å²—ä½æ—¥å¿—ä¸­ï¼ŒæŒç»­ä¼˜åŒ– AI å¯¹æ¥è´¨é‡ã€‚'}
                </p>
              </div>
            </div>
            <div className="p-6 border-t border-slate-100 flex items-center justify-end gap-3">
              <button
                onClick={() => setFeedbackModal({ open: false, candidate: null })}
                className="px-5 py-2.5 text-sm font-bold text-slate-600 bg-slate-100 rounded-xl hover:bg-slate-200 transition-all"
              >
                å–æ¶ˆ
              </button>
              <button
                disabled={feedbackSubmitting || (feedbackRating === 'bad' && !feedbackText.trim())}
                onClick={async () => {
                  setFeedbackSubmitting(true);
                  try {
                    const { submitCandidateFeedback } = await import('./services/apiService');
                    const jobId = jobData?.id;
                    if (jobId) {
                      await submitCandidateFeedback({
                        job_id: jobId,
                        user_id: userId,
                        candidate_name: feedbackModal.candidate.candidate_name,
                        rating: feedbackRating,
                        feedback_text: feedbackText.trim(),
                      });
                    }
                    setFeedbackModal({ open: false, candidate: null });
                    // åˆ·æ–°æ—¥å¿—
                    if (activeTab === 'logs') {
                      setLogsLoading(true);
                      const { getJobLogs } = await import('./services/apiService');
                      const result = await getJobLogs(Number(postId));
                      setJobLogs(result.logs || []);
                      setLogsLoading(false);
                    }
                  } catch (e) {
                    console.error('æäº¤åé¦ˆå¤±è´¥:', e);
                  } finally {
                    setFeedbackSubmitting(false);
                  }
                }}
                className="px-5 py-2.5 text-sm font-bold text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
              >
                {feedbackSubmitting ? <Loader2 size={14} className="animate-spin" /> : <Send size={14} />}
                æäº¤åé¦ˆ
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// --- è®°å¿†å½•å…¥ä»»åŠ¡é¡µ (MemoryInputView) ---
const MemoryInputView = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { user } = useAuth();
  
  // ä»è·¯ç”± state è·å– scopeï¼Œé»˜è®¤ä¸º candidate
  const scope = (location.state as any)?.scope || 'candidate';
  const isEmployerMemory = scope === 'employer';
  
  const [memoryType, setMemoryType] = useState(isEmployerMemory ? 'culture' : 'skill');
  const [content, setContent] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitted, setSubmitted] = useState(false);
  
  // æ ¹æ® scope æ˜¾ç¤ºä¸åŒçš„è®°å¿†ç±»å‹
  const employerMemoryTypes = [
    { id: 'culture', name: 'ä¼ä¸šæ–‡åŒ–', icon: Heart, color: 'bg-rose-100 text-rose-600', desc: 'ä¼ä¸šæ–‡åŒ–ã€ä»·å€¼è§‚ã€ç”¨äººç†å¿µ' },
    { id: 'tech', name: 'æŠ€æœ¯è¦æ±‚', icon: Cpu, color: 'bg-indigo-100 text-indigo-600', desc: 'æŠ€æœ¯æ ˆã€ç¼–ç¨‹è¯­è¨€ã€æ¡†æ¶è¦æ±‚' },
    { id: 'team', name: 'å›¢é˜Ÿè§„æ¨¡', icon: Users, color: 'bg-teal-100 text-teal-600', desc: 'å›¢é˜Ÿäººæ•°ã€æˆå‘˜æ„æˆ' },
    { id: 'salary', name: 'è–ªé…¬ç¦åˆ©', icon: CircleDollarSign, color: 'bg-green-100 text-green-600', desc: 'è–ªèµ„èŒƒå›´ã€å¥–é‡‘ã€æœŸæƒã€ç¦åˆ©' },
    { id: 'location', name: 'å·¥ä½œåœ°ç‚¹', icon: MapPin, color: 'bg-sky-100 text-sky-600', desc: 'åŸå¸‚ã€è¿œç¨‹ã€åŠå…¬åœ°å€' },
    { id: 'goal', name: 'æ‹›è˜ç›®æ ‡', icon: Target, color: 'bg-amber-100 text-amber-600', desc: 'æ‹›è˜è®¡åˆ’ã€äººæ•°ã€å‘¨æœŸ' },
  ];
  
  const candidateMemoryTypes = [
    { id: 'skill', name: 'æŠ€èƒ½ä¸“é•¿', icon: Cpu, color: 'bg-indigo-100 text-indigo-600', desc: 'ç¼–ç¨‹è¯­è¨€ã€æŠ€æœ¯æ ˆã€ä¸“ä¸šæŠ€èƒ½' },
    { id: 'experience', name: 'å·¥ä½œç»éªŒ', icon: Clock, color: 'bg-amber-100 text-amber-600', desc: 'å·¥ä½œå¹´é™ã€è¡Œä¸šèƒŒæ™¯ã€é¡¹ç›®ç»éªŒ' },
    { id: 'culture', name: 'æ–‡åŒ–åå¥½', icon: Heart, color: 'bg-rose-100 text-rose-600', desc: 'ç†æƒ³çš„å…¬å¸æ–‡åŒ–ã€å›¢é˜Ÿæ°›å›´' },
    { id: 'goal', name: 'èŒä¸šç›®æ ‡', icon: Target, color: 'bg-emerald-100 text-emerald-600', desc: 'æœŸæœ›è–ªèµ„ã€èŒä½ã€å‘å±•æ–¹å‘' },
    { id: 'location', name: 'å·¥ä½œåœ°ç‚¹', icon: MapPin, color: 'bg-sky-100 text-sky-600', desc: 'æœŸæœ›åŸå¸‚ã€è¿œç¨‹åå¥½' },
    { id: 'salary', name: 'æœŸæœ›è–ªèµ„', icon: CircleDollarSign, color: 'bg-green-100 text-green-600', desc: 'è–ªèµ„èŒƒå›´ã€ç¦åˆ©æœŸæœ›' },
  ];
  
  const memoryTypes = isEmployerMemory ? employerMemoryTypes : candidateMemoryTypes;
  
  const handleSubmit = async () => {
    if (!content.trim()) return;
    setIsSubmitting(true);
    
    try {
      // è°ƒç”¨åç«¯ API ä¿å­˜è®°å¿†ï¼Œä¼ é€’ scope å‚æ•°
      await createMemory({
        type: memoryType,
        content: content.trim(),
        importance: 'Medium',
        scope: scope,
      }, user?.id || 1);
      
      setIsSubmitting(false);
      setSubmitted(true);
    } catch (error) {
      console.error('ä¿å­˜è®°å¿†å¤±è´¥:', error);
      alert('ä¿å­˜è®°å¿†å¤±è´¥ï¼Œè¯·é‡è¯•');
      setIsSubmitting(false);
    }
  };
  
  const handleReset = () => {
    setContent('');
    setSubmitted(false);
  };
  
  if (submitted) {
    return (
      <div className="py-6 px-4 md:py-8 md:px-6 max-w-3xl mx-auto animate-in fade-in duration-500">
        <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-slate-500 hover:text-indigo-600 mb-8 font-black transition-colors group">
          <ChevronLeft size={20} className="group-hover:-translate-x-1 transition-transform" /> è¿”å›
        </button>
        
        <div className="bg-white rounded-xl border border-slate-100 shadow-sm p-10 text-center">
          <div className="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <Sparkle className="text-emerald-600" size={40} />
          </div>
          <h2 className="text-2xl font-black text-slate-900 mb-4">è®°å¿†å½•å…¥æˆåŠŸ</h2>
          <p className="text-slate-500 mb-8">AI Agent å·²æˆåŠŸå­¦ä¹ å¹¶å›ºåŒ–æ­¤æ¡è®°å¿†ï¼Œå°†ç”¨äºåç»­çš„æ‹›è˜å†³ç­–è¾…åŠ©ã€‚</p>
          
          <div className="bg-indigo-50 rounded-lg p-6 mb-8">
            <h3 className="text-sm font-black text-indigo-900 uppercase tracking-widest mb-4">AI ä»»åŠ¡æ‰§è¡Œæ‘˜è¦</h3>
            <div className="space-y-3 text-sm">
              <div className="flex justify-between">
                <span className="text-slate-500">è®°å¿†ç±»å‹</span>
                <span className="font-medium text-slate-900">{memoryTypes.find(t => t.id === memoryType)?.name}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-slate-500">Token æ¶ˆè€—</span>
                <span className="font-medium text-slate-900">2,450</span>
              </div>
              <div className="flex justify-between">
                <span className="text-slate-500">å½±å“èŒƒå›´</span>
                <span className="font-medium text-slate-900">å…¨å±€ (All Candidates)</span>
              </div>
              <div className="flex justify-between">
                <span className="text-slate-500">å¤„ç†è€—æ—¶</span>
                <span className="font-medium text-slate-900">1.2s</span>
              </div>
            </div>
          </div>
          
          <div className="flex gap-4 justify-center">
            <button onClick={handleReset} className="px-6 py-3 bg-white border border-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-50 transition-colors">
              ç»§ç»­å½•å…¥
            </button>
            <button 
              onClick={() => navigate(isEmployerMemory ? '/employer/memory' : '/candidate/memory')} 
              className={`px-6 py-3 ${isEmployerMemory ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-emerald-600 hover:bg-emerald-700'} text-white rounded-lg font-bold transition-colors`}
            >
              æŸ¥çœ‹{isEmployerMemory ? 'ä¼ä¸š' : 'äººæ‰'}è®°å¿†åº“
            </button>
          </div>
        </div>
      </div>
    );
  }
  
  return (
    <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 max-w-3xl mx-auto animate-in fade-in duration-500">
      <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-slate-500 hover:text-indigo-600 mb-8 font-black transition-colors group">
        <ChevronLeft size={20} className="group-hover:-translate-x-1 transition-transform" /> è¿”å›
      </button>
      
      <div className="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden">
        <div className={`bg-gradient-to-r ${isEmployerMemory ? 'from-indigo-600 to-purple-600' : 'from-emerald-600 to-teal-600'} p-8 text-white`}>
          <div className="flex items-center gap-4 mb-4">
            <div className="p-3 bg-white/20 rounded-lg">
              <Brain size={28} />
            </div>
            <div>
              <h1 className="text-2xl font-black">æ‰‹åŠ¨å½•å…¥æ–°è®°å¿†</h1>
              <p className={`${isEmployerMemory ? 'text-indigo-200' : 'text-emerald-200'} text-sm`}>
                {isEmployerMemory ? 'ä¸ºä¼ä¸šè®°å¿†æ³¨å…¥æ–°çš„è®°å¿†ä¸åå¥½' : 'ä¸ºä¸ªäººè®°å¿†æ·»åŠ æŠ€èƒ½ã€ç»éªŒä¸èŒä¸šç›®æ ‡'}
              </p>
            </div>
          </div>
        </div>
        
        <div className="p-8">
          <div className="mb-8">
            <h3 className="text-sm font-black text-slate-400 uppercase tracking-widest mb-4">é€‰æ‹©è®°å¿†ç±»å‹</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {memoryTypes.map((type) => (
                <button
                  key={type.id}
                  onClick={() => setMemoryType(type.id)}
                  className={`p-4 rounded-lg border-2 transition-all text-left ${
                    memoryType === type.id 
                      ? 'border-indigo-600 bg-indigo-50' 
                      : 'border-slate-100 hover:border-slate-200'
                  }`}
                >
                  <div className={`w-10 h-10 rounded-lg ${type.color} flex items-center justify-center mb-3`}>
                    <type.icon size={20} />
                  </div>
                  <div className="font-bold text-slate-900 text-sm">{type.name}</div>
                  <div className="text-xs text-slate-500 mt-1">{type.desc}</div>
                </button>
              ))}
            </div>
          </div>
          
          <div className="mb-8">
            <h3 className="text-sm font-black text-slate-400 uppercase tracking-widest mb-4">è®°å¿†å†…å®¹</h3>
            <textarea
              value={content}
              onChange={(e) => setContent(e.target.value)}
              placeholder={`è¯·è¾“å…¥${memoryTypes.find(t => t.id === memoryType)?.name}ç›¸å…³çš„å†…å®¹...`}
              className="w-full h-40 bg-slate-50 border border-slate-200 rounded-lg p-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all resize-none"
            />
          </div>
          
          <div className="flex gap-4">
            <button
              onClick={handleSubmit}
              disabled={isSubmitting || !content.trim()}
              className="flex-1 py-4 bg-indigo-600 text-white rounded-lg font-black flex items-center justify-center gap-2 shadow-xl shadow-indigo-200 hover:bg-indigo-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isSubmitting ? (
                <>
                  <Loader2 size={20} className="animate-spin" />
                  AI å¤„ç†ä¸­...
                </>
              ) : (
                <>
                  <Sparkle size={20} />
                  æäº¤è®°å¿†
                </>
              )}
            </button>
          </div>
        </div>
        
        <div className="bg-slate-50 px-8 py-4 border-t border-slate-100 flex items-center justify-between">
          <div className="flex items-center gap-2 text-xs text-slate-500">
            <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
            AI Agent å·²å°±ç»ªï¼Œç­‰å¾…å­¦ä¹ æ–°è®°å¿†
          </div>
          <div className="text-xs text-slate-400">
            é¢„è®¡æ¶ˆè€—: çº¦ 2,000-5,000 Token
          </div>
        </div>
      </div>
    </div>
  );
};

// --- ç™»å½•/æ³¨å†Œè§†å›¾ (LoginView) ---
const LoginView = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { login, register, isLoggedIn, needsRoleSelection, userRole } = useAuth();
  const [loginMethod, setLoginMethod] = useState<'password' | 'code'>('password');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');
  const [countdown, setCountdown] = useState(0);
  const [isNewUser, setIsNewUser] = useState(false);
  const [showSetPassword, setShowSetPassword] = useState(false);
  const [newPassword, setNewPassword] = useState('');
  const [confirmNewPassword, setConfirmNewPassword] = useState('');
  
  // è·å–æ¥æºé¡µé¢ï¼ˆå¦‚æœæœ‰ï¼‰
  const from = (location.state as any)?.from || null;
  
  // ä» URL è·å–é‚€è¯·ç  ref å‚æ•°ï¼ˆhash æ¨¡å¼ï¼š#/login?ref=XXXX æˆ– #/register?ref=XXXXï¼‰
  const refCodeFromUrl = useMemo(() => {
    const hash = window.location.hash || '';
    const qIdx = hash.indexOf('?');
    if (qIdx >= 0) {
      const params = new URLSearchParams(hash.slice(qIdx));
      return (params.get('ref') || '').toUpperCase();
    }
    return '';
  }, []);
  
  // è¡¨å•æ•°æ®
  const [phone, setPhone] = useState('');
  const [password, setPassword] = useState('');
  const [verifyCode, setVerifyCode] = useState('');
  const [inviteCode, setInviteCode] = useState(refCodeFromUrl);
  
  // å·²ç™»å½•åˆ™è·³è½¬ï¼ˆé™¤ééœ€è¦è®¾ç½®å¯†ç ï¼‰
  useEffect(() => {
    if (isLoggedIn && !showSetPassword) {
      if (needsRoleSelection) {
        navigate('/select-role', { state: { from } });
      } else if (from) {
        navigate(from);
      } else {
        if (userRole === 'employer' || userRole === 'recruiter' || userRole === 'admin') {
          navigate('/employer');
        } else {
          navigate('/candidate');
        }
      }
    }
  }, [isLoggedIn, needsRoleSelection, navigate, from, userRole, showSetPassword]);

  // å€’è®¡æ—¶
  useEffect(() => {
    if (countdown > 0) {
      const timer = setTimeout(() => setCountdown(countdown - 1), 1000);
      return () => clearTimeout(timer);
    }
  }, [countdown]);

  // æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²æ³¨å†Œ
  const checkPhoneRegistered = async (phoneNum: string): Promise<boolean> => {
    try {
      const emailFormat = `${phoneNum}@phone.devnors.com`;
      // å°è¯•ç”¨ä¸€ä¸ªé”™è¯¯å¯†ç ç™»å½•æ¥æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
      const result = await login(emailFormat, '__check_only__');
      // å¦‚æœè¿”å›"é‚®ç®±æˆ–å¯†ç é”™è¯¯"è¯´æ˜ç”¨æˆ·å­˜åœ¨
      return result.error?.includes('é‚®ç®±æˆ–å¯†ç é”™è¯¯') || false;
    } catch {
      return false;
    }
  };

  // å‘é€éªŒè¯ç 
  const handleSendCode = async () => {
    if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
      setError('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
      return;
    }
    setError('');
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°ç”¨æˆ·
    const registered = await checkPhoneRegistered(phone);
    setIsNewUser(!registered);
    
    if (!registered) {
      // æ–°ç”¨æˆ·åªèƒ½éªŒè¯ç ç™»å½•
      setLoginMethod('code');
    }
    
    setCountdown(60);
    // TODO: è°ƒç”¨åç«¯å‘é€éªŒè¯ç API
    // ç›®å‰æ¨¡æ‹Ÿå‘é€æˆåŠŸ
  };

  // æ‰‹æœºå·å˜åŒ–æ—¶é‡ç½®çŠ¶æ€
  const handlePhoneChange = (value: string) => {
    const newPhone = value.replace(/\D/g, '').slice(0, 11);
    setPhone(newPhone);
    setIsNewUser(false);
    setError('');
  };

  // è®¾ç½®å¯†ç 
  const handleSetPassword = async () => {
    if (!newPassword || newPassword.length < 6) {
      setError('å¯†ç è‡³å°‘éœ€è¦6ä½');
      return;
    }
    if (newPassword !== confirmNewPassword) {
      setError('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´');
      return;
    }
    
    setIsLoading(true);
    try {
      // è°ƒç”¨ä¿®æ”¹å¯†ç API
      const { changePassword } = await import('./services/apiService');
      await changePassword('code_' + verifyCode, newPassword);
      setShowSetPassword(false);
      // è·³è½¬
      if (needsRoleSelection) {
        navigate('/select-role', { state: { from } });
      } else if (from) {
        navigate(from);
      } else {
        navigate('/candidate');
      }
    } catch (err: any) {
      setError(err.message || 'è®¾ç½®å¯†ç å¤±è´¥');
    } finally {
      setIsLoading(false);
    }
  };

  // è·³è¿‡è®¾ç½®å¯†ç 
  const handleSkipSetPassword = () => {
    setShowSetPassword(false);
    if (needsRoleSelection) {
      navigate('/select-role', { state: { from } });
    } else if (from) {
      navigate(from);
    } else {
      navigate('/candidate');
    }
  };
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    
    // éªŒè¯æ‰‹æœºå·
    if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
      setError('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
      return;
    }

    if (loginMethod === 'password') {
      if (!password || password.length < 6) {
        setError('å¯†ç è‡³å°‘éœ€è¦6ä½');
        return;
      }
    } else {
      if (!verifyCode || verifyCode.length !== 6) {
        setError('è¯·è¾“å…¥6ä½éªŒè¯ç ');
        return;
      }
    }
    
    setIsLoading(true);
    
    try {
      const emailFormat = `${phone}@phone.devnors.com`;
      
      if (loginMethod === 'code') {
        // éªŒè¯ç ç™»å½•
        const result = await login(emailFormat, 'code_' + verifyCode);
        if (!result.success) {
          // å°è¯•æ³¨å†Œï¼ˆæ–°ç”¨æˆ·ï¼‰
          const regResult = await register({ email: emailFormat, password: 'code_' + verifyCode, name: phone, role: 'VIEWER', ref_code: inviteCode || undefined });
          if (!regResult.success) {
            setError('éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ');
          } else {
            // æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨ç™»å½•
            const loginResult = await login(emailFormat, 'code_' + verifyCode);
            if (loginResult.success) {
              // é¦–æ¬¡ç™»å½•ï¼Œæç¤ºè®¾ç½®å¯†ç 
              setShowSetPassword(true);
            }
          }
        }
      } else {
        // å¯†ç ç™»å½•
        const result = await login(emailFormat, password);
        if (!result.success) {
          if (result.error?.includes('é‚®ç®±æˆ–å¯†ç é”™è¯¯')) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°ç”¨æˆ·
            setError('æ‰‹æœºå·æœªæ³¨å†Œæˆ–å¯†ç é”™è¯¯ï¼Œè¯·ä½¿ç”¨éªŒè¯ç ç™»å½•');
            setLoginMethod('code');
          } else {
            setError(result.error || 'ç™»å½•å¤±è´¥');
          }
        }
      }
    } catch (err: any) {
      setError(err.message || 'æ“ä½œå¤±è´¥');
    } finally {
      setIsLoading(false);
    }
  };

  // æµ‹è¯•è´¦å·å¿«é€Ÿç™»å½•
  const handleTestLogin = async (type: 'candidate' | 'employer') => {
    setIsLoading(true);
    setError('');
    const testAccounts = {
      candidate: { email: 'test@example.com', password: 'test123456' },
      employer: { email: 'hr@devnors.com', password: 'hr123456' },
    };
    const account = testAccounts[type];
    const result = await login(account.email, account.password);
    if (!result.success) {
      setError(result.error || 'ç™»å½•å¤±è´¥');
    }
    setIsLoading(false);
  };

  // è®¾ç½®å¯†ç ç•Œé¢
  if (showSetPassword) {
    return (
      <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 min-h-screen bg-gradient-to-b from-slate-50 to-white">
        <div className="bg-white rounded-lg p-10 shadow-2xl border border-slate-100 max-w-md mx-auto relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-emerald-500 via-teal-500 to-cyan-500"></div>
          
          <div className="text-center mb-8">
            <div className="w-16 h-16 bg-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-emerald-100">
              <Lock className="text-white" size={32}/>
            </div>
            <h2 className="text-2xl font-black text-slate-900 mb-2">è®¾ç½®ç™»å½•å¯†ç </h2>
            <p className="text-slate-400 text-sm font-medium">è®¾ç½®å¯†ç åå¯ä½¿ç”¨å¯†ç å¿«é€Ÿç™»å½•</p>
          </div>

          {error && (
            <div className="mb-6 p-4 bg-rose-50 border border-rose-200 rounded-lg text-rose-600 text-sm font-medium flex items-center gap-2">
              <AlertCircle size={16} />
              {error}
            </div>
          )}

          <div className="space-y-4">
            <div>
              <label className="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2">è®¾ç½®å¯†ç </label>
              <input 
                type="password" 
                value={newPassword}
                onChange={(e) => setNewPassword(e.target.value)}
                className="w-full bg-slate-50 border border-slate-100 rounded-lg py-3.5 px-4 font-medium focus:ring-4 focus:ring-emerald-500/10 focus:bg-white focus:border-emerald-300 focus:outline-none transition-all" 
                placeholder="è¯·è®¾ç½®å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
              />
            </div>
            <div>
              <label className="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2">ç¡®è®¤å¯†ç </label>
              <input 
                type="password" 
                value={confirmNewPassword}
                onChange={(e) => setConfirmNewPassword(e.target.value)}
                className="w-full bg-slate-50 border border-slate-100 rounded-lg py-3.5 px-4 font-medium focus:ring-4 focus:ring-emerald-500/10 focus:bg-white focus:border-emerald-300 focus:outline-none transition-all" 
                placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
              />
            </div>
            
            <button 
              onClick={handleSetPassword}
              disabled={isLoading}
              className="w-full bg-emerald-500 text-white font-black py-4 rounded-lg shadow-xl shadow-emerald-200 hover:bg-emerald-600 hover:shadow-2xl active:scale-[0.98] transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isLoading ? (
                <>
                  <Loader2 className="animate-spin" size={18} />
                  å¤„ç†ä¸­...
                </>
              ) : (
                'ç¡®è®¤è®¾ç½®'
              )}
            </button>
            
            <button 
              onClick={handleSkipSetPassword}
              className="w-full py-3 text-slate-500 font-medium hover:text-slate-700 transition-colors"
            >
              æš‚æ—¶è·³è¿‡ï¼Œç¨åè®¾ç½®
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 min-h-screen bg-gradient-to-b from-slate-50 to-white">
      <div className="bg-white rounded-lg p-10 shadow-2xl border border-slate-100 max-w-md mx-auto relative overflow-hidden">
        {/* å“ç‰Œè£…é¥° */}
        <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-600 via-purple-600 to-rose-600"></div>
        
        <div className="text-center mb-8">
          <div className="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-indigo-100 rotate-6 hover:rotate-0 transition-transform">
            <Zap className="text-white" size={32}/>
          </div>
          <h2 className="text-2xl font-black text-slate-900 mb-2">ç™»å½• / æ³¨å†Œ</h2>
          <p className="text-slate-400 text-sm font-medium">æœªæ³¨å†Œçš„æ‰‹æœºå·å°†è‡ªåŠ¨åˆ›å»ºè´¦å·</p>
        </div>

        {/* é”™è¯¯æç¤º */}
        {error && (
          <div className="mb-6 p-4 bg-rose-50 border border-rose-200 rounded-lg text-rose-600 text-sm font-medium flex items-center gap-2">
            <AlertCircle size={16} />
            {error}
          </div>
        )}

        {/* æ–°ç”¨æˆ·æç¤º */}
        {isNewUser && (
          <div className="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg text-amber-700 text-sm font-medium flex items-center gap-2">
            <AlertCircle size={16} />
            è¯¥æ‰‹æœºå·æœªæ³¨å†Œï¼Œè¯·ä½¿ç”¨éªŒè¯ç å®Œæˆé¦–æ¬¡ç™»å½•
          </div>
        )}

        {/* ç™»å½•æ–¹å¼åˆ‡æ¢ */}
        {!isNewUser && (
          <div className="flex bg-slate-100 rounded-lg p-1 mb-6">
            <button
              type="button"
              onClick={() => { setLoginMethod('password'); setError(''); }}
              className={`flex-1 py-2.5 text-sm font-bold rounded-md transition-all ${
                loginMethod === 'password' 
                  ? 'bg-white text-slate-900 shadow-sm' 
                  : 'text-slate-500 hover:text-slate-700'
              }`}
            >
              å¯†ç ç™»å½•
            </button>
            <button
              type="button"
              onClick={() => { setLoginMethod('code'); setError(''); }}
              className={`flex-1 py-2.5 text-sm font-bold rounded-md transition-all ${
                loginMethod === 'code' 
                  ? 'bg-white text-slate-900 shadow-sm' 
                  : 'text-slate-500 hover:text-slate-700'
              }`}
            >
              éªŒè¯ç ç™»å½•
            </button>
          </div>
        )}

        {/* ç™»å½•è¡¨å• */}
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2">æ‰‹æœºå·</label>
            <div className="relative">
              <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-medium">+86</span>
              <input 
                type="tel" 
                value={phone}
                onChange={(e) => handlePhoneChange(e.target.value)}
                className="w-full bg-slate-50 border border-slate-100 rounded-lg py-3.5 pl-14 pr-4 font-medium focus:ring-4 focus:ring-indigo-500/10 focus:bg-white focus:border-indigo-300 focus:outline-none transition-all" 
                placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
                maxLength={11}
                required
              />
            </div>
          </div>
          
          {(loginMethod === 'password' && !isNewUser) ? (
            <div>
              <label className="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2">å¯†ç </label>
              <input 
                type="password" 
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full bg-slate-50 border border-slate-100 rounded-lg py-3.5 px-4 font-medium focus:ring-4 focus:ring-indigo-500/10 focus:bg-white focus:border-indigo-300 focus:outline-none transition-all" 
                placeholder="è¯·è¾“å…¥å¯†ç "
                required
              />
            </div>
          ) : (
            <div>
              <label className="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2">éªŒè¯ç </label>
              <div className="flex gap-3">
                <input 
                  type="text" 
                  value={verifyCode}
                  onChange={(e) => setVerifyCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
                  className="flex-1 bg-slate-50 border border-slate-100 rounded-lg py-3.5 px-4 font-medium focus:ring-4 focus:ring-indigo-500/10 focus:bg-white focus:border-indigo-300 focus:outline-none transition-all" 
                  placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç "
                  maxLength={6}
                  required
                />
                <button
                  type="button"
                  onClick={handleSendCode}
                  disabled={countdown > 0}
                  className={`px-4 py-3.5 rounded-lg font-bold text-sm whitespace-nowrap transition-all ${
                    countdown > 0 
                      ? 'bg-slate-100 text-slate-400 cursor-not-allowed' 
                      : 'bg-indigo-100 text-indigo-600 hover:bg-indigo-200'
                  }`}
                >
                  {countdown > 0 ? `${countdown}s` : 'è·å–éªŒè¯ç '}
                </button>
              </div>
            </div>
          )}
          
          {/* é‚€è¯·ç ï¼ˆå¯é€‰ï¼‰ */}
          <div>
            <label className="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2">
              é‚€è¯·ç  <span className="text-slate-300 font-medium normal-case tracking-normal">ï¼ˆé€‰å¡«ï¼ŒåŒæ–¹è·èµ  Tokenï¼‰</span>
            </label>
            <div className="relative">
              <Gift size={16} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" />
              <input 
                type="text" 
                value={inviteCode}
                onChange={(e) => setInviteCode(e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 10))}
                className="w-full bg-slate-50 border border-slate-100 rounded-lg py-3.5 pl-11 pr-4 font-bold tracking-widest text-slate-700 focus:ring-4 focus:ring-indigo-500/10 focus:bg-white focus:border-indigo-300 focus:outline-none transition-all placeholder:font-medium placeholder:tracking-normal" 
                placeholder="è¾“å…¥å¥½å‹é‚€è¯·ç "
                maxLength={10}
              />
              {inviteCode && (
                <div className="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-1 text-emerald-500">
                  <CheckCircle size={14} />
                  <span className="text-[10px] font-bold">åŒæ–¹è·èµ </span>
                </div>
              )}
            </div>
          </div>

          <button 
            type="submit"
            disabled={isLoading}
            className="w-full bg-indigo-600 text-white font-black py-4 rounded-lg shadow-xl shadow-indigo-200 hover:bg-indigo-700 hover:shadow-2xl active:scale-[0.98] transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isLoading ? (
              <>
                <Loader2 className="animate-spin" size={18} />
                å¤„ç†ä¸­...
              </>
            ) : (
              isNewUser ? 'æ³¨å†Œå¹¶ç™»å½•' : 'ç™»å½•'
            )}
          </button>
        </form>

        {/* åˆ†å‰²çº¿ */}
        <div className="flex items-center gap-4 my-8">
          <div className="h-px bg-slate-100 flex-1"></div>
          <span className="text-xs font-black text-slate-300 uppercase tracking-widest">æµ‹è¯•è´¦å·</span>
          <div className="h-px bg-slate-100 flex-1"></div>
        </div>

        {/* æµ‹è¯•è´¦å·å¿«æ·å…¥å£ */}
        <div className="grid grid-cols-2 gap-3">
          <button 
            onClick={() => handleTestLogin('candidate')}
            disabled={isLoading}
            className="flex items-center justify-center gap-2 py-3 border border-emerald-200 bg-emerald-50 text-emerald-700 rounded-lg hover:bg-emerald-100 transition-all active:scale-95 disabled:opacity-50"
          >
            <UserIcon size={16} />
            <span className="text-xs font-black">æ±‚èŒè€…æµ‹è¯•</span>
          </button>
          <button 
            onClick={() => handleTestLogin('employer')}
            disabled={isLoading}
            className="flex items-center justify-center gap-2 py-3 border border-indigo-200 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 transition-all active:scale-95 disabled:opacity-50"
          >
            <Building2 size={16} />
            <span className="text-xs font-black">ä¼ä¸šæ–¹æµ‹è¯•</span>
          </button>
        </div>

        <p className="mt-8 text-center text-xs font-bold text-slate-300 uppercase tracking-[0.15em]">Devnors Auth Gateway</p>
      </div>
    </div>
  );
};

// --- èº«ä»½é€‰æ‹©è§†å›¾ (RoleSelectionView) ---
const RoleSelectionView = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { user, setUserRole, isLoggedIn, needsRoleSelection } = useAuth();
  const [isLoading, setIsLoading] = useState(false);
  const [selectedRole, setSelectedRole] = useState<'candidate' | 'employer' | null>(null);

  // è·å–æ¥æºé¡µé¢ï¼ˆå¦‚æœæœ‰ï¼‰
  const from = (location.state as any)?.from || null;

  // æœªç™»å½•è·³è½¬åˆ°ç™»å½•é¡µ
  useEffect(() => {
    if (!isLoggedIn) {
      navigate('/login');
    } else if (!needsRoleSelection) {
      // å·²é€‰æ‹©èº«ä»½ï¼Œè·³è½¬åˆ°å¯¹åº”é¡µé¢
      if (from) {
        navigate(from);
      } else {
        navigate('/ai-assistant');
      }
    }
  }, [isLoggedIn, needsRoleSelection, navigate, from]);

  const handleSelectRole = async (role: 'candidate' | 'employer') => {
    setSelectedRole(role);
    setIsLoading(true);
    await setUserRole(role);
    setIsLoading(false);
    // å¦‚æœæœ‰æ¥æºé¡µé¢ï¼Œè·³è½¬åˆ°æ¥æºé¡µé¢ï¼Œå¦åˆ™è·³è½¬åˆ° AI åŠ©æ‰‹
    if (from) {
      navigate(from);
    } else {
      navigate('/ai-assistant');
    }
  };

  return (
    <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 min-h-screen bg-gradient-to-b from-slate-50 to-white">
      <div className="max-w-2xl mx-auto text-center">
        <div className="w-20 h-20 bg-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-8 shadow-xl shadow-indigo-100">
          <Zap className="text-white" size={40}/>
        </div>
        
        <h1 className="text-3xl font-black text-slate-900 mb-4">
          æ¬¢è¿ï¼Œ{user?.name || 'ç”¨æˆ·'}ï¼
        </h1>
        <p className="text-slate-500 font-medium mb-12">
          è¯·é€‰æ‹©æ‚¨çš„èº«ä»½ï¼Œæˆ‘ä»¬å°†ä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–çš„æœåŠ¡
        </p>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* æ±‚èŒè€… */}
          <button
            onClick={() => handleSelectRole('candidate')}
            disabled={isLoading}
            className={`group p-8 bg-white rounded-lg border-2 transition-all hover:shadow-xl hover:border-emerald-300 active:scale-[0.98] disabled:opacity-50 ${
              selectedRole === 'candidate' ? 'border-emerald-500 shadow-xl' : 'border-slate-100'
            }`}
          >
            <div className="w-16 h-16 bg-emerald-100 rounded-xl flex items-center justify-center mx-auto mb-6 group-hover:bg-emerald-500 group-hover:text-white transition-all">
              <UserIcon size={32} className="text-emerald-600 group-hover:text-white" />
            </div>
            <h3 className="text-xl font-black text-slate-900 mb-3">æˆ‘æ˜¯æ±‚èŒè€…</h3>
            <p className="text-slate-500 text-sm leading-relaxed mb-6">
              å¯»æ‰¾ç†æƒ³èŒä½ï¼Œè·å– AI èŒä¸šè§„åˆ’ï¼Œæ™ºèƒ½ç®€å†ä¼˜åŒ–
            </p>
            <ul className="text-left text-sm text-slate-600 space-y-2">
              <li className="flex items-center gap-2">
                <CheckCircle2 size={16} className="text-emerald-500" />
                AI æ™ºèƒ½ç®€å†åˆ†æ
              </li>
              <li className="flex items-center gap-2">
                <CheckCircle2 size={16} className="text-emerald-500" />
                ç²¾å‡†èŒä½åŒ¹é…æ¨è
              </li>
              <li className="flex items-center gap-2">
                <CheckCircle2 size={16} className="text-emerald-500" />
                AI é¢è¯•æ¨¡æ‹Ÿè®­ç»ƒ
              </li>
            </ul>
          </button>

          {/* ä¼ä¸šæ–¹ */}
          <button
            onClick={() => handleSelectRole('employer')}
            disabled={isLoading}
            className={`group p-8 bg-white rounded-lg border-2 transition-all hover:shadow-xl hover:border-indigo-300 active:scale-[0.98] disabled:opacity-50 ${
              selectedRole === 'employer' ? 'border-indigo-500 shadow-xl' : 'border-slate-100'
            }`}
          >
            <div className="w-16 h-16 bg-indigo-100 rounded-xl flex items-center justify-center mx-auto mb-6 group-hover:bg-indigo-500 group-hover:text-white transition-all">
              <Building2 size={32} className="text-indigo-600 group-hover:text-white" />
            </div>
            <h3 className="text-xl font-black text-slate-900 mb-3">æˆ‘æ˜¯æ‹›è˜æ–¹</h3>
            <p className="text-slate-500 text-sm leading-relaxed mb-6">
              å‘å¸ƒèŒä½ï¼Œæ™ºèƒ½ç­›é€‰äººæ‰ï¼ŒAI è¾…åŠ©é¢è¯•è¯„ä¼°
            </p>
            <ul className="text-left text-sm text-slate-600 space-y-2">
              <li className="flex items-center gap-2">
                <CheckCircle2 size={16} className="text-indigo-500" />
                AI æ™ºèƒ½äººæ‰ç­›é€‰
              </li>
              <li className="flex items-center gap-2">
                <CheckCircle2 size={16} className="text-indigo-500" />
                è‡ªåŠ¨åŒ–æ‹›è˜æµç¨‹
              </li>
              <li className="flex items-center gap-2">
                <CheckCircle2 size={16} className="text-indigo-500" />
                æ™ºèƒ½é¢è¯•è¯„ä¼°æŠ¥å‘Š
              </li>
            </ul>
          </button>
        </div>

        {isLoading && (
          <div className="mt-8 flex items-center justify-center gap-2 text-indigo-600">
            <Loader2 className="animate-spin" size={20} />
            <span className="font-medium">æ­£åœ¨è®¾ç½®æ‚¨çš„èº«ä»½...</span>
          </div>
        )}
      </div>
    </div>
  );
};

interface TaskItem {
  id: string;
  title: string;
  status: 'running' | 'completed' | 'pending';
  time: string;
  icon: string;
  priority?: string;
  source?: string;
  type?: string;
}

// ç¼–è¾‘å­—æ®µé…ç½®
const EDIT_FIELD_CONFIG: Record<string, {
  label: string;
  prompt: string;
  validate: (value: string) => { valid: boolean; message: string };
  examples?: string[];
}> = {
  // æ±‚èŒè€…ç”»åƒå­—æ®µ
  'candidate_skill': {
    label: 'æŠ€èƒ½ä¸“é•¿',
    prompt: 'è¯·å‘Šè¯‰æˆ‘æ‚¨çš„æŠ€èƒ½ä¸“é•¿ï¼ŒåŒ…æ‹¬ï¼š\nâ€¢ ç¼–ç¨‹è¯­è¨€/æŠ€æœ¯æ ˆ\nâ€¢ å·¥å…·/æ¡†æ¶\nâ€¢ ä¸“ä¸šæŠ€èƒ½\n\nä¾‹å¦‚ï¼š"ç²¾é€š Pythonã€Reactï¼Œç†Ÿæ‚‰æœºå™¨å­¦ä¹ "',
    validate: (v) => v.length >= 5 ? { valid: true, message: '' } : { valid: false, message: 'è¯·è¾“å…¥è‡³å°‘5ä¸ªå­—ç¬¦ï¼Œè¯¦ç»†æè¿°æ‚¨çš„æŠ€èƒ½' },
    examples: ['ç²¾é€š Python å’Œ React', '5å¹´ Java åç«¯å¼€å‘ç»éªŒ', 'ç†Ÿæ‚‰äº‘åŸç”Ÿå’Œ K8s']
  },
  'candidate_experience': {
    label: 'å·¥ä½œç»å†',
    prompt: 'è¯·æè¿°æ‚¨çš„å·¥ä½œç»å†ï¼ŒåŒ…æ‹¬ï¼š\nâ€¢ å…¬å¸åç§°\nâ€¢ èŒä½\nâ€¢ å·¥ä½œå¹´é™\nâ€¢ ä¸»è¦èŒè´£\n\nä¾‹å¦‚ï¼š"åœ¨å­—èŠ‚è·³åŠ¨æ‹…ä»»é«˜çº§å·¥ç¨‹å¸ˆ3å¹´ï¼Œè´Ÿè´£æ¨èç³»ç»Ÿå¼€å‘"',
    validate: (v) => v.length >= 10 ? { valid: true, message: '' } : { valid: false, message: 'è¯·è¯¦ç»†æè¿°æ‚¨çš„å·¥ä½œç»å†ï¼Œè‡³å°‘10ä¸ªå­—ç¬¦' },
    examples: ['é˜¿é‡Œå·´å·´ é«˜çº§å·¥ç¨‹å¸ˆ 3å¹´', 'è…¾è®¯ äº§å“ç»ç† 2å¹´']
  },
  'candidate_goal': {
    label: 'èŒä¸šç›®æ ‡',
    prompt: 'è¯·å‘Šè¯‰æˆ‘æ‚¨çš„èŒä¸šç›®æ ‡ï¼š\nâ€¢ æœŸæœ›èŒä½\nâ€¢ æœŸæœ›è–ªèµ„èŒƒå›´\nâ€¢ æœŸæœ›å·¥ä½œåœ°ç‚¹\nâ€¢ èŒä¸šå‘å±•æ–¹å‘\n\nä¾‹å¦‚ï¼š"ç›®æ ‡æŠ€æœ¯æ€»ç›‘ï¼ŒæœŸæœ›å¹´è–ª80-120ä¸‡ï¼ŒåŒ—äº¬"',
    validate: (v) => v.length >= 5 ? { valid: true, message: '' } : { valid: false, message: 'è¯·æè¿°æ‚¨çš„èŒä¸šç›®æ ‡' },
    examples: ['æœŸæœ›æŠ€æœ¯æ€»ç›‘å²—ä½', 'ç›®æ ‡å¹´è–ª 50-80 ä¸‡']
  },
  'candidate_preference': {
    label: 'æ±‚èŒåå¥½',
    prompt: 'è¯·å‘Šè¯‰æˆ‘æ‚¨çš„æ±‚èŒåå¥½ï¼š\nâ€¢ æœŸæœ›çš„å…¬å¸ç±»å‹ï¼ˆå¤§å‚/åˆ›ä¸šå…¬å¸/å¤–ä¼ï¼‰\nâ€¢ å·¥ä½œæ–¹å¼ï¼ˆè¿œç¨‹/æ··åˆ/ç°åœºï¼‰\nâ€¢ å›¢é˜Ÿæ–‡åŒ–åå¥½\n\nä¾‹å¦‚ï¼š"åå¥½è¿œç¨‹åŠå…¬çš„æŠ€æœ¯é©±åŠ¨å‹å…¬å¸"',
    validate: (v) => v.length >= 5 ? { valid: true, message: '' } : { valid: false, message: 'è¯·æè¿°æ‚¨çš„æ±‚èŒåå¥½' },
    examples: ['åå¥½è¿œç¨‹åŠå…¬', 'å–œæ¬¢æŠ€æœ¯æ°›å›´æµ“åšçš„å›¢é˜Ÿ']
  },
  // ä¼ä¸šç”»åƒå­—æ®µ
  'employer_company': {
    label: 'å…¬å¸ä»‹ç»',
    prompt: 'è¯·ä»‹ç»æ‚¨çš„å…¬å¸ï¼š\nâ€¢ å…¬å¸åç§°å’Œè¡Œä¸š\nâ€¢ ä¸»è¥ä¸šåŠ¡\nâ€¢ å…¬å¸è§„æ¨¡\nâ€¢ å‘å±•é˜¶æ®µ\n\nä¾‹å¦‚ï¼š"XXç§‘æŠ€ï¼Œä¸“æ³¨AIé¢†åŸŸï¼ŒBè½®èèµ„ï¼Œ200äººè§„æ¨¡"',
    validate: (v) => v.length >= 10 ? { valid: true, message: '' } : { valid: false, message: 'è¯·è¯¦ç»†ä»‹ç»å…¬å¸ä¿¡æ¯ï¼Œè‡³å°‘10ä¸ªå­—ç¬¦' },
    examples: ['ä¸“æ³¨ AI é¢†åŸŸçš„ B è½®åˆ›ä¸šå…¬å¸']
  },
  'employer_culture': {
    label: 'ä¼ä¸šæ–‡åŒ–',
    prompt: 'è¯·æè¿°æ‚¨å…¬å¸çš„ä¼ä¸šæ–‡åŒ–ï¼š\nâ€¢ æ ¸å¿ƒä»·å€¼è§‚\nâ€¢ å·¥ä½œæ°›å›´\nâ€¢ å›¢é˜Ÿç‰¹ç‚¹\n\nä¾‹å¦‚ï¼š"æ‰å¹³åŒ–ç®¡ç†ï¼ŒæŠ€æœ¯é©±åŠ¨ï¼Œé¼“åŠ±åˆ›æ–°"',
    validate: (v) => v.length >= 5 ? { valid: true, message: '' } : { valid: false, message: 'è¯·æè¿°ä¼ä¸šæ–‡åŒ–' },
    examples: ['æ‰å¹³åŒ–ç®¡ç†', 'æŠ€æœ¯é©±åŠ¨ï¼Œé¼“åŠ±åˆ›æ–°']
  },
  'employer_requirement': {
    label: 'æ‹›è˜éœ€æ±‚',
    prompt: 'è¯·æè¿°æ‚¨çš„æ‹›è˜éœ€æ±‚ï¼š\nâ€¢ æ‹›è˜å²—ä½\nâ€¢ äººæ•°\nâ€¢ æŠ€èƒ½è¦æ±‚\nâ€¢ ç»éªŒè¦æ±‚\n\nä¾‹å¦‚ï¼š"æ‹›è˜3åé«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆï¼Œè¦æ±‚3å¹´ä»¥ä¸ŠReactç»éªŒ"',
    validate: (v) => v.length >= 10 ? { valid: true, message: '' } : { valid: false, message: 'è¯·è¯¦ç»†æè¿°æ‹›è˜éœ€æ±‚' },
    examples: ['æ‹›è˜é«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆ 3 å', 'éœ€è¦ 3 å¹´ä»¥ä¸Šç»éªŒ']
  },
  'employer_benefit': {
    label: 'ç¦åˆ©å¾…é‡',
    prompt: 'è¯·æè¿°å…¬å¸æä¾›çš„ç¦åˆ©å¾…é‡ï¼š\nâ€¢ è–ªèµ„èŒƒå›´\nâ€¢ å¥–é‡‘/æœŸæƒ\nâ€¢ å‡æœŸç¦åˆ©\nâ€¢ å…¶ä»–ç¦åˆ©\n\nä¾‹å¦‚ï¼š"æœˆè–ª30-50Kï¼Œå¹´ç»ˆå¥–3-6ä¸ªæœˆï¼Œå¼¹æ€§å·¥ä½œï¼Œå…è´¹ä¸‰é¤"',
    validate: (v) => v.length >= 5 ? { valid: true, message: '' } : { valid: false, message: 'è¯·æè¿°ç¦åˆ©å¾…é‡' },
    examples: ['å¹´ç»ˆå¥– 3-6 ä¸ªæœˆ', 'å¼¹æ€§å·¥ä½œæ—¶é—´']
  },
  // ä¸ªäººèµ„æ–™å­—æ®µ
  'candidate_name': {
    label: 'å§“å',
    prompt: 'è¯·è¾“å…¥æ‚¨çš„å§“åï¼ˆä¸­è‹±æ–‡çš†å¯ï¼‰',
    validate: (v) => v.length >= 2 ? { valid: true, message: '' } : { valid: false, message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„å§“å' },
    examples: ['å¼ ä¸‰', 'John Doe']
  },
  'candidate_title': {
    label: 'èŒä½å¤´è¡”',
    prompt: 'è¯·è¾“å…¥æ‚¨å½“å‰æˆ–æœŸæœ›çš„èŒä½å¤´è¡”\n\nä¾‹å¦‚ï¼š"é«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆ"ã€"äº§å“ç»ç†"',
    validate: (v) => v.length >= 2 ? { valid: true, message: '' } : { valid: false, message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„èŒä½å¤´è¡”' },
    examples: ['é«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆ', 'èµ„æ·±äº§å“ç»ç†', 'AIç®—æ³•å·¥ç¨‹å¸ˆ']
  },
  'candidate_summary': {
    label: 'ä¸ªäººç®€ä»‹',
    prompt: 'è¯·ç®€è¦ä»‹ç»è‡ªå·±ï¼ˆ100-300å­—ï¼‰ï¼š\nâ€¢ ä¸“ä¸šèƒŒæ™¯\nâ€¢ æ ¸å¿ƒèƒ½åŠ›\nâ€¢ èŒä¸šäº®ç‚¹\n\nä¾‹å¦‚ï¼š"8å¹´äº’è”ç½‘ä»ä¸šç»éªŒï¼Œä¸“æ³¨äºå‰ç«¯æ¶æ„è®¾è®¡..."',
    validate: (v) => v.length >= 20 ? { valid: true, message: '' } : { valid: false, message: 'ä¸ªäººç®€ä»‹è‡³å°‘20ä¸ªå­—ç¬¦' },
    examples: ['8å¹´äº’è”ç½‘ç»éªŒï¼Œä¸“æ³¨å‰ç«¯æ¶æ„', 'å¤šå¹´ AI ç®—æ³•ç ”å‘ç»éªŒ']
  },
  // ä¼ä¸šèµ„æ–™å­—æ®µ
  'employer_name': {
    label: 'å…¬å¸åç§°',
    prompt: 'è¯·è¾“å…¥å…¬å¸å…¨ç§°',
    validate: (v) => v.length >= 2 ? { valid: true, message: '' } : { valid: false, message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„å…¬å¸åç§°' },
    examples: ['å¾—è‹¥æ™ºèƒ½ç§‘æŠ€', 'Devnors Tech']
  },
  'employer_mission': {
    label: 'ä¼ä¸šä½¿å‘½',
    prompt: 'è¯·æè¿°å…¬å¸çš„ä½¿å‘½å’Œæ„¿æ™¯ï¼š\nâ€¢ å…¬å¸è¿½æ±‚çš„ç›®æ ‡\nâ€¢ æƒ³è¦åˆ›é€ çš„ä»·å€¼\nâ€¢ å¯¹è¡Œä¸šçš„æ„¿æ™¯',
    validate: (v) => v.length >= 10 ? { valid: true, message: '' } : { valid: false, message: 'è¯·æè¿°ä¼ä¸šä½¿å‘½' },
    examples: ['ç”¨ AI é‡å¡‘ç”Ÿäº§åŠ›', 'è®©æ‹›è˜æ›´æ™ºèƒ½']
  },
  'employer_tech': {
    label: 'æŠ€æœ¯æ ˆ',
    prompt: 'è¯·æè¿°å…¬å¸ä½¿ç”¨çš„æŠ€æœ¯æ ˆï¼š\nâ€¢ å¼€å‘è¯­è¨€\nâ€¢ æ¡†æ¶å·¥å…·\nâ€¢ æŠ€æœ¯ç†å¿µ',
    validate: (v) => v.length >= 5 ? { valid: true, message: '' } : { valid: false, message: 'è¯·æè¿°æŠ€æœ¯æ ˆ' },
    examples: ['Go + Kubernetes äº‘åŸç”Ÿæ¶æ„', 'Python + TensorFlow AI æŠ€æœ¯æ ˆ']
  }
};

// --- AIåŠ©æ‰‹é¡µé¢ (AIAssistantView) - æ•´åˆä»»åŠ¡è¯¦æƒ…ä¸ä¸ªæ€§åŒ–æç¤º ---
const AIAssistantView = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { user, isLoggedIn, userRole } = useAuth();
  const scrollRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const certImageInputRef = useRef<HTMLInputElement>(null);
  
  // è·å–ç”¨æˆ·IDå’Œèµ„æ–™æ•°æ®ï¼ˆç”¨äºæ£€æµ‹æ˜¯å¦ä¸ºæ–°ç”¨æˆ·ï¼‰
  // å¼€å‘ç¯å¢ƒé»˜è®¤ä½¿ç”¨ user_id=4ï¼ˆæµ‹è¯•ç”¨æˆ·ï¼‰ï¼Œç”Ÿäº§ç¯å¢ƒåº”ä¸º 1 æˆ–è¦æ±‚ç™»å½•
  const userId = user?.id || 4;
  const profileType = userRole === 'employer' ? 'employer' : 'candidate';
  const { data: userProfileData, loading: profileLoading } = useProfile(userId, profileType);
  
  // æŠ•é€’ç»Ÿè®¡æ•°æ®ï¼ˆäº‘ç«¯æ±‚èŒè½®å·¡ç”¨ï¼‰
  const { data: aiFlowStats } = useFlowStats(userId);

  // æ–‡ä»¶ä¸Šä¼ çŠ¶æ€
  const [uploadingFile, setUploadingFile] = useState(false);
  const [uploadingCertImage, setUploadingCertImage] = useState(false);
  
  // ä» URL è·å–å‚æ•°
  const searchParams = new URLSearchParams(location.search);
  const taskIdFromUrl = searchParams.get('taskId');
  const editTypeFromUrl = searchParams.get('editType');  // ç¼–è¾‘ç±»å‹: memory, profile, job
  const editFieldFromUrl = searchParams.get('editField'); // å­—æ®µå
  const editIdFromUrl = searchParams.get('editId');       // è®°å½•ID
  const taskTypeFromUrl = searchParams.get('taskType');   // ç‰¹æ®Šä»»åŠ¡ç±»å‹: apply
  
  // ç¼–è¾‘æ¨¡å¼çŠ¶æ€
  const [editMode, setEditMode] = useState<{
    active: boolean;
    type: string;
    field: string;
    id?: string;
    awaitingInput: boolean;
    validationError?: string;
  }>({ active: false, type: '', field: '', awaitingInput: false });
  
  // æ±‚èŒç”³è¯·æ¨¡å¼çŠ¶æ€
  const [applyMode, setApplyMode] = useState<{
    active: boolean;
    step: 'resume' | 'analyze' | 'match' | 'complete';
    resumeText: string;
    analysisResult: string | null;
  }>({ active: false, step: 'resume', resumeText: '', analysisResult: null });
  
  // æ‹›è˜å‘å¸ƒæ¨¡å¼çŠ¶æ€ï¼ˆå®Œæ•´æµç¨‹ï¼šéœ€æ±‚â†’ç”Ÿæˆâ†’ä¼˜åŒ–â†’å‘å¸ƒâ†’é‚€è¯·â†’ç­›é€‰â†’å®Œæˆï¼‰
  const [postMode, setPostMode] = useState<{
    active: boolean;
    step: 'requirement' | 'generate' | 'optimize' | 'invite' | 'screen' | 'complete';
    jobDescription: string;
    generatedResult: string | null;
    publishedJobs?: any[];  // å·²å‘å¸ƒçš„å²—ä½åˆ—è¡¨
  }>({ active: false, step: 'requirement', jobDescription: '', generatedResult: null });
  
  // é‚€è¯·å¥½å‹æ¨¡å¼çŠ¶æ€
  const [inviteMode, setInviteMode] = useState<{
    active: boolean;
    step: 'intro' | 'share' | 'track';
    inviteLink: string;
    inviteCount: number;
  }>({ active: false, step: 'intro', inviteLink: '', inviteCount: 0 });
  
  // å®Œå–„ç®€å†æ¨¡å¼çŠ¶æ€
  const [profileCompleteMode, setProfileCompleteMode] = useState<{
    active: boolean;
    missingFields: {key: string; label: string; editUrl: string}[];
    currentFieldIndex: number;
  }>({ active: false, missingFields: [], currentFieldIndex: -1 });
  
  // å®Œå–„ä¼ä¸šèµ„æ–™æ¨¡å¼çŠ¶æ€
  const [enterpriseProfileMode, setEnterpriseProfileMode] = useState<{
    active: boolean;
    missingFields: {key: string; label: string; type: 'text' | 'select' | 'textarea'; options?: string[]}[];
    currentFieldIndex: number;
  }>({ active: false, missingFields: [], currentFieldIndex: -1 });
  
  // DISCæµ‹è¯•æ¨¡å¼çŠ¶æ€
  const [discTestMode, setDiscTestMode] = useState<{
    active: boolean;
    currentQuestion: number;
    answers: {question: number; answer: string; dimension: string}[];
    completed: boolean;
  }>({ active: false, currentQuestion: 0, answers: [], completed: false });
  
  // DISCæµ‹è¯•é¢˜ç›®ï¼ˆæ ¹æ®ç”¨æˆ·ç®€å†åŠ¨æ€ç”Ÿæˆåœºæ™¯ï¼‰
  const discQuestions = [
    {
      id: 1,
      question: "å½“å›¢é˜Ÿé¡¹ç›®é‡åˆ°ç´§æ€¥é—®é¢˜æ—¶ï¼Œæ‚¨é€šå¸¸ä¼šï¼Ÿ",
      options: [
        { label: "A", text: "ç«‹å³ä¸»åŠ¨æ‰¿æ‹…è´£ä»»ï¼Œå¿«é€Ÿåˆ¶å®šè§£å†³æ–¹æ¡ˆ", dimension: "D" },
        { label: "B", text: "å¬é›†å›¢é˜Ÿè®¨è®ºï¼Œæ¿€åŠ±å¤§å®¶å…±åŒè§£å†³", dimension: "I" },
        { label: "C", text: "å…ˆå®‰æŠšå›¢é˜Ÿæƒ…ç»ªï¼Œæœ‰æ¡ä¸ç´Šåœ°å¤„ç†", dimension: "S" },
        { label: "D", text: "ä»”ç»†åˆ†æé—®é¢˜åŸå› ï¼Œç¡®ä¿æ‰¾åˆ°æ ¹æœ¬è§£å†³æ–¹æ¡ˆ", dimension: "C" }
      ]
    },
    {
      id: 2,
      question: "åœ¨å·¥ä½œä¼šè®®ä¸­ï¼Œæ‚¨æ›´å€¾å‘äºï¼Ÿ",
      options: [
        { label: "A", text: "ç›´æ¥è¡¨è¾¾è§‚ç‚¹ï¼Œæ¨åŠ¨ä¼šè®®é«˜æ•ˆè¿›è¡Œ", dimension: "D" },
        { label: "B", text: "ç§¯æå‘è¨€ï¼Œè¥é€ è½»æ¾çš„è®¨è®ºæ°›å›´", dimension: "I" },
        { label: "C", text: "å€¾å¬ä»–äººæ„è§ï¼Œå¯»æ±‚å…±è¯†", dimension: "S" },
        { label: "D", text: "å‡†å¤‡å……åˆ†çš„æ•°æ®ï¼Œæå‡ºæœ‰æ®å¯ä¾çš„å»ºè®®", dimension: "C" }
      ]
    },
    {
      id: 3,
      question: "é¢å¯¹æ–°çš„æŒ‘æˆ˜æ€§ä»»åŠ¡ï¼Œæ‚¨ä¼šï¼Ÿ",
      options: [
        { label: "A", text: "è¿éš¾è€Œä¸Šï¼ŒæŠŠå®ƒå½“ä½œè¯æ˜èƒ½åŠ›çš„æœºä¼š", dimension: "D" },
        { label: "B", text: "æ„Ÿåˆ°å…´å¥‹ï¼ŒæœŸå¾…ä¸å›¢é˜Ÿä¸€èµ·æ”»å…‹", dimension: "I" },
        { label: "C", text: "ç¨³æ­¥æ¨è¿›ï¼Œç¡®ä¿æ¯ä¸€æ­¥éƒ½æ‰å®å¯é ", dimension: "S" },
        { label: "D", text: "è¯¦ç»†è§„åˆ’ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±å†å¼€å§‹", dimension: "C" }
      ]
    },
    {
      id: 4,
      question: "ä¸åŒäº‹äº§ç”Ÿæ„è§åˆ†æ­§æ—¶ï¼Œæ‚¨é€šå¸¸ï¼Ÿ",
      options: [
        { label: "A", text: "åšæŒè‡ªå·±çš„è§‚ç‚¹ï¼Œç”¨äº‹å®è¯´æœå¯¹æ–¹", dimension: "D" },
        { label: "B", text: "ç”¨å¹½é»˜å’Œçƒ­æƒ…åŒ–è§£çŸ›ç›¾ï¼Œå¯»æ±‚åŒèµ¢", dimension: "I" },
        { label: "C", text: "å°Šé‡å¯¹æ–¹æ„è§ï¼Œå¯»æ‰¾æŠ˜ä¸­æ–¹æ¡ˆ", dimension: "S" },
        { label: "D", text: "å†·é™åˆ†æåŒæ–¹è§‚ç‚¹çš„åˆ©å¼Šï¼Œç†æ€§è®¨è®º", dimension: "C" }
      ]
    },
    {
      id: 5,
      question: "æ‚¨ç†æƒ³çš„å·¥ä½œç¯å¢ƒæ˜¯ï¼Ÿ",
      options: [
        { label: "A", text: "å¿«èŠ‚å¥ã€æœ‰æŒ‘æˆ˜ã€èƒ½å¤Ÿç‹¬ç«‹å†³ç­–", dimension: "D" },
        { label: "B", text: "å¼€æ”¾è‡ªç”±ã€å›¢é˜Ÿåä½œã€å……æ»¡æ´»åŠ›", dimension: "I" },
        { label: "C", text: "ç¨³å®šå’Œè°ã€å›¢é˜Ÿæ”¯æŒã€æœ‰å®‰å…¨æ„Ÿ", dimension: "S" },
        { label: "D", text: "æœ‰è§„èŒƒã€é‡è´¨é‡ã€èƒ½å¤Ÿä¸“æ³¨ç»†èŠ‚", dimension: "C" }
      ]
    },
    {
      id: 6,
      question: "å½“éœ€è¦åšé‡è¦å†³å®šæ—¶ï¼Œæ‚¨ä¼šï¼Ÿ",
      options: [
        { label: "A", text: "å¿«é€Ÿå†³ç­–ï¼Œç›¸ä¿¡è‡ªå·±çš„åˆ¤æ–­åŠ›", dimension: "D" },
        { label: "B", text: "å¾æ±‚æœ‹å‹åŒäº‹çš„æ„è§ï¼Œå¬å–å¤šæ–¹å»ºè®®", dimension: "I" },
        { label: "C", text: "ä»”ç»†æƒè¡¡å„ç§å› ç´ ï¼Œç¡®ä¿è€ƒè™‘å‘¨å…¨", dimension: "S" },
        { label: "D", text: "æ”¶é›†æ•°æ®å’Œè¯æ®ï¼Œè¿›è¡Œç³»ç»Ÿåˆ†æ", dimension: "C" }
      ]
    },
    {
      id: 7,
      question: "åœ¨é¡¹ç›®åˆä½œä¸­ï¼Œæ‚¨æ›´æ“…é•¿çš„è§’è‰²æ˜¯ï¼Ÿ",
      options: [
        { label: "A", text: "é¢†å¯¼è€… - å¸¦é¢†å›¢é˜Ÿå‘ç›®æ ‡å‰è¿›", dimension: "D" },
        { label: "B", text: "æ²Ÿé€šè€… - åè°ƒå„æ–¹ï¼Œå‡èšå›¢é˜Ÿ", dimension: "I" },
        { label: "C", text: "æ‰§è¡Œè€… - ç¨³å®šå¯é åœ°å®Œæˆä»»åŠ¡", dimension: "S" },
        { label: "D", text: "åˆ†æå¸ˆ - ç¡®ä¿æ–¹æ¡ˆçš„å®Œå–„å’Œå¯è¡Œ", dimension: "C" }
      ]
    },
    {
      id: 8,
      question: "é¢å¯¹å¤±è´¥æˆ–æŒ«æŠ˜ï¼Œæ‚¨é€šå¸¸ä¼šï¼Ÿ",
      options: [
        { label: "A", text: "æ€»ç»“æ•™è®­ï¼Œç«‹å³è°ƒæ•´ç­–ç•¥å†æˆ˜", dimension: "D" },
        { label: "B", text: "ä¿æŒä¹è§‚ï¼Œç”¨ç§¯ææ€åº¦å½±å“å›¢é˜Ÿ", dimension: "I" },
        { label: "C", text: "ç»™è‡ªå·±æ—¶é—´æ¶ˆåŒ–ï¼Œç„¶åç¨³æ­¥æ¢å¤", dimension: "S" },
        { label: "D", text: "æ·±å…¥å¤ç›˜ï¼Œæ‰¾å‡ºæ¯ä¸ªå¯æ”¹è¿›çš„ç»†èŠ‚", dimension: "C" }
      ]
    },
    {
      id: 9,
      question: "æ‚¨æ›´çœ‹é‡å·¥ä½œä¸­çš„ï¼Ÿ",
      options: [
        { label: "A", text: "æˆå°±æ„Ÿå’Œçªç ´ - ä¸æ–­æŒ‘æˆ˜è‡ªæˆ‘", dimension: "D" },
        { label: "B", text: "äººé™…å…³ç³»å’Œè®¤å¯ - è·å¾—ä»–äººè‚¯å®š", dimension: "I" },
        { label: "C", text: "ç¨³å®šå’Œå®‰å…¨ - å¯é¢„æœŸçš„å‘å±•", dimension: "S" },
        { label: "D", text: "ä¸“ä¸šå’Œç²¾ç¡® - åšåˆ°è¡Œä¸šæ ‡å‡†", dimension: "C" }
      ]
    },
    {
      id: 10,
      question: "å½“åˆ«äººå‘æ‚¨å¯»æ±‚å¸®åŠ©æ—¶ï¼Œæ‚¨é€šå¸¸ï¼Ÿ",
      options: [
        { label: "A", text: "ç›´æ¥ç»™å‡ºå»ºè®®å’Œè§£å†³æ–¹æ¡ˆ", dimension: "D" },
        { label: "B", text: "çƒ­æƒ…å›åº”ï¼Œå¹¶é¼“åŠ±å¯¹æ–¹", dimension: "I" },
        { label: "C", text: "è€å¿ƒå€¾å¬ï¼Œç»™äºˆæ”¯æŒå’Œå®‰æ…°", dimension: "S" },
        { label: "D", text: "å¸®åŠ©åˆ†æé—®é¢˜ï¼Œæä¾›è¯¦ç»†æŒ‡å¯¼", dimension: "C" }
      ]
    }
  ];
  
  // æ±‚èŒåå¥½æ¨¡å¼çŠ¶æ€
  const [jobSearchMode, setJobSearchMode] = useState<{
    active: boolean;
    currentQuestion: number;
    answers: {question: string; answer: string; key: string}[];
    completed: boolean;
    tokenUsed: number;
    isSearching: boolean;
  }>({ active: false, currentQuestion: 0, answers: [], completed: false, tokenUsed: 0, isSearching: false });
  
  // æ±‚èŒåå¥½é—®é¢˜æ¸…å•
  const jobSearchQuestions = [
    {
      id: 1,
      key: 'job_type',
      question: "æ‚¨æœŸæœ›çš„å·¥ä½œç±»å‹æ˜¯ï¼Ÿ",
      options: [
        { label: "A", text: "å…¨èŒ - ç¨³å®šçš„é•¿æœŸå·¥ä½œ" },
        { label: "B", text: "å…¼èŒ - çµæ´»çš„å…¼èŒå·¥ä½œ" },
        { label: "C", text: "å®ä¹  - å®ä¹ æˆ–åŸ¹è®­æœºä¼š" },
        { label: "D", text: "è‡ªç”±èŒä¸š - é¡¹ç›®åˆ¶/è¿œç¨‹å·¥ä½œ" }
      ]
    },
    {
      id: 2,
      key: 'salary_expectation',
      question: "æ‚¨çš„æœŸæœ›è–ªèµ„èŒƒå›´æ˜¯ï¼Ÿï¼ˆæœˆè–ªï¼‰",
      options: [
        { label: "A", text: "3K-8K" },
        { label: "B", text: "8K-15K" },
        { label: "C", text: "15K-25K" },
        { label: "D", text: "25Kä»¥ä¸Š / é¢è®®" }
      ]
    },
    {
      id: 3,
      key: 'work_location',
      question: "æ‚¨æœŸæœ›çš„å·¥ä½œåœ°ç‚¹æ˜¯ï¼Ÿ",
      options: [
        { label: "A", text: "ä¸€çº¿åŸå¸‚ï¼ˆåŒ—ä¸Šå¹¿æ·±ï¼‰" },
        { label: "B", text: "æ–°ä¸€çº¿åŸå¸‚ï¼ˆæ­å·ã€æˆéƒ½ã€æ­¦æ±‰ç­‰ï¼‰" },
        { label: "C", text: "äºŒä¸‰çº¿åŸå¸‚ / å®¶ä¹¡" },
        { label: "D", text: "ä¸é™ / å¯æ¥å—è¿œç¨‹" }
      ]
    },
    {
      id: 4,
      key: 'company_size',
      question: "æ‚¨åå¥½çš„å…¬å¸è§„æ¨¡æ˜¯ï¼Ÿ",
      options: [
        { label: "A", text: "å¤§å‚/ä¸Šå¸‚å…¬å¸ï¼ˆ1000äººä»¥ä¸Šï¼‰" },
        { label: "B", text: "ä¸­å‹ä¼ä¸šï¼ˆ100-1000äººï¼‰" },
        { label: "C", text: "åˆåˆ›å…¬å¸/å°å›¢é˜Ÿï¼ˆ100äººä»¥ä¸‹ï¼‰" },
        { label: "D", text: "ä¸é™ï¼Œçœ‹å²—ä½å’Œå‘å±•" }
      ]
    },
    {
      id: 5,
      key: 'industry_preference',
      question: "æ‚¨åå¥½çš„è¡Œä¸šé¢†åŸŸæ˜¯ï¼Ÿ",
      options: [
        { label: "A", text: "äº’è”ç½‘/ç§‘æŠ€" },
        { label: "B", text: "é‡‘è/å’¨è¯¢" },
        { label: "C", text: "æ•™è‚²/åŒ»ç–—/æ¶ˆè´¹" },
        { label: "D", text: "ä¸é™ï¼Œçœ‹å…·ä½“å²—ä½" }
      ]
    },
    {
      id: 6,
      key: 'remote_preference',
      question: "æ‚¨å¯¹è¿œç¨‹åŠå…¬çš„æ€åº¦æ˜¯ï¼Ÿ",
      options: [
        { label: "A", text: "å¿…é¡»æ”¯æŒè¿œç¨‹/æ··åˆåŠå…¬" },
        { label: "B", text: "ä¼˜å…ˆè€ƒè™‘æ”¯æŒè¿œç¨‹çš„" },
        { label: "C", text: "æ›´å–œæ¬¢ç°åœºåŠå…¬" },
        { label: "D", text: "æ— æ‰€è°“ï¼Œéƒ½å¯ä»¥æ¥å—" }
      ]
    },
    {
      id: 7,
      key: 'start_time',
      question: "æ‚¨æœŸæœ›çš„å…¥èŒæ—¶é—´æ˜¯ï¼Ÿ",
      options: [
        { label: "A", text: "éšæ—¶å¯ä»¥å…¥èŒ" },
        { label: "B", text: "1-2å‘¨å†…" },
        { label: "C", text: "1ä¸ªæœˆå†…" },
        { label: "D", text: "éœ€è¦è¾ƒé•¿æ—¶é—´äº¤æ¥ï¼ˆ1ä¸ªæœˆä»¥ä¸Šï¼‰" }
      ]
    },
    {
      id: 8,
      key: 'overtime_attitude',
      question: "æ‚¨å¯¹åŠ ç­çš„æ€åº¦æ˜¯ï¼Ÿ",
      options: [
        { label: "A", text: "æ¥å—é€‚åº¦åŠ ç­ï¼ˆå¶å°”ï¼‰" },
        { label: "B", text: "ä¸æ¥å—åŠ ç­ï¼Œæ³¨é‡å·¥ä½œç”Ÿæ´»å¹³è¡¡" },
        { label: "C", text: "å¯ä»¥æ¥å—é«˜å¼ºåº¦å·¥ä½œï¼ˆæœ‰åŠ ç­è´¹ï¼‰" },
        { label: "D", text: "æ ¹æ®é¡¹ç›®æƒ…å†µçµæ´»å¤„ç†" }
      ]
    },
    {
      id: 9,
      key: 'travel_requirement',
      question: "æ‚¨å¯¹å‡ºå·®çš„æ¥å—ç¨‹åº¦æ˜¯ï¼Ÿ",
      options: [
        { label: "A", text: "ä¸æ¥å—å‡ºå·®" },
        { label: "B", text: "æ¥å—å¶å°”å‡ºå·®ï¼ˆæ¯æœˆ1-2æ¬¡ï¼‰" },
        { label: "C", text: "æ¥å—é¢‘ç¹å‡ºå·®" },
        { label: "D", text: "æ— æ‰€è°“ï¼Œçœ‹å·¥ä½œéœ€è¦" }
      ]
    },
    {
      id: 10,
      key: 'career_focus',
      question: "æ‚¨ç›®å‰æœ€çœ‹é‡çš„èŒä¸šå‘å±•å› ç´ æ˜¯ï¼Ÿ",
      options: [
        { label: "A", text: "è–ªèµ„å¾…é‡ - æ”¶å…¥æ˜¯é¦–è¦è€ƒè™‘" },
        { label: "B", text: "æˆé•¿ç©ºé—´ - å­¦ä¹ å’Œæ™‹å‡æœºä¼š" },
        { label: "C", text: "å·¥ä½œç¨³å®š - ç¨³å®šå‹å€’ä¸€åˆ‡" },
        { label: "D", text: "å›¢é˜Ÿæ°›å›´ - å¼€å¿ƒæœ€é‡è¦" }
      ]
    }
  ];
  
  // å®Œå–„è®¤è¯æ¨¡å¼çŠ¶æ€
  const [verificationMode, setVerificationMode] = useState<{
    active: boolean;
    items: {key: string; label: string; icon: string; description: string; needsImage: boolean}[];
    currentIndex: number;
    completedItems: string[];
    identityName?: string;  // èº«ä»½è¯ä¸Šçš„å§“åï¼Œç”¨äºåç»­è®¤è¯æ ¡éªŒ
  }>({ active: false, items: [], currentIndex: -1, completedItems: [] });
  
  // ä¼ä¸šè®¤è¯æ¨¡å¼çŠ¶æ€
  const [enterpriseVerificationMode, setEnterpriseVerificationMode] = useState<{
    active: boolean;
    items: {key: string; label: string; icon: string; description: string; needsImage: boolean; required?: boolean}[];
    currentIndex: number;
    completedItems: string[];
    companyName?: string;  // è¥ä¸šæ‰§ç…§ä¸Šçš„ä¼ä¸šåç§°
    legalRepresentative?: string;  // è¥ä¸šæ‰§ç…§ä¸Šçš„æ³•å®šä»£è¡¨äººå§“åï¼ˆç”¨äºæ ¡éªŒèº«ä»½è¯ï¼‰
    // æ³•äººèº«ä»½è¯ä¸´æ—¶å­˜å‚¨ï¼ˆæ­£é¢å®¡æ ¸åä¿å­˜ï¼ŒèƒŒé¢å®¡æ ¸ååˆå¹¶åˆ›å»ºè®°å½•ï¼‰
    legalPersonIdFront?: {
      name: string;
      idNumber: string;
      imageData: string;
    };
  }>({ active: false, items: [], currentIndex: -1, completedItems: [] });
  
  // è®¤è¯é¡¹ç›®å®šä¹‰
  const verificationItems = [
    { key: 'identity_front', label: 'èº«ä»½è®¤è¯ï¼ˆæ­£é¢ï¼‰', icon: 'ğŸ†”', description: 'è¯·ä¸Šä¼ æ‚¨çš„**èº«ä»½è¯æ­£é¢ç…§ç‰‡**ï¼ˆäººåƒé¢ï¼‰\n\nğŸ“· ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®é€‰æ‹©å›¾ç‰‡\n\nâš ï¸ è¦æ±‚ï¼š\nâ€¢ å›¾ç‰‡æ¸…æ™°ï¼Œå§“åã€èº«ä»½è¯å·å¯è¾¨è®¤\nâ€¢ æ”¯æŒ JPG/PNG æ ¼å¼\nâ€¢ å¤§å°ä¸è¶…è¿‡ 10MB\n\nâš ï¸ **èº«ä»½è®¤è¯æ˜¯å¿…å¡«é¡¹**ï¼Œä¸èƒ½è·³è¿‡', needsImage: true },
    { key: 'identity_back', label: 'èº«ä»½è®¤è¯ï¼ˆåé¢ï¼‰', icon: 'ğŸ†”', description: 'è¯·ä¸Šä¼ æ‚¨çš„**èº«ä»½è¯åé¢ç…§ç‰‡**ï¼ˆå›½å¾½é¢ï¼‰\n\nğŸ“· ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®é€‰æ‹©å›¾ç‰‡\n\nâš ï¸ è¦æ±‚ï¼š\nâ€¢ å›¾ç‰‡æ¸…æ™°ï¼Œæœ‰æ•ˆæœŸå¯è¾¨è®¤\nâ€¢ æ”¯æŒ JPG/PNG æ ¼å¼\nâ€¢ å¤§å°ä¸è¶…è¿‡ 10MB\n\nâš ï¸ **èº«ä»½è®¤è¯æ˜¯å¿…å¡«é¡¹**ï¼Œä¸èƒ½è·³è¿‡', needsImage: true },
    { key: 'education', label: 'å­¦å†è®¤è¯', icon: 'ğŸ“', description: 'è¯·ä¸Šä¼ æ‚¨çš„**å­¦å†è¯ä¹¦/å­¦ä½è¯ä¹¦ç…§ç‰‡**\n\nğŸ“· ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®é€‰æ‹©å›¾ç‰‡\n\nâš ï¸ è¦æ±‚ï¼š\nâ€¢ å›¾ç‰‡æ¸…æ™°ï¼Œå­¦æ ¡å’Œä¸“ä¸šå¯è¾¨è®¤\nâ€¢ æ”¯æŒ JPG/PNG æ ¼å¼\nâ€¢ å¤§å°ä¸è¶…è¿‡ 10MB\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹', needsImage: true },
    { key: 'skill_driver', label: 'æŠ€èƒ½è®¤è¯ - é©¾é©¶è¯', icon: 'ğŸš—', description: 'è¯·ä¸Šä¼ æ‚¨çš„**é©¾é©¶è¯ç…§ç‰‡**\n\nğŸ“· ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®é€‰æ‹©å›¾ç‰‡\n\nâš ï¸ è¦æ±‚ï¼š\nâ€¢ å›¾ç‰‡æ¸…æ™°ï¼Œå‡†é©¾è½¦å‹å’Œæœ‰æ•ˆæœŸå¯è¾¨è®¤\nâ€¢ æ”¯æŒ JPG/PNG æ ¼å¼\nâ€¢ å¤§å°ä¸è¶…è¿‡ 10MB\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹', needsImage: true },
    { key: 'skill_cert', label: 'æŠ€èƒ½è®¤è¯ - èŒä¸šè¯ä¹¦', icon: 'ğŸ†', description: 'è¯·ä¸Šä¼ æ‚¨çš„**èŒä¸šèµ„æ ¼è¯ä¹¦ç…§ç‰‡**\n\nğŸ“· ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®é€‰æ‹©å›¾ç‰‡\n\n**æ”¯æŒçš„è¯ä¹¦ç±»å‹ï¼š**\nâ€¢ å›½å®¶èŒä¸šèµ„æ ¼è¯ä¹¦\nâ€¢ ä¸“ä¸šæŠ€æœ¯èµ„æ ¼è¯ä¹¦\nâ€¢ æŠ€èƒ½ç­‰çº§è¯ä¹¦\nâ€¢ è¡Œä¸šè®¤è¯è¯ä¹¦ï¼ˆPMPã€CPAç­‰ï¼‰\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹', needsImage: true },
    { key: 'work', label: 'å·¥ä½œè¯æ˜', icon: 'ğŸ’¼', description: 'è¯·ä¸Šä¼ æ‚¨çš„**å·¥ä½œè¯æ˜ææ–™**\n\nğŸ“· ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®é€‰æ‹©å›¾ç‰‡\n\n**æ”¯æŒçš„è¯æ˜ç±»å‹ï¼š**\nâ€¢ å·¥ç‰Œç…§ç‰‡\nâ€¢ ä¼ä¸šé‚®ç®±æˆªå›¾\nâ€¢ åœ¨èŒè¯æ˜\nâ€¢ ç¦»èŒè¯æ˜\nâ€¢ åŠ³åŠ¨åˆåŒï¼ˆå¯æ‰“ç æ•æ„Ÿä¿¡æ¯ï¼‰\n\nâš ï¸ è¯·ç¡®ä¿å…¬å¸åç§°å’Œæ‚¨çš„å§“åæ¸…æ™°å¯è§\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹', needsImage: true },
    { key: 'credit_fund', label: 'å¾ä¿¡è®¤è¯ - å…¬ç§¯é‡‘è¯æ˜', icon: 'ğŸ ', description: 'è¯·ä¸Šä¼ æ‚¨çš„**å…¬ç§¯é‡‘ç¼´å­˜è¯æ˜**\n\nğŸ“· ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®é€‰æ‹©å›¾ç‰‡\n\n**æ”¯æŒçš„è¯æ˜ç±»å‹ï¼š**\nâ€¢ å…¬ç§¯é‡‘ç¼´å­˜è¯æ˜\nâ€¢ å…¬ç§¯é‡‘è´¦æˆ·æˆªå›¾\nâ€¢ ä½æˆ¿å…¬ç§¯é‡‘æŸ¥è¯¢ç»“æœ\n\nâš ï¸ è¯·ç¡®ä¿å§“åå’Œç¼´å­˜ä¿¡æ¯æ¸…æ™°å¯è§\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹', needsImage: true },
    { key: 'credit_social', label: 'å¾ä¿¡è®¤è¯ - ç¤¾ä¿è¯æ˜', icon: 'ğŸ¥', description: 'è¯·ä¸Šä¼ æ‚¨çš„**ç¤¾ä¿ç¼´çº³è¯æ˜**\n\nğŸ“· ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®é€‰æ‹©å›¾ç‰‡\n\n**æ”¯æŒçš„è¯æ˜ç±»å‹ï¼š**\nâ€¢ ç¤¾ä¿ç¼´çº³è¯æ˜\nâ€¢ ç¤¾ä¿è´¦æˆ·æˆªå›¾\nâ€¢ ç¤¾ä¿æŸ¥è¯¢ç»“æœ\n\nâš ï¸ è¯·ç¡®ä¿å§“åå’Œç¼´çº³ä¿¡æ¯æ¸…æ™°å¯è§\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹', needsImage: true }
  ];
  
  // ä¼ä¸šè®¤è¯é¡¹ç›®å®šä¹‰
  const enterpriseVerificationItems = [
    { key: 'business_license', label: 'è¥ä¸šæ‰§ç…§', icon: 'ğŸ¢', description: 'è¯·ä¸Šä¼ æ‚¨çš„**è¥ä¸šæ‰§ç…§ç…§ç‰‡**\n\nğŸ“· ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®é€‰æ‹©å›¾ç‰‡\n\nâš ï¸ è¦æ±‚ï¼š\nâ€¢ å›¾ç‰‡æ¸…æ™°ï¼Œä¼ä¸šåç§°ã€ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç å¯è¾¨è®¤\nâ€¢ æ”¯æŒ JPG/PNG æ ¼å¼\nâ€¢ å¤§å°ä¸è¶…è¿‡ 10MB\n\nâš ï¸ **è¥ä¸šæ‰§ç…§æ˜¯å¿…å¡«é¡¹**ï¼Œä¸èƒ½è·³è¿‡', needsImage: true, required: true },
    { key: 'legal_person_id_front', label: 'æ³•äººèº«ä»½è¯ï¼ˆæ­£é¢ï¼‰', icon: 'ğŸ†”', description: 'è¯·ä¸Šä¼ **ä¼ä¸šæ³•äººçš„èº«ä»½è¯æ­£é¢ç…§ç‰‡**ï¼ˆäººåƒé¢ï¼‰\n\nğŸ“· ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®é€‰æ‹©å›¾ç‰‡\n\nâš ï¸ è¦æ±‚ï¼š\nâ€¢ å›¾ç‰‡æ¸…æ™°ï¼Œå§“åã€èº«ä»½è¯å·å¯è¾¨è®¤\nâ€¢ æ³•äººå§“åéœ€ä¸è¥ä¸šæ‰§ç…§ä¸€è‡´\n\nâš ï¸ **æ³•äººèº«ä»½è¯æ˜¯å¿…å¡«é¡¹**ï¼Œä¸èƒ½è·³è¿‡', needsImage: true, required: true },
    { key: 'legal_person_id_back', label: 'æ³•äººèº«ä»½è¯ï¼ˆèƒŒé¢ï¼‰', icon: 'ğŸ†”', description: 'è¯·ä¸Šä¼ **ä¼ä¸šæ³•äººçš„èº«ä»½è¯èƒŒé¢ç…§ç‰‡**ï¼ˆå›½å¾½é¢ï¼‰\n\nğŸ“· ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®é€‰æ‹©å›¾ç‰‡\n\nâš ï¸ è¦æ±‚ï¼š\nâ€¢ å›¾ç‰‡æ¸…æ™°ï¼Œç­¾å‘æœºå…³ã€æœ‰æ•ˆæœŸå¯è¾¨è®¤\n\nâš ï¸ **æ³•äººèº«ä»½è¯æ˜¯å¿…å¡«é¡¹**ï¼Œä¸èƒ½è·³è¿‡', needsImage: true, required: true }
  ];
  
  // èº«ä»½è¯ä¸Šä¼ çŠ¶æ€
  const [idCardInfo, setIdCardInfo] = useState<{
    frontUploaded: boolean;
    backUploaded: boolean;
    frontInfo: Record<string, string> | null;
    backInfo: Record<string, string> | null;
    frontImage: string | null;
    backImage: string | null;
  }>({ frontUploaded: false, backUploaded: false, frontInfo: null, backInfo: null, frontImage: null, backImage: null });
  
  // è·å–ç”¨æˆ·ç”»åƒ memories æ¥åˆ¤æ–­å®Œå–„ç¨‹åº¦
  const memoryScope = userRole === 'employer' ? 'employer' : 'candidate';
  const { data: memoriesData, refetch: refetchMemories } = useMemories(userId, memoryScope);
  
  // è®¡ç®—ç”»åƒå®Œå–„ç¨‹åº¦
  const profileCompleteness = useMemo(() => {
    if (!memoriesData || memoriesData.length === 0) return 0;
    const types = new Set(memoriesData.map((m: any) => m.type));
    const requiredTypes = userRole === 'employer' 
      ? ['COMPANY', 'CULTURE', 'REQUIREMENT', 'BENEFIT']
      : ['SKILL', 'EXPERIENCE', 'GOAL', 'PREFERENCE'];
    const completedTypes = requiredTypes.filter(t => types.has(t)).length;
    return Math.round((completedTypes / requiredTypes.length) * 100);
  }, [memoriesData, userRole]);
  
  // æå–é«˜ä¼˜å…ˆçº§ä¼ä¸šè®°å¿†ä¸Šä¸‹æ–‡ â€” ç”¨äºæ³¨å…¥å¤§æ¨¡å‹ prompt
  // ç­›é€‰æ¡ä»¶ï¼šç±»å‹ä¸º"è¦æ±‚"çš„ + å¼ºåº¦>=2çš„å…¶ä»–ç±»å‹è®°å¿†
  const getMemoryContext = useCallback(() => {
    if (!memoriesData || memoriesData.length === 0) return '';
    
    // 1. æ‰€æœ‰"è¦æ±‚"ç±»å‹çš„è®°å¿†
    const requirementMemories = memoriesData.filter((m: any) => 
      m.type === 'è¦æ±‚' || m.raw_type === 'requirement'
    );
    
    // 2. å¼ºåº¦>=2 çš„å…¶ä»–ç±»å‹è®°å¿†ï¼ˆè¢«å¤šæ¬¡å¼ºè°ƒçš„åå¥½ï¼‰
    const highEmphasisMemories = memoriesData.filter((m: any) => 
      (m.emphasis_count || 1) >= 2 && 
      m.type !== 'è¦æ±‚' && m.raw_type !== 'requirement'
    );
    
    // 3. åŠ¨ä½œ/ç­–ç•¥ç±»è®°å¿†ï¼ˆè¡Œä¸ºè§„åˆ™ï¼‰
    const actionMemories = memoriesData.filter((m: any) =>
      (m.type === 'åŠ¨ä½œ' || m.raw_type === 'action' || m.type === 'ç­–ç•¥' || m.raw_type === 'strategy') &&
      (m.emphasis_count || 1) < 2  // é¿å…ä¸ä¸Šé¢é‡å¤
    );
    
    const allRelevant = [...requirementMemories, ...highEmphasisMemories, ...actionMemories];
    if (allRelevant.length === 0) return '';
    
    const lines = allRelevant.map((m: any) => {
      const strength = (m.emphasis_count || 1) > 1 ? `ï¼ˆå¼ºè°ƒÃ—${m.emphasis_count}ï¼‰` : '';
      return `â€¢ [${m.type}] ${m.content}${strength}`;
    });
    
    return `\n\nã€ä¼ä¸šè®°å¿†/åå¥½è¦æ±‚ â€” è¯·ä¸¥æ ¼éµå®ˆã€‘\nä»¥ä¸‹æ˜¯è¯¥ä¼ä¸šçš„å†å²åå¥½å’Œæ˜ç¡®è¦æ±‚ï¼Œç”Ÿæˆå†…å®¹æ—¶å¿…é¡»å‚è€ƒå¹¶éµå¾ªï¼š\n${lines.join('\n')}\n`;
  }, [memoriesData]);
  
  // æ‹›è˜å°±ç»ªçŠ¶æ€ï¼ˆemployer ç”¨äºé€šç”¨åŠ©æ‰‹åº•éƒ¨æç¤º"å¼€å§‹æ‹›è˜"ï¼‰
  const [recruitReady, setRecruitReady] = useState(false);
  // ä¼ä¸šè®¤è¯æ˜¯å¦å·²å®é™…å®Œæˆï¼ˆåŸºäºè®¤è¯æ•°æ®ï¼Œè€Œéä»…ä»»åŠ¡çŠ¶æ€ï¼‰
  const [enterpriseCertDone, setEnterpriseCertDone] = useState(false);
  useEffect(() => {
    if (userRole !== 'employer' && userRole !== 'recruiter') return;
    let cancelled = false;
    (async () => {
      try {
        const { getEnterpriseCertifications, getSettings } = await import('./services/apiService');
        const [certs, settings] = await Promise.all([
          getEnterpriseCertifications(userId).catch(() => []),
          getSettings(userId).catch(() => ({})),
        ]);
        if (cancelled) return;
        const hasCert = certs.some((c: any) => c.category === 'qualification' && c.name?.includes('è¥ä¸šæ‰§ç…§'));
        setEnterpriseCertDone(hasCert);
        const requiredFields = ['display_name', 'industry', 'company_size', 'detail_address', 'description'];
        const hasVal = (v: any) => v && typeof v === 'string' ? v.trim() !== '' && v.trim() !== '[]' && v.trim() !== '{}' : !!v;
        const profileDone = requiredFields.every(k => hasVal(settings[k]));
        setRecruitReady(hasCert && profileDone);
      } catch { /* ignore */ }
    })();
    return () => { cancelled = true; };
  }, [userRole, userId]);

  // é€‰ä¸­çš„ä»»åŠ¡
  const [selectedTask, setSelectedTask] = useState<any>(null);
  const [initialTaskLoaded, setInitialTaskLoaded] = useState(false);
  
  // ä»»åŠ¡ç­›é€‰çŠ¶æ€ï¼š'pending' | 'completed'
  const [taskFilter, setTaskFilter] = useState<'pending' | 'completed'>('pending');
  
  // æ£€æµ‹ç”¨æˆ·èµ„æ–™æ˜¯å¦ä¸ºç©ºï¼ˆæ–°ç”¨æˆ·ï¼‰
  const isNewUser = useMemo(() => {
    if (!userProfileData) return true;
    // æ£€æŸ¥å…³é”®å­—æ®µæ˜¯å¦ä¸ºç©º
    const hasDisplayName = userProfileData.display_name && userProfileData.display_name.trim() !== '';
    const hasTitle = userProfileData.title && userProfileData.title.trim() !== '';
    const hasSummary = userProfileData.summary && userProfileData.summary.trim() !== '';
    const hasProfileJson = userProfileData.profile_json && Object.keys(userProfileData.profile_json).length > 0;
    // å¦‚æœæ‰€æœ‰å…³é”®å­—æ®µéƒ½ä¸ºç©ºï¼Œåˆ™è®¤ä¸ºæ˜¯æ–°ç”¨æˆ·
    return !hasDisplayName && !hasTitle && !hasSummary && !hasProfileJson;
  }, [userProfileData]);
  
  // ç”Ÿæˆæ¬¢è¿æ¶ˆæ¯
  const getWelcomeMessage = (currentTasks?: any[]) => {
    if (!isLoggedIn) {
      return 'æ‚¨å¥½ï¼æˆ‘æ˜¯ Devnors AI æ™ºèƒ½åŠ©æ‰‹ã€‚\n\nè¯·å…ˆç™»å½•ä»¥è·å¾—ä¸ªæ€§åŒ–çš„æœåŠ¡ä½“éªŒã€‚';
    }
    const userName = user?.name || user?.email?.split('@')[0] || 'ç”¨æˆ·';
    
    // å®‰å…¨è·å–ä»»åŠ¡åˆ—è¡¨ï¼ˆå¯èƒ½åœ¨åˆå§‹åŒ–é˜¶æ®µtasksè¿˜æœªå£°æ˜ï¼‰
    let taskList: any[] = [];
    try {
      taskList = currentTasks || tasks || [];
    } catch {
      taskList = [];
    }
    
    if (userRole === 'employer' || userRole === 'recruiter') {
      // ä¼ä¸š/æ‹›è˜æ–¹ï¼šåŸºäºå®é™…æ•°æ®çŠ¶æ€åŠ¨æ€å¼•å¯¼ï¼ˆè€Œéä»…ä¾èµ–ä»»åŠ¡åˆ—è¡¨ï¼‰
      // recruitReady = ä¼ä¸šè®¤è¯ + ä¼ä¸šèµ„æ–™éƒ½å·²å®Œå–„ï¼ˆåŸºäºåç«¯å®é™…æ•°æ®åˆ¤æ–­ï¼‰
      if (recruitReady) {
        // ä¼ä¸šè®¤è¯å’Œèµ„æ–™éƒ½å·²å®Œå–„ï¼Œå¼•å¯¼æ‹›è˜æ‰¾äºº
        return `ğŸ‘‹ **${userName}ï¼Œæ¬¢è¿å›æ¥ï¼**\n\næ‚¨çš„ä¼ä¸šèµ„æ–™å·²å®Œå–„ï¼Œç°åœ¨å¯ä»¥å¼€å§‹æ‹›è˜å•¦ï¼š\n\n[[TASK:å¼€å§‹æ‹›è˜:post_job:ğŸš€]]\n\næˆ–ç›´æ¥å‘Šè¯‰æˆ‘æ‚¨çš„æ‹›è˜éœ€æ±‚~`;
      }
      
      // æ”¶é›†æœªå®Œæˆçš„ä»»åŠ¡å¼•å¯¼å¡ç‰‡
      const pendingGuides: string[] = [];
      if (!enterpriseCertDone) {
        pendingGuides.push('[[TASK:å®Œæˆä¼ä¸šè®¤è¯:enterprise_verification:ğŸ¢]]');
      }
      // recruitReady ä¸º false ä¸” enterpriseCertDone ä¸º true â†’ è¯´æ˜ä¼ä¸šèµ„æ–™æœªå®Œå–„
      if (enterpriseCertDone && !recruitReady) {
        pendingGuides.push('[[TASK:å®Œå–„ä¼ä¸šèµ„æ–™:enterprise_profile:ğŸ“‹]]');
      }
      // å¦‚æœéƒ½è¿˜æ²¡åŠ è½½å®Œï¼ˆenterpriseCertDone åˆå§‹ä¸º falseï¼‰ï¼Œè‡³å°‘æ˜¾ç¤ºè®¤è¯å’Œèµ„æ–™ä¸¤é¡¹
      if (pendingGuides.length === 0) {
        pendingGuides.push('[[TASK:å®Œæˆä¼ä¸šè®¤è¯:enterprise_verification:ğŸ¢]]');
        pendingGuides.push('[[TASK:å®Œå–„ä¼ä¸šèµ„æ–™:enterprise_profile:ğŸ“‹]]');
      }
      
      return `ğŸ‘‹ **${userName}ï¼Œæ¬¢è¿ä½¿ç”¨ Devnorsï¼**\n\næˆ‘æ˜¯æ‚¨çš„ AI æ‹›è˜åŠ©æ‰‹ï¼Œå»ºè®®æ‚¨å…ˆå®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š\n\n${pendingGuides.join('\n\n')}\n\næˆ–ç›´æ¥å‘Šè¯‰æˆ‘æ‚¨çš„æ‹›è˜éœ€æ±‚~`;
    } else {
      // æ±‚èŒè€…ï¼šæ ¹æ®ä»»åŠ¡å®ŒæˆçŠ¶æ€åŠ¨æ€å¼•å¯¼
      const resumeTask = taskList.find((t: any) => {
        const title = t.title || t.task || '';
        const type = (t.todo_type || t.type || '').toLowerCase();
        return type === 'profile_complete' || title === 'å®Œå–„ç®€å†èµ„æ–™' || 
          (title.includes('ç®€å†') && title.includes('èµ„æ–™'));
      });
      const personalCertTask = taskList.find((t: any) => {
        const title = t.title || t.task || '';
        const type = (t.todo_type || t.type || '').toLowerCase();
        return type === 'personal_verification' || title === 'å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯' || 
          (title.includes('ä¸ªäºº') && title.includes('è®¤è¯'));
      });
      const jobSearchTask = taskList.find((t: any) => {
        const title = t.title || t.task || '';
        const type = (t.todo_type || t.type || '').toLowerCase();
        return type === 'job_search' || title.includes('æ‰¾å·¥ä½œ') || title.includes('æ±‚èŒ');
      });
      
      const resumeCompleted = resumeTask?.status?.toLowerCase() === 'completed';
      const certCompleted = personalCertTask?.status?.toLowerCase() === 'completed';
      const jobSearchCompleted = jobSearchTask?.status?.toLowerCase() === 'completed';
      
      const pendingGuides: string[] = [];
      // ç®€å†èµ„æ–™ï¼ˆæœªå®Œæˆ æˆ– æ— ä»»åŠ¡è®°å½• â†’ é»˜è®¤æ˜¾ç¤ºï¼‰
      if (!resumeCompleted) {
        pendingGuides.push('[[TASK:å®Œå–„ç®€å†èµ„æ–™:profile_complete:ğŸ“]]');
      }
      // ä¸ªäººè®¤è¯
      if (!certCompleted) {
        pendingGuides.push('[[TASK:å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯:personal_verification:ğŸ”]]');
      }
      // æ‰¾å·¥ä½œï¼ˆç®€å†å®Œå–„åå¼•å¯¼æ±‚èŒï¼‰
      if (resumeCompleted && !jobSearchCompleted) {
        pendingGuides.push('[[TASK:å¼€å§‹æ‰¾å·¥ä½œ:job_search:ğŸš€]]');
      }
      
      // å…œåº•ï¼šè‡³å°‘æ˜¾ç¤ºç®€å†å’Œè®¤è¯ä¸¤é¡¹
      if (pendingGuides.length === 0) {
        pendingGuides.push('[[TASK:å®Œå–„ç®€å†èµ„æ–™:profile_complete:ğŸ“]]');
        pendingGuides.push('[[TASK:å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯:personal_verification:ğŸ”]]');
      }
      
      if (resumeCompleted && certCompleted && jobSearchCompleted) {
        return `ğŸ‘‹ **${userName}ï¼Œæ¬¢è¿å›æ¥ï¼**\n\næ‚¨çš„èµ„æ–™å·²å®Œå–„ï¼Œç°åœ¨å¯ä»¥å¼€å§‹æ™ºèƒ½æ±‚èŒå•¦ï¼š\n\n[[TASK:å¼€å§‹æ‰¾å·¥ä½œ:job_search:ğŸš€]]\n\næˆ–ç›´æ¥å‘Šè¯‰æˆ‘æ‚¨çš„ç›®æ ‡èŒä½å’Œæ ¸å¿ƒæŠ€èƒ½~`;
      }
      
      return `ğŸ‘‹ **${userName}ï¼Œæ¬¢è¿ä½¿ç”¨ Devnorsï¼**\n\næˆ‘æ˜¯æ‚¨çš„ AI æ±‚èŒåŠ©æ‰‹ï¼Œå»ºè®®æ‚¨å…ˆå®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š\n\n${pendingGuides.join('\n\n')}\n\næˆ–ç›´æ¥å‘Šè¯‰æˆ‘æ‚¨çš„ç›®æ ‡èŒä½å’Œæ ¸å¿ƒæŠ€èƒ½~`;
    }
  };
  
  // å¯¹è¯æŒä¹…åŒ–çš„ localStorage keysï¼ˆæŒ‰è§’è‰²éš”ç¦»ï¼Œåˆ‡æ¢èº«ä»½åå„è‡ªç‹¬ç«‹ï¼‰
  const GENERAL_MESSAGES_KEY = `devnors_general_messages_${userId || 'guest'}_${userRole}`;
  const TASK_MESSAGES_KEY = `devnors_task_messages_${userId || 'guest'}_${userRole}`;
  
  // ä» localStorage åŠ è½½å¯¹è¯ï¼ˆä½œä¸ºåå¤‡ï¼‰
  const loadSavedMessages = () => {
    try {
      const savedGeneral = localStorage.getItem(GENERAL_MESSAGES_KEY);
      if (savedGeneral) {
        return JSON.parse(savedGeneral);
      }
    } catch (e) {
      console.error('åŠ è½½å¯¹è¯å†å²å¤±è´¥:', e);
    }
    return [{role: 'assistant' as const, content: getWelcomeMessage()}];
  };
  
  const loadSavedTaskMessages = () => {
    try {
      const savedTasks = localStorage.getItem(TASK_MESSAGES_KEY);
      if (savedTasks) {
        return JSON.parse(savedTasks);
      }
    } catch (e) {
      console.error('åŠ è½½ä»»åŠ¡å¯¹è¯å†å²å¤±è´¥:', e);
    }
    return {};
  };
  
  // é€šç”¨å¯¹è¯æ¶ˆæ¯
  const [generalMessages, setGeneralMessages] = useState<{role: 'user' | 'assistant', content: string}[]>(loadSavedMessages);
  
  // ä»»åŠ¡ä¸“å±å¯¹è¯æ¶ˆæ¯ï¼ˆæŒ‰ä»»åŠ¡IDå­˜å‚¨ï¼‰
  const [taskMessages, setTaskMessages] = useState<Record<number, {role: 'user' | 'assistant', content: string}[]>>(loadSavedTaskMessages);
  
  // èŠå¤©æŒä¹…åŒ–ç›¸å…³çŠ¶æ€
  const [chatHistoryLoaded, setChatHistoryLoaded] = useState(false);
  const loadedTaskIds = useRef<Set<number>>(new Set());
  const persistedGeneralCount = useRef(0);
  const persistedTaskCounts = useRef<Record<number, number>>({});
  
  // è‡ªåŠ¨å°†æ–°å¢çš„é€šç”¨å¯¹è¯æ¶ˆæ¯æŒä¹…åŒ–åˆ°åç«¯
  useEffect(() => {
    if (!userId || !chatHistoryLoaded) return;
    const prevCount = persistedGeneralCount.current;
    const newMessages = generalMessages.slice(prevCount);
    if (newMessages.length > 0) {
      persistedGeneralCount.current = generalMessages.length;
      import('./services/apiService').then(({ saveChatMessage }) => {
        newMessages.forEach(msg => {
          saveChatMessage({ role: msg.role, content: msg.content, todo_id: null }, userId).catch(e =>
            console.error('[Chat Persist] ä¿å­˜é€šç”¨æ¶ˆæ¯å¤±è´¥:', e)
          );
        });
      });
    }
  }, [generalMessages, userId, chatHistoryLoaded]);
  
  // è‡ªåŠ¨å°†æ–°å¢çš„ä»»åŠ¡å¯¹è¯æ¶ˆæ¯æŒä¹…åŒ–åˆ°åç«¯
  useEffect(() => {
    if (!userId || !chatHistoryLoaded) return;
    for (const [tidStr, msgs] of Object.entries(taskMessages)) {
      const tid = Number(tidStr);
      const prevCount = persistedTaskCounts.current[tid] || 0;
      const newMessages = msgs.slice(prevCount);
      if (newMessages.length > 0) {
        persistedTaskCounts.current[tid] = msgs.length;
        import('./services/apiService').then(({ saveChatMessage }) => {
          newMessages.forEach(msg => {
            saveChatMessage({ role: msg.role, content: msg.content, todo_id: tid }, userId).catch(e =>
              console.error(`[Chat Persist] ä¿å­˜ä»»åŠ¡(${tid})æ¶ˆæ¯å¤±è´¥:`, e)
            );
          });
        });
      }
    }
  }, [taskMessages, userId, chatHistoryLoaded]);
  
  // ä¿å­˜å¯¹è¯åˆ° localStorageï¼ˆä½œä¸ºåå¤‡ç¼“å­˜ï¼‰
  useEffect(() => {
    if (userId) {
      try {
        localStorage.setItem(GENERAL_MESSAGES_KEY, JSON.stringify(generalMessages));
      } catch (e) {
        console.error('ä¿å­˜å¯¹è¯å¤±è´¥:', e);
      }
    }
  }, [generalMessages, userId, GENERAL_MESSAGES_KEY]);
  
  useEffect(() => {
    if (userId) {
      try {
        localStorage.setItem(TASK_MESSAGES_KEY, JSON.stringify(taskMessages));
      } catch (e) {
        console.error('ä¿å­˜ä»»åŠ¡å¯¹è¯å¤±è´¥:', e);
      }
    }
  }, [taskMessages, userId, TASK_MESSAGES_KEY]);
  
  // ä»åç«¯åŠ è½½å†å²å¯¹è¯ï¼ˆé¦–æ¬¡è¿›å…¥æ—¶åªåŠ è½½é€šç”¨å¯¹è¯ï¼Œä»»åŠ¡å¯¹è¯æŒ‰éœ€åŠ è½½ï¼‰
  useEffect(() => {
    if (!userId || chatHistoryLoaded) return;
    // è§’è‰²åˆ‡æ¢æ—¶è·³è¿‡åç«¯åŠ è½½ï¼ˆåç«¯æ¶ˆæ¯ä¸åŒºåˆ†è§’è‰²ï¼Œä¼šè¦†ç›–æ–°èº«ä»½çš„æ¬¢è¿æ¶ˆæ¯ï¼‰
    if (isRoleSwitchRef.current) {
      setChatHistoryLoaded(true);
      isRoleSwitchRef.current = false;
      return;
    }
    const loadFromBackend = async () => {
      try {
        const { getChatMessages } = await import('./services/apiService');
        
        // åªåŠ è½½é€šç”¨å¯¹è¯
        const generalMsgs = await getChatMessages(userId, undefined, 100);
        if (generalMsgs && generalMsgs.length > 0) {
          const formatted = generalMsgs.map((m: any) => ({ role: m.role as 'user' | 'assistant', content: m.content }));
          // å§‹ç»ˆç”¨å½“å‰è§’è‰²çš„æ¬¢è¿æ¶ˆæ¯æ›¿æ¢ç¬¬ä¸€æ¡ï¼ˆåç«¯ä¸åŒºåˆ†è§’è‰²ï¼Œå¯èƒ½åŒ…å«æ—§è§’è‰²å†…å®¹ï¼‰
          const freshWelcome = getWelcomeMessage();
          if (formatted[0]?.role === 'assistant') {
            formatted[0] = { role: 'assistant', content: freshWelcome };
          }
          setGeneralMessages(formatted);
          persistedGeneralCount.current = formatted.length;
        }
        
        console.log('[Chat History] å·²ä»åç«¯åŠ è½½é€šç”¨å¯¹è¯å†å²');
      } catch (e) {
        console.error('[Chat History] ä»åç«¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜:', e);
      }
      setChatHistoryLoaded(true);
    };
    loadFromBackend();
  }, [userId, chatHistoryLoaded]);
  
  // æŒ‰éœ€åŠ è½½ä»»åŠ¡å¯¹è¯ï¼ˆé€‰ä¸­ä»»åŠ¡æ—¶è§¦å‘ï¼‰
  const loadTaskMessages = async (taskId: number) => {
    if (!userId || loadedTaskIds.current.has(taskId)) return;
    loadedTaskIds.current.add(taskId);
    try {
      const { getChatMessages } = await import('./services/apiService');
      const msgs = await getChatMessages(userId, taskId, 100);
      if (msgs && msgs.length > 0) {
        const formatted = msgs.map((m: any) => ({ role: m.role as 'user' | 'assistant', content: m.content }));
        setTaskMessages(prev => ({ ...prev, [taskId]: formatted }));
        persistedTaskCounts.current[taskId] = formatted.length;
      }
    } catch (e) {
      console.error(`[Chat History] åŠ è½½ä»»åŠ¡(${taskId})å¯¹è¯å¤±è´¥:`, e);
    }
  };
  
  // å½“ç”¨æˆ·èº«ä»½å˜åŒ–æ—¶ï¼Œé‡æ–°åŠ è½½å¯¹è¯æˆ–æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
  const prevRoleRef = useRef(userRole);
  const isRoleSwitchRef = useRef(false);
  useEffect(() => {
    const isRoleSwitch = prevRoleRef.current !== userRole && prevRoleRef.current !== null;
    prevRoleRef.current = userRole;
    isRoleSwitchRef.current = isRoleSwitch;
    
    // é‡ç½®æŒä¹…åŒ–è®¡æ•°å™¨
    persistedGeneralCount.current = 0;
    persistedTaskCounts.current = {};
    loadedTaskIds.current = new Set();
    
    // åˆ‡æ¢èº«ä»½æ—¶ï¼šä¸é‡æ–°ä»åç«¯åŠ è½½ï¼ˆåç«¯æ¶ˆæ¯ä¸åŒºåˆ†è§’è‰²ï¼Œä¼šè¦†ç›–æ–°æ¬¢è¿æ¶ˆæ¯ï¼‰
    // ä»…åœ¨éè§’è‰²åˆ‡æ¢æ—¶ï¼ˆå¦‚é¦–æ¬¡è¿›å…¥ã€userId å˜åŒ–ï¼‰æ‰è§¦å‘åç«¯åŠ è½½
    if (!isRoleSwitch) {
      setChatHistoryLoaded(false);
    }
    
    // åˆ‡æ¢èº«ä»½æ—¶å–æ¶ˆå½“å‰é€‰ä¸­çš„ä»»åŠ¡ï¼ˆé¿å…æ˜¾ç¤ºå¦ä¸€ä¸ªè§’è‰²çš„ä»»åŠ¡ï¼‰
    if (isRoleSwitch) {
      setSelectedTask(null);
    }
    
    // å§‹ç»ˆç”¨å½“å‰èº«ä»½ç”Ÿæˆçš„æ¬¢è¿æ¶ˆæ¯
    const freshWelcome = getWelcomeMessage();
    if (isRoleSwitch) {
      // è§’è‰²åˆ‡æ¢ï¼šå¼ºåˆ¶å…¨æ–°å¯¹è¯ï¼Œæ¸…é™¤æ—§è§’è‰²æ®‹ç•™
      setGeneralMessages([{role: 'assistant', content: freshWelcome}]);
      setTaskMessages({});
      // é‡ç½®æŒä¹…åŒ–è®¡æ•°ä¸º1ï¼ˆåŒ…å«æ¬¢è¿æ¶ˆæ¯ï¼‰ï¼Œé˜²æ­¢é‡å¤æŒä¹…åŒ–
      persistedGeneralCount.current = 1;
    } else {
      const savedMessages = loadSavedMessages();
      if (savedMessages.length <= 1) {
        setGeneralMessages([{role: 'assistant', content: freshWelcome}]);
      } else {
        const updated = [...savedMessages];
        if (updated[0]?.role === 'assistant') {
          updated[0] = {role: 'assistant', content: freshWelcome};
        }
        setGeneralMessages(updated);
      }
      setTaskMessages(loadSavedTaskMessages());
    }
  }, [userId, isLoggedIn, userRole]);
  
  const [inputMessage, setInputMessage] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  // æ ¹æ®ç”¨æˆ·å½“å‰æ–¹æ¡ˆç­‰çº§åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©
  const tierToModel = (tier?: string) => {
    const t = tier?.toUpperCase();
    if (t === 'ULTRA') return 'Devnors 1.0 Ultra';
    if (t === 'PRO') return 'Devnors 1.0 Pro';
    return 'Devnors 1.0';
  };
  const [selectedModel, setSelectedModel] = useState(() => tierToModel(user?.account_tier));
  
  // ç”¨æˆ·æ–¹æ¡ˆç­‰çº§å˜åŒ–æ—¶åŒæ­¥æ›´æ–°æ¨¡å‹é€‰æ‹©
  useEffect(() => {
    setSelectedModel(tierToModel(user?.account_tier));
  }, [user?.account_tier]);
  
  // ä½¿ç”¨å½“å‰ç™»å½•ç”¨æˆ·çš„ ID è·å–ä»»åŠ¡æ•°æ®
  const { data: tasksData, loading: tasksLoading, refetch: refetchTasks } = useTasks(userId || 0);
  const tasks = userId ? tasksData : [];

  // å½“ç”¨æˆ·èµ„æ–™æˆ–ä»»åŠ¡æ•°æ®åŠ è½½å®Œæˆåï¼ŒåŠ¨æ€æ›´æ–°æ¬¢è¿æ¶ˆæ¯ï¼ˆç¬¬ä¸€æ¡æ¶ˆæ¯ï¼‰
  useEffect(() => {
    if (!profileLoading && isLoggedIn && !tasksLoading && tasks) {
      const newWelcome = getWelcomeMessage(tasks);
      setGeneralMessages(prev => {
        if (prev.length === 0) {
          return [{role: 'assistant', content: newWelcome}];
        }
        // å§‹ç»ˆæ›´æ–°ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆæ¬¢è¿æ¶ˆæ¯ï¼‰ä¸ºæœ€æ–°çš„åŠ¨æ€å†…å®¹
        if (prev[0]?.role === 'assistant' && prev[0].content !== newWelcome) {
          const updated = [...prev];
          updated[0] = {role: 'assistant', content: newWelcome};
          return updated;
        }
        return prev;
      });
    }
  }, [profileLoading, isNewUser, isLoggedIn, tasksLoading, tasks, enterpriseCertDone, recruitReady, userRole]);
  
  // æŒ‰è§’è‰²è¿‡æ»¤çš„ä»»åŠ¡åˆ—è¡¨ï¼ˆç”¨äºç»Ÿè®¡ï¼‰
  const roleFilteredTasks = useMemo(() => {
    if (!tasks || tasks.length === 0) return [];
    const recruitKeywords = ['æ™ºèƒ½æ‹›è˜', 'ä¼ä¸šè®¤è¯', 'ä¼ä¸šèµ„æ–™', 'ç­›é€‰å€™é€‰äºº', 'å®‰æ’é¢è¯•', 'äººæ‰åˆ†æ'];
    const candidateKeywords = ['ä¸ªäººè®¤è¯', 'ç®€å†', 'æ±‚èŒ', 'èŒä½æ¨è'];
    return tasks.filter((task: any) => {
      const taskType = (task.todo_type || task.type || '').toUpperCase();
      const title = task.title || task.task || '';
      
      // æŒ‰ç”¨æˆ·è§’è‰²è¿‡æ»¤ä»»åŠ¡ç±»å‹
      if (userRole === 'employer' || userRole === 'recruiter') {
        // ä¼ä¸š/æ‹›è˜è€…ä¸çœ‹CANDIDATEç±»å‹ä»»åŠ¡
        if (taskType === 'CANDIDATE') return false;
        if (candidateKeywords.some(kw => title.includes(kw))) return false;
      } else if (userRole === 'candidate') {
        // æ±‚èŒè€…ä¸çœ‹RECRUITå’ŒEMPLOYERç±»å‹ä»»åŠ¡
        if (taskType === 'RECRUIT' || taskType === 'EMPLOYER') return false;
        if (recruitKeywords.some(kw => title.includes(kw))) return false;
      }
      return true;
    });
  }, [tasks, userRole]);
  
  // è¿›è¡Œä¸­å’Œå·²å®Œæˆä»»åŠ¡è®¡æ•°ï¼ˆæŒ‰è§’è‰²è¿‡æ»¤åç»Ÿè®¡ï¼‰
  const pendingTasksCount = useMemo(() => 
    roleFilteredTasks.filter((t: any) => t.status?.toLowerCase() !== 'completed').length
  , [roleFilteredTasks]);
  
  const completedTasksCount = useMemo(() => 
    roleFilteredTasks.filter((t: any) => t.status?.toLowerCase() === 'completed').length
  , [roleFilteredTasks]);
  
  // è¿‡æ»¤åçš„ä»»åŠ¡åˆ—è¡¨ï¼ˆæŒ‰è§’è‰²å’ŒçŠ¶æ€è¿‡æ»¤ï¼Œå·²å®ŒæˆæŒ‰æ—¶é—´å€’åºï¼‰
  const filteredTasks = useMemo(() => {
    let list: any[];
    if (taskFilter === 'completed') {
      list = roleFilteredTasks.filter((t: any) => t.status?.toLowerCase() === 'completed');
      // å·²å®Œæˆä»»åŠ¡æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€è¿‘åˆ›å»ºçš„ä»»åŠ¡æ’å‰é¢ï¼Œæœ€æ—©åˆ›å»ºçš„æ’åé¢ï¼‰
      list.sort((a: any, b: any) => {
        const timeA = parseUTC(a.created_at || a.createdAt || 0).getTime();
        const timeB = parseUTC(b.created_at || b.createdAt || 0).getTime();
        return timeB - timeA;
      });
    } else {
      list = roleFilteredTasks.filter((t: any) => t.status?.toLowerCase() !== 'completed');
    }
    return list;
  }, [roleFilteredTasks, taskFilter]);
  
  const allModelOptions = ['Devnors 1.0', 'Devnors 1.0 Pro', 'Devnors 1.0 Ultra'];
  const isModelAvailable = (model: string) => {
    const tier = user?.account_tier || 'FREE';
    if (tier === 'ULTRA') return true;
    if (tier === 'PRO') return model !== 'Devnors 1.0 Ultra';
    return model === 'Devnors 1.0';
  };
  
  // å¤„ç† URL å‚æ•°ä¸­çš„ä»»åŠ¡ ID
  useEffect(() => {
    if (taskIdFromUrl && tasks.length > 0 && !initialTaskLoaded) {
      const task = tasks.find((t: any) => String(t.id) === taskIdFromUrl);
      if (task) {
        setSelectedTask(task);
        setInitialTaskLoaded(true);
        navigate('/ai-assistant', { replace: true });
      }
    }
  }, [taskIdFromUrl, tasks, initialTaskLoaded, navigate]);
  
  // å½“ tasks æ›´æ–°æ—¶ï¼ŒåŒæ­¥æ›´æ–° selectedTaskï¼ˆç¡®ä¿è¿›åº¦æ¡æ˜¾ç¤ºæœ€æ–°æ•°æ®ï¼‰
  useEffect(() => {
    if (selectedTask && tasks.length > 0) {
      const updatedTask = tasks.find((t: any) => t.id === selectedTask.id);
      if (updatedTask && (updatedTask.progress !== selectedTask.progress || updatedTask.status !== selectedTask.status)) {
        setSelectedTask(updatedTask);
      }
    }
  }, [tasks]);
  
  // å¤„ç†ç¼–è¾‘æ¨¡å¼ URL å‚æ•°
  useEffect(() => {
    if (editTypeFromUrl && editFieldFromUrl) {
      const fieldKey = `${editTypeFromUrl}_${editFieldFromUrl}`;
      const config = EDIT_FIELD_CONFIG[fieldKey];
      
      if (config) {
        setEditMode({
          active: true,
          type: editTypeFromUrl,
          field: editFieldFromUrl,
          id: editIdFromUrl || undefined,
          awaitingInput: true
        });
        
        // æ·»åŠ ç¼–è¾‘å¼•å¯¼æ¶ˆæ¯
        const editMessage = `ğŸ“ **ç¼–è¾‘${config.label}**\n\n${config.prompt}${config.examples ? `\n\nğŸ’¡ ç¤ºä¾‹ï¼š\n${config.examples.map(e => `â€¢ ${e}`).join('\n')}` : ''}`;
        setGeneralMessages([{role: 'assistant', content: editMessage}]);
        
        // æ¸…é™¤ URL å‚æ•°
        navigate('/ai-assistant', { replace: true });
      }
    }
  }, [editTypeFromUrl, editFieldFromUrl, editIdFromUrl, navigate]);
  
  // æ£€æŸ¥ç”¨æˆ·ç®€å†å®Œå–„åº¦çš„çŠ¶æ€
  const [profileChecked, setProfileChecked] = useState(false);
  const [profileCheckTask, setProfileCheckTask] = useState<any>(null);
  
  // æ£€æŸ¥ç”¨æˆ·ç®€å†å®Œå–„åº¦å¹¶åˆ›å»ºä»»åŠ¡
  const checkProfileCompleteness = async () => {
    if (!isLoggedIn || !userId || userRole !== 'candidate' || profileChecked) return;
    
    // ç­‰å¾…ä»»åŠ¡åˆ—è¡¨åŠ è½½å®Œæˆ
    if (tasksLoading) return;
    
    setProfileChecked(true);
    
    try {
      // å…ˆä» API è·å–æœ€æ–°çš„ä»»åŠ¡åˆ—è¡¨ï¼Œç¡®ä¿æ£€æŸ¥å‡†ç¡®
      const { getTasks, getUserProfile } = await import('./services/apiService');
      const latestTasks = await getTasks(userId);
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ã€Œå®Œå–„ç®€å†èµ„æ–™ã€ä»»åŠ¡
      const existingTask = latestTasks.find((t: any) => 
        t.todo_type === 'profile_complete' || 
        t.title === 'å®Œå–„ç®€å†èµ„æ–™' ||
        (t.title && t.title.includes('å®Œå–„') && (t.title.includes('ç®€å†') || t.title.includes('èµ„æ–™')))
      );
      
      if (existingTask) {
        // å·²å­˜åœ¨ä»»åŠ¡ï¼Œä¸å†æ£€æŸ¥å’Œåˆ›å»º
        setProfileCheckTask(existingTask);
        return false;
      }
      
      // è·å–ç”¨æˆ·èµ„æ–™
      const profile = await getUserProfile(userId, 'candidate');
      
      // æ£€æŸ¥å¿…å¡«å­—æ®µ
      const missingFields: string[] = [];
      const fieldLabels: Record<string, string> = {
        display_name: 'å§“å',
        title: 'èŒä½å¤´è¡”',
        summary: 'ä¸ªäººç®€ä»‹',
        skills: 'æŠ€èƒ½ç‰¹é•¿',
        experience: 'å·¥ä½œç»å†',
        projects: 'é¡¹ç›®ç»å†',
        education: 'æ•™è‚²èƒŒæ™¯',
        expected_salary: 'æœŸæœ›è–ªèµ„',
        expected_location: 'æœŸæœ›å·¥ä½œåœ°ç‚¹',
      };
      
      // åŸºç¡€å­—æ®µæ£€æŸ¥
      if (!profile?.display_name || profile.display_name.trim() === '') {
        missingFields.push('display_name');
      }
      if (!profile?.title || profile.title.trim() === '') {
        missingFields.push('title');
      }
      if (!profile?.summary || profile.summary.trim() === '' || profile.summary.length < 20) {
        missingFields.push('summary');
      }
      
      // æ£€æŸ¥ candidate_data ä¸­çš„å­—æ®µ
      const candidateData = profile?.candidate_data || {};
      if (!candidateData.skills || (Array.isArray(candidateData.skills) && candidateData.skills.length === 0)) {
        missingFields.push('skills');
      }
      if (!candidateData.experience || (Array.isArray(candidateData.experience) && candidateData.experience.length === 0)) {
        missingFields.push('experience');
      }
      if (!candidateData.projects || (Array.isArray(candidateData.projects) && candidateData.projects.length === 0)) {
        missingFields.push('projects');
      }
      if (!candidateData.education || (Array.isArray(candidateData.education) && candidateData.education.length === 0)) {
        missingFields.push('education');
      }
      if (!candidateData.expected_salary) {
        missingFields.push('expected_salary');
      }
      if (!candidateData.expected_location) {
        missingFields.push('expected_location');
      }
      
      // å¦‚æœæœ‰ç¼ºå¤±å­—æ®µï¼Œåˆ›å»ºä»»åŠ¡å¹¶æç¤º
      if (missingFields.length > 0) {
        const missingLabels = missingFields.map(f => fieldLabels[f] || f);
        const completenessPercent = Math.round(((9 - missingFields.length) / 9) * 100);
        
        // åˆ›å»ºæ–°ä»»åŠ¡ï¼ˆå‰é¢å·²ç¡®è®¤ä¸å­˜åœ¨é‡å¤ä»»åŠ¡ï¼‰
        const { createTodo } = await import('./services/apiService');
        const taskData = {
          title: 'å®Œå–„ç®€å†èµ„æ–™',
          description: `æ‚¨çš„ç®€å†è¿˜éœ€å®Œå–„ä»¥ä¸‹ä¿¡æ¯ï¼š${missingLabels.join('ã€')}`,
          priority: 'high',
          source: 'agent',  // Agent åˆ›å»ºçš„ä»»åŠ¡
          todo_type: 'profile_complete',
          ai_advice: `å®Œå–„ç®€å†ä¿¡æ¯å¯ä»¥å¤§å¹…æå‡æ‚¨çš„æ±‚èŒåŒ¹é…åº¦ã€‚å»ºè®®æ‚¨å°½å¿«è¡¥å……ï¼š${missingLabels.join('ã€')}ã€‚`,
          steps: missingFields.map((field, index) => ({
            order: index + 1,
            title: `å¡«å†™${fieldLabels[field] || field}`,
            status: 'pending'
          }))
        };
        
        const newTask = await createTodo(taskData, userId);
        setProfileCheckTask(newTask);
        
        // å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œæ¬¢è¿æ¶ˆæ¯å·²ç»åŒ…å«ä»»åŠ¡å¡ç‰‡ï¼Œä¸å†é‡å¤å‘é€æç¤º
        // åªæœ‰éæ–°ç”¨æˆ·ï¼ˆå·²æœ‰éƒ¨åˆ†èµ„æ–™ä½†ä¸å®Œæ•´ï¼‰æ‰å‘é€æç¤ºæ¶ˆæ¯
        if (!isNewUser) {
          const promptMessage = `âš ï¸ **ç®€å†å¾…å®Œå–„** (${completenessPercent}%)\n\nç¼ºå¤±ä¿¡æ¯ï¼š${missingLabels.join('ã€')}\n\n[[TASK:å®Œå–„ç®€å†èµ„æ–™:profile_complete:ğŸ“]]`;
          
          setGeneralMessages(prev => [...prev, {role: 'assistant', content: promptMessage}]);
        }
        
        // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
        if (typeof refetchTasks === 'function') {
          refetchTasks();
        }
        
        return true; // è¿”å› true è¡¨ç¤ºæœ‰æœªå®Œå–„çš„å­—æ®µ
      }
      
      return false;
    } catch (error) {
      console.error('æ£€æŸ¥ç®€å†å®Œå–„åº¦å¤±è´¥:', error);
      return false;
    }
  };
  
  // å¤„ç†æ±‚èŒç”³è¯·æ¨¡å¼ URL å‚æ•°
  useEffect(() => {
    if (taskTypeFromUrl === 'apply') {
      setApplyMode({
        active: true,
        step: 'resume',
        resumeText: '',
        analysisResult: null
      });
      
      // å…ˆæ£€æŸ¥ç®€å†å®Œå–„åº¦
      checkProfileCompleteness().then((hasIncomplete) => {
        if (!hasIncomplete) {
          // å¦‚æœç®€å†å·²å®Œå–„ï¼Œæ˜¾ç¤ºæ­£å¸¸çš„æ±‚èŒç”³è¯·å¼•å¯¼æ¶ˆæ¯
          const applyMessage = `ğŸš€ **å¼€å§‹æ±‚èŒç”³è¯·**\n\næ¬¢è¿ä½¿ç”¨ AI æ™ºèƒ½æ±‚èŒåŠ©æ‰‹ï¼æˆ‘å°†å¸®æ‚¨å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š\n\n**ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ ç®€å†**\n\nğŸ“ **æ–¹å¼ä¸€ï¼šç‚¹å‡»å·¦ä¸‹è§’ ğŸ“ æŒ‰é’®ä¸Šä¼ ç®€å†æ–‡ä»¶**\næ”¯æŒ PDFã€Word (.doc/.docx)ã€æ–‡æœ¬æ–‡ä»¶ (.txt/.md)\n\nğŸ“ **æ–¹å¼äºŒï¼šç›´æ¥ç²˜è´´ç®€å†å†…å®¹**\nå°†ç®€å†æ–‡æœ¬ç²˜è´´åˆ°è¾“å…¥æ¡†ä¸­\n\nğŸ’¡ æç¤ºï¼š\nâ€¢ ä¸Šä¼ å AI å°†è‡ªåŠ¨è§£æå¹¶æå–å…³é”®ä¿¡æ¯\nâ€¢ æˆ–è€…æè¿°æ‚¨çš„æ ¸å¿ƒæŠ€èƒ½å’Œå·¥ä½œç»å†\nâ€¢ AI å°†æ™ºèƒ½ä¼˜åŒ–å±•ç¤ºæ•ˆæœ`;
          setGeneralMessages([{role: 'assistant', content: applyMessage}]);
        }
      });
      
      // æ¸…é™¤ URL å‚æ•°
      navigate('/ai-assistant', { replace: true });
    }
  }, [taskTypeFromUrl, navigate]);
  
  // æ±‚èŒè€…è¿›å…¥ AI åŠ©æ‰‹é¡µé¢æ—¶è‡ªåŠ¨æ£€æŸ¥ç®€å†å®Œå–„åº¦
  useEffect(() => {
    if (isLoggedIn && userRole === 'candidate' && !taskTypeFromUrl && !profileChecked && !tasksLoading) {
      // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿ä»»åŠ¡åˆ—è¡¨å·²åŠ è½½
      const timer = setTimeout(() => {
        checkProfileCompleteness();
      }, 500);
      return () => clearTimeout(timer);
    }
  }, [isLoggedIn, userRole, taskTypeFromUrl, profileChecked, tasksLoading]);
  
  // æ‹›è˜æ–¹æ£€æŸ¥ä¼ä¸šè®¤è¯çŠ¶æ€
  const [enterpriseChecked, setEnterpriseChecked] = useState(false);
  useEffect(() => {
    const checkEnterpriseVerification = async () => {
      if (!isLoggedIn || !userId || userRole !== 'employer' || enterpriseChecked || tasksLoading) return;
      
      setEnterpriseChecked(true);
      
      try {
        const { getTasks, createTodo, getEnterpriseCertifications } = await import('./services/apiService');
        const latestTasks = await getTasks(userId);
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ã€Œå®Œæˆä¼ä¸šè®¤è¯ã€ä»»åŠ¡
        const existingTask = latestTasks.find((t: any) => 
          t.todo_type?.toUpperCase() === 'EMPLOYER' && t.title?.includes('ä¼ä¸šè®¤è¯') ||
          t.title === 'å®Œæˆä¼ä¸šè®¤è¯'
        );
        
        if (existingTask) {
          console.log('[Enterprise] å·²å­˜åœ¨ä¼ä¸šè®¤è¯ä»»åŠ¡');
          return;
        }
        
        // æ£€æŸ¥ä¼ä¸šè®¤è¯çŠ¶æ€
        const certifications = await getEnterpriseCertifications(userId);
        const hasBusinessLicense = certifications.some((c: any) => 
          c.category === 'qualification' && c.name?.includes('è¥ä¸šæ‰§ç…§')
        );
        
        // å¦‚æœæ²¡æœ‰è¥ä¸šæ‰§ç…§è®¤è¯ï¼Œåˆ›å»ºä¼ä¸šè®¤è¯ä»»åŠ¡
        if (!hasBusinessLicense) {
          const taskData = {
            title: 'å®Œæˆä¼ä¸šè®¤è¯',
            description: 'å®Œæˆè¥ä¸šæ‰§ç…§ã€èµ„è´¨è®¤è¯ç­‰ä¼ä¸šè®¤è¯ï¼Œæå‡æ‹›è˜æ•ˆæœå’Œå¯ä¿¡åº¦',
            priority: 'HIGH',
            source: 'AGENT',
            todo_type: 'EMPLOYER',
            icon: 'Building2',
            user_id: userId,
          };
          
          const newTask = await createTodo(taskData, userId);
          console.log('[Enterprise] åˆ›å»ºä¼ä¸šè®¤è¯ä»»åŠ¡:', newTask);
          
          if (typeof refetchTasks === 'function') {
            refetchTasks();
          }
        }
      } catch (error) {
        console.error('æ£€æŸ¥ä¼ä¸šè®¤è¯çŠ¶æ€å¤±è´¥:', error);
      }
    };
    
    if (isLoggedIn && userRole === 'employer' && !enterpriseChecked && !tasksLoading) {
      const timer = setTimeout(checkEnterpriseVerification, 500);
      return () => clearTimeout(timer);
    }
  }, [isLoggedIn, userRole, userId, enterpriseChecked, tasksLoading]);
  
  // ç»„ä»¶åŠ è½½æ—¶æ¸…ç†é‡å¤çš„ã€Œå®Œå–„ç®€å†èµ„æ–™ã€ä»»åŠ¡
  const [duplicatesCleanedUp, setDuplicatesCleanedUp] = useState(false);
  useEffect(() => {
    const cleanupDuplicates = async () => {
      if (!isLoggedIn || !userId || duplicatesCleanedUp) return;
      
      try {
        const { cleanupDuplicateProfileTasks } = await import('./services/apiService');
        const result = await cleanupDuplicateProfileTasks(userId);
        if (result.deleted_count > 0) {
          console.log(`å·²æ¸…ç† ${result.deleted_count} ä¸ªé‡å¤çš„ã€Œå®Œå–„ç®€å†èµ„æ–™ã€ä»»åŠ¡`);
        }
        setDuplicatesCleanedUp(true);
      } catch (error) {
        console.error('æ¸…ç†é‡å¤ä»»åŠ¡å¤±è´¥:', error);
      }
    };
    
    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿ä»»åŠ¡åˆ—è¡¨å·²åŠ è½½
    const timer = setTimeout(cleanupDuplicates, 500);
    return () => clearTimeout(timer);
  }, [isLoggedIn, userId, duplicatesCleanedUp]);
  
  // å¤„ç†æ±‚èŒç”³è¯·æµç¨‹
  const handleApplyProcess = async (userInput: string) => {
    if (applyMode.step === 'resume') {
      // ç”¨æˆ·æäº¤äº†ç®€å†
      setApplyMode(prev => ({ ...prev, resumeText: userInput, step: 'analyze' }));
      setGeneralMessages(prev => [...prev, {role: 'user', content: userInput}]);
      setIsTyping(true);
      
      // æ¨¡æ‹Ÿ AI åˆ†æç®€å†
      setTimeout(async () => {
        const analysisResult = `ğŸ“Š **ç®€å†åˆ†æå®Œæˆï¼**\n\n**æ ¸å¿ƒæŠ€èƒ½è¯†åˆ«ï¼š**\n${userInput.includes('React') || userInput.includes('å‰ç«¯') ? 'â€¢ å‰ç«¯å¼€å‘ (React/Vue)' : 'â€¢ è½¯ä»¶å¼€å‘'}\n${userInput.includes('Python') || userInput.includes('åç«¯') ? 'â€¢ åç«¯å¼€å‘ (Python/Java)' : ''}\n${userInput.includes('AI') || userInput.includes('æœºå™¨å­¦ä¹ ') ? 'â€¢ AI/æœºå™¨å­¦ä¹ ' : ''}\n\n**èŒä¸šç”»åƒç”Ÿæˆä¸­...**\n\næˆ‘å·²å°†æ‚¨çš„ç®€å†ä¿¡æ¯ä¿å­˜åˆ°èŒä¸šç”»åƒä¸­ã€‚æ¥ä¸‹æ¥ï¼Œæ‚¨æƒ³è¦ï¼š\n\n1ï¸âƒ£ æŸ¥çœ‹æ¨èèŒä½\n2ï¸âƒ£ ä¼˜åŒ–ç®€å†å†…å®¹\n3ï¸âƒ£ å‡†å¤‡é¢è¯•é—®é¢˜\n\nè¯·è¾“å…¥æ•°å­—æˆ–ç›´æ¥æè¿°æ‚¨çš„éœ€æ±‚ã€‚`;
        
        // ä¿å­˜åˆ° Memory
        try {
          await createMemory({
            type: 'experience',
            content: userInput.substring(0, 500),
            importance: 'High',
            scope: 'candidate'
          }, userId);
          refetchMemories();
        } catch (e) {
          console.error('ä¿å­˜ç®€å†è®°å¿†å¤±è´¥', e);
        }
        
        setGeneralMessages(prev => [...prev, {role: 'assistant', content: analysisResult}]);
        setApplyMode(prev => ({ ...prev, step: 'match', analysisResult }));
        setIsTyping(false);
      }, 2000);
      
      return true;
    }
    
    if (applyMode.step === 'match') {
      // ç”¨æˆ·é€‰æ‹©åç»­æ“ä½œ
      setGeneralMessages(prev => [...prev, {role: 'user', content: userInput}]);
      setIsTyping(true);
      
      setTimeout(() => {
        let response = '';
        if (userInput.includes('1') || userInput.includes('æ¨è') || userInput.includes('èŒä½')) {
          response = `ğŸ¯ **ä¸ºæ‚¨æ¨èä»¥ä¸‹èŒä½ï¼š**\n\n**1. é«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆ - å­—èŠ‚è·³åŠ¨**\nâ€¢ åŒ¹é…åº¦ï¼š92%\nâ€¢ è–ªèµ„ï¼š40-60K\nâ€¢ æŠ€èƒ½å¥‘åˆï¼šReact, TypeScript, æ€§èƒ½ä¼˜åŒ–\n\n**2. å…¨æ ˆå·¥ç¨‹å¸ˆ - é˜¿é‡Œå·´å·´**\nâ€¢ åŒ¹é…åº¦ï¼š88%\nâ€¢ è–ªèµ„ï¼š45-70K\nâ€¢ æŠ€èƒ½å¥‘åˆï¼šNode.js, React, å¾®æœåŠ¡\n\n**3. AI åº”ç”¨å¼€å‘å·¥ç¨‹å¸ˆ - å•†æ±¤ç§‘æŠ€**\nâ€¢ åŒ¹é…åº¦ï¼š85%\nâ€¢ è–ªèµ„ï¼š50-80K\nâ€¢ æŠ€èƒ½å¥‘åˆï¼šPython, æ·±åº¦å­¦ä¹ , Webå¼€å‘\n\nğŸ’¡ ç‚¹å‡»èŒä½åç§°å¯æŸ¥çœ‹è¯¦æƒ…ï¼Œæˆ–å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£å“ªä¸ªèŒä½ã€‚`;
        } else if (userInput.includes('2') || userInput.includes('ä¼˜åŒ–') || userInput.includes('ç®€å†')) {
          response = `âœ¨ **ç®€å†ä¼˜åŒ–å»ºè®®ï¼š**\n\n**1. é¡¹ç›®ç»å†ä¼˜åŒ–**\nâ€¢ ä½¿ç”¨ STAR æ³•åˆ™æè¿°é¡¹ç›®\nâ€¢ é‡åŒ–æˆæœï¼ˆæå‡ XX%ã€èŠ‚çœ XX æ—¶é—´ï¼‰\n\n**2. æŠ€èƒ½å±•ç¤ºä¼˜åŒ–**\nâ€¢ æŒ‰ç†Ÿç»ƒåº¦åˆ†çº§å±•ç¤ºæŠ€èƒ½\nâ€¢ çªå‡ºä¸ç›®æ ‡èŒä½åŒ¹é…çš„æŠ€èƒ½\n\n**3. ä¸ªäººäº®ç‚¹**\nâ€¢ æ·»åŠ æŠ€æœ¯åšå®¢æˆ–å¼€æºé¡¹ç›®é“¾æ¥\nâ€¢ å±•ç¤ºæŒç»­å­¦ä¹ èƒ½åŠ›\n\néœ€è¦æˆ‘å¸®æ‚¨é‡å†™æŸä¸ªéƒ¨åˆ†å—ï¼Ÿ`;
        } else if (userInput.includes('3') || userInput.includes('é¢è¯•')) {
          response = `ğŸ“ **é¢è¯•å‡†å¤‡æ¸…å•ï¼š**\n\n**æŠ€æœ¯é¢è¯•å¸¸è§é—®é¢˜ï¼š**\n1. è¯·ä»‹ç»ä¸€ä¸ªä½ æœ€æœ‰æŒ‘æˆ˜æ€§çš„é¡¹ç›®\n2. å¦‚ä½•è¿›è¡Œå‰ç«¯æ€§èƒ½ä¼˜åŒ–ï¼Ÿ\n3. æè¿°ä¸€æ¬¡ä½ è§£å†³å¤æ‚é—®é¢˜çš„ç»å†\n\n**è¡Œä¸ºé¢è¯•å¸¸è§é—®é¢˜ï¼š**\n1. ä¸ºä»€ä¹ˆé€‰æ‹©æˆ‘ä»¬å…¬å¸ï¼Ÿ\n2. ä½ çš„èŒä¸šè§„åˆ’æ˜¯ä»€ä¹ˆï¼Ÿ\n3. å¦‚ä½•å¤„ç†å·¥ä½œä¸­çš„å†²çªï¼Ÿ\n\néœ€è¦æˆ‘ä¸ºæ‚¨è¿›è¡Œæ¨¡æ‹Ÿé¢è¯•å—ï¼Ÿè¾“å…¥"å¼€å§‹æ¨¡æ‹Ÿ"å³å¯å¼€å§‹ã€‚`;
        } else {
          response = `å¥½çš„ï¼Œæˆ‘æ¥å¸®æ‚¨å¤„ç†ï¼š${userInput}\n\nè¯·ç¨ç­‰ï¼Œæ­£åœ¨ä¸ºæ‚¨åˆ†æ...`;
        }
        
        setGeneralMessages(prev => [...prev, {role: 'assistant', content: response}]);
        setIsTyping(false);
      }, 1500);
      
      return true;
    }
    
    return false;
  };
  
  // å¤„ç†æ‹›è˜å‘å¸ƒæ¨¡å¼ URL å‚æ•°
  useEffect(() => {
    if (taskTypeFromUrl === 'post') {
      // å…ˆåšå‰ç½®æ£€æŸ¥
      const checkAndStartPost = async () => {
        try {
          const { getEnterpriseCertifications, getSettings, getTasks } = await import('./services/apiService');
          const [certifications, settingsData, tasks] = await Promise.all([
            getEnterpriseCertifications(userId).catch(() => []),
            getSettings(userId).catch(() => ({})),
            getTasks(userId).catch(() => []),
          ]);
          
          const hasBusinessLicense = certifications.some((c: any) => c.category === 'qualification' && c.name?.includes('è¥ä¸šæ‰§ç…§'));
          const certTask = tasks.find((t: any) => t.title === 'å®Œæˆä¼ä¸šè®¤è¯' || (t.title?.includes('ä¼ä¸š') && t.title?.includes('è®¤è¯')));
          const certCompleted = hasBusinessLicense || certTask?.status?.toLowerCase() === 'completed';
          
          const requiredFields = ['display_name', 'industry', 'company_size', 'detail_address', 'description'];
          const hasValue = (val: any) => val && typeof val === 'string' ? val.trim() !== '' && val.trim() !== '[]' && val.trim() !== '{}' : !!val;
          const missingFields = requiredFields.filter(k => !hasValue(settingsData[k]));
          const profileCompleted = missingFields.length === 0;
          
          if (!certCompleted || !profileCompleted) {
            // æœªæ»¡è¶³å‰ç½®æ¡ä»¶ï¼Œç»™å‡ºå¼•å¯¼
            const issues: string[] = [];
            if (!certCompleted) issues.push('â€¢ **ä¼ä¸šè®¤è¯æœªå®Œæˆ** â€” è¯·å…ˆå‰å¾€ [ä¼ä¸šè®¤è¯ä¿¡æ¯](/settings?tab=Verification) å®Œæˆè®¤è¯');
            if (!profileCompleted) issues.push('â€¢ **ä¼ä¸šèµ„æ–™æœªå®Œå–„** â€” è¯·å…ˆå‰å¾€ [å®Œå–„ä¼ä¸šèµ„æ–™](/ai-assistant?task=enterprise_profile) è¡¥å……ä¿¡æ¯');
            
            setGeneralMessages([{role: 'assistant', content: `âš ï¸ **æš‚æ—¶æ— æ³•å¼€å¯æ‹›è˜**\n\nä¸ºäº†ä¿éšœæ‹›è˜è´¨é‡å’Œä¼ä¸šå¯ä¿¡åº¦ï¼Œå¼€å¯æ‹›è˜å‰éœ€è¦å®Œæˆä»¥ä¸‹å‡†å¤‡ï¼š\n\n${issues.join('\n\n')}\n\nå®Œæˆåå†æ¥æ‰¾æˆ‘ï¼Œå³å¯å¼€å§‹æ™ºèƒ½æ‹›è˜ï¼`}]);
            navigate('/ai-assistant', { replace: true });
            return;
          }
          
          // å‰ç½®æ¡ä»¶æ»¡è¶³ â€” æ£€æŸ¥æœªå®Œæˆæ‹›è˜ä»»åŠ¡æ•°é‡æ˜¯å¦è¶…è¿‡æ–¹æ¡ˆé™åˆ¶
          const pendingRecruitTasks = tasks.filter((t: any) => 
            (t.todo_type?.toUpperCase() === 'RECRUIT' || t.title?.includes('æ™ºèƒ½æ‹›è˜')) &&
            t.status?.toUpperCase() !== 'COMPLETED' && t.status?.toUpperCase() !== 'CANCELLED'
          );
          const tierLimits: Record<string, number> = { FREE: 1, PRO: 3, ULTRA: 10 };
          const userTier = user?.account_tier || 'FREE';
          const maxRecruitTasks = tierLimits[userTier] || 1;
          
          if (pendingRecruitTasks.length >= maxRecruitTasks) {
            // è¶…è¿‡é™åˆ¶ï¼Œæç¤ºç”¨æˆ·å®Œæˆå·²æœ‰ä»»åŠ¡
            const taskNames = pendingRecruitTasks.map((t: any) => `â€¢ **${t.title}**`).join('\n');
            const tierName = userTier === 'ULTRA' ? 'æ——èˆ°ç‰ˆ' : userTier === 'PRO' ? 'ä¸“ä¸šç‰ˆ' : 'åŸºç¡€ç‰ˆ';
            setGeneralMessages(prev => [...prev, {
              role: 'assistant',
              content: `âš ï¸ **æ‹›è˜ä»»åŠ¡æ•°é‡å·²è¾¾ä¸Šé™**\n\næ‚¨å½“å‰çš„${tierName}æ–¹æ¡ˆæœ€å¤šåŒæ—¶è¿›è¡Œ **${maxRecruitTasks}** ä¸ªæ‹›è˜ä»»åŠ¡ï¼Œç›®å‰å·²æœ‰ ${pendingRecruitTasks.length} ä¸ªæœªå®Œæˆï¼š\n\n${taskNames}\n\nè¯·å…ˆå®Œæˆæˆ–å–æ¶ˆå·²æœ‰çš„æ‹›è˜ä»»åŠ¡åï¼Œå†åˆ›å»ºæ–°çš„æ‹›è˜ä»»åŠ¡ã€‚${userTier !== 'ULTRA' ? `\n\nğŸ’¡ å‡çº§æ–¹æ¡ˆå¯è§£é”æ›´å¤šå¹¶è¡Œæ‹›è˜ä»»åŠ¡æ•°é‡ã€‚\n\n[[LINK:å‡çº§æ–¹æ¡ˆ:/pricing:âš¡]]` : ''}`
            }]);
            navigate('/ai-assistant', { replace: true });
            return;
          }
          
          // åˆ›å»ºæ–°çš„æ‹›è˜ä»»åŠ¡
          let newTask: any = null;
          try {
            const { createTodo } = await import('./services/apiService');
            const taskShortId = `RC${Date.now().toString().slice(-6)}`;
            newTask = await createTodo({
              title: `æ™ºèƒ½æ‹›è˜ #${taskShortId}`,
              description: 'AI æ™ºèƒ½æ‹›è˜åŠ©æ‰‹ â€” ä»éœ€æ±‚åˆ°äººæ‰å¯¹æ¥çš„å…¨æµç¨‹æ‹›è˜',
              priority: 'HIGH',
              source: 'AGENT',
              todo_type: 'RECRUIT',
              ai_advice: 'å‘Šè¯‰ AI åŠ©æ‰‹æ‚¨çš„æ‹›è˜éœ€æ±‚ï¼ŒAI å°†ä¸ºæ‚¨è‡ªåŠ¨ç”Ÿæˆå²—ä½ã€åŒ¹é…å€™é€‰äººã€ç­›é€‰è¯„ä¼°ç›´åˆ°åŒæ–¹å»ºç«‹è”ç³»ã€‚',
              steps: [
                { step: 1, title: 'æè¿°æ‹›è˜éœ€æ±‚', status: 'pending' },
                { step: 2, title: 'AI ç”Ÿæˆå²—ä½', status: 'pending' },
                { step: 3, title: 'ç¡®è®¤å¹¶å‘å¸ƒ', status: 'pending' },
                { step: 4, title: 'æ™ºèƒ½é‚€è¯·æŠ•é€’', status: 'pending' },
                { step: 5, title: 'æ™ºèƒ½ç­›é€‰è¯„ä¼°', status: 'pending' },
              ],
            }, userId);
            
            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
            if (typeof refetchTasks === 'function') await refetchTasks();
            
            // å¦‚æœ createTodo æ²¡æœ‰è¿”å›å®Œæ•´ä»»åŠ¡å¯¹è±¡ï¼Œé‡æ–°è·å–
            if (!newTask?.id) {
              const updatedTasks = await getTasks(userId);
              newTask = updatedTasks.find((t: any) => 
                t.title?.includes(taskShortId)
              ) || updatedTasks.find((t: any) => 
                t.todo_type?.toUpperCase() === 'RECRUIT' && 
                (t.status?.toUpperCase() === 'PENDING' || t.status?.toUpperCase() === 'RUNNING')
              );
            }
          } catch (e) {
            console.error('åˆ›å»ºæ‹›è˜ä»»åŠ¡å¤±è´¥:', e);
          }
          
          setPostMode({
            active: true,
            step: 'requirement',
            jobDescription: '',
            generatedResult: null
          });
          
          const companyName = settingsData.display_name || settingsData.short_name || user?.company_name || 'è´µå…¬å¸';
          const postMessage = `ğŸ¢ **${companyName}ï¼Œæ¬¢è¿ä½¿ç”¨ AI æ™ºèƒ½æ‹›è˜åŠ©æ‰‹ï¼**\n\nâœ… ä¼ä¸šè®¤è¯å·²é€šè¿‡ Â· âœ… ä¼ä¸šèµ„æ–™å·²å®Œå–„\n\n---\n\n**ç¬¬ä¸€æ­¥ï¼šæè¿°æ‚¨çš„æ‹›è˜éœ€æ±‚**\n\nè¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³æ‹›ä»€ä¹ˆäººï¼Œæ”¯æŒä»¥ä¸‹æ–¹å¼ï¼š\n\n**ç®€å•æè¿°**\n> "æ‹›3ä¸ªå‰ç«¯ï¼Œ2ä¸ªåç«¯ï¼Œè–ªèµ„20-40K"\n\n**è¯¦ç»†æè¿°**\n> "æ‹›è˜é«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆï¼Œéœ€è¦3å¹´ä»¥ä¸ŠReactç»éªŒï¼Œè´Ÿè´£æ ¸å¿ƒäº§å“å¼€å‘"\n\n**æ‰¹é‡æè¿°**\n> "æŠ€æœ¯å›¢é˜Ÿæ‰©æ‹›ï¼Œéœ€è¦å‰ç«¯ã€åç«¯ã€äº§å“ç»ç†å„1äºº"\n\n**ç¬¬äºŒæ­¥ï¼š** AI è‡ªåŠ¨ç”Ÿæˆä¸“ä¸šå²—ä½æè¿°\n**ç¬¬ä¸‰æ­¥ï¼š** ç¡®è®¤åä¸€é”®å‘å¸ƒï¼Œå¼€å§‹æ™ºèƒ½åŒ¹é…\n\nğŸ’¡ æè¿°è¶Šè¯¦ç»†ï¼Œç”Ÿæˆçš„å²—ä½è¶Šç²¾å‡†ï¼`;
          
          // é€‰ä¸­æ–°åˆ›å»ºçš„ä»»åŠ¡ï¼Œåœ¨ä»»åŠ¡å¯¹è¯ä¸­å±•ç¤ºæ‹›è˜æµç¨‹
          if (newTask?.id) {
            setSelectedTask(newTask);
            setTaskMessages(prev => ({
              ...prev,
              [newTask.id]: [{ role: 'assistant', content: postMessage }]
            }));
          } else {
            // é™çº§ï¼šå¦‚æœä»»åŠ¡åˆ›å»ºå¤±è´¥ï¼Œä»åœ¨é€šç”¨å¯¹è¯ä¸­å±•ç¤º
            setGeneralMessages([{role: 'assistant', content: postMessage}]);
          }
        } catch (e) {
          console.error('æ£€æŸ¥æ‹›è˜å‰ç½®æ¡ä»¶å¤±è´¥:', e);
          setGeneralMessages([{role: 'assistant', content: 'âš ï¸ æ£€æŸ¥æ‹›è˜èµ„è´¨æ—¶å‡ºç°å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•ã€‚'}]);
        }
        navigate('/ai-assistant', { replace: true });
      };
      
      checkAndStartPost();
    }
  }, [taskTypeFromUrl, navigate]);
  
  // æ‹›è˜æµç¨‹æ¶ˆæ¯è¾…åŠ©å‡½æ•°
  const addPostMsg = (content: string, role: 'user' | 'assistant' = 'assistant') => {
    if (selectedTask) {
      setTaskMessages(prev => ({
        ...prev,
        [selectedTask.id]: [...(prev[selectedTask.id] || []), { role, content }]
      }));
    } else {
      setGeneralMessages(prev => [...prev, { role, content }]);
    }
  };

  // å¤„ç†æ‹›è˜å‘å¸ƒæµç¨‹
  const handlePostProcess = async (userInput: string) => {
    // å°†å²—ä½æè¿°è½¬ä¸º Markdown æ ¼å¼ï¼ˆæ”¯æŒå¯¹è±¡/æ•°ç»„/å­—ç¬¦ä¸²ï¼‰
    const formatJobDesc = (description: any): string => {
      if (!description) return 'æš‚æ— æè¿°';
      if (typeof description === 'string') return description;
      if (typeof description === 'object' && !Array.isArray(description)) {
        return Object.entries(description).map(([key, val]) => {
          if (Array.isArray(val)) {
            return `**${key}ï¼š**\n${(val as string[]).map(item => `â€¢ ${item}`).join('\n')}`;
          }
          return `**${key}ï¼š** ${val}`;
        }).join('\n\n');
      }
      if (Array.isArray(description)) {
        return description.map(item => `â€¢ ${item}`).join('\n');
      }
      return String(description);
    };
    
    if (postMode.step === 'requirement') {
      // ç”¨æˆ·æäº¤äº†æ‹›è˜éœ€æ±‚
      setPostMode(prev => ({ ...prev, jobDescription: userInput, step: 'generate' }));
      addPostMsg(userInput, 'user');
      setIsTyping(true);
      
      addPostMsg('ğŸ¤– æ­£åœ¨åˆ†ææ‚¨çš„æ‹›è˜éœ€æ±‚ï¼Œæ ¹æ®ä¼ä¸šä¿¡æ¯æ™ºèƒ½ç”Ÿæˆå²—ä½è®¡åˆ’...');
      
      try {
        // è·å–ä¼ä¸šä¿¡æ¯ç”¨äº AI ä¸Šä¸‹æ–‡
        const { getSettings } = await import('./services/apiService');
        const settingsData = await getSettings(userId).catch(() => ({}));
        const companyName = settingsData.display_name || settingsData.short_name || user?.company_name || '';
        const industry = settingsData.industry || '';
        const companySize = settingsData.company_size || '';
        const location = settingsData.detail_address || '';
        const benefits = settingsData.benefits || '';
        
        // è·å–ä¼ä¸šè®°å¿†ä¸Šä¸‹æ–‡
        const memoryContext = getMemoryContext();
        
        // ç”¨ AI ç”ŸæˆèŒä½æè¿°
        const aiPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„HRæ‹›è˜åŠ©æ‰‹ã€‚ç”¨æˆ·åªæ˜¯ç®€å•æè¿°äº†æ‹›è˜éœ€æ±‚ï¼Œä½ éœ€è¦æ ¹æ®ä¼ä¸šä¿¡æ¯å’Œè¡Œä¸šç‰¹ç‚¹ï¼Œ"è„‘è¡¥"å®Œå–„ï¼Œç”Ÿæˆå®Œæ•´ä¸“ä¸šçš„å²—ä½ä¿¡æ¯ã€‚

ä¼ä¸šä¿¡æ¯ï¼š
- ä¼ä¸šåç§°ï¼š${companyName}
- æ‰€å±è¡Œä¸šï¼š${industry}
- ä¼ä¸šè§„æ¨¡ï¼š${companySize}
- å·¥ä½œåœ°ç‚¹ï¼š${location}
- ä¼ä¸šç¦åˆ©ï¼š${benefits}
${memoryContext}
ç”¨æˆ·çš„å¤§è‡´éœ€æ±‚ï¼š${userInput}

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼ˆç›´æ¥è¿”å›JSONæ•°ç»„ï¼Œä¸è¦åŒ…å«markdownä»£ç å—æ ‡è®°ï¼‰ï¼š
[
  {
    "title": "èŒä½åç§°ï¼ˆä¸“ä¸šã€æœ‰å¸å¼•åŠ›ï¼‰",
    "location": "å·¥ä½œåœ°ç‚¹",
    "description": "å®Œæ•´çš„å²—ä½æè¿°ï¼ŒåŒ…å«ã€å²—ä½èŒè´£ã€‘å’Œã€ä»»èŒè¦æ±‚ã€‘å’Œã€åŠ åˆ†é¡¹ã€‘ä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†3-5æ¡ï¼Œç”¨markdownæ ¼å¼",
    "salary_min": æœ€ä½è–ªèµ„ï¼ˆå•ä½ï¼šåƒå…ƒ/æœˆï¼Œæ•°å­—ç±»å‹ï¼Œæ ¹æ®è¡Œä¸šå’Œå²—ä½åˆç†ä¼°ç®—ï¼‰ï¼Œ
    "salary_max": æœ€é«˜è–ªèµ„ï¼ˆå•ä½ï¼šåƒå…ƒ/æœˆï¼Œæ•°å­—ç±»å‹ï¼‰ï¼Œ
    "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2", "æ ‡ç­¾3", "æ ‡ç­¾4"]
  }
]

è¦æ±‚ï¼š
1. ç”¨æˆ·åªç®€å•è¯´"æ‹›å‰ç«¯"ï¼Œä½ è¦è„‘è¡¥æˆå®Œæ•´çš„å²—ä½æè¿°ï¼ŒåŒ…å«åˆç†çš„æŠ€æœ¯æ ˆã€ç»éªŒè¦æ±‚ã€å­¦å†è¦æ±‚ç­‰
2. å¦‚æœç”¨æˆ·æåˆ°å¤šä¸ªå²—ä½ï¼Œç”Ÿæˆå¤šä¸ªå¯¹è±¡
3. è–ªèµ„æ ¹æ®è¡Œä¸šå’Œå²—ä½çº§åˆ«åˆç†ä¼°ç®—ï¼Œä½†å¦‚æœä¼ä¸šè®°å¿†ä¸­æœ‰æ˜ç¡®çš„è–ªèµ„èŒƒå›´è¦æ±‚ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆ
4. descriptionè¦ä¸“ä¸šã€å®Œæ•´ã€æœ‰å¸å¼•åŠ›ï¼Œä½“ç°ä¼ä¸šç‰¹è‰²
5. tagsåŒ…å«æŠ€æœ¯æ ˆã€ç»éªŒè¦æ±‚ã€å­¦å†ã€å·¥ä½œæ–¹å¼ç­‰å…³é”®æ ‡ç­¾
6. å¦‚æœä¼ä¸šè®°å¿†ä¸­æœ‰ç‰¹æ®Šè¦æ±‚ï¼ˆå¦‚è¿œç¨‹åŠå…¬ã€å­¦å†åå¥½ã€å·¥ä½œæ–¹å¼ç­‰ï¼‰ï¼Œå¿…é¡»ä½“ç°åœ¨å²—ä½æè¿°å’Œæ ‡ç­¾ä¸­
7. ç›´æ¥è¿”å›JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—`;
        
        const aiResult = await chatWithAI({
          message: aiPrompt,
          context: 'job_generation',
        });
        
        // è§£æ AI è¿”å›çš„èŒä½æ•°æ®
        let jobs: any[] = [];
        try {
          let responseText = aiResult.response || '';
          responseText = responseText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
          jobs = JSON.parse(responseText);
          if (!Array.isArray(jobs)) jobs = [jobs];
        } catch (parseErr) {
          console.error('AI è¿”å›è§£æå¤±è´¥:', parseErr);
          const titleGuess = userInput.includes('å‰ç«¯') ? 'å‰ç«¯å·¥ç¨‹å¸ˆ' : 
                             userInput.includes('åç«¯') ? 'åç«¯å·¥ç¨‹å¸ˆ' : 
                             userInput.includes('äº§å“') ? 'äº§å“ç»ç†' :
                             userInput.includes('è®¾è®¡') ? 'UI/UX è®¾è®¡å¸ˆ' :
                             userInput.includes('è¿è¥') ? 'è¿è¥ç»ç†' : 'AI åº”ç”¨å·¥ç¨‹å¸ˆ';
          jobs = [{
            title: titleGuess,
            location: location || 'ä¸é™',
            description: `**å²—ä½èŒè´£ï¼š**\nâ€¢ è´Ÿè´£æ ¸å¿ƒäº§å“åŠŸèƒ½å¼€å‘ä¸ä¼˜åŒ–\nâ€¢ å‚ä¸æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡ä¸è¯„å®¡\nâ€¢ æ¨åŠ¨é¡¹ç›®è½åœ°å¹¶æŒç»­è¿­ä»£\n\n**ä»»èŒè¦æ±‚ï¼š**\nâ€¢ æœ¬ç§‘åŠä»¥ä¸Šå­¦å†\nâ€¢ 3å¹´ä»¥ä¸Šç›¸å…³å¼€å‘ç»éªŒ\nâ€¢ è‰¯å¥½çš„æ²Ÿé€šèƒ½åŠ›å’Œå›¢é˜Ÿåä½œç²¾ç¥`,
            salary_min: 15, salary_max: 35,
            tags: ['3å¹´ä»¥ä¸Šç»éªŒ', 'æœ¬ç§‘', titleGuess]
          }];
        }
        
        // ä¿å­˜åˆ° Memory
        try {
          await createMemory({ type: 'action', content: `æ‹›è˜éœ€æ±‚ï¼š${userInput.substring(0, 500)}`, importance: 'High', scope: 'employer' }, userId);
          refetchMemories();
        } catch (e) { console.error('ä¿å­˜æ‹›è˜éœ€æ±‚è®°å¿†å¤±è´¥', e); }
        
        // ç”Ÿæˆå²—ä½æ‘˜è¦ç»™ç”¨æˆ·ç¡®è®¤
        const jobsSummary = jobs.map((job: any, i: number) => {
          const desc = formatJobDesc(job.description);
          const salaryMin = typeof job.salary_min === 'number' ? job.salary_min : 'é¢è®®';
          const salaryMax = typeof job.salary_max === 'number' ? job.salary_max : 'é¢è®®';
          return `### å²—ä½ ${i + 1}ï¼š${job.title}\n\nğŸ“ **åœ°ç‚¹ï¼š** ${job.location || 'ä¸é™'} Â· ğŸ’° **è–ªèµ„ï¼š** ${salaryMin}K-${salaryMax}K/æœˆ\n\n${desc}\n\nğŸ·ï¸ ${(job.tags || []).join(' Â· ')}`;
        }).join('\n\n---\n\n');
        
        const generatedResult = `ğŸ“‹ **æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œæˆ‘ä¸ºæ‚¨æ‹Ÿå®šäº†ä»¥ä¸‹ ${jobs.length} ä¸ªå²—ä½æ‹›è˜è®¡åˆ’ï¼š**\n\n${jobsSummary}\n\n---\n\nâ¬†ï¸ ä»¥ä¸Šæ˜¯æˆ‘æ ¹æ®æ‚¨çš„éœ€æ±‚å’Œä¼ä¸šä¿¡æ¯ç”Ÿæˆçš„å²—ä½æè¿°ã€‚\n\næ‚¨å¯ä»¥ç›´æ¥å‘Šè¯‰æˆ‘è¦æ€ä¹ˆè°ƒæ•´ï¼Œä¾‹å¦‚ï¼š\nâ€¢ "æŠŠè–ªèµ„è°ƒé«˜åˆ°30-50K"\nâ€¢ "åŠ ä¸Šè¿œç¨‹åŠå…¬"\nâ€¢ "åˆ æ‰ç¬¬äºŒä¸ªå²—ä½"\nâ€¢ "å†åŠ ä¸€ä¸ªäº§å“ç»ç†"\n\næ²¡é—®é¢˜çš„è¯ï¼Œç‚¹å‡»ä¸‹æ–¹ **ã€Œç¡®è®¤å‘å¸ƒã€** å³å¯ä¸Šçº¿ã€‚`;
        
        // ç§»é™¤ä¹‹å‰çš„"æ­£åœ¨åˆ†æ"æ¶ˆæ¯ï¼Œæ›¿æ¢ä¸ºç»“æœ
        if (selectedTask) {
          setTaskMessages(prev => {
            const msgs = prev[selectedTask.id] || [];
            const filtered = msgs.filter(m => !m.content.includes('æ­£åœ¨åˆ†ææ‚¨çš„æ‹›è˜éœ€æ±‚'));
            return { ...prev, [selectedTask.id]: [...filtered, { role: 'assistant', content: generatedResult }] };
          });
        } else {
          setGeneralMessages(prev => {
            const filtered = prev.filter(m => !m.content.includes('æ­£åœ¨åˆ†ææ‚¨çš„æ‹›è˜éœ€æ±‚'));
            return [...filtered, { role: 'assistant', content: generatedResult }];
          });
        }
        
        setPostMode(prev => ({ ...prev, step: 'optimize', generatedResult, jobDescription: JSON.stringify(jobs) }));
        setIsTyping(false);
      } catch (err) {
        console.error('AI ç”Ÿæˆå²—ä½å¤±è´¥:', err);
        addPostMsg(`âš ï¸ ç”Ÿæˆå²—ä½æ—¶é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•ã€‚\n\né”™è¯¯ä¿¡æ¯ï¼š${(err as any)?.message || 'æœªçŸ¥é”™è¯¯'}`);
        setIsTyping(false);
      }
      
      return true;
    }
    
    if (postMode.step === 'optimize') {
      addPostMsg(userInput, 'user');
      setIsTyping(true);
      
      const handleOptimizeAction = async () => {
        try {
          // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç¡®è®¤å‘å¸ƒ
          const isConfirmPublish = /^(å‘å¸ƒ|ç¡®è®¤|æ²¡é—®é¢˜|ok|OK|å¥½çš„|å¯ä»¥|1|å…¨éƒ¨å‘å¸ƒ|ç›´æ¥å‘å¸ƒ|å‘å§)$/i.test(userInput.trim()) ||
            (userInput.includes('å‘å¸ƒ') && !userInput.includes('ä¿®æ”¹') && !userInput.includes('æ”¹') && userInput.length < 15) ||
            (userInput.includes('ç¡®è®¤') && userInput.length < 10);
          
          if (isConfirmPublish) {
            // ç”¨æˆ·ç¡®è®¤å‘å¸ƒ
            let jobs: any[] = [];
            try { jobs = JSON.parse(postMode.jobDescription); } catch { jobs = []; }
            
            if (jobs.length === 0) {
              addPostMsg('âš ï¸ æœªæ‰¾åˆ°å¾…å‘å¸ƒçš„å²—ä½æ•°æ®ï¼Œè¯·é‡æ–°æè¿°æ‚¨çš„æ‹›è˜éœ€æ±‚ã€‚');
              setPostMode(prev => ({ ...prev, step: 'requirement' }));
              setIsTyping(false);
              return;
            }
            
            addPostMsg(`â³ æ­£åœ¨å‘å¸ƒ ${jobs.length} ä¸ªå²—ä½...`);
            
            const { createJob, updateTodo } = await import('./services/apiService');
            const companyName = user?.company_name || 'æœªçŸ¥ä¼ä¸š';
            
            const publishResults: string[] = [];
            const publishedJobIds: number[] = [];
            let successCount = 0;
            
            for (const job of jobs) {
              try {
                const createdJob = await createJob({
                  title: job.title,
                  company: companyName,
                  location: job.location || 'ä¸é™',
                  description: typeof job.description === 'string' ? job.description : JSON.stringify(job.description || ''),
                  salary_min: job.salary_min ? job.salary_min * 1000 : undefined,
                  salary_max: job.salary_max ? job.salary_max * 1000 : undefined,
                  tags: job.tags || [],
                  user_id: userId,
                });
                successCount++;
                if (createdJob?.id) publishedJobIds.push(createdJob.id);
                // ä¿ç•™å·²åˆ›å»ºå²—ä½çš„ ID åˆ° job å¯¹è±¡ä¸Š
                job._publishedId = createdJob?.id;
                publishResults.push(`âœ… **${job.title}** â€” å‘å¸ƒæˆåŠŸ`);
              } catch (e) {
                publishResults.push(`âŒ **${job.title}** â€” å‘å¸ƒå¤±è´¥: ${(e as any)?.message || 'æœªçŸ¥é”™è¯¯'}`);
              }
            }
            
            // æ›´æ–°æ‹›è˜ä»»åŠ¡ï¼šè¿›åº¦40%ã€stepsçŠ¶æ€ã€å…³è”å·²å‘å¸ƒå²—ä½IDã€å½“å‰é˜¶æ®µ
            if (selectedTask) {
              try {
                await updateTodo(selectedTask.id, { 
                  status: 'in_progress', 
                  progress: 40,
                  published_job_ids: publishedJobIds,
                  current_step: 'invite',
                  steps: [
                    { step: 1, title: 'æè¿°æ‹›è˜éœ€æ±‚', status: 'completed' },
                    { step: 2, title: 'AI ç”Ÿæˆå²—ä½', status: 'completed' },
                    { step: 3, title: 'ç¡®è®¤å¹¶å‘å¸ƒ', status: 'completed' },
                    { step: 4, title: 'æ™ºèƒ½é‚€è¯·æŠ•é€’', status: 'in_progress' },
                    { step: 5, title: 'æ™ºèƒ½ç­›é€‰è¯„ä¼°', status: 'pending' },
                  ],
                  ai_advice: `å·²å‘å¸ƒ ${successCount} ä¸ªå²—ä½ï¼ˆID: ${publishedJobIds.join(',')}ï¼‰ï¼Œæ­£åœ¨è¿›è¡Œæ™ºèƒ½é‚€è¯·æŠ•é€’ã€‚`,
                });
                if (typeof refetchTasks === 'function') refetchTasks();
              } catch (e) { console.error('æ›´æ–°ä»»åŠ¡è¿›åº¦å¤±è´¥:', e); }
            }
            
            const response = `ğŸ‰ **å²—ä½å‘å¸ƒå®Œæˆï¼**\n\n${publishResults.join('\n')}\n\nå…± **${successCount}/${jobs.length}** ä¸ªå²—ä½å‘å¸ƒæˆåŠŸã€‚\n\n---\n\nğŸ“¢ **ä¸‹ä¸€æ­¥ï¼šæ™ºèƒ½é‚€è¯·æŠ•é€’**\n\nç³»ç»Ÿå°†åŸºäºå·²å‘å¸ƒçš„å²—ä½è¦æ±‚ï¼Œåœ¨äººæ‰åº“ä¸­æ™ºèƒ½åŒ¹é…åˆé€‚çš„å€™é€‰äººï¼Œå¹¶è‡ªåŠ¨å‘èµ·æŠ•é€’é‚€è¯·ã€‚\n\næ‚¨å¯ä»¥ï¼š\nâ€¢ ç‚¹å‡»ä¸‹æ–¹ **ã€Œå¼€å§‹æ™ºèƒ½é‚€è¯·ã€** è®© AI è‡ªåŠ¨åŒ¹é…å¹¶é‚€è¯·å€™é€‰äºº\nâ€¢ è¾“å…¥ç‰¹å®šè¦æ±‚ï¼Œä¾‹å¦‚ "ä¼˜å…ˆé‚€è¯·æœ‰å¤§å‚ç»éªŒçš„å€™é€‰äºº"\nâ€¢ å‰å¾€ [èŒä½ç®¡ç†](/employer/post) æŸ¥çœ‹å·²å‘å¸ƒçš„å²—ä½`;
            
            // ç§»é™¤"æ­£åœ¨å‘å¸ƒ"æ¶ˆæ¯
            if (selectedTask) {
              setTaskMessages(prev => {
                const msgs = prev[selectedTask.id] || [];
                const filtered = msgs.filter(m => !m.content.includes('æ­£åœ¨å‘å¸ƒ'));
                return { ...prev, [selectedTask.id]: [...filtered, { role: 'assistant', content: response }] };
              });
            } else {
              setGeneralMessages(prev => {
                const filtered = prev.filter(m => !m.content.includes('æ­£åœ¨å‘å¸ƒ'));
                return [...filtered, { role: 'assistant', content: response }];
              });
            }
            
            // å‘å¸ƒæˆåŠŸåï¼Œåå°è‡ªåŠ¨æ‰§è¡Œè®°å¿†ä¼˜åŒ–ï¼ˆä¸é˜»å¡ç”¨æˆ·æ“ä½œï¼‰
            if (successCount > 0) {
              (async () => {
                try {
                  const { optimizeMemories } = await import('./services/apiService');
                  await optimizeMemories(userId, 'employer');
                  console.log('[æ™ºèƒ½æ‹›è˜] å²—ä½å‘å¸ƒåè®°å¿†ä¼˜åŒ–å®Œæˆ');
                  if (typeof refetchMemories === 'function') refetchMemories();
                } catch (e) { console.error('[æ™ºèƒ½æ‹›è˜] è®°å¿†ä¼˜åŒ–å¤±è´¥:', e); }
              })();
            }
            
            // è¿›å…¥æ™ºèƒ½é‚€è¯·é˜¶æ®µï¼Œä¿å­˜å·²å‘å¸ƒå²—ä½
            setPostMode(prev => ({ ...prev, step: 'invite', publishedJobs: jobs }));
          } else {
            // ç”¨æˆ·è¦ä¿®æ”¹ - å…ˆå°è¯•æœ¬åœ°å¤„ç†ç®€å•æ“ä½œï¼ˆåˆ é™¤/ç§»é™¤æŒ‡å®šå²—ä½ï¼‰ï¼Œå†fallbackåˆ°AI
            let currentJobs: any[] = [];
            try { currentJobs = JSON.parse(postMode.jobDescription); } catch { currentJobs = []; }
            
            // === æœ¬åœ°å¤„ç†ï¼šåˆ é™¤æŒ‡å®šåºå·çš„å²—ä½ ===
            const chineseNumMap: Record<string, number> = { 'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10, 'ç¬¬ä¸€': 1, 'ç¬¬äºŒ': 2, 'ç¬¬ä¸‰': 3, 'ç¬¬å››': 4, 'ç¬¬äº”': 5, 'æœ€å': currentJobs.length };
            const deleteMatch = userInput.match(/(?:åˆ (?:é™¤|æ‰)?|å»æ‰|ç§»é™¤|ä¸è¦|ç æ‰|å–æ¶ˆ)\s*(?:ç¬¬?\s*([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+)\s*(?:ä¸ª|æ¡)?\s*(?:å²—ä½|èŒä½)?|(?:å²—ä½|èŒä½)\s*(\d+))/);
            let localHandled = false;
            
            if (deleteMatch && currentJobs.length > 0) {
              const rawNum = deleteMatch[1] || deleteMatch[2];
              let deleteIndex = -1;
              if (rawNum) {
                // å°è¯•ä¸­æ–‡æ•°å­—è½¬æ¢
                const cleaned = rawNum.replace(/^ç¬¬/, '');
                deleteIndex = chineseNumMap[cleaned] || chineseNumMap[rawNum] || parseInt(cleaned, 10);
              }
              
              if (deleteIndex >= 1 && deleteIndex <= currentJobs.length) {
                const deletedJob = currentJobs[deleteIndex - 1];
                const updatedJobs = [...currentJobs];
                updatedJobs.splice(deleteIndex - 1, 1);
                
                const jobsSummary = updatedJobs.map((job: any, i: number) => {
                  const desc = formatJobDesc(job.description);
                  const salaryMin = typeof job.salary_min === 'number' ? job.salary_min : 'é¢è®®';
                  const salaryMax = typeof job.salary_max === 'number' ? job.salary_max : 'é¢è®®';
                  return `### å²—ä½ ${i + 1}ï¼š${job.title}\n\nğŸ“ **åœ°ç‚¹ï¼š** ${job.location || 'ä¸é™'} Â· ğŸ’° **è–ªèµ„ï¼š** ${salaryMin}K-${salaryMax}K/æœˆ\n\n${desc}\n\nğŸ·ï¸ ${(job.tags || []).join(' Â· ')}`;
                }).join('\n\n---\n\n');
                
                const updatedResult = `âœï¸ **å·²åˆ é™¤å²—ä½ ${deleteIndex}ã€Œ${deletedJob.title}ã€ï¼Œå‰©ä½™ ${updatedJobs.length} ä¸ªå²—ä½ï¼š**\n\n${jobsSummary}\n\n---\n\nå¦‚éœ€ç»§ç»­è°ƒæ•´ï¼Œç›´æ¥å‘Šè¯‰æˆ‘å³å¯ã€‚æ²¡é—®é¢˜è¯·ç‚¹å‡»ä¸‹æ–¹ **ã€Œç¡®è®¤å‘å¸ƒã€**ã€‚`;
                
                if (selectedTask) {
                  setTaskMessages(prev => {
                    const msgs = prev[selectedTask.id] || [];
                    return { ...prev, [selectedTask.id]: [...msgs, { role: 'assistant', content: updatedResult }] };
                  });
                } else {
                  setGeneralMessages(prev => [...prev, { role: 'assistant', content: updatedResult }]);
                }
                
                setPostMode(prev => ({ ...prev, jobDescription: JSON.stringify(updatedJobs) }));
                localHandled = true;
              }
            }
            
            // === æœ¬åœ°æœªå¤„ç† â†’ è°ƒç”¨ AI ä¿®æ”¹ ===
            if (!localHandled) {
            addPostMsg('ğŸ¤– æ­£åœ¨æ ¹æ®æ‚¨çš„åé¦ˆä¿®æ”¹å²—ä½ä¿¡æ¯...');
            
            const memCtx = getMemoryContext();
            // ç»™æ¯ä¸ªå²—ä½åŠ ä¸Šåºå·æ ‡æ³¨ï¼Œæ–¹ä¾¿AIç†è§£
            const numberedJobs = currentJobs.map((job: any, i: number) => ({ _index: i + 1, ...job }));
            const modifyPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„HRæ‹›è˜åŠ©æ‰‹ã€‚ä»¥ä¸‹æ˜¯å½“å‰å·²ç”Ÿæˆçš„ ${currentJobs.length} ä¸ªå²—ä½ä¿¡æ¯ï¼ˆæ¯ä¸ªå²—ä½éƒ½æœ‰ _index åºå·ï¼‰ï¼š

${JSON.stringify(numberedJobs, null, 2)}
${memCtx}
ç”¨æˆ·çš„ä¿®æ”¹è¦æ±‚ï¼š${userInput}

ã€å…³é”®è§„åˆ™ - å¿…é¡»ä¸¥æ ¼éµå®ˆã€‘
1. ä½ å¿…é¡»è¿”å›ä¿®æ”¹åçš„ã€å®Œæ•´å²—ä½åˆ—è¡¨ã€‘ï¼ŒåŒ…å«æ‰€æœ‰æœªè¢«ä¿®æ”¹çš„å²—ä½
2. ç”¨æˆ·æ²¡æœ‰æ˜ç¡®æåˆ°çš„å²—ä½ï¼Œå¿…é¡»åŸæ ·ä¿ç•™ï¼Œä¸€ä¸ªå­—éƒ½ä¸è¦æ”¹
3. å¦‚æœç”¨æˆ·è¯´"åˆ é™¤ç¬¬Nä¸ªå²—ä½"ï¼Œåªåˆ é™¤åºå·ä¸ºNçš„é‚£ä¸€ä¸ªå²—ä½ï¼Œå…¶ä»–å…¨éƒ¨ä¿ç•™
4. å¦‚æœç”¨æˆ·è¯´ä¿®æ”¹æŸä¸ªå²—ä½çš„æŸé¡¹å†…å®¹ï¼Œåªæ”¹é‚£ä¸€é¡¹ï¼Œå…¶ä»–å­—æ®µåŸæ ·ä¿ç•™
5. å½“å‰å…± ${currentJobs.length} ä¸ªå²—ä½ï¼Œå¦‚æœç”¨æˆ·åªè¯´åˆ é™¤1ä¸ªï¼Œè¿”å›çš„æ•°ç»„åº”æœ‰ ${currentJobs.length - 1} ä¸ªå²—ä½
6. å¿…é¡»éµå®ˆä¼ä¸šè®°å¿†ä¸­çš„åå¥½è¦æ±‚

ä¸¥æ ¼æŒ‰ç…§JSONæ•°ç»„æ ¼å¼è¿”å›ï¼ˆç›´æ¥è¿”å›JSONï¼Œä¸è¦åŒ…å«markdownä»£ç å—æ ‡è®°ï¼Œä¸è¦åŒ…å« _index å­—æ®µï¼‰ï¼š
[
  {
    "title": "èŒä½åç§°",
    "location": "å·¥ä½œåœ°ç‚¹",
    "description": "å®Œæ•´çš„å²—ä½æè¿°",
    "salary_min": æ•°å­—,
    "salary_max": æ•°å­—,
    "tags": ["æ ‡ç­¾"]
  }
]

ç›´æ¥è¿”å›JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—ã€‚`;
            
            try {
              const modifyResult = await chatWithAI({ message: modifyPrompt, context: 'job_modification' });
              
              let updatedJobs: any[] = [];
              try {
                let responseText = modifyResult.response || '';
                responseText = responseText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                updatedJobs = JSON.parse(responseText);
                if (!Array.isArray(updatedJobs)) updatedJobs = [updatedJobs];
                // ç§»é™¤å¯èƒ½æ®‹ç•™çš„ _index å­—æ®µ
                updatedJobs = updatedJobs.map(({ _index, ...rest }: any) => rest);
              } catch {
                // è§£æå¤±è´¥ï¼Œä¿æŒåŸæ ·
                updatedJobs = currentJobs;
              }
              
              const jobsSummary = updatedJobs.map((job: any, i: number) => {
                const desc = formatJobDesc(job.description);
                const salaryMin = typeof job.salary_min === 'number' ? job.salary_min : 'é¢è®®';
                const salaryMax = typeof job.salary_max === 'number' ? job.salary_max : 'é¢è®®';
                return `### å²—ä½ ${i + 1}ï¼š${job.title}\n\nğŸ“ **åœ°ç‚¹ï¼š** ${job.location || 'ä¸é™'} Â· ğŸ’° **è–ªèµ„ï¼š** ${salaryMin}K-${salaryMax}K/æœˆ\n\n${desc}\n\nğŸ·ï¸ ${(job.tags || []).join(' Â· ')}`;
              }).join('\n\n---\n\n');
              
              const updatedResult = `âœï¸ **å·²æ ¹æ®æ‚¨çš„è¦æ±‚ä¿®æ”¹ï¼Œè¯·å†æ¬¡ç¡®è®¤ï¼ˆå…± ${updatedJobs.length} ä¸ªå²—ä½ï¼‰ï¼š**\n\n${jobsSummary}\n\n---\n\nå¦‚éœ€ç»§ç»­è°ƒæ•´ï¼Œç›´æ¥å‘Šè¯‰æˆ‘å³å¯ã€‚æ²¡é—®é¢˜è¯·ç‚¹å‡»ä¸‹æ–¹ **ã€Œç¡®è®¤å‘å¸ƒã€**ã€‚`;
              
              // ç§»é™¤"æ­£åœ¨ä¿®æ”¹"æ¶ˆæ¯
              if (selectedTask) {
                setTaskMessages(prev => {
                  const msgs = prev[selectedTask.id] || [];
                  const filtered = msgs.filter(m => !m.content.includes('æ­£åœ¨æ ¹æ®æ‚¨çš„åé¦ˆä¿®æ”¹'));
                  return { ...prev, [selectedTask.id]: [...filtered, { role: 'assistant', content: updatedResult }] };
                });
              } else {
                setGeneralMessages(prev => {
                  const filtered = prev.filter(m => !m.content.includes('æ­£åœ¨æ ¹æ®æ‚¨çš„åé¦ˆä¿®æ”¹'));
                  return [...filtered, { role: 'assistant', content: updatedResult }];
                });
              }
              
              setPostMode(prev => ({ ...prev, jobDescription: JSON.stringify(updatedJobs) }));
            } catch (err) {
              addPostMsg(`âš ï¸ ä¿®æ”¹å¤±è´¥ï¼š${(err as any)?.message || 'æœªçŸ¥é”™è¯¯'}ï¼Œè¯·é‡è¯•ã€‚`);
            }
            }
          }
        } catch (err) {
          addPostMsg(`âš ï¸ æ“ä½œå¤±è´¥ï¼š${(err as any)?.message || 'æœªçŸ¥é”™è¯¯'}`);
        }
        setIsTyping(false);
      };
      
      handleOptimizeAction();
      return true;
    }
    
    // ========== æ™ºèƒ½é‚€è¯·æŠ•é€’é˜¶æ®µï¼ˆäº‘ç«¯å¼‚æ­¥ï¼‰ ==========
    if (postMode.step === 'invite') {
      addPostMsg(userInput, 'user');
      
      // æ£€æµ‹æ˜¯å¦ç›´æ¥è·³åˆ°ç­›é€‰
      const goToScreen = /^(å¼€å§‹æ™ºèƒ½ç­›é€‰|è¿›å…¥ç­›é€‰|æ™ºèƒ½ç­›é€‰|è·³åˆ°ç­›é€‰)$/i.test(userInput.trim());
      if (goToScreen) {
        setPostMode(prev => ({ ...prev, step: 'screen' }));
        return true;
      }
      
      const handleInviteAsync = async () => {
        try {
          const publishedJobs = postMode.publishedJobs || [];
          const jobIds = publishedJobs.map((j: any) => j._publishedId || j.id).filter(Boolean);
          const jobTitles = publishedJobs.map((j: any) => j.title).join('ã€');
          const isDefaultTrigger = /^(å¼€å§‹æ™ºèƒ½é‚€è¯·|å¼€å§‹é‚€è¯·|é‚€è¯·)$/i.test(userInput.trim());
          const extraRequirements = isDefaultTrigger ? '' : userInput;
          
          addPostMsg('â˜ï¸ æ­£åœ¨æäº¤äº‘ç«¯æ™ºèƒ½åŒ¹é…ä»»åŠ¡...');
          
          // å¯åŠ¨åç«¯å¼‚æ­¥ä»»åŠ¡
          const { startAsyncTask, getAsyncTaskStatus, updateTodo, seedMockCandidates } = await import('./services/apiService');
          
          // ç¡®ä¿æœ‰è¶³å¤Ÿçš„å€™é€‰äººæ•°æ®
          try { await seedMockCandidates(); } catch { /* ignore */ }
          const taskRes = await startAsyncTask({
            task_type: 'smart_invite',
            job_ids: jobIds,
            user_id: userId,
            todo_id: selectedTask?.id,
            extra_requirements: extraRequirements,
          });
          
          const asyncTaskId = taskRes.task_id;
          if (!asyncTaskId) throw new Error('å¯åŠ¨å¼‚æ­¥ä»»åŠ¡å¤±è´¥');
          
          // è½®è¯¢è¿›åº¦ â€” å®æ—¶å±•ç¤ºåç«¯ AI æ€è€ƒè¿‡ç¨‹
          let completed = false;
          let lastMsg = '';
          for (let i = 0; i < 80; i++) {
            await new Promise(r => setTimeout(r, 1000));
            const status = await getAsyncTaskStatus(asyncTaskId);
            
            // åªè¦ message æˆ– progress æœ‰å˜åŒ–å°±å®æ—¶æ›´æ–° UI
            const curMsg = `${status.progress}|${status.message || ''}`;
            if (curMsg !== lastMsg) {
              lastMsg = curMsg;
              const progressBar = 'â–ˆ'.repeat(Math.floor(status.progress / 5)) + 'â–‘'.repeat(20 - Math.floor(status.progress / 5));
              if (selectedTask) {
                setTaskMessages(prev => {
                  const msgs = prev[selectedTask.id] || [];
                  const filtered = msgs.filter(m => !m.content.startsWith('â˜ï¸') && !m.content.startsWith('â³') && !m.content.startsWith('ğŸ”') && !m.content.startsWith('ğŸ¤–') && !m.content.startsWith('ğŸ“¨'));
                  return { ...prev, [selectedTask.id]: [...filtered, { role: 'assistant', content: `â˜ï¸ **äº‘ç«¯æ™ºèƒ½é‚€è¯·** \`${status.progress}%\`\n${progressBar}\n\n${status.message || 'å¤„ç†ä¸­...'}` }] };
                });
              }
            }
            
            if (status.status === 'completed') {
              completed = true;
              const result = status.result || {};
              const candidates: any[] = result.matches || [];
              const realCount = result.total_real || 0;
              const simCount = result.total_simulated || 0;
              const memoryContext = result.memory_context || '';
              
              // æ„å»ºå€™é€‰äººå¡ç‰‡
              const candidateCards = candidates.map((c: any, idx: number) => {
                const stars = 'â­'.repeat(Math.round((c.match_score || 80) / 20));
                const sourceBadge = c.source === 'database' ? '`[DB]`' : '`[AI]`';
                const skillTags = (c.skills || []).slice(0, 5).join(' Â· ');
                return [
                  `**${idx + 1}. ${c.name}** ${sourceBadge} â€” ${c.title || ''}ï¼ˆ${c.experience || ''}ï¼‰`,
                  `   ${stars} **${c.match_score || 80}%** åŒ¹é…`,
                  `   ğŸ’¡ ${c.highlight || ''}`,
                  c.match_reason ? `   ğŸ“‹ ${c.match_reason}` : '',
                  skillTags ? `   ğŸ·ï¸ ${skillTags}` : '',
                ].filter(Boolean).join('\n');
              }).join('\n\n');
              
              const statsLine = `ğŸ“Š åŒ¹é…ç»Ÿè®¡ï¼šå…± **${candidates.length}** äººï¼ˆæ•°æ®åº“ ${realCount} äºº + AI æ¨è ${simCount} äººï¼‰`;
              const memLine = memoryContext ? `\n\nğŸ“ *${memoryContext.slice(0, 100)}*` : '';
              
              const inviteResponse = `âœ… **äº‘ç«¯æ™ºèƒ½åŒ¹é…å®Œæˆï¼**\n\nåŸºäºã€Œ${jobTitles}ã€çš„å²—ä½è¦æ±‚ï¼š\n\n${candidateCards}\n\n---\n\n${statsLine}${memLine}\n\nğŸ“¨ **å·²è‡ªåŠ¨å‘ä»¥ä¸Šå€™é€‰äººå‘é€æŠ•é€’é‚€è¯·**ï¼ˆæ—¥å¿—å·²è®°å½•ï¼‰\n\nä¸‹ä¸€æ­¥å°†è¿›å…¥ **ã€Œæ™ºèƒ½ç­›é€‰ã€** ç¯èŠ‚ï¼ŒAI å°†å¯¹å€™é€‰äººè¿›è¡Œç‹¬ç«‹å®¡æ ¸åˆ†æã€‚\n\næ‚¨å¯ä»¥ï¼š\nâ€¢ ç‚¹å‡» **ã€Œå¼€å§‹æ™ºèƒ½ç­›é€‰ã€** è¿›å…¥ç­›é€‰\nâ€¢ è¾“å…¥ **"å†åŒ¹é…ä¸€æ‰¹"** è·å–æ›´å¤šå€™é€‰äºº`;
              
              if (selectedTask) {
                setTaskMessages(prev => {
                  const msgs = prev[selectedTask.id] || [];
                  const filtered = msgs.filter(m => !m.content.includes('â˜ï¸') && !m.content.includes('â³') && !m.content.includes('äº‘ç«¯'));
                  return { ...prev, [selectedTask.id]: [...filtered, { role: 'assistant', content: inviteResponse }] };
                });
              }
              
              // æ›´æ–°ä»»åŠ¡è¿›åº¦
              if (selectedTask) {
                try {
                  await updateTodo(selectedTask.id, { 
                    progress: 60, current_step: 'screen',
                    steps: [
                      { step: 1, title: 'æè¿°æ‹›è˜éœ€æ±‚', status: 'completed' },
                      { step: 2, title: 'AI ç”Ÿæˆå²—ä½', status: 'completed' },
                      { step: 3, title: 'ç¡®è®¤å¹¶å‘å¸ƒ', status: 'completed' },
                      { step: 4, title: 'æ™ºèƒ½é‚€è¯·æŠ•é€’', status: 'completed' },
                      { step: 5, title: 'æ™ºèƒ½ç­›é€‰è¯„ä¼°', status: 'in_progress' },
                    ],
                    ai_advice: `å·²ä¸º ${jobTitles} åŒ¹é… ${candidates.length} åå€™é€‰äººå¹¶å‘é€é‚€è¯·ï¼ˆäº‘ç«¯å¼‚æ­¥ï¼‰ï¼Œç­‰å¾…è¿›å…¥ç­›é€‰ç¯èŠ‚ã€‚`,
                  });
                  if (typeof refetchTasks === 'function') refetchTasks();
                } catch { /* ignore */ }
              }
              break;
            }
            
            if (status.status === 'failed') {
              throw new Error(status.message || 'äº‘ç«¯åŒ¹é…å¤±è´¥');
            }
          }
          
          if (!completed) {
            addPostMsg('â³ äº‘ç«¯åŒ¹é…ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨åç‚¹å‡»ã€Œå¼€å§‹æ™ºèƒ½é‚€è¯·ã€æŸ¥çœ‹è¿›åº¦ã€‚');
          }
        } catch (err) {
          addPostMsg(`âš ï¸ æ™ºèƒ½åŒ¹é…å¤±è´¥ï¼š${(err as any)?.message || 'æœªçŸ¥é”™è¯¯'}ï¼Œè¯·é‡è¯•ã€‚`);
        }
      };
      
      handleInviteAsync();
      return true;
    }
    
    // ========== æ™ºèƒ½ç­›é€‰é˜¶æ®µï¼ˆäº‘ç«¯å¼‚æ­¥ï¼‰ ==========
    if (postMode.step === 'screen') {
      addPostMsg(userInput, 'user');
      
      const handleScreenAsync = async () => {
        try {
          const publishedJobs = postMode.publishedJobs || [];
          const jobIds = publishedJobs.map((j: any) => j._publishedId || j.id).filter(Boolean);
          const jobTitles = publishedJobs.map((j: any) => j.title).join('ã€');
          const isDefaultTrigger = /^(å¼€å§‹æ™ºèƒ½ç­›é€‰|å¼€å§‹ç­›é€‰|ç­›é€‰)$/i.test(userInput.trim());
          const extraRequirements = isDefaultTrigger ? '' : userInput;
          
          addPostMsg('â˜ï¸ æ­£åœ¨æäº¤äº‘ç«¯æ™ºèƒ½ç­›é€‰ä»»åŠ¡...\n\nAI å°†å¯¹å€™é€‰äººè¿›è¡Œå¤šç»´åº¦ç‹¬ç«‹å®¡æ ¸åˆ†æã€‚');
          
          const { startAsyncTask, getAsyncTaskStatus, updateTodo, createJobLog } = await import('./services/apiService');
          const taskRes = await startAsyncTask({
            task_type: 'smart_screen',
            job_ids: jobIds,
            user_id: userId,
            todo_id: selectedTask?.id,
            extra_requirements: extraRequirements,
          });
          
          const asyncTaskId = taskRes.task_id;
          if (!asyncTaskId) throw new Error('å¯åŠ¨å¼‚æ­¥ç­›é€‰ä»»åŠ¡å¤±è´¥');
          
          // è½®è¯¢è¿›åº¦ â€” å®æ—¶å±•ç¤ºåç«¯ AI æ€è€ƒè¿‡ç¨‹ï¼ˆåç«¯æ¯ 1.5s æ›´æ–°ä¸€æ¬¡ï¼‰
          let completed = false;
          let lastMsg = '';
          for (let i = 0; i < 100; i++) {
            await new Promise(r => setTimeout(r, 1000));
            const status = await getAsyncTaskStatus(asyncTaskId);
            
            // åªè¦ message æˆ– progress æœ‰å˜åŒ–å°±å®æ—¶æ›´æ–° UI
            const curMsg = `${status.progress}|${status.message || ''}`;
            if (curMsg !== lastMsg) {
              lastMsg = curMsg;
              const progressBar = 'â–ˆ'.repeat(Math.floor(status.progress / 5)) + 'â–‘'.repeat(20 - Math.floor(status.progress / 5));
              if (selectedTask) {
                setTaskMessages(prev => {
                  const msgs = prev[selectedTask.id] || [];
                  const filtered = msgs.filter(m => !m.content.startsWith('â˜ï¸') && !m.content.startsWith('â³') && !m.content.startsWith('ğŸ¢') && !m.content.startsWith('ğŸ‘¤') && !m.content.startsWith('ğŸ“Š'));
                  return { ...prev, [selectedTask.id]: [...filtered, { role: 'assistant', content: `â˜ï¸ **äº‘ç«¯æ™ºèƒ½ç­›é€‰** \`${status.progress}%\`\n${progressBar}\n\n${status.message || 'å¤„ç†ä¸­...'}` }] };
                });
              }
            }
            
            if (status.status === 'completed') {
              completed = true;
              const result = status.result || {};
              const bothPass: any[] = result.both_pass || [];
              const employerOnly: any[] = result.employer_only || [];
              const candidateOnly: any[] = result.candidate_only || [];
              const neither: any[] = result.neither || [];
              const summary = result.summary || {};
              
              // æ„å»ºç­›é€‰æŠ¥å‘Š
              let reportSections = '';
              
              if (bothPass.length > 0) {
                const passCards = bothPass.map((c: any, i: number) => {
                  const thinkContent = [
                    `ğŸ¢ **ä¼ä¸šå®¡æ ¸**ï¼š${c.employer_score || 0}åˆ† â€” ${c.employer_analysis || 'æš‚æ— åˆ†æ'}`,
                    `ğŸ‘¤ **æŠ•é€’æ„æ„¿**ï¼š${c.candidate_interest || 0}% â€” ${c.response_type || 'æœªçŸ¥'}`,
                    (c.strengths?.length ? `âœ… **ä¼˜åŠ¿**ï¼š${c.strengths.join(' Â· ')}` : ''),
                    (c.concerns?.length ? `âš ï¸ **å…³æ³¨ç‚¹**ï¼š${c.concerns.join(' Â· ')}` : ''),
                  ].filter(Boolean).join('\n\n');
                  return `âœ… **${i+1}. ${c.name}** â€” åŒ¹é… ${c.match_score || 0}%\n\n<think>${thinkContent}</think>`;
                }).join('\n\n');
                reportSections += `### âœ… ç­›é€‰é€šè¿‡ï¼ˆ${bothPass.length} äººï¼‰\n\n${passCards}\n\n`;
              }
              
              if (employerOnly.length > 0) {
                const eoCards = employerOnly.map((c: any) => {
                  const thinkContent = c.candidate_analysis || 'æš‚æ— è¯¦ç»†åˆ†æ';
                  return `ğŸ¢ **${c.name}** â€” ä¼ä¸šé€šè¿‡ (${c.employer_score || 0}åˆ†)ï¼Œå€™é€‰äºº${c.response_type || 'æœªå“åº”'}\n\n<think>${thinkContent}</think>`;
                }).join('\n\n');
                reportSections += `### ğŸ¢ å¾…å€™é€‰äººç¡®è®¤ï¼ˆ${employerOnly.length} äººï¼‰\n\n${eoCards}\n\n`;
              }
              
              if (candidateOnly.length > 0) {
                const coCards = candidateOnly.map((c: any) => {
                  const thinkContent = c.employer_analysis || 'æš‚æ— è¯¦ç»†åˆ†æ';
                  return `ğŸ‘¤ **${c.name}** â€” å€™é€‰äººæœ‰æ„å‘ (${c.candidate_interest || 0}%)ï¼Œä¼ä¸šæ–¹æœªé€šè¿‡\n\n<think>${thinkContent}</think>`;
                }).join('\n\n');
                reportSections += `### ğŸ‘¤ ä»…å€™é€‰äººæ„å‘ï¼ˆ${candidateOnly.length} äººï¼‰\n\n${coCards}\n\n`;
              }
              
              if (neither.length > 0) {
                const nCards = neither.map((c: any) => `âŒ **${c.name}** â€” æœªé€šè¿‡`).join('\n');
                reportSections += `### âŒ æœªé€šè¿‡ï¼ˆ${neither.length} äººï¼‰\n\n${nCards}\n\n`;
              }
              
              // æ„å»ºæ¯ä¸ªå€™é€‰äººçš„è¯¦ç»†è¯„å®¡æ‘˜è¦ï¼ˆç”¨äºæ—¥å¿—ï¼‰
              const allResults: any[] = result.final_results || [];
              const screenDetailLines = allResults.map((r: any) => 
                `${r.name}ï¼š${r.final_status}ï¼ˆä¼ä¸š${r.employer_score || 0}åˆ† / å€™é€‰äºº${r.candidate_interest || 0}%ï¼‰`
              ).join('ã€');
              
              if (bothPass.length > 0) {
                // æœ‰é€šè¿‡çš„å€™é€‰äºº â€” è·å–è”ç³»æ–¹å¼ â†’ è¿›å…¥äº’æ¢é˜¶æ®µ
                const passNames = bothPass.map((c: any) => c.name).join('ã€');
                
                // è·å–è”ç³»æ–¹å¼
                let contactsInfo = '';
                try {
                  const { getExchangeContacts } = await import('./services/apiService');
                  const exchangeJobIds = publishedJobs.map((pj: any) => pj._publishedId || pj.id).filter(Boolean);
                  const contactsResult = await getExchangeContacts(exchangeJobIds, bothPass);
                  const contacts = contactsResult.contacts || [];
                  contactsInfo = contacts.map((c: any, idx: number) => {
                    const simTag = c.is_simulated_contact ? ' *(æ¨¡æ‹Ÿ)* ' : '';
                    return `**${idx + 1}. ${c.name}**${simTag}\n` +
                      `   ğŸ“± ç”µè¯ï¼š\`${c.phone || 'æœªæä¾›'}\`\n` +
                      `   ğŸ“§ é‚®ç®±ï¼š\`${c.email || 'æœªæä¾›'}\`\n` +
                      `   ğŸ¯ åŒ¹é… ${c.match_score}% | ä¼ä¸šè¯„åˆ† ${c.employer_score}åˆ†` +
                      (c.strengths?.length ? `\n   âœ… ä¼˜åŠ¿ï¼š${c.strengths.join('ã€')}` : '');
                  }).join('\n\n');
                } catch {
                  contactsInfo = bothPass.map((c: any, idx: number) =>
                    `**${idx + 1}. ${c.name}** â€” åŒ¹é… ${c.match_score || 0}% | ä¼ä¸šè¯„åˆ† ${c.employer_score || 0}åˆ†`
                  ).join('\n');
                }
                
                const screenResponse = `ğŸ“Š **æ™ºèƒ½ç­›é€‰æŠ¥å‘Š**\n\nå¯¹ã€Œ${jobTitles}ã€çš„å€™é€‰äººå®Œæˆäº† AI ç‹¬ç«‹å®¡æ ¸åˆ†æï¼š\n\nğŸ“ˆ **æ±‡æ€»**ï¼šå…± ${summary.total || 0} äºº â†’ é€šè¿‡ **${summary.both_pass_count || 0}** äºº | å¾…ç¡®è®¤ ${summary.employer_only_count || 0} äºº | æœªé€šè¿‡ ${(summary.candidate_only_count || 0) + (summary.neither_count || 0)} äºº\n\n---\n\n${reportSections}---\n\nâœ… **ç­›é€‰é€šè¿‡ï¼è”ç³»æ–¹å¼å·²è‡ªåŠ¨äº’æ¢ï¼š**\n\n${contactsInfo}\n\n---\n\nğŸ“ **è¯·å°½å¿«ä¸å€™é€‰äººå–å¾—è”ç³»ï¼**\n\nè”ç³»åè¯·å‰å¾€å²—ä½è¯¦æƒ…é¡µé€šè¿‡ã€Œåé¦ˆè¯„ä»·ã€å‘Šè¯‰æˆ‘ä»¬ä½“éªŒï¼Œå¸®åŠ© AI ä¼˜åŒ–åç»­åŒ¹é…è´¨é‡ã€‚\n\nğŸ‰ **æ‹›è˜ä»»åŠ¡å·²å®Œæˆï¼** å¦‚éœ€ç»§ç»­æ‹›è˜å…¶ä»–å²—ä½ï¼Œå¯éšæ—¶å‘Šè¯‰æˆ‘ã€‚`;
                
                if (selectedTask) {
                  setTaskMessages(prev => {
                    const msgs = prev[selectedTask.id] || [];
                    const filtered = msgs.filter(m => !m.content.includes('â˜ï¸') && !m.content.includes('â³') && !m.content.includes('äº‘ç«¯'));
                    return { ...prev, [selectedTask.id]: [...filtered, { role: 'assistant', content: screenResponse }] };
                  });
                }
                
                // ç­›é€‰é€šè¿‡ â†’ è‡ªåŠ¨å®Œæˆäº’æ¢ â†’ æ ‡è®°ä»»åŠ¡å®Œæˆï¼ˆä¿æŒ complete çŠ¶æ€ä»¥æ˜¾ç¤ºå…¨å®Œæˆæ­¥éª¤æ¡ï¼‰
                setPostMode(prev => ({ ...prev, active: true, step: 'complete' }));
                
                // æ›´æ–°ä»»åŠ¡è¿›åº¦ â†’ å®Œæˆ
                if (selectedTask) {
                  try {
                    await updateTodo(selectedTask.id, { 
                      status: 'completed', progress: 100, current_step: 'complete',
                      steps: [
                        { step: 1, title: 'æè¿°æ‹›è˜éœ€æ±‚', status: 'completed' },
                        { step: 2, title: 'AI ç”Ÿæˆå²—ä½', status: 'completed' },
                        { step: 3, title: 'ç¡®è®¤å¹¶å‘å¸ƒ', status: 'completed' },
                        { step: 4, title: 'æ™ºèƒ½é‚€è¯·æŠ•é€’', status: 'completed' },
                        { step: 5, title: 'æ™ºèƒ½ç­›é€‰è¯„ä¼°', status: 'completed' },
                      ],
                      ai_advice: `æ™ºèƒ½ç­›é€‰å®Œæˆï¼Œ${bothPass.length} äººé€šè¿‡ã€‚è”ç³»æ–¹å¼å·²è‡ªåŠ¨äº’æ¢ï¼Œæ‹›è˜ä»»åŠ¡å®Œæˆã€‚`,
                    });
                    if (typeof refetchTasks === 'function') refetchTasks();
                  } catch { /* ignore */ }
                }
                
                // å†™å…¥å²—ä½æ—¥å¿— â€” ç­›é€‰ç»“æœç¡®è®¤ + è‡ªåŠ¨äº’æ¢è”ç³»æ–¹å¼
                for (const pj of publishedJobs) {
                  const jobId = pj._publishedId || pj.id;
                  if (jobId) {
                    try {
                      await createJobLog({
                        job_id: jobId, actor_type: 'system', action: 'screen_result',
                        title: 'æ™ºèƒ½ç­›é€‰å®Œæˆ Â· è”ç³»æ–¹å¼å·²äº’æ¢',
                        content: `å²—ä½ã€Œ${pj.title}ã€æ™ºèƒ½ç­›é€‰å®Œæˆï¼šå…± ${summary.total || 0} äººï¼Œé€šè¿‡ ${bothPass.length} äººï¼ˆ${passNames}ï¼‰ã€‚è”ç³»æ–¹å¼å·²è‡ªåŠ¨äº’æ¢ï¼Œæ‹›è˜æµç¨‹å®Œæˆã€‚`,
                        extra_data: { 
                          total: summary.total, both_pass: bothPass.length, 
                          employer_only: employerOnly.length, neither: neither.length,
                          pass_names: bothPass.map((c: any) => c.name),
                          contacts_exchanged: true,
                          task_completed: true,
                        },
                        todo_id: selectedTask?.id,
                      });
                    } catch { /* ignore */ }
                  }
                }
                
                // è‡ªåŠ¨å®Œæˆ Flow è®°å½•
                try {
                  const { completeExchangeFlows } = await import('./services/apiService');
                  const exchangeJobIds = publishedJobs.map((pj: any) => pj._publishedId || pj.id).filter(Boolean);
                  if (exchangeJobIds.length > 0) {
                    await completeExchangeFlows(exchangeJobIds, bothPass.map((c: any) => c.name));
                  }
                } catch { /* ignore */ }
              } else {
                // æ— é€šè¿‡çš„å€™é€‰äºº
                const screenResponse = `ğŸ“Š **æ™ºèƒ½ç­›é€‰æŠ¥å‘Š**\n\nå¯¹ã€Œ${jobTitles}ã€çš„å€™é€‰äººå®Œæˆäº† AI ç‹¬ç«‹å®¡æ ¸åˆ†æï¼š\n\nğŸ“ˆ **æ±‡æ€»**ï¼šå…± ${summary.total || 0} äººï¼Œæš‚æ— é€šè¿‡ç­›é€‰çš„å€™é€‰äººã€‚\n\n---\n\n${reportSections}---\n\nâš ï¸ **æš‚æ— é€šè¿‡ç­›é€‰çš„å€™é€‰äºº**\n\næ‚¨å¯ä»¥ï¼š\nâ€¢ è¾“å…¥ **"é‡æ–°ç­›é€‰"** è°ƒæ•´ç­›é€‰æ¡ä»¶\nâ€¢ è¿”å›é‚€è¯·é˜¶æ®µåŒ¹é…æ›´å¤šå€™é€‰äºº`;
                
                if (selectedTask) {
                  setTaskMessages(prev => {
                    const msgs = prev[selectedTask.id] || [];
                    const filtered = msgs.filter(m => !m.content.includes('â˜ï¸') && !m.content.includes('â³') && !m.content.includes('äº‘ç«¯'));
                    return { ...prev, [selectedTask.id]: [...filtered, { role: 'assistant', content: screenResponse }] };
                  });
                  
                  try {
                    await updateTodo(selectedTask.id, { 
                      progress: 75, current_step: 'screen',
                      ai_advice: `æ™ºèƒ½ç­›é€‰å®Œæˆä½†æ— é€šè¿‡å€™é€‰äººï¼Œå»ºè®®è°ƒæ•´æ¡ä»¶é‡æ–°ç­›é€‰ã€‚`,
                    });
                    if (typeof refetchTasks === 'function') refetchTasks();
                  } catch { /* ignore */ }
                }
                
                // å†™å…¥å²—ä½æ—¥å¿— â€” æ— é€šè¿‡å€™é€‰äºº
                for (const pj of publishedJobs) {
                  const jobId = pj._publishedId || pj.id;
                  if (jobId) {
                    try {
                      await createJobLog({
                        job_id: jobId, actor_type: 'system', action: 'user_action',
                        title: 'æ™ºèƒ½ç­›é€‰æŠ¥å‘Šå·²å±•ç¤ºï¼ˆæš‚æ— é€šè¿‡ï¼‰',
                        content: `ç”¨æˆ·æŸ¥çœ‹äº†å²—ä½ã€Œ${pj.title}ã€çš„æ™ºèƒ½ç­›é€‰æŠ¥å‘Šï¼šå…± ${summary.total || 0} äººï¼Œæš‚æ— é€šè¿‡ç­›é€‰çš„å€™é€‰äººã€‚è¯¦ç»†è¯„å®¡ï¼š${screenDetailLines}ã€‚ç­‰å¾…ç”¨æˆ·è°ƒæ•´æ¡ä»¶é‡æ–°ç­›é€‰ã€‚`,
                        extra_data: { 
                          total: summary.total, both_pass: 0, 
                          employer_only: employerOnly.length, 
                          candidate_only: candidateOnly.length,
                          neither: neither.length,
                          needs_retry: true,
                        },
                        todo_id: selectedTask?.id,
                      });
                    } catch { /* ignore */ }
                  }
                }
              }
              break;
            }
            
            if (status.status === 'failed') {
              throw new Error(status.message || 'äº‘ç«¯ç­›é€‰å¤±è´¥');
            }
          }
          
          if (!completed) {
            addPostMsg('â³ äº‘ç«¯ç­›é€‰ä»åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨åç‚¹å‡»ã€Œå¼€å§‹æ™ºèƒ½ç­›é€‰ã€æŸ¥çœ‹è¿›åº¦ã€‚');
          }
        } catch (err) {
          addPostMsg(`âš ï¸ æ™ºèƒ½ç­›é€‰å¤±è´¥ï¼š${(err as any)?.message || 'æœªçŸ¥é”™è¯¯'}ï¼Œè¯·é‡è¯•ã€‚`);
        }
      };
      
      handleScreenAsync();
      return true;
    }
    
    // exchange é˜¶æ®µå·²åˆå¹¶åˆ°ç­›é€‰ä¸­ï¼Œç­›é€‰é€šè¿‡è‡ªåŠ¨å®Œæˆäº’æ¢
    
    return false;
  };
  
  // å¤„ç†é‚€è¯·å¥½å‹æ¨¡å¼ URL å‚æ•°
  useEffect(() => {
    if (taskTypeFromUrl === 'invite') {
      const userInviteLink = `${window.location.origin}${window.location.pathname}#/login?ref=${user?.invite_code || 'DEVNORS'}`;
      setInviteMode({
        active: true,
        step: 'intro',
        inviteLink: userInviteLink,
        inviteCount: 0
      });
      
      // æ·»åŠ é‚€è¯·å¥½å‹å¼•å¯¼æ¶ˆæ¯
      const inviteMessage = `ğŸ **é‚€è¯·å¥½å‹èµš Token**\n\næ¬¢è¿ä½¿ç”¨ Devnors é‚€è¯·å¥–åŠ±è®¡åˆ’ï¼\n\n**å¥–åŠ±è§„åˆ™ï¼š**\nâ€¢ æ¯æˆåŠŸé‚€è¯· 1 ä½å¥½å‹æ³¨å†Œï¼Œæ‚¨è·å¾— **50,000 Token**\nâ€¢ å¥½å‹ä¹Ÿè·å¾— **20,000 Token** é¢å¤–å¥–åŠ±\nâ€¢ æ— ä¸Šé™ï¼Œé‚€è¯·è¶Šå¤šï¼Œå¥–åŠ±è¶Šå¤šï¼\n\n**æ‚¨çš„ä¸“å±é‚€è¯·ç ï¼š** \`${user?.invite_code || 'DEVNORS'}\`\n**é‚€è¯·é“¾æ¥ï¼š** \`${userInviteLink}\`\n\nå¥½å‹å¯ä»¥é€šè¿‡é“¾æ¥æ³¨å†Œï¼Œæˆ–åœ¨æ³¨å†Œæ—¶æ‰‹åŠ¨è¾“å…¥æ‚¨çš„é‚€è¯·ç ã€‚\n\nè¯·è¾“å…¥ä»¥ä¸‹æ“ä½œï¼š\n1ï¸âƒ£ å¤åˆ¶é‚€è¯·é“¾æ¥\n2ï¸âƒ£ æŸ¥çœ‹é‚€è¯·è®°å½•\n3ï¸âƒ£ äº†è§£æ›´å¤šå¥–åŠ±è§„åˆ™`;
      setGeneralMessages([{role: 'assistant', content: inviteMessage}]);
      
      // æ¸…é™¤ URL å‚æ•°
      navigate('/ai-assistant', { replace: true });
    }
  }, [taskTypeFromUrl, navigate, user, userId]);
  
  // å¤„ç†ä¸ªäººè®¤è¯ä»»åŠ¡ URL å‚æ•°
  useEffect(() => {
    if (taskTypeFromUrl === 'personal_verification' && isLoggedIn && userId) {
      const handleVerificationTask = async () => {
        try {
          const { getTasks, createTodo } = await import('./services/apiService');
          
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è®¤è¯ä»»åŠ¡
          const existingTasks = await getTasks(userId);
          let verificationTask = existingTasks.find((t: any) => 
            t.todo_type === 'personal_verification' || 
            t.title === 'å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯' ||
            (t.title.includes('å®Œå–„') && t.title.includes('è®¤è¯'))
          );
          
          // å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
          if (!verificationTask) {
            const verificationTaskData = {
              title: 'å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯',
              description: 'å®Œæˆèº«ä»½è®¤è¯ã€å­¦å†è®¤è¯ã€æŠ€èƒ½è®¤è¯ã€å·¥ä½œè¯æ˜ç­‰ï¼Œæå‡æ±‚èŒç«äº‰åŠ›ï¼Œå¢åŠ é¢è¯•æœºä¼š',
              priority: 'high',
              source: 'agent',
              todo_type: 'personal_verification',
              ai_advice: 'å®Œæˆä¸ªäººè®¤è¯å¯ä»¥å¤§å¹…æå‡æ‚¨çš„å¯ä¿¡åº¦å’Œæ±‚èŒæˆåŠŸç‡ã€‚å»ºè®®ä¼˜å…ˆå®Œæˆèº«ä»½è®¤è¯å’Œå­¦å†è®¤è¯ã€‚',
              steps: [
                { order: 1, title: 'å®Œæˆèº«ä»½è®¤è¯', status: 'pending' },
                { order: 2, title: 'å®Œæˆå­¦å†è®¤è¯', status: 'pending' },
                { order: 3, title: 'å®ŒæˆæŠ€èƒ½è®¤è¯', status: 'pending' },
                { order: 4, title: 'å®Œæˆå·¥ä½œè¯æ˜', status: 'pending' },
                { order: 5, title: 'å®Œæˆå¾ä¿¡è®¤è¯', status: 'pending' }
              ]
            };
            
            verificationTask = await createTodo(verificationTaskData, userId);
            console.log('[Verification Task] å·²åˆ›å»ºä¸ªäººè®¤è¯ä»»åŠ¡');
            
            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
            if (typeof refetchTasks === 'function') {
              refetchTasks();
            }
          }
          
          // é€‰ä¸­è¯¥ä»»åŠ¡
          if (verificationTask) {
            setSelectedTask(verificationTask);
            
            // å¯åŠ¨è®¤è¯æ¨¡å¼
            setVerificationMode({
              active: true,
              items: verificationItems,
              currentIndex: 0,
              completedItems: []
            });
            
            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯ï¼Œç›´æ¥å¼€å§‹ç¬¬ä¸€é¡¹è®¤è¯
            const firstItem = verificationItems[0];
            const totalSteps = verificationItems.length;
            const welcomeMessage = `ğŸ‘‹ **æ¬¢è¿æ¥åˆ°ä¸ªäººè®¤è¯ä¸­å¿ƒï¼**\n\nå®Œæˆè®¤è¯å¯ä»¥å¸®åŠ©æ‚¨ï¼š\nâœ… æé«˜ç®€å†å¯ä¿¡åº¦ï¼Œå¢åŠ  HR ä¿¡ä»»\nâœ… è·å¾—"å·²è®¤è¯"ä¸“å±æ ‡è¯†\nâœ… ä¼˜å…ˆå±•ç¤ºåœ¨æ¨èåˆ—è¡¨ä¸­\nâœ… å¢åŠ  30% ä»¥ä¸Šçš„é¢è¯•é‚€è¯·æœºä¼š\n\n---\n\nğŸ“‹ **è®¤è¯è¿›åº¦ï¼š** 0/${totalSteps} é¡¹\n\n${firstItem.icon} **ç¬¬ 1 é¡¹ï¼š${firstItem.label}**\n\n${firstItem.description}`;
            
            setTaskMessages(prev => ({
              ...prev,
              [verificationTask.id]: [{ role: 'assistant', content: welcomeMessage }]
            }));
          }
          
        } catch (error) {
          console.error('å¤„ç†è®¤è¯ä»»åŠ¡å¤±è´¥:', error);
        }
        
        // æ¸…é™¤ URL å‚æ•°
        navigate('/ai-assistant', { replace: true });
      };
      
      handleVerificationTask();
    }
  }, [taskTypeFromUrl, isLoggedIn, userId, navigate, refetchTasks]);
  
  // å¤„ç†é‚€è¯·å¥½å‹æµç¨‹
  const handleInviteProcess = async (userInput: string) => {
    if (inviteMode.active) {
      setGeneralMessages(prev => [...prev, {role: 'user', content: userInput}]);
      setIsTyping(true);
      
      setTimeout(() => {
        let response = '';
        if (userInput.includes('1') || userInput.includes('å¤åˆ¶') || userInput.includes('é“¾æ¥')) {
          response = `ğŸ“‹ **é‚€è¯·é“¾æ¥å·²å‡†å¤‡å¥½ï¼**\n\n**é‚€è¯·é“¾æ¥ï¼š**\n\`${inviteMode.inviteLink}\`\n\n**é‚€è¯·ç ï¼š** \`${user?.invite_code || ''}\`\n\n**ä¸¤ç§é‚€è¯·æ–¹å¼ï¼š**\nâ€¢ æ–¹å¼ä¸€ï¼šç›´æ¥åˆ†äº«é“¾æ¥ï¼Œå¥½å‹ç‚¹å‡»å³å¯æ³¨å†Œ\nâ€¢ æ–¹å¼äºŒï¼šå‘Šè¯‰å¥½å‹æ‚¨çš„é‚€è¯·ç ï¼Œæ³¨å†Œæ—¶æ‰‹åŠ¨è¾“å…¥\n\nå¥½å‹æ³¨å†Œåï¼Œæ‚¨è·å¾— **50,000 Token**ï¼Œå¥½å‹è·å¾— **20,000 Token**ï¼`;
        } else if (userInput.includes('2') || userInput.includes('è®°å½•') || userInput.includes('æŸ¥çœ‹')) {
          response = `ğŸ“Š **é‚€è¯·è®°å½•**\n\n**æœ¬æœˆé‚€è¯·ç»Ÿè®¡ï¼š**\nâ€¢ å·²é‚€è¯·ï¼š${inviteMode.inviteCount} äºº\nâ€¢ å·²è·å¾— Tokenï¼š${(inviteMode.inviteCount * 50000).toLocaleString()}\nâ€¢ å¾…å‘æ”¾å¥–åŠ±ï¼š0 Token\n\n**é‚€è¯·æ˜ç»†ï¼š**\n${inviteMode.inviteCount === 0 ? 'æš‚æ— é‚€è¯·è®°å½•ï¼Œå¿«å»åˆ†äº«æ‚¨çš„é‚€è¯·é“¾æ¥å§ï¼' : 'â€¢ ç”¨æˆ· A*** - å·²æ³¨å†Œ - +50,000 Token'}\n\nç»§ç»­é‚€è¯·å¥½å‹ï¼Œèµšå–æ›´å¤š Tokenï¼`;
        } else if (userInput.includes('3') || userInput.includes('è§„åˆ™') || userInput.includes('äº†è§£')) {
          response = `ğŸ“œ **å¥–åŠ±è§„åˆ™è¯¦æƒ…**\n\n**åŸºç¡€å¥–åŠ±ï¼š**\nâ€¢ å¥½å‹æ³¨å†ŒæˆåŠŸï¼šæ‚¨è·å¾— **+50,000 Token**\nâ€¢ å¥½å‹è·å¾— **+20,000 Token** é¢å¤–å¥–åŠ±\n\n**é‚€è¯·æ–¹å¼ï¼š**\nâ€¢ åˆ†äº«é‚€è¯·é“¾æ¥ï¼ˆå¥½å‹ç‚¹å‡»ç›´æ¥æ³¨å†Œï¼‰\nâ€¢ åˆ†äº«é‚€è¯·ç ï¼ˆå¥½å‹æ³¨å†Œæ—¶æ‰‹åŠ¨è¾“å…¥ï¼‰\n\n**æ³¨æ„äº‹é¡¹ï¼š**\nâ€¢ å¥–åŠ±å°†åœ¨å¥½å‹å®Œæˆæ³¨å†Œåå³æ—¶å‘æ”¾\nâ€¢ åŒä¸€è®¾å¤‡/IP ä»…è®¡ç®—ä¸€æ¬¡æœ‰æ•ˆé‚€è¯·\nâ€¢ å¥–åŠ± Token å¯ç”¨äºå¹³å°æ‰€æœ‰ AI åŠŸèƒ½\nâ€¢ æ— é‚€è¯·ä¸Šé™ï¼Œé‚€è¯·è¶Šå¤šå¥–åŠ±è¶Šå¤š\n\næœ‰å…¶ä»–é—®é¢˜å—ï¼Ÿ`;
        } else {
          response = `æˆ‘ç†è§£æ‚¨è¯´çš„æ˜¯ï¼š"${userInput}"\n\nå…³äºé‚€è¯·å¥½å‹ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨ï¼š\n1ï¸âƒ£ å¤åˆ¶é‚€è¯·é“¾æ¥\n2ï¸âƒ£ æŸ¥çœ‹é‚€è¯·è®°å½•\n3ï¸âƒ£ äº†è§£æ›´å¤šå¥–åŠ±è§„åˆ™\n\nè¯·è¾“å…¥å¯¹åº”æ•°å­—æˆ–æè¿°æ‚¨çš„éœ€æ±‚ã€‚`;
        }
        
        setGeneralMessages(prev => [...prev, {role: 'assistant', content: response}]);
        setIsTyping(false);
      }, 1000);
      
      return true;
    }
    
    return false;
  };
  
  // ä¿å­˜ç¼–è¾‘çš„æ•°æ®
  const saveEditData = async (fieldKey: string, value: string) => {
    const [type, field] = fieldKey.split('_');
    
    try {
      // æ ¹æ®ç±»å‹ä¿å­˜åˆ°ä¸åŒçš„åœ°æ–¹
      if (type === 'candidate' || type === 'employer') {
        const profileType = type as 'candidate' | 'employer';
        
        // åªæœ‰å…³é”®å­—æ®µæ‰ä¿å­˜åˆ° Memoryï¼ˆé¿å…é‡å¤ä¿å­˜æ‰€æœ‰å­—æ®µï¼‰
        const memoryFields = ['experience', 'skills', 'education', 'projects', 'requirement', 'tech', 'culture', 'benefit'];
        const memoryType = field.toLowerCase();
        const memoryScope = type === 'employer' ? 'employer' : 'candidate';
        
        if (memoryFields.includes(memoryType)) {
          try {
            console.log('Saving memory:', { type: memoryType, content: value, importance: 'High', scope: memoryScope, userId });
            await createMemory({
              type: memoryType,
              content: value,
              importance: 'High',
              scope: memoryScope
            }, userId);
            refetchMemories();
          } catch (memErr) {
            console.log('Memory ä¿å­˜è·³è¿‡ï¼ˆå¯èƒ½é‡å¤ï¼‰:', memErr);
          }
        }
        
        // ä¿å­˜åˆ° Profile API (ç”¨äº Profile é¡µé¢æ˜¾ç¤º)
        try {
          const { updateProfileField } = await import('./services/apiService');
          await updateProfileField(userId, profileType, field, value, true); // ç¼–è¾‘æ¨¡å¼å¼ºåˆ¶è¦†ç›–
          console.log('Profile field updated:', { field, value, profileType });
        } catch (profileErr) {
          console.log('Profile API update failed (non-critical):', profileErr);
        }
      }
      return true;
    } catch (error) {
      console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
      return false;
    }
  };
  
  // è·å–å½“å‰æ˜¾ç¤ºçš„æ¶ˆæ¯
  const currentMessages = selectedTask 
    ? (taskMessages[selectedTask.id] || [])
    : generalMessages;
  
  // è·å–ç”¨æˆ·ç®€å†ç¼ºå¤±å­—æ®µ
  const getProfileMissingFields = async () => {
    try {
      const { getUserProfile } = await import('./services/apiService');
      const profile = await getUserProfile(userId, 'candidate');
      
      const missingFields: {key: string; label: string; editUrl: string}[] = [];
      
      if (!profile?.display_name || profile.display_name.trim() === '') {
        missingFields.push({key: 'display_name', label: 'å§“å', editUrl: '/ai-assistant?editType=candidate&editField=name'});
      }
      if (!profile?.title || profile.title.trim() === '') {
        missingFields.push({key: 'title', label: 'èŒä½å¤´è¡”', editUrl: '/ai-assistant?editType=candidate&editField=title'});
      }
      if (!profile?.summary || profile.summary.length < 20) {
        missingFields.push({key: 'summary', label: 'ä¸ªäººç®€ä»‹', editUrl: '/ai-assistant?editType=candidate&editField=summary'});
      }
      
      const candidateData = profile?.candidate_data || {};
      
      // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥å­—æ®µæ˜¯å¦æœ‰æœ‰æ•ˆå€¼
      const hasValue = (val: any) => {
        if (!val) return false;
        if (Array.isArray(val)) return val.length > 0;
        if (typeof val === 'string') return val.trim() !== '';
        return true;
      };
      
      if (!hasValue(candidateData.skills)) {
        missingFields.push({key: 'skills', label: 'æŠ€èƒ½ç‰¹é•¿', editUrl: '/ai-assistant?editType=candidate&editField=skills'});
      }
      if (!hasValue(candidateData.experience)) {
        missingFields.push({key: 'experience', label: 'å·¥ä½œç»å†', editUrl: '/ai-assistant?editType=candidate&editField=experience'});
      }
      if (!hasValue(candidateData.projects)) {
        missingFields.push({key: 'projects', label: 'é¡¹ç›®ç»å†', editUrl: '/ai-assistant?editType=candidate&editField=projects'});
      }
      if (!hasValue(candidateData.education)) {
        missingFields.push({key: 'education', label: 'æ•™è‚²èƒŒæ™¯', editUrl: '/ai-assistant?editType=candidate&editField=education'});
      }
      if (!hasValue(candidateData.expected_salary)) {
        missingFields.push({key: 'expected_salary', label: 'æœŸæœ›è–ªèµ„', editUrl: '/ai-assistant?editType=candidate&editField=expected_salary'});
      }
      if (!hasValue(candidateData.expected_location)) {
        missingFields.push({key: 'expected_location', label: 'æœŸæœ›å·¥ä½œåœ°ç‚¹', editUrl: '/ai-assistant?editType=candidate&editField=expected_location'});
      }
      
      return missingFields;
    } catch (error) {
      console.error('è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
      return [];
    }
  };

  // å¼€å§‹å®Œå–„ç®€å†å¼•å¯¼æµç¨‹
  const startProfileCompleteGuide = async (isTaskMode: boolean = false) => {
    console.log('[Profile Guide] Starting profile complete guide, isTaskMode:', isTaskMode);
    setIsTyping(true);
    
    try {
      const missingFields = await getProfileMissingFields();
      console.log('[Profile Guide] Missing fields:', missingFields);
    
    if (missingFields.length === 0) {
      const successMessage = {
        role: 'assistant' as const,
        content: `âœ¨ **æ‚¨çš„ç®€å†èµ„æ–™å·²ç»å¾ˆå®Œå–„äº†ï¼**\n\nå½“å‰ç®€å†å®Œå–„åº¦ï¼š100%\n\næ‚¨å¯ä»¥ï¼š\nâ€¢ å‰å¾€ [ä¸ªäººä¸»é¡µ](/candidate/profile) æŸ¥çœ‹å’Œå¾®è°ƒ\n\nå®Œæˆä¸ªäººè®¤è¯ä¿¡æ¯ï¼Œæé«˜æ±‚èŒæœºä¼šï¼š\n\n[[TASK:å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯:personal_verification:ğŸ”]]\n\nğŸ‰ ä»»åŠ¡å·²å®Œæˆï¼è¿˜æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`
      };
      
      if (isTaskMode && selectedTask) {
        setTaskMessages(prev => ({
          ...prev,
          [selectedTask.id]: [...(prev[selectedTask.id] || []), successMessage]
        }));
      } else {
        setGeneralMessages(prev => [...prev, successMessage]);
      }
      setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
    } else {
      const completenessPercent = Math.round(((9 - missingFields.length) / 9) * 100);
      const fieldsList = missingFields.map((f, i) => 
        `${i + 1}ï¸âƒ£ **${f.label}**`
      ).join('\n');
      
      const guideMessage = {
        role: 'assistant' as const,
        content: `ğŸ“ **å¼€å§‹å®Œå–„ç®€å†èµ„æ–™**\n\nå½“å‰ç®€å†å®Œå–„åº¦ï¼š**${completenessPercent}%**\n\néœ€è¦è¡¥å……ä»¥ä¸‹ä¿¡æ¯ï¼ˆå…± ${missingFields.length} é¡¹ï¼‰ï¼š\n\n${fieldsList}\n\n---\n\nğŸš€ **ç°åœ¨å¼€å§‹å¡«å†™ç¬¬ 1 é¡¹ï¼š${missingFields[0].label}**\n\n${getFieldPrompt(missingFields[0].key)}\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹ï¼Œè¾“å…¥ "é€€å‡º" å¯ä»¥ç»“æŸå¡«å†™æµç¨‹\nğŸ“ å¿«æ·æ–¹å¼ï¼šç‚¹å‡»å·¦ä¸‹è§’ä¸Šä¼ ç®€å†ï¼ŒAI è‡ªåŠ¨è§£æå¡«å……`
      };
      
      if (isTaskMode && selectedTask) {
        console.log('[Profile Guide] Adding guide message to task:', selectedTask.id);
        setTaskMessages(prev => {
          const newMessages = [...(prev[selectedTask.id] || []), guideMessage];
          console.log('[Profile Guide] Task messages count:', newMessages.length);
          return {
            ...prev,
            [selectedTask.id]: newMessages
          };
        });
      } else {
        console.log('[Profile Guide] Adding guide message to general messages');
        setGeneralMessages(prev => [...prev, guideMessage]);
      }
      
      // è®¾ç½®å®Œå–„ç®€å†æ¨¡å¼ï¼Œè‡ªåŠ¨ä»ç¬¬ä¸€é¡¹å¼€å§‹
      setProfileCompleteMode({
        active: true,
        missingFields,
        currentFieldIndex: 0
      });
      console.log('[Profile Guide] Profile mode set to active');
    }
    } catch (error) {
      console.error('[Profile Guide] Error in startProfileCompleteGuide:', error);
      // å‡ºé”™æ—¶ä¹Ÿè¦æ·»åŠ ä¸€æ¡æ¶ˆæ¯è®©ç”¨æˆ·çŸ¥é“
      const errorMessage = {
        role: 'assistant' as const,
        content: `âŒ æŠ±æ­‰ï¼Œè·å–ç®€å†ä¿¡æ¯æ—¶å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚\n\næ‚¨ä¹Ÿå¯ä»¥å‰å¾€ [ä¸ªäººèµ„æ–™é¡µ](/candidate/profile) æ‰‹åŠ¨ç¼–è¾‘ã€‚`
      };
      if (isTaskMode && selectedTask) {
        setTaskMessages(prev => ({
          ...prev,
          [selectedTask.id]: [...(prev[selectedTask.id] || []), errorMessage]
        }));
      } else {
        setGeneralMessages(prev => [...prev, errorMessage]);
      }
    } finally {
      setIsTyping(false);
    }
  };
  
  // è·å–å­—æ®µå¡«å†™æç¤º
  const getFieldPrompt = (fieldKey: string) => {
    const prompts: Record<string, string> = {
      'display_name': 'è¯·è¾“å…¥æ‚¨çš„çœŸå®å§“åï¼š',
      'title': 'è¯·è¾“å…¥æ‚¨çš„èŒä½å¤´è¡”ï¼ˆå¦‚ï¼šé«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆã€äº§å“ç»ç†ã€æ•°æ®åˆ†æå¸ˆï¼‰ï¼š',
      'summary': 'è¯·ç®€è¦ä»‹ç»æ‚¨è‡ªå·±ï¼ˆåŒ…æ‹¬å·¥ä½œç»éªŒã€ä¸“ä¸šé¢†åŸŸã€ä¸ªäººä¼˜åŠ¿ç­‰ï¼Œå»ºè®® 50-200 å­—ï¼‰ï¼š',
      'skills': 'è¯·åˆ—å‡ºæ‚¨çš„æ ¸å¿ƒæŠ€èƒ½ï¼ˆç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šReact, TypeScript, Node.js, Pythonï¼‰ï¼š',
      'experience': 'è¯·æè¿°æ‚¨æœ€è¿‘çš„å·¥ä½œç»å†ï¼š\nâ€¢ å…¬å¸åç§°\nâ€¢ èŒä½åç§°\nâ€¢ åœ¨èŒæ—¶é—´\nâ€¢ ä¸»è¦èŒè´£å’Œæˆå°±',
      'projects': 'è¯·æè¿°æ‚¨å‚ä¸è¿‡çš„é‡è¦é¡¹ç›®ï¼š\nâ€¢ é¡¹ç›®åç§°\nâ€¢ æ‚¨çš„è§’è‰²/èŒè´£\nâ€¢ é¡¹ç›®æˆæœ/äº®ç‚¹\nâ€¢ ä½¿ç”¨çš„æŠ€æœ¯',
      'education': 'è¯·å¡«å†™æ‚¨çš„æ•™è‚²èƒŒæ™¯ï¼š\nâ€¢ å­¦æ ¡åç§°\nâ€¢ ä¸“ä¸š\nâ€¢ å­¦å†ï¼ˆæœ¬ç§‘/ç¡•å£«/åšå£«ï¼‰\nâ€¢ æ¯•ä¸šæ—¶é—´',
      'expected_salary': 'è¯·è¾“å…¥æ‚¨çš„æœŸæœ›è–ªèµ„èŒƒå›´ï¼ˆå¦‚ï¼š3K-5Kã€5K-10Kã€10K-15Kã€15K-20Kã€20K-30Kã€30Kä»¥ä¸Šã€é¢è®®ï¼‰ï¼š',
      'expected_location': 'è¯·è¾“å…¥æ‚¨æœŸæœ›çš„å·¥ä½œåœ°ç‚¹ï¼ˆå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€æ·±åœ³ã€è¿œç¨‹å‡å¯ï¼‰ï¼š'
    };
    return prompts[fieldKey] || 'è¯·è¾“å…¥ç›¸å…³ä¿¡æ¯ï¼š';
  };
  
  // ===== å®Œå–„ä¼ä¸šèµ„æ–™ ç›¸å…³å‡½æ•° =====
  
  // ä¼ä¸šèµ„æ–™éœ€è¦å®Œå–„çš„æ‰€æœ‰å­—æ®µå®šä¹‰
  const enterpriseProfileFields = [
    { key: 'display_name', label: 'ä¼ä¸šå…¨ç§°', type: 'text' as const },
    { key: 'short_name', label: 'ä¼ä¸šç®€ç§°', type: 'text' as const },
    { key: 'industry', label: 'æ‰€å±è¡Œä¸š', type: 'select' as const, options: ['äº’è”ç½‘/IT', 'äººå·¥æ™ºèƒ½', 'é‡‘è/æŠ•èµ„', 'æ•™è‚²åŸ¹è®­', 'åŒ»ç–—å¥åº·', 'åˆ¶é€ ä¸š', 'å…¶ä»–'] },
    { key: 'company_size', label: 'ä¼ä¸šè§„æ¨¡', type: 'select' as const, options: ['0-20äºº', '20-99äºº', '100-499äºº', '500-999äºº', '1000äººä»¥ä¸Š'] },
    { key: 'funding_stage', label: 'èèµ„é˜¶æ®µ', type: 'select' as const, options: ['æœªèèµ„', 'å¤©ä½¿è½®', 'Aè½®', 'Bè½®', 'Cè½®åŠä»¥ä¸Š', 'å·²ä¸Šå¸‚', 'ä¸éœ€è¦èèµ„'] },
    { key: 'detail_address', label: 'å…¬å¸åœ°å€', type: 'text' as const },
    { key: 'contact_name', label: 'HRå§“å', type: 'text' as const },
    { key: 'hr_phone', label: 'è”ç³»ç”µè¯', type: 'text' as const },
    { key: 'description', label: 'ä¼ä¸šç®€ä»‹', type: 'textarea' as const },
    { key: 'benefits', label: 'ä¼ä¸šç¦åˆ©', type: 'select' as const, options: ['äº”é™©ä¸€é‡‘', 'å¹´ç»ˆå¥–', 'å¸¦è–ªå¹´å‡', 'å¼¹æ€§å·¥ä½œ', 'é¤è¡¥', 'äº¤é€šè¡¥è´´', 'å‘˜å·¥åŸ¹è®­', 'èŠ‚æ—¥ç¦åˆ©'] },
  ];
  
  // è·å–ä¼ä¸šèµ„æ–™ç¼ºå¤±å­—æ®µ
  const getEnterpriseMissingFields = async () => {
    try {
      const { getSettings } = await import('./services/apiService');
      const currentSettings = await getSettings(userId);
      
      const missingFields: {key: string; label: string; type: 'text' | 'select' | 'textarea'; options?: string[]}[] = [];
      
      const hasValue = (val: any) => {
        if (!val) return false;
        if (typeof val === 'string') {
          const trimmed = val.trim();
          if (trimmed === '' || trimmed === '[]' || trimmed === '{}') return false;
          // å¯¹äº benefitsï¼Œæ£€æŸ¥ JSON æ•°ç»„æ˜¯å¦ä¸ºç©º
          if (trimmed.startsWith('[')) {
            try { return JSON.parse(trimmed).length > 0; } catch { return false; }
          }
          return true;
        }
        return true;
      };
      
      for (const field of enterpriseProfileFields) {
        if (!hasValue(currentSettings[field.key])) {
          missingFields.push(field);
        }
      }
      
      return missingFields;
    } catch (error) {
      console.error('è·å–ä¼ä¸šèµ„æ–™å¤±è´¥:', error);
      return [];
    }
  };
  
  // è·å–ä¼ä¸šå­—æ®µå¡«å†™æç¤º
  const getEnterpriseFieldPrompt = (field: {key: string; label: string; type: string; options?: string[]}) => {
    if (field.type === 'select' && field.options) {
      if (field.key === 'benefits') {
        return `è¯·é€‰æ‹©ä¼ä¸šç¦åˆ©ï¼ˆå¯å¤šé€‰ï¼Œç”¨é€—å·åˆ†éš”ï¼‰ï¼š\n\n${field.options.map((o, i) => `${i + 1}. ${o}`).join('\n')}\n\nä¾‹å¦‚è¾“å…¥ï¼š1,3,4 æˆ– äº”é™©ä¸€é‡‘,å¸¦è–ªå¹´å‡,å¼¹æ€§å·¥ä½œ`;
      }
      return `è¯·é€‰æ‹©${field.label}ï¼š\n\n${field.options.map((o, i) => `${i + 1}. ${o}`).join('\n')}\n\nğŸ’¡ ç›´æ¥è¾“å…¥åºå·æˆ–é€‰é¡¹åç§°å³å¯`;
    }
    
    const prompts: Record<string, string> = {
      'display_name': 'è¯·è¾“å…¥ä¼ä¸šå…¨ç§°ï¼ˆä¸è¥ä¸šæ‰§ç…§ä¸€è‡´ï¼‰ï¼š',
      'short_name': 'è¯·è¾“å…¥ä¼ä¸šç®€ç§°ï¼ˆå¦‚ï¼šå­—èŠ‚ã€é˜¿é‡Œã€è…¾è®¯ï¼‰ï¼š',
      'detail_address': 'è¯·è¾“å…¥å…¬å¸åœ°å€ï¼ˆå¦‚ï¼šæµ™æ±Ÿçœæ­å·å¸‚è¥¿æ¹–åŒºæ–‡ä¸‰è·¯XXXå·ï¼‰ï¼š',
      'contact_name': 'è¯·è¾“å…¥HRè”ç³»äººå§“åï¼š',
      'hr_phone': 'è¯·è¾“å…¥è”ç³»ç”µè¯ï¼ˆæ‰‹æœºå·æˆ–åº§æœºï¼‰ï¼š',
      'description': 'è¯·è¾“å…¥ä¼ä¸šç®€ä»‹ï¼ˆä»‹ç»ä¼ä¸šä¸šåŠ¡ã€æ–‡åŒ–ã€æ„¿æ™¯ç­‰ï¼Œå»ºè®®50-300å­—ï¼‰ï¼š',
    };
    return prompts[field.key] || `è¯·è¾“å…¥${field.label}ï¼š`;
  };
  
  // è§£æç”¨æˆ·è¾“å…¥çš„é€‰æ‹©å€¼
  const parseEnterpriseSelectInput = (input: string, field: {key: string; options?: string[]}) => {
    if (!field.options) return input.trim();
    
    // ç¦åˆ©å­—æ®µæ”¯æŒå¤šé€‰
    if (field.key === 'benefits') {
      const results: string[] = [];
      const parts = input.split(/[,ï¼Œã€\s]+/).map(p => p.trim()).filter(Boolean);
      for (const part of parts) {
        const numMatch = part.match(/^(\d+)$/);
        if (numMatch) {
          const idx = parseInt(numMatch[1]) - 1;
          if (idx >= 0 && idx < field.options.length) {
            results.push(field.options[idx]);
          }
        } else {
          // ç›´æ¥åŒ¹é…é€‰é¡¹å
          const match = field.options.find(o => o.includes(part) || part.includes(o));
          if (match) results.push(match);
          else results.push(part); // å…è®¸è‡ªå®šä¹‰è¾“å…¥
        }
      }
      return JSON.stringify(results.length > 0 ? results : [input.trim()]);
    }
    
    // å•é€‰å­—æ®µ
    const numMatch = input.trim().match(/^(\d+)$/);
    if (numMatch) {
      const idx = parseInt(numMatch[1]) - 1;
      if (idx >= 0 && idx < field.options.length) {
        return field.options[idx];
      }
    }
    // ç›´æ¥åŒ¹é…é€‰é¡¹å
    const match = field.options.find(o => o === input.trim() || o.includes(input.trim()));
    return match || input.trim();
  };
  
  // è®¡ç®—ä¼ä¸šèµ„æ–™å®Œå–„è¿›åº¦
  const [enterpriseProfileProgress, setEnterpriseProfileProgress] = useState(0);
  
  const calculateEnterpriseProfileProgress = async () => {
    if (!userId || (userRole !== 'employer' && userRole !== 'recruiter')) return 0;
    
    try {
      const { getSettings } = await import('./services/apiService');
      const currentSettings = await getSettings(userId);
      
      const hasValue = (val: any) => {
        if (!val) return false;
        if (typeof val === 'string') {
          const trimmed = val.trim();
          if (trimmed === '' || trimmed === '[]' || trimmed === '{}') return false;
          if (trimmed.startsWith('[')) {
            try { return JSON.parse(trimmed).length > 0; } catch { return false; }
          }
          return true;
        }
        return true;
      };
      
      let completedFields = 0;
      const totalFields = enterpriseProfileFields.length;
      
      for (const field of enterpriseProfileFields) {
        if (hasValue(currentSettings[field.key])) completedFields++;
      }
      
      const progress = Math.round((completedFields / totalFields) * 100);
      setEnterpriseProfileProgress(progress);
      
      // è¿›åº¦è¾¾åˆ°100%ï¼Œè‡ªåŠ¨æ ‡è®°ä»»åŠ¡å®Œæˆ
      if (progress >= 100 && selectedTask) {
        const taskTitle = selectedTask.title || selectedTask.task || '';
        const taskType = selectedTask.todo_type || selectedTask.type || '';
        const isEnterpriseProfileTask = taskType === 'enterprise_profile' || 
          taskTitle === 'å®Œå–„ä¼ä¸šèµ„æ–™';
        
        if (isEnterpriseProfileTask && selectedTask.status !== 'completed') {
          try {
            const { updateTodo } = await import('./services/apiService');
            await updateTodo(selectedTask.id, { status: 'completed', progress: 100 });
            console.log('[Enterprise Profile Task] ä»»åŠ¡å·²è‡ªåŠ¨æ ‡è®°ä¸ºå®Œæˆ');
            if (typeof refetchTasks === 'function') refetchTasks();
          } catch (e) {
            console.error('æ›´æ–°ä¼ä¸šä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
          }
        }
      }
      
      return progress;
    } catch (error) {
      console.error('è®¡ç®—ä¼ä¸šèµ„æ–™è¿›åº¦å¤±è´¥:', error);
      return 0;
    }
  };
  
  // å¼€å§‹å®Œå–„ä¼ä¸šèµ„æ–™å¼•å¯¼æµç¨‹
  const startEnterpriseProfileGuide = async (isTaskMode: boolean = false) => {
    console.log('[Enterprise Profile Guide] Starting guide, isTaskMode:', isTaskMode);
    setIsTyping(true);
    
    try {
      const missingFields = await getEnterpriseMissingFields();
      console.log('[Enterprise Profile Guide] Missing fields:', missingFields.map(f => f.label));
      
      if (missingFields.length === 0) {
        const successMessage = {
          role: 'assistant' as const,
          content: `âœ… **ä¼ä¸šèµ„æ–™å·²å®Œå–„ï¼**\n\nå½“å‰å®Œå–„åº¦ï¼š100%\n\næ‚¨å¯ä»¥ï¼š\nâ€¢ å‰å¾€ [åŸºç¡€ä¿¡æ¯è®¾ç½®](/settings?tab=General) æŸ¥çœ‹æˆ–ä¿®æ”¹\nâ€¢ å‰å¾€ [ä¼ä¸šä¸»é¡µ](/employer/profile) æŸ¥çœ‹å±•ç¤ºæ•ˆæœ\n\nğŸ‰ ä»»åŠ¡å·²å®Œæˆï¼ç°åœ¨å¯ä»¥å¼€å§‹å‘å¸ƒèŒä½æ‹›è˜äººæ‰äº†ã€‚`
        };
        
        if (isTaskMode && selectedTask) {
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [...(prev[selectedTask.id] || []), successMessage]
          }));
          // æ ‡è®°ä»»åŠ¡å®Œæˆ
          const { updateTodo } = await import('./services/apiService');
          await updateTodo(selectedTask.id, { progress: 100, status: 'completed' });
          if (typeof refetchTasks === 'function') refetchTasks();
        } else {
          setGeneralMessages(prev => [...prev, successMessage]);
        }
        setEnterpriseProfileMode({ active: false, missingFields: [], currentFieldIndex: -1 });
      } else {
        const totalFields = enterpriseProfileFields.length;
        const filledCount = totalFields - missingFields.length;
        const completenessPercent = Math.round((filledCount / totalFields) * 100);
        const fieldsList = missingFields.map((f, i) => 
          `${i + 1}ï¸âƒ£ **${f.label}**`
        ).join('\n');
        
        const guideMessage = {
          role: 'assistant' as const,
          content: `ğŸ“‹ **å¼€å§‹å®Œå–„ä¼ä¸šèµ„æ–™**\n\nå®Œå–„ä¼ä¸šèµ„æ–™å¯ä»¥å¸®åŠ©æ‚¨ï¼š\nâœ… æå‡ä¼ä¸šä¸»é¡µå±•ç¤ºæ•ˆæœ\nâœ… å¢åŠ å€™é€‰äººæŠ•é€’æ„æ„¿\nâœ… æé«˜äººæ‰åŒ¹é…ç²¾å‡†åº¦\n\n---\n\nğŸ“Š å½“å‰å®Œå–„åº¦ï¼š**${completenessPercent}%**ï¼ˆ${filledCount}/${totalFields}ï¼‰\n\néœ€è¦è¡¥å……ä»¥ä¸‹ä¿¡æ¯ï¼ˆå…± ${missingFields.length} é¡¹ï¼‰ï¼š\n\n${fieldsList}\n\n---\n\nğŸš€ **ç°åœ¨å¼€å§‹å¡«å†™ç¬¬ 1 é¡¹ï¼š${missingFields[0].label}**\n\n${getEnterpriseFieldPrompt(missingFields[0])}\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹ï¼Œè¾“å…¥ "é€€å‡º" å¯ä»¥ç»“æŸå¡«å†™æµç¨‹`
        };
        
        if (isTaskMode && selectedTask) {
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [...(prev[selectedTask.id] || []), guideMessage]
          }));
        } else {
          setGeneralMessages(prev => [...prev, guideMessage]);
        }
        
        setEnterpriseProfileMode({
          active: true,
          missingFields,
          currentFieldIndex: 0
        });
      }
    } catch (error) {
      console.error('[Enterprise Profile Guide] Error:', error);
      const errorMessage = {
        role: 'assistant' as const,
        content: `âŒ æŠ±æ­‰ï¼Œè·å–ä¼ä¸šèµ„æ–™æ—¶å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚\n\næ‚¨ä¹Ÿå¯ä»¥å‰å¾€ [åŸºç¡€ä¿¡æ¯è®¾ç½®](/settings?tab=General) æ‰‹åŠ¨ç¼–è¾‘ã€‚`
      };
      if (isTaskMode && selectedTask) {
        setTaskMessages(prev => ({
          ...prev,
          [selectedTask.id]: [...(prev[selectedTask.id] || []), errorMessage]
        }));
      } else {
        setGeneralMessages(prev => [...prev, errorMessage]);
      }
    } finally {
      setIsTyping(false);
    }
  };
  
  // è¡¥å¿æ£€æŸ¥ï¼šèº«ä»½è¯è®¤è¯å·²å®Œæˆä½† DISC ä»»åŠ¡æœªåˆ›å»ºæ—¶ï¼Œè‡ªåŠ¨è¡¥åˆ›å»º
  const [discTaskChecked, setDiscTaskChecked] = useState(false);
  useEffect(() => {
    if (!userId || userRole !== 'candidate' || discTaskChecked || tasksLoading) return;
    const checkDiscTask = async () => {
      try {
        const { getTasks, createTodo, getPersonalCertifications } = await import('./services/apiService');
        const allTasks = await getTasks(userId);
        
        // å·²æœ‰ DISC ä»»åŠ¡åˆ™æ— éœ€å¤„ç†
        const hasDiscTask = allTasks.some((t: any) => t.title === 'DISCæ€§æ ¼æµ‹è¯•');
        if (hasDiscTask) {
          setDiscTaskChecked(true);
          return;
        }
        
        // æ£€æŸ¥èº«ä»½è¯è®¤è¯æ˜¯å¦å·²å®Œæˆ
        const certs = await getPersonalCertifications(userId);
        const hasIdentity = certs.some((c: any) => c.category === 'identity');
        
        console.log('[DISCè¡¥å¿æ£€æŸ¥] hasIdentity:', hasIdentity, 'hasDiscTask:', hasDiscTask);
        
        if (hasIdentity && !hasDiscTask) {
          await createTodo({
            title: 'DISCæ€§æ ¼æµ‹è¯•',
            description: 'é€šè¿‡DISCæµ‹è¯•äº†è§£æ‚¨çš„è¡Œä¸ºé£æ ¼ï¼Œæå‡æ±‚èŒåŒ¹é…åº¦',
            priority: 'MEDIUM',
            status: 'PENDING',
            progress: 0,
            source: 'AGENT',
            todo_type: 'CANDIDATE',
            icon: 'UserIcon',
          }, userId);
          console.log('[DISC Task] è¡¥å¿åˆ›å»ºï¼šèº«ä»½è®¤è¯å·²å®Œæˆï¼Œå·²è¡¥åˆ›å»ºDISCæ€§æ ¼æµ‹è¯•ä»»åŠ¡, userId:', userId);
          if (typeof refetchTasks === 'function') {
            refetchTasks();
          }
        }
        setDiscTaskChecked(true);
      } catch (err) {
        console.error('[DISC Task] è¡¥å¿æ£€æŸ¥å¤±è´¥:', err);
        setDiscTaskChecked(true);
      }
    };
    checkDiscTask();
  }, [userId, userRole, discTaskChecked, tasksLoading]);

  // è®¡ç®—ã€Œå®Œå–„ç®€å†èµ„æ–™ã€ä»»åŠ¡çš„åŠ¨æ€è¿›åº¦
  const [profileTaskProgress, setProfileTaskProgress] = useState(0);
  
  const calculateProfileTaskProgress = async () => {
    if (!userId || userRole !== 'candidate') return 0;
    
    try {
      const { getUserProfile } = await import('./services/apiService');
      const profile = await getUserProfile(userId, 'candidate');
      
      let completedFields = 0;
      const totalFields = 9;  // å¢åŠ äº† projects å­—æ®µ
      
      // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥å­—æ®µæ˜¯å¦æœ‰æœ‰æ•ˆå€¼
      const hasValue = (val: any) => {
        if (!val) return false;
        if (Array.isArray(val)) return val.length > 0;
        if (typeof val === 'string') return val.trim() !== '';
        return true;
      };
      
      // æ£€æŸ¥æ¯ä¸ªå­—æ®µ
      if (hasValue(profile?.display_name)) completedFields++;
      if (hasValue(profile?.title)) completedFields++;
      if (profile?.summary && profile.summary.trim() !== '' && profile.summary.length >= 20) completedFields++;
      
      const candidateData = profile?.candidate_data || {};
      if (hasValue(candidateData.skills)) completedFields++;
      if (hasValue(candidateData.experience)) completedFields++;
      if (hasValue(candidateData.projects)) completedFields++;
      if (hasValue(candidateData.education)) completedFields++;
      if (hasValue(candidateData.expected_salary)) completedFields++;
      if (hasValue(candidateData.expected_location)) completedFields++;
      
      const progress = Math.round((completedFields / totalFields) * 100);
      setProfileTaskProgress(progress);
      
      // å½“è¿›åº¦è¾¾åˆ°100%æ—¶ï¼Œè‡ªåŠ¨å°†ä»»åŠ¡æ ‡è®°ä¸ºå·²å®Œæˆï¼Œå¹¶åˆ›å»º"å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯"ä»»åŠ¡
      if (progress >= 100 && selectedTask) {
        const taskTitle = selectedTask.title || selectedTask.task || '';
        const taskType = selectedTask.todo_type || selectedTask.type || '';
        const isProfileTask = taskType === 'profile_complete' || 
          taskTitle === 'å®Œå–„ç®€å†èµ„æ–™';
        
        if (isProfileTask && selectedTask.status !== 'completed') {
          try {
            const { updateTodo, createTodo, getTasks } = await import('./services/apiService');
            await updateTodo(selectedTask.id, { status: 'completed', progress: 100 });
            console.log('[Profile Task] ä»»åŠ¡å·²è‡ªåŠ¨æ ‡è®°ä¸ºå®Œæˆ');
            
            // æ£€æŸ¥å¹¶åˆ›å»º"å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯"ä»»åŠ¡
            if (userId) {
              const existingTasks = await getTasks(userId);
              const hasVerificationTask = existingTasks.some((t: any) => 
                t.todo_type === 'personal_verification' || 
                t.title === 'å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯' ||
                (t.title.includes('å®Œå–„') && t.title.includes('è®¤è¯'))
              );
              
              if (!hasVerificationTask) {
                // åˆ›å»º"å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯"ä»»åŠ¡
                const verificationTaskData = {
                  title: 'å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯',
                  description: 'å®Œæˆèº«ä»½è®¤è¯ã€å­¦å†è®¤è¯ã€æŠ€èƒ½è®¤è¯ã€å·¥ä½œè¯æ˜ç­‰ï¼Œæå‡æ±‚èŒç«äº‰åŠ›ï¼Œå¢åŠ é¢è¯•æœºä¼š',
                  priority: 'high',
                  source: 'agent',
                  todo_type: 'personal_verification',
                  ai_advice: 'å®Œæˆä¸ªäººè®¤è¯å¯ä»¥å¤§å¹…æå‡æ‚¨çš„å¯ä¿¡åº¦å’Œæ±‚èŒæˆåŠŸç‡ã€‚å»ºè®®ä¼˜å…ˆå®Œæˆèº«ä»½è®¤è¯å’Œå­¦å†è®¤è¯ã€‚',
                  steps: [
                    { order: 1, title: 'å®Œæˆèº«ä»½è®¤è¯', status: 'pending' },
                    { order: 2, title: 'å®Œæˆå­¦å†è®¤è¯', status: 'pending' },
                    { order: 3, title: 'å®ŒæˆæŠ€èƒ½è®¤è¯', status: 'pending' },
                    { order: 4, title: 'å®Œæˆå·¥ä½œè¯æ˜', status: 'pending' },
                    { order: 5, title: 'å®Œæˆå¾ä¿¡è®¤è¯', status: 'pending' }
                  ]
                };
                
                await createTodo(verificationTaskData, userId);
                console.log('[Verification Task] ç®€å†100%å®Œæˆï¼Œå·²è‡ªåŠ¨åˆ›å»ºä¸ªäººè®¤è¯ä»»åŠ¡');
              }
            }
            
            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
            if (typeof refetchTasks === 'function') {
              refetchTasks();
            }
            
          } catch (err) {
            console.error('è‡ªåŠ¨å®Œæˆä»»åŠ¡å¤±è´¥:', err);
          }
        }
      }
      
      return progress;
    } catch (error) {
      console.error('è®¡ç®—ä»»åŠ¡è¿›åº¦å¤±è´¥:', error);
      return 0;
    }
  };
  
  // å½“é€‰ä¸­ä»»åŠ¡å˜åŒ–æ—¶ï¼Œè®¡ç®—è¿›åº¦
  useEffect(() => {
    if (selectedTask) {
      // æŒ‰éœ€ä»åç«¯åŠ è½½è¯¥ä»»åŠ¡çš„å¯¹è¯å†å²
      const tid = parseInt(selectedTask.id);
      if (!isNaN(tid)) loadTaskMessages(tid);
      
      const taskTitle = selectedTask.title || selectedTask.task || '';
      const taskType = selectedTask.todo_type || selectedTask.type || '';
      const isProfileTask = taskType === 'profile_complete' || 
        taskTitle === 'å®Œå–„ç®€å†èµ„æ–™' ||
        (taskTitle.includes('å®Œå–„') && (taskTitle.includes('ç®€å†') || taskTitle.includes('èµ„æ–™')) && !taskTitle.includes('ä¼ä¸š'));
      
      if (isProfileTask) {
        calculateProfileTaskProgress();
      }
      
      const isEnterpriseProfileTask = taskType === 'enterprise_profile' || 
        taskTitle === 'å®Œå–„ä¼ä¸šèµ„æ–™';
      
      if (isEnterpriseProfileTask) {
        calculateEnterpriseProfileProgress();
      }
    }
  }, [selectedTask, userId, userRole]);
  
  // è·å–ä»»åŠ¡æ˜¾ç¤ºè¿›åº¦ï¼ˆå¯¹äºå®Œå–„ç®€å†ä»»åŠ¡å’Œè®¤è¯ä»»åŠ¡ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„è¿›åº¦ï¼‰
  const getTaskDisplayProgress = () => {
    if (!selectedTask) return 0;
    
    const taskTitle = selectedTask.title || selectedTask.task || '';
    const taskType = selectedTask.todo_type || selectedTask.type || '';
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å®Œå–„ç®€å†ä»»åŠ¡
    const isProfileTask = taskType === 'profile_complete' || 
      taskTitle === 'å®Œå–„ç®€å†èµ„æ–™' ||
      (taskTitle.includes('å®Œå–„') && (taskTitle.includes('ç®€å†') || taskTitle.includes('èµ„æ–™')) && !taskTitle.includes('ä¼ä¸š'));
    
    if (isProfileTask) {
      return profileTaskProgress;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å®Œå–„ä¼ä¸šèµ„æ–™ä»»åŠ¡
    const isEnterpriseProfileTask = taskType === 'enterprise_profile' || 
      taskTitle === 'å®Œå–„ä¼ä¸šèµ„æ–™';
    
    if (isEnterpriseProfileTask) {
      return enterpriseProfileProgress;
    }
    
    // ä»æœ€æ–°çš„ tasks æ•°æ®ä¸­è·å–è¿›åº¦ï¼ˆç¡®ä¿è·å–æœ€æ–°æ•°æ®ï¼‰
    const latestTask = tasks.find((t: any) => t.id === selectedTask.id);
    const currentProgress = latestTask?.progress ?? selectedTask.progress ?? 0;
    const currentStatus = (latestTask?.status || selectedTask.status || '').toLowerCase();
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯DISCæµ‹è¯•ä»»åŠ¡
    const isDiscTask = taskTitle === 'DISCæ€§æ ¼æµ‹è¯•';
    if (isDiscTask) {
      // å¦‚æœæµ‹è¯•å·²å®Œæˆï¼Œæ˜¾ç¤º100%
      if (discTestMode.completed || currentStatus === 'completed' || currentProgress >= 100) {
        return 100;
      }
      // æ ¹æ®å½“å‰é¢˜ç›®è®¡ç®—è¿›åº¦
      if (discTestMode.active && discTestMode.currentQuestion > 0) {
        return Math.round((discTestMode.currentQuestion / discQuestions.length) * 100);
      }
      return currentProgress;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯äº‘ç«¯æ±‚èŒè½®å·¡ä»»åŠ¡
    const isCloudJobTask = taskTitle?.includes('äº‘ç«¯æ±‚èŒè½®å·¡');
    if (isCloudJobTask) {
      // è¿è¡Œä¸­çš„ä»»åŠ¡æ ¹æ®å®é™…çŠ¶æ€æ˜¾ç¤ºè¿›åº¦
      if (currentStatus === 'completed' || currentProgress >= 100) {
        return 100;
      }
      if (currentStatus === 'running') {
        // è¿è¡Œä¸­ï¼Œæ˜¾ç¤ºå®é™…è¿›åº¦æˆ–æœ€å°10%
        return Math.max(currentProgress, 10);
      }
      // åå¥½æ”¶é›†é˜¶æ®µ
      if (jobSearchMode.active && jobSearchMode.currentQuestion > 0) {
        const questionProgress = Math.round((jobSearchMode.currentQuestion / jobSearchQuestions.length) * 50);
        return jobSearchMode.isSearching ? 75 : questionProgress;
      }
      return currentProgress;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ™ºèƒ½æ±‚èŒåŠ©æ‰‹ä»»åŠ¡ï¼ˆæ—§ç‰ˆæœ¬å…¼å®¹ï¼‰
    const isJobSearchTask = taskTitle === 'æ™ºèƒ½æ±‚èŒåŠ©æ‰‹';
    if (isJobSearchTask) {
      // å¦‚æœå·²å®Œæˆï¼Œæ˜¾ç¤º100%
      if (jobSearchMode.completed && !jobSearchMode.isSearching || currentStatus === 'completed' || currentProgress >= 100) {
        return 100;
      }
      // æ ¹æ®å½“å‰é—®é¢˜è®¡ç®—è¿›åº¦ï¼ˆåå¥½æ”¶é›†å 50%ï¼ŒåŒ¹é…å 50%ï¼‰
      if (jobSearchMode.active && jobSearchMode.currentQuestion > 0) {
        const questionProgress = Math.round((jobSearchMode.currentQuestion / jobSearchQuestions.length) * 50);
        return jobSearchMode.isSearching ? 75 : questionProgress;
      }
      return currentProgress;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ™ºèƒ½æ‹›è˜ä»»åŠ¡
    const isRecruitTask = taskType?.toUpperCase() === 'RECRUIT' || taskTitle?.includes('æ™ºèƒ½æ‹›è˜');
    if (isRecruitTask) {
      if (currentStatus === 'completed' || currentProgress >= 100) return 100;
      // æ ¹æ® postMode.step åŠ¨æ€è®¡ç®—è¿›åº¦
      if (postMode.active) {
        const stepProgress: Record<string, number> = {
          'requirement': 5,
          'generate': 15,
          'optimize': 25,
          'invite': 45,
          'screen': 75,
          'complete': 100,
        };
        return stepProgress[postMode.step] || currentProgress;
      }
      return currentProgress;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯ä»»åŠ¡
    const isVerificationTask = taskType === 'personal_verification' || 
      taskTitle === 'å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯' ||
      (taskTitle.includes('å®Œå–„') && taskTitle.includes('è®¤è¯'));
    
    if (isVerificationTask) {
      // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²å®Œæˆï¼ˆä¼˜å…ˆä½¿ç”¨æœ€æ–°æ•°æ®ï¼‰
      if (currentStatus === 'completed' || currentProgress >= 100) {
        return 100;
      }
      
      if (verificationMode.active) {
        // ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„è®¤è¯è¿›åº¦
        const totalItems = verificationItems.length;
        const completedCount = verificationMode.completedItems.length;
        return Math.round((completedCount / totalItems) * 100);
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ä¼ä¸šè®¤è¯ä»»åŠ¡ï¼ˆä¸ä½¿ç”¨ EMPLOYER åŒ¹é…ï¼Œé¿å…å’Œ"å®Œå–„ä¼ä¸šèµ„æ–™"å†²çªï¼‰
    const isEnterpriseVerificationTask = taskType === 'enterprise_verification' || 
      taskTitle === 'å®Œæˆä¼ä¸šè®¤è¯' ||
      (taskTitle.includes('ä¼ä¸š') && taskTitle.includes('è®¤è¯') && !taskTitle.includes('èµ„æ–™'));
    
    if (isEnterpriseVerificationTask) {
      // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²å®Œæˆ
      if (currentStatus === 'completed' || currentProgress >= 100) {
        return 100;
      }
      
      if (enterpriseVerificationMode.active) {
        // ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„è®¤è¯è¿›åº¦
        const totalItems = enterpriseVerificationItems.length;
        const completedCount = enterpriseVerificationMode.completedItems.length;
        return Math.round((completedCount / totalItems) * 100);
      }
    }
    
    return currentProgress;
  };

  // è·å–æ™ºèƒ½æ‹›è˜å½“å‰é˜¶æ®µæ˜¾ç¤ºä¿¡æ¯
  const getRecruitStepInfo = () => {
    const steps = [
      { key: 'requirement', label: 'æè¿°éœ€æ±‚', icon: <PenTool size={10} />, short: 'éœ€æ±‚' },
      { key: 'generate',    label: 'AIç”Ÿæˆå²—ä½', icon: <Sparkles size={10} />, short: 'ç”Ÿæˆ' },
      { key: 'optimize',    label: 'ç¡®è®¤å‘å¸ƒ', icon: <Rocket size={10} />, short: 'å‘å¸ƒ' },
      { key: 'invite',      label: 'æ™ºèƒ½é‚€è¯·', icon: <Send size={10} />, short: 'é‚€è¯·' },
      { key: 'screen',      label: 'æ™ºèƒ½ç­›é€‰', icon: <Search size={10} />, short: 'ç­›é€‰' },
    ];
    // complete è¡¨ç¤ºå…¨éƒ¨å®Œæˆï¼ŒcurrentIdx è®¾ä¸º steps.length ä½¿æ‰€æœ‰æ­¥éª¤æ˜¾ç¤ºä¸ºå·²å®Œæˆ
    if (postMode.step === 'complete') {
      return { steps, currentIdx: steps.length };
    }
    const currentIdx = steps.findIndex(s => s.key === postMode.step);
    return { steps, currentIdx: currentIdx >= 0 ? currentIdx : 0 };
  };
  
  // è®°å½•ä¸Šæ¬¡é€‰ä¸­çš„ä»»åŠ¡IDï¼Œç”¨äºæ£€æµ‹ä»»åŠ¡åˆ‡æ¢
  const lastSelectedTaskIdRef = useRef<number | null>(null);
  
  // åˆå§‹åŒ–ä»»åŠ¡ä¸“å±æ¶ˆæ¯
  useEffect(() => {
    if (!selectedTask) {
      lastSelectedTaskIdRef.current = null;
      // åˆ‡æ¢åˆ°é€šç”¨å¯¹è¯æ—¶ï¼Œé‡ç½®è®¤è¯æ¨¡å¼å’Œç®€å†å®Œå–„æ¨¡å¼
      setVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
      setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
      return;
    }
    
    const taskTitle = selectedTask.title || selectedTask.task || '';
    const taskAdvice = selectedTask.aiAdvice || selectedTask.ai_advice || '';
    const taskType = selectedTask.todo_type || selectedTask.type || '';
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å®Œå–„ç®€å†èµ„æ–™ä»»åŠ¡ï¼ˆæ’é™¤ä¼ä¸šèµ„æ–™ï¼‰
    const isProfileCompleteTask = taskType === 'profile_complete' || 
      taskTitle === 'å®Œå–„ç®€å†èµ„æ–™';
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å®Œå–„ä¼ä¸šèµ„æ–™ä»»åŠ¡
    const isEnterpriseProfileTask = taskType === 'enterprise_profile' || 
      taskTitle === 'å®Œå–„ä¼ä¸šèµ„æ–™';
    
    // æ£€æµ‹æ˜¯å¦æ˜¯æ–°é€‰ä¸­çš„ä»»åŠ¡ï¼ˆä»»åŠ¡åˆ‡æ¢ï¼‰
    const isNewSelection = lastSelectedTaskIdRef.current !== selectedTask.id;
    lastSelectedTaskIdRef.current = selectedTask.id;
    
    if (isProfileCompleteTask && userRole === 'candidate') {
      // å¯¹äºå®Œå–„ç®€å†ä»»åŠ¡ï¼Œæ¯æ¬¡é€‰ä¸­æ—¶éƒ½é‡æ–°åˆå§‹åŒ–å¹¶å¯åŠ¨å¼•å¯¼
      if (isNewSelection || !profileCompleteMode.active) {
        console.log('[useEffect] Initializing profile task, taskId:', selectedTask.id);
        // é‡ç½®å¼•å¯¼æ¨¡å¼çŠ¶æ€
        setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
        // é‡ç½®è®¤è¯æ¨¡å¼ï¼ˆåˆ‡æ¢åˆ°ç®€å†ä»»åŠ¡æ—¶ï¼‰
        setVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
        
        // åˆå§‹åŒ–ä»»åŠ¡æ¶ˆæ¯ - ç›´æ¥å¯åŠ¨å¼•å¯¼ï¼Œä¸å†è®¾ç½®ç­‰å¾…æ¶ˆæ¯
        setTaskMessages(prev => ({
          ...prev,
          [selectedTask.id]: []  // æ¸…ç©ºï¼Œè®©å¼•å¯¼æ¶ˆæ¯æˆä¸ºç¬¬ä¸€æ¡
        }));
        
        // ç«‹å³å¯åŠ¨å¼•å¯¼æµç¨‹ï¼ˆä¸å†å»¶è¿Ÿï¼‰
        console.log('[useEffect] Starting profile guide immediately');
        startProfileCompleteGuide(true);
      }
    } else if (taskType === 'personal_verification' || taskTitle === 'å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯' || (taskTitle.includes('å®Œå–„') && taskTitle.includes('è®¤è¯'))) {
      // å¯¹äºè®¤è¯ä»»åŠ¡ï¼Œå¯åŠ¨è®¤è¯å¼•å¯¼æµç¨‹
      // å¼‚æ­¥åŠ è½½å·²å®Œæˆçš„è®¤è¯æ•°æ®
      const initVerificationTask = async () => {
        try {
          const { getPersonalCertifications } = await import('./services/apiService');
          const certifications = await getPersonalCertifications(userId);
          
          // æ ¹æ®å·²æœ‰è®¤è¯ç¡®å®šå·²å®Œæˆçš„é¡¹ç›®
          const completedKeys: string[] = [];
          const certCategories = new Set(certifications.map((c: any) => c.category));
          
          // ä»èº«ä»½è®¤è¯ä¸­æå–å§“åï¼ˆç”¨äºåç»­è¯ä»¶çš„å§“åéªŒè¯ï¼‰
          let identityNameFromDB = '';
          const identityCerts = certifications.filter((c: any) => c.category === 'identity');
          if (identityCerts.length > 0) {
            // ä» "å®åè®¤è¯ - å§“å" æ ¼å¼ä¸­æå–å§“å
            const identityCert = identityCerts[0];
            if (identityCert.name && identityCert.name.includes(' - ')) {
              identityNameFromDB = identityCert.name.split(' - ')[1] || '';
            } else if (identityCert.name) {
              identityNameFromDB = identityCert.name;
            }
            console.log('[Verification] Extracted identity name from DB:', identityNameFromDB);
          }
          
          // æ£€æŸ¥èº«ä»½è®¤è¯æ˜¯å¦å®Œæˆï¼ˆéœ€è¦æ­£åé¢éƒ½å®Œæˆï¼Œæˆ–è€…æœ‰ identity ç±»åˆ«çš„è®¤è¯ï¼‰
          if (certCategories.has('identity')) {
            completedKeys.push('identity_front', 'identity_back');
          }
          // æ£€æŸ¥å­¦å†è®¤è¯
          if (certCategories.has('education')) {
            completedKeys.push('education');
          }
          // æ£€æŸ¥æŠ€èƒ½è®¤è¯ï¼ˆé©¾é©¶è¯ã€èŒä¸šè¯ä¹¦ï¼‰- éœ€è¦åˆ†åˆ«æ£€æŸ¥
          const skillCerts = certifications.filter((c: any) => c.category === 'skill');
          for (const cert of skillCerts) {
            if (cert.name === 'é©¾é©¶è¯') {
              completedKeys.push('skill_driver');
            } else {
              completedKeys.push('skill_cert');
            }
          }
          // æ£€æŸ¥å·¥ä½œè¯æ˜
          if (certCategories.has('work')) {
            completedKeys.push('work');
          }
          // æ£€æŸ¥å¾ä¿¡è®¤è¯ï¼ˆå…¬ç§¯é‡‘è¯æ˜ã€ç¤¾ä¿è¯æ˜ï¼‰- éœ€è¦åˆ†åˆ«æ£€æŸ¥
          const creditCertsData = certifications.filter((c: any) => c.category === 'credit');
          for (const cert of creditCertsData) {
            if (cert.name === 'å…¬ç§¯é‡‘è¯æ˜') {
              completedKeys.push('credit_fund');
            } else if (cert.name === 'ç¤¾ä¿è¯æ˜') {
              completedKeys.push('credit_social');
            }
          }
          
          // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„è®¤è¯é¡¹
          let startIndex = 0;
          for (let i = 0; i < verificationItems.length; i++) {
            if (!completedKeys.includes(verificationItems[i].key)) {
              startIndex = i;
              break;
            }
            // å¦‚æœæ‰€æœ‰é¡¹éƒ½å·²å®Œæˆ
            if (i === verificationItems.length - 1) {
              startIndex = verificationItems.length; // è¡¨ç¤ºå…¨éƒ¨å®Œæˆ
            }
          }
          
          const totalSteps = verificationItems.length;
          const completedCount = completedKeys.length;
          
          console.log('[useEffect] Initializing verification task, completed:', completedKeys, 'startIndex:', startIndex);
          
          // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²ç»å®Œæˆï¼ˆç”¨æˆ·ä¹‹å‰å·²å®Œæˆæµç¨‹ï¼‰
          const isTaskAlreadyCompleted = selectedTask.status?.toLowerCase() === 'completed' || selectedTask.progress >= 100;
          
          // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
          if (startIndex >= totalSteps || isTaskAlreadyCompleted) {
            // æ‰€æœ‰è®¤è¯éƒ½å·²å®Œæˆ æˆ– ä»»åŠ¡å·²æ ‡è®°å®Œæˆ
            setVerificationMode({
              active: false,
              items: verificationItems,
              currentIndex: -1,
              completedItems: completedKeys,
              identityName: identityNameFromDB
            });
            
            const completeMessage = `ğŸ‰ **æ­å–œï¼æ‚¨å·²å®Œæˆå…¨éƒ¨è®¤è¯ï¼**\n\nâœ… å·²å®Œæˆï¼š${completedCount}/${totalSteps} é¡¹\n\næ‚¨çš„æ‰€æœ‰è®¤è¯ä¿¡æ¯å·²ä¿å­˜ï¼Œè¿™å°†å¤§å¹…æå‡æ‚¨çš„æ±‚èŒç«äº‰åŠ›ï¼\n\nğŸ‘‰ å‰å¾€ [è®¾ç½® - ä¸ªäººè®¤è¯ä¿¡æ¯](/settings?tab=PersonalVerification) æŸ¥çœ‹è¯¦æƒ…\n\nè¿˜æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`;
            
            setTaskMessages(prev => ({
              ...prev,
              [selectedTask.id]: [{ role: 'assistant', content: completeMessage }]
            }));
            
            // ç¡®ä¿ä»»åŠ¡çŠ¶æ€ä¸ºå®Œæˆ
            if (!isTaskAlreadyCompleted) {
              const { updateTodo } = await import('./services/apiService');
              await updateTodo(selectedTask.id, { progress: 100, status: 'completed' });
              if (typeof refetchTasks === 'function') {
                refetchTasks();
              }
            }
            return; // ç›´æ¥è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­ä»£ç 
          } else {
            // è¿˜æœ‰æœªå®Œæˆçš„è®¤è¯é¡¹
            setVerificationMode({
              active: true,
              items: verificationItems,
              currentIndex: startIndex,
              completedItems: completedKeys,
              identityName: identityNameFromDB
            });
            
            const currentItem = verificationItems[startIndex];
            let welcomeMessage = `ğŸ‘‹ **æ¬¢è¿æ¥åˆ°ä¸ªäººè®¤è¯ä¸­å¿ƒï¼**\n\n`;
            
            if (completedCount > 0) {
              welcomeMessage += `ğŸ“Š **æ‚¨å·²å®Œæˆ ${completedCount}/${totalSteps} é¡¹è®¤è¯**\n\n`;
              welcomeMessage += `å·²å®Œæˆçš„è®¤è¯ï¼š\n`;
              if (completedKeys.includes('identity_front')) welcomeMessage += `âœ… èº«ä»½è®¤è¯\n`;
              if (completedKeys.includes('education')) welcomeMessage += `âœ… å­¦å†è®¤è¯\n`;
              if (completedKeys.includes('skill_driver') || completedKeys.includes('skill_cert')) welcomeMessage += `âœ… æŠ€èƒ½è®¤è¯\n`;
              if (completedKeys.includes('work')) welcomeMessage += `âœ… å·¥ä½œè¯æ˜\n`;
              if (completedKeys.includes('credit_fund') || completedKeys.includes('credit_social')) welcomeMessage += `âœ… å¾ä¿¡è®¤è¯\n`;
              welcomeMessage += `\n---\n\n`;
              welcomeMessage += `ğŸ“‹ **ç»§ç»­å®Œæˆå‰©ä½™è®¤è¯ï¼š**\n\n`;
            } else {
              welcomeMessage += `å®Œæˆè®¤è¯å¯ä»¥å¸®åŠ©æ‚¨ï¼š\nâœ… æé«˜ç®€å†å¯ä¿¡åº¦ï¼Œå¢åŠ  HR ä¿¡ä»»\nâœ… è·å¾—"å·²è®¤è¯"ä¸“å±æ ‡è¯†\nâœ… ä¼˜å…ˆå±•ç¤ºåœ¨æ¨èåˆ—è¡¨ä¸­\nâœ… å¢åŠ  30% ä»¥ä¸Šçš„é¢è¯•é‚€è¯·æœºä¼š\n\n---\n\nğŸ“‹ **è®¤è¯è¿›åº¦ï¼š** ${completedCount}/${totalSteps} é¡¹\n\n`;
            }
            
            welcomeMessage += `${currentItem.icon} **ç¬¬ ${startIndex + 1} é¡¹ï¼š${currentItem.label}**\n\n${currentItem.description}`;
            
            setTaskMessages(prev => ({
              ...prev,
              [selectedTask.id]: [{ role: 'assistant', content: welcomeMessage }]
            }));
          }
          
          // æ›´æ–°ä»»åŠ¡è¿›åº¦
          const { updateTodo } = await import('./services/apiService');
          const progress = Math.round((completedCount / totalSteps) * 100);
          await updateTodo(selectedTask.id, { progress, status: progress >= 100 ? 'completed' : 'in_progress' });
          
          // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
          if (typeof refetchTasks === 'function') {
            refetchTasks();
          }
        } catch (error) {
          console.error('åˆå§‹åŒ–è®¤è¯ä»»åŠ¡å¤±è´¥:', error);
          // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œä½¿ç”¨é»˜è®¤åˆå§‹åŒ–
          setVerificationMode({
            active: true,
            items: verificationItems,
            currentIndex: 0,
            completedItems: []
          });
          
          const firstItem = verificationItems[0];
          const totalSteps = verificationItems.length;
          const welcomeMessage = `ğŸ‘‹ **æ¬¢è¿æ¥åˆ°ä¸ªäººè®¤è¯ä¸­å¿ƒï¼**\n\nå®Œæˆè®¤è¯å¯ä»¥å¸®åŠ©æ‚¨ï¼š\nâœ… æé«˜ç®€å†å¯ä¿¡åº¦ï¼Œå¢åŠ  HR ä¿¡ä»»\nâœ… è·å¾—"å·²è®¤è¯"ä¸“å±æ ‡è¯†\nâœ… ä¼˜å…ˆå±•ç¤ºåœ¨æ¨èåˆ—è¡¨ä¸­\nâœ… å¢åŠ  30% ä»¥ä¸Šçš„é¢è¯•é‚€è¯·æœºä¼š\n\n---\n\nğŸ“‹ **è®¤è¯è¿›åº¦ï¼š** 0/${totalSteps} é¡¹\n\n${firstItem.icon} **ç¬¬ 1 é¡¹ï¼š${firstItem.label}**\n\n${firstItem.description}`;
          
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [{ role: 'assistant', content: welcomeMessage }]
          }));
        }
      };
      
      // åªåœ¨æ–°é€‰æ‹©ä»»åŠ¡æˆ–éœ€è¦é‡æ–°æ¿€æ´»æ—¶æ‰§è¡Œ
      const existingMessages = taskMessages[selectedTask.id];
      const hasExistingMessages = existingMessages && existingMessages.length > 0;
      
      if (!hasExistingMessages || (isNewSelection && !verificationMode.active)) {
        initVerificationTask();
      }
    } else if (isEnterpriseProfileTask) {
      // å®Œå–„ä¼ä¸šèµ„æ–™ä»»åŠ¡ - ä½¿ç”¨å¯¹è¯å¼•å¯¼æµç¨‹ï¼ˆå¿…é¡»åœ¨ä¼ä¸šè®¤è¯ä¹‹å‰åŒ¹é…ï¼ï¼‰
      if (isNewSelection || !enterpriseProfileMode.active) {
        console.log('[useEffect] Initializing enterprise profile task, taskId:', selectedTask.id);
        // é‡ç½®å¼•å¯¼æ¨¡å¼çŠ¶æ€
        setEnterpriseProfileMode({ active: false, missingFields: [], currentFieldIndex: -1 });
        setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
        setVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
        setDiscTestMode({ active: false, currentQuestion: 0, answers: [], completed: false });
        
        // æ¸…ç©ºæ—§æ¶ˆæ¯ï¼Œå¯åŠ¨ä¼ä¸šèµ„æ–™å¼•å¯¼æµç¨‹
        setTaskMessages(prev => ({
          ...prev,
          [selectedTask.id]: []
        }));
        startEnterpriseProfileGuide(true);
      }
    } else if (taskType === 'enterprise_verification' || taskTitle === 'å®Œæˆä¼ä¸šè®¤è¯' || (taskTitle.includes('ä¼ä¸š') && taskTitle.includes('è®¤è¯'))) {
      // ä¼ä¸šè®¤è¯ä»»åŠ¡ï¼ˆæ³¨æ„ï¼šä¸å†ä½¿ç”¨ taskType === 'EMPLOYER' åŒ¹é…ï¼Œå› ä¸ºä¼šå’Œ"å®Œå–„ä¼ä¸šèµ„æ–™"å†²çªï¼‰
      const initEnterpriseVerificationTask = async () => {
        try {
          const { getEnterpriseCertifications } = await import('./services/apiService');
          const certifications = await getEnterpriseCertifications(userId);
          
          // æ ¹æ®å·²æœ‰è®¤è¯ç¡®å®šå·²å®Œæˆçš„é¡¹ç›®
          const completedKeys: string[] = [];
          const certCategories = new Set(certifications.map((c: any) => c.category));
          
          // ä»è¥ä¸šæ‰§ç…§ä¸­æå–ä¼ä¸šåç§°
          let companyNameFromDB = '';
          const businessLicenseCerts = certifications.filter((c: any) => c.category === 'qualification' && c.name?.includes('è¥ä¸šæ‰§ç…§'));
          if (businessLicenseCerts.length > 0) {
            const cert = businessLicenseCerts[0];
            companyNameFromDB = cert.organization || '';
            completedKeys.push('business_license');
          }
          
          // æ£€æŸ¥æ³•äººèº«ä»½è¯è®¤è¯ï¼ˆåˆå¹¶è®°å½•è¡¨ç¤ºæ­£åé¢éƒ½å®Œæˆï¼‰
          const hasLegalPersonId = certifications.some((c: any) => 
            c.name?.includes('æ³•äººèº«ä»½è¯') && !c.name?.includes('æ­£é¢') && !c.name?.includes('èƒŒé¢')
          );
          if (hasLegalPersonId) {
            completedKeys.push('legal_person_id_front');
            completedKeys.push('legal_person_id_back');
          }
          
          // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„è®¤è¯é¡¹
          let startIndex = 0;
          for (let i = 0; i < enterpriseVerificationItems.length; i++) {
            if (!completedKeys.includes(enterpriseVerificationItems[i].key)) {
              startIndex = i;
              break;
            }
            if (i === enterpriseVerificationItems.length - 1) {
              startIndex = enterpriseVerificationItems.length;
            }
          }
          
          const totalSteps = enterpriseVerificationItems.length;
          const completedCount = completedKeys.length;
          
          console.log('[useEffect] Initializing enterprise verification task, completed:', completedKeys, 'startIndex:', startIndex);
          
          // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²ç»å®Œæˆ
          const isTaskAlreadyCompleted = selectedTask.status?.toLowerCase() === 'completed' || selectedTask.progress >= 100;
          
          if (startIndex >= totalSteps || isTaskAlreadyCompleted) {
            // æ‰€æœ‰è®¤è¯éƒ½å·²å®Œæˆ
            setEnterpriseVerificationMode({
              active: false,
              items: enterpriseVerificationItems,
              currentIndex: -1,
              completedItems: completedKeys,
              companyName: companyNameFromDB
            });
            
            const completeMessage = `ğŸ‰ **æ­å–œï¼ä¼ä¸šè®¤è¯å·²å…¨éƒ¨å®Œæˆï¼**\n\nâœ… å·²å®Œæˆï¼š${completedCount}/${totalSteps} é¡¹\n\næ‚¨çš„ä¼ä¸šå·²é€šè¿‡è®¤è¯ï¼Œè¿™å°†å¤§å¹…æå‡æ‹›è˜æ•ˆæœå’Œå€™é€‰äººä¿¡ä»»åº¦ï¼\n\nğŸ‘‰ å‰å¾€ [è®¾ç½® - ä¼ä¸šè®¤è¯ä¿¡æ¯](/settings?tab=Verification) æŸ¥çœ‹è¯¦æƒ…\n\nè¿˜æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`;
            
            setTaskMessages(prev => ({
              ...prev,
              [selectedTask.id]: [{ role: 'assistant', content: completeMessage }]
            }));
          } else {
            // è®¾ç½®ä¼ä¸šè®¤è¯æ¨¡å¼
            setEnterpriseVerificationMode({
              active: true,
              items: enterpriseVerificationItems,
              currentIndex: startIndex,
              completedItems: completedKeys,
              companyName: companyNameFromDB
            });
            
            // é‡ç½®å…¶ä»–æ¨¡å¼
            setVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
            setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
            setDiscTestMode({ active: false, currentQuestion: 0, answers: [], completed: false });
            setJobSearchMode({ active: false, currentQuestion: 0, answers: [], completed: false, tokenUsed: 0, isSearching: false });
            
            const currentItem = enterpriseVerificationItems[startIndex];
            const welcomeMessage = currentItem 
              ? `ğŸ¢ **æ¬¢è¿æ¥åˆ°ä¼ä¸šè®¤è¯ä¸­å¿ƒï¼**\n\nå®Œæˆä¼ä¸šè®¤è¯å¯ä»¥å¸®åŠ©æ‚¨ï¼š\nâœ… æå‡ä¼ä¸šå¯ä¿¡åº¦ï¼Œè·å¾—"è®¤è¯ä¼ä¸š"æ ‡è¯†\nâœ… ä¼˜å…ˆå±•ç¤ºåœ¨ä¼ä¸šæ¨èåˆ—è¡¨\nâœ… å¢åŠ å€™é€‰äººæŠ•é€’æ„æ„¿\nâœ… è§£é”æ›´å¤šé«˜çº§æ‹›è˜åŠŸèƒ½\n\n---\n\nğŸ“‹ **è®¤è¯è¿›åº¦ï¼š** ${completedCount}/${totalSteps} é¡¹\n\n${currentItem.icon} **ç¬¬ ${startIndex + 1} é¡¹ï¼š${currentItem.label}**\n\n${currentItem.description}`
              : `ğŸ¢ **æ¬¢è¿æ¥åˆ°ä¼ä¸šè®¤è¯ä¸­å¿ƒï¼**\n\nå®Œæˆä¼ä¸šè®¤è¯å¯ä»¥å¸®åŠ©æ‚¨ï¼š\nâœ… æå‡ä¼ä¸šå¯ä¿¡åº¦ï¼Œè·å¾—"è®¤è¯ä¼ä¸š"æ ‡è¯†\nâœ… ä¼˜å…ˆå±•ç¤ºåœ¨ä¼ä¸šæ¨èåˆ—è¡¨\nâœ… å¢åŠ å€™é€‰äººæŠ•é€’æ„æ„¿\nâœ… è§£é”æ›´å¤šé«˜çº§æ‹›è˜åŠŸèƒ½\n\n---\n\nğŸ“‹ **è®¤è¯è¿›åº¦ï¼š** ${completedCount}/${totalSteps} é¡¹\n\nç‚¹å‡»ä¸‹æ–¹ **ã€Œå¼€å§‹è®¤è¯ã€** æŒ‰é’®å¼€å§‹ä¼ä¸šè®¤è¯æµç¨‹ã€‚`;
            
            setTaskMessages(prev => ({
              ...prev,
              [selectedTask.id]: [{ role: 'assistant', content: welcomeMessage }]
            }));
          }
        } catch (error) {
          console.error('åˆå§‹åŒ–ä¼ä¸šè®¤è¯ä»»åŠ¡å¤±è´¥:', error);
        }
      };
      
      const existingMessages = taskMessages[selectedTask.id];
      const hasExistingMessages = existingMessages && existingMessages.length > 0;
      
      if (!hasExistingMessages || (isNewSelection && !enterpriseVerificationMode.active)) {
        initEnterpriseVerificationTask();
      }
    } else if (taskTitle === 'DISCæ€§æ ¼æµ‹è¯•') {
      // DISCæµ‹è¯•ä»»åŠ¡
      if (isNewSelection) {
        setVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
        setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
        setDiscTestMode({ active: true, currentQuestion: 0, answers: [], completed: false });
        setJobSearchMode({ active: false, currentQuestion: 0, answers: [], completed: false, tokenUsed: 0, isSearching: false });
        
        const discWelcomeMessage = `ğŸ¯ **æ¬¢è¿å‚åŠ  DISC æ€§æ ¼æµ‹è¯•ï¼**\n\n**ä»€ä¹ˆæ˜¯ DISCï¼Ÿ**\nDISC æ˜¯ä¸€ç§å¹¿æ³›åº”ç”¨äºèŒåœºçš„è¡Œä¸ºé£æ ¼è¯„ä¼°å·¥å…·ï¼Œå¸®åŠ©æ‚¨äº†è§£è‡ªå·±çš„ï¼š\n\nâ€¢ **D (Dominance) æ”¯é…å‹** - ç»“æœå¯¼å‘ã€æœæ–­å†³ç­–\nâ€¢ **I (Influence) å½±å“å‹** - å–„äºæ²Ÿé€šã€çƒ­æƒ…ä¹è§‚\nâ€¢ **S (Steadiness) ç¨³å¥å‹** - ç¨³é‡å¯é ã€å›¢é˜Ÿåä½œ\nâ€¢ **C (Conscientiousness) è°¨æ…å‹** - æ³¨é‡ç»†èŠ‚ã€è¿½æ±‚å®Œç¾\n\n**æµ‹è¯•æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ**\nâœ… äº†è§£æ‚¨çš„è¡Œä¸ºé£æ ¼å’Œå·¥ä½œåå¥½\nâœ… å‘ç°æ‚¨çš„ä¼˜åŠ¿å’Œæ½œåœ¨æˆé•¿ç©ºé—´\nâœ… å¸®åŠ© HR æ›´å¥½åœ°åŒ¹é…é€‚åˆæ‚¨çš„å²—ä½\nâœ… æå‡å›¢é˜Ÿåä½œå’Œæ²Ÿé€šæ•ˆç‡\n\nğŸ“‹ æµ‹è¯•å…± **10 é“é¢˜ç›®**ï¼Œé¢„è®¡ç”¨æ—¶ 3-5 åˆ†é’Ÿ\n\n---\n\nå‡†å¤‡å¥½äº†å—ï¼Ÿè¾“å…¥ã€Œå¼€å§‹æµ‹è¯•ã€å¼€å§‹æ‚¨çš„ DISC ä¹‹æ—…ï¼`;
        
        setTaskMessages(prev => ({
          ...prev,
          [selectedTask.id]: [{ role: 'assistant', content: discWelcomeMessage }]
        }));
      }
    } else if (taskTitle?.includes('äº‘ç«¯æ±‚èŒè½®å·¡')) {
      // äº‘ç«¯æ±‚èŒè½®å·¡ä»»åŠ¡
      if (isNewSelection) {
        setVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
        setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
        setDiscTestMode({ active: false, currentQuestion: 0, answers: [], completed: false });
        
        // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å†³å®šåˆå§‹åŒ–æ¨¡å¼
        const taskStatus = (selectedTask.status || '').toUpperCase();
        const isRunning = taskStatus === 'RUNNING';
        
        if (isRunning) {
          // ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­ï¼Œè®¾ç½®ä¸ºå·²å®Œæˆåå¥½æ”¶é›†çš„çŠ¶æ€
          setJobSearchMode({ active: true, currentQuestion: 0, answers: [], completed: true, tokenUsed: 0, isSearching: false });
        } else {
          // ä»»åŠ¡å¾…å¼€å§‹ï¼Œéœ€è¦æ”¶é›†åå¥½
          setJobSearchMode({ active: true, currentQuestion: 0, answers: [], completed: false, tokenUsed: 0, isSearching: false });
        }
        
        // è·å–ä»»åŠ¡æè¿°ä¸­çš„ä¼šå‘˜ä¿¡æ¯
        const taskDesc = selectedTask.description || '';
        const daysMatch = taskDesc.match(/(\d+)å¤©/);
        const days = daysMatch ? parseInt(daysMatch[1]) : 7;
        
        // æ ¹æ®ä»»åŠ¡çŠ¶æ€ç”Ÿæˆæ¬¢è¿æ¶ˆæ¯
        const initCloudTask = async () => {
          const { getMemories } = await import('./services/apiService');
          const memories = await getMemories(userId);
          const oneMonthAgo = new Date();
          oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
          
          const recentJobPreference = memories.find((m: any) => {
            if (m.type?.toLowerCase() !== 'preference' || !m.content?.includes('æ±‚èŒåå¥½')) return false;
            const memoryDate = parseUTC(m.created_at || m.createdAt);
            return memoryDate > oneMonthAgo;
          });
          
          let welcomeMsg = '';
          
          if (isRunning) {
            // ä»»åŠ¡å·²åœ¨è¿è¡Œ â€” æ˜¾ç¤ºçœŸå®ç»Ÿè®¡æ•°æ®
            welcomeMsg = `ğŸš€ **äº‘ç«¯æ±‚èŒè½®å·¡ä»»åŠ¡è¿è¡Œä¸­ï¼**\n\n`;
            welcomeMsg += `ğŸ“‹ **ä»»åŠ¡åç§°**ï¼š${taskTitle}\n`;
            welcomeMsg += `â±ï¸ **è½®å·¡å‘¨æœŸ**ï¼š${days} å¤©\n`;
            welcomeMsg += `ğŸ“Š **ä»»åŠ¡çŠ¶æ€**ï¼šğŸŸ¢ è¿è¡Œä¸­\n\n`;
            // æ’å…¥çœŸå®ç»Ÿè®¡
            if (aiFlowStats && aiFlowStats.applied > 0) {
              welcomeMsg += `---\n\n### ğŸ“Š å½“å‰æŠ•é€’è¿›åº¦\n\n`;
              welcomeMsg += `| æŒ‡æ ‡ | æ•°æ® |\n`;
              welcomeMsg += `|------|------|\n`;
              welcomeMsg += `| å·²æ‰«æå²—ä½ | **${aiFlowStats.viewed || 0}** ä¸ª |\n`;
              welcomeMsg += `| å·²æŠ•é€’ | **${aiFlowStats.applied || 0}** ä¸ª |\n`;
              welcomeMsg += `| å·²é€šè¿‡ | **${aiFlowStats.passed || 0}** ä¸ª |\n`;
              welcomeMsg += `| è¿›è¡Œä¸­ | **${aiFlowStats.pending || 0}** ä¸ª |\n`;
              welcomeMsg += `| æœªé€šè¿‡ | **${aiFlowStats.rejected || 0}** ä¸ª |\n`;
              welcomeMsg += `| å¹³å‡åŒ¹é…åº¦ | **${aiFlowStats.avgMatch || 0}%** |\n`;
            }
            welcomeMsg += `\n---\n\n## ğŸ¤– AI æ­£åœ¨äº‘ç«¯ä¸ºæ‚¨å·¥ä½œ\n\n`;
            welcomeMsg += `â€¢ â° æ¯å°æ—¶æ‰«æå…¨ç½‘æ–°å¢å²—ä½\n`;
            welcomeMsg += `â€¢ ğŸ¯ è‡ªåŠ¨ç­›é€‰åŒ¹é…åº¦ â‰¥ 85% çš„å²—ä½\n`;
            welcomeMsg += `â€¢ ğŸ“¤ è‡ªåŠ¨æŠ•é€’ç¬¦åˆæ¡ä»¶çš„å²—ä½\n`;
            welcomeMsg += `â€¢ ğŸ”” å®æ—¶é€šçŸ¥æŠ•é€’ç»“æœå’Œé¢è¯•é‚€è¯·\n\n`;
            welcomeMsg += `---\n\nğŸ’¡ æ‚¨å¯ä»¥ï¼š\n`;
            welcomeMsg += `â€¢ è¾“å…¥ã€ŒæŸ¥çœ‹è¿›åº¦ã€æŸ¥çœ‹å®æ—¶æŠ•é€’è¿›åº¦\n`;
            welcomeMsg += `â€¢ è¾“å…¥ã€ŒæŸ¥çœ‹æŠ•é€’ã€æŸ¥çœ‹æ‰€æœ‰æŠ•é€’è®°å½•\n`;
            welcomeMsg += `â€¢ è¾“å…¥ã€Œæš‚åœè½®å·¡ã€æš‚åœä»»åŠ¡\n`;
            welcomeMsg += `â€¢ è¾“å…¥ã€Œä¿®æ”¹åå¥½ã€æ›´æ–°æ±‚èŒåå¥½`;
          } else if (recentJobPreference) {
            // æœ‰åå¥½è®°å½•ï¼Œå‡†å¤‡å¼€å§‹
            welcomeMsg = `ğŸ¯ **äº‘ç«¯æ±‚èŒè½®å·¡ä»»åŠ¡å‡†å¤‡å°±ç»ªï¼**\n\n`;
            welcomeMsg += `ğŸ“‹ **ä»»åŠ¡åç§°**ï¼š${taskTitle}\n`;
            welcomeMsg += `â±ï¸ **è½®å·¡å‘¨æœŸ**ï¼š${days} å¤©\n`;
            welcomeMsg += `ğŸ“Š **ä»»åŠ¡çŠ¶æ€**ï¼šâ¸ï¸ å¾…å¯åŠ¨\n\n`;
            welcomeMsg += `---\n\næ£€æµ‹åˆ°æ‚¨å·²æœ‰æ±‚èŒåå¥½è®°å½•ï¼š\n\n`;
            welcomeMsg += `${recentJobPreference.content}\n\n`;
            welcomeMsg += `---\n\nè¾“å…¥ã€Œå¼€å§‹ã€å³å¯å¯åŠ¨äº‘ç«¯è½®å·¡ä»»åŠ¡ï¼\n`;
            welcomeMsg += `æˆ–è¾“å…¥ã€Œä¿®æ”¹åå¥½ã€é‡æ–°è®¾ç½®æ±‚èŒåå¥½ã€‚`;
          } else {
            // æ— åå¥½è®°å½•ï¼Œéœ€è¦æ”¶é›†
            welcomeMsg = `ğŸ¯ **äº‘ç«¯æ±‚èŒè½®å·¡ä»»åŠ¡**\n\n`;
            welcomeMsg += `ğŸ“‹ **ä»»åŠ¡åç§°**ï¼š${taskTitle}\n`;
            welcomeMsg += `â±ï¸ **è½®å·¡å‘¨æœŸ**ï¼š${days} å¤©\n`;
            welcomeMsg += `ğŸ“Š **ä»»åŠ¡çŠ¶æ€**ï¼šâ¸ï¸ å¾…å¯åŠ¨\n\n`;
            welcomeMsg += `---\n\nåœ¨å¯åŠ¨äº‘ç«¯è½®å·¡ä¹‹å‰ï¼Œæˆ‘éœ€è¦äº†è§£æ‚¨çš„**æ±‚èŒåå¥½**ï¼Œä»¥ä¾¿æ›´ç²¾å‡†åœ°ä¸ºæ‚¨åŒ¹é…å²—ä½ã€‚\n\n`;
            welcomeMsg += `ğŸ“‹ å…± **${jobSearchQuestions.length} ä¸ªé—®é¢˜**ï¼Œé¢„è®¡ç”¨æ—¶ 2-3 åˆ†é’Ÿ\n\n`;
            welcomeMsg += `---\n\nå‡†å¤‡å¥½äº†å—ï¼Ÿè¾“å…¥ã€Œå¼€å§‹ã€å¼€å§‹è®¾ç½®æ±‚èŒåå¥½ï¼`;
          }
          
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [{ role: 'assistant', content: welcomeMsg }]
          }));
        };
        
        initCloudTask();
      }
    } else if (taskTitle === 'æ™ºèƒ½æ±‚èŒåŠ©æ‰‹') {
      // æ™ºèƒ½æ±‚èŒåŠ©æ‰‹ä»»åŠ¡ï¼ˆæ—§ç‰ˆæœ¬å…¼å®¹ï¼‰
      if (isNewSelection) {
        setVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
        setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
        setDiscTestMode({ active: false, currentQuestion: 0, answers: [], completed: false });
        setJobSearchMode({ active: true, currentQuestion: 0, answers: [], completed: false, tokenUsed: 0, isSearching: false });
        
        const jobSearchWelcomeMessage = `ğŸ¯ **æ™ºèƒ½æ±‚èŒåŠ©æ‰‹**\n\næ¬¢è¿ä½¿ç”¨æ™ºèƒ½æ±‚èŒåŠŸèƒ½ï¼æˆ‘å°†æ ¹æ®æ‚¨çš„ç®€å†ã€è®¤è¯ä¿¡æ¯å’Œæ±‚èŒåå¥½ï¼Œä¸ºæ‚¨æ™ºèƒ½åŒ¹é…å¹¶æ¨èåˆé€‚çš„å²—ä½ã€‚\n\nåœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘éœ€è¦äº†è§£ä¸€äº›æ‚¨çš„**æ±‚èŒåå¥½**ï¼Œè¿™å°†å¸®åŠ©æˆ‘æ›´ç²¾å‡†åœ°ä¸ºæ‚¨åŒ¹é…åˆé€‚çš„å²—ä½ã€‚\n\nğŸ“‹ å…± **${jobSearchQuestions.length} ä¸ªé—®é¢˜**ï¼Œé¢„è®¡ç”¨æ—¶ 2-3 åˆ†é’Ÿ\n\n---\n\nå‡†å¤‡å¥½äº†å—ï¼Ÿè¾“å…¥ã€Œå¼€å§‹ã€å¼€å§‹æ‚¨çš„æ™ºèƒ½æ±‚èŒä¹‹æ—…ï¼`;
        
        setTaskMessages(prev => ({
          ...prev,
          [selectedTask.id]: [{ role: 'assistant', content: jobSearchWelcomeMessage }]
        }));
      }
    } else if (taskType === 'recruit' || taskTitle?.includes('æ™ºèƒ½æ‹›è˜')) {
      // æ™ºèƒ½æ‹›è˜ä»»åŠ¡ - ä¸»åŠ¨å¼•å¯¼ç”¨æˆ·å‘å¸ƒæ‹›è˜éœ€æ±‚
      if (isNewSelection) {
        setVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
        setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
        setEnterpriseProfileMode({ active: false, missingFields: [], currentFieldIndex: -1 });
        setDiscTestMode({ active: false, currentQuestion: 0, answers: [], completed: false });
        setJobSearchMode({ active: false, currentQuestion: 0, answers: [], completed: false, tokenUsed: 0, isSearching: false });
        
        // ===== æ¢å¤é€»è¾‘ï¼šæ£€æŸ¥ä»»åŠ¡åç«¯ä¿å­˜çš„è¿›åº¦å’Œé˜¶æ®µ =====
        const existingMessages = taskMessages[selectedTask.id];
        const hasExistingMessages = existingMessages && existingMessages.length > 0;
        const progress = selectedTask.progress ?? 0;
        const taskStatus = (selectedTask.status || '').toLowerCase();
        
        // ä»åç«¯ä¿å­˜çš„ steps.metadata è¯»å–ç²¾ç¡®é˜¶æ®µå’Œå·²å‘å¸ƒå²—ä½
        const stepsData = selectedTask.steps;
        const metadata = stepsData?.metadata || {};
        const savedStep = metadata.current_step;
        const savedJobIds: number[] = metadata.published_job_ids || [];
        
        // åˆ¤æ–­æ˜¯å¦æœ‰åç«¯ä¿å­˜çš„è¿›åº¦ï¼ˆå³éå…¨æ–°ä»»åŠ¡ï¼‰
        const hasBackendProgress = progress > 0 || !!savedStep || savedJobIds.length > 0;
        
        if (hasBackendProgress) {
          // ===== æ¢å¤å·²æœ‰è¿›åº¦çš„ä»»åŠ¡ =====
          let resumeStep: 'requirement' | 'generate' | 'optimize' | 'invite' | 'screen' | 'complete' = 'requirement';
          
          if (savedStep && ['requirement','generate','optimize','invite','screen','complete'].includes(savedStep)) {
            resumeStep = savedStep as any;
          } else if (savedStep === 'exchange') {
            // æ—§æ•°æ®å…¼å®¹ï¼šexchange å·²åˆå¹¶åˆ° screenï¼Œè§†ä¸º complete
            resumeStep = 'complete';
          } else {
            if (taskStatus === 'completed' || progress >= 100) resumeStep = 'complete';
            else if (progress >= 60) resumeStep = 'screen';
            else if (progress >= 40) resumeStep = 'invite';
            else if (progress >= 25) resumeStep = 'optimize';
          }
          
          // æ¢å¤ postMode
          setPostMode(prev => ({ ...prev, active: true, step: resumeStep }));
          
          // å¼‚æ­¥åŠ è½½å…³è”å²—ä½ + ç”Ÿæˆå½“å‰é˜¶æ®µçš„ä¸Šä¸‹æ–‡æç¤º
          const taskId = selectedTask.id;
          (async () => {
            let publishedJobNames: string[] = [];
            
            // åŠ è½½å…³è”å²—ä½è¯¦æƒ…
            if (savedJobIds.length > 0) {
              try {
                const { getMyJobs } = await import('./services/apiService');
                const allJobs = await getMyJobs(userId).catch(() => []);
                const publishedJobs = allJobs.filter((j: any) => savedJobIds.includes(j.id));
                if (publishedJobs.length > 0) {
                  setPostMode(prev => ({ ...prev, publishedJobs }));
                  publishedJobNames = publishedJobs.map((j: any) => j.title);
                }
              } catch { /* ignore */ }
            }
            
            // æ„å»ºå½“å‰é˜¶æ®µçš„ä¸Šä¸‹æ–‡æ¶ˆæ¯
            const stepLabels: Record<string, string> = {
              requirement: 'ğŸ“ æè¿°æ‹›è˜éœ€æ±‚',
              generate: 'ğŸ¤– AI ç”Ÿæˆå²—ä½',
              optimize: 'ğŸ“‹ ä¼˜åŒ–å²—ä½ä¿¡æ¯',
              invite: 'ğŸ“¨ æ™ºèƒ½é‚€è¯·æŠ•é€’',
              screen: 'ğŸ” æ™ºèƒ½ç­›é€‰è¯„ä¼°',
              complete: 'âœ… æ‹›è˜ä»»åŠ¡å·²å®Œæˆ',
            };
            const currentLabel = stepLabels[resumeStep] || resumeStep;
            const jobsDisplay = publishedJobNames.length > 0 
              ? publishedJobNames.map(n => `ã€Œ${n}ã€`).join('ã€')
              : savedJobIds.length > 0 ? `${savedJobIds.length} ä¸ªå²—ä½` : '';
            
            let stageMsg = '';
            
            if (resumeStep === 'invite') {
              stageMsg = `ğŸ“¨ **å½“å‰é˜¶æ®µï¼šæ™ºèƒ½é‚€è¯·æŠ•é€’ï¼ˆâ˜ï¸ äº‘ç«¯å¼‚æ­¥ï¼‰**\n\n`;
              if (jobsDisplay) stageMsg += `å·²å‘å¸ƒå²—ä½ï¼š${jobsDisplay}\n\n`;
              stageMsg += `å²—ä½å·²å‘å¸ƒæˆåŠŸï¼ä¸‹ä¸€æ­¥å°†é€šè¿‡äº‘ç«¯å¼‚æ­¥ä»»åŠ¡ï¼Œåœ¨äººæ‰åº“ä¸­æ™ºèƒ½åŒ¹é…å€™é€‰äººã€‚\n\n`;
              stageMsg += `æ‚¨å¯ä»¥ï¼š\n`;
              stageMsg += `â€¢ ç‚¹å‡»ä¸‹æ–¹ **ã€Œâ˜ï¸ å¼€å§‹æ™ºèƒ½é‚€è¯·ã€** æäº¤äº‘ç«¯åŒ¹é…ä»»åŠ¡\n`;
              stageMsg += `â€¢ è¾“å…¥é¢å¤–ç­›é€‰è¦æ±‚ï¼Œä¾‹å¦‚ "ä¼˜å…ˆé‚€è¯·æœ‰å¤§å‚ç»éªŒçš„"\n`;
              stageMsg += `â€¢ ç‚¹å‡» **ã€Œè·³åˆ°ç­›é€‰ã€** ç›´æ¥è¿›å…¥ç­›é€‰ç¯èŠ‚`;
            } else if (resumeStep === 'screen') {
              stageMsg = `ğŸ” **å½“å‰é˜¶æ®µï¼šæ™ºèƒ½ç­›é€‰ï¼ˆâ˜ï¸ äº‘ç«¯å¼‚æ­¥ï¼‰**\n\n`;
              if (jobsDisplay) stageMsg += `æ‹›è˜å²—ä½ï¼š${jobsDisplay}\n\n`;
              stageMsg += `å€™é€‰äººé‚€è¯·å·²å®Œæˆï¼ä¸‹ä¸€æ­¥ AI å°†å¯¹å€™é€‰äººè¿›è¡Œå¤šç»´åº¦ç‹¬ç«‹å®¡æ ¸åˆ†æï¼š\n`;
              stageMsg += `ğŸ¢ **ä¼ä¸šé€‚é…æ€§å®¡æ ¸** â€” AI è¯„ä¼°å€™é€‰äººä¸å²—ä½çš„åŒ¹é…ç¨‹åº¦\n`;
              stageMsg += `ğŸ‘¤ **å€™é€‰äººæ„æ„¿è¯„ä¼°** â€” AI è¯„ä¼°å€™é€‰äººæ¥å—é‚€è¯·çš„å¯èƒ½æ€§\n\n`;
              stageMsg += `é€šè¿‡ç­›é€‰çš„å€™é€‰äººå°† **è‡ªåŠ¨äº’æ¢è”ç³»æ–¹å¼**ï¼Œå®Œæˆæ‹›è˜æµç¨‹ã€‚\n\n`;
              stageMsg += `â€¢ ç‚¹å‡»ä¸‹æ–¹ **ã€Œâ˜ï¸ å¼€å§‹æ™ºèƒ½ç­›é€‰ã€** å¯åŠ¨äº‘ç«¯ç­›é€‰\n`;
              stageMsg += `â€¢ è¾“å…¥ç‰¹å®šç­›é€‰æ ‡å‡†ï¼Œä¾‹å¦‚ "é‡ç‚¹è¯„ä¼°é¡¹ç›®ç»éªŒ"`;
            } else if (resumeStep === 'complete') {
              stageMsg = `âœ… **æ‹›è˜ä»»åŠ¡å·²å®Œæˆ**\n\n`;
              if (jobsDisplay) stageMsg += `æ‹›è˜å²—ä½ï¼š${jobsDisplay}\n\n`;
              stageMsg += `ğŸ‰ è¯¥æ‹›è˜ä»»åŠ¡å…¨æµç¨‹å·²åœ†æ»¡å®Œæˆï¼\n\n`;
              stageMsg += `å¦‚éœ€ç»§ç»­æ‹›è˜å…¶ä»–å²—ä½ï¼Œè¯·è¿”å›é¦–é¡µåˆ›å»ºæ–°çš„æ‹›è˜ä»»åŠ¡ã€‚`;
            } else if (resumeStep === 'optimize') {
              stageMsg = `ğŸ“‹ **å½“å‰é˜¶æ®µï¼šç¡®è®¤å²—ä½ä¿¡æ¯**\n\n`;
              stageMsg += `AI å·²ç”Ÿæˆå²—ä½æè¿°ï¼Œè¯·ç¡®è®¤åå‘å¸ƒã€‚\n\n`;
              stageMsg += `â€¢ ç‚¹å‡» **ã€Œç¡®è®¤å‘å¸ƒã€** å°†å²—ä½ä¸Šçº¿\n`;
              stageMsg += `â€¢ æˆ–è¾“å…¥ä¿®æ”¹æ„è§ï¼Œä¾‹å¦‚ "è–ªèµ„æ”¹ä¸º 15-25k"`;
            } else {
              stageMsg = `ğŸ“ **å½“å‰é˜¶æ®µï¼šæè¿°æ‹›è˜éœ€æ±‚**\n\n`;
              stageMsg += `è¯·å‘Šè¯‰æˆ‘æ‚¨çš„æ‹›è˜éœ€æ±‚ï¼ŒAI å°†ä¸ºæ‚¨æ™ºèƒ½ç”Ÿæˆå²—ä½ã€‚\n\n`;
              stageMsg += `ä¾‹å¦‚ï¼š\nğŸ’¡ "æ‹›ä¸€ä¸ªé«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆï¼Œ3å¹´ä»¥ä¸Šç»éªŒ"\nğŸ’¡ "æŠ€æœ¯å›¢é˜Ÿæ‰©æ‹›5ä¸ªäºº"`;
            }
            
            // å¦‚æœå·²æœ‰å¯¹è¯è®°å½•ï¼Œåœ¨æœ«å°¾è¿½åŠ é˜¶æ®µæç¤ºï¼›å¦åˆ™ä½œä¸ºé¦–æ¡æ¶ˆæ¯
            if (hasExistingMessages) {
              // æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦å·²ç»æ˜¯é˜¶æ®µæç¤ºï¼ˆé¿å…é‡å¤è¿½åŠ ï¼‰
              const lastMsg = existingMessages[existingMessages.length - 1];
              const isAlreadyStageMsg = lastMsg?.content?.includes('å½“å‰é˜¶æ®µï¼š');
              if (!isAlreadyStageMsg && resumeStep !== 'requirement') {
                setTaskMessages(prev => {
                  const msgs = prev[taskId] || [];
                  return { ...prev, [taskId]: [...msgs, { role: 'assistant', content: stageMsg }] };
                });
              }
            } else {
              // æ— å¯¹è¯è®°å½•ï¼Œç”Ÿæˆå®Œæ•´çš„æ¢å¤æ¶ˆæ¯
              let resumeHeader = `ğŸ¢ **æ™ºèƒ½æ‹›è˜åŠ©æ‰‹ â€” ä»»åŠ¡æ¢å¤**\n\n`;
              resumeHeader += `ğŸ“Š **è¿›åº¦**ï¼š${progress}% | ${currentLabel}\n\n---\n\n`;
              
              setTaskMessages(prev => ({
                ...prev,
                [taskId]: [{ role: 'assistant', content: resumeHeader + stageMsg }]
              }));
            }
          })();
          return;
        }
        
        // ===== å…¨æ–°ä»»åŠ¡ï¼ˆprogress=0ï¼Œæ— åç«¯ä¿å­˜çš„é˜¶æ®µï¼‰â€” å¯åŠ¨æ‹›è˜å¼•å¯¼ =====
        if (hasExistingMessages) {
          // æœ‰å‰ç«¯å¯¹è¯è®°å½•ä½†æ— åç«¯è¿›åº¦ï¼ˆæå°‘è§ï¼‰ï¼Œæ¢å¤ä¸º requirement
          setPostMode(prev => ({ ...prev, active: true, step: 'requirement' }));
          return;
        }
        
        setPostMode({
          active: true,
          step: 'requirement',
          jobDescription: '',
          generatedResult: null
        });
        
        const initRecruitTask = async () => {
          const taskId = selectedTask.id;
          try {
            // å…ˆæ˜¾ç¤ºåŠ è½½ä¸­çš„æç¤º
            const { getRecruitmentSuggestions } = await import('./services/apiService');
            const companyName = user?.company_name || 'è´µå…¬å¸';
            
            setTaskMessages(prev => ({
              ...prev,
              [taskId]: [{ role: 'assistant', content: `ğŸ¢ **${companyName} Â· æ™ºèƒ½æ‹›è˜åŠ©æ‰‹**\n\nâ³ æ­£åœ¨æ ¹æ®ä¼ä¸šèµ„æ–™åˆ†æé€‚åˆæ‚¨çš„æ‹›è˜æ–¹å‘...` }]
            }));
            
            // å¹¶è¡Œè°ƒç”¨ï¼šè·å–æ‹›è˜å»ºè®® + è·å–ä¼ä¸šè®°å¿†
            const { getMemories } = await import('./services/apiService');
            const [suggestionsData, memoryList] = await Promise.all([
              getRecruitmentSuggestions(userId),
              getMemories(userId, 'employer').catch(() => [])
            ]);
            const finalCompanyName = suggestionsData.company_name || companyName;
            const suggestions = suggestionsData.suggestions || [];
            const companySummary = suggestionsData.company_summary || '';
            
            // æ„å»ºä¸ªæ€§åŒ–çš„æ¬¢è¿æ¶ˆæ¯
            let suggestionsText = '';
            if (suggestions.length > 0) {
              suggestionsText = suggestions.map(s => `ğŸ’¡ "${s}"`).join('\n');
            } else {
              suggestionsText = `ğŸ’¡ "éœ€è¦ä¸€ä¸ªå‰ç«¯å’Œä¸€ä¸ªåç«¯"\nğŸ’¡ "æ‹›äº§å“ç»ç†ï¼Œ3å¹´ç»éªŒä»¥ä¸Š"\nğŸ’¡ "æŠ€æœ¯å›¢é˜Ÿæ‰©æ‹›5ä¸ªäºº"`;
            }
            
            let welcomeMsg = `ğŸ¢ **${finalCompanyName} Â· æ™ºèƒ½æ‹›è˜åŠ©æ‰‹**\n\n`;
            
            if (companySummary) {
              welcomeMsg += `ğŸ“Š **ä¼ä¸šè®°å¿†åˆ†æ**ï¼š${companySummary}\n\n`;
            }
            
            // å±•ç¤ºç”Ÿæ•ˆçš„ä¼ä¸šè®°å¿†è¦æ±‚ï¼ˆä½¿ç”¨åˆšè·å–çš„ memoryList ä¿è¯æ•°æ®æœ€æ–°ï¼‰
            const activeMemories = (memoryList || []).filter((m: any) => 
              m.raw_type === 'requirement' || m.raw_type === 'action' || m.raw_type === 'strategy' || (m.emphasis_count || 1) >= 2
            );
            if (activeMemories.length > 0) {
              welcomeMsg += `ğŸ§  **å·²åŠ è½½ ${activeMemories.length} æ¡ä¼ä¸šè®°å¿†åå¥½**ï¼ˆç”Ÿæˆå²—ä½æ—¶å°†è‡ªåŠ¨éµå¾ªï¼‰ï¼š\n`;
              activeMemories.slice(0, 5).forEach((m: any) => {
                const strength = (m.emphasis_count || 1) > 1 ? ` Ã—${m.emphasis_count}` : '';
                welcomeMsg += `> â€¢ ${m.content.substring(0, 60)}${m.content.length > 60 ? '...' : ''}${strength}\n`;
              });
              if (activeMemories.length > 5) {
                welcomeMsg += `> _...ç­‰ ${activeMemories.length - 5} æ¡æ›´å¤šè®°å¿†_\n`;
              }
              welcomeMsg += `\n`;
            }
            
            welcomeMsg += `æˆ‘å°†å¸®æ‚¨å®Œæˆæ•´ä¸ªæ‹›è˜æµç¨‹ï¼š\n\n` +
              `**â‘  æè¿°éœ€æ±‚** â†’ å‘Šè¯‰æˆ‘æ‚¨æƒ³æ‹›ä»€ä¹ˆäºº\n` +
              `**â‘¡ AI ç”Ÿæˆå²—ä½** â†’ æ ¹æ®ä¼ä¸šä¿¡æ¯å’Œè®°å¿†åå¥½è‡ªåŠ¨ç”Ÿæˆå²—ä½æè¿°\n` +
              `**â‘¢ ç¡®è®¤å‘å¸ƒ** â†’ ç¡®è®¤åå²—ä½ä¸Šçº¿\n` +
              `**â‘£ æ™ºèƒ½é‚€è¯·** â†’ AI ä»äººæ‰åº“åŒ¹é…å€™é€‰äººå¹¶å‘é€é‚€è¯·\n` +
              `**â‘¤ æ™ºèƒ½ç­›é€‰** â†’ AI æ·±åº¦è¯„ä¼°å¹¶è‡ªåŠ¨äº’æ¢è”ç³»æ–¹å¼\n\n---\n\n` +
              `æ ¹æ®æ‚¨çš„ä¼ä¸šèµ„æ–™ï¼Œä¸ºæ‚¨æ™ºèƒ½æ¨èä»¥ä¸‹æ‹›è˜æ–¹å‘ï¼š\n\n` +
              `${suggestionsText}\n\n` +
              `æ‚¨å¯ä»¥ç›´æ¥è¾“å…¥ä»¥ä¸Šå»ºè®®ï¼Œä¹Ÿå¯ä»¥è‡ªç”±æè¿°æ‚¨çš„æ‹›è˜éœ€æ±‚ã€‚`;
            
            setTaskMessages(prev => ({
              ...prev,
              [taskId]: [{ role: 'assistant', content: welcomeMsg }]
            }));
          } catch (e) {
            console.error('[Recruitment Init] Error:', e);
            setTaskMessages(prev => ({
              ...prev,
              [taskId]: [{ role: 'assistant', content: `ğŸ¢ **æ™ºèƒ½æ‹›è˜åŠ©æ‰‹**\n\næˆ‘å°†å¸®æ‚¨å®Œæˆæ•´ä¸ªæ‹›è˜æµç¨‹ï¼š\n\n**â‘  æè¿°éœ€æ±‚** â†’ å‘Šè¯‰æˆ‘æ‚¨æƒ³æ‹›ä»€ä¹ˆäºº\n**â‘¡ AI ç”Ÿæˆå²—ä½** â†’ æ ¹æ®ä¼ä¸šä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆ\n**â‘¢ ç¡®è®¤å‘å¸ƒ** â†’ ç¡®è®¤åå²—ä½ä¸Šçº¿\n**â‘£ æ™ºèƒ½é‚€è¯·** â†’ AI åŒ¹é…å€™é€‰äººå¹¶é‚€è¯·\n**â‘¤ æ™ºèƒ½ç­›é€‰** â†’ AI æ·±åº¦è¯„ä¼°å¹¶è‡ªåŠ¨äº’æ¢è”ç³»æ–¹å¼\n\nè¯·å‘Šè¯‰æˆ‘æ‚¨çš„æ‹›è˜éœ€æ±‚ï¼Œä¾‹å¦‚ï¼š\n\nğŸ’¡ "éœ€è¦ä¸€ä¸ªå‰ç«¯å’Œä¸€ä¸ªåç«¯"\nğŸ’¡ "æ‹›äº§å“ç»ç†ï¼Œ3å¹´ç»éªŒä»¥ä¸Š"\nğŸ’¡ "æŠ€æœ¯å›¢é˜Ÿæ‰©æ‹›5ä¸ªäºº"\n\næ‚¨æƒ³æ‹›ä»€ä¹ˆäººï¼Ÿ` }]
            }));
          }
        };
        
        initRecruitTask();
      }
    } else {
      // æ™®é€šä»»åŠ¡ï¼šé‡ç½®è®¤è¯æ¨¡å¼å’Œç®€å†å®Œå–„æ¨¡å¼
      if (isNewSelection) {
        setVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
        setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
        setDiscTestMode({ active: false, currentQuestion: 0, answers: [], completed: false });
        setJobSearchMode({ active: false, currentQuestion: 0, answers: [], completed: false, tokenUsed: 0, isSearching: false });
      }
      
      if (!taskMessages[selectedTask.id]) {
        // æ™®é€šä»»åŠ¡åˆå§‹åŒ–æ¶ˆæ¯ï¼ˆåªåœ¨æ²¡æœ‰æ¶ˆæ¯æ—¶åˆå§‹åŒ–ï¼‰
        setTaskMessages(prev => ({
          ...prev,
          [selectedTask.id]: [{
            role: 'assistant',
            content: `ä½ å¥½ï¼æˆ‘æ˜¯ Devnors ä»»åŠ¡æ‰§è¡ŒåŠ©æ‰‹ã€‚å…³äºã€Œ${taskTitle}ã€è¿™é¡¹ä»»åŠ¡ï¼Œæˆ‘å·²ç»å‡†å¤‡å¥½ååŠ©æ‚¨ã€‚${taskAdvice ? `\n\nğŸ’¡ AIå»ºè®®ï¼š${taskAdvice}` : ''}\n\næ‚¨å¯ä»¥å‘Šè¯‰æˆ‘æ‚¨æƒ³è¦å¦‚ä½•æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œæˆ–è€…æœ‰ä»€ä¹ˆå…·ä½“çš„é—®é¢˜éœ€è¦æˆ‘å¸®å¿™è§£ç­”ã€‚`
          }]
        }));
      }
    }
  }, [selectedTask, userRole]);
  
  // æ»šåŠ¨åˆ°åº•éƒ¨
  useEffect(() => {
    scrollRef.current?.scrollTo(0, scrollRef.current.scrollHeight);
  }, [currentMessages, isTyping]);
  
  // æ ¹æ® icon å­—ç¬¦ä¸²è·å–å›¾æ ‡ç»„ä»¶
  const getIconComponent = (iconName: string | undefined) => {
    switch (iconName) {
      case 'UserIcon': return UserIcon;
      case 'Building2': return Building2;
      case 'Calendar': return Calendar;
      case 'Zap': return Zap;
      default: return Calendar;
    }
  };

  const handleSend = async (directMessageOrEvent?: string | React.MouseEvent) => {
    // åŒºåˆ†ç›´æ¥ä¼ å…¥çš„æ¶ˆæ¯å­—ç¬¦ä¸²å’Œ onClick ä¼ å…¥çš„ MouseEvent
    const directMessage = typeof directMessageOrEvent === 'string' ? directMessageOrEvent : undefined;
    const messageToSend = directMessage || inputMessage;
    if (!messageToSend.trim() || isTyping) return;
    
    const userMessage = messageToSend;
    
    // ç¼–è¾‘æ¨¡å¼å¤„ç†
    if (editMode.active && editMode.awaitingInput) {
      const fieldKey = `${editMode.type}_${editMode.field}`;
      const config = EDIT_FIELD_CONFIG[fieldKey];
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      setGeneralMessages(prev => [...prev, {role: 'user', content: userMessage}]);
      setInputMessage('');
      setIsTyping(true);
      
      // éªŒè¯è¾“å…¥
      const validation = config?.validate(userMessage);
      
      if (!validation?.valid) {
        // éªŒè¯å¤±è´¥
        setTimeout(() => {
          setGeneralMessages(prev => [...prev, {
            role: 'assistant',
            content: `âŒ ${validation?.message || 'è¾“å…¥æ ¼å¼ä¸æ­£ç¡®'}\n\nè¯·é‡æ–°è¾“å…¥ï¼Œ${config?.prompt}`
          }]);
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // éªŒè¯æˆåŠŸï¼Œä¿å­˜æ•°æ®
      const saved = await saveEditData(fieldKey, userMessage);
      
      if (saved) {
        setGeneralMessages(prev => [...prev, {
          role: 'assistant',
          content: `âœ… **${config?.label}å·²æ›´æ–°ï¼**\n\næ‚¨è¾“å…¥çš„å†…å®¹ï¼šã€Œ${userMessage}ã€\n\nå·²æˆåŠŸä¿å­˜åˆ°æ‚¨çš„${editMode.type === 'employer' ? 'ä¼ä¸š' : 'èŒä¸š'}ç”»åƒä¸­ã€‚\n\nğŸ“Œ æ‚¨å¯ä»¥ç»§ç»­å®Œå–„å…¶ä»–ä¿¡æ¯ï¼Œæˆ–è¿”å›æŸ¥çœ‹æ›´æ–°åçš„ç”»åƒã€‚`
        }]);
        
        // é€€å‡ºç¼–è¾‘æ¨¡å¼
        setEditMode({ active: false, type: '', field: '', awaitingInput: false });
      } else {
        setGeneralMessages(prev => [...prev, {
          role: 'assistant',
          content: `âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚`
        }]);
      }
      
      setIsTyping(false);
      return;
    }
    
    // è®°å¿†æ“ä½œæŒ‡ä»¤æ£€æµ‹ â€” ä¼˜å…ˆçº§æœ€é«˜ï¼Œåœ¨æ‰€æœ‰æ¨¡å¼ä¹‹å‰æ‹¦æˆª
    const memoryKeywords = ['ä½ è®°å¾—', 'è®°ä½', 'åé¢éƒ½', 'ä»¥åéƒ½', 'æ·»åŠ è®°å¿†', 'åŠ åˆ°è®°å¿†', 'æ·»åŠ æ–°è®°å¿†', 'ä¿å­˜è®°å¿†', 'è®°åˆ°ç”»åƒ', 'å†™å…¥è®°å¿†', 'è®°ä¸‹æ¥', 'å¸®æˆ‘è®°', 'è¯·è®°ä½', 'è®°ä¸€ä¸‹', 'å­˜åˆ°è®°å¿†'];
    const isMemoryRequest = memoryKeywords.some(kw => userMessage.includes(kw));
    
    if (isMemoryRequest) {
      const addUserMsg = (content: string) => {
        if (selectedTask) {
          setTaskMessages(prev => ({ ...prev, [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'user' as const, content}] }));
        } else {
          setGeneralMessages(prev => [...prev, {role: 'user', content}]);
        }
      };
      const addAiMsg = (content: string) => {
        if (selectedTask) {
          setTaskMessages(prev => ({ ...prev, [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'assistant' as const, content}] }));
        } else {
          setGeneralMessages(prev => [...prev, {role: 'assistant', content}]);
        }
      };
      
      addUserMsg(userMessage);
      setInputMessage('');
      setIsTyping(true);
      
      try {
        const recentContext = currentMessages.slice(-6).map(m => `${m.role === 'user' ? 'ç”¨æˆ·' : 'AI'}ï¼š${m.content}`).join('\n');
        const scope = (userRole === 'employer' || userRole === 'recruiter') ? 'employer' : 'candidate';
        const scopeLabel = scope === 'employer' ? 'ä¼ä¸šè®°å¿†' : 'ä¸ªäººè®°å¿†';
        
        const analyzePrompt = `ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½è®°å¿†ç®¡ç†åŠ©æ‰‹ã€‚ç”¨æˆ·å¸Œæœ›å°†æŸäº›åå¥½ã€è¦æ±‚æˆ–è§„åˆ™ä¿å­˜åˆ°è®°å¿†ä¸­ã€‚

æœ€è¿‘çš„å¯¹è¯ä¸Šä¸‹æ–‡ï¼š
${recentContext}

ç”¨æˆ·æœ€æ–°æ¶ˆæ¯ï¼š${userMessage}

è¯·åˆ†æç”¨æˆ·æƒ³è¦è®°ä½çš„æ ¸å¿ƒå†…å®¹ï¼Œè¿”å›JSONæ ¼å¼ï¼ˆç›´æ¥è¿”å›JSONï¼Œä¸è¦åŒ…å«markdownä»£ç å—æ ‡è®°ï¼‰ï¼š
{
  "content": "æç‚¼åçš„è®°å¿†å†…å®¹ï¼ˆç®€æ´ã€æ¸…æ™°ã€å¯æ‰§è¡Œï¼Œ20-80å­—ï¼‰",
  "type": "è®°å¿†åˆ†ç±»ï¼ˆåªèƒ½æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼šrequirement/tech/culture/strategy/experience/skills/preferenceï¼‰",
  "importance": "é‡è¦ç¨‹åº¦ï¼ˆHigh/Medium/Lowï¼‰",
  "summary": "ç”¨ä¸€å¥è¯æ¦‚æ‹¬è¿™æ¡è®°å¿†"
}

æ³¨æ„ï¼š
1. content åº”è¯¥æ˜¯ç²¾ç‚¼åçš„å¯æ‰§è¡Œè§„åˆ™æˆ–åå¥½ï¼Œä¸è¦ç…§æ¬åŸæ–‡
2. type æ ¹æ®å†…å®¹åˆ¤æ–­ï¼šrequirement=æ‹›è˜/å²—ä½è¦æ±‚, tech=æŠ€æœ¯åå¥½, culture=ä¼ä¸šæ–‡åŒ–/å·¥ä½œæ–¹å¼, strategy=æ‹›è˜/é¢è¯•ç­–ç•¥, experience=å·¥ä½œç»éªŒ, skills=æŠ€èƒ½è¦æ±‚, preference=é€šç”¨åå¥½
3. å½“å‰ç”¨æˆ·èº«ä»½æ˜¯${scopeLabel}`;
        
        const result = await chatWithAI({ message: analyzePrompt, context: 'memory_extraction' });
        
        let memoryData: any = null;
        try {
          let responseText = result.response || '';
          responseText = responseText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
          memoryData = JSON.parse(responseText);
        } catch {
          memoryData = {
            content: userMessage.replace(/ä½ è®°å¾—|è®°ä½|åé¢éƒ½|ä»¥åéƒ½|æ·»åŠ è®°å¿†|åŠ åˆ°è®°å¿†|æ·»åŠ æ–°è®°å¿†|ä¿å­˜è®°å¿†|è®°åˆ°ç”»åƒ|å†™å…¥è®°å¿†|è®°ä¸‹æ¥|å¸®æˆ‘è®°|è¯·è®°ä½|è®°ä¸€ä¸‹|å­˜åˆ°è®°å¿†/g, '').trim(),
            type: 'requirement',
            importance: 'Medium',
          };
        }
        
        if (!memoryData.content || memoryData.content.length < 2) {
          addAiMsg(`âš ï¸ æ— æ³•æå–æœ‰æ•ˆçš„è®°å¿†å†…å®¹ã€‚è¯·æ›´æ¸…æ¥šåœ°æè¿°ï¼Œä¾‹å¦‚ï¼š\n\nâ€¢ "è®°ä½ï¼Œæ‹›è˜è–ªèµ„èŒƒå›´æ˜¯2-6K"\nâ€¢ "ä»¥åå‘å¸ƒå²—ä½éƒ½åŠ ä¸Šè¿œç¨‹åŠå…¬"\nâ€¢ "è®°ä½æˆ‘åå¥½985/211å­¦å†"`);
          setIsTyping(false);
          return;
        }
        
        await createMemory({
          type: memoryData.type || 'requirement',
          content: memoryData.content,
          importance: memoryData.importance || 'Medium',
          scope: scope,
        }, userId);
        
        refetchMemories();
        
        const typeLabels: Record<string, string> = {
          requirement: 'ğŸ“‹ è¦æ±‚', tech: 'ğŸ’» æŠ€æœ¯', culture: 'ğŸ¢ æ–‡åŒ–',
          strategy: 'ğŸ¯ ç­–ç•¥', experience: 'ğŸ’¼ ç»éªŒ', skills: 'ğŸ› ï¸ æŠ€èƒ½', preference: 'â­ åå¥½',
        };
        
        addAiMsg(`âœ… **è®°ä¸‹äº†ï¼å·²ä¿å­˜åˆ°${scopeLabel}è®°å¿†**\n\nğŸ“Œ ${memoryData.content}\n\nğŸ·ï¸ åˆ†ç±»ï¼š${typeLabels[memoryData.type] || memoryData.type} Â· å¼ºåº¦ï¼šÃ—1\n\nåç»­ç›¸å…³ä»»åŠ¡ä¼šè‡ªåŠ¨å‚è€ƒè¿™æ¡è®°å¿†ã€‚`);
      } catch (error) {
        console.error('ä¿å­˜è®°å¿†å¤±è´¥:', error);
        addAiMsg(`âŒ ä¿å­˜è®°å¿†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚`);
      } finally {
        setIsTyping(false);
      }
      return;
    }
    
    // æ±‚èŒç”³è¯·æ¨¡å¼å¤„ç†
    if (applyMode.active) {
      setInputMessage('');
      const handled = await handleApplyProcess(userMessage);
      if (handled) return;
    }
    
    // æ‹›è˜å‘å¸ƒæ¨¡å¼å¤„ç†
    if (postMode.active) {
      setInputMessage('');
      const handled = await handlePostProcess(userMessage);
      if (handled) return;
    }
    
    // é‚€è¯·å¥½å‹æ¨¡å¼å¤„ç†
    if (inviteMode.active) {
      setInputMessage('');
      const handled = await handleInviteProcess(userMessage);
      if (handled) return;
    }
    
    // æ£€æµ‹ç”¨æˆ·æ˜¯å¦æœ‰æ‰¾å·¥ä½œæ„å›¾
    const jobSearchKeywords = ['æ‰¾å·¥ä½œ', 'æ±‚èŒ', 'æ‰¾ä¸ªå·¥ä½œ', 'æƒ³æ¢å·¥ä½œ', 'å¼€å§‹æ±‚èŒ', 'æŠ•ç®€å†', 'åº”è˜', 'æ‰¾ä»½å·¥ä½œ', 'æƒ³è·³æ§½', 'çœ‹æœºä¼š', 'çœ‹çœ‹æœºä¼š', 'æƒ³æ‰¾', 'æ‰¾ä¸€ä»½'];
    const isJobSearchRequest = jobSearchKeywords.some(kw => userMessage.includes(kw)) && userRole === 'candidate';
    
    if (isJobSearchRequest && !jobSearchMode.active) {
      setInputMessage('');
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      if (selectedTask) {
        setTaskMessages(prev => ({
          ...prev,
          [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'user' as const, content: userMessage}]
        }));
      } else {
        setGeneralMessages(prev => [...prev, {role: 'user', content: userMessage}]);
      }
      
      setIsTyping(true);
      
      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å®Œæˆäº†å¿…è¦çš„ä»»åŠ¡
      const checkPrerequisites = async () => {
        try {
          // åŠ¨æ€å¯¼å…¥APIå‡½æ•°
          const { getPersonalCertifications, getTasks, createTodo, getMemories } = await import('./services/apiService');
          
          // è·å–ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨
          const userTasks = await getTasks(userId);
          
          // æ£€æŸ¥ç®€å†å®Œå–„ä»»åŠ¡
          const profileTask = userTasks.find((t: any) => 
            t.title === 'å®Œå–„ç®€å†èµ„æ–™' || t.todo_type === 'profile_complete'
          );
          const isProfileCompleted = profileTask?.status?.toLowerCase() === 'completed' || profileTask?.progress >= 100;
          
          // æ£€æŸ¥èº«ä»½è®¤è¯ - ä»ä¸ªäººè®¤è¯æ•°æ®ä¸­æ£€æŸ¥
          const certifications = await getPersonalCertifications(userId);
          const hasIdentityVerification = certifications.some((c: any) => 
            c.category === 'identity'
          );
          
          const addMsg = (content: string) => {
            if (selectedTask) {
              setTaskMessages(prev => ({
                ...prev,
                [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'assistant' as const, content}]
              }));
            } else {
              setGeneralMessages(prev => [...prev, {role: 'assistant', content}]);
            }
          };
          
          if (!isProfileCompleted) {
            // ç®€å†æœªå®Œæˆï¼Œå¼•å¯¼ç”¨æˆ·å…ˆå®Œå–„ç®€å†
            const guideMsg = `ğŸ‘‹ å¾ˆé«˜å…´æ‚¨æƒ³è¦å¼€å§‹æ±‚èŒï¼\n\nä¸è¿‡ï¼Œæˆ‘å‘ç°æ‚¨çš„**ç®€å†èµ„æ–™è¿˜æœªå®Œå–„**ã€‚ä¸ºäº†èƒ½å¤Ÿå¸®æ‚¨æ›´ç²¾å‡†åœ°åŒ¹é…åˆé€‚çš„å²—ä½ï¼Œå»ºè®®æ‚¨å…ˆå®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š\n\nğŸ“‹ **ç¬¬ä¸€æ­¥ï¼šå®Œå–„ç®€å†èµ„æ–™**\nå¡«å†™å®Œæ•´çš„ä¸ªäººä¿¡æ¯ï¼Œè®©æ‹›è˜æ–¹æ›´å¥½åœ°äº†è§£æ‚¨\n\n[[TASK:å®Œå–„ç®€å†èµ„æ–™:profile_complete:FileText]]\n\nå®Œæˆç®€å†åï¼Œæˆ‘å°±å¯ä»¥å¸®æ‚¨å¼€å§‹æ™ºèƒ½æ±‚èŒå•¦ï¼`;
            addMsg(guideMsg);
            setIsTyping(false);
            return;
          }
          
          if (!hasIdentityVerification) {
            // èº«ä»½è®¤è¯æœªå®Œæˆ
            const guideMsg = `ğŸ‘‹ å¾ˆé«˜å…´æ‚¨æƒ³è¦å¼€å§‹æ±‚èŒï¼\n\næ‚¨çš„ç®€å†å·²å®Œå–„ï¼Œä½†è¿˜éœ€è¦å®Œæˆ**èº«ä»½è®¤è¯**æ‰èƒ½å¼€å§‹æŠ•é€’ã€‚èº«ä»½è®¤è¯å¯ä»¥æé«˜æ‚¨çš„å¯ä¿¡åº¦ï¼Œè®©æ‹›è˜æ–¹æ›´æ”¾å¿ƒã€‚\n\nğŸ†” **è¯·å…ˆå®Œæˆèº«ä»½è®¤è¯**\n\n[[TASK:å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯:personal_verification:Shield]]\n\nå®Œæˆèº«ä»½è®¤è¯åï¼Œæˆ‘å°±å¯ä»¥å¸®æ‚¨å¼€å§‹æ™ºèƒ½æ±‚èŒå•¦ï¼`;
            addMsg(guideMsg);
            setIsTyping(false);
            return;
          }
          
          // å‰ç½®æ¡ä»¶æ»¡è¶³ï¼Œæ£€æŸ¥æ˜¯å¦å·²æœ‰è¿è¡Œä¸­çš„äº‘ç«¯è½®å·¡ä»»åŠ¡
          const existingJobTask = userTasks.find((t: any) => 
            t.title?.includes('äº‘ç«¯æ±‚èŒè½®å·¡') && 
            (t.status?.toUpperCase() === 'RUNNING' || t.status?.toUpperCase() === 'PENDING')
          );
          
          if (existingJobTask) {
            // å·²æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œä½¿ç”¨å¡ç‰‡å¼•å¯¼
            addMsg(`ğŸ”” **æ£€æµ‹åˆ°æ‚¨å·²æœ‰è¿è¡Œä¸­çš„äº‘ç«¯æ±‚èŒè½®å·¡ä»»åŠ¡ï¼**\n\nä»»åŠ¡çŠ¶æ€ï¼šğŸŸ¢ è¿è¡Œä¸­\n\nç‚¹å‡»ä¸‹æ–¹å¡ç‰‡æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…ï¼š\n\n[[TASK:${existingJobTask.title}:cloud_job:ğŸš€]]`);
            setIsTyping(false);
            return;
          }
          
          // æ£€æŸ¥æ±‚èŒåå¥½
          const memories = await getMemories(userId);
          const oneMonthAgo = new Date();
          oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
          
          const recentJobPreference = memories.find((m: any) => {
            if (m.type?.toLowerCase() !== 'preference' || !m.content?.includes('æ±‚èŒåå¥½')) return false;
            const memoryDate = parseUTC(m.created_at || m.createdAt);
            return memoryDate > oneMonthAgo;
          });
          
          // æ ¹æ®ç”¨æˆ·å®é™… account_tier è·å–ä¼šå‘˜ç­‰çº§
          const tier = (user?.account_tier || 'FREE').toUpperCase();
          const userMembership = tier === 'ULTRA' ? 'ultra' : tier === 'PRO' ? 'pro' : 'basic';
          const membershipConfig: Record<string, {name: string; days: number; color: string}> = {
            'basic': { name: 'Devnors 1.0', days: 1, color: 'slate' },
            'pro': { name: 'Devnors 1.0 Pro', days: 7, color: 'indigo' },
            'ultra': { name: 'Devnors 1.0 Ultra', days: 30, color: 'amber' }
          };
          const membership = membershipConfig[userMembership] || membershipConfig['basic'];
          
          // ç”Ÿæˆä»»åŠ¡ID
          const taskId = `JOB_${Date.now()}_${userId}`;
          const taskShortId = taskId.slice(-6);
          
          // åˆ›å»ºæ–°çš„äº‘ç«¯è½®å·¡ä»»åŠ¡
          addMsg(`ğŸ¯ **æ™ºèƒ½æ±‚èŒåŠ©æ‰‹å¯åŠ¨ï¼**\n\nå¤ªæ£’äº†ï¼æ‚¨å·²å®Œæˆç®€å†å’Œèº«ä»½è®¤è¯ã€‚\n\nâ³ æ­£åœ¨ä¸ºæ‚¨åˆ›å»ºäº‘ç«¯æ±‚èŒè½®å·¡ä»»åŠ¡...`);
          
          // åˆ›å»ºä»»åŠ¡
          let newTask: any = null;
          try {
            newTask = await createTodo({
              title: `äº‘ç«¯æ±‚èŒè½®å·¡ #${taskShortId}`,
              description: `${membership.name} - ${membership.days}å¤©åœ¨çº¿è½®å·¡æŠ•é€’`,
              priority: 'HIGH',
              status: recentJobPreference ? 'RUNNING' : 'PENDING',
              progress: 0,
              source: 'AGENT',
              todo_type: 'CANDIDATE',
              icon: 'Rocket',
              user_id: userId,
            });
            console.log('[JobSearch] äº‘ç«¯è½®å·¡ä»»åŠ¡åˆ›å»ºæˆåŠŸ:', newTask);
            
            if (typeof refetchTasks === 'function') {
              await refetchTasks();
            }
          } catch (e) {
            console.error('åˆ›å»ºè½®å·¡ä»»åŠ¡å¤±è´¥:', e);
            addMsg(`âŒ åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚`);
            setIsTyping(false);
            return;
          }
          
          // å»¶è¿Ÿååˆ‡æ¢åˆ°æ–°ä»»åŠ¡
          setTimeout(async () => {
            // é‡æ–°è·å–ä»»åŠ¡åˆ—è¡¨ä»¥è·å¾—æ–°ä»»åŠ¡çš„å®Œæ•´ä¿¡æ¯
            const updatedTasks = await getTasks(userId);
            const createdTask = updatedTasks.find((t: any) => t.title?.includes(taskShortId));
            
            if (createdTask) {
              addMsg(`âœ… **äº‘ç«¯æ±‚èŒè½®å·¡ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼**\n\nğŸ–ï¸ ä¼šå‘˜ç­‰çº§ï¼š${membership.name}\nâ±ï¸ è½®å·¡å‘¨æœŸï¼š${membership.days} å¤©\n\nç‚¹å‡»ä¸‹æ–¹å¡ç‰‡è¿›å…¥ä»»åŠ¡ï¼š\n\n[[TASK:${createdTask.title}:cloud_job:ğŸš€]]`);
              setIsTyping(false);
            } else {
              addMsg(`âœ… **äº‘ç«¯æ±‚èŒè½®å·¡ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼**\n\nğŸ–ï¸ ä¼šå‘˜ç­‰çº§ï¼š${membership.name}\nâ±ï¸ è½®å·¡å‘¨æœŸï¼š${membership.days} å¤©\n\nç‚¹å‡»ä¸‹æ–¹å¡ç‰‡è¿›å…¥ä»»åŠ¡ï¼š\n\n[[TASK:äº‘ç«¯æ±‚èŒè½®å·¡ #${taskShortId}:cloud_job:ğŸš€]]`);
              setIsTyping(false);
            }
          }, 1000);
          
        } catch (err: any) {
          console.error('æ£€æŸ¥æ±‚èŒå‰ç½®æ¡ä»¶å¤±è´¥:', err);
          console.error('é”™è¯¯è¯¦æƒ…:', err?.message, err?.stack);
          const errorMsg = `æŠ±æ­‰ï¼Œæ£€æŸ¥æ‚¨çš„èµ„æ–™æ—¶é‡åˆ°äº†é—®é¢˜ï¼š${err?.message || 'æœªçŸ¥é”™è¯¯'}ã€‚è¯·ç¨åå†è¯•ï¼Œæˆ–å…ˆç¡®ä¿æ‚¨å·²å®Œå–„ç®€å†å’Œèº«ä»½è®¤è¯ã€‚`;
          if (selectedTask) {
            setTaskMessages(prev => ({
              ...prev,
              [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'assistant' as const, content: errorMsg}]
            }));
          } else {
            setGeneralMessages(prev => [...prev, {role: 'assistant', content: errorMsg}]);
          }
        }
        setIsTyping(false);
      };
      
      checkPrerequisites();
      return;
    }
    
    // æ£€æµ‹ç”¨æˆ·æ˜¯å¦æƒ³è¦å®Œå–„ç®€å†
    const profileKeywords = ['å®Œå–„ç®€å†', 'å¡«å†™ç®€å†', 'æ›´æ–°ç®€å†', 'å®Œå–„èµ„æ–™', 'è¡¥å……ä¿¡æ¯', 'è¡¥å……ç®€å†', 'å¼€å§‹å¡«å†™', 'å®Œå–„ä¸ªäºº'];
    const isProfileRequest = profileKeywords.some(kw => userMessage.includes(kw));
    
    console.log('[handleSend] Checking profile request:', {
      userMessage,
      isProfileRequest,
      userRole,
      profileCompleteModeActive: profileCompleteMode.active
    });
    
    if (isProfileRequest && userRole === 'candidate' && !profileCompleteMode.active) {
      console.log('[handleSend] Starting profile guide flow');
      setInputMessage('');
      // æ ¹æ®æ˜¯å¦æœ‰é€‰ä¸­ä»»åŠ¡ï¼Œæ·»åŠ åˆ°å¯¹åº”çš„æ¶ˆæ¯åˆ—è¡¨
      if (selectedTask) {
        setTaskMessages(prev => ({
          ...prev,
          [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'user' as const, content: userMessage}]
        }));
        // ä½¿ç”¨ä»»åŠ¡æ¨¡å¼çš„å¼•å¯¼æµç¨‹
        startProfileCompleteGuide(true);
      } else {
        setGeneralMessages(prev => [...prev, {role: 'user', content: userMessage}]);
        // ä½¿ç”¨éä»»åŠ¡æ¨¡å¼çš„å¼•å¯¼æµç¨‹
        startProfileCompleteGuide(false);
      }
      return;
    }
    
    // æ£€æµ‹ä¼ä¸šç”¨æˆ·æ˜¯å¦æƒ³è¦å®Œå–„ä¼ä¸šèµ„æ–™
    const enterpriseProfileKeywords = ['å®Œå–„ä¼ä¸š', 'å®Œå–„å…¬å¸', 'ä¼ä¸šèµ„æ–™', 'ä¼ä¸šä¿¡æ¯', 'å…¬å¸ä¿¡æ¯', 'å®Œå–„èµ„æ–™'];
    const isEnterpriseProfileRequest = enterpriseProfileKeywords.some(kw => userMessage.includes(kw));
    
    if (isEnterpriseProfileRequest && (userRole === 'employer' || userRole === 'recruiter') && !enterpriseProfileMode.active) {
      console.log('[handleSend] Starting enterprise profile guide flow');
      setInputMessage('');
      if (selectedTask) {
        setTaskMessages(prev => ({
          ...prev,
          [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'user' as const, content: userMessage}]
        }));
        startEnterpriseProfileGuide(true);
      } else {
        setGeneralMessages(prev => [...prev, {role: 'user', content: userMessage}]);
        startEnterpriseProfileGuide(false);
      }
      return;
    }
    
    // æ£€æµ‹ä¼ä¸šç”¨æˆ·æ˜¯å¦æƒ³è¦æ‹›è˜
    const recruitKeywords = ['æ‹›è˜', 'æ‹›äºº', 'å‘å¸ƒå²—ä½', 'å‘å¸ƒèŒä½', 'å¼€å§‹æ‹›è˜', 'æ‹›ä¸ª', 'æ‹›ä¸€ä¸ª', 'æƒ³æ‹›', 'è¦æ‹›', 'éœ€è¦æ‹›', 'æ‹›å‡ ä¸ª', 'å‘å¸ƒæ‹›è˜', 'æ‰¾äºº', 'ç¼ºäºº', 'æ‹›å·¥', 'å‘JD', 'å‘jd'];
    const isRecruitRequest = recruitKeywords.some(kw => userMessage.includes(kw)) && (userRole === 'employer' || userRole === 'recruiter');
    
    if (isRecruitRequest && !postMode.active) {
      setInputMessage('');
      setGeneralMessages(prev => [...prev, {role: 'user', content: userMessage}]);
      setIsTyping(true);
      
      // å‰ç½®æ¡ä»¶æ£€æŸ¥
      const checkRecruitPrerequisites = async () => {
        try {
          const { getEnterpriseCertifications, getSettings, getTasks } = await import('./services/apiService');
          const [certifications, settingsData, tasks] = await Promise.all([
            getEnterpriseCertifications(userId).catch(() => []),
            getSettings(userId).catch(() => ({})),
            getTasks(userId).catch(() => []),
          ]);
          
          const hasBusinessLicense = certifications.some((c: any) => c.category === 'qualification' && c.name?.includes('è¥ä¸šæ‰§ç…§'));
          const certTask = tasks.find((t: any) => t.title === 'å®Œæˆä¼ä¸šè®¤è¯' || (t.title?.includes('ä¼ä¸š') && t.title?.includes('è®¤è¯')));
          const certCompleted = hasBusinessLicense || certTask?.status?.toLowerCase() === 'completed';
          
          const requiredFields = ['display_name', 'industry', 'company_size', 'detail_address', 'description'];
          const hasValue = (val: any) => val && typeof val === 'string' ? val.trim() !== '' && val.trim() !== '[]' && val.trim() !== '{}' : !!val;
          const missingProfileFields = requiredFields.filter(k => !hasValue(settingsData[k]));
          const profileCompleted = missingProfileFields.length === 0;
          
          if (!certCompleted || !profileCompleted) {
            const issues: string[] = [];
            if (!certCompleted) issues.push('â€¢ **ä¼ä¸šè®¤è¯æœªå®Œæˆ** â€” è¯·å…ˆå‰å¾€ [ä¼ä¸šè®¤è¯ä¿¡æ¯](/settings?tab=Verification) ä¸Šä¼ è¥ä¸šæ‰§ç…§ç­‰è®¤è¯ææ–™\n\n[[TASK:å®Œæˆä¼ä¸šè®¤è¯:enterprise_verification:ğŸ¢]]');
            if (!profileCompleted) issues.push('â€¢ **ä¼ä¸šèµ„æ–™æœªå®Œå–„** â€” è¿˜éœ€è¡¥å……ï¼š' + missingProfileFields.map(k => {
              const labels: Record<string, string> = { display_name: 'ä¼ä¸šå…¨ç§°', industry: 'æ‰€å±è¡Œä¸š', company_size: 'ä¼ä¸šè§„æ¨¡', detail_address: 'å…¬å¸åœ°å€', description: 'ä¼ä¸šç®€ä»‹' };
              return labels[k] || k;
            }).join('ã€') + '\n\n[[TASK:å®Œå–„ä¼ä¸šèµ„æ–™:enterprise_profile:ğŸ“‹]]');
            
            setGeneralMessages(prev => [...prev, {role: 'assistant', content: `ğŸ‘‹ æ”¶åˆ°æ‚¨çš„æ‹›è˜éœ€æ±‚ï¼\n\nä¸è¿‡åœ¨å¼€å§‹æ‹›è˜å‰ï¼Œéœ€è¦å…ˆå®Œæˆä»¥ä¸‹å‡†å¤‡å·¥ä½œï¼Œä»¥ä¿éšœæ‹›è˜è´¨é‡å’Œä¼ä¸šå¯ä¿¡åº¦ï¼š\n\n${issues.join('\n\n')}\n\nå®Œæˆåå†å‘Šè¯‰æˆ‘æ‚¨çš„æ‹›è˜éœ€æ±‚ï¼Œæˆ‘å°±èƒ½å¸®æ‚¨æ™ºèƒ½ç”Ÿæˆå²—ä½å¹¶å‘å¸ƒäº†ï¼`}]);
            setIsTyping(false);
            return;
          }
          
          // å‰ç½®æ¡ä»¶æ»¡è¶³ â€” æ£€æŸ¥æ‹›è˜ä»»åŠ¡æ•°é‡é™åˆ¶
          const pendingRecruits = tasks.filter((t: any) => 
            (t.todo_type?.toUpperCase() === 'RECRUIT' || t.title?.includes('æ™ºèƒ½æ‹›è˜')) &&
            t.status?.toUpperCase() !== 'COMPLETED' && t.status?.toUpperCase() !== 'CANCELLED'
          );
          const recruitLimits: Record<string, number> = { FREE: 1, PRO: 3, ULTRA: 10 };
          const curTier = user?.account_tier || 'FREE';
          const maxTasks = recruitLimits[curTier] || 1;
          
          if (pendingRecruits.length >= maxTasks) {
            const taskNames = pendingRecruits.map((t: any) => `â€¢ **${t.title}**`).join('\n');
            const tierLabel = curTier === 'ULTRA' ? 'æ——èˆ°ç‰ˆ' : curTier === 'PRO' ? 'ä¸“ä¸šç‰ˆ' : 'åŸºç¡€ç‰ˆ';
            setGeneralMessages(prev => [...prev, {
              role: 'assistant',
              content: `âš ï¸ **æ‹›è˜ä»»åŠ¡æ•°é‡å·²è¾¾ä¸Šé™**\n\næ‚¨å½“å‰çš„${tierLabel}æ–¹æ¡ˆæœ€å¤šåŒæ—¶è¿›è¡Œ **${maxTasks}** ä¸ªæ‹›è˜ä»»åŠ¡ï¼Œç›®å‰å·²æœ‰ ${pendingRecruits.length} ä¸ªæœªå®Œæˆï¼š\n\n${taskNames}\n\nè¯·å…ˆå®Œæˆæˆ–å–æ¶ˆå·²æœ‰çš„æ‹›è˜ä»»åŠ¡åï¼Œå†åˆ›å»ºæ–°çš„æ‹›è˜ä»»åŠ¡ã€‚${curTier !== 'ULTRA' ? `\n\nğŸ’¡ å‡çº§æ–¹æ¡ˆå¯è§£é”æ›´å¤šå¹¶è¡Œæ‹›è˜ä»»åŠ¡æ•°é‡ã€‚\n\n[[LINK:å‡çº§æ–¹æ¡ˆ:/pricing:âš¡]]` : ''}`
            }]);
            setIsTyping(false);
            return;
          }
          
          // åˆ›å»ºæ‹›è˜ä»»åŠ¡å¹¶è‡ªåŠ¨è·³è½¬åˆ°è¯¥ä»»åŠ¡
          const companyName = settingsData.display_name || settingsData.short_name || user?.company_name || 'è´µå…¬å¸';
          
          try {
            const { createTodo } = await import('./services/apiService');
            let recruitTask: any = null;
            {
              const taskShortId = `RC${Date.now().toString().slice(-6)}`;
              recruitTask = await createTodo({
                title: `æ™ºèƒ½æ‹›è˜ #${taskShortId}`,
                description: 'AI æ™ºèƒ½æ‹›è˜åŠ©æ‰‹ â€” ä»éœ€æ±‚åˆ°äººæ‰å¯¹æ¥çš„å…¨æµç¨‹æ‹›è˜',
                priority: 'HIGH',
                source: 'AGENT',
                todo_type: 'RECRUIT',
                ai_advice: 'å‘Šè¯‰ AI åŠ©æ‰‹æ‚¨çš„æ‹›è˜éœ€æ±‚ï¼ŒAI å°†ä¸ºæ‚¨è‡ªåŠ¨ç”Ÿæˆå²—ä½ã€åŒ¹é…å€™é€‰äººã€ç­›é€‰è¯„ä¼°ç›´åˆ°åŒæ–¹å»ºç«‹è”ç³»ã€‚',
                steps: [
                  { step: 1, title: 'æè¿°æ‹›è˜éœ€æ±‚', status: 'pending' },
                  { step: 2, title: 'AI ç”Ÿæˆå²—ä½', status: 'pending' },
                  { step: 3, title: 'ç¡®è®¤å¹¶å‘å¸ƒ', status: 'pending' },
                  { step: 4, title: 'æ™ºèƒ½é‚€è¯·æŠ•é€’', status: 'pending' },
                  { step: 5, title: 'æ™ºèƒ½ç­›é€‰è¯„ä¼°', status: 'pending' },
                ],
              }, userId);
              if (typeof refetchTasks === 'function') refetchTasks();
            }
            
            // å¦‚æœç”¨æˆ·æ¶ˆæ¯ä¸­å·²ç»åŒ…å«äº†å…·ä½“éœ€æ±‚ï¼Œå…ˆè®°å½•åˆ°é€šç”¨æ¶ˆæ¯ï¼Œå†è·³è½¬
            const hasSpecificNeed = userMessage.length > 10 && (
              userMessage.includes('å·¥ç¨‹å¸ˆ') || userMessage.includes('ç»ç†') || userMessage.includes('è®¾è®¡') ||
              userMessage.includes('å¼€å‘') || userMessage.includes('è¿è¥') || /\d+[kK]/.test(userMessage) ||
              userMessage.includes('ç»éªŒ') || userMessage.includes('å¹´')
            );
            
            // é€šç”¨åŠ©æ‰‹æ˜¾ç¤ºç®€çŸ­æç¤º + è·³è½¬é€šçŸ¥
            setGeneralMessages(prev => [...prev, {
              role: 'assistant', 
              content: `âœ… **${companyName}** ä¼ä¸šè®¤è¯å’Œèµ„æ–™å‡å·²å®Œå–„ï¼\n\nğŸš€ æ­£åœ¨ä¸ºæ‚¨è·³è½¬åˆ°ã€Œæ™ºèƒ½æ‹›è˜ã€ä»»åŠ¡...`
            }]);
            setIsTyping(false);
            
            // çŸ­æš‚å»¶è¿Ÿåè‡ªåŠ¨è·³è½¬åˆ°æ‹›è˜ä»»åŠ¡
            setTimeout(() => {
              if (recruitTask) {
                setSelectedTask(recruitTask);
                // å¦‚æœå¸¦æœ‰å…·ä½“éœ€æ±‚ï¼Œåœ¨è·³è½¬åè‡ªåŠ¨å°†éœ€æ±‚ä¼ å…¥å¤„ç†
                if (hasSpecificNeed) {
                  setTimeout(() => {
                    handlePostProcess(userMessage);
                  }, 1500);
                }
              }
            }, 600);
          } catch (e) {
            console.error('åˆ›å»ºæ‹›è˜ä»»åŠ¡å¤±è´¥:', e);
            // é™çº§ï¼šæ— æ³•è·³è½¬æ—¶å°±åœ¨é€šç”¨åŠ©æ‰‹ä¸­å¼•å¯¼
            setPostMode({ active: true, step: 'requirement', jobDescription: '', generatedResult: null });
            setGeneralMessages(prev => [...prev, {
              role: 'assistant',
              content: `âœ… **${companyName}** ä¼ä¸šè®¤è¯å’Œèµ„æ–™å‡å·²å®Œå–„ï¼Œå¯ä»¥å¼€å§‹æ‹›è˜ï¼\n\nè¯·å‘Šè¯‰æˆ‘æ‚¨çš„æ‹›è˜éœ€æ±‚ï¼Œä¾‹å¦‚ï¼š\n\n> "æ‹›è˜é«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆï¼Œ3å¹´ä»¥ä¸ŠReactç»éªŒ"\n\nğŸ’¡ æè¿°è¶Šè¯¦ç»†ï¼Œç”Ÿæˆçš„å²—ä½è¶Šç²¾å‡†ï¼`
            }]);
            setIsTyping(false);
          }
        } catch (err) {
          console.error('æ£€æŸ¥æ‹›è˜å‰ç½®æ¡ä»¶å¤±è´¥:', err);
          setGeneralMessages(prev => [...prev, {role: 'assistant', content: `âš ï¸ æ£€æŸ¥æ‹›è˜èµ„è´¨æ—¶å‡ºç°å¼‚å¸¸ï¼š${(err as any)?.message || 'æœªçŸ¥é”™è¯¯'}ã€‚è¯·ç¨åé‡è¯•ã€‚`}]);
          setIsTyping(false);
        }
      };
      
      checkRecruitPrerequisites();
      return;
    }
    
    // å®Œå–„ç®€å†æ¨¡å¼å¤„ç†
    if (profileCompleteMode.active) {
      setInputMessage('');
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å½“å‰å¯¹è¯
      const addUserMessage = (content: string) => {
        if (selectedTask) {
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'user' as const, content}]
          }));
        } else {
          setGeneralMessages(prev => [...prev, {role: 'user' as const, content}]);
        }
      };
      
      // æ·»åŠ  AI æ¶ˆæ¯åˆ°å½“å‰å¯¹è¯
      const addAssistantMessage = (content: string) => {
        if (selectedTask) {
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'assistant' as const, content}]
          }));
        } else {
          setGeneralMessages(prev => [...prev, {role: 'assistant' as const, content}]);
        }
      };
      
      addUserMessage(userMessage);
      setIsTyping(true);
      
      // ç”¨æˆ·è¾“å…¥äº†è·³è¿‡å½“å‰å­—æ®µ
      if (userMessage.includes('è·³è¿‡')) {
        const currentIndex = profileCompleteMode.currentFieldIndex;
        const currentField = profileCompleteMode.missingFields[currentIndex];
        const nextIndex = currentIndex + 1;
        const totalFields = profileCompleteMode.missingFields.length;
        
        setTimeout(async () => {
          if (nextIndex >= totalFields) {
            // æ‰€æœ‰å­—æ®µéƒ½å·²å¤„ç†ï¼ˆè·³è¿‡æˆ–å¡«å†™ï¼‰
            const progress = await calculateProfileTaskProgress();
            addAssistantMessage(`â­ï¸ å·²è·³è¿‡ã€Œ${currentField?.label}ã€\n\n---\n\nğŸ“‹ **ç®€å†å®Œå–„æµç¨‹ç»“æŸ**\n\nå½“å‰å®Œå–„åº¦ï¼š**${progress}%**\n\n${progress < 100 ? 'ğŸ’¡ æç¤ºï¼šå®Œå–„æ›´å¤šèµ„æ–™å¯ä»¥è·å¾—æ›´å¤šé¢è¯•æœºä¼šï¼\n\næ‚¨å¯ä»¥éšæ—¶å‘é€"å®Œå–„ç®€å†"ç»§ç»­è¡¥å……ä¿¡æ¯ã€‚' : 'ğŸ‰ æ‚¨çš„ç®€å†å·²å®Œå–„ï¼'}\n\nè¿˜æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`);
            setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
          } else {
            // è·³è¿‡å½“å‰å­—æ®µï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
            const nextField = profileCompleteMode.missingFields[nextIndex];
            const skippedCount = currentIndex + 1;
            addAssistantMessage(`â­ï¸ å·²è·³è¿‡ã€Œ${currentField?.label}ã€ (${skippedCount}/${totalFields})\n\n---\n\nğŸ“ **ç»§ç»­å¡«å†™ç¬¬ ${nextIndex + 1} é¡¹ï¼š${nextField.label}**\n\n${getFieldPrompt(nextField.key)}\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹ï¼Œè¾“å…¥ "é€€å‡º" å¯ä»¥ç»“æŸå¡«å†™æµç¨‹\nğŸ“ å¿«æ·æ–¹å¼ï¼šç‚¹å‡»å·¦ä¸‹è§’ä¸Šä¼ ç®€å†ï¼ŒAI è‡ªåŠ¨è§£æå¡«å……`);
            setProfileCompleteMode(prev => ({
              ...prev,
              currentFieldIndex: nextIndex
            }));
          }
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // ç”¨æˆ·æƒ³é€€å‡ºæ•´ä¸ªæµç¨‹
      if (userMessage.includes('é€€å‡º') || userMessage.includes('å–æ¶ˆ') || userMessage.includes('ç¨å')) {
        setTimeout(async () => {
          const progress = await calculateProfileTaskProgress();
          addAssistantMessage(`å¥½çš„ï¼Œæ‚¨å¯ä»¥ç¨åç»§ç»­å®Œå–„ç®€å†ã€‚\n\nå½“å‰å®Œå–„åº¦ï¼š**${progress}%**\n\nğŸ’¡ æç¤ºï¼šå®Œå–„çš„ç®€å†å¯ä»¥å¸®åŠ©æ‚¨è·å¾—æ›´å¤šé¢è¯•æœºä¼šï¼\n\nè¿˜æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`);
          setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç¡®è®¤è¦†ç›–å·²æœ‰å€¼
      const confirmKeywords = ['ç¡®è®¤', 'è¦†ç›–', 'æ˜¯', 'ä¿®æ”¹', 'æ›´æ–°', 'yes', 'ok'];
      const cancelKeywords = ['å–æ¶ˆ', 'ä¸', 'å¦', 'ä¿ç•™', 'no', 'cancel'];
      
      // å¦‚æœæœ‰å¾…ç¡®è®¤è¦†ç›–çš„å­—æ®µ
      if ((profileCompleteMode as any).pendingOverwrite) {
        const pending = (profileCompleteMode as any).pendingOverwrite;
        const isConfirm = confirmKeywords.some(kw => userMessage.toLowerCase().includes(kw));
        const isCancel = cancelKeywords.some(kw => userMessage.toLowerCase().includes(kw));
        
        if (isConfirm) {
          // ç”¨æˆ·ç¡®è®¤è¦†ç›–
          try {
            const { updateProfileField } = await import('./services/apiService');
            await updateProfileField(userId, 'candidate', pending.field, pending.value, true); // force_update = true
            
            const currentIndex = profileCompleteMode.currentFieldIndex;
            const nextIndex = currentIndex + 1;
            const totalFields = profileCompleteMode.missingFields.length;
            
            setTimeout(async () => {
              await calculateProfileTaskProgress();
              
              if (nextIndex >= totalFields) {
                // æ‰€æœ‰å­—æ®µéƒ½å·²å¤„ç†
                const progress = await calculateProfileTaskProgress();
                addAssistantMessage(`âœ… **${pending.label}å·²æ›´æ–°ï¼**\n\næ—§å€¼ï¼š${pending.existingValue}\næ–°å€¼ï¼š${pending.value}\n\n---\n\nğŸ‰ **æ­å–œï¼æ‚¨çš„ç®€å†èµ„æ–™å·²å…¨éƒ¨å®Œå–„ï¼**\n\nâœ¨ ç®€å†å®Œå–„åº¦ï¼š**${progress}%**\n\nç°åœ¨æ‚¨å¯ä»¥ï¼š\nâ€¢ å‰å¾€ [ä¸ªäººä¸»é¡µ](/candidate/profile) æŸ¥çœ‹å’Œå¾®è°ƒ\n\nå®Œæˆä¸ªäººè®¤è¯ä¿¡æ¯ï¼Œæé«˜æ±‚èŒæœºä¼šï¼š\n\n[[TASK:å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯:personal_verification:ğŸ”]]\n\nç¥æ‚¨æ±‚èŒé¡ºåˆ©ï¼ğŸš€`);
                setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
              } else {
                // ç»§ç»­ä¸‹ä¸€ä¸ªå­—æ®µ
                const nextField = profileCompleteMode.missingFields[nextIndex];
                const completedCount = nextIndex;
                const progressPercent = Math.round((completedCount / totalFields) * 100);
                
                addAssistantMessage(`âœ… **${pending.label}å·²æ›´æ–°ï¼** (${completedCount}/${totalFields})\n\nğŸ“Š å®Œå–„è¿›åº¦ï¼š${'â–ˆ'.repeat(Math.floor(progressPercent / 10))}${'â–‘'.repeat(10 - Math.floor(progressPercent / 10))} ${progressPercent}%\n\n---\n\nğŸ“ **ç»§ç»­å¡«å†™ç¬¬ ${nextIndex + 1} é¡¹ï¼š${nextField.label}**\n\n${getFieldPrompt(nextField.key)}\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹`);
                
                // æ¸…é™¤å¾…è¦†ç›–çŠ¶æ€ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªå­—æ®µ
                setProfileCompleteMode(prev => {
                  const newState = { ...prev };
                  delete (newState as any).pendingOverwrite;
                  return {
                    ...newState,
                    currentFieldIndex: nextIndex
                  };
                });
              }
              setIsTyping(false);
            }, 500);
          } catch (e) {
            addAssistantMessage(`âŒ æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚`);
            setIsTyping(false);
          }
          return;
        } else if (isCancel) {
          // ç”¨æˆ·å–æ¶ˆï¼Œè·³è¿‡æ­¤å­—æ®µ
          const currentIndex = profileCompleteMode.currentFieldIndex;
          const nextIndex = currentIndex + 1;
          const totalFields = profileCompleteMode.missingFields.length;
          
          setTimeout(async () => {
            if (nextIndex >= totalFields) {
              // æ‰€æœ‰å­—æ®µéƒ½å·²å¤„ç†
              const progress = await calculateProfileTaskProgress();
              addAssistantMessage(`å¥½çš„ï¼Œä¿ç•™åŸæœ‰çš„${pending.label}ï¼šã€Œ${pending.existingValue}ã€\n\n---\n\nğŸ“‹ **ç®€å†å®Œå–„æµç¨‹ç»“æŸ**\n\nå½“å‰å®Œå–„åº¦ï¼š**${progress}%**\n\nè¿˜æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`);
              setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
            } else {
              // ç»§ç»­ä¸‹ä¸€ä¸ªå­—æ®µ
              const nextField = profileCompleteMode.missingFields[nextIndex];
              addAssistantMessage(`å¥½çš„ï¼Œä¿ç•™åŸæœ‰çš„${pending.label}ï¼šã€Œ${pending.existingValue}ã€\n\n---\n\nğŸ“ **ç»§ç»­å¡«å†™ç¬¬ ${nextIndex + 1} é¡¹ï¼š${nextField.label}**\n\n${getFieldPrompt(nextField.key)}\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹`);
              
              setProfileCompleteMode(prev => {
                const newState = { ...prev };
                delete (newState as any).pendingOverwrite;
                return {
                  ...newState,
                  currentFieldIndex: nextIndex
                };
              });
            }
            setIsTyping(false);
          }, 500);
          return;
        }
      }
      
      // å½“å‰æ­£åœ¨å¡«å†™æŸä¸ªå­—æ®µï¼Œä¿å­˜ç”¨æˆ·è¾“å…¥
      if (profileCompleteMode.currentFieldIndex >= 0) {
        const field = profileCompleteMode.missingFields[profileCompleteMode.currentFieldIndex];
        
        try {
          // ä¿å­˜åˆ°ç”¨æˆ·èµ„æ–™ï¼ˆç®€å†å­—æ®µç›´æ¥ä¿å­˜åˆ° profileï¼Œä¸é‡å¤å­˜åˆ° memoryï¼‰
          const { updateProfileField } = await import('./services/apiService');
          const result = await updateProfileField(userId, 'candidate', field.key, userMessage, false);
          
          // æ£€æŸ¥æ˜¯å¦å·²æœ‰å€¼
          if (result.has_existing && !result.success) {
            // å·²æœ‰å€¼ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦è¦†ç›–
            setTimeout(() => {
              addAssistantMessage(`âš ï¸ **${field.label}å·²æœ‰å€¼**\n\nå½“å‰å€¼ï¼šã€Œ${result.existing_value}ã€\næ‚¨è¾“å…¥çš„ï¼šã€Œ${userMessage}ã€\n\næ˜¯å¦è¦è¦†ç›–åŸæœ‰å†…å®¹ï¼Ÿ\n\nâ€¢ è¾“å…¥ **"ç¡®è®¤"** è¦†ç›–åŸå†…å®¹\nâ€¢ è¾“å…¥ **"å–æ¶ˆ"** ä¿ç•™åŸå†…å®¹`);
              // ä¿å­˜å¾…è¦†ç›–ä¿¡æ¯
              setProfileCompleteMode(prev => ({
                ...prev,
                pendingOverwrite: {
                  field: field.key,
                  label: field.label,
                  value: userMessage,
                  existingValue: result.existing_value
                }
              } as any));
              setIsTyping(false);
            }, 500);
            return;
          }
          
          // åªæœ‰å…³é”®å­—æ®µï¼ˆç»å†ã€æŠ€èƒ½ã€é¡¹ç›®ï¼‰æ‰ä¿å­˜åˆ° Memory ç”¨äºç”»åƒå±•ç¤º
          const memoryFields = ['experience', 'skills', 'education', 'projects'];
          if (memoryFields.includes(field.key)) {
            try {
              // å­—æ®µååˆ° Memory ç±»å‹çš„æ˜ å°„ï¼ˆå¤„ç†å•å¤æ•°å·®å¼‚ï¼‰
              const fieldToMemoryType: Record<string, string> = {
                'skills': 'skill',
                'projects': 'project',
                'experience': 'experience',
                'education': 'education'
              };
              const memoryType = fieldToMemoryType[field.key] || field.key.toLowerCase();
              
              await createMemory({
                type: memoryType,
                content: userMessage,
                importance: 'High',
                scope: 'candidate'
              }, userId);
              refetchMemories();
            } catch (memErr) {
              console.log('Memory ä¿å­˜è·³è¿‡ï¼ˆå¯èƒ½é‡å¤ï¼‰:', memErr);
            }
          }
          
          // è®¡ç®—ä¸‹ä¸€ä¸ªå­—æ®µ
          const nextIndex = profileCompleteMode.currentFieldIndex + 1;
          const totalFields = profileCompleteMode.missingFields.length;
          const completedCount = nextIndex;
          const progressPercent = Math.round((completedCount / totalFields) * 100);
          
          setTimeout(async () => {
            // åˆ·æ–°ä»»åŠ¡è¿›åº¦ï¼ˆç­‰å¾…æ›´æ–°å®Œæˆï¼‰
            const actualProgress = await calculateProfileTaskProgress();
            
            if (nextIndex >= totalFields) {
              // æ‰€æœ‰å­—æ®µéƒ½å·²å®Œæˆ
              addAssistantMessage(`âœ… **${field.label}å·²ä¿å­˜ï¼**\n\n---\n\nğŸ‰ **æ­å–œï¼æ‚¨çš„ç®€å†èµ„æ–™å·²å…¨éƒ¨å®Œå–„ï¼**\n\nâœ¨ ç®€å†å®Œå–„åº¦ï¼š**${actualProgress}%**\n\nç°åœ¨æ‚¨å¯ä»¥ï¼š\nâ€¢ å‰å¾€ [ä¸ªäººä¸»é¡µ](/candidate/profile) æŸ¥çœ‹å’Œå¾®è°ƒ\n\nå®Œæˆä¸ªäººè®¤è¯ä¿¡æ¯ï¼Œæé«˜æ±‚èŒæœºä¼šï¼š\n\n[[TASK:å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯:personal_verification:ğŸ”]]\n\nç¥æ‚¨æ±‚èŒé¡ºåˆ©ï¼ğŸš€`);
              setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
            } else {
              // è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¡¹
              const nextField = profileCompleteMode.missingFields[nextIndex];
              addAssistantMessage(`âœ… **${field.label}å·²ä¿å­˜ï¼** (${completedCount}/${totalFields})\n\nğŸ“Š å®Œå–„è¿›åº¦ï¼š${'â–ˆ'.repeat(Math.floor(actualProgress / 10))}${'â–‘'.repeat(10 - Math.floor(actualProgress / 10))} ${actualProgress}%\n\n---\n\nğŸ“ **ç»§ç»­å¡«å†™ç¬¬ ${nextIndex + 1} é¡¹ï¼š${nextField.label}**\n\n${getFieldPrompt(nextField.key)}\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹ï¼Œè¾“å…¥ "é€€å‡º" å¯ä»¥ç»“æŸå¡«å†™æµç¨‹\nğŸ“ å¿«æ·æ–¹å¼ï¼šç‚¹å‡»å·¦ä¸‹è§’ä¸Šä¼ ç®€å†ï¼ŒAI è‡ªåŠ¨è§£æå¡«å……`);
              
              setProfileCompleteMode(prev => ({
                ...prev,
                currentFieldIndex: nextIndex
              }));
            }
            setIsTyping(false);
          }, 600);
          
          return;
        } catch (error) {
          console.error('ä¿å­˜èµ„æ–™å¤±è´¥:', error);
          setTimeout(() => {
            addAssistantMessage(`âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚\n\næ‚¨è¾“å…¥çš„æ˜¯ï¼šã€Œ${userMessage}ã€\n\nè¯·é‡æ–°è¾“å…¥${field.label}ï¼š`);
            setIsTyping(false);
          }, 500);
          return;
        }
      }
      
      // æ²¡æœ‰é€‰æ‹©å­—æ®µæ—¶ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦é€‰æ‹©äº†æŸä¸ªæ•°å­—
      const numMatch = userMessage.match(/^(\d)$/);
      if (numMatch) {
        const fieldIndex = parseInt(numMatch[1]) - 1;
        if (fieldIndex >= 0 && fieldIndex < profileCompleteMode.missingFields.length) {
          const field = profileCompleteMode.missingFields[fieldIndex];
          
          setTimeout(() => {
            addAssistantMessage(`ğŸ“ **å¡«å†™${field.label}**\n\n${getFieldPrompt(field.key)}`);
            
            setProfileCompleteMode(prev => ({
              ...prev,
              currentFieldIndex: fieldIndex
            }));
            setIsTyping(false);
          }, 500);
          
          return;
        }
      }
      
      // å…¶ä»–æƒ…å†µï¼Œæç¤ºç”¨æˆ·
      setTimeout(() => {
        const currentIndex = profileCompleteMode.currentFieldIndex;
        const currentField = profileCompleteMode.missingFields[currentIndex >= 0 ? currentIndex : 0];
        addAssistantMessage(`æˆ‘æ²¡æœ‰ç†è§£æ‚¨çš„æ„æ€ã€‚\n\nç°åœ¨æ­£åœ¨å¡«å†™ã€Œ${currentField?.label || 'ç®€å†ä¿¡æ¯'}ã€ï¼Œè¯·ç›´æ¥è¾“å…¥å†…å®¹ã€‚\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹ï¼Œè¾“å…¥ "é€€å‡º" å¯ä»¥ç»“æŸå¡«å†™æµç¨‹\nğŸ“ å¿«æ·æ–¹å¼ï¼šç‚¹å‡»å·¦ä¸‹è§’ä¸Šä¼ ç®€å†ï¼ŒAI è‡ªåŠ¨è§£æå¡«å……`);
        setIsTyping(false);
      }, 500);
      
      return;
    }
    
    // å®Œå–„ä¼ä¸šèµ„æ–™æ¨¡å¼å¤„ç†
    if (enterpriseProfileMode.active) {
      setInputMessage('');
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      const addUserMsg = (content: string) => {
        if (selectedTask) {
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'user' as const, content}]
          }));
        } else {
          setGeneralMessages(prev => [...prev, {role: 'user' as const, content}]);
        }
      };
      
      const addAsstMsg = (content: string) => {
        if (selectedTask) {
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'assistant' as const, content}]
          }));
        } else {
          setGeneralMessages(prev => [...prev, {role: 'assistant' as const, content}]);
        }
      };
      
      addUserMsg(userMessage);
      setIsTyping(true);
      
      // ç”¨æˆ·è·³è¿‡å½“å‰å­—æ®µ
      if (userMessage.includes('è·³è¿‡')) {
        const currentIndex = enterpriseProfileMode.currentFieldIndex;
        const currentField = enterpriseProfileMode.missingFields[currentIndex];
        const nextIndex = currentIndex + 1;
        const totalFields = enterpriseProfileMode.missingFields.length;
        
        setTimeout(async () => {
          if (nextIndex >= totalFields) {
            const progress = await calculateEnterpriseProfileProgress();
            addAsstMsg(`â­ï¸ å·²è·³è¿‡ã€Œ${currentField?.label}ã€\n\n---\n\nğŸ“‹ **ä¼ä¸šèµ„æ–™å®Œå–„æµç¨‹ç»“æŸ**\n\nå½“å‰å®Œå–„åº¦ï¼š**${progress}%**\n\n${progress < 100 ? 'ğŸ’¡ æç¤ºï¼šå®Œå–„æ›´å¤šèµ„æ–™å¯ä»¥æå‡æ‹›è˜æ•ˆæœï¼\n\næ‚¨å¯ä»¥éšæ—¶ç‚¹å‡»æ­¤ä»»åŠ¡ç»§ç»­è¡¥å……ï¼Œæˆ–å‰å¾€ [åŸºç¡€ä¿¡æ¯è®¾ç½®](/settings?tab=General) æ‰‹åŠ¨ç¼–è¾‘ã€‚' : 'ğŸ‰ ä¼ä¸šèµ„æ–™å·²å®Œå–„ï¼'}`);
            setEnterpriseProfileMode({ active: false, missingFields: [], currentFieldIndex: -1 });
          } else {
            const nextField = enterpriseProfileMode.missingFields[nextIndex];
            addAsstMsg(`â­ï¸ å·²è·³è¿‡ã€Œ${currentField?.label}ã€ (${currentIndex + 1}/${totalFields})\n\n---\n\nğŸ“ **ç»§ç»­å¡«å†™ç¬¬ ${nextIndex + 1} é¡¹ï¼š${nextField.label}**\n\n${getEnterpriseFieldPrompt(nextField)}\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹ï¼Œè¾“å…¥ "é€€å‡º" å¯ä»¥ç»“æŸå¡«å†™æµç¨‹`);
            setEnterpriseProfileMode(prev => ({ ...prev, currentFieldIndex: nextIndex }));
          }
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // ç”¨æˆ·é€€å‡ºæµç¨‹
      if (userMessage.includes('é€€å‡º') || userMessage.includes('ç¨å')) {
        setTimeout(async () => {
          const progress = await calculateEnterpriseProfileProgress();
          addAsstMsg(`å¥½çš„ï¼Œæ‚¨å¯ä»¥ç¨åç»§ç»­å®Œå–„ä¼ä¸šèµ„æ–™ã€‚\n\nå½“å‰å®Œå–„åº¦ï¼š**${progress}%**\n\nğŸ’¡ æç¤ºï¼šå®Œå–„çš„ä¼ä¸šèµ„æ–™å¯ä»¥å¸®åŠ©æ‚¨å¸å¼•æ›´å¤šä¼˜è´¨äººæ‰ï¼\n\næ‚¨å¯ä»¥éšæ—¶ç‚¹å‡»æ­¤ä»»åŠ¡ç»§ç»­è¡¥å……ï¼Œæˆ–å‰å¾€ [åŸºç¡€ä¿¡æ¯è®¾ç½®](/settings?tab=General) æ‰‹åŠ¨ç¼–è¾‘ã€‚`);
          setEnterpriseProfileMode({ active: false, missingFields: [], currentFieldIndex: -1 });
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // å½“å‰æ­£åœ¨å¡«å†™æŸä¸ªå­—æ®µï¼Œä¿å­˜ç”¨æˆ·è¾“å…¥
      if (enterpriseProfileMode.currentFieldIndex >= 0) {
        const field = enterpriseProfileMode.missingFields[enterpriseProfileMode.currentFieldIndex];
        
        try {
          const { updateSettings } = await import('./services/apiService');
          
          // è§£æç”¨æˆ·è¾“å…¥
          let valueToSave = userMessage.trim();
          if (field.type === 'select' && field.options) {
            valueToSave = parseEnterpriseSelectInput(userMessage, field);
          }
          
          // æ‰‹æœºå·æ ¼å¼éªŒè¯
          if (field.key === 'hr_phone' || field.key === 'contact_phone') {
            const phoneClean = valueToSave.replace(/[\s\-]/g, '');
            const mobileReg = /^1[3-9]\d{9}$/;
            const landlineReg = /^0\d{2,3}\d{7,8}$/;
            if (!mobileReg.test(phoneClean) && !landlineReg.test(phoneClean)) {
              setTimeout(() => {
                addAsstMsg(`âš ï¸ æ‚¨è¾“å…¥çš„ã€Œ${valueToSave}ã€ä¸æ˜¯æœ‰æ•ˆçš„ç”µè¯å·ç æ ¼å¼ã€‚\n\nè¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ï¼ˆå¦‚ 13812345678ï¼‰æˆ–å›ºå®šç”µè¯ï¼ˆå¦‚ 02112345678ï¼‰ï¼š`);
                setIsTyping(false);
              }, 300);
              return;
            }
            valueToSave = phoneClean;
          }
          
          // åªå‘é€éœ€è¦æ›´æ–°çš„å­—æ®µ
          const updateData: any = {};
          updateData[field.key] = valueToSave;
          
          await updateSettings(updateData, userId);
          console.log(`[Enterprise Profile] å·²ä¿å­˜ ${field.label}: ${valueToSave}`);
          
          // è®¡ç®—ä¸‹ä¸€æ­¥
          const nextIndex = enterpriseProfileMode.currentFieldIndex + 1;
          const totalFields = enterpriseProfileMode.missingFields.length;
          const completedCount = nextIndex;
          
          setTimeout(async () => {
            const actualProgress = await calculateEnterpriseProfileProgress();
            
            // æ˜¾ç¤ºä¿å­˜çš„å€¼ï¼ˆç¦åˆ©å­—æ®µç‰¹æ®Šå¤„ç†ï¼‰
            let displayValue = valueToSave;
            if (field.key === 'benefits') {
              try { displayValue = JSON.parse(valueToSave).join('ã€'); } catch { /* keep original */ }
            }
            
            if (nextIndex >= totalFields) {
              addAsstMsg(`âœ… **${field.label}å·²ä¿å­˜ï¼** â†’ ${displayValue}\n\n---\n\nğŸ‰ **æ­å–œï¼ä¼ä¸šèµ„æ–™å·²å…¨éƒ¨å®Œå–„ï¼**\n\nâœ¨ å®Œå–„åº¦ï¼š**${actualProgress}%**\n\næ‚¨å¯ä»¥ï¼š\nâ€¢ å‰å¾€ [åŸºç¡€ä¿¡æ¯è®¾ç½®](/settings?tab=General) æŸ¥çœ‹æˆ–ä¿®æ”¹\nâ€¢ å‰å¾€ [ä¼ä¸šä¸»é¡µ](/employer/profile) æŸ¥çœ‹å±•ç¤ºæ•ˆæœ\n\nç°åœ¨å¯ä»¥å¼€å§‹å‘å¸ƒèŒä½ï¼Œæ‹›è˜ä¼˜è´¨äººæ‰äº†ï¼ğŸš€`);
              setEnterpriseProfileMode({ active: false, missingFields: [], currentFieldIndex: -1 });
            } else {
              const nextField = enterpriseProfileMode.missingFields[nextIndex];
              addAsstMsg(`âœ… **${field.label}å·²ä¿å­˜ï¼** â†’ ${displayValue} (${completedCount}/${totalFields})\n\nğŸ“Š å®Œå–„è¿›åº¦ï¼š${'â–ˆ'.repeat(Math.floor(actualProgress / 10))}${'â–‘'.repeat(10 - Math.floor(actualProgress / 10))} ${actualProgress}%\n\n---\n\nğŸ“ **ç»§ç»­å¡«å†™ç¬¬ ${nextIndex + 1} é¡¹ï¼š${nextField.label}**\n\n${getEnterpriseFieldPrompt(nextField)}\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹ï¼Œè¾“å…¥ "é€€å‡º" å¯ä»¥ç»“æŸå¡«å†™æµç¨‹`);
              setEnterpriseProfileMode(prev => ({ ...prev, currentFieldIndex: nextIndex }));
            }
            setIsTyping(false);
          }, 600);
          
          return;
        } catch (error) {
          console.error('ä¿å­˜ä¼ä¸šèµ„æ–™å¤±è´¥:', error);
          setTimeout(() => {
            addAsstMsg(`âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚\n\næ‚¨è¾“å…¥çš„æ˜¯ï¼šã€Œ${userMessage}ã€\n\nè¯·é‡æ–°è¾“å…¥${field.label}ï¼š`);
            setIsTyping(false);
          }, 500);
          return;
        }
      }
      
      // å…¶ä»–æƒ…å†µ
      setTimeout(() => {
        const currentIndex = enterpriseProfileMode.currentFieldIndex;
        const currentField = enterpriseProfileMode.missingFields[currentIndex >= 0 ? currentIndex : 0];
        addAsstMsg(`æˆ‘æ²¡æœ‰ç†è§£æ‚¨çš„æ„æ€ã€‚\n\nç°åœ¨æ­£åœ¨å¡«å†™ã€Œ${currentField?.label || 'ä¼ä¸šèµ„æ–™'}ã€ï¼Œè¯·ç›´æ¥è¾“å…¥å†…å®¹ã€‚\n\nğŸ’¡ è¾“å…¥ "è·³è¿‡" å¯ä»¥è·³è¿‡å½“å‰é¡¹ï¼Œè¾“å…¥ "é€€å‡º" å¯ä»¥ç»“æŸå¡«å†™æµç¨‹`);
        setIsTyping(false);
      }, 500);
      
      return;
    }
    
    // DISCæµ‹è¯•æ¨¡å¼å¤„ç†
    if (discTestMode.active) {
      // å¤„ç†é‡æ–°æµ‹è¯•
      if (discTestMode.completed && (userMessage.includes('é‡æ–°æµ‹è¯•') || userMessage.includes('å†æµ‹ä¸€æ¬¡'))) {
        setInputMessage('');
        setDiscTestMode({ active: true, currentQuestion: 0, answers: [], completed: false });
        
        const addRestartMsg = (content: string) => {
          if (selectedTask) {
            setTaskMessages(prev => ({
              ...prev,
              [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'assistant' as const, content}]
            }));
          } else {
            setGeneralMessages(prev => [...prev, {role: 'assistant' as const, content}]);
          }
        };
        
        addRestartMsg(`ğŸ”„ å¥½çš„ï¼Œè®©æˆ‘ä»¬é‡æ–°å¼€å§‹ DISC æ€§æ ¼æµ‹è¯•ï¼\n\nğŸ“‹ æµ‹è¯•å…± **10 é“é¢˜ç›®**ï¼Œé¢„è®¡ç”¨æ—¶ 3-5 åˆ†é’Ÿ\n\nå‡†å¤‡å¥½äº†å—ï¼Ÿè¾“å…¥ã€Œå¼€å§‹æµ‹è¯•ã€å¼€å§‹æ‚¨çš„ DISC ä¹‹æ—…ï¼`);
        return;
      }
      
      // æµ‹è¯•å·²å®Œæˆï¼Œä¸å¤„ç†å…¶ä»–è¾“å…¥
      if (discTestMode.completed) {
        return;
      }
      setInputMessage('');
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      const addUserMsg = (content: string) => {
        if (selectedTask) {
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'user' as const, content}]
          }));
        } else {
          setGeneralMessages(prev => [...prev, {role: 'user' as const, content}]);
        }
      };
      
      // æ·»åŠ  AI æ¶ˆæ¯
      const addAIMsg = (content: string) => {
        if (selectedTask) {
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'assistant' as const, content}]
          }));
        } else {
          setGeneralMessages(prev => [...prev, {role: 'assistant' as const, content}]);
        }
      };
      
      addUserMsg(userMessage);
      setIsTyping(true);
      
      // æ£€æµ‹å¼€å§‹æµ‹è¯•
      if (userMessage.includes('å¼€å§‹æµ‹è¯•') || userMessage.includes('å¼€å§‹') || userMessage.includes('Start')) {
        setTimeout(() => {
          const firstQuestion = discQuestions[0];
          let questionMsg = `ğŸ“ **DISC æ€§æ ¼æµ‹è¯•å¼€å§‹ï¼**\n\n---\n\n**ç¬¬ 1 é¢˜ / å…± ${discQuestions.length} é¢˜**\n\n${firstQuestion.question}\n\n`;
          firstQuestion.options.forEach(opt => {
            questionMsg += `**${opt.label}.** ${opt.text}\n\n`;
          });
          questionMsg += `\nè¯·è¾“å…¥æ‚¨çš„é€‰æ‹©ï¼ˆA/B/C/Dï¼‰`;
          
          addAIMsg(questionMsg);
          setDiscTestMode(prev => ({ ...prev, currentQuestion: 1 }));
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // å¤„ç†ç­”æ¡ˆ
      const answerMatch = userMessage.toUpperCase().match(/^[ABCD]$/);
      if (answerMatch && discTestMode.currentQuestion > 0) {
        const answer = answerMatch[0];
        const currentQ = discQuestions[discTestMode.currentQuestion - 1];
        const selectedOption = currentQ.options.find(opt => opt.label === answer);
        
        if (selectedOption) {
          const newAnswer = {
            question: discTestMode.currentQuestion,
            answer: answer,
            dimension: selectedOption.dimension
          };
          
          const newAnswers = [...discTestMode.answers, newAnswer];
          
          setTimeout(async () => {
            if (discTestMode.currentQuestion < discQuestions.length) {
              // ç»§ç»­ä¸‹ä¸€é¢˜
              const nextQ = discQuestions[discTestMode.currentQuestion];
              let questionMsg = `âœ… å·²è®°å½•æ‚¨çš„é€‰æ‹©ï¼š**${answer}**\n\n---\n\n**ç¬¬ ${discTestMode.currentQuestion + 1} é¢˜ / å…± ${discQuestions.length} é¢˜**\n\n${nextQ.question}\n\n`;
              nextQ.options.forEach(opt => {
                questionMsg += `**${opt.label}.** ${opt.text}\n\n`;
              });
              questionMsg += `\nè¯·è¾“å…¥æ‚¨çš„é€‰æ‹©ï¼ˆA/B/C/Dï¼‰`;
              
              addAIMsg(questionMsg);
              setDiscTestMode(prev => ({
                ...prev,
                currentQuestion: prev.currentQuestion + 1,
                answers: newAnswers
              }));
            } else {
              // æµ‹è¯•å®Œæˆï¼Œè®¡ç®—ç»“æœ
              const scores = { D: 0, I: 0, S: 0, C: 0 };
              newAnswers.forEach(a => {
                scores[a.dimension as keyof typeof scores]++;
              });
              
              // æ‰¾å‡ºæœ€é«˜åˆ†çš„ç»´åº¦
              const maxScore = Math.max(...Object.values(scores));
              const dominantTypes = Object.entries(scores)
                .filter(([_, score]) => score === maxScore)
                .map(([type]) => type);
              
              // è®¡ç®—ç™¾åˆ†æ¯”
              const total = discQuestions.length;
              const percentages = {
                D: Math.round((scores.D / total) * 100),
                I: Math.round((scores.I / total) * 100),
                S: Math.round((scores.S / total) * 100),
                C: Math.round((scores.C / total) * 100)
              };
              
              // DISCç±»å‹æè¿°
              const typeDescriptions: Record<string, {name: string; traits: string; strengths: string; careers: string}> = {
                D: {
                  name: "æ”¯é…å‹ (Dominance)",
                  traits: "ç»“æœå¯¼å‘ã€æœæ–­å†³ç­–ã€å–œæ¬¢æŒ‘æˆ˜ã€è¿½æ±‚æ•ˆç‡",
                  strengths: "é¢†å¯¼åŠ›å¼ºã€å–„äºè§£å†³é—®é¢˜ã€æ¨åŠ¨åŠ›å¼ºã€æ•¢äºæ‰¿æ‹…é£é™©",
                  careers: "ç®¡ç†è€…ã€åˆ›ä¸šè€…ã€é”€å”®æ€»ç›‘ã€é¡¹ç›®ç»ç†ã€å’¨è¯¢é¡¾é—®"
                },
                I: {
                  name: "å½±å“å‹ (Influence)",
                  traits: "å–„äºç¤¾äº¤ã€çƒ­æƒ…ä¹è§‚ã€å¯Œæœ‰æ„ŸæŸ“åŠ›ã€å–œæ¬¢è¡¨è¾¾",
                  strengths: "æ²Ÿé€šèƒ½åŠ›å¼ºã€å›¢é˜Ÿæ¿€åŠ±ã€äººé™…å…³ç³»å¥½ã€åˆ›æ„ä¸°å¯Œ",
                  careers: "å¸‚åœºè¥é”€ã€å…¬å…³ã€åŸ¹è®­å¸ˆã€é”€å”®ã€äººåŠ›èµ„æº"
                },
                S: {
                  name: "ç¨³å¥å‹ (Steadiness)",
                  traits: "ç¨³é‡å¯é ã€è€å¿ƒå€¾å¬ã€å›¢é˜Ÿåä½œã€è¿½æ±‚å’Œè°",
                  strengths: "å¿ è¯šåº¦é«˜ã€æ‰§è¡ŒåŠ›å¼ºã€å–„äºæ”¯æŒä»–äººã€å¤„äº‹å†·é™",
                  careers: "å®¢æˆ·æœåŠ¡ã€è¡Œæ”¿ç®¡ç†ã€äººåŠ›èµ„æºã€é¡¹ç›®åè°ƒã€åŒ»ç–—æŠ¤ç†"
                },
                C: {
                  name: "è°¨æ…å‹ (Conscientiousness)",
                  traits: "æ³¨é‡ç»†èŠ‚ã€è¿½æ±‚å®Œç¾ã€é€»è¾‘æ¸…æ™°ã€ä¸¥è°¨è®¤çœŸ",
                  strengths: "åˆ†æèƒ½åŠ›å¼ºã€è´¨é‡æŠŠæ§å¥½ã€ä¸“ä¸šçŸ¥è¯†æ‰å®ã€è§„åˆ’èƒ½åŠ›å¼º",
                  careers: "å·¥ç¨‹å¸ˆã€æ•°æ®åˆ†æå¸ˆã€è´¢åŠ¡ã€è´¨é‡ç®¡ç†ã€ç ”å‘"
                }
              };
              
              const primaryType = dominantTypes[0];
              const primaryDesc = typeDescriptions[primaryType];
              
              // ç”Ÿæˆç»“æœæ¶ˆæ¯
              let resultMsg = `ğŸ‰ **DISC æµ‹è¯•å®Œæˆï¼**\n\n---\n\n## ğŸ“Š æ‚¨çš„ DISC è¯„ä¼°ç»“æœ\n\n`;
              resultMsg += `### ä¸»å¯¼ç±»å‹ï¼š${primaryDesc.name}\n\n`;
              resultMsg += `**å¾—åˆ†åˆ†å¸ƒï¼š**\n`;
              resultMsg += `â€¢ D æ”¯é…å‹ï¼š${scores.D} åˆ† (${percentages.D}%)\n`;
              resultMsg += `â€¢ I å½±å“å‹ï¼š${scores.I} åˆ† (${percentages.I}%)\n`;
              resultMsg += `â€¢ S ç¨³å¥å‹ï¼š${scores.S} åˆ† (${percentages.S}%)\n`;
              resultMsg += `â€¢ C è°¨æ…å‹ï¼š${scores.C} åˆ† (${percentages.C}%)\n\n`;
              resultMsg += `---\n\n### ğŸ¯ æ€§æ ¼ç‰¹ç‚¹\n${primaryDesc.traits}\n\n`;
              resultMsg += `### ğŸ’ª æ ¸å¿ƒä¼˜åŠ¿\n${primaryDesc.strengths}\n\n`;
              resultMsg += `### ğŸ’¼ é€‚åˆèŒä¸š\n${primaryDesc.careers}\n\n`;
              resultMsg += `---\n\nâœ… æµ‹è¯•ç»“æœå·²ä¿å­˜åˆ°æ‚¨çš„ä¸ªäººæ¡£æ¡ˆï¼ŒHR å¯ä»¥å‚è€ƒæ­¤ç»“æœä¸ºæ‚¨åŒ¹é…æ›´åˆé€‚çš„å²—ä½ï¼\n\nè¿˜æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`;
              
              addAIMsg(resultMsg);
              
              // ä¿å­˜ç»“æœåˆ° Memory
              try {
                const { createMemory } = await import('./services/apiService');
                
                // æ„å»ºå®Œæ•´çš„DISCç»“æœæè¿°
                const discResultContent = `ã€DISCæ€§æ ¼æµ‹è¯•ç»“æœã€‘\nä¸»å¯¼ç±»å‹: ${primaryDesc.name}\nå¾—åˆ†åˆ†å¸ƒ: D-${scores.D}åˆ†(${percentages.D}%) I-${scores.I}åˆ†(${percentages.I}%) S-${scores.S}åˆ†(${percentages.S}%) C-${scores.C}åˆ†(${percentages.C}%)\næ€§æ ¼ç‰¹ç‚¹: ${primaryDesc.traits}\næ ¸å¿ƒä¼˜åŠ¿: ${primaryDesc.strengths}\né€‚åˆèŒä¸š: ${primaryDesc.careers}`;
                
                await createMemory({
                  type: 'experience',
                  content: discResultContent,
                  importance: 'High',
                  scope: 'candidate'
                }, userId);
                console.log('[DISC] æµ‹è¯•ç»“æœå·²ä¿å­˜åˆ° Memory');
              } catch (err) {
                console.error('[DISC] ä¿å­˜æµ‹è¯•ç»“æœå¤±è´¥:', err);
              }
              
              // æ›´æ–°ä»»åŠ¡è¿›åº¦ä¸º100%
              if (selectedTask) {
                try {
                  const { updateTodo } = await import('./services/apiService');
                  await updateTodo(selectedTask.id, { progress: 100, status: 'completed' });
                  if (typeof refetchTasks === 'function') {
                    refetchTasks();
                  }
                } catch (err) {
                  console.error('[DISC] æ›´æ–°ä»»åŠ¡è¿›åº¦å¤±è´¥:', err);
                }
              }
              
              setDiscTestMode(prev => ({
                ...prev,
                answers: newAnswers,
                completed: true
              }));
            }
            setIsTyping(false);
          }, 500);
          return;
        }
      }
      
      // æ— æ•ˆè¾“å…¥
      setTimeout(() => {
        if (discTestMode.currentQuestion === 0) {
          addAIMsg(`è¯·è¾“å…¥ã€Œå¼€å§‹æµ‹è¯•ã€æ¥å¼€å§‹ DISC æ€§æ ¼æµ‹è¯•ã€‚`);
        } else {
          addAIMsg(`è¯·è¾“å…¥æœ‰æ•ˆçš„é€‰é¡¹ï¼ˆA/B/C/Dï¼‰æ¥å›ç­”å½“å‰é—®é¢˜ã€‚`);
        }
        setIsTyping(false);
      }, 500);
      return;
    }
    
    // æ±‚èŒåå¥½æ¨¡å¼å¤„ç†
    if (jobSearchMode.active) {
      setInputMessage('');
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      const addJobMsg = (content: string, role: 'user' | 'assistant') => {
        if (selectedTask) {
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [...(prev[selectedTask.id] || []), {role, content}]
          }));
        } else {
          setGeneralMessages(prev => [...prev, {role, content}]);
        }
      };
      
      addJobMsg(userMessage, 'user');
      setIsTyping(true);
      
      // å¤„ç†è°ƒæ•´åå¥½/ä¿®æ”¹åå¥½
      if (jobSearchMode.completed && (userMessage.includes('è°ƒæ•´åå¥½') || userMessage.includes('ä¿®æ”¹åå¥½') || userMessage.includes('é‡æ–°æµ‹è¯•') || userMessage.includes('å†æ¥ä¸€æ¬¡'))) {
        setTimeout(() => {
          setJobSearchMode({ active: true, currentQuestion: 0, answers: [], completed: false, tokenUsed: jobSearchMode.tokenUsed, isSearching: false });
          addJobMsg(`ğŸ”„ å¥½çš„ï¼Œè®©æˆ‘ä»¬é‡æ–°æ”¶é›†æ‚¨çš„æ±‚èŒåå¥½ï¼\n\nä¹‹å‰çš„åå¥½å°†è¢«æ–°çš„åå¥½è¦†ç›–ã€‚\n\nğŸ“‹ å…± **${jobSearchQuestions.length} ä¸ªé—®é¢˜**ï¼Œé¢„è®¡ç”¨æ—¶ 2-3 åˆ†é’Ÿ\n\nå‡†å¤‡å¥½äº†å—ï¼Ÿè¾“å…¥ã€Œå¼€å§‹ã€å¼€å§‹ï¼`, 'assistant');
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // å¤„ç†ç»§ç»­æ‰¾å·¥ä½œ
      if (jobSearchMode.completed && !jobSearchMode.isSearching && (userMessage.includes('ç»§ç»­æ‰¾') || userMessage.includes('ç»§ç»­æœç´¢'))) {
        setJobSearchMode(prev => ({ ...prev, isSearching: true }));
        addJobMsg(`ğŸ” **ç»§ç»­ä¸ºæ‚¨æœç´¢æ–°å²—ä½...**\n\nâ³ æ­£åœ¨è·å–æœ€æ–°èŒä½ä¿¡æ¯...`, 'assistant');
        
        setTimeout(async () => {
          const tokenBalance = 1000 - jobSearchMode.tokenUsed;
          const tokenCost = 200;
          
          if (tokenBalance < tokenCost) {
            addJobMsg(`âš ï¸ **Token ä½™é¢ä¸è¶³**\n\nç»§ç»­æœç´¢éœ€è¦ ${tokenCost} Tokenï¼Œæ‚¨å½“å‰ä½™é¢ä¸º ${tokenBalance} Tokenã€‚\n\nè¯·å……å€¼åç»§ç»­ã€‚`, 'assistant');
            setJobSearchMode(prev => ({ ...prev, isSearching: false }));
            setIsTyping(false);
            return;
          }
          
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          let newSearchMsg = '';
          try {
            const { getPublicFlows, getFlowStats } = await import('./services/apiService');
            const realFlows = await getPublicFlows(50, userId);
            const realStats = await getFlowStats(userId);
            const passedFlows = realFlows.filter((f: any) => f.status === 'completed' || f.matchScore >= 85);
            const skippedFlows = realFlows.filter((f: any) => f.status === 'rejected' && f.matchScore < 85);
            
            newSearchMsg = `ğŸ“‹ **å²—ä½æœç´¢å®Œæˆï¼**\n\n---\n\næ‰¾åˆ° **${realStats?.applied || 0}** ä¸ªåŒ¹é…å²—ä½ï¼š\n\n`;
            if (passedFlows.length > 0) {
              newSearchMsg += `### âœ… å·²æŠ•é€’ï¼ˆåŒ¹é…åº¦ â‰¥ 85%ï¼‰\n\n`;
              passedFlows.slice(0, 5).forEach((f: any, i: number) => {
                newSearchMsg += `${i + 1}. **${f.role}** - ${f.company}\n`;
                newSearchMsg += `   ğŸ“Š åŒ¹é…åº¦: ${f.matchScore}% | ${f.salary || 'é¢è®®'} | ${f.status === 'completed' ? 'âœ… å·²é€šè¿‡' : 'ğŸ“¤ å·²æŠ•é€’'}\n\n`;
              });
            }
            if (skippedFlows.length > 0) {
              newSearchMsg += `### âŒ æœªé€šè¿‡ç­›é€‰\n\n`;
              skippedFlows.slice(0, 3).forEach((f: any, i: number) => {
                newSearchMsg += `${passedFlows.length + i + 1}. **${f.role}** - ${f.company} | åŒ¹é…åº¦: ${f.matchScore}%\n`;
              });
              newSearchMsg += `\n`;
            }
            newSearchMsg += `---\n\nğŸ’° æœ¬æ¬¡æ¶ˆè€—: ${tokenCost} Token | å‰©ä½™: ${tokenBalance - tokenCost} Token`;
          } catch (err) {
            newSearchMsg = `ğŸ“‹ **å²—ä½æœç´¢å®Œæˆï¼**\n\næ­£åœ¨è·å–æœ€æ–°æ•°æ®...\n\nğŸ’° æœ¬æ¬¡æ¶ˆè€—: ${tokenCost} Token`;
          }
          
          addJobMsg(newSearchMsg, 'assistant');
          setJobSearchMode(prev => ({ ...prev, isSearching: false, tokenUsed: prev.tokenUsed + tokenCost }));
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // å¤„ç†æŸ¥çœ‹æŠ•é€’è®°å½• - ä»åç«¯è·å–çœŸå®æ•°æ®
      if (jobSearchMode.completed && !jobSearchMode.isSearching && (userMessage.includes('æŸ¥çœ‹æŠ•é€’') || userMessage.includes('æŠ•é€’è®°å½•'))) {
        setTimeout(async () => {
          try {
            const { getPublicFlows, getFlowStats } = await import('./services/apiService');
            const realFlows = await getPublicFlows(50, userId);
            const realStats = await getFlowStats(userId);
            
            let recordMsg = `ğŸ“‹ **æ‚¨çš„æŠ•é€’è®°å½•**\n\n---\n\n### ğŸ“¬ å·²æŠ•é€’å²—ä½ (${realStats?.applied || 0} ä¸ª)\n\n`;
            
            if (realFlows && realFlows.length > 0) {
              recordMsg += `| å²—ä½ | å…¬å¸ | åŒ¹é…åº¦ | è–ªèµ„ | çŠ¶æ€ |\n`;
              recordMsg += `|------|------|--------|------|------|\n`;
              realFlows.forEach((flow: any) => {
                const statusIcon = flow.status === 'completed' ? 'âœ… å·²é€šè¿‡' 
                  : flow.status === 'rejected' ? 'âŒ æœªé€šè¿‡' 
                  : flow.status === 'screening' ? 'ğŸ” ç­›é€‰ä¸­' 
                  : 'ğŸ“¤ å·²æŠ•é€’';
                recordMsg += `| ${flow.role || 'æœªçŸ¥èŒä½'} | ${flow.company || 'æœªçŸ¥'} | ${flow.matchScore || 0}% | ${flow.salary || 'é¢è®®'} | ${statusIcon} |\n`;
              });
              recordMsg += `\n---\n\n### ğŸ“Š æ±‡æ€»ç»Ÿè®¡\n\n`;
              recordMsg += `| æŒ‡æ ‡ | æ•°æ® |\n`;
              recordMsg += `|------|------|\n`;
              recordMsg += `| å·²æ‰«æå²—ä½ | **${realStats?.viewed || 0}** ä¸ª |\n`;
              recordMsg += `| å·²æŠ•é€’ | **${realStats?.applied || 0}** ä¸ª |\n`;
              recordMsg += `| å·²é€šè¿‡ | **${realStats?.passed || 0}** ä¸ª |\n`;
              recordMsg += `| è¿›è¡Œä¸­ | **${realStats?.pending || 0}** ä¸ª |\n`;
              recordMsg += `| æœªé€šè¿‡ | **${realStats?.rejected || 0}** ä¸ª |\n`;
              recordMsg += `| å¹³å‡åŒ¹é…åº¦ | **${realStats?.avgMatch || 0}%** |\n`;
            } else {
              recordMsg += `æš‚æ— æŠ•é€’è®°å½•ã€‚\n`;
            }
            
            recordMsg += `\n---\n\n**çŠ¶æ€è¯´æ˜**ï¼š\n`;
            recordMsg += `â€¢ âœ… å·²é€šè¿‡ - ç­›é€‰é€šè¿‡ï¼Œå·²äº’æ¢è”ç³»æ–¹å¼\n`;
            recordMsg += `â€¢ ğŸ“¤ å·²æŠ•é€’ - AI å·²æŠ•é€’ï¼Œç­‰å¾…ä¼ä¸šå›å¤\n`;
            recordMsg += `â€¢ ğŸ” ç­›é€‰ä¸­ - ä¼ä¸šæ­£åœ¨ç­›é€‰è¯„ä¼°\n`;
            recordMsg += `â€¢ âŒ æœªé€šè¿‡ - æœ¬æ¬¡æŠ•é€’æœªé€šè¿‡ç­›é€‰\n\n`;
            recordMsg += `---\n\nğŸ“Š **æŸ¥çœ‹æ›´è¯¦ç»†çš„æŠ•é€’è¿›åº¦å’Œ AI å¯¹æ¥é˜Ÿåˆ—**\n\n`;
            recordMsg += `[[LINK:å‰å¾€å·¥ä½œå°æŸ¥çœ‹è¯¦æƒ…:/workbench:ğŸ“Š]]`;
            
            addJobMsg(recordMsg, 'assistant');
          } catch (err) {
            console.error('[JobSearch] è·å–æŠ•é€’è®°å½•å¤±è´¥:', err);
            addJobMsg('âš ï¸ è·å–æŠ•é€’è®°å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚\n\n[[LINK:å‰å¾€å·¥ä½œå°æŸ¥çœ‹è¯¦æƒ…:/workbench:ğŸ“Š]]', 'assistant');
          }
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // å¦‚æœå·²å®Œæˆä¸”æ­£åœ¨æœç´¢ï¼Œä¸å¤„ç†
      if (jobSearchMode.completed && jobSearchMode.isSearching) {
        setTimeout(() => {
          addJobMsg(`â³ AI æ±‚èŒä»£ç†æ­£åœ¨å·¥ä½œä¸­ï¼Œè¯·ç¨å€™...\n\næ­£åœ¨ä¸ºæ‚¨åˆ†æå’ŒæŠ•é€’åˆé€‚çš„å²—ä½ã€‚`, 'assistant');
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // æ£€æµ‹å¼€å§‹
      if (jobSearchMode.currentQuestion === 0 && (userMessage.includes('å¼€å§‹') || userMessage.includes('Start') || userMessage.includes('å¥½'))) {
        setTimeout(() => {
          const firstQ = jobSearchQuestions[0];
          let qMsg = `ğŸ“ **æ±‚èŒåå¥½è°ƒæŸ¥å¼€å§‹ï¼**\n\n---\n\n**ç¬¬ 1 é¢˜ / å…± ${jobSearchQuestions.length} é¢˜**\n\n${firstQ.question}\n\n`;
          firstQ.options.forEach(opt => {
            qMsg += `**${opt.label}.** ${opt.text}\n\n`;
          });
          qMsg += `\nè¯·è¾“å…¥æ‚¨çš„é€‰æ‹©ï¼ˆA/B/C/Dï¼‰`;
          
          addJobMsg(qMsg, 'assistant');
          setJobSearchMode(prev => ({ ...prev, currentQuestion: 1 }));
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // å¤„ç†ç­”æ¡ˆ
      const answerMatch = userMessage.toUpperCase().match(/^[ABCD]$/);
      if (answerMatch && jobSearchMode.currentQuestion > 0 && !jobSearchMode.completed) {
        const answer = answerMatch[0];
        const currentQ = jobSearchQuestions[jobSearchMode.currentQuestion - 1];
        const selectedOption = currentQ.options.find(opt => opt.label === answer);
        
        if (selectedOption) {
          const newAnswer = {
            question: currentQ.question,
            answer: selectedOption.text,
            key: currentQ.key
          };
          
          const newAnswers = [...jobSearchMode.answers, newAnswer];
          
          setTimeout(async () => {
            if (jobSearchMode.currentQuestion < jobSearchQuestions.length) {
              // ç»§ç»­ä¸‹ä¸€é¢˜
              const nextQ = jobSearchQuestions[jobSearchMode.currentQuestion];
              let qMsg = `âœ… å·²è®°å½•ï¼š**${selectedOption.text}**\n\n---\n\n**ç¬¬ ${jobSearchMode.currentQuestion + 1} é¢˜ / å…± ${jobSearchQuestions.length} é¢˜**\n\n${nextQ.question}\n\n`;
              nextQ.options.forEach(opt => {
                qMsg += `**${opt.label}.** ${opt.text}\n\n`;
              });
              qMsg += `\nè¯·è¾“å…¥æ‚¨çš„é€‰æ‹©ï¼ˆA/B/C/Dï¼‰`;
              
              addJobMsg(qMsg, 'assistant');
              setJobSearchMode(prev => ({
                ...prev,
                currentQuestion: prev.currentQuestion + 1,
                answers: newAnswers
              }));
            } else {
              // åå¥½æ”¶é›†å®Œæˆï¼Œä¿å­˜åˆ°memory
              const keyLabel: Record<string, string> = {
                'job_type': 'å·¥ä½œç±»å‹',
                'salary_expectation': 'æœŸæœ›è–ªèµ„',
                'work_location': 'å·¥ä½œåœ°ç‚¹',
                'company_size': 'å…¬å¸è§„æ¨¡',
                'industry_preference': 'è¡Œä¸šåå¥½',
                'remote_preference': 'è¿œç¨‹åŠå…¬',
                'start_time': 'å…¥èŒæ—¶é—´',
                'overtime_attitude': 'åŠ ç­æ€åº¦',
                'travel_requirement': 'å‡ºå·®æ¥å—åº¦',
                'career_focus': 'èŒä¸šå…³æ³¨ç‚¹'
              };
              
              let preferenceSummary = `ã€æ±‚èŒåå¥½ä¿¡æ¯ã€‘\n`;
              newAnswers.forEach(a => {
                preferenceSummary += `${keyLabel[a.key] || a.key}: ${a.answer}\n`;
              });
              
              // ä¿å­˜åˆ°Memory
              try {
                await createMemory({
                  type: 'preference',
                  content: preferenceSummary,
                  importance: 'High',
                  scope: 'candidate'
                }, userId);
                console.log('[JobSearch] æ±‚èŒåå¥½å·²ä¿å­˜åˆ° Memory');
              } catch (err) {
                console.error('[JobSearch] ä¿å­˜æ±‚èŒåå¥½å¤±è´¥:', err);
              }
              
              // æ˜¾ç¤ºåå¥½æ±‡æ€»
              let completionMsg = `ğŸ‰ **æ±‚èŒåå¥½æ”¶é›†å®Œæˆï¼**\n\n---\n\n## ğŸ“‹ æ‚¨çš„æ±‚èŒåå¥½æ±‡æ€»\n\n`;
              newAnswers.forEach(a => {
                completionMsg += `â€¢ **${keyLabel[a.key] || a.key}**: ${a.answer}\n`;
              });
              completionMsg += `\n---\n\nâœ… åå¥½å·²ä¿å­˜åˆ°æ‚¨çš„æ¡£æ¡ˆï¼`;
              
              addJobMsg(completionMsg, 'assistant');
              
              setJobSearchMode(prev => ({
                ...prev,
                answers: newAnswers,
                completed: true,
                isSearching: true
              }));
              
              // æ›´æ–°ä»»åŠ¡è¿›åº¦
              if (selectedTask) {
                try {
                  await updateTodo(selectedTask.id, { progress: 30, status: 'IN_PROGRESS' });
                  if (typeof refetchTasks === 'function') {
                    refetchTasks();
                  }
                } catch (err) {
                  console.error('[JobSearch] æ›´æ–°ä»»åŠ¡è¿›åº¦å¤±è´¥:', err);
                }
              }
              
              // æ ¹æ®ç”¨æˆ·å®é™… account_tier è·å–ä¼šå‘˜ç­‰çº§
              const tier = (user?.account_tier || 'FREE').toUpperCase();
              const userMembership = tier === 'ULTRA' ? 'ultra' : tier === 'PRO' ? 'pro' : 'basic';
              const membershipConfig: Record<string, {name: string; days: number; color: string}> = {
                'basic': { name: 'Devnors 1.0', days: 1, color: 'slate' },
                'pro': { name: 'Devnors 1.0 Pro', days: 7, color: 'indigo' },
                'ultra': { name: 'Devnors 1.0 Ultra', days: 30, color: 'amber' }
              };
              const membership = membershipConfig[userMembership] || membershipConfig['basic'];
              
              // å¯åŠ¨äº‘ç«¯è½®å·¡ä»»åŠ¡
              setTimeout(async () => {
                const startTime = new Date();
                const endTime = new Date(startTime.getTime() + membership.days * 24 * 60 * 60 * 1000);
                
                // æ£€æŸ¥æ˜¯å¦å·²åœ¨äº‘ç«¯è½®å·¡ä»»åŠ¡ä¸­
                const isInCloudTask = selectedTask?.title?.includes('äº‘ç«¯æ±‚èŒè½®å·¡');
                const taskTitle = selectedTask?.title || 'äº‘ç«¯æ±‚èŒè½®å·¡';
                
                // æ›´æ–°å½“å‰ä»»åŠ¡çŠ¶æ€ä¸ºè¿è¡Œä¸­
                if (selectedTask) {
                  try {
                    await updateTodo(selectedTask.id, { progress: 10, status: 'RUNNING' });
                    if (typeof refetchTasks === 'function') {
                      refetchTasks();
                    }
                  } catch (err) {
                    console.error('[JobSearch] æ›´æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥:', err);
                  }
                }
                
                let taskStartedMsg = `ğŸš€ **${isInCloudTask ? 'äº‘ç«¯è½®å·¡ä»»åŠ¡å·²å¯åŠ¨' : 'æ™ºèƒ½æ±‚èŒä»»åŠ¡å·²å¯åŠ¨'}ï¼**\n\n`;
                taskStartedMsg += `---\n\n## ğŸ“‹ ä»»åŠ¡è¯¦æƒ…\n\n`;
                taskStartedMsg += `| é¡¹ç›® | å†…å®¹ |\n`;
                taskStartedMsg += `|------|------|\n`;
                taskStartedMsg += `| ä»»åŠ¡åç§° | **${taskTitle}** |\n`;
                taskStartedMsg += `| ä¼šå‘˜ç­‰çº§ | **${membership.name}** |\n`;
                taskStartedMsg += `| è½®å·¡å‘¨æœŸ | **${membership.days} å¤©** |\n`;
                taskStartedMsg += `| å¼€å§‹æ—¶é—´ | ${startTime.toLocaleString('zh-CN')} |\n`;
                taskStartedMsg += `| ç»“æŸæ—¶é—´ | ${endTime.toLocaleString('zh-CN')} |\n`;
                taskStartedMsg += `| ä»»åŠ¡çŠ¶æ€ | ğŸŸ¢ è¿è¡Œä¸­ |\n\n`;
                taskStartedMsg += `---\n\n## ğŸ¤– AI æ±‚èŒä»£ç†å·¥ä½œæ¨¡å¼\n\n`;
                taskStartedMsg += `æ‚¨çš„ AI æ±‚èŒä»£ç†å°†åœ¨äº‘ç«¯ **24å°æ—¶ä¸é—´æ–­** ä¸ºæ‚¨å·¥ä½œï¼š\n\n`;
                taskStartedMsg += `â€¢ â° **æ¯å°æ—¶** æ‰«æå…¨ç½‘æ–°å¢å²—ä½\n`;
                taskStartedMsg += `â€¢ ğŸ¯ **è‡ªåŠ¨ç­›é€‰** åŒ¹é…åº¦ â‰¥ 85% çš„å²—ä½\n`;
                taskStartedMsg += `â€¢ ğŸ“¤ **è‡ªåŠ¨æŠ•é€’** ç¬¦åˆæ¡ä»¶çš„å²—ä½\n`;
                taskStartedMsg += `â€¢ ğŸ”” **å®æ—¶é€šçŸ¥** æŠ•é€’ç»“æœå’Œé¢è¯•é‚€è¯·\n\n`;
                taskStartedMsg += `---\n\n## ğŸ“Š é¢„è®¡æ•ˆæœ\n\n`;
                taskStartedMsg += `æ ¹æ®æ‚¨çš„ç®€å†å’Œåå¥½ï¼Œé¢„è®¡ ${membership.days} å¤©å†…ï¼š\n\n`;
                taskStartedMsg += `â€¢ æ‰«æå²—ä½ï¼š**${membership.days * 50}+** ä¸ª\n`;
                taskStartedMsg += `â€¢ æ™ºèƒ½æŠ•é€’ï¼š**${membership.days * 5}-${membership.days * 10}** ä¸ª\n`;
                taskStartedMsg += `â€¢ é¢è¯•é‚€è¯·ï¼š**${Math.ceil(membership.days * 1.5)}-${membership.days * 3}** ä¸ªï¼ˆé¢„ä¼°ï¼‰\n\n`;
                taskStartedMsg += `---\n\nğŸ’¡ **æ¸©é¦¨æç¤º**ï¼š\n`;
                taskStartedMsg += `â€¢ ä»»åŠ¡è¿è¡ŒæœŸé—´ï¼Œè¯·ä¿æŒæ‰‹æœºç•…é€šä»¥æ¥æ”¶é¢è¯•é‚€è¯·\n`;
                taskStartedMsg += `â€¢ æ‚¨å¯ä»¥éšæ—¶è¾“å…¥ã€Œæš‚åœè½®å·¡ã€æš‚åœä»»åŠ¡\n`;
                taskStartedMsg += `â€¢ è¾“å…¥ã€ŒæŸ¥çœ‹è¿›åº¦ã€å¯æŸ¥çœ‹å®æ—¶æŠ•é€’è¿›åº¦\n`;
                taskStartedMsg += `â€¢ è¾“å…¥ã€Œä¿®æ”¹åå¥½ã€å¯æ›´æ–°æ±‚èŒåå¥½\n\n`;
                taskStartedMsg += `---\n\nğŸš€ **ä»»åŠ¡å·²å¼€å§‹è¿è¡Œï¼ŒAI æ­£åœ¨ä¸ºæ‚¨æœç´¢åˆé€‚çš„å²—ä½...**`;
                
                addJobMsg(taskStartedMsg, 'assistant');
                
                // ä»åç«¯è·å–çœŸå®æŠ•é€’æ•°æ®
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                let firstBatchMsg = `ğŸ“¬ **é¦–è½®æŠ•é€’å®Œæˆï¼**\n\n`;
                firstBatchMsg += `---\n\n### âœ… æœ¬è½®æŠ•é€’ (${new Date().toLocaleTimeString('zh-CN')})\n\n`;
                try {
                  const { getPublicFlows, getFlowStats } = await import('./services/apiService');
                  const realFlows = await getPublicFlows(50, userId);
                  const realStats = await getFlowStats(userId);
                  
                  if (realFlows && realFlows.length > 0) {
                    firstBatchMsg += `| å²—ä½ | å…¬å¸ | åŒ¹é…åº¦ | è–ªèµ„ | çŠ¶æ€ |\n`;
                    firstBatchMsg += `|------|------|--------|------|------|\n`;
                    realFlows.forEach((flow: any) => {
                      const statusIcon = flow.status === 'completed' ? 'âœ… å·²é€šè¿‡' 
                        : flow.status === 'rejected' ? 'âŒ æœªé€šè¿‡' 
                        : flow.status === 'screening' ? 'ğŸ” ç­›é€‰ä¸­' 
                        : 'ğŸ“¤ å·²æŠ•é€’';
                      firstBatchMsg += `| ${flow.role || 'æœªçŸ¥èŒä½'} | ${flow.company || 'æœªçŸ¥'} | ${flow.matchScore || 0}% | ${flow.salary || 'é¢è®®'} | ${statusIcon} |\n`;
                    });
                    firstBatchMsg += `\n---\n\n### ğŸ“Š æŠ•é€’ç»Ÿè®¡\n\n`;
                    firstBatchMsg += `| æŒ‡æ ‡ | æ•°æ® |\n`;
                    firstBatchMsg += `|------|------|\n`;
                    firstBatchMsg += `| å·²æ‰«æå²—ä½ | **${realStats?.viewed || 0}** ä¸ª |\n`;
                    firstBatchMsg += `| å·²æŠ•é€’ | **${realStats?.applied || 0}** ä¸ª |\n`;
                    firstBatchMsg += `| å·²é€šè¿‡ | **${realStats?.passed || 0}** ä¸ª |\n`;
                    firstBatchMsg += `| è¿›è¡Œä¸­ | **${realStats?.pending || 0}** ä¸ª |\n`;
                    firstBatchMsg += `| æœªé€šè¿‡ | **${realStats?.rejected || 0}** ä¸ª |\n`;
                    firstBatchMsg += `| å¹³å‡åŒ¹é…åº¦ | **${realStats?.avgMatch || 0}%** |\n`;
                  } else {
                    firstBatchMsg += `æš‚æ— æŠ•é€’è®°å½•ï¼ŒAI æ­£åœ¨æœç´¢åŒ¹é…å²—ä½ä¸­...\n`;
                  }
                } catch (err) {
                  console.error('[JobSearch] è·å–çœŸå®æŠ•é€’æ•°æ®å¤±è´¥:', err);
                  firstBatchMsg += `æ­£åœ¨è·å–æŠ•é€’æ•°æ®...\n`;
                }
                firstBatchMsg += `\n---\n\nâ° **ä¸‹æ¬¡è½®å·¡**: 1å°æ—¶å\n\n`;
                firstBatchMsg += `ğŸ”” AI å°†æŒç»­åœ¨äº‘ç«¯ä¸ºæ‚¨å·¥ä½œï¼Œæœ‰æ–°çš„æŠ•é€’æˆ–é¢è¯•é‚€è¯·ä¼šç«‹å³é€šçŸ¥æ‚¨ï¼`;
                
                addJobMsg(firstBatchMsg, 'assistant');
                
                // æ›´æ–°ä»»åŠ¡è¿›åº¦ï¼ˆä¸è®¾ä¸ºå®Œæˆï¼Œå› ä¸ºæ˜¯é•¿æœŸè¿è¡Œçš„ä»»åŠ¡ï¼‰
                if (selectedTask) {
                  try {
                    await updateTodo(selectedTask.id, { progress: 25 });
                    if (typeof refetchTasks === 'function') {
                      refetchTasks();
                    }
                  } catch (err) {
                    console.error('[JobSearch] æ›´æ–°ä»»åŠ¡è¿›åº¦å¤±è´¥:', err);
                  }
                }
                
                setJobSearchMode(prev => ({
                  ...prev,
                  isSearching: false,
                  tokenUsed: 200
                }));
                setIsTyping(false);
              }, 3000);
            }
            setIsTyping(false);
          }, 500);
          return;
        }
      }
      
      // æ— æ•ˆè¾“å…¥
      setTimeout(() => {
        if (jobSearchMode.currentQuestion === 0) {
          addJobMsg(`è¯·è¾“å…¥ã€Œå¼€å§‹ã€æ¥å¼€å§‹æ±‚èŒåå¥½è°ƒæŸ¥ã€‚`, 'assistant');
        } else if (!jobSearchMode.completed) {
          addJobMsg(`è¯·è¾“å…¥æœ‰æ•ˆçš„é€‰é¡¹ï¼ˆA/B/C/Dï¼‰æ¥å›ç­”å½“å‰é—®é¢˜ã€‚`, 'assistant');
        }
        setIsTyping(false);
      }, 500);
      return;
    }
    
    // å®Œå–„è®¤è¯æ¨¡å¼å¤„ç†
    if (verificationMode.active) {
      setInputMessage('');
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      const addUserMessage = (content: string) => {
        if (selectedTask) {
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'user' as const, content}]
          }));
        } else {
          setGeneralMessages(prev => [...prev, {role: 'user' as const, content}]);
        }
      };
      
      // æ·»åŠ  AI æ¶ˆæ¯
      const addAssistantMsg = (content: string) => {
        if (selectedTask) {
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'assistant' as const, content}]
          }));
        } else {
          setGeneralMessages(prev => [...prev, {role: 'assistant' as const, content}]);
        }
      };
      
      addUserMessage(userMessage);
      setIsTyping(true);
      
      const currentIndex = verificationMode.currentIndex;
      const currentItem = verificationMode.items[currentIndex];
      const totalItems = verificationMode.items.length;
      const completedCount = verificationMode.completedItems.length;
      
      // åˆ¤æ–­æ˜¯å¦æ˜¯èº«ä»½è¯è®¤è¯é¡¹
      const isIdentityItem = currentItem?.key === 'identity_front' || currentItem?.key === 'identity_back';
      
      // ç”¨æˆ·é€‰æ‹©è·³è¿‡
      if (userMessage.includes('è·³è¿‡')) {
        // èº«ä»½è®¤è¯ä¸èƒ½è·³è¿‡
        if (isIdentityItem) {
          setTimeout(() => {
            addAssistantMsg(`âš ï¸ **èº«ä»½è®¤è¯æ˜¯å¿…å¡«é¡¹**ï¼Œä¸èƒ½è·³è¿‡ã€‚\n\nèº«ä»½è®¤è¯æ˜¯æ‰€æœ‰è®¤è¯çš„åŸºç¡€ï¼Œåç»­è®¤è¯éœ€è¦ä¸èº«ä»½è¯å§“åè¿›è¡Œæ ¸å¯¹ã€‚\n\nğŸ“· è¯·ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®ä¸Šä¼ èº«ä»½è¯ç…§ç‰‡ã€‚`);
            setIsTyping(false);
          }, 500);
          return;
        }
        
        // å…¶ä»–è®¤è¯å¯ä»¥è·³è¿‡
        setTimeout(async () => {
          const nextIndex = currentIndex + 1;
          
          if (nextIndex >= totalItems) {
            // æ‰€æœ‰è®¤è¯é¡¹éƒ½å·²å¤„ç†
            addAssistantMsg(`â­ï¸ å·²è·³è¿‡ã€Œ${currentItem.label}ã€\n\n---\n\nğŸ“‹ **è®¤è¯æµç¨‹ç»“æŸ**\n\nâœ… å·²å®Œæˆï¼š${completedCount} é¡¹è®¤è¯\n\n${completedCount > 0 ? 'ğŸ‰ æ‚¨å·²å®Œæˆéƒ¨åˆ†è®¤è¯ï¼å·²è®¤è¯çš„ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨æ‚¨çš„ä¸ªäººä¸»é¡µã€‚' : 'ğŸ’¡ æ‚¨å¯ä»¥éšæ—¶è¿”å›å®Œæˆè®¤è¯ï¼Œæé«˜æ±‚èŒç«äº‰åŠ›ã€‚'}\n\nğŸ‘‰ å‰å¾€ [è®¾ç½® - ä¸ªäººè®¤è¯ä¿¡æ¯](/settings?tab=PersonalVerification) æŸ¥çœ‹è¯¦æƒ…\n\nè¿˜æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`);
            setVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
            
            // æ›´æ–°ä»»åŠ¡ä¸ºå®Œæˆï¼ˆ100%ï¼‰
            if (selectedTask) {
              try {
                const { updateTodo } = await import('./services/apiService');
                await updateTodo(selectedTask.id, { 
                  progress: 100, 
                  status: 'completed' 
                });
                if (typeof refetchTasks === 'function') {
                  refetchTasks();
                }
              } catch (updateError) {
                console.error('æ›´æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥:', updateError);
              }
            }
          } else {
            // ç»§ç»­ä¸‹ä¸€é¡¹
            const nextItem = verificationMode.items[nextIndex];
            addAssistantMsg(`â­ï¸ å·²è·³è¿‡ã€Œ${currentItem.label}ã€\n\n---\n\nğŸ“‹ **è®¤è¯è¿›åº¦ï¼š** ${completedCount}/${totalItems} é¡¹\n\n${nextItem.icon} **ç¬¬ ${nextIndex + 1} é¡¹ï¼š${nextItem.label}**\n\n${nextItem.description}`);
            setVerificationMode(prev => ({
              ...prev,
              currentIndex: nextIndex
            }));
          }
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // ç”¨æˆ·é€‰æ‹©é€€å‡º
      if (userMessage.includes('é€€å‡º') || userMessage.includes('å–æ¶ˆ') || userMessage.includes('ç¨å')) {
        // èº«ä»½è®¤è¯é˜¶æ®µä¸èƒ½é€€å‡º
        if (isIdentityItem) {
          setTimeout(() => {
            addAssistantMsg(`âš ï¸ **èº«ä»½è®¤è¯æ˜¯å¿…å¡«é¡¹**ï¼Œè¯·å…ˆå®Œæˆèº«ä»½è®¤è¯ã€‚\n\nğŸ“· è¯·ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®ä¸Šä¼ èº«ä»½è¯ç…§ç‰‡ã€‚`);
            setIsTyping(false);
          }, 500);
          return;
        }
        
        setTimeout(() => {
          addAssistantMsg(`å¥½çš„ï¼Œæ‚¨å¯ä»¥ç¨åç»§ç»­å®Œæˆè®¤è¯ã€‚\n\nâœ… å·²å®Œæˆï¼š${completedCount} é¡¹\n\nğŸ’¡ å®Œæˆè®¤è¯å¯ä»¥å¤§å¹…æé«˜æ±‚èŒæˆåŠŸç‡ï¼\n\nè¿˜æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`);
          setVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // å¤„ç†ç”¨æˆ·è¾“å…¥çš„è®¤è¯ä¿¡æ¯
      setTimeout(async () => {
        try {
          // æ£€æŸ¥å½“å‰è®¤è¯é¡¹æ˜¯å¦éœ€è¦å›¾ç‰‡ä¸Šä¼ 
          if (currentItem && currentItem.needsImage) {
            // éœ€è¦å›¾ç‰‡ä¸Šä¼ çš„é¡¹ç›®ï¼Œæç¤ºç”¨æˆ·ç‚¹å‡»ä¸Šä¼ æŒ‰é’®
            addAssistantMsg(`ğŸ“· **è¯·ç‚¹å‡»å·¦ä¸‹è§’çš„ã€Œä¸Šä¼ è¯ä»¶ã€æŒ‰é’®ä¸Šä¼ æ‚¨çš„${currentItem.label}å›¾ç‰‡**\n\n${currentItem.description}`);
            setIsTyping(false);
            return;
          }
          
          // ä¸éœ€è¦å›¾ç‰‡çš„è®¤è¯é¡¹ï¼ˆå¦‚å¾ä¿¡è®¤è¯ï¼‰
          let success = false;
          let savedInfo = '';
          
          if (currentItem.key === 'credit') {
            // å¾ä¿¡è®¤è¯ï¼šåªéœ€è¦æˆæƒ
            if (userMessage.includes('æˆæƒ') || userMessage.includes('åŒæ„') || userMessage.includes('ç¡®è®¤')) {
              success = true;
              savedInfo = 'å·²æˆæƒå¾ä¿¡æŸ¥è¯¢';
            }
          }
          
          if (success) {
            const newCompletedItems = [...verificationMode.completedItems, currentItem.key];
            const nextIndex = currentIndex + 1;
            
            // ä¿å­˜è®¤è¯ä¿¡æ¯åˆ°æ•°æ®åº“å¹¶æ›´æ–°ä»»åŠ¡è¿›åº¦
            try {
              const { createPersonalCertification, updateTodo } = await import('./services/apiService');
              
              // ä¿å­˜è®¤è¯ä¿¡æ¯
              const certData = {
                name: currentItem.key === 'credit' ? 'å¾ä¿¡è®¤è¯' : currentItem.label,
                organization: 'ç³»ç»Ÿè®¤è¯',
                cert_date: new Date().toISOString().split('T')[0],
                category: currentItem.key,
                color: 'orange',
                icon: 'FileCheck'
              };
              await createPersonalCertification(certData, userId);
              console.log(`[Certification] å·²ä¿å­˜${currentItem.label}åˆ°æ•°æ®åº“`);
              
              // æ›´æ–°ä»»åŠ¡è¿›åº¦
              if (selectedTask) {
                const progress = Math.round((newCompletedItems.length / totalItems) * 100);
                const taskStatus = progress >= 100 ? 'completed' : 'in_progress';
                await updateTodo(selectedTask.id, { 
                  progress, 
                  status: taskStatus 
                });
                console.log(`[Task Progress] ä»»åŠ¡è¿›åº¦æ›´æ–°ä¸º ${progress}%`);
                
                // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                if (typeof refetchTasks === 'function') {
                  refetchTasks();
                }
              }
            } catch (saveError) {
              console.error('ä¿å­˜è®¤è¯ä¿¡æ¯å¤±è´¥:', saveError);
            }
            
            if (nextIndex >= totalItems) {
              // æ‰€æœ‰è®¤è¯é¡¹éƒ½å·²å®Œæˆ
              addAssistantMsg(`âœ… **${currentItem.label}è®¤è¯æˆåŠŸï¼**\n\n${savedInfo}\n\n---\n\nğŸ‰ **æ­å–œï¼æ‚¨å·²å®Œæˆå…¨éƒ¨è®¤è¯ï¼**\n\nâœ… å·²å®Œæˆï¼š${newCompletedItems.length}/${totalItems} é¡¹\n\næ‚¨çš„è®¤è¯ä¿¡æ¯å·²ä¿å­˜ï¼Œè¿™å°†å¤§å¹…æå‡æ‚¨çš„æ±‚èŒç«äº‰åŠ›ï¼\n\nğŸ‘‰ å‰å¾€ [è®¾ç½® - ä¸ªäººè®¤è¯ä¿¡æ¯](/settings?tab=PersonalVerification) æŸ¥çœ‹è¯¦æƒ…\n\nè¿˜æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`);
              setVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
            } else {
              // ç»§ç»­ä¸‹ä¸€é¡¹
              const nextItem = verificationMode.items[nextIndex];
              addAssistantMsg(`âœ… **${currentItem.label}è®¤è¯æˆåŠŸï¼**\n\n${savedInfo}\n\n---\n\nğŸ“‹ **è®¤è¯è¿›åº¦ï¼š** ${newCompletedItems.length}/${totalItems} é¡¹\n\n${nextItem.icon} **ç¬¬ ${nextIndex + 1} é¡¹ï¼š${nextItem.label}**\n\n${nextItem.description}`);
              setVerificationMode(prev => ({
                ...prev,
                currentIndex: nextIndex,
                completedItems: newCompletedItems
              }));
            }
          } else {
            // è¾“å…¥æ ¼å¼ä¸æ­£ç¡®
            addAssistantMsg(`âš ï¸ è¯·æŒ‰ç…§ä»¥ä¸‹æç¤ºæ“ä½œï¼š\n\n${currentItem.description}`);
          }
          
          setIsTyping(false);
        } catch (error) {
          console.error('å¤„ç†è®¤è¯ä¿¡æ¯å¤±è´¥:', error);
          addAssistantMsg(`æŠ±æ­‰ï¼Œå¤„ç†è®¤è¯ä¿¡æ¯æ—¶å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚`);
          setIsTyping(false);
        }
      }, 800);
      
      return;
    }
    
    // ä¼ä¸šè®¤è¯æ¨¡å¼å¤„ç†
    if (enterpriseVerificationMode.active) {
      setInputMessage('');
      
      const addUserMsg = (content: string) => {
        if (selectedTask) {
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'user' as const, content}]
          }));
        } else {
          setGeneralMessages(prev => [...prev, {role: 'user' as const, content}]);
        }
      };
      
      const addAssistantMsg = (content: string) => {
        if (selectedTask) {
          setTaskMessages(prev => ({
            ...prev,
            [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'assistant' as const, content}]
          }));
        } else {
          setGeneralMessages(prev => [...prev, {role: 'assistant' as const, content}]);
        }
      };
      
      addUserMsg(userMessage);
      setIsTyping(true);
      
      const currentIndex = enterpriseVerificationMode.currentIndex;
      const currentItem = enterpriseVerificationItems[currentIndex];
      const totalItems = enterpriseVerificationItems.length;
      const completedCount = enterpriseVerificationMode.completedItems.length;
      
      // æ£€æŸ¥ currentItem æ˜¯å¦æœ‰æ•ˆ
      if (!currentItem) {
        console.error('[handleSendMessage] Enterprise verification currentItem is undefined, currentIndex:', currentIndex);
        setTimeout(() => {
          addAssistantMsg(`âš ï¸ å½“å‰è®¤è¯é¡¹æ— æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚`);
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // ç”¨æˆ·é€‰æ‹©è·³è¿‡
      if (userMessage.includes('è·³è¿‡')) {
        // è¥ä¸šæ‰§ç…§ä¸èƒ½è·³è¿‡
        if (currentItem.required) {
          setTimeout(() => {
            addAssistantMsg(`âš ï¸ **${currentItem.label}æ˜¯å¿…å¡«é¡¹**ï¼Œä¸èƒ½è·³è¿‡ã€‚\n\nè¥ä¸šæ‰§ç…§æ˜¯ä¼ä¸šè®¤è¯çš„åŸºç¡€ï¼Œåç»­è®¤è¯éœ€è¦ä¸è¥ä¸šæ‰§ç…§ä¿¡æ¯è¿›è¡Œæ ¸å¯¹ã€‚\n\nğŸ“· è¯·ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®ä¸Šä¼ è¥ä¸šæ‰§ç…§ç…§ç‰‡ã€‚`);
            setIsTyping(false);
          }, 500);
          return;
        }
        
        // å…¶ä»–è®¤è¯å¯ä»¥è·³è¿‡
        setTimeout(async () => {
          const nextIndex = currentIndex + 1;
          
          if (nextIndex >= totalItems) {
            addAssistantMsg(`â­ï¸ å·²è·³è¿‡ã€Œ${currentItem.label}ã€\n\n---\n\nğŸ“‹ **ä¼ä¸šè®¤è¯æµç¨‹ç»“æŸ**\n\nâœ… å·²å®Œæˆï¼š${completedCount} é¡¹è®¤è¯\n\n${completedCount > 0 ? 'ğŸ‰ æ‚¨çš„ä¼ä¸šå·²å®Œæˆéƒ¨åˆ†è®¤è¯ï¼å·²è®¤è¯çš„ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨ä¼ä¸šä¸»é¡µã€‚' : 'ğŸ’¡ æ‚¨å¯ä»¥éšæ—¶è¿”å›å®Œæˆè®¤è¯ï¼Œæé«˜æ‹›è˜æ•ˆæœã€‚'}\n\nğŸ‘‰ å‰å¾€ [è®¾ç½® - ä¼ä¸šè®¤è¯ä¿¡æ¯](/settings?tab=Verification) æŸ¥çœ‹è¯¦æƒ…\n\nè¿˜æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`);
            setEnterpriseVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
            
            if (selectedTask) {
              try {
                const { updateTodo } = await import('./services/apiService');
                await updateTodo(selectedTask.id, { progress: 100, status: 'completed' });
                if (typeof refetchTasks === 'function') refetchTasks();
              } catch (e) {
                console.error('æ›´æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
              }
            }
          } else {
            const nextItem = enterpriseVerificationItems[nextIndex];
            addAssistantMsg(`â­ï¸ å·²è·³è¿‡ã€Œ${currentItem.label}ã€\n\n---\n\nğŸ“‹ **è®¤è¯è¿›åº¦ï¼š** ${completedCount}/${totalItems} é¡¹\n\n${nextItem.icon} **ç¬¬ ${nextIndex + 1} é¡¹ï¼š${nextItem.label}**\n\n${nextItem.description}`);
            setEnterpriseVerificationMode(prev => ({ ...prev, currentIndex: nextIndex }));
          }
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // ç”¨æˆ·é€‰æ‹©é€€å‡º
      if (userMessage.includes('é€€å‡º') || userMessage.includes('å–æ¶ˆ') || userMessage.includes('ç¨å')) {
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¿…å¡«é¡¹éƒ½å·²å®Œæˆ
        const completedItems = enterpriseVerificationMode.completedItems;
        const requiredItems = enterpriseVerificationItems.filter(item => item.required);
        const allRequiredCompleted = requiredItems.every(item => completedItems.includes(item.key));
        
        if (!allRequiredCompleted) {
          // æ‰¾å‡ºæœªå®Œæˆçš„å¿…å¡«é¡¹
          const incompleteRequired = requiredItems.filter(item => !completedItems.includes(item.key));
          const incompleteList = incompleteRequired.map(item => `â€¢ ${item.label}`).join('\n');
          setTimeout(() => {
            addAssistantMsg(`âš ï¸ **è¯·å…ˆå®Œæˆæ‰€æœ‰å¿…å¡«è®¤è¯é¡¹**\n\nä»¥ä¸‹è®¤è¯é¡¹ä¸ºå¿…å¡«ï¼š\n${incompleteList}\n\nğŸ“· è¯·ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®ä¸Šä¼ è¯ä»¶ç…§ç‰‡ã€‚`);
            setIsTyping(false);
          }, 500);
          return;
        }
        
        setTimeout(() => {
          addAssistantMsg(`ğŸ“‹ **å·²æš‚åœä¼ä¸šè®¤è¯**\n\nå½“å‰è¿›åº¦ï¼š${completedCount}/${totalItems} é¡¹\n\næ‚¨å¯ä»¥éšæ—¶è¿”å›ç»§ç»­å®Œæˆè®¤è¯ã€‚å·²å®Œæˆçš„è®¤è¯ä¿¡æ¯ä¼šè‡ªåŠ¨ä¿å­˜ã€‚\n\nè¿˜æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`);
          setEnterpriseVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
          setIsTyping(false);
        }, 500);
        return;
      }
      
      // æç¤ºä¸Šä¼ å›¾ç‰‡
      setTimeout(() => {
        addAssistantMsg(`ğŸ“· è¯·ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®ä¸Šä¼  **${currentItem.label}** å›¾ç‰‡ã€‚\n\n${currentItem.description}`);
        setIsTyping(false);
      }, 500);
      return;
    }
    
    // æ™®é€šæ¶ˆæ¯å¤„ç†
    if (selectedTask) {
      setTaskMessages(prev => ({
        ...prev,
        [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'user', content: userMessage}]
      }));
    } else {
      setGeneralMessages(prev => [...prev, {role: 'user', content: userMessage}]);
    }
    
    setInputMessage('');
    setIsTyping(true);
    
    try {
      const taskTitle = selectedTask?.title || selectedTask?.task || '';
      const memCtx = getMemoryContext();
      let contextStr = '';
      if (selectedTask) {
        contextStr = `å½“å‰ä»»åŠ¡æ˜¯ï¼š${taskTitle}ã€‚ä»»åŠ¡æè¿°ï¼š${selectedTask?.description || ''}`;
      }
      if (memCtx) {
        contextStr += memCtx;
      }
      const result = await chatWithAI({
        message: userMessage,
        history: currentMessages.map(m => ({role: m.role, content: m.content})),
        model: selectedModel,
        context: contextStr || undefined,
        user_id: userId,
      });
      
      // æ£€æŸ¥ä½™é¢ä¸è¶³
      if (result.error === 'insufficient_tokens') {
        (window as any).__showTokenInsufficient?.(result.balance || 0);
        const insufficientMsg = {role: 'assistant' as const, content: `âš ï¸ Token ä½™é¢ä¸è¶³ï¼Œå½“å‰ä½™é¢ ${(result.balance || 0).toLocaleString()} tokensï¼Œæœ¬æ¬¡æ“ä½œé¢„ä¼°éœ€è¦ ${(result.required || 0).toLocaleString()} tokensã€‚è¯·å……å€¼åç»§ç»­ä½¿ç”¨ã€‚`};
        if (selectedTask) {
          setTaskMessages(prev => ({...prev, [selectedTask.id]: [...(prev[selectedTask.id] || []), insufficientMsg]}));
        } else {
          setGeneralMessages(prev => [...prev, insufficientMsg]);
        }
        return;
      }
      
      const aiResponse = {role: 'assistant' as const, content: result.response};
      
      if (selectedTask) {
        setTaskMessages(prev => ({
          ...prev,
          [selectedTask.id]: [...(prev[selectedTask.id] || []), aiResponse]
        }));
      } else {
        setGeneralMessages(prev => [...prev, aiResponse]);
      }
    } catch (error) {
      console.error('AI èŠå¤©å¤±è´¥:', error);
      const errorResponse = {role: 'assistant' as const, content: `æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‡ºç°é—®é¢˜ã€‚è¯·ç¨åå†è¯•ã€‚`};
      
      if (selectedTask) {
        setTaskMessages(prev => ({
          ...prev,
          [selectedTask.id]: [...(prev[selectedTask.id] || []), errorResponse]
        }));
      } else {
        setGeneralMessages(prev => [...prev, errorResponse]);
      }
    } finally {
      setIsTyping(false);
    }
  };

  // æ·»åŠ  AI æ¶ˆæ¯çš„è¾…åŠ©å‡½æ•°ï¼ˆç»„ä»¶çº§åˆ«ï¼‰
  const addFileUploadMessage = (content: string) => {
    if (selectedTask) {
      setTaskMessages(prev => ({
        ...prev,
        [selectedTask.id]: [...(prev[selectedTask.id] || []), {role: 'assistant' as const, content}]
      }));
    } else {
      setGeneralMessages(prev => [...prev, {role: 'assistant' as const, content}]);
    }
  };

  // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;
    
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    const fileExtension = file.name.split('.').pop()?.toLowerCase();
    const allowedExtensions = ['pdf', 'doc', 'docx', 'txt', 'md'];
    
    if (!allowedExtensions.includes(fileExtension || '')) {
      addFileUploadMessage('âŒ ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ã€‚è¯·ä¸Šä¼  PDFã€Word (.doc/.docx) æˆ–æ–‡æœ¬æ–‡ä»¶ (.txt/.md)ã€‚');
      if (fileInputRef.current) fileInputRef.current.value = '';
      return;
    }
    
    // æ£€æŸ¥æ–‡ä»¶å¤§å° (æœ€å¤§ 10MB)
    if (file.size > 10 * 1024 * 1024) {
      addFileUploadMessage('âŒ æ–‡ä»¶è¿‡å¤§ï¼Œè¯·ä¸Šä¼ ä¸è¶…è¿‡ 10MB çš„æ–‡ä»¶ã€‚');
      if (fileInputRef.current) fileInputRef.current.value = '';
      return;
    }
    
    setUploadingFile(true);
    addFileUploadMessage(`ğŸ“ æ­£åœ¨è§£ææ–‡ä»¶ï¼š**${file.name}**...\n\nè¯·ç¨å€™ï¼Œæ­£åœ¨ä½¿ç”¨ AI æå–ç®€å†å†…å®¹...`);
    
    try {
      // è°ƒç”¨åç«¯ API è§£ææ–‡ä»¶
      const { parseResumeFile, autoFillProfileFromResume } = await import('./services/apiService');
      const result = await parseResumeFile(file);
      
      if (result.success && result.content) {
        addFileUploadMessage(`âœ… **æ–‡ä»¶è§£ææˆåŠŸï¼**\n\nğŸ“„ æ–‡ä»¶ï¼š${result.filename}\nğŸ“Š æå–äº† ${result.char_count} ä¸ªå­—ç¬¦\n\nğŸ¤– æ­£åœ¨æ™ºèƒ½åˆ†æç®€å†ï¼Œè‡ªåŠ¨å¡«å……æ‚¨çš„ä¸ªäººèµ„æ–™...`);
        
        // è‡ªåŠ¨å¡«å……ç”¨æˆ·èµ„æ–™
        if (userId) {
          try {
            const fillResult = await autoFillProfileFromResume(userId, result.content);
            
            if (fillResult.success) {
              // æ„å»ºæˆåŠŸæ¶ˆæ¯
              let successMsg = `ğŸ‰ **ç®€å†æ™ºèƒ½è§£æå®Œæˆï¼**\n\n`;
              successMsg += `ğŸ“Š **ç®€å†å®Œå–„åº¦ï¼š${fillResult.completeness}%**\n\n`;
              
              if (fillResult.updates_made.length > 0) {
                successMsg += `âœ… **å·²è‡ªåŠ¨å¡«å……ä»¥ä¸‹ä¿¡æ¯ï¼š**\n`;
                fillResult.updates_made.forEach(field => {
                  successMsg += `â€¢ ${field}\n`;
                });
                successMsg += `\n`;
              }
              
              if (fillResult.memories_created.length > 0) {
                successMsg += `ğŸ’¾ **å·²ä¿å­˜åˆ°è®°å¿†ä¸­å¿ƒï¼š**\n`;
                fillResult.memories_created.forEach(mem => {
                  successMsg += `â€¢ ${mem}\n`;
                });
                successMsg += `\n`;
              }
              
              // æ ¹æ®å®Œå–„åº¦æ˜¾ç¤ºä¸åŒçš„å¼•å¯¼
              if (fillResult.completeness >= 100) {
                successMsg += `---\n\n`;
                successMsg += `æ‚¨å¯ä»¥ï¼š\n`;
                successMsg += `â€¢ å‰å¾€ [ä¸ªäººä¸»é¡µ](/candidate/profile) æŸ¥çœ‹å’Œç¼–è¾‘èµ„æ–™\n`;
                successMsg += `â€¢ å‰å¾€ [è®°å¿†ä¸­å¿ƒ](/candidate/memory) ç®¡ç†æ‚¨çš„è®°å¿†\n\n`;
                successMsg += `å®Œæˆä¸ªäººè®¤è¯ä¿¡æ¯ï¼Œæé«˜æ±‚èŒæœºä¼šï¼š\n\n`;
                successMsg += `[[TASK:å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯:personal_verification:ğŸ”]]`;
                addFileUploadMessage(successMsg);
              } else {
                // å®Œå–„åº¦ä¸åˆ°100%ï¼Œç»§ç»­å¼•å¯¼ç”¨æˆ·å®Œå–„
                successMsg += `---\n\n`;
                successMsg += `ğŸ“ ç»§ç»­å®Œå–„å‰©ä½™ä¿¡æ¯ï¼Œæé«˜åŒ¹é…åº¦...\n`;
                addFileUploadMessage(successMsg);
                
                // å»¶è¿Ÿå¯åŠ¨å¼•å¯¼æµç¨‹
                setTimeout(() => {
                  startProfileCompleteGuide(!!selectedTask);
                }, 1000);
              }
              
              // åˆ·æ–°ä»»åŠ¡è¿›åº¦
              await calculateProfileTaskProgress();
              
              // å¦‚æœå®Œå–„åº¦è¾¾åˆ°100%ï¼Œæ ‡è®°ä»»åŠ¡å®Œæˆ
              if (fillResult.completeness >= 100 && selectedTask) {
                const taskTitle = selectedTask.title || selectedTask.task || '';
                const taskType = selectedTask.todo_type || selectedTask.type || '';
                const isProfileTask = taskType === 'profile_complete' || 
                  taskTitle === 'å®Œå–„ç®€å†èµ„æ–™';
                
                if (isProfileTask && selectedTask.status !== 'completed') {
                  const { updateTodo, createTodo, getTasks } = await import('./services/apiService');
                  await updateTodo(selectedTask.id, { status: 'completed', progress: 100 });
                  
                  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨"å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯"ä»»åŠ¡
                  if (userId) {
                    const existingTasks = await getTasks(userId);
                    const hasVerificationTask = existingTasks.some((t: any) => 
                      t.todo_type === 'personal_verification' || 
                      t.title === 'å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯' ||
                      (t.title.includes('å®Œå–„') && t.title.includes('è®¤è¯'))
                    );
                    
                    if (!hasVerificationTask) {
                      // åˆ›å»º"å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯"ä»»åŠ¡
                      const verificationTaskData = {
                        title: 'å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯',
                        description: 'å®Œæˆèº«ä»½è®¤è¯ã€å­¦å†è®¤è¯ã€æŠ€èƒ½è®¤è¯ã€å·¥ä½œè¯æ˜ç­‰ï¼Œæå‡æ±‚èŒç«äº‰åŠ›ï¼Œå¢åŠ é¢è¯•æœºä¼š',
                        priority: 'high',
                        source: 'agent',
                        todo_type: 'personal_verification',
                        ai_advice: 'å®Œæˆä¸ªäººè®¤è¯å¯ä»¥å¤§å¹…æå‡æ‚¨çš„å¯ä¿¡åº¦å’Œæ±‚èŒæˆåŠŸç‡ã€‚å»ºè®®ä¼˜å…ˆå®Œæˆèº«ä»½è®¤è¯å’Œå­¦å†è®¤è¯ã€‚',
                        steps: [
                          { order: 1, title: 'å®Œæˆèº«ä»½è®¤è¯', status: 'pending' },
                          { order: 2, title: 'å®Œæˆå­¦å†è®¤è¯', status: 'pending' },
                          { order: 3, title: 'å®ŒæˆèŒä¸šèµ„æ ¼è®¤è¯', status: 'pending' },
                          { order: 4, title: 'å®Œæˆå¾ä¿¡è®¤è¯', status: 'pending' }
                        ]
                      };
                      
                      await createTodo(verificationTaskData, userId);
                      console.log('[Verification Task] å·²è‡ªåŠ¨åˆ›å»ºä¸ªäººè®¤è¯ä»»åŠ¡');
                    }
                  }
                  
                  if (typeof refetchTasks === 'function') {
                    refetchTasks();
                  }
                  
                }
              }
            } else {
              addFileUploadMessage(`âš ï¸ è‡ªåŠ¨å¡«å……éƒ¨åˆ†å¤±è´¥ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨å®Œå–„èµ„æ–™ã€‚\n\nç®€å†å†…å®¹å·²å¡«å…¥ä¸‹æ–¹è¾“å…¥æ¡†ï¼Œç‚¹å‡»å‘é€å¯ç»§ç»­åˆ†æã€‚`);
              setInputMessage(result.content.substring(0, 5000));
            }
          } catch (fillError: any) {
            console.error('è‡ªåŠ¨å¡«å……å¤±è´¥:', fillError);
            addFileUploadMessage(`âš ï¸ è‡ªåŠ¨å¡«å……å¤±è´¥ï¼š${fillError.message}\n\nç®€å†å†…å®¹å·²å¡«å…¥ä¸‹æ–¹è¾“å…¥æ¡†ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨å®Œå–„èµ„æ–™ã€‚`);
            setInputMessage(result.content.substring(0, 5000));
          }
        } else {
          // æœªç™»å½•ï¼Œåªå¡«å…¥è¾“å…¥æ¡†
          setInputMessage(result.content.substring(0, 5000));
          addFileUploadMessage(`âœ… æ–‡ä»¶è§£ææˆåŠŸï¼\n\nè¯·å…ˆç™»å½•åå†ä¸Šä¼ ç®€å†ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å¡«å……æ‚¨çš„ä¸ªäººèµ„æ–™ã€‚`);
        }
      } else {
        addFileUploadMessage('âŒ æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ–‡ä»¶åé‡è¯•ã€‚');
      }
    } catch (error: any) {
      console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
      addFileUploadMessage(`âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}\n\nè¯·å°è¯•ç›´æ¥å¤åˆ¶ç²˜è´´ç®€å†å†…å®¹åˆ°è¾“å…¥æ¡†ã€‚`);
    } finally {
      setUploadingFile(false);
      if (fileInputRef.current) fileInputRef.current.value = '';
    }
  };

  // å¤„ç†è¯ä»¶å›¾ç‰‡ä¸Šä¼ å’Œ AI å®¡æ ¸
  const handleCertImageUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;
    
    // æ£€æŸ¥æ˜¯å¦å¤„äºä¸ªäººè®¤è¯æ¨¡å¼æˆ–ä¼ä¸šè®¤è¯æ¨¡å¼
    const isPersonalVerification = verificationMode.active;
    const isEnterpriseVerification = enterpriseVerificationMode.active;
    
    if (!isPersonalVerification && !isEnterpriseVerification) {
      if (certImageInputRef.current) certImageInputRef.current.value = '';
      return;
    }
    
    // æ ¹æ®è®¤è¯æ¨¡å¼è·å–å½“å‰é¡¹
    const currentIndex = isPersonalVerification ? verificationMode.currentIndex : enterpriseVerificationMode.currentIndex;
    const currentItem = isPersonalVerification ? verificationMode.items[currentIndex] : enterpriseVerificationItems[currentIndex];
    const totalItems = isPersonalVerification ? verificationMode.items.length : enterpriseVerificationItems.length;
    
    // æ£€æŸ¥ currentItem æ˜¯å¦æœ‰æ•ˆ
    if (!currentItem) {
      console.error('[handleCertImageUpload] currentItem is undefined, currentIndex:', currentIndex);
      addCertImageMessage(`âŒ å›¾ç‰‡å¤„ç†å¤±è´¥\n\nå½“å‰è®¤è¯é¡¹æ— æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚`);
      if (certImageInputRef.current) certImageInputRef.current.value = '';
      return;
    }
    
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    const fileType = file.type;
    if (!['image/jpeg', 'image/png', 'image/jpg'].includes(fileType)) {
      addCertImageMessage(`âŒ ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ã€‚è¯·ä¸Šä¼  JPG æˆ– PNG æ ¼å¼çš„å›¾ç‰‡ã€‚`);
      if (certImageInputRef.current) certImageInputRef.current.value = '';
      return;
    }
    
    // æ£€æŸ¥æ–‡ä»¶å¤§å° (æœ€å¤§ 10MB)
    if (file.size > 10 * 1024 * 1024) {
      addCertImageMessage(`âŒ å›¾ç‰‡è¿‡å¤§ï¼Œè¯·ä¸Šä¼ ä¸è¶…è¿‡ 10MB çš„å›¾ç‰‡ã€‚`);
      if (certImageInputRef.current) certImageInputRef.current.value = '';
      return;
    }
    
    setUploadingCertImage(true);
    
    // æ·»åŠ ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡çš„æ¶ˆæ¯
    addCertImageMessage(`ğŸ“¤ æ­£åœ¨ä¸Šä¼ è¯ä»¶å›¾ç‰‡ï¼š**${file.name}**...`);
    
    try {
      // è·å–å›¾ç‰‡ä¿¡æ¯ç”¨äºæ˜¾ç¤º
      const fileSizeKB = (file.size / 1024).toFixed(1);
      
      // æ·»åŠ å›¾ç‰‡ä¿¡æ¯æ¶ˆæ¯
      addCertImageMessage(`ğŸ–¼ï¸ **å·²æ”¶åˆ°å›¾ç‰‡ï¼Œæ­£åœ¨ä½¿ç”¨ AI OCR å®¡æ ¸...**\n\nğŸ“„ æ–‡ä»¶ï¼š${file.name}\nğŸ“Š å¤§å°ï¼š${fileSizeKB} KB\nğŸ” çŠ¶æ€ï¼šAI æ­£åœ¨è¯†åˆ«è¯ä»¶å†…å®¹...`);
      
      setIsTyping(true);
      
      // è¯»å–å›¾ç‰‡ä¸º base64
      const imageBase64 = await new Promise<string>((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result as string;
          // ç§»é™¤ data URL å‰ç¼€ï¼Œåªä¿ç•™ base64 æ•°æ®
          const base64Data = result.split(',')[1];
          resolve(base64Data);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
      
      // è°ƒç”¨åç«¯ OCR API è¿›è¡ŒçœŸæ­£çš„å›¾ç‰‡å†…å®¹è¯†åˆ«
      const { certOCRReview } = await import('./services/apiService');
      const ocrResult = await certOCRReview(imageBase64, currentItem.key as 'education' | 'skill_driver' | 'skill_cert' | 'work' | 'identity_front' | 'identity_back' | 'credit_fund' | 'credit_social' | 'business_license' | 'org_code' | 'tax_registration' | 'legal_person_id' | 'legal_person_id_front' | 'legal_person_id_back' | 'qualification' | 'enterprise_credit', userId);
      
      // è½¬æ¢ OCR ç»“æœæ ¼å¼
      const reviewResult = {
        success: ocrResult.success,
        reason: ocrResult.reason,
        extractedInfo: ocrResult.extracted_info,
        detectedSide: ocrResult.detected_side as 'front' | 'back' | undefined
      };
      
      if (reviewResult.success) {
        // å®¡æ ¸é€šè¿‡ï¼ˆåç«¯å·²éªŒè¯å§“åä¸€è‡´æ€§ï¼‰
        
        // ========== ä¼ä¸šè®¤è¯å¤„ç†åˆ†æ”¯ ==========
        if (isEnterpriseVerification) {
          const nextIndex = currentIndex + 1;
          const newCompletedItems = [...enterpriseVerificationMode.completedItems, currentItem.key];
          
          try {
            const { updateTodo, createEnterpriseCertification } = await import('./services/apiService');
            
            // æ ¹æ®å½“å‰é¡¹æ„å»ºè®¤è¯æ•°æ®
            const certData: any = {
              name: currentItem.label,
              organization: 'ç³»ç»Ÿè®¤è¯',
              category: 'qualification',
              cert_date: new Date().toISOString().split('T')[0],
              color: 'blue',
              icon: 'Building2'
            };
            
            // æ ¹æ®æå–çš„ä¿¡æ¯å¡«å……æ•°æ®
            if (reviewResult.extractedInfo) {
              if (currentItem.key === 'business_license') {
                // è¥ä¸šæ‰§ç…§ - ä¿å­˜è¯¦ç»†ä¿¡æ¯
                const companyName = reviewResult.extractedInfo['ä¼ä¸šåç§°'] || reviewResult.extractedInfo['å…¬å¸åç§°'] || 'è¥ä¸šæ‰§ç…§';
                const legalRepresentative = reviewResult.extractedInfo['æ³•å®šä»£è¡¨äºº'] || '';
                certData.name = `è¥ä¸šæ‰§ç…§ - ${companyName}`;
                certData.organization = legalRepresentative || 'ç³»ç»Ÿè®¤è¯';
                
                // ä¿å­˜è¥ä¸šæ‰§ç…§ä¸“ç”¨å­—æ®µ
                certData.credit_code = reviewResult.extractedInfo['ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç '] || '';
                certData.valid_period = reviewResult.extractedInfo['æœ‰æ•ˆæœŸ'] || reviewResult.extractedInfo['ç»è¥æœŸé™'] || '';
                certData.business_address = reviewResult.extractedInfo['ä½æ‰€'] || reviewResult.extractedInfo['åœ°å€'] || '';
                certData.registered_capital = reviewResult.extractedInfo['æ³¨å†Œèµ„æœ¬'] || '';
                certData.business_scope = reviewResult.extractedInfo['ç»è¥èŒƒå›´'] || '';
                
                // ä¿å­˜åŸå§‹å›¾ç‰‡ç”¨äºåå°æŸ¥çœ‹
                certData.image_data = imageBase64;
                
                // ä¿å­˜ä¼ä¸šåç§°å’Œæ³•å®šä»£è¡¨äººåˆ°çŠ¶æ€ï¼ˆæ³•å®šä»£è¡¨äººç”¨äºåç»­æ ¡éªŒèº«ä»½è¯ï¼‰
                setEnterpriseVerificationMode(prev => ({
                  ...prev,
                  companyName: companyName,
                  legalRepresentative: legalRepresentative
                }));
              } else if (currentItem.key === 'legal_person_id_front') {
                // æ³•äººèº«ä»½è¯æ­£é¢ - æ ¡éªŒå§“åä¸è¥ä¸šæ‰§ç…§æ³•å®šä»£è¡¨äººæ˜¯å¦ä¸€è‡´
                const idName = reviewResult.extractedInfo['å§“å'] || '';
                const idNumber = reviewResult.extractedInfo['èº«ä»½è¯å·'] || '';
                const legalRepresentative = enterpriseVerificationMode.legalRepresentative || '';
                
                // æ ¡éªŒå§“åä¸€è‡´æ€§
                if (legalRepresentative && idName && legalRepresentative !== idName) {
                  // å§“åä¸ä¸€è‡´ï¼Œæ‹’ç»å®¡æ ¸
                  addCertImageMessage(`âŒ **æ³•äººèº«ä»½è¯å®¡æ ¸æœªé€šè¿‡ï¼**\n\n**åŸå› ï¼šèº«ä»½è¯å§“åä¸è¥ä¸šæ‰§ç…§æ³•å®šä»£è¡¨äººä¸ä¸€è‡´**\n\nâ€¢ è¥ä¸šæ‰§ç…§æ³•å®šä»£è¡¨äººï¼š**${legalRepresentative}**\nâ€¢ èº«ä»½è¯å§“åï¼š**${idName}**\n\nè¯·ä¸Šä¼ ä¸è¥ä¸šæ‰§ç…§æ³•å®šä»£è¡¨äººä¸€è‡´çš„èº«ä»½è¯ç…§ç‰‡ã€‚\n\nğŸ“· ç‚¹å‡»ä¸‹æ–¹ **ã€Œä¸Šä¼ è¯ä»¶ã€** æŒ‰é’®é‡æ–°ä¸Šä¼ ã€‚`);
                  setIsTyping(false);
                  setUploadingCertImage(false);
                  if (certImageInputRef.current) certImageInputRef.current.value = '';
                  return;
                }
                
                // å°†æ­£é¢ä¿¡æ¯æš‚å­˜åˆ°çŠ¶æ€
                setEnterpriseVerificationMode(prev => ({
                  ...prev,
                  legalPersonIdFront: {
                    name: idName,
                    idNumber: idNumber,
                    imageData: imageBase64
                  }
                }));
                
                // æ­£é¢ä¸åˆ›å»ºæ•°æ®åº“è®°å½•ï¼Œæ ‡è®°ä¸ºè·³è¿‡ä¿å­˜
                certData._skipSave = true;
              } else if (currentItem.key === 'legal_person_id_back') {
                // æ³•äººèº«ä»½è¯èƒŒé¢ - åˆå¹¶æ­£é¢ä¿¡æ¯åˆ›å»ºå®Œæ•´è®°å½•
                const frontInfo = enterpriseVerificationMode.legalPersonIdFront;
                const authority = reviewResult.extractedInfo['ç­¾å‘æœºå…³'] || 'å…¬å®‰æœºå…³';
                const validPeriod = reviewResult.extractedInfo['æœ‰æ•ˆæœŸ'] || reviewResult.extractedInfo['æœ‰æ•ˆæœŸé™'] || '';
                
                certData.name = `æ³•äººèº«ä»½è¯ - ${frontInfo?.name || 'å·²è®¤è¯'}`;
                certData.organization = 'èº«ä»½è¯è®¤è¯';
                certData.id_card_name = frontInfo?.name || '';
                certData.id_card_number = frontInfo?.idNumber || '';
                certData.id_card_authority = authority;
                certData.id_card_valid_period = validPeriod;
                certData.image_data_front = frontInfo?.imageData || '';
                certData.image_data_back = imageBase64;
              } else {
                // å…¶ä»–è¯ä»¶
                certData.name = currentItem.label;
                Object.keys(reviewResult.extractedInfo).forEach(key => {
                  if (key.includes('åç§°') || key.includes('å…¬å¸')) {
                    certData.name = `${currentItem.label} - ${reviewResult.extractedInfo[key]}`;
                  }
                });
              }
            }
            
            // å°è¯•ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆå¦‚æœAPIå­˜åœ¨çš„è¯ï¼Œä¸”ä¸æ˜¯è·³è¿‡ä¿å­˜çš„æƒ…å†µï¼‰
            if (!certData._skipSave) {
              try {
                await createEnterpriseCertification(certData, userId);
                console.log('[Enterprise Cert] å·²ä¿å­˜ä¼ä¸šè®¤è¯åˆ°æ•°æ®åº“');
              } catch (saveErr) {
                console.warn('[Enterprise Cert] ä¿å­˜è®¤è¯å¤±è´¥ï¼ˆAPIå¯èƒ½æœªå®ç°ï¼‰:', saveErr);
              }
            } else {
              console.log('[Enterprise Cert] è·³è¿‡ä¿å­˜ï¼ˆç­‰å¾…åç»­æ­¥éª¤åˆå¹¶ï¼‰');
            }
            
            // æ„å»ºæˆåŠŸæ¶ˆæ¯
            let successMessage = `âœ… **${currentItem.label}å®¡æ ¸é€šè¿‡ï¼**\n\n`;
            if (reviewResult.extractedInfo) {
              successMessage += `ğŸ“‹ **è¯†åˆ«åˆ°çš„ä¿¡æ¯ï¼š**\n`;
              Object.entries(reviewResult.extractedInfo).forEach(([key, value]) => {
                successMessage += `â€¢ ${key}ï¼š${value}\n`;
              });
              successMessage += `\n`;
            }
            
            // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰è®¤è¯
            if (nextIndex >= enterpriseVerificationItems.length) {
              // è®¤è¯å…¨éƒ¨å®Œæˆ
              successMessage += `---\n\nğŸ‰ **æ­å–œï¼ä¼ä¸šè®¤è¯å·²å…¨éƒ¨å®Œæˆï¼**\n\n`;
              successMessage += `âœ… å·²å®Œæˆï¼š${newCompletedItems.length}/${enterpriseVerificationItems.length} é¡¹\n\n`;
              successMessage += `æ‚¨çš„ä¼ä¸šå·²é€šè¿‡è®¤è¯ï¼Œè¿™å°†å¤§å¹…æå‡æ‹›è˜æ•ˆæœï¼\n\n`;
              successMessage += `æ¥ä¸‹æ¥ï¼Œè¯·å®Œå–„ä¼ä¸šèµ„æ–™ä»¥è·å¾—æ›´å¥½çš„æ‹›è˜æ•ˆæœï¼š\n\n`;
              successMessage += `[[TASK:å®Œå–„ä¼ä¸šèµ„æ–™:enterprise_profile:ğŸ“‹]]`;
              
              addCertImageMessage(successMessage);
              
              setEnterpriseVerificationMode(prev => ({
                ...prev,
                currentIndex: nextIndex,
                completedItems: newCompletedItems
              }));
              
              // æ›´æ–°ä»»åŠ¡ä¸ºå®ŒæˆçŠ¶æ€
              if (selectedTask) {
                await updateTodo(selectedTask.id, { 
                  progress: 100, 
                  status: 'completed' 
                });
                if (typeof refetchTasks === 'function') {
                  refetchTasks();
                }
              }
              
              // åˆ›å»º"å®Œå–„ä¼ä¸šèµ„æ–™"å¼•å¯¼ä»»åŠ¡
              try {
                const { createTodo, updateSettings, getEnterpriseCertifications } = await import('./services/apiService');
                
                // åˆ›å»ºå®Œå–„ä¼ä¸šèµ„æ–™ä»»åŠ¡
                const profileTaskData = {
                  title: 'å®Œå–„ä¼ä¸šèµ„æ–™',
                  description: 'å®Œå–„ä¼ä¸šåŸºæœ¬ä¿¡æ¯ã€è”ç³»æ–¹å¼ã€ä¼ä¸šä»‹ç»ç­‰ï¼Œæå‡æ‹›è˜æ•ˆæœ',
                  priority: 'MEDIUM',
                  source: 'AGENT',
                  todo_type: 'EMPLOYER',
                  icon: 'FileText',
                  user_id: userId,
                  progress: 0,
                  status: 'pending'
                };
                
                await createTodo(profileTaskData);
                console.log('[Enterprise] å·²åˆ›å»º"å®Œå–„ä¼ä¸šèµ„æ–™"å¼•å¯¼ä»»åŠ¡');
                
                // è·å–ä¼ä¸šè®¤è¯ä¿¡æ¯ï¼Œç”¨äºè‡ªåŠ¨å¡«å……åŸºç¡€ä¿¡æ¯
                const certifications = await getEnterpriseCertifications(userId);
                const businessLicenseCert = certifications.find((c: any) => c.category === 'qualification' && c.name?.includes('è¥ä¸šæ‰§ç…§'));
                
                if (businessLicenseCert) {
                  // å°†è®¤è¯è¯†åˆ«çš„ä¿¡æ¯è‡ªåŠ¨å¡«å…¥åŸºç¡€ä¿¡æ¯è®¾ç½®
                  const settingsToUpdate: any = {};
                  
                  // ä¼ä¸šåç§°ï¼ˆä»è¥ä¸šæ‰§ç…§åç§°ä¸­æå–ï¼‰
                  const certName = businessLicenseCert.name || '';
                  const companyNameMatch = certName.match(/è¥ä¸šæ‰§ç…§\s*-\s*(.+)/);
                  if (companyNameMatch && companyNameMatch[1]) {
                    settingsToUpdate.display_name = companyNameMatch[1];
                  }
                  
                  // å…¬å¸åœ°å€
                  if (businessLicenseCert.business_address) {
                    settingsToUpdate.detail_address = businessLicenseCert.business_address;
                  }
                  
                  // æ³•å®šä»£è¡¨äººå§“åä½œä¸ºè”ç³»äºº
                  if (businessLicenseCert.organization && businessLicenseCert.organization !== 'ç³»ç»Ÿè®¤è¯') {
                    settingsToUpdate.contact_name = businessLicenseCert.organization;
                  }
                  
                  // å¦‚æœæœ‰éœ€è¦æ›´æ–°çš„è®¾ç½®ï¼Œè°ƒç”¨APIæ›´æ–°
                  if (Object.keys(settingsToUpdate).length > 0) {
                    await updateSettings(settingsToUpdate, userId);
                    console.log('[Enterprise] å·²å°†è®¤è¯ä¿¡æ¯è‡ªåŠ¨å¡«å…¥åŸºç¡€è®¾ç½®:', settingsToUpdate);
                  }
                }
                
                // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                if (typeof refetchTasks === 'function') {
                  refetchTasks();
                }
              } catch (taskError) {
                console.error('[Enterprise] åˆ›å»ºå®Œå–„ä¼ä¸šèµ„æ–™ä»»åŠ¡å¤±è´¥:', taskError);
              }
            } else {
              // ç»§ç»­ä¸‹ä¸€é¡¹
              const nextItem = enterpriseVerificationItems[nextIndex];
              successMessage += `---\n\nğŸ“‹ **è®¤è¯è¿›åº¦ï¼š** ${newCompletedItems.length}/${enterpriseVerificationItems.length} é¡¹\n\n`;
              successMessage += `${nextItem.icon} **ç¬¬ ${nextIndex + 1} é¡¹ï¼š${nextItem.label}**\n\n`;
              successMessage += nextItem.description;
              
              addCertImageMessage(successMessage);
              
              setEnterpriseVerificationMode(prev => ({
                ...prev,
                currentIndex: nextIndex,
                completedItems: newCompletedItems
              }));
              
              // æ›´æ–°ä»»åŠ¡è¿›åº¦
              if (selectedTask) {
                const progress = Math.round((newCompletedItems.length / enterpriseVerificationItems.length) * 100);
                await updateTodo(selectedTask.id, { 
                  progress, 
                  status: 'in_progress' 
                });
                if (typeof refetchTasks === 'function') {
                  refetchTasks();
                }
              }
            }
          } catch (error) {
            console.error('[Enterprise Cert] å¤„ç†å¤±è´¥:', error);
            addCertImageMessage(`âŒ å¤„ç†è®¤è¯ä¿¡æ¯æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚`);
          }
          
          setIsTyping(false);
          setUploadingCertImage(false);
          if (certImageInputRef.current) certImageInputRef.current.value = '';
          return;
        }
        
        // ========== ä¸ªäººè®¤è¯å¤„ç†åˆ†æ”¯ ==========
        const newCompletedItems = [...verificationMode.completedItems, currentItem.key];
        const nextIndex = currentIndex + 1;
        
        // ä¿å­˜è®¤è¯ä¿¡æ¯åˆ°æ•°æ®åº“
        try {
          const { createPersonalCertification, updateTodo, updateCandidateIdentity, updateCandidateEducation } = await import('./services/apiService');
          
          // å¤„ç†èº«ä»½è¯æ­£åé¢
          if (currentItem.key === 'identity_front' || currentItem.key === 'identity_back') {
            const isIdFront = currentItem.key === 'identity_front';
            let identityNameFromFront = '';
            
            // æ›´æ–°èº«ä»½è¯çŠ¶æ€
            if (isIdFront) {
              identityNameFromFront = reviewResult.extractedInfo?.['å§“å'] || '';
              setIdCardInfo(prev => ({
                ...prev,
                frontUploaded: true,
                frontInfo: reviewResult.extractedInfo || null,
                frontImage: imageBase64
              }));
              
              // ä¿å­˜æ­£é¢ä¿¡æ¯åˆ°ç”¨æˆ·èµ„æ–™
              if (reviewResult.extractedInfo && userId) {
                try {
                  await updateCandidateIdentity(userId, {
                    real_name: reviewResult.extractedInfo['å§“å'],
                    gender: reviewResult.extractedInfo['æ€§åˆ«'],
                    birthday: reviewResult.extractedInfo['å‡ºç”Ÿæ—¥æœŸ'],
                    id_number: reviewResult.extractedInfo['èº«ä»½è¯å·'],
                    address: reviewResult.extractedInfo['ä½å€'],
                    ethnicity: reviewResult.extractedInfo['æ°‘æ—']
                  });
                  console.log('[ID Card Front] å·²ä¿å­˜èº«ä»½è¯æ­£é¢ä¿¡æ¯åˆ°ç”¨æˆ·èµ„æ–™');
                } catch (profileError) {
                  console.error('ä¿å­˜èº«ä»½è¯æ­£é¢ä¿¡æ¯å¤±è´¥:', profileError);
                }
              }
            } else {
              setIdCardInfo(prev => ({
                ...prev,
                backUploaded: true,
                backInfo: reviewResult.extractedInfo || null,
                backImage: imageBase64
              }));
              
              // ä¿å­˜åé¢ä¿¡æ¯åˆ°ç”¨æˆ·èµ„æ–™
              if (reviewResult.extractedInfo && userId) {
                try {
                  await updateCandidateIdentity(userId, {
                    id_issuing_authority: reviewResult.extractedInfo['ç­¾å‘æœºå…³'],
                    id_valid_period: reviewResult.extractedInfo['æœ‰æ•ˆæœŸé™']
                  });
                  console.log('[ID Card Back] å·²ä¿å­˜èº«ä»½è¯åé¢ä¿¡æ¯åˆ°ç”¨æˆ·èµ„æ–™');
                } catch (profileError) {
                  console.error('ä¿å­˜èº«ä»½è¯åé¢ä¿¡æ¯å¤±è´¥:', profileError);
                }
              }
            }
            
            // å½“èº«ä»½è¯ä¸¤é¢éƒ½ä¸Šä¼ å®Œæˆåï¼Œåˆ›å»ºè®¤è¯è®°å½•
            const updatedIdCardInfo = isIdFront 
              ? { ...idCardInfo, frontUploaded: true, frontInfo: reviewResult.extractedInfo || null, frontImage: imageBase64 }
              : { ...idCardInfo, backUploaded: true, backInfo: reviewResult.extractedInfo || null, backImage: imageBase64 };
            
            if (updatedIdCardInfo.frontUploaded && updatedIdCardInfo.backUploaded) {
              // ä¸¤é¢éƒ½å·²ä¸Šä¼ ï¼Œåˆ›å»ºå®Œæ•´çš„èº«ä»½è®¤è¯è®°å½•
              // ç»„åˆæ€§åˆ«å’Œæ°‘æ—ä¿¡æ¯
              const gender = updatedIdCardInfo.frontInfo?.['æ€§åˆ«'] || '';
              const ethnicity = updatedIdCardInfo.frontInfo?.['æ°‘æ—'] || '';
              const genderEthnicity = [gender, ethnicity ? `${ethnicity}æ—` : ''].filter(Boolean).join(' Â· ');
              const finalIdentityName = updatedIdCardInfo.frontInfo?.['å§“å'] || '';
              
              // åˆå¹¶æ­£åé¢å›¾ç‰‡æ•°æ®ï¼ˆç”¨åˆ†éš”ç¬¦è¿æ¥ï¼‰
              const combinedImageData = [
                updatedIdCardInfo.frontImage || '',
                updatedIdCardInfo.backImage || ''
              ].filter(Boolean).join('|||');
              
              const certData = {
                name: `å®åè®¤è¯ - ${finalIdentityName || 'å·²è®¤è¯'}`,
                organization: updatedIdCardInfo.backInfo?.['ç­¾å‘æœºå…³'] || 'å…¬å®‰æœºå…³',
                cert_date: updatedIdCardInfo.backInfo?.['æœ‰æ•ˆæœŸé™'] || '', // å­˜å‚¨æœ‰æ•ˆæœŸ
                level: updatedIdCardInfo.frontInfo?.['èº«ä»½è¯å·'] || '', // å­˜å‚¨æ‰“ç åçš„èº«ä»½è¯å·
                degree: updatedIdCardInfo.frontInfo?.['ä½å€'] || '', // å­˜å‚¨æ‰“ç åçš„åœ°å€
                major: genderEthnicity, // å­˜å‚¨æ€§åˆ«å’Œæ°‘æ—
                category: 'identity',
                color: 'blue',
                icon: 'IdCard',
                image_data: combinedImageData  // ä¿å­˜å®¡æ ¸é€šè¿‡çš„æ­£åé¢å›¾ç‰‡
              };
              await createPersonalCertification(certData, userId);
              console.log('[Certification] å·²ä¿å­˜å®Œæ•´èº«ä»½è®¤è¯åˆ°æ•°æ®åº“');
              
              // èº«ä»½è¯è®¤è¯å®Œæˆï¼Œç»§ç»­ä¸‹ä¸€é¡¹è®¤è¯
              const nextItemIndex = 2;  // identity_back æ˜¯ index 1ï¼Œä¸‹ä¸€é¡¹æ˜¯ index 2
              const nextItem = verificationItems[nextItemIndex];
              
              let successMessage = `âœ… **èº«ä»½è®¤è¯å·²å®Œæˆï¼**\n\n`;
              successMessage += `ğŸ‘¤ è®¤è¯å§“åï¼š**${finalIdentityName}**\n\n`;
              successMessage += `ğŸ“‹ **è¯†åˆ«åˆ°çš„ä¿¡æ¯ï¼š**\n`;
              if (updatedIdCardInfo.frontInfo) {
                Object.entries(updatedIdCardInfo.frontInfo).forEach(([key, value]) => {
                  successMessage += `â€¢ ${key}ï¼š${value}\n`;
                });
              }
              successMessage += `\nå·²è‡ªåŠ¨ä¿å­˜è®¤è¯ä¿¡æ¯ã€‚\n\n`;
              successMessage += `---\n\n`;
              successMessage += `ğŸ“‹ **è®¤è¯è¿›åº¦ï¼š** 2/${verificationItems.length} é¡¹\n\n`;
              successMessage += `âš ï¸ åç»­è®¤è¯ä¿¡æ¯å¿…é¡»ä¸èº«ä»½è¯å§“åã€Œ${finalIdentityName}ã€ä¸€è‡´\n\n`;
              successMessage += `${nextItem.icon} **ç¬¬ ${nextItemIndex + 1} é¡¹ï¼š${nextItem.label}**\n\n`;
              successMessage += nextItem.description;
              
              addCertImageMessage(successMessage);
              
              // æ›´æ–°çŠ¶æ€ï¼šç»§ç»­ä¸‹ä¸€é¡¹
              setVerificationMode(prev => ({
                ...prev,
                currentIndex: nextItemIndex,
                completedItems: ['identity_front', 'identity_back'],
                identityName: finalIdentityName
              }));
              
              // æ›´æ–°ä»»åŠ¡è¿›åº¦
              if (selectedTask) {
                const progress = Math.round((2 / verificationItems.length) * 100);
                await updateTodo(selectedTask.id, { 
                  progress, 
                  status: 'in_progress' 
                });
                if (typeof refetchTasks === 'function') {
                  refetchTasks();
                }
              }
              
              // èº«ä»½è®¤è¯å®Œæˆåï¼Œåˆ›å»ºDISCæµ‹è¯•ä»»åŠ¡
              try {
                const existingTasks = await getTasks(userId);
                const hasDiscTask = existingTasks.some((t: any) => 
                  t.title === 'DISCæ€§æ ¼æµ‹è¯•'
                );
                
                if (!hasDiscTask) {
                  await createTodo({
                    title: 'DISCæ€§æ ¼æµ‹è¯•',
                    description: 'é€šè¿‡DISCæµ‹è¯•äº†è§£æ‚¨çš„è¡Œä¸ºé£æ ¼ï¼Œæå‡æ±‚èŒåŒ¹é…åº¦',
                    priority: 'MEDIUM',
                    status: 'PENDING',
                    progress: 0,
                    source: 'AGENT',
                    todo_type: 'CANDIDATE',
                    icon: 'UserIcon',
                  }, userId);
                  console.log('[DISC Task] å·²åˆ›å»ºDISCæ€§æ ¼æµ‹è¯•ä»»åŠ¡, userId:', userId);
                  if (typeof refetchTasks === 'function') {
                    refetchTasks();
                  }
                }
              } catch (discTaskError) {
                console.error('åˆ›å»ºDISCæµ‹è¯•ä»»åŠ¡å¤±è´¥:', discTaskError);
              }
              
              return;  // èº«ä»½è¯è®¤è¯å®Œæˆï¼Œç›´æ¥è¿”å›
            }
          } else {
            // å…¶ä»–è®¤è¯ç±»å‹çš„å¤„ç†
            // æ ¹æ® key ç¡®å®šæ­£ç¡®çš„ category
            const categoryMap: Record<string, string> = {
              'education': 'education',
              'skill_driver': 'skill',
              'skill_cert': 'skill',
              'work': 'work',
              'credit_fund': 'credit',
              'credit_social': 'credit'
            };
            
            const certData: any = {
              name: currentItem.label,
              organization: 'ç³»ç»Ÿè®¤è¯',
              cert_date: new Date().toISOString().split('T')[0],
              category: categoryMap[currentItem.key] || currentItem.key,
            };
            
            // æ ¹æ®æå–çš„ä¿¡æ¯å¡«å……è®¤è¯æ•°æ®
            if (reviewResult.extractedInfo) {
              if (currentItem.key === 'education') {
                certData.name = reviewResult.extractedInfo['å§“å'] || 'å­¦å†è®¤è¯';
                certData.organization = reviewResult.extractedInfo['å­¦æ ¡'] || 'æœªçŸ¥å­¦æ ¡';
                certData.degree = reviewResult.extractedInfo['å­¦å†'];
                certData.major = reviewResult.extractedInfo['ä¸“ä¸š'];
                certData.cert_number = reviewResult.extractedInfo['è¯ä¹¦ç¼–å·'];
                
                // ä½¿ç”¨ OCR æå–çš„æ¯•ä¸šæ—¶é—´ï¼Œè€Œä¸æ˜¯å½“å‰æ—¥æœŸ
                if (reviewResult.extractedInfo['æ¯•ä¸šæ—¶é—´']) {
                  certData.cert_date = reviewResult.extractedInfo['æ¯•ä¸šæ—¶é—´'];
                }
                
                // ä¿å­˜å­¦å†ä¿¡æ¯åˆ°ç”¨æˆ·èµ„æ–™
                if (userId) {
                  try {
                    await updateCandidateEducation(userId, {
                      education: reviewResult.extractedInfo['å­¦å†'],
                      school: reviewResult.extractedInfo['å­¦æ ¡'],
                      major: reviewResult.extractedInfo['ä¸“ä¸š'],
                      graduation_year: reviewResult.extractedInfo['æ¯•ä¸šæ—¶é—´'],
                      degree: reviewResult.extractedInfo['å­¦ä½'],
                      cert_number: reviewResult.extractedInfo['è¯ä¹¦ç¼–å·']
                    });
                    console.log('[Education] å·²ä¿å­˜å­¦å†ä¿¡æ¯åˆ°ç”¨æˆ·èµ„æ–™');
                  } catch (profileError) {
                    console.error('ä¿å­˜å­¦å†ä¿¡æ¯å¤±è´¥:', profileError);
                  }
                }
              } else if (currentItem.key === 'skill_driver') {
                // é©¾é©¶è¯è®¤è¯
                certData.name = 'é©¾é©¶è¯';
                certData.organization = reviewResult.extractedInfo['å§“å'] || 'é©¾é©¶äºº';  // é©¾é©¶äººå§“å
                certData.level = reviewResult.extractedInfo['å‡†é©¾è½¦å‹'] || '';
                certData.cert_number = reviewResult.extractedInfo['è¯å·'] || '';
                certData.cert_date = reviewResult.extractedInfo['æœ‰æ•ˆæœŸè‡³'] || '';
                certData.major = reviewResult.extractedInfo['åˆæ¬¡é¢†è¯'] || '';  // å‘è¯æ—¥æœŸ
              } else if (currentItem.key === 'skill_cert') {
                // èŒä¸šèµ„æ ¼è¯ä¹¦è®¤è¯
                certData.name = reviewResult.extractedInfo['è¯ä¹¦ç±»å‹'] || reviewResult.extractedInfo['è¯ä¹¦åç§°'] || 'èŒä¸šèµ„æ ¼è¯ä¹¦';
                certData.organization = reviewResult.extractedInfo['å‘è¯æœºæ„'] || '';
                certData.level = reviewResult.extractedInfo['ç­‰çº§'] || '';
                certData.cert_number = reviewResult.extractedInfo['è¯ä¹¦ç¼–å·'] || '';
                certData.major = reviewResult.extractedInfo['å§“å'] || '';  // ä¿å­˜æŒè¯äººå§“å
              } else if (currentItem.key === 'work') {
                // å·¥ä½œè¯æ˜è®¤è¯ - åç§°ä½¿ç”¨å…¬å¸åæˆ–è®¤è¯æ–¹å¼ï¼Œä¸ä½¿ç”¨äººå
                const companyName = reviewResult.extractedInfo['å…¬å¸åç§°'] || '';
                const proofType = reviewResult.extractedInfo['è®¤è¯æ–¹å¼'] || 'å·¥ä½œè¯æ˜';
                certData.name = companyName || proofType;  // ä½¿ç”¨å…¬å¸åä½œä¸ºæ ‡é¢˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨è®¤è¯æ–¹å¼
                certData.organization = reviewResult.extractedInfo['å§“å'] || '';  // å­˜å‚¨å§“ååˆ° organization
                certData.degree = reviewResult.extractedInfo['èŒä½'] || '';  // å­˜å‚¨èŒä½
                certData.major = proofType;  // å­˜å‚¨è®¤è¯æ–¹å¼
                certData.cert_date = reviewResult.extractedInfo['åœ¨èŒæ—¶é—´'] || '';
              } else if (currentItem.key === 'credit_fund') {
                // å…¬ç§¯é‡‘è¯æ˜
                certData.name = 'å…¬ç§¯é‡‘è¯æ˜';
                certData.organization = reviewResult.extractedInfo['å§“å'] || '';
                certData.level = reviewResult.extractedInfo['ç¼´å­˜åŸºæ•°'] || '';
                certData.major = reviewResult.extractedInfo['ç¼´å­˜çŠ¶æ€'] || 'æ­£å¸¸ç¼´å­˜';
                certData.cert_date = reviewResult.extractedInfo['ç¼´å­˜æ—¶é—´'] || '';
              } else if (currentItem.key === 'credit_social') {
                // ç¤¾ä¿è¯æ˜
                certData.name = 'ç¤¾ä¿è¯æ˜';
                certData.organization = reviewResult.extractedInfo['å§“å'] || '';
                certData.level = reviewResult.extractedInfo['å‚ä¿ç±»å‹'] || '';
                certData.major = reviewResult.extractedInfo['ç¼´çº³çŠ¶æ€'] || 'æ­£å¸¸ç¼´çº³';
                certData.cert_date = reviewResult.extractedInfo['ç¼´çº³æ—¶é—´'] || '';
              }
            }
            
            // è®¾ç½®é¢œè‰²å’Œå›¾æ ‡
            const certStyles: Record<string, {color: string; icon: string}> = {
              'identity_front': { color: 'blue', icon: 'IdCard' },
              'identity_back': { color: 'blue', icon: 'IdCard' },
              'education': { color: 'green', icon: 'GraduationCap' },
              'skill_driver': { color: 'purple', icon: 'Car' },
              'skill_cert': { color: 'purple', icon: 'Award' },
              'work': { color: 'amber', icon: 'Briefcase' },
              'credit_fund': { color: 'orange', icon: 'Building' },
              'credit_social': { color: 'orange', icon: 'ShieldCheck' }
            };
            certData.color = certStyles[currentItem.key]?.color || 'gray';
            certData.icon = certStyles[currentItem.key]?.icon || 'Award';
            certData.image_data = imageBase64;  // ä¿å­˜å®¡æ ¸é€šè¿‡çš„è¯ä»¶åŸå§‹å›¾ç‰‡
            
            await createPersonalCertification(certData, userId);
            console.log(`[Certification] å·²ä¿å­˜${currentItem.label}åˆ°æ•°æ®åº“ï¼ˆå«åŸå§‹å›¾ç‰‡ï¼‰`);
          }
          
          // æ›´æ–°ä»»åŠ¡è¿›åº¦
          if (selectedTask) {
            const progress = Math.round((newCompletedItems.length / totalItems) * 100);
            const taskStatus = progress >= 100 ? 'completed' : 'in_progress';
            await updateTodo(selectedTask.id, { 
              progress, 
              status: taskStatus 
            });
            console.log(`[Task Progress] ä»»åŠ¡è¿›åº¦æ›´æ–°ä¸º ${progress}%`);
            
            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
            if (typeof refetchTasks === 'function') {
              refetchTasks();
            }
          }
        } catch (saveError) {
          console.error('ä¿å­˜è®¤è¯ä¿¡æ¯å¤±è´¥:', saveError);
        }
        
        let successMessage = `âœ… **${currentItem.label}å®¡æ ¸é€šè¿‡ï¼**\n\n`;
        successMessage += `ğŸ“‹ **è¯†åˆ«åˆ°çš„ä¿¡æ¯ï¼š**\n`;
        if (reviewResult.extractedInfo) {
          Object.entries(reviewResult.extractedInfo).forEach(([key, value]) => {
            successMessage += `â€¢ ${key}ï¼š${value}\n`;
          });
        }
        successMessage += `\nå·²è‡ªåŠ¨ä¿å­˜è®¤è¯ä¿¡æ¯ã€‚`;
        
        // èº«ä»½è¯æ­£é¢å®Œæˆï¼Œç»§ç»­åé¢
        if (currentItem.key === 'identity_front') {
          const nextItem = verificationMode.items[1];  // identity_back
          successMessage += `\n\n---\n\n${nextItem.icon} **ç»§ç»­ä¸Šä¼ ï¼š${nextItem.label}**\n\n${nextItem.description}`;
          
          addCertImageMessage(successMessage);
          setVerificationMode(prev => ({
            ...prev,
            currentIndex: 1,
            completedItems: newCompletedItems
          }));
        } else if (nextIndex >= totalItems) {
          // æ‰€æœ‰è®¤è¯é¡¹éƒ½å·²å®Œæˆ
          successMessage += `\n\n---\n\nğŸ‰ **æ­å–œï¼æ‚¨å·²å®Œæˆå…¨éƒ¨è®¤è¯ï¼**\n\n`;
          successMessage += `âœ… å·²å®Œæˆï¼š${newCompletedItems.length}/${totalItems} é¡¹\n\n`;
          successMessage += `æ‚¨çš„è®¤è¯ä¿¡æ¯å·²ä¿å­˜ï¼Œè¿™å°†å¤§å¹…æå‡æ‚¨çš„æ±‚èŒç«äº‰åŠ›ï¼\n\n`;
          successMessage += `ğŸ‘‰ å‰å¾€ [è®¾ç½® - ä¸ªäººè®¤è¯ä¿¡æ¯](/settings?tab=PersonalVerification) æŸ¥çœ‹è¯¦æƒ…\n\n`;
          successMessage += `è¿˜æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`;
          
          addCertImageMessage(successMessage);
          setVerificationMode({ active: false, items: [], currentIndex: -1, completedItems: [] });
          
          // æ›´æ–°ä»»åŠ¡ä¸ºå®Œæˆ
          if (selectedTask) {
            const { updateTodo } = await import('./services/apiService');
            await updateTodo(selectedTask.id, { 
              progress: 100, 
              status: 'completed' 
            });
            if (typeof refetchTasks === 'function') {
              refetchTasks();
            }
          }
        } else {
          // ç»§ç»­ä¸‹ä¸€é¡¹
          const nextItem = verificationMode.items[nextIndex];
          successMessage += `\n\n---\n\n`;
          successMessage += `ğŸ“‹ **è®¤è¯è¿›åº¦ï¼š** ${newCompletedItems.length}/${totalItems} é¡¹\n\n`;
          successMessage += `${nextItem.icon} **ç¬¬ ${nextIndex + 1} é¡¹ï¼š${nextItem.label}**\n\n`;
          successMessage += nextItem.description;
          
          addCertImageMessage(successMessage);
          setVerificationMode(prev => ({
            ...prev,
            currentIndex: nextIndex,
            completedItems: newCompletedItems
          }));
          
          // æ›´æ–°ä»»åŠ¡è¿›åº¦
          if (selectedTask) {
            const { updateTodo } = await import('./services/apiService');
            const progress = Math.round((newCompletedItems.length / totalItems) * 100);
            await updateTodo(selectedTask.id, { 
              progress, 
              status: 'in_progress' 
            });
            if (typeof refetchTasks === 'function') {
              refetchTasks();
            }
          }
        }
      } else {
        // å®¡æ ¸ä¸é€šè¿‡
        const isIdentityItem = currentItem.key === 'identity_front' || currentItem.key === 'identity_back';
        
        let failMessage = `âŒ **${currentItem.label}å®¡æ ¸æœªé€šè¿‡**\n\n`;
        failMessage += `**åŸå› ï¼š** ${reviewResult.reason}\n\n`;
        failMessage += `ğŸ“· è¯·é‡æ–°ä¸Šä¼ ç¬¦åˆè¦æ±‚çš„è¯ä»¶å›¾ç‰‡ï¼š\n`;
        failMessage += `â€¢ ç¡®ä¿å›¾ç‰‡æ¸…æ™°ï¼Œæ–‡å­—å¯è¾¨è®¤\n`;
        failMessage += `â€¢ ç¡®ä¿è¯ä»¶åœ¨å›¾ç‰‡ä¸­å®Œæ•´æ˜¾ç¤º\n`;
        failMessage += `â€¢ é¿å…åå…‰ã€é®æŒ¡æˆ–æ¨¡ç³Š\n\n`;
        
        // æ ¹æ®è®¤è¯é¡¹ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
        if (isIdentityItem) {
          failMessage += `ğŸ“· è¯·é‡æ–°ä¸Šä¼ èº«ä»½è¯ç…§ç‰‡ï¼ˆèº«ä»½è®¤è¯æ˜¯å¿…å¡«é¡¹ï¼‰`;
        } else {
          failMessage += `ğŸ’¡ è¾“å…¥ **"è·³è¿‡"** å¯ä»¥è·³è¿‡å½“å‰è®¤è¯é¡¹`;
        }
        
        addCertImageMessage(failMessage);
      }
      
    } catch (error: any) {
      console.error('è¯ä»¶å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
      const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
      const isNetworkError = errorMsg.includes('æ— æ³•è¿æ¥') || errorMsg.includes('fetch') || errorMsg.includes('network');
      
      if (isNetworkError) {
        addCertImageMessage(`âŒ **ç½‘ç»œè¿æ¥å¤±è´¥**\n\næ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š\nâ€¢ åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ\nâ€¢ ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n\nè¯·ç¨åé‡è¯•æˆ–è¾“å…¥ **"è·³è¿‡"** è·³è¿‡å½“å‰è®¤è¯é¡¹ã€‚`);
      } else {
        addCertImageMessage(`âŒ **å›¾ç‰‡å¤„ç†å¤±è´¥**\n\né”™è¯¯ä¿¡æ¯ï¼š${errorMsg}\n\nè¯·é‡æ–°ä¸Šä¼ æˆ–è¾“å…¥ **"è·³è¿‡"** è·³è¿‡å½“å‰è®¤è¯é¡¹ã€‚`);
      }
    } finally {
      setUploadingCertImage(false);
      setIsTyping(false);
      if (certImageInputRef.current) certImageInputRef.current.value = '';
    }
  };
  
  // æ·»åŠ è¯ä»¶å›¾ç‰‡ç›¸å…³æ¶ˆæ¯çš„è¾…åŠ©å‡½æ•°
  const addCertImageMessage = (content: string) => {
    if (selectedTask) {
      setTaskMessages(prev => ({
        ...prev,
        [selectedTask.id]: [...(prev[selectedTask.id] || []), { role: 'assistant' as const, content }]
      }));
    } else {
      setGeneralMessages(prev => [...prev, { role: 'assistant' as const, content }]);
    }
  };
  
  // æ¨¡æ‹Ÿ AI å®¡æ ¸è¯ä»¶å›¾ç‰‡ (å®é™…åº”ç”¨ä¸­åº”è°ƒç”¨åç«¯ API)
  // å»ºç«‹ä¸¥æ ¼çš„å®¡æ ¸è§„åˆ™
  const simulateAIReview = async (certType: string, fileName: string, fileSize: number): Promise<{
    success: boolean;
    reason?: string;
    extractedInfo?: Record<string, string>;
    detectedSide?: 'front' | 'back'; // è‡ªåŠ¨æ£€æµ‹çš„èº«ä»½è¯é¢
  }> => {
    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    const fileNameLower = fileName.toLowerCase();
    const fileSizeKB = fileSize / 1024;
    
    // ========== é€šç”¨å®¡æ ¸è§„åˆ™ ==========
    // è§„åˆ™1: å›¾ç‰‡å¤§å°æ£€æŸ¥ - è¿‡å°çš„å›¾ç‰‡æ— æ³•è¯†åˆ«
    if (fileSizeKB < 50) {
      return {
        success: false,
        reason: 'å›¾ç‰‡æ–‡ä»¶è¿‡å°ï¼ˆå°äº50KBï¼‰ï¼Œåˆ†è¾¨ç‡å¯èƒ½ä¸è¶³ï¼Œæ— æ³•æ¸…æ™°è¯†åˆ«è¯ä»¶ä¿¡æ¯ã€‚è¯·ä¸Šä¼ æ¸…æ™°çš„åŸå§‹è¯ä»¶ç…§ç‰‡ã€‚'
      };
    }
    
    // è§„åˆ™2: æ£€æµ‹å¸¸è§çš„éè¯ä»¶å›¾ç‰‡ç‰¹å¾
    const nonCertKeywords = ['screenshot', 'æˆªå›¾', 'logo', 'icon', 'å¤´åƒ', 'avatar', 'wallpaper', 'å£çº¸', 'background', 'meme', 'è¡¨æƒ…', 'emoji', 'gif'];
    if (nonCertKeywords.some(keyword => fileNameLower.includes(keyword))) {
      return {
        success: false,
        reason: 'æ£€æµ‹åˆ°ä¸Šä¼ çš„å¯èƒ½ä¸æ˜¯è¯ä»¶å›¾ç‰‡ã€‚è¯·ä¸Šä¼ æ­£è§„è¯ä»¶çš„æ‹ç…§æˆ–æ‰«æä»¶ã€‚'
      };
    }
    
    // ========== é’ˆå¯¹ä¸åŒè¯ä»¶ç±»å‹çš„ä¸“é—¨å®¡æ ¸è§„åˆ™ ==========
    switch (certType) {
      case 'identity_front':
      case 'identity_back': {
        // èº«ä»½è¯å®¡æ ¸è§„åˆ™
        const idCardKeywords = ['èº«ä»½è¯', 'id', 'identity', 'sfz', 'æ­£é¢', 'åé¢', 'front', 'back', 'å›½å¾½'];
        const hasIdCardHint = idCardKeywords.some(k => fileNameLower.includes(k));
        
        // èº«ä»½è¯å›¾ç‰‡é€šå¸¸åœ¨ 100KB - 3MB ä¹‹é—´
        if (fileSizeKB > 5000) {
          return {
            success: false,
            reason: 'å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·å‹ç¼©åé‡æ–°ä¸Šä¼ ï¼ˆå»ºè®®ä¸è¶…è¿‡10MBï¼‰ã€‚'
          };
        }
        
        // æ¨¡æ‹Ÿ AI è¯†åˆ«æˆåŠŸç‡ï¼ˆæœ‰å…³é”®è¯æç¤ºæ—¶æé«˜æˆåŠŸç‡ï¼‰
        const idPassRate = hasIdCardHint ? 0.95 : 0.7;
        if (Math.random() > idPassRate) {
          return {
            success: false,
            reason: certType === 'identity_front' 
              ? 'æœªèƒ½è¯†åˆ«åˆ°èº«ä»½è¯æ­£é¢ï¼ˆäººåƒé¢ï¼‰ä¿¡æ¯ã€‚è¯·ç¡®ä¿ï¼š\nâ€¢ ä¸Šä¼ çš„æ˜¯èº«ä»½è¯æ­£é¢ç…§ç‰‡\nâ€¢ è¯ä»¶å››è§’å®Œæ•´å¯è§\nâ€¢ ç…§ç‰‡æ¸…æ™°æ— åå…‰'
              : 'æœªèƒ½è¯†åˆ«åˆ°èº«ä»½è¯åé¢ï¼ˆå›½å¾½é¢ï¼‰ä¿¡æ¯ã€‚è¯·ç¡®ä¿ï¼š\nâ€¢ ä¸Šä¼ çš„æ˜¯èº«ä»½è¯åé¢ç…§ç‰‡\nâ€¢ å›½å¾½å’Œç­¾å‘æœºå…³ä¿¡æ¯æ¸…æ™°å¯è§'
          };
        }
        
        if (certType === 'identity_front') {
          return {
            success: true,
            detectedSide: 'front',
            extractedInfo: {
              'è¯ä»¶é¢': 'æ­£é¢ï¼ˆäººåƒé¢ï¼‰',
              'å§“å': 'å¼ ä¸‰',
              'æ€§åˆ«': 'ç”·',
              'æ°‘æ—': 'æ±‰',
              'å‡ºç”Ÿæ—¥æœŸ': '1995å¹´06æœˆ15æ—¥',
              'ä½å€': 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº****è·¯**å·',
              'èº«ä»½è¯å·': '310115199506******'
            }
          };
        } else {
          return {
            success: true,
            detectedSide: 'back',
            extractedInfo: {
              'è¯ä»¶é¢': 'åé¢ï¼ˆå›½å¾½é¢ï¼‰',
              'ç­¾å‘æœºå…³': 'ä¸Šæµ·å¸‚å…¬å®‰å±€æµ¦ä¸œåˆ†å±€',
              'æœ‰æ•ˆæœŸé™': '2020.01.01-2040.01.01'
            }
          };
        }
      }
      
      case 'education': {
        // ========== å­¦å†è®¤è¯å®¡æ ¸è§„åˆ™ ==========
        // è®¾è®¡åŸåˆ™ï¼šæ‹’ç»æ˜æ˜¾çš„éè¯ä¹¦å›¾ç‰‡ï¼Œå…è®¸æ­£å¸¸çš„è¯ä¹¦ç…§ç‰‡é€šè¿‡
        
        // è§„åˆ™1: å›¾ç‰‡å¤§å°å¿…é¡»åœ¨åˆç†èŒƒå›´å†…
        // å¤ªå°çš„å›¾ç‰‡æ— æ³•çœ‹æ¸…è¯ä¹¦å†…å®¹
        if (fileSizeKB < 100) {
          return {
            success: false,
            reason: '**å›¾ç‰‡åˆ†è¾¨ç‡ä¸è¶³**\n\nä¸Šä¼ çš„å›¾ç‰‡å¤ªå°ï¼ˆ' + Math.round(fileSizeKB) + 'KBï¼‰ï¼Œæ— æ³•æ¸…æ™°è¯†åˆ«è¯ä¹¦ä¿¡æ¯ã€‚\n\n**è¯·ä¸Šä¼ ï¼š**\nâ€¢ åˆ†è¾¨ç‡è¾ƒé«˜çš„æ¸…æ™°ç…§ç‰‡ï¼ˆå»ºè®®100KBä»¥ä¸Šï¼‰\nâ€¢ æˆ–ä½¿ç”¨æ‰«æä»ªæ‰«æçš„é«˜æ¸…ç‰ˆæœ¬\n\nğŸ’¡ å»ºè®®ä½¿ç”¨æ‰‹æœºç›¸æœºè¿‘è·ç¦»æ‹æ‘„ï¼Œç¡®ä¿æ–‡å­—æ¸…æ™°å¯è¯»ã€‚'
          };
        }
        
        // è§„åˆ™2: æ‹’ç»æ˜æ˜¾çš„éè¯ä¹¦å›¾ç‰‡ï¼ˆæˆªå›¾ã€å¤´åƒã€å£çº¸ã€è¡¨æƒ…åŒ…ç­‰ï¼‰
        const invalidFilePatterns = [
          // æˆªå›¾ç±»
          'screenshot', 'æˆªå›¾', 'å±å¹•å¿«ç…§', 'screen', 'snip',
          // å¤´åƒ/ç¤¾äº¤ç±»
          'avatar', 'å¤´åƒ', 'profile', 'icon', 'logo',
          // å£çº¸/èƒŒæ™¯ç±»
          'wallpaper', 'å£çº¸', 'background', 'èƒŒæ™¯', 'desktop',
          // è¡¨æƒ…/å¨±ä¹ç±»
          'emoji', 'è¡¨æƒ…', 'meme', 'sticker', 'gif',
          // æ˜æ˜¾éè¯ä¹¦çš„æè¿°
          'é£æ™¯', 'landscape', 'è‡ªæ‹', 'selfie', 'ç¾é£Ÿ', 'food',
          'æ—…æ¸¸', 'travel', 'å® ç‰©', 'pet', 'æ¸¸æˆ', 'game'
        ];
        
        const isInvalidFile = invalidFilePatterns.some(p => fileNameLower.includes(p));
        
        if (isInvalidFile) {
          return {
            success: false,
            reason: '**æ£€æµ‹åˆ°éå­¦å†è¯ä¹¦å›¾ç‰‡**\n\nä¸Šä¼ çš„æ–‡ä»¶ä¸æ˜¯å­¦å†è¯ä¹¦ã€‚\n\n**å­¦å†è®¤è¯è¦æ±‚ä¸Šä¼ ä»¥ä¸‹è¯ä»¶ä¹‹ä¸€ï¼š**\nâ€¢ æ¯•ä¸šè¯ä¹¦åŸä»¶ç…§ç‰‡\nâ€¢ å­¦ä½è¯ä¹¦åŸä»¶ç…§ç‰‡\nâ€¢ å­¦ä¿¡ç½‘å­¦å†è®¤è¯æŠ¥å‘Š\n\n**è¯·é‡æ–°ä¸Šä¼ æ­£ç¡®çš„è¯ä»¶ç…§ç‰‡ã€‚**'
          };
        }
        
        // è§„åˆ™3: æ£€æµ‹å­¦å†ç›¸å…³å…³é”®è¯ï¼ˆç”¨äºä¼˜åŒ–è¯†åˆ«ç»“æœå±•ç¤ºï¼‰
        const educationKeywords = [
          'æ¯•ä¸š', 'å­¦å†', 'å­¦ä½', 'è¯ä¹¦', 'æ–‡å‡­', 'å­¦ä¿¡',
          'å¤§å­¦', 'å­¦é™¢', 'æœ¬ç§‘', 'ç¡•å£«', 'åšå£«', 'ä¸“ç§‘', 'å­¦å£«',
          'diploma', 'degree', 'certificate', 'university', 'college',
          'bachelor', 'master', 'phd'
        ];
        const hasEducationKeyword = educationKeywords.some(k => fileNameLower.includes(k));
        
        // è§„åˆ™4: æ–‡ä»¶å¤§å°å’Œç±»å‹ç»¼åˆåˆ¤æ–­
        // æ­£å¸¸çš„è¯ä¹¦ç…§ç‰‡/æ‰«æä»¶é€šå¸¸åœ¨ 100KB - 10MB ä¹‹é—´
        // å¦‚æœæ–‡ä»¶å¤§å°åˆç†ï¼Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·ä¸Šä¼ çš„æ˜¯æ­£ç¡®çš„è¯ä¹¦
        const isReasonableSize = fileSizeKB >= 100 && fileSizeKB <= 10240;
        
        if (!isReasonableSize) {
          return {
            success: false,
            reason: '**å›¾ç‰‡å¤§å°å¼‚å¸¸**\n\nä¸Šä¼ çš„å›¾ç‰‡å¤§å°ä¸åœ¨æ­£å¸¸èŒƒå›´å†…ã€‚å­¦å†è¯ä¹¦ç…§ç‰‡é€šå¸¸åœ¨ 100KB - 10MB ä¹‹é—´ã€‚\n\n**è¯·æ£€æŸ¥ï¼š**\nâ€¢ æ˜¯å¦ä¸Šä¼ äº†æ­£ç¡®çš„æ–‡ä»¶\nâ€¢ å›¾ç‰‡æ˜¯å¦è¢«è¿‡åº¦å‹ç¼©\n\nè¯·é‡æ–°æ‹æ‘„æˆ–é€‰æ‹©åŸå§‹å›¾ç‰‡ä¸Šä¼ ã€‚'
          };
        }
        
        // é€šè¿‡å®¡æ ¸ï¼Œè¿”å›æ¨¡æ‹Ÿçš„æå–ä¿¡æ¯
        // å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨ OCR API æå–çœŸå®ä¿¡æ¯
        return {
          success: true,
          extractedInfo: {
            'å­¦æ ¡': hasEducationKeyword ? 'æ¸…åå¤§å­¦' : 'åŒ—äº¬å¤§å­¦',
            'ä¸“ä¸š': 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯',
            'å­¦å†': 'æœ¬ç§‘',
            'å­¦ä½': 'å·¥å­¦å­¦å£«',
            'æ¯•ä¸šæ—¶é—´': '2020å¹´6æœˆ',
            'è¯ä¹¦ç¼–å·': '1084**********'
          }
        };
      }
      
      case 'skill_driver': {
        // é©¾é©¶è¯å®¡æ ¸è§„åˆ™
        const driverKeywords = ['é©¾é©¶è¯', 'é©¾ç…§', 'driver', 'license', 'c1', 'c2', 'a1', 'b1'];
        const hasDriverHint = driverKeywords.some(k => fileNameLower.includes(k));
        
        if (fileSizeKB < 80) {
          return {
            success: false,
            reason: 'é©¾é©¶è¯å›¾ç‰‡åˆ†è¾¨ç‡è¿‡ä½ã€‚è¯·ä¸Šä¼ æ¸…æ™°çš„é©¾é©¶è¯ç…§ç‰‡ï¼ˆå»ºè®®ä¸å°äº100KBï¼‰ã€‚'
          };
        }
        
        const driverPassRate = hasDriverHint ? 0.85 : 0.5;
        if (Math.random() > driverPassRate) {
          return {
            success: false,
            reason: 'æœªèƒ½è¯†åˆ«åˆ°æœ‰æ•ˆçš„é©¾é©¶è¯ã€‚\n\nè¯·ç¡®ä¿ï¼š\nâ€¢ ä¸Šä¼ çš„æ˜¯é©¾é©¶è¯æ­£æœ¬ç…§ç‰‡\nâ€¢ å›¾ç‰‡æ¸…æ™°ï¼Œå‡†é©¾è½¦å‹å’Œæœ‰æ•ˆæœŸå¯è¾¨è®¤'
          };
        }
        
        return {
          success: true,
          extractedInfo: {
            'å§“å': 'å¼ ä¸‰',
            'å‡†é©¾è½¦å‹': 'C1',
            'æœ‰æ•ˆæœŸè‡³': '2030-12-31',
            'è¯å·': '110101****1234'
          }
        };
      }
      
      case 'skill_cert': {
        // èŒä¸šèµ„æ ¼è¯ä¹¦å®¡æ ¸è§„åˆ™
        const skillKeywords = [
          'èµ„æ ¼', 'è¯ä¹¦', 'èŒä¸š', 'æŠ€èƒ½', 'ç­‰çº§', 'certificate', 'qualification', 'license',
          'å·¥ç¨‹å¸ˆ', 'ä¼šè®¡', 'å¾‹å¸ˆ', 'åŒ»å¸ˆ', 'æ•™å¸ˆ', 'å»ºé€ å¸ˆ', 'pmp', 'cpa', 'cfa'
        ];
        const hasSkillHint = skillKeywords.some(k => fileNameLower.includes(k));
        
        if (fileSizeKB < 80) {
          return {
            success: false,
            reason: 'èŒä¸šèµ„æ ¼è¯ä¹¦å›¾ç‰‡åˆ†è¾¨ç‡è¿‡ä½ã€‚è¯·ä¸Šä¼ æ¸…æ™°çš„è¯ä¹¦ç…§ç‰‡æˆ–æ‰«æä»¶ï¼ˆå»ºè®®ä¸å°äº100KBï¼‰ã€‚'
          };
        }
        
        const skillPassRate = hasSkillHint ? 0.85 : 0.4;
        if (Math.random() > skillPassRate) {
          return {
            success: false,
            reason: 'æœªèƒ½è¯†åˆ«åˆ°æœ‰æ•ˆçš„èŒä¸šèµ„æ ¼è¯ä¹¦ã€‚\n\n**æŠ€èƒ½è®¤è¯æ”¯æŒä»¥ä¸‹è¯ä¹¦ï¼š**\nâ€¢ å›½å®¶èŒä¸šèµ„æ ¼è¯ä¹¦\nâ€¢ ä¸“ä¸šæŠ€æœ¯èµ„æ ¼è¯ä¹¦\nâ€¢ æŠ€èƒ½ç­‰çº§è¯ä¹¦\nâ€¢ è¡Œä¸šè®¤è¯è¯ä¹¦ï¼ˆå¦‚PMPã€CPAç­‰ï¼‰\n\n**è¯·ç¡®ä¿è¯ä¹¦å›¾ç‰‡ï¼š**\nâ€¢ å®Œæ•´æ˜¾ç¤ºè¯ä¹¦å†…å®¹\nâ€¢ å°ç« å’Œç¼–å·æ¸…æ™°å¯è§'
          };
        }
        
        return {
          success: true,
          extractedInfo: {
            'è¯ä¹¦åç§°': 'é«˜çº§è½¯ä»¶å·¥ç¨‹å¸ˆ',
            'å‘è¯æœºæ„': 'äººåŠ›èµ„æºå’Œç¤¾ä¼šä¿éšœéƒ¨',
            'è¯ä¹¦ç¼–å·': 'XYZ****5678',
            'ç­‰çº§': 'é«˜çº§'
          }
        };
      }
      
      case 'work': {
        // å·¥ä½œè¯æ˜å®¡æ ¸è§„åˆ™
        const workKeywords = [
          'å·¥ç‰Œ', 'åœ¨èŒ', 'ç¦»èŒ', 'è¯æ˜', 'å…¬å¸', 'ä¼ä¸š', 'å‘˜å·¥', 'badge', 'employee', 'email'
        ];
        const hasWorkHint = workKeywords.some(k => fileNameLower.includes(k));
        
        if (fileSizeKB < 50) {
          return {
            success: false,
            reason: 'å·¥ä½œè¯æ˜å›¾ç‰‡åˆ†è¾¨ç‡è¿‡ä½ã€‚è¯·ä¸Šä¼ æ¸…æ™°çš„å·¥ä½œè¯æ˜ç…§ç‰‡ï¼ˆå»ºè®®ä¸å°äº80KBï¼‰ã€‚'
          };
        }
        
        const workPassRate = hasWorkHint ? 0.85 : 0.5;
        if (Math.random() > workPassRate) {
          return {
            success: false,
            reason: 'æœªèƒ½è¯†åˆ«åˆ°æœ‰æ•ˆçš„å·¥ä½œè¯æ˜ã€‚\n\n**æ”¯æŒçš„è¯æ˜ç±»å‹ï¼š**\nâ€¢ å·¥ç‰Œç…§ç‰‡\nâ€¢ ä¼ä¸šé‚®ç®±æˆªå›¾\nâ€¢ åœ¨èŒ/ç¦»èŒè¯æ˜\nâ€¢ åŠ³åŠ¨åˆåŒ\n\nè¯·ç¡®ä¿å…¬å¸åç§°å’Œæ‚¨çš„å§“åæ¸…æ™°å¯è§ã€‚'
          };
        }
        
        return {
          success: true,
          extractedInfo: {
            'å§“å': 'å¼ ä¸‰',
            'å…¬å¸åç§°': 'æŸç§‘æŠ€æœ‰é™å…¬å¸',
            'èŒä½': 'é«˜çº§å·¥ç¨‹å¸ˆ',
            'è®¤è¯æ–¹å¼': 'å·¥ç‰Œ',
            'åœ¨èŒæ—¶é—´': '2020å¹´6æœˆ - è‡³ä»Š'
          }
        };
      }
      
      case 'credit_fund': {
        // å…¬ç§¯é‡‘è¯æ˜å®¡æ ¸è§„åˆ™
        const fundKeywords = [
          'å…¬ç§¯é‡‘', 'ä½æˆ¿', 'ç¼´å­˜', 'è´¦æˆ·', 'fund', 'housing'
        ];
        const hasFundHint = fundKeywords.some(k => fileNameLower.includes(k));
        
        if (fileSizeKB < 50) {
          return {
            success: false,
            reason: 'å…¬ç§¯é‡‘è¯æ˜å›¾ç‰‡åˆ†è¾¨ç‡è¿‡ä½ã€‚è¯·ä¸Šä¼ æ¸…æ™°çš„è¯æ˜ç…§ç‰‡ï¼ˆå»ºè®®ä¸å°äº80KBï¼‰ã€‚'
          };
        }
        
        const fundPassRate = hasFundHint ? 0.85 : 0.5;
        if (Math.random() > fundPassRate) {
          return {
            success: false,
            reason: 'æœªèƒ½è¯†åˆ«åˆ°æœ‰æ•ˆçš„å…¬ç§¯é‡‘è¯æ˜ã€‚\n\n**æ”¯æŒçš„è¯æ˜ç±»å‹ï¼š**\nâ€¢ å…¬ç§¯é‡‘ç¼´å­˜è¯æ˜\nâ€¢ å…¬ç§¯é‡‘è´¦æˆ·æˆªå›¾\nâ€¢ ä½æˆ¿å…¬ç§¯é‡‘æŸ¥è¯¢ç»“æœ\n\nè¯·ç¡®ä¿å§“åå’Œç¼´å­˜ä¿¡æ¯æ¸…æ™°å¯è§ã€‚'
          };
        }
        
        return {
          success: true,
          extractedInfo: {
            'å§“å': 'å¼ ä¸‰',
            'ç¼´å­˜åŸºæ•°': '12000å…ƒ',
            'ç¼´å­˜çŠ¶æ€': 'æ­£å¸¸ç¼´å­˜',
            'ç¼´å­˜æ—¶é—´': '2020å¹´6æœˆ - è‡³ä»Š'
          }
        };
      }
      
      case 'credit_social': {
        // ç¤¾ä¿è¯æ˜å®¡æ ¸è§„åˆ™
        const socialKeywords = [
          'ç¤¾ä¿', 'ç¤¾ä¼šä¿é™©', 'åŒ»ä¿', 'å…»è€', 'social', 'insurance'
        ];
        const hasSocialHint = socialKeywords.some(k => fileNameLower.includes(k));
        
        if (fileSizeKB < 50) {
          return {
            success: false,
            reason: 'ç¤¾ä¿è¯æ˜å›¾ç‰‡åˆ†è¾¨ç‡è¿‡ä½ã€‚è¯·ä¸Šä¼ æ¸…æ™°çš„è¯æ˜ç…§ç‰‡ï¼ˆå»ºè®®ä¸å°äº80KBï¼‰ã€‚'
          };
        }
        
        const socialPassRate = hasSocialHint ? 0.85 : 0.5;
        if (Math.random() > socialPassRate) {
          return {
            success: false,
            reason: 'æœªèƒ½è¯†åˆ«åˆ°æœ‰æ•ˆçš„ç¤¾ä¿è¯æ˜ã€‚\n\n**æ”¯æŒçš„è¯æ˜ç±»å‹ï¼š**\nâ€¢ ç¤¾ä¿ç¼´çº³è¯æ˜\nâ€¢ ç¤¾ä¿è´¦æˆ·æˆªå›¾\nâ€¢ ç¤¾ä¿æŸ¥è¯¢ç»“æœ\n\nè¯·ç¡®ä¿å§“åå’Œç¼´çº³ä¿¡æ¯æ¸…æ™°å¯è§ã€‚'
          };
        }
        
        return {
          success: true,
          extractedInfo: {
            'å§“å': 'å¼ ä¸‰',
            'å‚ä¿ç±»å‹': 'äº”é™©ä¸€é‡‘',
            'ç¼´çº³çŠ¶æ€': 'æ­£å¸¸ç¼´çº³',
            'ç¼´çº³æ—¶é—´': '2020å¹´6æœˆ - è‡³ä»Š'
          }
        };
      }
      
      default:
        return {
          success: true,
          extractedInfo: {
            'è®¤è¯çŠ¶æ€': 'å·²é€šè¿‡'
          }
        };
    }
  };
  
  // è‡ªåŠ¨æ£€æµ‹èº«ä»½è¯æ­£åé¢ (æ¨¡æ‹Ÿ)
  const detectIdCardSide = async (fileName: string): Promise<'front' | 'back' | 'unknown'> => {
    // å®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨å›¾åƒè¯†åˆ« API åˆ†æå›¾ç‰‡å†…å®¹
    // è¿™é‡Œé€šè¿‡æ¨¡æ‹Ÿæ¥æ¼”ç¤ºåŠŸèƒ½
    // æ£€æµ‹é€»è¾‘ï¼šæ­£é¢æœ‰äººåƒå’Œå§“åï¼Œåé¢æœ‰å›½å¾½å’Œæœ‰æ•ˆæœŸ
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // æ¨¡æ‹Ÿ 90% å‡†ç¡®ç‡çš„è‡ªåŠ¨æ£€æµ‹
    const detectionRate = 0.9;
    if (Math.random() < detectionRate) {
      // éšæœºè¿”å›æ­£é¢æˆ–åé¢ï¼ˆå®é™…åº”è¯¥åˆ†æå›¾ç‰‡å†…å®¹ï¼‰
      return Math.random() < 0.5 ? 'front' : 'back';
    }
    return 'unknown';
  };

  // ç¡®è®¤å¼¹çª—çŠ¶æ€
  const [showMobileTaskPanel, setShowMobileTaskPanel] = useState(false);
  const [confirmDialog, setConfirmDialog] = useState<{
    show: boolean;
    title: string;
    message: string;
    onConfirm: () => void;
  }>({ show: false, title: '', message: '', onConfirm: () => {} });

  const handleResetChat = () => {
    setConfirmDialog({
      show: true,
      title: 'æ¸…é™¤èŠå¤©è®°å½•',
      message: selectedTask 
        ? `ç¡®å®šè¦æ¸…é™¤ã€Œ${selectedTask.title || selectedTask.task || ''}ã€çš„èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`
        : 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
      onConfirm: () => {
        if (selectedTask) {
          const taskId = selectedTask.id;
          const taskTitle = selectedTask.title || selectedTask.task || '';
          const taskType = selectedTask.todo_type || selectedTask.type || '';
          const isProfileTask = taskType === 'profile_complete' || taskTitle === 'å®Œå–„ç®€å†èµ„æ–™';
          
          // é‡ç½®ä»»åŠ¡å¯¹è¯ä¸ºåˆå§‹æ¶ˆæ¯
          setTaskMessages(prev => ({
            ...prev,
            [taskId]: [{
              role: 'assistant',
              content: isProfileTask
                ? `ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ¥å¸®æ‚¨å®Œæˆã€Œ${taskTitle}ã€ä»»åŠ¡ã€‚\n\nè¾“å…¥ "å¼€å§‹å¡«å†™ç®€å†" å¼€å§‹å¼•å¯¼æµç¨‹ã€‚`
                : `ä½ å¥½ï¼æˆ‘æ˜¯ Devnors ä»»åŠ¡æ‰§è¡ŒåŠ©æ‰‹ã€‚å…³äº"${taskTitle}"è¿™é¡¹ä»»åŠ¡ï¼Œæˆ‘å·²ç»å‡†å¤‡å¥½ååŠ©æ‚¨ã€‚`
            }]
          }));
          
          // é‡ç½®ç›¸å…³æ¨¡å¼
          setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
          setPostMode({ active: false, step: 'requirement', jobDescription: '', generatedResult: null });
          
          // åå°æ¸…é™¤èŠå¤©è®°å½•
          (async () => {
            try {
              await fetch(`/api/v1/public/chat-messages?user_id=${userId}&todo_id=${taskId}`, { method: 'DELETE' });
            } catch { /* ignore */ }
          })();
        } else {
          // é€šç”¨åŠ©æ‰‹ï¼šé‡ç½®ä¸ºæ¬¢è¿æ¶ˆæ¯
          setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
          setGeneralMessages([{role: 'assistant', content: getWelcomeMessage()}]);
          
          // åå°æ¸…é™¤èŠå¤©è®°å½•
          (async () => {
            try {
              await fetch(`/api/v1/public/chat-messages?user_id=${userId}`, { method: 'DELETE' });
            } catch { /* ignore */ }
          })();
        }
        
        // æ¸…é™¤ localStorage
        try {
          localStorage.removeItem(GENERAL_MESSAGES_KEY);
          localStorage.removeItem(TASK_MESSAGES_KEY);
        } catch { /* ignore */ }
        
        setConfirmDialog(prev => ({ ...prev, show: false }));
      }
    });
  };

  const TaskIcon = selectedTask ? getIconComponent(selectedTask.icon) : Calendar;

  return (
    <div className="fixed top-[52px] md:top-[60px] left-0 right-0 bottom-[40px] bg-slate-50 animate-in fade-in duration-500 z-10">
      <div className="flex gap-0 h-full relative">
        {/* ç§»åŠ¨ç«¯ä»»åŠ¡é¢æ¿é®ç½© */}
        {showMobileTaskPanel && (
          <div className="fixed inset-0 bg-black/30 z-40 md:hidden" onClick={() => setShowMobileTaskPanel(false)} />
        )}
        {/* å·¦ä¾§ä»»åŠ¡åˆ—è¡¨ â€” ç§»åŠ¨ç«¯ä¸ºæ»‘å‡ºæŠ½å±‰ */}
        <div className={`
          fixed md:relative top-0 left-0 z-50 md:z-auto
          w-[280px] md:w-[280px] h-full md:h-auto flex-shrink-0
          bg-white border-r border-slate-200/40
          overflow-hidden flex flex-col
          transition-transform duration-300 ease-out
          ${showMobileTaskPanel ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}
        `}>
          <div className="bg-white px-4 py-3 border-b border-slate-100">
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-2">
                <div className="w-7 h-7 bg-indigo-600 rounded-lg flex items-center justify-center">
                  <ListTodo size={13} className="text-white" />
                </div>
                <span className="text-slate-800 font-semibold text-sm">ä»»åŠ¡ä¸­å¿ƒ</span>
              </div>
            </div>
            {/* ä»»åŠ¡ç­›é€‰æ ‡ç­¾ */}
            <div className="flex gap-1 bg-slate-100/80 p-0.5 rounded-xl">
              <button
                onClick={() => setTaskFilter('pending')}
                className={`flex-1 px-2 py-1.5 rounded-[10px] text-xs font-medium transition-all ${
                  taskFilter === 'pending' 
                    ? 'bg-white text-slate-800 shadow-sm' 
                    : 'text-slate-500 hover:text-slate-700'
                }`}
              >
                è¿›è¡Œä¸­ ({pendingTasksCount})
              </button>
              <button
                onClick={() => setTaskFilter('completed')}
                className={`flex-1 px-2 py-1.5 rounded-[10px] text-xs font-medium transition-all ${
                  taskFilter === 'completed' 
                    ? 'bg-white text-slate-800 shadow-sm' 
                    : 'text-slate-500 hover:text-slate-700'
                }`}
              >
                å·²å®Œæˆ ({completedTasksCount})
              </button>
            </div>
          </div>
          <div className="flex-1 p-3 space-y-2 overflow-y-auto scrollbar-hide">
            {/* é€šç”¨åŠ©æ‰‹å…¥å£ */}
            <div 
              className={`cursor-pointer px-2.5 py-2 rounded-lg border transition-all ${
                !selectedTask 
                  ? 'bg-indigo-50/50 border-indigo-200/60 shadow-sm' 
                  : 'bg-transparent border-transparent hover:bg-slate-50 hover:border-slate-200/60'
              }`}
              onClick={() => { setSelectedTask(null); setShowMobileTaskPanel(false); }}
            >
              <div className="flex items-center gap-2.5">
                <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${
                  !selectedTask ? 'bg-indigo-600 text-white' : 'bg-white text-slate-600 border border-slate-200/60'
                }`}>
                  <Bot size={16} />
                </div>
                <div className="flex-1 min-w-0">
                  <div className="text-sm font-semibold text-slate-800 truncate">Devnors AI Agent</div>
                  <div className="text-xs text-slate-400">éšæ—¶æé—®å’¨è¯¢</div>
                </div>
              </div>
            </div>
            
            <div className="border-t border-slate-100 my-2"></div>
            
            {!isLoggedIn ? (
              <div className="flex flex-col items-center justify-center py-8 text-center">
                <UserIcon size={40} className="text-slate-200 mb-3" />
                <p className="text-slate-400 text-sm font-medium mb-1">è¯·å…ˆç™»å½•</p>
                <p className="text-slate-300 text-xs mb-3">ç™»å½•åå¯æŸ¥çœ‹ä»»åŠ¡</p>
                <button 
                  onClick={() => navigate('/login')}
                  className="px-4 py-2 bg-indigo-600 text-white text-xs rounded-xl hover:bg-indigo-500 transition-colors"
                >
                  ç«‹å³ç™»å½•
                </button>
              </div>
            ) : tasksLoading ? (
              <div className="flex items-center justify-center py-8">
                <Loader2 className="animate-spin text-indigo-600" size={24} />
              </div>
            ) : filteredTasks.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-8 text-center">
                <ListTodo size={40} className="text-slate-200 mb-3" />
                <p className="text-slate-400 text-sm font-medium mb-1">
                  {taskFilter === 'completed' ? 'æš‚æ— å·²å®Œæˆä»»åŠ¡' : 'æš‚æ— è¿›è¡Œä¸­ä»»åŠ¡'}
                </p>
                <p className="text-slate-300 text-xs">
                  {taskFilter === 'completed' ? 'å®Œæˆä»»åŠ¡åä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ' : 'AI ä¼šè‡ªåŠ¨ç”Ÿæˆä»»åŠ¡'}
                </p>
              </div>
            ) : filteredTasks.map((task: any) => {
              const TaskItemIcon = getIconComponent(task.icon);
              const isSelected = selectedTask?.id === task.id;
              return (
                <div 
                  key={task.id} 
                  className={`cursor-pointer px-2.5 py-2 rounded-lg border transition-all ${
                    isSelected 
                      ? 'bg-indigo-50/50 border-indigo-200/60 shadow-sm' 
                      : 'bg-transparent border-transparent hover:bg-slate-50 hover:border-slate-200/60'
                  }`}
                  onClick={() => { setSelectedTask(task); setShowMobileTaskPanel(false); }}
                >
                  <div className="flex items-center gap-2.5">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 ${
                      task.status === 'running' ? 'bg-amber-50 text-amber-600' : 
                      task.status === 'completed' ? 'bg-emerald-50 text-emerald-600' : 
                      isSelected ? 'bg-indigo-600 text-white' : 'bg-white text-slate-400 border border-slate-200/60'
                    }`}>
                      <TaskItemIcon size={14} />
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className={`text-sm font-semibold truncate ${isSelected ? 'text-indigo-700' : 'text-slate-700'}`}>
                        {task.title}
                      </div>
                      <div className="flex items-center gap-1.5 mt-0.5">
                        {task.status?.toLowerCase() === 'running' && <Loader2 size={10} className="animate-spin text-amber-500" />}
                        {task.status?.toLowerCase() === 'completed' && <CheckCircle2 size={10} className="text-emerald-500" />}
                        <span className={`text-xs ${
                          task.status?.toLowerCase() === 'running' ? 'text-amber-500' : 
                          task.status?.toLowerCase() === 'completed' ? 'text-emerald-500' : 'text-slate-400'
                        }`}>
                          {task.status?.toLowerCase() === 'running' ? 'è¿›è¡Œä¸­' : task.status?.toLowerCase() === 'completed' ? 'å·²å®Œæˆ' : 'å¾…æ‰§è¡Œ'}
                        </span>
                        {task.priority && (
                          <span className={`text-xs ${
                            task.priority === 'High' ? 'text-rose-500' : 
                            task.priority === 'Medium' ? 'text-amber-500' : 'text-slate-400'
                          }`}>
                            Â· {task.priority}
                          </span>
                        )}
                        {task.source === 'agent' && (
                          <span className="text-xs text-purple-500">Â· Agent</span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {/* å³ä¾§ AI å¯¹è¯åŒºåŸŸ â€” å±…ä¸­é™å®½ */}
        <div className="flex-1 flex justify-center min-w-0">
        <div className="w-full max-w-3xl bg-white border-l border-slate-200/40 overflow-hidden flex flex-col min-w-0">
          {/* å¤´éƒ¨ */}
          <div className="bg-white px-3 py-2.5 md:px-5 md:py-3 border-b border-slate-100 flex justify-between items-center gap-2">
            <div className="flex items-center gap-2 md:gap-3 min-w-0">
              {/* ç§»åŠ¨ç«¯ä»»åŠ¡é¢æ¿åˆ‡æ¢æŒ‰é’® */}
              <button 
                onClick={() => setShowMobileTaskPanel(!showMobileTaskPanel)} 
                className="md:hidden p-1.5 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all flex-shrink-0"
                title="ä»»åŠ¡åˆ—è¡¨"
              >
                <ListTodo size={18} />
              </button>
              <div className="w-2 h-2 md:w-2.5 md:h-2.5 bg-emerald-500 rounded-full animate-pulse flex-shrink-0"></div>
              <span className="text-slate-900 font-bold text-sm md:text-base truncate">
                {selectedTask ? (selectedTask.title || 'ä»»åŠ¡å¯¹è¯').substring(0, 15) : 'Devnors AI Agent'}
              </span>
            </div>
            <div className="flex items-center gap-1.5 md:gap-3 flex-shrink-0">
              <select 
                value={selectedModel} 
                onChange={(e) => {
                  if (isModelAvailable(e.target.value)) setSelectedModel(e.target.value);
                }}
                className="text-[11px] md:text-xs border border-slate-200/60 rounded-xl px-2 py-1 md:px-2.5 md:py-1 bg-slate-50 text-slate-700 font-medium focus:outline-none focus:border-indigo-300 cursor-pointer max-w-[110px] md:max-w-none"
              >
                {allModelOptions.map(model => (
                  <option key={model} value={model} disabled={!isModelAvailable(model)}>
                    {model}{!isModelAvailable(model) ? ' (éœ€å‡çº§)' : ''}
                  </option>
                ))}
              </select>
              {user?.account_tier !== 'ULTRA' && (
                <Link to="/pricing" className="hidden md:flex text-amber-500 hover:text-amber-600 transition-colors" title="å‡çº§æ–¹æ¡ˆ">
                  <Zap size={14} />
                </Link>
              )}
              <button 
                onClick={handleResetChat} 
                className="p-1.5 md:p-2 text-slate-400 hover:text-indigo-600 hover:bg-slate-50 rounded-xl transition-all" 
                title="æ¸…é™¤èŠå¤©è®°å½•"
              >
                <RotateCcw size={14} />
              </button>
            </div>
          </div>
          
          {/* ä»»åŠ¡ä¿¡æ¯æ¡ï¼ˆé€‰ä¸­ä»»åŠ¡æ—¶æ˜¾ç¤ºï¼‰ */}
          {selectedTask && (
            <div className="px-3 py-2 md:px-4 md:py-2.5 bg-slate-50/50 border-b border-slate-100">
              <div className="flex items-center gap-2 md:gap-3">
                <div className="w-8 h-8 md:w-9 md:h-9 bg-indigo-600 rounded-xl flex items-center justify-center text-white flex-shrink-0">
                  <TaskIcon size={15} />
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-1.5 md:gap-2 mb-0.5">
                    <span className="text-sm md:text-base font-bold text-slate-900 truncate">{selectedTask.title || selectedTask.task}</span>
                    <span className={`px-1.5 py-0.5 rounded-md text-[9px] font-medium uppercase flex-shrink-0 ${
                      selectedTask.priority === 'High' ? 'bg-rose-100 text-rose-600' : 
                      selectedTask.priority === 'Medium' ? 'bg-amber-100 text-amber-600' : 'bg-slate-100 text-slate-600'
                    }`}>
                      {selectedTask.priority}
                    </span>
                    {selectedTask.source === 'agent' && (
                      <span className="px-1.5 py-0.5 rounded-md text-[9px] font-medium bg-purple-100 text-purple-600 flex-shrink-0">Agent</span>
                    )}
                  </div>
                  <div className="flex items-center gap-2 md:gap-3 text-[10px] md:text-xs text-slate-500 overflow-x-auto scrollbar-hide">
                    {/* äº‘ç«¯æ±‚èŒè½®å·¡ä»»åŠ¡æ˜¾ç¤ºç‰¹æ®Šä¿¡æ¯ */}
                    {/* æ™ºèƒ½æ‹›è˜ä»»åŠ¡ï¼šæ˜¾ç¤ºé˜¶æ®µæ­¥éª¤è¿›åº¦æ¡ + å²—ä½å¿«é€Ÿå…¥å£ */}
                    {(selectedTask.todo_type?.toUpperCase() === 'RECRUIT' || selectedTask.title?.includes('æ™ºèƒ½æ‹›è˜')) && postMode.active ? (() => {
                      const { steps: recruitSteps, currentIdx } = getRecruitStepInfo();
                      const stepsMetadata = selectedTask.steps?.metadata || {};
                      const linkedJobIds: number[] = stepsMetadata.published_job_ids || [];
                      const hasPublishedJobs = linkedJobIds.length > 0 || (postMode.publishedJobs && postMode.publishedJobs.length > 0);
                      
                      return (
                        <div className="flex flex-col gap-1 w-full">
                          {/* æ­¥éª¤è¿›åº¦æ¡ */}
                          <div className="flex items-center gap-0.5">
                            {recruitSteps.map((s, i) => (
                              <div key={s.key} className="flex items-center gap-0.5">
                                <div className={`flex items-center gap-0.5 px-1.5 py-0.5 rounded-md text-[10px] font-bold transition-all whitespace-nowrap ${
                                  i < currentIdx ? 'bg-emerald-100 text-emerald-700' :
                                  i === currentIdx ? 'bg-indigo-100 text-indigo-700 ring-1 ring-indigo-300' :
                                  'bg-slate-100 text-slate-400'
                                }`}>
                                  <span className="flex items-center">{i < currentIdx ? <Check size={10} /> : s.icon}</span>
                                  <span>{s.short}</span>
                                </div>
                                {i < recruitSteps.length - 1 && (
                                  <div className={`w-2 h-0.5 rounded-full ${i < currentIdx ? 'bg-emerald-300' : 'bg-slate-200'}`} />
                                )}
                              </div>
                            ))}
                          </div>
                          {/* å·²å‘å¸ƒå²—ä½å¿«é€Ÿå…¥å£ */}
                          {hasPublishedJobs && (
                            <div className="flex items-center gap-1.5 mt-0.5">
                              <Briefcase size={10} className="text-indigo-400 flex-shrink-0" />
                              <span className="text-[10px] text-slate-400 flex-shrink-0">å…³è”å²—ä½ï¼š</span>
                              <div className="flex items-center gap-1 overflow-x-auto scrollbar-hide">
                                {(postMode.publishedJobs && postMode.publishedJobs.length > 0 
                                  ? postMode.publishedJobs 
                                  : linkedJobIds.map(id => ({ _publishedId: id, id, title: `å²—ä½ #${id}` }))
                                ).map((job: any, ji: number) => {
                                  const jobId = job._publishedId || job.id;
                                  return (
                                    <button
                                      key={ji}
                                      onClick={() => navigate(`/employer/post/${jobId}`)}
                                      className="flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-bold bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50 hover:border-indigo-400 transition-all whitespace-nowrap group cursor-pointer"
                                      title={`æŸ¥çœ‹å²—ä½ï¼š${job.title || `#${jobId}`}`}
                                    >
                                      <span className="truncate max-w-[100px]">{job.title || `#${jobId}`}</span>
                                      <ExternalLink size={8} className="opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0" />
                                    </button>
                                  );
                                })}
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })() : selectedTask.title?.includes('äº‘ç«¯æ±‚èŒè½®å·¡') ? (
                      <>
                        <span className="flex items-center gap-1">
                          <Clock size={12} className="text-amber-500" />
                          å·²æ‰§è¡Œ {(() => {
                            const createdStr = selectedTask.created_at || selectedTask.createdAt || selectedTask.updated_at || selectedTask.updatedAt;
                            if (!createdStr) return '1åˆ†é’Ÿ';
                            const created = new Date(createdStr.replace(' ', 'T'));
                            if (isNaN(created.getTime())) return '1åˆ†é’Ÿ';
                            const now = new Date();
                            const diffMs = now.getTime() - created.getTime();
                            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                            if (diffHours > 24) {
                              const diffDays = Math.floor(diffHours / 24);
                              return `${diffDays}å¤©${diffHours % 24}å°æ—¶`;
                            }
                            if (diffHours > 0) return `${diffHours}å°æ—¶${diffMins}åˆ†é’Ÿ`;
                            return `${Math.max(1, diffMins)}åˆ†é’Ÿ`;
                          })()}
                        </span>
                        <span className="text-slate-300">|</span>
                        <span className="flex items-center gap-1">
                          <Eye size={12} className="text-blue-500" />
                          æŸ¥çœ‹å²—ä½ <strong className="text-blue-600">{aiFlowStats?.viewed || 0}</strong> ä¸ª
                        </span>
                        <span className="text-slate-300">|</span>
                        <span className="flex items-center gap-1">
                          <Send size={12} className="text-emerald-500" />
                          æŠ•é€’å²—ä½ <strong className="text-emerald-600">{aiFlowStats?.applied || 0}</strong> ä¸ª
                        </span>
                        <span className="text-slate-300">|</span>
                        <span className="flex items-center gap-1">
                          <CheckCircle2 size={12} className="text-emerald-500" />
                          é€šè¿‡ <strong className="text-emerald-600">{aiFlowStats?.passed || 0}</strong>
                        </span>
                        <span className="text-slate-300">|</span>
                        <button
                          onClick={(e) => { e.stopPropagation(); navigate('/workbench'); }}
                          className="flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[11px] font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition-all whitespace-nowrap shadow-sm active:scale-95"
                        >
                          <Activity size={10} /> æŸ¥çœ‹è¯¦æƒ…
                          <ChevronRight size={10} />
                        </button>
                      </>
                    ) : (
                      <>
                        <span>{selectedTask.description?.substring(0, 40)}{selectedTask.description?.length > 40 ? '...' : ''}</span>
                        <span className="flex items-center gap-1 text-indigo-600 font-medium flex-shrink-0">
                          <div className="w-12 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                            <div className="h-full bg-indigo-500 rounded-full transition-all duration-300" style={{ width: `${getTaskDisplayProgress()}%` }}></div>
                          </div>
                          {getTaskDisplayProgress()}%
                        </span>
                      </>
                    )}
                  </div>
                </div>
                <button 
                  onClick={() => {
                    const task = selectedTask;
                    if (!task) return;
                    setConfirmDialog({
                      show: true,
                      title: 'åˆ é™¤ä»»åŠ¡',
                      message: `ç¡®å®šè¦åˆ é™¤ä»»åŠ¡ã€Œ${task.title || task.task || ''}ã€åŠå…¶èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
                      onConfirm: () => {
                        const taskId = task.id;
                        setTaskMessages(prev => {
                          const updated = { ...prev };
                          delete updated[taskId];
                          return updated;
                        });
                        setSelectedTask(null);
                        setProfileCompleteMode({ active: false, missingFields: [], currentFieldIndex: -1 });
                        setPostMode({ active: false, step: 'requirement', jobDescription: '', generatedResult: null });
                        (async () => {
                          try {
                            const { deleteTodo } = await import('./services/apiService');
                            await deleteTodo(taskId);
                            if (typeof refetchTasks === 'function') refetchTasks();
                          } catch (e) { console.error('[Task] åˆ é™¤ä»»åŠ¡å¤±è´¥:', e); }
                          try {
                            await fetch(`/api/v1/public/chat-messages?user_id=${userId}&todo_id=${taskId}`, { method: 'DELETE' });
                          } catch { /* ignore */ }
                        })();
                        try {
                          localStorage.removeItem(TASK_MESSAGES_KEY);
                        } catch { /* ignore */ }
                        setConfirmDialog(prev => ({ ...prev, show: false }));
                      }
                    });
                  }}
                  className="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all flex-shrink-0"
                  title="åˆ é™¤ä»»åŠ¡"
                >
                  <Trash2 size={14} />
                </button>
              </div>
            </div>
          )}
            
          {/* æ¶ˆæ¯åŒºåŸŸ */}
          <div ref={scrollRef} className="flex-1 overflow-y-auto p-3 md:p-5 space-y-3 md:space-y-4 scrollbar-hide bg-white">
            {currentMessages.map((msg, idx) => (
              <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`flex gap-2 md:gap-3 max-w-[92%] md:max-w-[80%] ${msg.role === 'user' ? 'flex-row-reverse' : 'flex-row'}`}>
                  <div className={`w-6 h-6 md:w-7 md:h-7 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden ${
                    msg.role === 'user' ? (user?.avatar_url ? '' : 'bg-indigo-600') : 'bg-slate-100'
                  }`}>
                    {msg.role === 'user' ? (
                      user?.avatar_url 
                        ? <img src={user.avatar_url} alt="" className="w-full h-full object-cover" />
                        : <UserIcon size={12} className="text-white md:w-[13px] md:h-[13px]" />
                    ) : <Bot size={12} className="text-indigo-600 md:w-[13px] md:h-[13px]" />}
                  </div>
                  <div className={`px-3.5 py-2.5 md:px-4 md:py-3 rounded-2xl text-sm md:text-[15px] leading-relaxed ${
                    msg.role === 'user' 
                      ? 'bg-indigo-600 text-white rounded-tr-md' 
                      : 'bg-slate-50/80 text-slate-700 rounded-tl-md border border-slate-100'
                  }`}>
                    {msg.role === 'user' ? (
                      <p className="whitespace-pre-line">{msg.content}</p>
                    ) : msg.content.startsWith('â˜ï¸') && idx === currentMessages.length - 1 ? (
                      /* äº‘ç«¯å¼‚æ­¥è¿›åº¦æ¶ˆæ¯ â€” ç”¨æ‰“å­—æœºæ•ˆæœå®æ—¶å±•ç¤º */
                      <div className="markdown-content">
                        <StreamingMessage targetText={msg.content} speed={12} onTyping={() => scrollRef.current?.scrollTo(0, scrollRef.current.scrollHeight)} />
                      </div>
                    ) : (
                      <div className="markdown-content">
                        {/* æ¸²æŸ“æ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒä»»åŠ¡å¡ç‰‡ã€é“¾æ¥å¡ç‰‡å’Œæ€è€ƒè¿‡ç¨‹æŠ˜å  */}
                        {(() => {
                          // ç»Ÿä¸€è§£æ: [[TASK:...]], [[LINK:...]], [[ACTION:...]], <think>...</think>
                          const combinedRegex = /\[\[(TASK|LINK|ACTION):([^:]+):([^:]+):([^\]]+)\]\]|<think>([\s\S]*?)<\/think>/g;
                          type PartType = string 
                            | { type: 'task'; title: string; taskType: string; icon: string } 
                            | { type: 'link'; title: string; path: string; icon: string } 
                            | { type: 'action'; label: string; message: string; style: string }
                            | { type: 'thinking'; content: string };
                          const parts: PartType[] = [];
                          let lastIndex = 0;
                          let match;
                          const content = msg.content;
                          
                          while ((match = combinedRegex.exec(content)) !== null) {
                            // æ·»åŠ åŒ¹é…ä¹‹å‰çš„æ–‡æœ¬
                            if (match.index > lastIndex) {
                              parts.push(content.slice(lastIndex, match.index));
                            }
                            
                            if (match[5] !== undefined) {
                              // <think>...</think> åŒ¹é…
                              parts.push({ type: 'thinking', content: match[5].trim() });
                            } else if (match[1] === 'TASK') {
                              parts.push({
                                type: 'task',
                                title: match[2],
                                taskType: match[3],
                                icon: match[4]
                              });
                            } else if (match[1] === 'LINK') {
                              parts.push({
                                type: 'link',
                                title: match[2],
                                path: match[3],
                                icon: match[4]
                              });
                            } else if (match[1] === 'ACTION') {
                              parts.push({
                                type: 'action',
                                label: match[2],
                                message: match[3],
                                style: match[4]
                              });
                            }
                            lastIndex = match.index + match[0].length;
                          }
                          // æ·»åŠ å‰©ä½™æ–‡æœ¬
                          if (lastIndex < content.length) {
                            parts.push(content.slice(lastIndex));
                          }
                          
                          // å¦‚æœæ²¡æœ‰ä»»åŠ¡å¡ç‰‡ï¼Œç›´æ¥æ¸²æŸ“ Markdown
                          if (parts.length === 1 && typeof parts[0] === 'string') {
                            return (
                              <ReactMarkdown 
                                remarkPlugins={[remarkGfm]}
                                components={{
                                  a: ({node, ...props}) => (
                                    <Link to={props.href || '#'} className="text-indigo-600 hover:underline font-medium">
                                      {props.children}
                                    </Link>
                                  ),
                                  h1: ({node, ...props}) => <h3 className="text-base font-bold text-slate-900 mt-3 mb-2" {...props} />,
                                  h2: ({node, ...props}) => <h4 className="text-sm font-bold text-slate-900 mt-3 mb-1.5" {...props} />,
                                  h3: ({node, ...props}) => <h5 className="text-sm font-bold text-slate-800 mt-2 mb-1" {...props} />,
                                  p: ({node, ...props}) => <p className="my-1.5 leading-relaxed" {...props} />,
                                  ul: ({node, ...props}) => <ul className="my-2 ml-4 list-disc space-y-1" {...props} />,
                                  ol: ({node, ...props}) => <ol className="my-2 ml-4 list-decimal space-y-1" {...props} />,
                                  li: ({node, ...props}) => <li className="leading-relaxed" {...props} />,
                                  strong: ({node, ...props}) => <strong className="font-bold text-slate-900" {...props} />,
                                  em: ({node, ...props}) => <em className="italic" {...props} />,
                                  code: ({node, inline, className, ...props}: any) => {
                                    const isInline = inline || !className;
                                    return isInline ? (
                                      <code className="bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded text-xs font-mono" {...props} />
                                    ) : (
                                      <code className="block bg-slate-900 text-slate-100 p-3 rounded-lg text-xs overflow-x-auto font-mono my-2" {...props} />
                                    );
                                  },
                                  pre: ({node, ...props}) => <pre className="my-2" {...props} />,
                                  hr: ({node, ...props}) => <hr className="my-3 border-slate-200" {...props} />,
                                  blockquote: ({node, ...props}) => (
                                    <blockquote className="border-l-4 border-indigo-300 pl-3 my-2 text-slate-600 italic bg-slate-50 py-2 rounded-r" {...props} />
                                  ),
                                  table: ({node, ...props}) => (
                                    <div className="overflow-x-auto my-2">
                                      <table className="min-w-full border-collapse border border-slate-200 text-xs" {...props} />
                                    </div>
                                  ),
                                  th: ({node, ...props}) => <th className="border border-slate-200 bg-slate-50 px-3 py-2 text-left font-bold" {...props} />,
                                  td: ({node, ...props}) => <td className="border border-slate-200 px-3 py-2" {...props} />,
                                  img: ({node, ...props}) => <img className="max-w-full h-auto rounded-lg my-2" {...props} />,
                                }}
                              >
                                {content}
                              </ReactMarkdown>
                            );
                          }
                          
                          // æœ‰ä»»åŠ¡å¡ç‰‡æ—¶ï¼Œåˆ†æ®µæ¸²æŸ“
                          return parts.map((part, partIdx) => {
                            if (typeof part === 'string') {
                              return (
                                <ReactMarkdown 
                                  key={partIdx}
                                  remarkPlugins={[remarkGfm]}
                                  components={{
                                    a: ({node, ...props}) => (
                                      <Link to={props.href || '#'} className="text-indigo-600 hover:underline font-medium">
                                        {props.children}
                                      </Link>
                                    ),
                                    h1: ({node, ...props}) => <h3 className="text-base font-bold text-slate-900 mt-3 mb-2" {...props} />,
                                    h2: ({node, ...props}) => <h4 className="text-sm font-bold text-slate-900 mt-3 mb-1.5" {...props} />,
                                    h3: ({node, ...props}) => <h5 className="text-sm font-bold text-slate-800 mt-2 mb-1" {...props} />,
                                    p: ({node, ...props}) => <p className="my-1.5 leading-relaxed" {...props} />,
                                    ul: ({node, ...props}) => <ul className="my-2 ml-4 list-disc space-y-1" {...props} />,
                                    ol: ({node, ...props}) => <ol className="my-2 ml-4 list-decimal space-y-1" {...props} />,
                                    li: ({node, ...props}) => <li className="leading-relaxed" {...props} />,
                                    strong: ({node, ...props}) => <strong className="font-bold text-slate-900" {...props} />,
                                    em: ({node, ...props}) => <em className="italic" {...props} />,
                                    code: ({node, inline, className, ...props}: any) => {
                                      const isInline = inline || !className;
                                      return isInline ? (
                                        <code className="bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded text-xs font-mono" {...props} />
                                      ) : (
                                        <code className="block bg-slate-900 text-slate-100 p-3 rounded-lg text-xs overflow-x-auto font-mono my-2" {...props} />
                                      );
                                    },
                                    pre: ({node, ...props}) => <pre className="my-2" {...props} />,
                                    hr: ({node, ...props}) => <hr className="my-3 border-slate-200" {...props} />,
                                    blockquote: ({node, ...props}) => (
                                      <blockquote className="border-l-4 border-indigo-300 pl-3 my-2 text-slate-600 italic bg-slate-50 py-2 rounded-r" {...props} />
                                    ),
                                    table: ({node, ...props}) => (
                                      <div className="overflow-x-auto my-2">
                                        <table className="min-w-full border-collapse border border-slate-200 text-xs" {...props} />
                                      </div>
                                    ),
                                    th: ({node, ...props}) => <th className="border border-slate-200 bg-slate-50 px-3 py-2 text-left font-bold" {...props} />,
                                    td: ({node, ...props}) => <td className="border border-slate-200 px-3 py-2" {...props} />,
                                    img: ({node, ...props}) => <img className="max-w-full h-auto rounded-lg my-2" {...props} />,
                                  }}
                                >
                                  {part}
                                </ReactMarkdown>
                              );
                            } else if (part.type === 'task') {
                              // æ¸²æŸ“ä»»åŠ¡å¡ç‰‡
                              const handleTaskClick = async () => {
                                try {
                                  // ç‰¹æ®Šæ“ä½œç±»å‹ï¼šç›´æ¥æ‰§è¡ŒåŠ¨ä½œè€Œéåˆ›å»º/é€‰ä¸­ä»»åŠ¡
                                  if (part.taskType === 'post_job') {
                                    navigate('/ai-assistant?taskType=post');
                                    return;
                                  }
                                  if (part.taskType === 'search_candidates') {
                                    setSelectedTask(null);
                                    handleSend('æˆ‘æƒ³æœç´¢ç­›é€‰å€™é€‰äººï¼Œè¯·å¸®æˆ‘å¼€å§‹æ™ºèƒ½äººæ‰æœç´¢');
                                    return;
                                  }
                                  
                                  const { createTodo, getTasks } = await import('./services/apiService');
                                  
                                  // å…ˆè·å–æœ€æ–°çš„ä»»åŠ¡åˆ—è¡¨
                                  const latestTasks = await getTasks(userId);
                                  
                                  // æ‰¾åˆ°å¯¹åº”ä»»åŠ¡ï¼ˆæ”¯æŒç²¾ç¡®åŒ¹é…ã€åŒ…å«åŒ¹é…ã€ç±»å‹åŒ¹é…ï¼‰
                                  let targetTask = latestTasks.find((t: any) => 
                                    t.title === part.title || 
                                    t.title?.includes(part.title) || 
                                    part.title?.includes(t.title) ||
                                    (part.taskType === 'enterprise_verification' && t.title === 'å®Œæˆä¼ä¸šè®¤è¯') ||
                                    (part.taskType === 'enterprise_profile' && t.title === 'å®Œå–„ä¼ä¸šèµ„æ–™') ||
                                    (part.taskType === 'profile_complete' && t.title === 'å®Œå–„ç®€å†èµ„æ–™') ||
                                    (part.taskType === 'personal_verification' && t.title === 'å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯') ||
                                    (part.taskType === 'cloud_job' && t.title?.includes('äº‘ç«¯æ±‚èŒè½®å·¡'))
                                  );
                                  
                                  console.log('[TaskCard] æŸ¥æ‰¾ä»»åŠ¡:', part.title, part.taskType, 'æ‰¾åˆ°:', targetTask?.title);
                                  
                                  // å¦‚æœä»»åŠ¡ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä»»åŠ¡
                                  if (!targetTask && part.taskType) {
                                    // æ ¹æ®ä»»åŠ¡ç±»å‹åˆ›å»ºç›¸åº”çš„ä»»åŠ¡
                                    let taskData: any = null;
                                    
                                    if (part.taskType === 'enterprise_verification') {
                                      taskData = {
                                        title: 'å®Œæˆä¼ä¸šè®¤è¯',
                                        description: 'å®Œæˆè¥ä¸šæ‰§ç…§ã€èµ„è´¨è®¤è¯ç­‰ä¼ä¸šè®¤è¯ï¼Œæå‡æ‹›è˜æ•ˆæœå’Œå¯ä¿¡åº¦',
                                        priority: 'HIGH',
                                        source: 'AGENT',
                                        todo_type: 'EMPLOYER',
                                        icon: 'Building2',
                                        user_id: userId,
                                      };
                                    } else if (part.taskType === 'profile_complete') {
                                      taskData = {
                                        title: 'å®Œå–„ç®€å†èµ„æ–™',
                                        description: 'å®Œå–„æ‚¨çš„ç®€å†èµ„æ–™ï¼Œæé«˜åŒ¹é…ç²¾å‡†åº¦',
                                        priority: 'HIGH',
                                        source: 'AGENT',
                                        todo_type: 'CANDIDATE',
                                        icon: 'FileText',
                                        user_id: userId,
                                      };
                                    } else if (part.taskType === 'personal_verification') {
                                      taskData = {
                                        title: 'å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯',
                                        description: 'å®Œæˆèº«ä»½è®¤è¯ã€å­¦å†è®¤è¯ç­‰ï¼Œæå‡æ±‚èŒç«äº‰åŠ›',
                                        priority: 'HIGH',
                                        source: 'AGENT',
                                        todo_type: 'CANDIDATE',
                                        icon: 'Shield',
                                        user_id: userId,
                                      };
                                    } else if (part.taskType === 'enterprise_profile') {
                                      taskData = {
                                        title: 'å®Œå–„ä¼ä¸šèµ„æ–™',
                                        description: 'å®Œå–„ä¼ä¸šåŸºæœ¬ä¿¡æ¯ã€è”ç³»æ–¹å¼ã€ä¼ä¸šä»‹ç»ç­‰ï¼Œæå‡æ‹›è˜æ•ˆæœ',
                                        priority: 'MEDIUM',
                                        source: 'AGENT',
                                        todo_type: 'EMPLOYER',
                                        icon: 'FileText',
                                        user_id: userId,
                                      };
                                    } else if (part.taskType === 'cloud_job') {
                                      // äº‘ç«¯æ±‚èŒè½®å·¡ä»»åŠ¡ â€” è‡ªåŠ¨åˆ›å»º
                                      const shortId = String(Date.now()).slice(-6);
                                      taskData = {
                                        title: part.title || `äº‘ç«¯æ±‚èŒè½®å·¡ #${shortId}`,
                                        description: 'Devnors 1.0 Ultra - 30å¤©åœ¨çº¿è½®å·¡æŠ•é€’',
                                        priority: 'HIGH',
                                        source: 'AGENT',
                                        todo_type: 'CANDIDATE',
                                        icon: 'Rocket',
                                        user_id: userId,
                                      };
                                    }
                                    
                                    if (taskData) {
                                      console.log('[TaskCard] åˆ›å»ºä»»åŠ¡:', taskData.title);
                                      const newTask = await createTodo(taskData, userId);
                                      console.log('[TaskCard] åˆ›å»ºä»»åŠ¡æˆåŠŸ:', newTask);
                                      
                                      // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                                      if (typeof refetchTasks === 'function') {
                                        await refetchTasks();
                                      }
                                      
                                      // é‡æ–°è·å–ä»»åŠ¡åˆ—è¡¨ä»¥æ‰¾åˆ°æ–°åˆ›å»ºçš„ä»»åŠ¡
                                      const updatedTasks = await getTasks(userId);
                                      targetTask = updatedTasks.find((t: any) => 
                                        t.title === taskData.title || t.title?.includes('äº‘ç«¯æ±‚èŒè½®å·¡')
                                      );
                                    }
                                  }
                                  
                                  if (targetTask) {
                                    console.log('[TaskCard] é€‰ä¸­ä»»åŠ¡:', targetTask.title);
                                    setSelectedTask(targetTask);
                                  } else {
                                    console.warn('[TaskCard] æœªæ‰¾åˆ°ä»»åŠ¡ï¼Œå°è¯•åˆ·æ–°åˆ—è¡¨');
                                    if (typeof refetchTasks === 'function') {
                                      await refetchTasks();
                                    }
                                  }
                                } catch (error) {
                                  console.error('[TaskCard] å¤„ç†ä»»åŠ¡ç‚¹å‡»å¤±è´¥:', error);
                                }
                              };
                              
                              return (
                                <div 
                                  key={partIdx}
                                  onClick={handleTaskClick}
                                  className="my-3 p-3 bg-slate-50/80 rounded-2xl border border-slate-100 cursor-pointer hover:shadow-sm hover:border-indigo-200/60 transition-all group"
                                >
                                  <div className="flex items-center gap-3">
                                    <div className="w-9 h-9 rounded-xl bg-indigo-50 flex items-center justify-center text-base border border-indigo-100/60 group-hover:scale-105 transition-transform">
                                      {part.icon}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                      <div className="font-semibold text-slate-800 text-[15px] group-hover:text-indigo-700 transition-colors">{part.title}</div>
                                      <div className="text-xs text-slate-500 mt-0.5">ç‚¹å‡»å¼€å§‹ä»»åŠ¡</div>
                                    </div>
                                    <ArrowRight size={16} className="text-slate-400 group-hover:text-indigo-600 group-hover:translate-x-1 transition-all" />
                                  </div>
                                </div>
                              );
                            } else if (part.type === 'link') {
                              // æ¸²æŸ“é“¾æ¥å¡ç‰‡
                              return (
                                <Link 
                                  key={partIdx}
                                  to={part.path}
                                  className="block my-3 p-3 bg-slate-50/80 rounded-2xl border border-slate-100 cursor-pointer hover:shadow-sm hover:border-emerald-200/60 transition-all group no-underline"
                                >
                                  <div className="flex items-center gap-3">
                                    <div className="w-9 h-9 rounded-xl bg-emerald-50 flex items-center justify-center text-base border border-emerald-100/60 group-hover:scale-105 transition-transform">
                                      {part.icon}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                      <div className="font-semibold text-slate-800 text-[15px] group-hover:text-emerald-700 transition-colors">{part.title}</div>
                                      <div className="text-xs text-slate-500 mt-0.5">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                                    </div>
                                    <ExternalLink size={16} className="text-slate-400 group-hover:text-emerald-600 group-hover:translate-x-1 transition-all" />
                                  </div>
                                </Link>
                              );
                            } else if (part.type === 'action') {
                              // æ¸²æŸ“å¿«æ·æ“ä½œæŒ‰é’®ï¼ˆä¸€ç»„ACTIONè¿ç»­æ¸²æŸ“ä¸ºæŒ‰é’®ç»„ï¼‰
                              const isFirstInGroup = partIdx === 0 || typeof parts[partIdx - 1] !== 'object' || (parts[partIdx - 1] as any).type !== 'action';
                              
                              if (!isFirstInGroup) return null; // éé¦–ä¸ªæŒ‰é’®ï¼Œå·²åœ¨é¦–ä¸ªä¸­æ¸²æŸ“
                              
                              // æ”¶é›†è¿ç»­çš„ ACTION
                              const actionGroup: { label: string; message: string; style: string }[] = [];
                              for (let k = partIdx; k < parts.length; k++) {
                                const p = parts[k];
                                if (typeof p === 'object' && p.type === 'action') {
                                  actionGroup.push(p);
                                } else {
                                  break;
                                }
                              }
                              
                              const styleMap: Record<string, string> = {
                                'primary': 'bg-indigo-600 text-white hover:bg-indigo-700 border-indigo-600',
                                'success': 'bg-emerald-600 text-white hover:bg-emerald-700 border-emerald-600',
                                'warning': 'bg-amber-500 text-white hover:bg-amber-600 border-amber-500',
                                'secondary': 'bg-white text-slate-700 hover:bg-slate-50 border-slate-200',
                                'outline': 'bg-white text-indigo-600 hover:bg-indigo-50 border-indigo-200',
                              };
                              
                              return (
                                <div key={partIdx} className="flex flex-wrap gap-2 my-3">
                                  {actionGroup.map((action, actionIdx) => (
                                    <button
                                      key={actionIdx}
                                      onClick={() => {
                                        handleSend(action.message);
                                      }}
                                      className={`px-4 py-2 rounded-xl text-sm font-medium border transition-all active:scale-95 ${styleMap[action.style] || styleMap['secondary']}`}
                                    >
                                      {action.label}
                                    </button>
                                  ))}
                                </div>
                              );
                            } else if (part.type === 'thinking') {
                              // æ¸²æŸ“æ€è€ƒè¿‡ç¨‹æŠ˜å å—
                              return <ThinkingBlock key={partIdx} content={part.content} />;
                            } else {
                              return null;
                            }
                          });
                        })()}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            ))}
            {isTyping && (
              <div className="flex gap-3 animate-in fade-in">
                <div className="w-7 h-7 rounded-full bg-slate-100 flex items-center justify-center">
                  <Loader2 className="animate-spin text-indigo-600" size={13} />
                </div>
                <div className="px-4 py-3 bg-slate-50/80 rounded-2xl rounded-tl-md border border-slate-100">
                  <span className="text-slate-500 text-xs">æ­£åœ¨æ€è€ƒä¸­...</span>
                </div>
              </div>
            )}
          </div>
          
          {/* è¾“å…¥åŒºåŸŸ */}
          <div className="p-3 md:p-4 bg-white border-t border-slate-100">
            <div className="flex gap-1.5 md:gap-2 bg-slate-50/80 rounded-2xl p-2 md:p-2.5 border border-slate-200/60">
              {/* éšè—çš„æ–‡ä»¶ä¸Šä¼  input */}
              <input
                ref={fileInputRef}
                type="file"
                accept=".pdf,.doc,.docx,.txt,.md"
                onChange={handleFileUpload}
                className="hidden"
              />
              {/* éšè—çš„è¯ä»¶å›¾ç‰‡ä¸Šä¼  input */}
              <input
                ref={certImageInputRef}
                type="file"
                accept="image/jpeg,image/png,image/jpg"
                onChange={handleCertImageUpload}
                className="hidden"
              />
              {/* ä¸Šä¼ æŒ‰é’® - æ ¹æ®ä»»åŠ¡ç±»å‹æ˜¾ç¤ºä¸åŒå†…å®¹ */}
              {(() => {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸ªäººè®¤è¯ä»»åŠ¡ä¸”å½“å‰é¡¹éœ€è¦å›¾ç‰‡
                const isVerificationUpload = verificationMode.active && verificationMode.items[verificationMode.currentIndex]?.needsImage;
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä¼ä¸šè®¤è¯ä»»åŠ¡ä¸”å½“å‰é¡¹éœ€è¦å›¾ç‰‡
                const isEnterpriseVerificationUpload = enterpriseVerificationMode.active && enterpriseVerificationItems[enterpriseVerificationMode.currentIndex]?.needsImage;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å®Œå–„ç®€å†ä»»åŠ¡
                const taskTitle = selectedTask?.title || selectedTask?.task || '';
                const taskType = selectedTask?.todo_type || selectedTask?.type || '';
                const isProfileTask = taskType === 'profile_complete' || 
                  taskTitle === 'å®Œå–„ç®€å†èµ„æ–™';
                
                if (isVerificationUpload || isEnterpriseVerificationUpload) {
                  // è®¤è¯ä»»åŠ¡ï¼šæ˜¾ç¤º"ä¸Šä¼ è¯ä»¶"æŒ‰é’®
                  return (
                    <button
                      onClick={() => certImageInputRef.current?.click()}
                      disabled={uploadingCertImage || isTyping}
                      className="p-2 text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-lg transition-all disabled:opacity-50 flex items-center gap-1"
                      title="ä¸Šä¼ è¯ä»¶å›¾ç‰‡"
                    >
                      {uploadingCertImage ? (
                        <Loader2 size={18} className="animate-spin" />
                      ) : (
                        <Camera size={18} />
                      )}
                      <span className="hidden sm:inline text-sm font-medium">ä¸Šä¼ è¯ä»¶</span>
                    </button>
                  );
                } else if (isProfileTask) {
                  // å®Œå–„ç®€å†ä»»åŠ¡ï¼šæ˜¾ç¤º"ä¸Šä¼ ç®€å†"æŒ‰é’®
                  return (
                    <button
                      onClick={() => fileInputRef.current?.click()}
                      disabled={uploadingFile || isTyping}
                      className="p-2 text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-lg transition-all disabled:opacity-50 flex items-center gap-1"
                      title="ä¸Šä¼ ç®€å†æ–‡ä»¶ (PDF/Word/TXT)"
                    >
                      {uploadingFile ? (
                        <Loader2 size={18} className="animate-spin" />
                      ) : (
                        <Upload size={18} />
                      )}
                      <span className="hidden sm:inline text-sm font-medium">ä¸Šä¼ ç®€å†</span>
                    </button>
                  );
                } else {
                  // å…¶ä»–æƒ…å†µï¼šåªæ˜¾ç¤ºé™„ä»¶å›¾æ ‡
                  return (
                    <button
                      onClick={() => fileInputRef.current?.click()}
                      disabled={uploadingFile || isTyping}
                      className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all disabled:opacity-50"
                      title="ä¸Šä¼ é™„ä»¶"
                    >
                      {uploadingFile ? (
                        <Loader2 size={18} className="animate-spin" />
                      ) : (
                        <Paperclip size={18} />
                      )}
                    </button>
                  );
                }
              })()}
              <input
                type="text"
                value={inputMessage}
                onChange={(e) => setInputMessage(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                placeholder={selectedTask ? "è¾“å…¥æŒ‡ä»¤æ‰§è¡Œä»»åŠ¡..." : "è¾“å…¥æ‚¨çš„é—®é¢˜..."}
                className="flex-1 bg-transparent border-none rounded-lg px-3 py-2.5 text-base text-slate-900 focus:outline-none placeholder:text-slate-400"
              />
              <button
                onClick={handleSend}
                disabled={isTyping}
                data-send-btn
                className="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-2 md:px-4 rounded-xl flex items-center gap-1 md:gap-1.5 transition-all active:scale-95 disabled:opacity-50 font-medium text-xs md:text-sm flex-shrink-0"
              >
                <Send size={14} /> <span className="hidden sm:inline">å‘é€</span>
              </button>
            </div>
            {/* æ ¹æ®ä»»åŠ¡ç±»å‹æˆ–æ¨¡å¼æ˜¾ç¤ºç›¸å…³æç¤º */}
            {(() => {
              // è·å–å½“å‰ä»»åŠ¡ç›¸å…³çš„æç¤º
              const getTaskPrompts = (): {label: string; prompt: string; autoSend?: boolean}[] => {
                // æ£€æŸ¥æ˜¯å¦å¤„äºä¸ªäººè®¤è¯æ¨¡å¼
                if (verificationMode.active) {
                  const currentItem = verificationMode.items[verificationMode.currentIndex];
                  const isIdentityItem = currentItem?.key === 'identity_front' || currentItem?.key === 'identity_back';
                  
                  // èº«ä»½è®¤è¯é˜¶æ®µ - ä¸èƒ½è·³è¿‡
                  if (isIdentityItem) {
                    return []; // èº«ä»½è®¤è¯å¿…é¡»å®Œæˆï¼Œä¸æä¾›è·³è¿‡é€‰é¡¹
                  }
                  
                  // å…¶ä»–è®¤è¯é¡¹ - æ˜¾ç¤ºè·³è¿‡æŒ‰é’®
                  return [
                    { label: "â­ï¸ è·³è¿‡æ­¤é¡¹", prompt: "è·³è¿‡", autoSend: true }
                  ];
                }
                
                // æ£€æŸ¥æ˜¯å¦å¤„äºDISCæµ‹è¯•æ¨¡å¼
                if (discTestMode.active) {
                  if (discTestMode.completed) {
                    // æµ‹è¯•å·²å®Œæˆï¼Œæ˜¾ç¤ºé‡æ–°æµ‹è¯•æŒ‰é’®
                    return [
                      { label: "ğŸ”„ é‡æ–°æµ‹è¯•", prompt: "é‡æ–°æµ‹è¯•", autoSend: true }
                    ];
                  } else if (discTestMode.currentQuestion === 0) {
                    return [
                      { label: "ğŸš€ å¼€å§‹æµ‹è¯•", prompt: "å¼€å§‹æµ‹è¯•", autoSend: true }
                    ];
                  } else {
                    // ç­”é¢˜é˜¶æ®µï¼Œæ˜¾ç¤ºABCDé€‰é¡¹
                    return [
                      { label: "A", prompt: "A", autoSend: true },
                      { label: "B", prompt: "B", autoSend: true },
                      { label: "C", prompt: "C", autoSend: true },
                      { label: "D", prompt: "D", autoSend: true }
                    ];
                  }
                }
                
                // æ£€æŸ¥æ˜¯å¦å¤„äºæ±‚èŒåå¥½æ¨¡å¼
                if (jobSearchMode.active) {
                  if (jobSearchMode.completed) {
                    if (jobSearchMode.isSearching) {
                      return []; // AIæ­£åœ¨è‡ªåŠ¨å¤„ç†ä¸­ï¼Œä¸æ˜¾ç¤ºæŒ‰é’®
                    }
                    // äº‘ç«¯è½®å·¡ä»»åŠ¡å·²åˆ›å»ºï¼Œæ˜¾ç¤ºåç»­æ“ä½œæŒ‰é’®
                    return [
                      { label: "ğŸ“‹ æŸ¥çœ‹æŠ•é€’", prompt: "æŸ¥çœ‹æŠ•é€’", autoSend: true },
                      { label: "â¸ï¸ æš‚åœè½®å·¡", prompt: "æš‚åœè½®å·¡", autoSend: true },
                      { label: "âœï¸ ä¿®æ”¹åå¥½", prompt: "ä¿®æ”¹åå¥½", autoSend: true }
                    ];
                  } else if (jobSearchMode.currentQuestion === 0) {
                    return [
                      { label: "ğŸš€ å¼€å§‹", prompt: "å¼€å§‹", autoSend: true },
                      { label: "âœï¸ ä¿®æ”¹åå¥½", prompt: "ä¿®æ”¹åå¥½", autoSend: true }
                    ];
                  } else {
                    // ç­”é¢˜é˜¶æ®µï¼Œæ˜¾ç¤ºABCDé€‰é¡¹
                    return [
                      { label: "A", prompt: "A", autoSend: true },
                      { label: "B", prompt: "B", autoSend: true },
                      { label: "C", prompt: "C", autoSend: true },
                      { label: "D", prompt: "D", autoSend: true }
                    ];
                  }
                }
                
                // æ£€æŸ¥æ˜¯å¦å¤„äºå®Œå–„ç®€å†æ¨¡å¼
                if (profileCompleteMode.active) {
                  const currentField = profileCompleteMode.missingFields[profileCompleteMode.currentFieldIndex];
                  if (currentField) {
                    // æ ¹æ®å½“å‰å­—æ®µæ˜¾ç¤ºå¯ç›´æ¥ä½¿ç”¨çš„ç¤ºä¾‹å€¼
                    const fieldPrompts: Record<string, {label: string; prompt: string; autoSend?: boolean}[]> = {
                      'display_name': [
                        { label: "â­ï¸ è·³è¿‡æ­¤é¡¹", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'title': [
                        { label: "å‰ç«¯å·¥ç¨‹å¸ˆ", prompt: "é«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆ", autoSend: true },
                        { label: "åç«¯å·¥ç¨‹å¸ˆ", prompt: "èµ„æ·±åç«¯å·¥ç¨‹å¸ˆ", autoSend: true },
                        { label: "äº§å“ç»ç†", prompt: "äº§å“ç»ç†", autoSend: true },
                        { label: "â­ï¸ è·³è¿‡", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'summary': [
                        { label: "â­ï¸ è·³è¿‡æ­¤é¡¹", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'skills': [
                        { label: "å‰ç«¯æŠ€èƒ½", prompt: "React, TypeScript, Vue, Node.js, CSS", autoSend: true },
                        { label: "åç«¯æŠ€èƒ½", prompt: "Python, Java, Go, MySQL, Redis", autoSend: true },
                        { label: "å…¨æ ˆæŠ€èƒ½", prompt: "React, Node.js, Python, MySQL, Docker", autoSend: true },
                        { label: "â­ï¸ è·³è¿‡", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'experience': [
                        { label: "â­ï¸ è·³è¿‡æ­¤é¡¹", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'education': [
                        { label: "æœ¬ç§‘ç¤ºä¾‹", prompt: "åŒ—äº¬å¤§å­¦ | è®¡ç®—æœºç§‘å­¦ | æœ¬ç§‘ | 2020å¹´", autoSend: true },
                        { label: "ç¡•å£«ç¤ºä¾‹", prompt: "æ¸…åå¤§å­¦ | è½¯ä»¶å·¥ç¨‹ | ç¡•å£« | 2022å¹´", autoSend: true },
                        { label: "â­ï¸ è·³è¿‡", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'expected_salary': [
                        { label: "5K-10K", prompt: "5K-10K", autoSend: true },
                        { label: "10K-15K", prompt: "10K-15K", autoSend: true },
                        { label: "15K-20K", prompt: "15K-20K", autoSend: true },
                        { label: "20K-30K", prompt: "20K-30K", autoSend: true },
                        { label: "30Kä»¥ä¸Š", prompt: "30Kä»¥ä¸Š", autoSend: true },
                        { label: "é¢è®®", prompt: "é¢è®®", autoSend: true },
                        { label: "â­ï¸ è·³è¿‡", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'expected_location': [
                        { label: "åŒ—äº¬", prompt: "åŒ—äº¬", autoSend: true },
                        { label: "ä¸Šæµ·", prompt: "ä¸Šæµ·", autoSend: true },
                        { label: "æ·±åœ³", prompt: "æ·±åœ³", autoSend: true },
                        { label: "è¿œç¨‹", prompt: "è¿œç¨‹å‡å¯", autoSend: true },
                        { label: "â­ï¸ è·³è¿‡", prompt: "è·³è¿‡", autoSend: true },
                      ],
                    };
                    return fieldPrompts[currentField.key] || [{ label: "â­ï¸ è·³è¿‡æ­¤é¡¹", prompt: "è·³è¿‡", autoSend: true }];
                  }
                  return [];
                }
                
                // æ£€æŸ¥æ˜¯å¦å¤„äºå®Œå–„ä¼ä¸šèµ„æ–™æ¨¡å¼
                if (enterpriseProfileMode.active) {
                  const currentField = enterpriseProfileMode.missingFields[enterpriseProfileMode.currentFieldIndex];
                  if (currentField) {
                    const enterpriseFieldPrompts: Record<string, {label: string; prompt: string; autoSend?: boolean}[]> = {
                      'display_name': [
                        { label: "â­ï¸ è·³è¿‡æ­¤é¡¹", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'short_name': [
                        { label: "â­ï¸ è·³è¿‡æ­¤é¡¹", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'industry': [
                        { label: "äº’è”ç½‘/IT", prompt: "1", autoSend: true },
                        { label: "äººå·¥æ™ºèƒ½", prompt: "2", autoSend: true },
                        { label: "é‡‘è/æŠ•èµ„", prompt: "3", autoSend: true },
                        { label: "â­ï¸ è·³è¿‡", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'company_size': [
                        { label: "0-20äºº", prompt: "1", autoSend: true },
                        { label: "20-99äºº", prompt: "2", autoSend: true },
                        { label: "100-499äºº", prompt: "3", autoSend: true },
                        { label: "500+", prompt: "4", autoSend: true },
                        { label: "â­ï¸ è·³è¿‡", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'funding_stage': [
                        { label: "æœªèèµ„", prompt: "1", autoSend: true },
                        { label: "Aè½®", prompt: "3", autoSend: true },
                        { label: "å·²ä¸Šå¸‚", prompt: "6", autoSend: true },
                        { label: "ä¸éœ€è¦èèµ„", prompt: "7", autoSend: true },
                        { label: "â­ï¸ è·³è¿‡", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'detail_address': [
                        { label: "â­ï¸ è·³è¿‡æ­¤é¡¹", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'contact_name': [
                        { label: "â­ï¸ è·³è¿‡æ­¤é¡¹", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'hr_phone': [
                        { label: "â­ï¸ è·³è¿‡æ­¤é¡¹", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'description': [
                        { label: "â­ï¸ è·³è¿‡æ­¤é¡¹", prompt: "è·³è¿‡", autoSend: true },
                      ],
                      'benefits': [
                        { label: "å…¨é€‰", prompt: "1,2,3,4,5,6,7,8", autoSend: true },
                        { label: "åŸºç¡€ç¦åˆ©", prompt: "1,3,8", autoSend: true },
                        { label: "â­ï¸ è·³è¿‡", prompt: "è·³è¿‡", autoSend: true },
                      ],
                    };
                    return enterpriseFieldPrompts[currentField.key] || [{ label: "â­ï¸ è·³è¿‡æ­¤é¡¹", prompt: "è·³è¿‡", autoSend: true }];
                  }
                  return [];
                }
                
                // æ‹›è˜æµç¨‹å„é˜¶æ®µåº•éƒ¨æŒ‰é’®ï¼ˆpostMode æ¿€æ´»æ—¶ä¼˜å…ˆï¼‰
                if (postMode.active) {
                  if (postMode.step === 'optimize') {
                    return [
                      { label: "âœ… ç¡®è®¤å‘å¸ƒ", prompt: "ç¡®è®¤å‘å¸ƒ", autoSend: true },
                    ];
                  }
                  if (postMode.step === 'requirement') {
                    return [
                      { label: "ğŸ’¡ æ‹›å‰ç«¯", prompt: "æ‹›ä¸€ä¸ªå‰ç«¯å·¥ç¨‹å¸ˆ", autoSend: true },
                      { label: "ğŸ’¡ æ‹›åç«¯", prompt: "æ‹›ä¸€ä¸ªåç«¯å·¥ç¨‹å¸ˆ", autoSend: true },
                      { label: "ğŸ’¡ æ‹›äº§å“ç»ç†", prompt: "æ‹›ä¸€ä¸ªäº§å“ç»ç†", autoSend: true },
                    ];
                  }
                  if (postMode.step === 'invite') {
                    return [
                      { label: "â˜ï¸ å¼€å§‹æ™ºèƒ½é‚€è¯·", prompt: "å¼€å§‹æ™ºèƒ½é‚€è¯·", autoSend: true },
                      { label: "â­ï¸ è·³åˆ°ç­›é€‰", prompt: "å¼€å§‹æ™ºèƒ½ç­›é€‰", autoSend: true },
                    ];
                  }
                  if (postMode.step === 'screen') {
                    return [
                      { label: "â˜ï¸ å¼€å§‹æ™ºèƒ½ç­›é€‰", prompt: "å¼€å§‹æ™ºèƒ½ç­›é€‰", autoSend: true },
                    ];
                  }
                  if (postMode.step === 'complete') {
                    return [
                      { label: "ğŸš€ ç»§ç»­æ‹›è˜å…¶ä»–å²—ä½", prompt: "ç»§ç»­æ‹›è˜", autoSend: true },
                    ];
                  }
                }
                
                // éä»»åŠ¡æ¨¡å¼ â€” é€šç”¨ AI åŠ©æ‰‹
                if (!selectedTask) {
                  if (userRole === 'candidate') {
                    return [
                      { label: "ğŸš€ æ‰¾å·¥ä½œ", prompt: "æ‰¾å·¥ä½œ", autoSend: true },
                      { label: "âœï¸ ä¿®æ”¹åå¥½", prompt: "ä¿®æ”¹åå¥½", autoSend: true },
                    ];
                  }
                  if ((userRole === 'employer' || userRole === 'recruiter') && recruitReady) {
                    return [
                      { label: "ğŸš€ å¼€å§‹æ‹›è˜", prompt: "å¼€å§‹æ‹›è˜", autoSend: true },
                    ];
                  }
                  return [];
                }
                
                // ========== ä»»åŠ¡æ¨¡å¼ â€” æ ¹æ®ä»»åŠ¡ç±»å‹ + è¿›åº¦çŠ¶æ€åŠ¨æ€å˜åŒ– ==========
                const taskTitle = selectedTask.title || selectedTask.task || '';
                const taskType = (selectedTask.todo_type || selectedTask.type || '').toUpperCase();
                const taskStatus = (selectedTask.status || '').toUpperCase();
                const isCompleted = taskStatus === 'COMPLETED';
                
                // å·²å®Œæˆçš„ä»»åŠ¡
                if (isCompleted) {
                  return [];
                }
                
                // === æ‹›è˜ä»»åŠ¡ï¼ˆRECRUITï¼‰===
                if (taskType === 'RECRUIT' || taskTitle.includes('æ™ºèƒ½æ‹›è˜')) {
                  // ä» metadata è·å–åç«¯ä¿å­˜çš„é˜¶æ®µ
                  const stepsMetadata = selectedTask.steps?.metadata || {};
                  const savedStep = stepsMetadata.current_step || '';
                  
                  // postMode æœªæ¿€æ´»æ—¶ï¼Œæ ¹æ®åç«¯ä¿å­˜çš„é˜¶æ®µæ¨æ–­
                  if (!postMode.active) {
                    if (savedStep === 'complete') {
                      return [{ label: "ğŸš€ ç»§ç»­æ‹›è˜å…¶ä»–å²—ä½", prompt: "ç»§ç»­æ‹›è˜", autoSend: true }];
                    }
                    if (savedStep === 'screen') {
                      return [{ label: "â˜ï¸ å¼€å§‹æ™ºèƒ½ç­›é€‰", prompt: "å¼€å§‹æ™ºèƒ½ç­›é€‰", autoSend: true }];
                    }
                    if (savedStep === 'invite') {
                      return [
                        { label: "â˜ï¸ å¼€å§‹æ™ºèƒ½é‚€è¯·", prompt: "å¼€å§‹æ™ºèƒ½é‚€è¯·", autoSend: true },
                        { label: "â­ï¸ è·³åˆ°ç­›é€‰", prompt: "å¼€å§‹æ™ºèƒ½ç­›é€‰", autoSend: true },
                      ];
                    }
                    if (savedStep === 'optimize') {
                      return [{ label: "âœ… ç¡®è®¤å‘å¸ƒ", prompt: "ç¡®è®¤å‘å¸ƒ", autoSend: true }];
                    }
                    // é»˜è®¤ï¼šè¿˜æœªå¼€å§‹æˆ–åœ¨éœ€æ±‚é˜¶æ®µ
                    return [
                      { label: "ğŸ’¡ æ‹›å‰ç«¯", prompt: "æ‹›ä¸€ä¸ªå‰ç«¯å·¥ç¨‹å¸ˆ", autoSend: true },
                      { label: "ğŸ’¡ æ‹›åç«¯", prompt: "æ‹›ä¸€ä¸ªåç«¯å·¥ç¨‹å¸ˆ", autoSend: true },
                      { label: "ğŸ’¡ æ‹›äº§å“ç»ç†", prompt: "æ‹›ä¸€ä¸ªäº§å“ç»ç†", autoSend: true },
                    ];
                  }
                  return [];
                }
                
                // === å®Œå–„ç®€å†ä»»åŠ¡ ===
                if (taskType === 'PROFILE_COMPLETE' || taskType === 'CANDIDATE' && taskTitle === 'å®Œå–„ç®€å†èµ„æ–™' || taskTitle === 'å®Œå–„ç®€å†èµ„æ–™') {
                  return [
                    { label: "ğŸ“ å¼€å§‹å¡«å†™ç®€å†", prompt: "å¼€å§‹å¡«å†™ç®€å†", autoSend: true },
                  ];
                }
                
                // === å®Œå–„ä¼ä¸šèµ„æ–™ä»»åŠ¡ ===
                if (taskType === 'ENTERPRISE_PROFILE' || taskTitle === 'å®Œå–„ä¼ä¸šèµ„æ–™') {
                  return [
                    { label: "ğŸ“‹ å¼€å§‹å®Œå–„", prompt: "å¼€å§‹å®Œå–„ä¼ä¸šèµ„æ–™", autoSend: true },
                  ];
                }
                
                // === ä¸ªäººè®¤è¯ä»»åŠ¡ ===
                if (taskType === 'PERSONAL_VERIFICATION' || 
                    taskTitle === 'å®Œå–„ä¸ªäººè®¤è¯ä¿¡æ¯' ||
                    (taskTitle.includes('è®¤è¯') && taskTitle.includes('ä¿¡æ¯') && !taskTitle.includes('ä¼ä¸š'))) {
                  return [
                    { label: "ğŸš€ å¼€å§‹è®¤è¯", prompt: "å¼€å§‹è®¤è¯", autoSend: true },
                  ];
                }
                
                // === ä¼ä¸šè®¤è¯ä»»åŠ¡ ===
                if (taskType === 'ENTERPRISE_VERIFICATION' || 
                    taskType === 'EMPLOYER' ||
                    taskTitle === 'å®Œæˆä¼ä¸šè®¤è¯' ||
                    (taskTitle.includes('ä¼ä¸š') && taskTitle.includes('è®¤è¯'))) {
                  if (enterpriseVerificationMode.active) {
                    const currentItem = enterpriseVerificationItems[enterpriseVerificationMode.currentIndex];
                    if (currentItem?.required) {
                      return [
                        { label: "ğŸ“· ä¸Šä¼ è¯ä»¶", prompt: "ä¸Šä¼ è¯ä»¶", autoSend: false },
                      ];
                    }
                    return [
                      { label: "ğŸ“· ä¸Šä¼ è¯ä»¶", prompt: "ä¸Šä¼ è¯ä»¶", autoSend: false },
                      { label: "â­ï¸ è·³è¿‡", prompt: "è·³è¿‡", autoSend: true },
                    ];
                  }
                  return [
                    { label: "ğŸš€ å¼€å§‹è®¤è¯", prompt: "å¼€å§‹è®¤è¯", autoSend: true },
                  ];
                }
                
                // === äº‘ç«¯æ±‚èŒè½®å·¡ä»»åŠ¡ ===
                if (taskType === 'CANDIDATE' && taskTitle.includes('äº‘ç«¯æ±‚èŒè½®å·¡')) {
                  return [
                    { label: "ğŸ“‹ æŸ¥çœ‹æŠ•é€’", prompt: "æŸ¥çœ‹æŠ•é€’è¿›åº¦", autoSend: true },
                    { label: "â¸ï¸ æš‚åœè½®å·¡", prompt: "æš‚åœè½®å·¡", autoSend: true },
                  ];
                }
                
                // === é¢è¯•å‡†å¤‡ä»»åŠ¡ ===
                if (taskTitle.includes('é¢è¯•')) {
                  return [
                    { label: "â“ å¸¸è§é—®é¢˜", prompt: "åˆ—ä¸¾è¿™ä¸ªèŒä½çš„å¸¸è§é¢è¯•é—®é¢˜", autoSend: true },
                    { label: "ğŸ‘‹ è‡ªæˆ‘ä»‹ç»", prompt: "å¸®æˆ‘å‡†å¤‡è‡ªæˆ‘ä»‹ç»", autoSend: true },
                    { label: "ğŸ¤ æ¨¡æ‹Ÿé¢è¯•", prompt: "å¼€å§‹æ¨¡æ‹Ÿé¢è¯•", autoSend: true },
                  ];
                }
                
                // === èŒä½æ¨èä»»åŠ¡ ===
                if (taskTitle.includes('èŒä½') || taskTitle.includes('æ¨è')) {
                  return [
                    { label: "ğŸ“‹ æŸ¥çœ‹æ¨è", prompt: "æŸ¥çœ‹ä¸ºæˆ‘æ¨èçš„èŒä½", autoSend: true },
                    { label: "âœï¸ è°ƒæ•´åå¥½", prompt: "æˆ‘æƒ³è°ƒæ•´èŒä½åå¥½", autoSend: true },
                  ];
                }
                
                // === äººæ‰ç­›é€‰ä»»åŠ¡ ===
                if (taskTitle.includes('å€™é€‰äºº') || taskTitle.includes('ç­›é€‰') || taskTitle.includes('äººæ‰')) {
                  return [
                    { label: "ğŸ‘¤ æŸ¥çœ‹å€™é€‰äºº", prompt: "æŸ¥çœ‹åŒ¹é…çš„å€™é€‰äºº", autoSend: true },
                    { label: "ğŸ”§ è°ƒæ•´æ¡ä»¶", prompt: "è°ƒæ•´ç­›é€‰æ¡ä»¶", autoSend: true },
                  ];
                }
                
                // å…¶ä»–ä»»åŠ¡ - ä¸æ˜¾ç¤ºæç¤º
                return [];
              };
              
              const prompts = getTaskPrompts();
              
              // å¦‚æœæ²¡æœ‰æç¤ºï¼Œä¸æ¸²æŸ“è¿™ä¸ªåŒºåŸŸ
              if (prompts.length === 0) return null;
              
              return (
                <div className="mt-2.5 flex flex-wrap gap-2">
                  {prompts.map((item, sIdx) => (
                    <button 
                      key={sIdx}
                      onClick={() => {
                        if (item.autoSend) {
                          // è‡ªåŠ¨å‘é€ï¼šç›´æ¥è°ƒç”¨ handleSend
                          handleSend(item.prompt);
                        } else {
                          setInputMessage(item.prompt);
                        }
                      }}
                      className="px-3 py-1.5 bg-slate-50/80 hover:bg-indigo-50 text-xs font-medium text-slate-600 border border-slate-200/60 rounded-full transition-colors hover:border-indigo-200 hover:text-indigo-600"
                    >
                      {item.label}
                    </button>
                  ))}
                </div>
              );
            })()}
          </div>
        </div>
        </div>
      </div>
      
      {/* ç¡®è®¤å¼¹çª— */}
      {confirmDialog.show && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setConfirmDialog(prev => ({ ...prev, show: false }))} />
          <div className="relative bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full mx-4 animate-in fade-in zoom-in-95 duration-200">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center flex-shrink-0">
                <AlertTriangle size={20} className="text-red-500" />
              </div>
              <h3 className="text-base font-bold text-slate-900">{confirmDialog.title}</h3>
            </div>
            <p className="text-sm text-slate-600 leading-relaxed mb-6">{confirmDialog.message}</p>
            <div className="flex gap-3 justify-end">
              <button
                onClick={() => setConfirmDialog(prev => ({ ...prev, show: false }))}
                className="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors"
              >
                å–æ¶ˆ
              </button>
              <button
                onClick={confirmDialog.onConfirm}
                className="px-4 py-2 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-lg transition-colors"
              >
                ç¡®è®¤æ¸…é™¤
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// --- æ±‚èŒç”³è¯·ä»»åŠ¡è¯¦æƒ…é¡µ (ApplyDetailView) - é‡å®šå‘åˆ° AI åŠ©æ‰‹ ---
const ApplyDetailView = () => {
  const navigate = useNavigate();
  
  useEffect(() => {
    // é‡å®šå‘åˆ° AI åŠ©æ‰‹é¡µé¢å¹¶å¯åŠ¨æ±‚èŒç”³è¯·ä»»åŠ¡
    navigate('/ai-assistant?taskType=apply', { replace: true });
  }, [navigate]);

  return (
    <div className="pt-20 text-center">
      <Loader2 className="mx-auto text-emerald-600 animate-spin mb-4" size={48} />
      <p className="text-slate-500">æ­£åœ¨è·³è½¬åˆ° AI åŠ©æ‰‹...</p>
    </div>
  );
};

// --- èŒä½ç®¡ç†é¡µ (JobManagementView) ---
const JobManagementView = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const userId = user?.id || 0;

  const [jobs, setJobs] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState<'all' | 'active' | 'closed' | 'draft'>('all');
  const [searchText, setSearchText] = useState('');
  const [deleteConfirm, setDeleteConfirm] = useState<number | null>(null);
  const [editingJob, setEditingJob] = useState<any | null>(null);
  const [editForm, setEditForm] = useState<any>({});
  const [saving, setSaving] = useState(false);
  const [toastMsg, setToastMsg] = useState('');

  const showToast = (msg: string) => {
    setToastMsg(msg);
    setTimeout(() => setToastMsg(''), 2500);
  };

  // åŠ è½½å²—ä½
  const fetchJobs = async () => {
    setLoading(true);
    try {
      const data = await getMyJobs(userId);
      setJobs(data || []);
    } catch (e) {
      console.error('åŠ è½½å²—ä½å¤±è´¥:', e);
      setJobs([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (userId) fetchJobs();
  }, [userId]);

  // è¿‡æ»¤
  const filteredJobs = jobs.filter(j => {
    if (filter !== 'all' && j.status !== filter) return false;
    if (searchText && !j.title?.toLowerCase().includes(searchText.toLowerCase()) && !j.company?.toLowerCase().includes(searchText.toLowerCase())) return false;
    return true;
  });

  // ç»Ÿè®¡
  const activeCount = jobs.filter(j => j.status === 'active').length;
  const closedCount = jobs.filter(j => j.status === 'closed').length;
  const totalViews = jobs.reduce((s, j) => s + (j.view_count || 0), 0);
  const totalApplies = jobs.reduce((s, j) => s + (j.apply_count || 0), 0);

  // åˆ é™¤
  const handleDelete = async (jobId: number) => {
    try {
      await deleteJob(jobId, userId);
      setJobs(prev => prev.filter(j => j.id !== jobId));
      setDeleteConfirm(null);
      showToast('å²—ä½å·²åˆ é™¤');
    } catch (e) {
      console.error('åˆ é™¤å¤±è´¥:', e);
      showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  };

  // åˆ‡æ¢çŠ¶æ€
  const handleToggleStatus = async (job: any) => {
    const newStatus = job.status === 'active' ? 'closed' : 'active';
    try {
      await updateJob(job.id, { status: newStatus, user_id: userId } as any);
      setJobs(prev => prev.map(j => j.id === job.id ? { ...j, status: newStatus } : j));
      showToast(newStatus === 'active' ? 'å²—ä½å·²ä¸Šçº¿' : 'å²—ä½å·²å…³é—­');
    } catch (e) {
      console.error('çŠ¶æ€æ›´æ–°å¤±è´¥:', e);
      showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  };

  // ç¼–è¾‘
  const openEdit = (job: any) => {
    setEditingJob(job);
    setEditForm({
      title: job.title || '',
      company: job.company || '',
      location: job.location || '',
      description: job.description || '',
      salary_min: job.salary_min || '',
      salary_max: job.salary_max || '',
      tags: (job.tags || []).join(', '),
    });
  };

  const handleSaveEdit = async () => {
    if (!editingJob) return;
    setSaving(true);
    try {
      const tagsList = editForm.tags ? editForm.tags.split(/[,ï¼Œ]/).map((t: string) => t.trim()).filter(Boolean) : [];
      await updateJob(editingJob.id, {
        title: editForm.title,
        company: editForm.company,
        location: editForm.location,
        description: editForm.description,
        salary_min: editForm.salary_min ? Number(editForm.salary_min) : undefined,
        salary_max: editForm.salary_max ? Number(editForm.salary_max) : undefined,
        tags: tagsList,
        user_id: userId,
      } as any);
      setJobs(prev => prev.map(j => j.id === editingJob.id ? {
        ...j,
        ...editForm,
        salary_min: editForm.salary_min ? Number(editForm.salary_min) : j.salary_min,
        salary_max: editForm.salary_max ? Number(editForm.salary_max) : j.salary_max,
        tags: tagsList,
      } : j));
      setEditingJob(null);
      showToast('å²—ä½ä¿¡æ¯å·²æ›´æ–°');
    } catch (e) {
      console.error('ä¿å­˜å¤±è´¥:', e);
      showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setSaving(false);
    }
  };

  const formatSalary = (min?: number, max?: number) => {
    if (!min && !max) return 'é¢è®®';
    if (min && max) return `${(min / 1000).toFixed(0)}k - ${(max / 1000).toFixed(0)}k`;
    if (min) return `${(min / 1000).toFixed(0)}k èµ·`;
    return `æœ€é«˜ ${((max || 0) / 1000).toFixed(0)}k`;
  };

  const statusLabel = (s: string) => {
    if (s === 'active') return { text: 'æ‹›è˜ä¸­', color: 'bg-emerald-100 text-emerald-700' };
    if (s === 'closed') return { text: 'å·²å…³é—­', color: 'bg-slate-100 text-slate-500' };
    if (s === 'draft') return { text: 'è‰ç¨¿', color: 'bg-amber-100 text-amber-700' };
    return { text: s, color: 'bg-slate-100 text-slate-500' };
  };

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-700">
      {/* é¡µé¢å¤´éƒ¨ */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
        <div>
          <h1 className="text-2xl md:text-4xl font-black text-slate-900 flex items-center gap-2 md:gap-4">
            <div className="p-3 bg-indigo-600 text-white rounded shadow-xl"><Briefcase size={32} /></div>
            èŒä½ç®¡ç†
          </h1>
          <p className="text-slate-500 font-medium mt-2">ç®¡ç†æ‚¨å‘å¸ƒçš„æ‰€æœ‰æ‹›è˜å²—ä½</p>
        </div>
        <button
          onClick={() => navigate('/ai-assistant?taskType=post')}
          className="bg-indigo-600 text-white px-8 py-3.5 rounded font-black text-sm flex items-center gap-2 shadow-xl shadow-indigo-200 active:scale-95 transition-all"
        >
          <Plus size={20} /> å‘å¸ƒèŒä½
        </button>
      </div>

      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
        <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
          <div className="flex items-center gap-3 mb-3">
            <Briefcase size={18} className="text-indigo-500" />
            <span className="text-xs font-black uppercase text-slate-400 tracking-wider">æ€»å²—ä½</span>
          </div>
          <div className="text-3xl font-black text-slate-900">{jobs.length}</div>
        </div>
        <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
          <div className="flex items-center gap-3 mb-3">
            <Play size={18} className="text-emerald-500" />
            <span className="text-xs font-black uppercase text-slate-400 tracking-wider">æ‹›è˜ä¸­</span>
          </div>
          <div className="text-3xl font-black text-emerald-600">{activeCount}</div>
        </div>
        <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
          <div className="flex items-center gap-3 mb-3">
            <Eye size={18} className="text-indigo-500" />
            <span className="text-xs font-black uppercase text-slate-400 tracking-wider">æ€»æµè§ˆ</span>
          </div>
          <div className="text-3xl font-black text-slate-900">{totalViews}</div>
        </div>
        <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-sm">
          <div className="flex items-center gap-3 mb-3">
            <Users size={18} className="text-indigo-500" />
            <span className="text-xs font-black uppercase text-slate-400 tracking-wider">æ€»æŠ•é€’</span>
          </div>
          <div className="text-3xl font-black text-slate-900">{totalApplies}</div>
        </div>
      </div>

      {/* æœç´¢å’Œè¿‡æ»¤æ  */}
      <div className="bg-white rounded-lg border border-slate-100 p-4 mb-6 flex flex-col md:flex-row gap-3 items-center shadow-sm">
        <div className="flex-1 relative w-full">
          <Search className="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
          <input
            value={searchText}
            onChange={(e) => setSearchText(e.target.value)}
            placeholder="æœç´¢å²—ä½åç§°æˆ–å…¬å¸..."
            className="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400 placeholder:text-slate-400"
          />
        </div>
        <div className="flex gap-2">
          {[
            { key: 'all' as const, label: 'å…¨éƒ¨', count: jobs.length },
            { key: 'active' as const, label: 'æ‹›è˜ä¸­', count: activeCount },
            { key: 'closed' as const, label: 'å·²å…³é—­', count: closedCount },
          ].map(f => (
            <button
              key={f.key}
              onClick={() => setFilter(f.key)}
              className={`px-4 py-2 rounded text-xs font-black transition-all ${
                filter === f.key
                  ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-100'
                  : 'text-slate-500 hover:bg-slate-50 border border-slate-200'
              }`}
            >
              {f.label} ({f.count})
            </button>
          ))}
        </div>
      </div>

      {/* åˆ—è¡¨ */}
      {loading ? (
        <div className="text-center py-20">
          <Loader2 className="mx-auto animate-spin text-indigo-600 mb-3" size={24} />
          <p className="text-sm text-slate-400">åŠ è½½ä¸­...</p>
        </div>
      ) : filteredJobs.length === 0 ? (
        <div className="text-center py-20 bg-white rounded-lg border border-slate-100 shadow-sm">
          <Briefcase className="mx-auto text-slate-300 mb-4" size={40} />
          <p className="text-slate-900 font-black mb-1">
            {jobs.length === 0 ? 'è¿˜æ²¡æœ‰å‘å¸ƒè¿‡å²—ä½' : 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å²—ä½'}
          </p>
          <p className="text-slate-500 text-sm mb-6 font-medium">
            {jobs.length === 0 ? 'é€šè¿‡ AI åŠ©æ‰‹ï¼Œä¸€å¥è¯å³å¯å‘å¸ƒæ‹›è˜å²—ä½' : 'å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶'}
          </p>
          {jobs.length === 0 && (
            <button
              onClick={() => navigate('/ai-assistant?taskType=post')}
              className="bg-indigo-600 text-white px-6 py-3 rounded font-black text-sm inline-flex items-center gap-2 shadow-xl shadow-indigo-200 active:scale-95 transition-all"
            >
              <Sparkles size={16} /> å¼€å§‹æ™ºèƒ½æ‹›è˜
            </button>
          )}
        </div>
      ) : (
        <div className="space-y-4">
          {filteredJobs.map((job) => {
            const st = statusLabel(job.status);
            return (
              <div 
                key={job.id} 
                onClick={() => navigate(`/employer/post/${job.id}`)}
                className="flex flex-col md:flex-row items-center justify-between p-6 bg-slate-50 rounded border border-slate-100 group hover:border-indigo-300 transition-all cursor-pointer"
              >
                <div className="flex items-center gap-5 w-full md:w-auto">
                  <div className={`w-14 h-14 flex items-center justify-center text-xl font-black rounded shadow-lg ring-4 transition-transform group-hover:scale-105 flex-shrink-0 ${
                    job.status === 'active' ? 'bg-indigo-600 text-white ring-indigo-50' : 'bg-slate-400 text-white ring-slate-100'
                  }`}>
                    <Briefcase size={24} />
                  </div>
                  <div>
                    <div className="text-base font-semibold text-slate-900">{job.title}</div>
                    <div className="text-sm text-slate-500 mt-0.5">{job.company} Â· {job.location}</div>
                    <div className="flex items-center gap-2 mt-2 flex-wrap">
                      <span className="text-xs font-medium text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">
                        {formatSalary(job.salary_min, job.salary_max)}
                      </span>
                      <span className={`text-xs font-medium px-2 py-0.5 rounded ${st.color}`}>{st.text}</span>
                      {job.tags && job.tags.slice(0, 3).map((tag: string) => (
                        <span key={tag} className="text-xs text-slate-500 bg-white px-2 py-0.5 rounded border border-slate-100">{tag}</span>
                      ))}
                      {job.tags && job.tags.length > 3 && <span className="text-xs text-slate-400">+{job.tags.length - 3}</span>}
                    </div>
                  </div>
                </div>
                <div className="flex items-center gap-6 mt-4 md:mt-0 w-full md:w-auto justify-between md:justify-end">
                  <div className="flex items-center gap-3">
                    <div className="text-center px-3 py-2 bg-white rounded-lg border border-slate-100 min-w-[60px]">
                      <div className="text-xl font-bold text-indigo-600">{job.view_count || 0}</div>
                      <div className="text-xs text-slate-400">æµè§ˆ</div>
                    </div>
                    <div className="text-center px-3 py-2 bg-white rounded-lg border border-slate-100 min-w-[60px]">
                      <div className="text-xl font-bold text-emerald-600">{job.apply_count || 0}</div>
                      <div className="text-xs text-slate-400">æŠ•é€’</div>
                    </div>
                  </div>
                  <div className="text-xs text-slate-400 text-right hidden md:block">
                    {job.created_at ? parseUTC(job.created_at).toLocaleDateString('zh-CN') : '-'}
                  </div>
                  <div className="flex items-center gap-1" onClick={e => e.stopPropagation()}>
                    <button onClick={() => openEdit(job)} className="p-2.5 bg-white text-slate-400 hover:text-indigo-600 rounded border border-slate-100 hover:border-indigo-200 transition-all" title="ç¼–è¾‘"><Edit3 size={16} /></button>
                    <button onClick={() => handleToggleStatus(job)} className={`p-2.5 bg-white rounded border border-slate-100 transition-all ${job.status === 'active' ? 'text-slate-400 hover:text-amber-600 hover:border-amber-200' : 'text-slate-400 hover:text-emerald-600 hover:border-emerald-200'}`} title={job.status === 'active' ? 'å…³é—­' : 'ä¸Šçº¿'}>{job.status === 'active' ? <Square size={16} /> : <Play size={16} />}</button>
                    <button onClick={() => setDeleteConfirm(job.id)} className="p-2.5 bg-white text-slate-400 hover:text-red-600 rounded border border-slate-100 hover:border-red-200 transition-all" title="åˆ é™¤"><Trash2 size={16} /></button>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* åˆ é™¤ç¡®è®¤å¼¹çª— */}
      {deleteConfirm !== null && (
        <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4" onClick={() => setDeleteConfirm(null)}>
          <div className="bg-white rounded-lg p-6 w-full max-w-sm shadow-2xl animate-in fade-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
            <h3 className="text-lg font-black text-slate-900 mb-2">ç¡®è®¤åˆ é™¤</h3>
            <p className="text-sm text-slate-500 mb-6">åˆ é™¤åå²—ä½ä¿¡æ¯å°†æ— æ³•æ¢å¤ï¼Œç¡®è®¤è¦åˆ é™¤è¿™ä¸ªå²—ä½å—ï¼Ÿ</p>
            <div className="flex gap-3">
              <button onClick={() => setDeleteConfirm(null)} className="flex-1 py-2.5 rounded border border-slate-200 text-sm font-black text-slate-600 hover:bg-slate-50 transition-colors">å–æ¶ˆ</button>
              <button onClick={() => handleDelete(deleteConfirm)} className="flex-1 py-2.5 rounded bg-red-600 text-white text-sm font-black hover:bg-red-700 transition-colors">ç¡®è®¤åˆ é™¤</button>
            </div>
          </div>
        </div>
      )}

      {/* ç¼–è¾‘å¼¹çª— */}
      {editingJob && (
        <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4" onClick={() => setEditingJob(null)}>
          <div className="bg-white rounded-xl w-full max-w-lg shadow-2xl max-h-[85vh] overflow-hidden animate-in fade-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
            <div className="px-6 pt-6 pb-4 border-b border-slate-100">
              <h3 className="text-lg font-black text-slate-900 flex items-center gap-2">
                <Edit3 size={18} className="text-indigo-600" /> ç¼–è¾‘å²—ä½
              </h3>
            </div>
            <div className="px-6 py-5 overflow-y-auto max-h-[60vh] space-y-4">
              <div>
                <label className="text-xs font-black text-slate-400 mb-1.5 block uppercase tracking-wider">å²—ä½åç§°</label>
                <input value={editForm.title} onChange={e => setEditForm({ ...editForm, title: e.target.value })} className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400" />
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="text-xs font-black text-slate-400 mb-1.5 block uppercase tracking-wider">å…¬å¸åç§°</label>
                  <input value={editForm.company} onChange={e => setEditForm({ ...editForm, company: e.target.value })} className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400" />
                </div>
                <div>
                  <label className="text-xs font-black text-slate-400 mb-1.5 block uppercase tracking-wider">å·¥ä½œåœ°ç‚¹</label>
                  <input value={editForm.location} onChange={e => setEditForm({ ...editForm, location: e.target.value })} className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400" />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="text-xs font-black text-slate-400 mb-1.5 block uppercase tracking-wider">æœ€ä½è–ªèµ„ï¼ˆå…ƒ/æœˆï¼‰</label>
                  <input type="number" value={editForm.salary_min} onChange={e => setEditForm({ ...editForm, salary_min: e.target.value })} placeholder="8000" className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400" />
                </div>
                <div>
                  <label className="text-xs font-black text-slate-400 mb-1.5 block uppercase tracking-wider">æœ€é«˜è–ªèµ„ï¼ˆå…ƒ/æœˆï¼‰</label>
                  <input type="number" value={editForm.salary_max} onChange={e => setEditForm({ ...editForm, salary_max: e.target.value })} placeholder="15000" className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400" />
                </div>
              </div>
              <div>
                <label className="text-xs font-black text-slate-400 mb-1.5 block uppercase tracking-wider">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                <input value={editForm.tags} onChange={e => setEditForm({ ...editForm, tags: e.target.value })} placeholder="React, Python, è¿œç¨‹" className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400" />
              </div>
              <div>
                <label className="text-xs font-black text-slate-400 mb-1.5 block uppercase tracking-wider">å²—ä½æè¿°</label>
                <textarea value={editForm.description} onChange={e => setEditForm({ ...editForm, description: e.target.value })} rows={5} className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400 resize-none" />
              </div>
            </div>
            <div className="px-6 py-4 border-t border-slate-100 flex gap-3">
              <button onClick={() => setEditingJob(null)} className="flex-1 py-2.5 rounded border border-slate-200 text-sm font-black text-slate-600 hover:bg-slate-50 transition-colors">å–æ¶ˆ</button>
              <button onClick={handleSaveEdit} disabled={saving} className="flex-1 py-2.5 rounded bg-indigo-600 text-white text-sm font-black hover:bg-indigo-700 transition-colors disabled:opacity-50 flex items-center justify-center gap-2">
                {saving ? <Loader2 size={16} className="animate-spin" /> : <Save size={16} />}
                {saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜ä¿®æ”¹'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Toast */}
      {toastMsg && (
        <div className="fixed top-16 right-3 md:top-24 md:right-6 z-[9999] px-4 py-2.5 md:px-5 md:py-3 rounded-xl shadow-2xl font-bold text-sm flex items-center gap-2 animate-in slide-in-from-right duration-300 bg-emerald-500 text-white">
          <CheckCircle2 size={18} /> {toastMsg}
        </div>
      )}
    </div>
  );
};
// --- ä¼ä¸šå²—ä½æ¨èåˆ—è¡¨é¡µ (JobRecommendListView) ---
const JobRecommendListView = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const userId = user?.id || 0;

  // AI æŠ•é€’çŠ¶æ€
  const [applyingId, setApplyingId] = useState<number | null>(null);
  const [appliedIds, setAppliedIds] = useState<Set<number>>(new Set());
  const [applyDetails, setApplyDetails] = useState<Record<number, any>>({});
  const [applyResult, setApplyResult] = useState<any>(null);

  // é¡µé¢åŠ è½½æ—¶è·å–å·²æŠ•é€’çš„å²—ä½
  useEffect(() => {
    if (!userId) return;
    fetch(`/api/v1/public/my-applies?user_id=${userId}`)
      .then(r => r.ok ? r.json() : null)
      .then(data => {
        if (data?.success && data.applies) {
          const ids = new Set<number>();
          const details: Record<number, any> = {};
          Object.values(data.applies).forEach((a: any) => {
            ids.add(a.job_id);
            details[a.job_id] = a;
          });
          setAppliedIds(ids);
          setApplyDetails(details);
        }
      })
      .catch(() => {});
  }, [userId]);

  const handleQuickApply = async (e: React.MouseEvent, jobId: number) => {
    e.stopPropagation();
    if (appliedIds.has(jobId) || applyingId === jobId) return;
    setApplyingId(jobId);
    setApplyResult(null);
    try {
      const res = await fetch('/api/v1/public/quick-apply', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ job_id: jobId, user_id: userId }),
      });
      const data = await res.json();
      if (data.success) {
        setAppliedIds(prev => new Set(prev).add(jobId));
        setApplyDetails(prev => ({ ...prev, [jobId]: {
          job_id: jobId,
          flow_id: data.flow_id,
          job_title: data.job_title,
          company: data.company || '',
          match_score: data.match_score,
          details: data.ai_reason || '',
          last_action: data.ai_queue || 'AIç­›é€‰é˜Ÿåˆ—',
        }}));
        setApplyResult({ success: true, ...data });
      } else {
        setApplyResult({ success: false, message: data.error || 'æŠ•é€’å¤±è´¥' });
      }
    } catch {
      setApplyResult({ success: false, message: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•' });
    }
    setApplyingId(null);
    setTimeout(() => setApplyResult(null), 5000);
  };

  // ç­›é€‰çŠ¶æ€
  const [searchText, setSearchText] = useState('');
  const [activeSearch, setActiveSearch] = useState('');
  const [location, setLocation] = useState('');
  const [jobType, setJobType] = useState('');
  const [selectedTag, setSelectedTag] = useState('');
  const [salaryRange, setSalaryRange] = useState('');
  const [sortBy, setSortBy] = useState('newest');
  const [page, setPage] = useState(1);
  const pageSize = 12;

  // æ•°æ®çŠ¶æ€
  const [jobs, setJobs] = useState<any[]>([]);
  const [total, setTotal] = useState(0);
  const [totalPages, setTotalPages] = useState(0);
  const [loading, setLoading] = useState(true);
  const [allTags, setAllTags] = useState<{ id: number; name: string; category: string }[]>([]);

  // åŠ è½½æ ‡ç­¾
  useEffect(() => {
    const loadTags = async () => {
      try {
        const { getJobTags } = await import('./services/apiService');
        const data = await getJobTags();
        setAllTags(data);
      } catch { /* ignore */ }
    };
    loadTags();
  }, []);

  // åŠ è½½å²—ä½åˆ—è¡¨
  useEffect(() => {
    const load = async () => {
      setLoading(true);
      try {
        const { getPublicJobs } = await import('./services/apiService');
        // è§£æè–ªèµ„èŒƒå›´
        let salaryMin: number | undefined;
        let salaryMax: number | undefined;
        if (salaryRange === '0-10k') { salaryMin = 0; salaryMax = 10000; }
        else if (salaryRange === '10k-20k') { salaryMin = 10000; salaryMax = 20000; }
        else if (salaryRange === '20k-40k') { salaryMin = 20000; salaryMax = 40000; }
        else if (salaryRange === '40k+') { salaryMin = 40000; }

        const data = await getPublicJobs({
          page,
          page_size: pageSize,
          search: activeSearch || undefined,
          location: location || undefined,
          job_type: jobType || undefined,
          tag: selectedTag || undefined,
          salary_min: salaryMin,
          salary_max: salaryMax,
          sort: sortBy,
        });
        setJobs(data.items || []);
        setTotal(data.total || 0);
        setTotalPages(data.pages || 0);
      } catch (e) {
        console.error('åŠ è½½å²—ä½å¤±è´¥', e);
      }
      setLoading(false);
    };
    load();
  }, [page, activeSearch, location, jobType, selectedTag, salaryRange, sortBy]);

  const handleSearch = () => {
    setPage(1);
    setActiveSearch(searchText);
  };

  const clearFilters = () => {
    setSearchText('');
    setActiveSearch('');
    setLocation('');
    setJobType('');
    setSelectedTag('');
    setSalaryRange('');
    setSortBy('newest');
    setPage(1);
  };

  const hasFilters = activeSearch || location || jobType || selectedTag || salaryRange;

  const jobTypeLabels: Record<string, string> = {
    full_time: 'å…¨èŒ',
    part_time: 'å…¼èŒ',
    contract: 'åˆåŒ',
    internship: 'å®ä¹ ',
    remote: 'è¿œç¨‹',
  };

  const salaryOptions = [
    { value: '', label: 'ä¸é™è–ªèµ„' },
    { value: '0-10k', label: '10Kä»¥ä¸‹' },
    { value: '10k-20k', label: '10K-20K' },
    { value: '20k-40k', label: '20K-40K' },
    { value: '40k+', label: '40Kä»¥ä¸Š' },
  ];

  const sortOptions = [
    { value: 'newest', label: 'æœ€æ–°å‘å¸ƒ' },
    { value: 'salary_desc', label: 'è–ªèµ„ä»é«˜åˆ°ä½' },
    { value: 'salary_asc', label: 'è–ªèµ„ä»ä½åˆ°é«˜' },
  ];

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-700">
      {/* é¡¶éƒ¨æ ‡é¢˜ */}
      <div className="flex items-center gap-4 mb-6">
        <div className="flex-1">
          <h1 className="text-2xl font-black text-slate-900 tracking-tight">ä¼ä¸šå²—ä½æ¨è</h1>
          <p className="text-sm text-slate-500">AI æ™ºèƒ½ä½“ä¸ºæ‚¨åŒ¹é…çš„ä¼˜è´¨å²—ä½ï¼Œå…± <span className="font-black text-indigo-600">{total}</span> ä¸ªå²—ä½</p>
        </div>
      </div>

      {/* æœç´¢ + ç­›é€‰åˆå¹¶ */}
      <div className="bg-white rounded-xl border border-slate-200 p-5 mb-4 shadow-sm">
        {/* æœç´¢æ  */}
        <div className="flex items-center gap-3 mb-4">
          <div className="relative flex-1 min-w-0">
            <Search size={16} className="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" />
            <input
              type="text"
              placeholder="æœç´¢å²—ä½åç§°ã€å…¬å¸ã€å…³é”®è¯..."
              value={searchText}
              onChange={(e) => setSearchText(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
              className="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition-all placeholder:text-slate-400"
            />
          </div>
          <button
            onClick={handleSearch}
            className="flex-shrink-0 px-6 py-2.5 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700 transition-all active:scale-95 flex items-center gap-1.5"
          >
            <Search size={14} /> æœç´¢
          </button>
        </div>

        {/* ç­›é€‰è¡Œ */}
        <div className="flex flex-wrap items-center gap-3">
          {/* åœ°åŒº */}
          <div className="flex items-center gap-1.5">
            <MapPin size={13} className="text-slate-400" />
            <select
              value={location}
              onChange={(e) => { setLocation(e.target.value); setPage(1); }}
              className="text-xs font-bold bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200 text-slate-600"
            >
              <option value="">å…¨éƒ¨åœ°åŒº</option>
              {['åŒ—äº¬', 'ä¸Šæµ·', 'æ·±åœ³', 'å¹¿å·', 'æ­å·', 'æˆéƒ½', 'æ­¦æ±‰', 'å—äº¬', 'è¿œç¨‹'].map(c => (
                <option key={c} value={c}>{c}</option>
              ))}
            </select>
          </div>

          {/* èŒä½ç±»å‹ */}
          <select
            value={jobType}
            onChange={(e) => { setJobType(e.target.value); setPage(1); }}
            className="text-xs font-bold bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200 text-slate-600"
          >
            <option value="">å…¨éƒ¨ç±»å‹</option>
            {Object.entries(jobTypeLabels).map(([k, v]) => (
              <option key={k} value={k}>{v}</option>
            ))}
          </select>

          {/* è–ªèµ„èŒƒå›´ */}
          <select
            value={salaryRange}
            onChange={(e) => { setSalaryRange(e.target.value); setPage(1); }}
            className="text-xs font-bold bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200 text-slate-600"
          >
            {salaryOptions.map(o => (
              <option key={o.value} value={o.value}>{o.label}</option>
            ))}
          </select>

          {/* æ’åº */}
          <select
            value={sortBy}
            onChange={(e) => { setSortBy(e.target.value); setPage(1); }}
            className="text-xs font-bold bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200 text-slate-600"
          >
            {sortOptions.map(o => (
              <option key={o.value} value={o.value}>{o.label}</option>
            ))}
          </select>

          {hasFilters && (
            <button
              onClick={clearFilters}
              className="text-xs font-bold text-slate-400 hover:text-red-500 flex items-center gap-1 transition-colors"
            >
              <X size={12} /> æ¸…é™¤ç­›é€‰
            </button>
          )}
        </div>

        {/* çƒ­é—¨æ ‡ç­¾ */}
        {allTags.length > 0 && (
          <div className="flex flex-wrap items-center gap-2 mt-3 pt-3 border-t border-slate-100">
            <span className="text-[10px] font-bold text-slate-400 mr-1">
              <Tag size={10} className="inline -mt-0.5" /> æ ‡ç­¾:
            </span>
            <button
              onClick={() => { setSelectedTag(''); setPage(1); }}
              className={`px-2.5 py-1 rounded-lg text-[11px] font-bold transition-all ${
                !selectedTag ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
              }`}
            >
              å…¨éƒ¨
            </button>
            {allTags.slice(0, 15).map(t => (
              <button
                key={t.id}
                onClick={() => { setSelectedTag(selectedTag === t.name ? '' : t.name); setPage(1); }}
                className={`px-2.5 py-1 rounded-lg text-[11px] font-bold transition-all ${
                  selectedTag === t.name ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                }`}
              >
                {t.name}
              </button>
            ))}
          </div>
        )}
      </div>

      {/* å²—ä½åˆ—è¡¨ */}
      {loading ? (
        <div className="flex justify-center py-20">
          <Loader2 className="animate-spin text-indigo-600" size={36} />
        </div>
      ) : jobs.length === 0 ? (
        <div className="bg-white rounded-xl border border-slate-200 p-16 text-center shadow-sm">
          <Briefcase size={48} className="mx-auto text-slate-200 mb-4" />
          <p className="text-slate-500 font-bold mb-2">æš‚æ— åŒ¹é…çš„å²—ä½</p>
          <p className="text-slate-400 text-sm">è¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æœç´¢å…³é”®è¯</p>
          {hasFilters && (
            <button onClick={clearFilters} className="mt-4 px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-bold hover:bg-indigo-100 transition-all">
              æ¸…é™¤æ‰€æœ‰ç­›é€‰
            </button>
          )}
        </div>
      ) : (
        <div className="space-y-3">
          {jobs.map((job: any) => {
            const salary = (job.salary_min && job.salary_max)
              ? `Â¥${(job.salary_min / 1000).toFixed(0)}k - Â¥${(job.salary_max / 1000).toFixed(0)}k`
              : (job.salary_display || 'é¢è®®');
            const tags = job.tags ? (Array.isArray(job.tags) ? job.tags : []) : [];
            const tagNames = tags.map((t: any) => typeof t === 'string' ? t : t.name);
            const matchScore = 85 + (job.id % 15);

            return (
              <div
                key={job.id}
                onClick={() => navigate(`/candidate/job/${job.id}`)}
                className="group bg-white rounded-xl border border-slate-100 hover:border-indigo-200 p-5 cursor-pointer transition-all hover:shadow-md"
              >
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <div className="flex items-start gap-4 flex-1 min-w-0">
                    <div className="w-12 h-12 bg-slate-50 rounded-lg flex items-center justify-center shadow-sm border border-slate-100 text-xl font-bold flex-shrink-0 group-hover:scale-105 transition-transform">
                      {job.logo || 'ğŸ’¼'}
                    </div>
                    <div className="min-w-0 flex-1">
                      <div className="flex items-center gap-2 flex-wrap">
                        <h3 className="text-base font-black text-slate-900 group-hover:text-indigo-700 transition-colors truncate">{job.title}</h3>
                        <span className="px-2 py-0.5 bg-indigo-100 rounded text-[10px] font-black text-indigo-700 flex-shrink-0">{matchScore}% åŒ¹é…</span>
                      </div>
                      <p className="text-sm text-slate-500 font-medium mt-0.5">{job.company} Â· {job.location || 'å…¨å›½'}</p>
                      <div className="flex flex-wrap gap-1.5 mt-2">
                        <span className="px-2.5 py-0.5 bg-amber-50 border border-amber-200 rounded text-xs font-black text-amber-700">{salary}</span>
                        {job.job_type && (
                          <span className="px-2 py-0.5 bg-indigo-50 border border-indigo-100 rounded text-[10px] font-bold text-indigo-600">
                            {jobTypeLabels[job.job_type] || job.job_type}
                          </span>
                        )}
                        {job.experience_required && (
                          <span className="px-2 py-0.5 bg-slate-50 border border-slate-200 rounded text-[10px] font-bold text-slate-500">{job.experience_required}</span>
                        )}
                        {tagNames.slice(0, 3).map((t: string, i: number) => (
                          <span key={i} className="px-2 py-0.5 bg-slate-50 border border-slate-200 rounded text-[10px] font-bold text-slate-500">{t}</span>
                        ))}
                      </div>
                    </div>
                  </div>

                  <div className="flex items-center gap-2 flex-shrink-0">
                    {appliedIds.has(job.id) ? (
                      <div className="relative group/apply">
                        <span className="bg-indigo-50 border border-indigo-200 text-indigo-700 px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-1.5 cursor-default">
                          <CheckCircle2 size={13} /> å·²æŠ•é€’
                        </span>
                        {applyDetails[job.id] && (
                          <div
                            onClick={(e) => { e.stopPropagation(); navigate(`/workbench/flow/${applyDetails[job.id].flow_id}`); }}
                            className="absolute right-0 top-full mt-2 w-64 bg-slate-900 text-white rounded-xl shadow-2xl p-4 z-50 opacity-0 invisible group-hover/apply:opacity-100 group-hover/apply:visible transition-all duration-200 text-xs cursor-pointer hover:bg-slate-800"
                          >
                            <div className="flex items-center gap-1.5 font-bold mb-2 text-indigo-300">
                              <CheckCircle2 size={12} /> AI æŠ•é€’è¯¦æƒ…
                            </div>
                            <p className="text-slate-300 mb-1">å²—ä½ï¼š<span className="text-indigo-300 font-bold">{applyDetails[job.id].job_title}</span></p>
                            <div className="flex items-center gap-2 mb-1">
                              <span className="bg-indigo-500/20 text-indigo-300 px-1.5 py-0.5 rounded text-[10px] font-bold">åŒ¹é…åº¦ {applyDetails[job.id].match_score}%</span>
                            </div>
                            {applyDetails[job.id].details && <p className="text-slate-400 mt-1">{applyDetails[job.id].details}</p>}
                            <p className="text-indigo-400 mt-2 font-bold flex items-center gap-1">æŸ¥çœ‹æŠ•é€’è¯¦æƒ… <ChevronRight size={11} /></p>
                            <div className="absolute -top-1.5 right-6 w-3 h-3 bg-slate-900 rotate-45"></div>
                          </div>
                        )}
                      </div>
                    ) : (
                      <button
                        onClick={(e) => handleQuickApply(e, job.id)}
                        disabled={applyingId === job.id}
                        className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-1.5 transition-all shadow-sm active:scale-95 disabled:opacity-60"
                      >
                        {applyingId === job.id ? <Loader2 size={13} className="animate-spin" /> : <Rocket size={13} />} {applyingId === job.id ? 'AI åˆ†æä¸­...' : 'AI æŠ•é€’'}
                      </button>
                    )}
                    <button
                      onClick={(e) => { e.stopPropagation(); navigate(`/candidate/job/${job.id}`); }}
                      className="bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-1.5 transition-all"
                    >
                      è¯¦æƒ… <ChevronRight size={12} />
                    </button>
                  </div>
                </div>

                {(job.ai_intro || job.aiIntro) && (
                  <div className="mt-3 pt-3 border-t border-slate-100">
                    <p className="text-xs text-slate-400 font-medium flex items-center gap-1.5">
                      <Zap size={11} className="text-amber-500" />
                      {job.ai_intro || job.aiIntro}
                    </p>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}

      {/* åˆ†é¡µ */}
      {totalPages > 1 && (
        <div className="flex items-center justify-center gap-2 mt-8">
          <button
            disabled={page <= 1}
            onClick={() => setPage(p => Math.max(1, p - 1))}
            className="px-3 py-2 rounded-lg border border-slate-200 text-sm font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
          >
            <ChevronLeft size={14} />
          </button>
          {Array.from({ length: Math.min(totalPages, 7) }, (_, i) => {
            let pageNum: number;
            if (totalPages <= 7) {
              pageNum = i + 1;
            } else if (page <= 4) {
              pageNum = i + 1;
            } else if (page >= totalPages - 3) {
              pageNum = totalPages - 6 + i;
            } else {
              pageNum = page - 3 + i;
            }
            return (
              <button
                key={pageNum}
                onClick={() => setPage(pageNum)}
                className={`w-9 h-9 rounded-lg text-sm font-bold transition-all ${
                  page === pageNum
                    ? 'bg-indigo-600 text-white shadow-sm'
                    : 'border border-slate-200 text-slate-600 hover:bg-slate-50'
                }`}
              >
                {pageNum}
              </button>
            );
          })}
          <button
            disabled={page >= totalPages}
            onClick={() => setPage(p => Math.min(totalPages, p + 1))}
            className="px-3 py-2 rounded-lg border border-slate-200 text-sm font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
          >
            <ChevronRight size={14} />
          </button>
          <span className="text-xs text-slate-400 font-bold ml-3">å…± {total} æ¡</span>
        </div>
      )}

      {/* AI æŠ•é€’ç»“æœ Toast */}
      {applyResult && (
        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 animate-in fade-in slide-in-from-bottom-4 duration-300">
          {applyResult.success ? (
            <div className="bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl text-sm max-w-md">
              <div className="flex items-center gap-2 font-bold mb-2">
                <Rocket size={15} className="text-indigo-400" />
                <span>AI æ™ºèƒ½æŠ•é€’å®Œæˆ</span>
              </div>
              <div className="space-y-1 text-slate-300 text-xs">
                <p>å·²æŠ•é€’ã€Œ<span className="text-indigo-300 font-bold">{applyResult.job_title}</span>ã€{applyResult.company && <span className="text-slate-400"> Â· {applyResult.company}</span>}</p>
                <div className="flex items-center gap-3 mt-1.5">
                  <span className="bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded text-xs font-bold">åŒ¹é…åº¦ {applyResult.match_score}%</span>
                  <span className="bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded text-xs font-bold">åŠ å…¥{applyResult.ai_queue || 'AIç­›é€‰é˜Ÿåˆ—'}</span>
                </div>
                {applyResult.ai_reason && <p className="text-slate-400 mt-1">ğŸ’¡ {applyResult.ai_reason}</p>}
                {applyResult.ai_suggestion && <p className="text-amber-400 mt-0.5">ğŸ“ {applyResult.ai_suggestion}</p>}
                {applyResult.tokens_used > 0 && <p className="text-slate-500 mt-1 text-[10px]">æ¶ˆè€— {applyResult.tokens_used} tokens Â· {applyResult.model_name || 'AI'}</p>}
              </div>
            </div>
          ) : (
            <div className="bg-slate-900 text-white px-6 py-3 rounded-xl shadow-2xl text-sm font-bold flex items-center gap-2">
              <XCircle size={16} className="text-red-400" />
              {applyResult.message}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// --- é‚€è¯·å¥½å‹é¡µé¢ (InviteFriendView) ---
const InviteFriendView = () => {
  const navigate = useNavigate();
  const { user, isLoggedIn } = useAuth();
  const userId = user?.id || 0;

  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState<any>(null);
  const [copied, setCopied] = useState(false);
  const [codeCopied, setCodeCopied] = useState(false);

  // åŠ è½½é‚€è¯·ç»Ÿè®¡
  useEffect(() => {
    if (!isLoggedIn || !userId) return;
    const load = async () => {
      setLoading(true);
      try {
        const { getInviteStats } = await import('./services/apiService');
        const data = await getInviteStats(userId);
        setStats(data);
      } catch (e) {
        console.error('è·å–é‚€è¯·æ•°æ®å¤±è´¥', e);
      }
      setLoading(false);
    };
    load();
  }, [userId, isLoggedIn]);

  // æœªç™»å½•
  if (!isLoggedIn) {
    return (
      <div className="pt-20 text-center">
        <Lock className="mx-auto text-slate-300 mb-4" size={48} />
        <p className="text-slate-500 mb-4">è¯·å…ˆç™»å½•å†æŸ¥çœ‹é‚€è¯·é¡µé¢</p>
        <button onClick={() => navigate('/login')} className="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-all">å»ç™»å½•</button>
      </div>
    );
  }

  if (loading) {
    return (
      <div className="pt-20 text-center">
        <Loader2 className="mx-auto text-indigo-600 animate-spin mb-4" size={48} />
        <p className="text-slate-500">åŠ è½½é‚€è¯·æ•°æ®...</p>
      </div>
    );
  }

  const inviteCode = stats?.invite_code || '------';
  const baseUrl = window.location.origin + window.location.pathname;
  const inviteLink = `${baseUrl}#/login?ref=${inviteCode}`;
  const inviteCount = stats?.invite_count || 0;
  const totalReward = stats?.total_reward_tokens || 0;
  const tokenBalance = stats?.token_balance || 0;
  const records = stats?.records || [];
  const rules = stats?.rules || { per_invite_reward: 50000, new_user_bonus: 20000, milestone_5: 100000, milestone_10: 300000, milestone_20: 800000 };

  const handleCopy = () => {
    navigator.clipboard.writeText(inviteLink).then(() => {
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }).catch(() => {});
  };

  // é‡Œç¨‹ç¢‘è¿›åº¦
  const milestones = [
    { count: 5, bonus: rules.milestone_5, label: '5äºº' },
    { count: 10, bonus: rules.milestone_10, label: '10äºº' },
    { count: 20, bonus: rules.milestone_20, label: '20äºº' },
  ];

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-700">
      {/* æ ‡é¢˜ */}
      <div className="flex items-center gap-4 mb-8">
        <div>
          <h1 className="text-2xl font-black text-slate-900 tracking-tight">é‚€è¯·å¥½å‹</h1>
          <p className="text-sm text-slate-500">é‚€è¯·å¥½å‹æ³¨å†Œï¼ŒåŒæ–¹éƒ½èƒ½è·å¾— Token å¥–åŠ±</p>
        </div>
      </div>

      {/* é‚€è¯·é“¾æ¥å¡ç‰‡ */}
      <div className="bg-gradient-to-br from-indigo-600 via-indigo-700 to-purple-700 rounded-lg p-6 md:p-8 text-white mb-6 shadow-xl relative overflow-hidden">
        <div className="absolute top-0 right-0 w-40 h-40 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/2" />
        <div className="absolute bottom-0 left-0 w-32 h-32 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/2" />
        <div className="relative z-10">
          <div className="flex items-center gap-2 mb-4">
            <Gift size={20} />
            <span className="font-bold text-lg">æ‚¨çš„ä¸“å±é‚€è¯·é“¾æ¥</span>
          </div>
          <div className="flex flex-col md:flex-row gap-3 items-stretch md:items-center">
            <div className="flex-1 bg-white/10 backdrop-blur-sm rounded-xl px-4 py-3 text-sm font-mono truncate border border-white/20">
              {inviteLink}
            </div>
            <button
              onClick={handleCopy}
              className={`flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-bold text-sm transition-all active:scale-95 whitespace-nowrap ${
                copied 
                  ? 'bg-emerald-500 text-white' 
                  : 'bg-white text-indigo-700 hover:bg-indigo-50'
              }`}
            >
              {copied ? <><Check size={16} /> å·²å¤åˆ¶</> : <><Link2 size={16} /> å¤åˆ¶é“¾æ¥</>}
            </button>
          </div>
          <div className="mt-4 flex items-center gap-4 text-indigo-200 text-xs">
            <div className="flex items-center gap-2">
              <Shield size={12} />
              <span>é‚€è¯·ç ï¼š<span className="font-mono font-bold text-white text-base tracking-[0.15em]">{inviteCode}</span></span>
            </div>
            <button 
              onClick={() => {
                try {
                  navigator.clipboard.writeText(inviteCode).then(() => {
                    setCodeCopied(true);
                    setTimeout(() => setCodeCopied(false), 2000);
                  }).catch(() => {
                    // fallback: ä½¿ç”¨ execCommand
                    const ta = document.createElement('textarea');
                    ta.value = inviteCode;
                    ta.style.position = 'fixed';
                    ta.style.opacity = '0';
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    setCodeCopied(true);
                    setTimeout(() => setCodeCopied(false), 2000);
                  });
                } catch {
                  const ta = document.createElement('textarea');
                  ta.value = inviteCode;
                  ta.style.position = 'fixed';
                  ta.style.opacity = '0';
                  document.body.appendChild(ta);
                  ta.select();
                  document.execCommand('copy');
                  document.body.removeChild(ta);
                  setCodeCopied(true);
                  setTimeout(() => setCodeCopied(false), 2000);
                }
              }}
              className={`px-3 py-1 rounded-lg text-xs font-bold transition-all ${codeCopied ? 'bg-emerald-500 text-white' : 'bg-white/15 hover:bg-white/25 text-white'}`}
            >
              {codeCopied ? 'âœ“ å·²å¤åˆ¶' : 'å¤åˆ¶é‚€è¯·ç '}
            </button>
          </div>
          <p className="mt-2 text-indigo-300/70 text-[11px]">å¥½å‹å¯é€šè¿‡é“¾æ¥æ³¨å†Œï¼Œæˆ–åœ¨æ³¨å†Œé¡µæ‰‹åŠ¨è¾“å…¥é‚€è¯·ç </p>
        </div>
      </div>

      {/* ç»Ÿè®¡å¡ç‰‡åŒº */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div className="bg-white rounded-xl border border-slate-100 p-5 shadow-sm">
          <div className="flex items-center gap-2 text-slate-400 text-xs font-bold mb-2">
            <UserPlus size={14} />
            å·²é‚€è¯·å¥½å‹
          </div>
          <div className="text-3xl font-black text-slate-900">{inviteCount}<span className="text-base font-bold text-slate-400 ml-1">äºº</span></div>
        </div>
        <div className="bg-white rounded-xl border border-slate-100 p-5 shadow-sm">
          <div className="flex items-center gap-2 text-slate-400 text-xs font-bold mb-2">
            <Coins size={14} />
            ç´¯è®¡è·å¾—å¥–åŠ±
          </div>
          <div className="text-3xl font-black text-amber-600">{totalReward.toLocaleString()}<span className="text-base font-bold text-slate-400 ml-1">Token</span></div>
        </div>
        <div className="bg-white rounded-xl border border-slate-100 p-5 shadow-sm">
          <div className="flex items-center gap-2 text-slate-400 text-xs font-bold mb-2">
            <Wallet size={14} />
            Token ä½™é¢
          </div>
          <div className="text-3xl font-black text-indigo-600">{tokenBalance.toLocaleString()}<span className="text-base font-bold text-slate-400 ml-1">Token</span></div>
        </div>
      </div>

      {/* é‡Œç¨‹ç¢‘è¿›åº¦ */}
      <div className="bg-white rounded-xl border border-slate-100 p-6 shadow-sm mb-6">
        <h3 className="text-sm font-black text-slate-700 flex items-center gap-2 mb-4">
          <Trophy size={16} className="text-amber-500" />
          é‚€è¯·é‡Œç¨‹ç¢‘å¥–åŠ±
        </h3>
        <div className="flex items-center gap-4">
          {milestones.map((m, i) => {
            const reached = inviteCount >= m.count;
            return (
              <div key={i} className="flex-1">
                <div className={`relative rounded-lg p-4 text-center border-2 transition-all ${
                  reached 
                    ? 'bg-amber-50 border-amber-300 ring-2 ring-amber-100' 
                    : 'bg-slate-50 border-slate-200'
                }`}>
                  {reached && <div className="absolute -top-2 -right-2 w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center"><Check size={12} className="text-white" /></div>}
                  <div className={`text-2xl font-black ${reached ? 'text-amber-600' : 'text-slate-300'}`}>{m.label}</div>
                  <div className={`text-xs font-bold mt-1 ${reached ? 'text-amber-700' : 'text-slate-400'}`}>+{m.bonus.toLocaleString()} Token</div>
                </div>
                {i < milestones.length - 1 && <div className="hidden md:block" />}
              </div>
            );
          })}
        </div>
        <div className="mt-3">
          <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
            <div 
              className="h-full bg-gradient-to-r from-amber-400 to-amber-500 rounded-full transition-all duration-700"
              style={{ width: `${Math.min(100, (inviteCount / 20) * 100)}%` }}
            />
          </div>
          <div className="flex justify-between text-[10px] text-slate-400 font-bold mt-1">
            <span>0</span>
            <span>5</span>
            <span>10</span>
            <span>20</span>
          </div>
        </div>
      </div>

      {/* é‚€è¯·è®°å½• */}
      <div className="bg-white rounded-xl border border-slate-100 p-6 shadow-sm mb-6">
        <h3 className="text-sm font-black text-slate-700 flex items-center gap-2 mb-4">
          <History size={16} className="text-indigo-500" />
          é‚€è¯·è®°å½•
        </h3>
        {records.length === 0 ? (
          <div className="text-center py-10">
            <UserPlus size={40} className="mx-auto text-slate-200 mb-3" />
            <p className="text-slate-400 text-sm font-bold">æš‚æ— é‚€è¯·è®°å½•</p>
            <p className="text-slate-300 text-xs mt-1">åˆ†äº«æ‚¨çš„é‚€è¯·é“¾æ¥ï¼Œå¥½å‹æ³¨å†Œåå³å¯è·å¾—å¥–åŠ±</p>
          </div>
        ) : (
          <div className="space-y-3">
            {records.map((r: any) => (
              <div key={r.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100">
                <div className="flex items-center gap-3">
                  <div className="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-sm font-black">
                    {r.invitee_name?.[0] || '?'}
                  </div>
                  <div>
                    <div className="text-sm font-bold text-slate-700">{r.invitee_name}</div>
                    <div className="text-[10px] text-slate-400">{r.created_at ? parseUTC(r.created_at).toLocaleDateString('zh-CN') : 'â€”'}</div>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <span className={`text-xs px-2 py-0.5 rounded-full font-bold ${
                    r.status === 'rewarded' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'
                  }`}>
                    {r.status === 'rewarded' ? 'å·²å‘æ”¾' : 'å·²æ³¨å†Œ'}
                  </span>
                  <span className="text-sm font-black text-amber-600">+{r.reward_tokens}</span>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* å¥–åŠ±è§„åˆ™ */}
      <div className="bg-gradient-to-br from-slate-50 to-indigo-50/30 rounded-xl border border-slate-100 p-6 shadow-sm">
        <h3 className="text-sm font-black text-slate-700 flex items-center gap-2 mb-4">
          <Info size={16} className="text-indigo-500" />
          å¥–åŠ±è§„åˆ™
        </h3>
        <div className="space-y-3 text-sm text-slate-600">
          <div className="flex items-start gap-3">
            <div className="w-6 h-6 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xs font-black flex-shrink-0 mt-0.5">1</div>
            <div><span className="font-bold text-slate-700">åŸºç¡€å¥–åŠ±</span>ï¼šæ¯æˆåŠŸé‚€è¯· 1 ä½å¥½å‹æ³¨å†Œï¼Œæ‚¨è·å¾— <span className="font-black text-amber-600">{rules.per_invite_reward?.toLocaleString()} Token</span>ï¼Œå¥½å‹è·å¾— <span className="font-black text-emerald-600">{rules.new_user_bonus?.toLocaleString()} Token</span></div>
          </div>
          <div className="flex items-start gap-3">
            <div className="w-6 h-6 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xs font-black flex-shrink-0 mt-0.5">2</div>
            <div><span className="font-bold text-slate-700">é‡Œç¨‹ç¢‘å¥–åŠ±</span>ï¼šç´¯è®¡é‚€è¯·è¾¾åˆ° 5 / 10 / 20 äººæ—¶ï¼Œé¢å¤–è·å¾— <span className="font-black text-amber-600">{rules.milestone_5?.toLocaleString()} / {rules.milestone_10?.toLocaleString()} / {rules.milestone_20?.toLocaleString()} Token</span></div>
          </div>
          <div className="flex items-start gap-3">
            <div className="w-6 h-6 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xs font-black flex-shrink-0 mt-0.5">3</div>
            <div><span className="font-bold text-slate-700">åˆ†äº«æ–¹å¼</span>ï¼šå¤åˆ¶é‚€è¯·é“¾æ¥å‘é€ç»™å¥½å‹ï¼Œæˆ–åˆ†äº«é‚€è¯·ç è®©å¥½å‹æ³¨å†Œæ—¶æ‰‹åŠ¨å¡«å†™ï¼Œæ³¨å†Œåå³è‡ªåŠ¨å‘æ”¾å¥–åŠ±</div>
          </div>
          <div className="flex items-start gap-3">
            <div className="w-6 h-6 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xs font-black flex-shrink-0 mt-0.5">4</div>
            <div><span className="font-bold text-slate-700">Token ç”¨é€”</span>ï¼šToken å¯ç”¨äº AI æ™ºèƒ½æ‹›è˜ã€ç®€å†è§£æã€é¢è¯•æ¨¡æ‹Ÿã€å¸‚åœºåˆ†æç­‰å…¨éƒ¨ AI åŠŸèƒ½</div>
          </div>
        </div>
      </div>
    </div>
  );
};

// --- AIæŠ•é€’ä»»åŠ¡è¯¦æƒ…é¡µ (AIDeliveryView) ---
const AIDeliveryView = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const [selectedJob, setSelectedJob] = useState(RECOMMENDED_JOBS[0]);
  const [isDelivering, setIsDelivering] = useState(false);
  const [deliveryStatus, setDeliveryStatus] = useState<'idle' | 'preparing' | 'delivering' | 'completed'>('idle');
  const [deliveryProgress, setDeliveryProgress] = useState(0);
  const [aiMessages, setAiMessages] = useState<{role: 'user' | 'assistant', content: string}[]>([
    {role: 'assistant', content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯ AI æŠ•é€’åŠ©æ‰‹ã€‚æˆ‘å°†å¸®åŠ©æ‚¨å®Œæˆç®€å†æŠ•é€’å…¨æµç¨‹ï¼ŒåŒ…æ‹¬ç®€å†ä¼˜åŒ–ã€æ±‚èŒä¿¡ç”Ÿæˆã€æŠ•é€’ç­–ç•¥è§„åˆ’ç­‰ã€‚'}
  ]);
  const [inputMessage, setInputMessage] = useState('');
  // æ ¹æ®ç”¨æˆ·å½“å‰æ–¹æ¡ˆç­‰çº§åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©
  const [selectedModel, setSelectedModel] = useState(() => {
    const t = user?.account_tier?.toUpperCase();
    if (t === 'ULTRA') return 'Devnors 1.0 Ultra';
    if (t === 'PRO') return 'Devnors 1.0 Pro';
    return 'Devnors 1.0';
  });
  
  const allModelOptions = ['Devnors 1.0', 'Devnors 1.0 Pro', 'Devnors 1.0 Ultra'];
  const isModelAvailable = (model: string) => {
    const tier = user?.account_tier || 'FREE';
    if (tier === 'ULTRA') return true;
    if (tier === 'PRO') return model !== 'Devnors 1.0 Ultra';
    return model === 'Devnors 1.0';
  };

  const handleDelivery = async () => {
    setIsDelivering(true);
    setDeliveryStatus('preparing');
    setDeliveryProgress(0);
    
    setAiMessages(prev => [...prev, {role: 'user', content: `æˆ‘æƒ³è¦æŠ•é€’ ${selectedJob.company} çš„ ${selectedJob.title} èŒä½`}]);
    
    setTimeout(() => {
      setAiMessages(prev => [...prev, {role: 'assistant', content: `å¥½çš„ï¼æˆ‘æ­£åœ¨ä¸ºæ‚¨å‡†å¤‡æŠ•é€’ææ–™ã€‚é¦–å…ˆåˆ†æè¯¥èŒä½çš„æ ¸å¿ƒéœ€æ±‚...`}]);
    }, 500);

    const steps = [
      { progress: 20, message: 'æ­£åœ¨åˆ†æèŒä½éœ€æ±‚...' },
      { progress: 40, message: 'æ­£åœ¨ä¼˜åŒ–æ‚¨çš„ç®€å†...' },
      { progress: 60, message: 'æ­£åœ¨ç”Ÿæˆæ±‚èŒä¿¡...' },
      { progress: 80, message: 'æ­£åœ¨å‡†å¤‡æŠ•é€’ææ–™...' },
      { progress: 100, message: 'æŠ•é€’å‡†å¤‡å®Œæˆï¼å³å°†è‡ªåŠ¨æŠ•é€’...' },
    ];

    for (let i = 0; i < steps.length; i++) {
      await new Promise(resolve => setTimeout(resolve, 800));
      setDeliveryProgress(steps[i].progress);
      setDeliveryStatus(i === steps.length - 1 ? 'completed' : 'delivering');
    }

    setIsDelivering(false);
    setAiMessages(prev => [...prev, {role: 'assistant', content: 'æŠ•é€’æˆåŠŸï¼æ‚¨çš„ç®€å†å·²å‘é€è‡³ HR é‚®ç®±ï¼Œé¢„è®¡ 3-5 ä¸ªå·¥ä½œæ—¥å†…æ”¶åˆ°å›å¤ã€‚å»ºè®®æ‚¨å‡†å¤‡å¥½é¢è¯•ï¼Œéšæ—¶å…³æ³¨å¹³å°é€šçŸ¥ã€‚'}]);
  };

  const handleSendMessage = () => {
    if (!inputMessage.trim()) return;
    setAiMessages(prev => [...prev, {role: 'user', content: inputMessage}]);
    setInputMessage('');
    
    setTimeout(() => {
      const responses = [
        'æˆ‘å¯ä»¥å¸®æ‚¨ä¼˜åŒ–ç®€å†ä¸­çš„è¿™ä¸ªé¡¹ç›®æè¿°ï¼Œçªå‡ºæ‚¨çš„æ ¸å¿ƒè´¡çŒ®å’ŒæŠ€æœ¯éš¾ç‚¹ã€‚',
        'é’ˆå¯¹è¿™ä¸ªèŒä½ï¼Œæˆ‘å»ºè®®æ‚¨åœ¨æ±‚èŒä¿¡ä¸­å¼ºè°ƒä»¥ä¸‹ç»éªŒï¼š...',
        'æŠ•é€’åæ‚¨å¯ä»¥å‡†å¤‡ä»¥ä¸‹å‡ ä¸ªå¸¸è§çš„é¢è¯•é—®é¢˜ï¼š...',
        'å¥½çš„ï¼Œæˆ‘ä¼šå¸®æ‚¨è·Ÿè¸ªæŠ•é€’çŠ¶æ€ï¼Œå¹¶åœ¨æœ‰æ–°è¿›å±•æ—¶åŠæ—¶é€šçŸ¥æ‚¨ã€‚'
      ];
      setAiMessages(prev => [...prev, {role: 'assistant', content: responses[Math.floor(Math.random() * responses.length)]}]);
    }, 1000);
  };

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-7xl mx-auto animate-in fade-in duration-500">
      <button onClick={() => navigate('/candidate/home')} className="flex items-center gap-2 text-slate-500 hover:text-indigo-600 mb-8 font-black transition-colors group">
        <ChevronLeft size={20} className="group-hover:-translate-x-1 transition-transform" /> è¿”å›
      </button>

      <div className="grid grid-cols-1 xl:grid-cols-10 gap-8">
        <div className="xl:col-span-3 space-y-6">
          <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-xl">
            <h1 className="text-xl font-black text-slate-900 mb-2 flex items-center gap-2">
              <Rocket size={20} className="text-emerald-600" /> AI å¯¹æ¥æŠ•é€’
            </h1>
            <p className="text-xs text-slate-500 mb-4">AI å…¨ç¨‹é™ªä¼´ï¼ŒåŠ©æ‚¨é«˜æ•ˆå®Œæˆç®€å†æŠ•é€’</p>
            
            <div className="bg-slate-50 rounded-lg p-4 mb-4">
              <h2 className="text-base font-black text-slate-900 mb-3 flex items-center gap-2">
                <Briefcase size={16} className="text-indigo-600" /> ç›®æ ‡èŒä½
              </h2>
              <div className="flex items-start gap-3">
                <div className="w-12 h-12 bg-white rounded flex items-center justify-center shadow-sm text-xl font-bold border border-slate-100">
                  {selectedJob.logo}
                </div>
                <div className="flex-1">
                  <h3 className="text-sm font-black text-slate-900">{selectedJob.title}</h3>
                  <p className="text-xs text-indigo-600 font-bold">{selectedJob.company}</p>
                  <p className="text-xs text-slate-500 mt-1">{selectedJob.location}</p>
                </div>
              </div>
              <div className="flex flex-wrap gap-1.5 mt-3">
                <span className="px-2 py-0.5 bg-emerald-100 rounded text-xs font-bold text-emerald-700">{selectedJob.match}% åŒ¹é…åº¦</span>
                <span className="px-2 py-0.5 bg-slate-100 rounded text-xs font-bold text-slate-600">{selectedJob.salary}</span>
              </div>
            </div>

            {deliveryStatus !== 'idle' && (
              <div className="bg-slate-50 rounded-lg p-4 mb-4">
                <h2 className="text-base font-black text-slate-900 mb-3 flex items-center gap-2">
                  <Activity size={16} className="text-emerald-600" /> æŠ•é€’è¿›åº¦
                </h2>
                <div className="space-y-3">
                  {[
                    { step: 1, name: 'åˆ†æèŒä½éœ€æ±‚', done: deliveryProgress >= 20 },
                    { step: 2, name: 'ä¼˜åŒ–ç®€å†', done: deliveryProgress >= 40 },
                    { step: 3, name: 'ç”Ÿæˆæ±‚èŒä¿¡', done: deliveryProgress >= 60 },
                    { step: 4, name: 'å‡†å¤‡ææ–™', done: deliveryProgress >= 80 },
                    { step: 5, name: 'å®ŒæˆæŠ•é€’', done: deliveryProgress >= 100 },
                  ].map((s, idx) => (
                    <div key={idx} className="flex items-center gap-2">
                      <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-black ${
                        s.done ? 'bg-emerald-500 text-white' : 'bg-slate-200 text-slate-500'
                      }`}>
                        {s.done ? <CheckCircle2 size={12} /> : s.step}
                      </div>
                      <span className={`text-xs ${s.done ? 'text-slate-900 font-medium' : 'text-slate-400'}`}>{s.name}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <button 
              onClick={handleDelivery}
              disabled={isDelivering}
              className="w-full bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-3 rounded font-black flex items-center justify-center gap-2 shadow-lg shadow-emerald-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed text-sm"
            >
              {isDelivering ? (
                <>
                  <Loader2 size={16} className="animate-spin" /> æŠ•é€’ä¸­...
                </>
              ) : (
                <>
                  <Rocket size={16} /> ä¸€é”®æŠ•é€’
                </>
              )}
            </button>
          </div>

          <div className="bg-white rounded-lg p-6 border border-slate-100 shadow-xl">
            <h2 className="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
              <FileText size={18} className="text-indigo-600" /> æŠ•é€’ææ–™
            </h2>
            <div className="space-y-3">
              <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                <div className="flex items-center gap-2">
                  <FileText size={14} className="text-indigo-600" />
                  <span className="text-xs font-medium text-slate-700">ä¼˜åŒ–ç®€å†</span>
                </div>
                <span className="text-xs font-bold text-emerald-600">å·²ç”Ÿæˆ</span>
              </div>
              <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                <div className="flex items-center gap-2">
                  <FileText size={14} className="text-rose-600" />
                  <span className="text-xs font-medium text-slate-700">æ±‚èŒä¿¡</span>
                </div>
                <span className={`text-xs font-bold ${deliveryProgress >= 60 ? 'text-emerald-600' : 'text-slate-400'}`}>
                  {deliveryProgress >= 60 ? 'å·²ç”Ÿæˆ' : 'å¾…ç”Ÿæˆ'}
                </span>
              </div>
              <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                <div className="flex items-center gap-2">
                  <Award size={14} className="text-amber-600" />
                  <span className="text-xs font-medium text-slate-700">ä½œå“é›†</span>
                </div>
                <span className="text-xs font-bold text-slate-400">å¯é€‰</span>
              </div>
            </div>
          </div>
        </div>

        <div className="xl:col-span-7">
          <div className="bg-white rounded-lg border border-slate-200 overflow-hidden flex flex-col h-[600px] shadow-xl sticky top-8">
            <div className="bg-white/90 px-4 py-3 border-b border-slate-200 backdrop-blur-sm flex justify-between items-center">
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 bg-emerald-400 rounded-full animate-pulse"></div>
                <span className="text-slate-900 font-black text-sm tracking-wide uppercase">AI æŠ•é€’åŠ©æ‰‹</span>
              </div>
              <div className="flex items-center gap-2">
                <select 
                  value={selectedModel} 
                  onChange={(e) => {
                    if (isModelAvailable(e.target.value)) setSelectedModel(e.target.value);
                  }}
                  className="text-xs border border-slate-200 rounded-lg px-3 py-1.5 bg-white text-slate-700 font-medium focus:outline-none focus:border-indigo-300 cursor-pointer"
                >
                  {allModelOptions.map(model => (
                    <option key={model} value={model} disabled={!isModelAvailable(model)}>
                      {model}{!isModelAvailable(model) ? ' (éœ€å‡çº§)' : ''}
                    </option>
                  ))}
                </select>
                {user?.account_tier !== 'ULTRA' && (
                  <Link to="/pricing" className="text-amber-500 hover:text-amber-600 transition-colors" title="å‡çº§æ–¹æ¡ˆ">
                    <Zap size={14} />
                  </Link>
                )}
              </div>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide bg-slate-50">
              {aiMessages.map((msg, i) => (
                <div key={i} className={`flex justify-${msg.role === 'user' ? 'end' : 'start'}`}>
                  <div className={`flex gap-3 max-w-[85%] flex-row ${msg.role === 'user' ? 'flex-row-reverse' : ''}`}>
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${msg.role === 'user' ? 'bg-emerald-600' : 'bg-indigo-50 border border-indigo-100'}`}>
                      {msg.role === 'user' ? <UserIcon size={14} className="text-white" /> : <Bot size={14} className="text-indigo-600" />}
                    </div>
                    <div className={`px-4 py-3 rounded-lg text-sm leading-relaxed ${msg.role === 'user' ? 'bg-emerald-600 text-white rounded-tr-none' : 'bg-white text-slate-700 rounded-tl-none border border-slate-200'}`}>
                      {msg.content}
                    </div>
                  </div>
                </div>
              ))}
            </div>
            <div className="p-4 bg-white/90 border-t border-slate-200 backdrop-blur-md">
              <div className="flex gap-2">
                <input 
                  type="text" 
                  value={inputMessage}
                  onChange={(e) => setInputMessage(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                  placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                  className="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder:text-slate-400"
                />
                <button 
                  onClick={handleSendMessage}
                  className="w-9 h-9 bg-indigo-600 text-white rounded-lg flex items-center justify-center hover:bg-indigo-500 transition-all"
                >
                  <Send size={14} />
                </button>
              </div>
              <div className="mt-3 flex flex-wrap gap-2">
                <button 
                  onClick={() => setInputMessage('å¸®æˆ‘ä¼˜åŒ–ç®€å†')}
                  className="px-3 py-1.5 bg-white hover:bg-indigo-50 text-xs font-black text-slate-600 border border-slate-200 rounded-lg transition-colors"
                >
                  ä¼˜åŒ–ç®€å†
                </button>
                <button 
                  onClick={() => setInputMessage('ç”Ÿæˆæ±‚èŒä¿¡')}
                  className="px-3 py-1.5 bg-white hover:bg-indigo-50 text-xs font-black text-slate-600 border border-slate-200 rounded-lg transition-colors"
                >
                  æ±‚èŒä¿¡
                </button>
                <button 
                  onClick={() => setInputMessage('å‡†å¤‡é¢è¯•é—®é¢˜')}
                  className="px-3 py-1.5 bg-white hover:bg-indigo-50 text-xs font-black text-slate-600 border border-slate-200 rounded-lg transition-colors"
                >
                  é¢è¯•é—®é¢˜
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// --- æ¨èäººæ‰åˆ—è¡¨é¡µ (TalentPoolView) ---
const TalentPoolView = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const userId = user?.id || 0;

  // é‚€è¯·çŠ¶æ€
  const [invitingId, setInvitingId] = useState<number | null>(null);
  const [invitedIds, setInvitedIds] = useState<Set<number>>(new Set());
  const [inviteDetails, setInviteDetails] = useState<Record<number, any>>({});
  const [inviteResult, setInviteResult] = useState<any>(null);

  // é¡µé¢åŠ è½½æ—¶è·å–å·²é‚€è¯·çš„å€™é€‰äºº
  useEffect(() => {
    if (!userId) return;
    fetch(`/api/v1/public/my-invites?user_id=${userId}`)
      .then(r => r.ok ? r.json() : null)
      .then(data => {
        if (data?.success && data.invites) {
          const ids = new Set<number>();
          const details: Record<number, any> = {};
          Object.values(data.invites).forEach((inv: any) => {
            ids.add(inv.candidate_id);
            details[inv.candidate_id] = inv;
          });
          setInvitedIds(ids);
          setInviteDetails(details);
        }
      })
      .catch(() => {});
  }, [userId]);

  const handleQuickInvite = async (e: React.MouseEvent, candidateId: number) => {
    e.stopPropagation();
    if (invitedIds.has(candidateId) || invitingId === candidateId) return;
    setInvitingId(candidateId);
    setInviteResult(null);
    try {
      const res = await fetch('/api/v1/public/quick-invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ candidate_id: candidateId, user_id: userId }),
      });
      const data = await res.json();
      if (data.success) {
        setInvitedIds(prev => new Set(prev).add(candidateId));
        setInviteDetails(prev => ({ ...prev, [candidateId]: {
          candidate_id: candidateId,
          flow_id: data.flow_id,
          job_title: data.job_title,
          match_score: data.match_score,
          details: data.ai_reason || '',
          last_action: data.ai_queue || 'æ™ºèƒ½ç­›é€‰é˜Ÿåˆ—',
        }}));
        setInviteResult({ success: true, ...data });
      } else {
        setInviteResult({ success: false, message: data.error || 'é‚€è¯·å¤±è´¥' });
      }
    } catch {
      setInviteResult({ success: false, message: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•' });
    }
    setInvitingId(null);
    setTimeout(() => setInviteResult(null), 5000);
  };

  // ç­›é€‰çŠ¶æ€
  const [searchText, setSearchText] = useState('');
  const [activeSearch, setActiveSearch] = useState('');
  const [selectedSkill, setSelectedSkill] = useState('');
  const [experienceRange, setExperienceRange] = useState('');
  const [sortBy, setSortBy] = useState('match');
  const [page, setPage] = useState(1);
  const pageSize = 12;

  // æ•°æ®çŠ¶æ€
  const [talents, setTalents] = useState<any[]>([]);
  const [total, setTotal] = useState(0);
  const [totalPages, setTotalPages] = useState(0);
  const [loading, setLoading] = useState(true);
  const [allSkills, setAllSkills] = useState<string[]>([]);

  // åŠ è½½æŠ€èƒ½æ ‡ç­¾
  useEffect(() => {
    const loadSkills = async () => {
      try {
        const { getTalentSkills } = await import('./services/apiService');
        const data = await getTalentSkills();
        setAllSkills(data);
      } catch { /* ignore */ }
    };
    loadSkills();
  }, []);

  // åŠ è½½äººæ‰åˆ—è¡¨
  useEffect(() => {
    const load = async () => {
      setLoading(true);
      try {
        const { getPublicTalentsPaged } = await import('./services/apiService');
        let expMin: number | undefined;
        let expMax: number | undefined;
        if (experienceRange === '0-3') { expMin = 0; expMax = 3; }
        else if (experienceRange === '3-5') { expMin = 3; expMax = 5; }
        else if (experienceRange === '5-10') { expMin = 5; expMax = 10; }
        else if (experienceRange === '10+') { expMin = 10; }

        const data = await getPublicTalentsPaged({
          page,
          page_size: pageSize,
          search: activeSearch || undefined,
          skill: selectedSkill || undefined,
          experience_min: expMin,
          experience_max: expMax,
          sort: sortBy,
        });
        setTalents(data.items || []);
        setTotal(data.total || 0);
        setTotalPages(data.pages || 0);
      } catch (e) {
        console.error('åŠ è½½äººæ‰å¤±è´¥', e);
      }
      setLoading(false);
    };
    load();
  }, [page, activeSearch, selectedSkill, experienceRange, sortBy]);

  const handleSearch = () => {
    setPage(1);
    setActiveSearch(searchText);
  };

  const clearFilters = () => {
    setSearchText('');
    setActiveSearch('');
    setSelectedSkill('');
    setExperienceRange('');
    setSortBy('match');
    setPage(1);
  };

  const hasFilters = activeSearch || selectedSkill || experienceRange;

  const experienceOptions = [
    { value: '', label: 'ä¸é™ç»éªŒ' },
    { value: '0-3', label: '0-3å¹´' },
    { value: '3-5', label: '3-5å¹´' },
    { value: '5-10', label: '5-10å¹´' },
    { value: '10+', label: '10å¹´ä»¥ä¸Š' },
  ];

  const sortOptions = [
    { value: 'match', label: 'åŒ¹é…åº¦ä¼˜å…ˆ' },
    { value: 'newest', label: 'æœ€è¿‘åŠ å…¥' },
    { value: 'experience', label: 'ç»éªŒæœ€ä¸°å¯Œ' },
  ];

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-700">
      {/* é¡¶éƒ¨æ ‡é¢˜ */}
      <div className="flex items-center gap-4 mb-6">
        <div className="flex-1">
          <h1 className="text-2xl font-black text-slate-900 tracking-tight">æ¨èäººæ‰</h1>
          <p className="text-sm text-slate-500">AI æ™ºèƒ½åŒ¹é…æ¨èç»™ä¼ä¸šçš„ä¼˜è´¨å€™é€‰äººï¼Œå…± <span className="font-black text-indigo-600">{total}</span> ä½äººæ‰</p>
        </div>
      </div>

      {/* æœç´¢ + ç­›é€‰åˆå¹¶ */}
      <div className="bg-white rounded-xl border border-slate-200 p-5 mb-4 shadow-sm">
        {/* æœç´¢æ  */}
        <div className="flex items-center gap-3 mb-4">
          <div className="relative flex-1 min-w-0">
            <Search size={16} className="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" />
            <input
              type="text"
              placeholder="æœç´¢å§“åã€èŒä½ã€æŠ€èƒ½å…³é”®è¯..."
              value={searchText}
              onChange={(e) => setSearchText(e.target.value)}
              onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
              className="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400 transition-all placeholder:text-slate-400"
            />
          </div>
          <button
            onClick={handleSearch}
            className="flex-shrink-0 px-6 py-2.5 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700 transition-all active:scale-95 flex items-center gap-1.5"
          >
            <Search size={14} /> æœç´¢
          </button>
        </div>

        {/* ç­›é€‰è¡Œ */}
        <div className="flex flex-wrap items-center gap-3">
          {/* ç»éªŒ */}
          <div className="flex items-center gap-1.5">
            <Briefcase size={13} className="text-slate-400" />
            <select
              value={experienceRange}
              onChange={(e) => { setExperienceRange(e.target.value); setPage(1); }}
              className="text-xs font-bold bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200 text-slate-600"
            >
              {experienceOptions.map(o => (
                <option key={o.value} value={o.value}>{o.label}</option>
              ))}
            </select>
          </div>

          {/* æ’åº */}
          <select
            value={sortBy}
            onChange={(e) => { setSortBy(e.target.value); setPage(1); }}
            className="text-xs font-bold bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200 text-slate-600"
          >
            {sortOptions.map(o => (
              <option key={o.value} value={o.value}>{o.label}</option>
            ))}
          </select>

          {hasFilters && (
            <button
              onClick={clearFilters}
              className="text-xs font-bold text-slate-400 hover:text-red-500 flex items-center gap-1 transition-colors"
            >
              <X size={12} /> æ¸…é™¤ç­›é€‰
            </button>
          )}
        </div>

        {/* æŠ€èƒ½æ ‡ç­¾ */}
        {allSkills.length > 0 && (
          <div className="flex flex-wrap items-center gap-2 mt-3 pt-3 border-t border-slate-100">
            <span className="text-[10px] font-bold text-slate-400 mr-1">
              <Tag size={10} className="inline -mt-0.5" /> æŠ€èƒ½:
            </span>
            <button
              onClick={() => { setSelectedSkill(''); setPage(1); }}
              className={`px-2.5 py-1 rounded-lg text-[11px] font-bold transition-all ${
                !selectedSkill ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
              }`}
            >
              å…¨éƒ¨
            </button>
            {allSkills.slice(0, 20).map(sk => (
              <button
                key={sk}
                onClick={() => { setSelectedSkill(selectedSkill === sk ? '' : sk); setPage(1); }}
                className={`px-2.5 py-1 rounded-lg text-[11px] font-bold transition-all ${
                  selectedSkill === sk ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                }`}
              >
                {sk}
              </button>
            ))}
          </div>
        )}
      </div>

      {/* äººæ‰åˆ—è¡¨ */}
      {loading ? (
        <div className="flex justify-center py-20">
          <Loader2 className="animate-spin text-indigo-600" size={36} />
        </div>
      ) : talents.length === 0 ? (
        <div className="bg-white rounded-xl border border-slate-200 p-16 text-center shadow-sm">
          <Users2 size={48} className="mx-auto text-slate-200 mb-4" />
          <p className="text-slate-500 font-bold mb-2">æš‚æ— åŒ¹é…çš„äººæ‰</p>
          <p className="text-slate-400 text-sm">è¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æœç´¢å…³é”®è¯</p>
          {hasFilters && (
            <button onClick={clearFilters} className="mt-4 px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-bold hover:bg-indigo-100 transition-all">
              æ¸…é™¤æ‰€æœ‰ç­›é€‰
            </button>
          )}
        </div>
      ) : (
        <div className="space-y-3">
          {talents.map((t: any) => {
            const matchScore = t.matchScore || (85 + ((t.id || 0) % 15));
            const skills: string[] = t.skills || [];

            return (
              <div
                key={t.id}
                onClick={() => navigate(`/candidate/profile/${t.id}`)}
                className="group bg-white rounded-xl border border-slate-100 hover:border-indigo-200 p-5 cursor-pointer transition-all hover:shadow-md"
              >
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <div className="flex items-start gap-4 flex-1 min-w-0">
                    <div className="w-12 h-12 bg-indigo-600 text-white rounded-lg flex items-center justify-center text-lg font-black shadow-sm ring-2 ring-indigo-100 flex-shrink-0 group-hover:scale-105 transition-transform">
                      {(t.name || '?').charAt(0)}
                    </div>
                    <div className="min-w-0 flex-1">
                      <div className="flex items-center gap-2 flex-wrap">
                        <h3 className="text-base font-black text-slate-900 group-hover:text-indigo-700 transition-colors truncate">{t.name}</h3>
                        <span className="px-2 py-0.5 bg-emerald-100 rounded text-[10px] font-black text-emerald-700 flex-shrink-0 flex items-center gap-0.5">
                          <Zap size={10} /> {matchScore}% åŒ¹é…
                        </span>
                      </div>
                      <p className="text-sm text-slate-500 font-medium mt-0.5">{t.role || 'æœªçŸ¥èŒä½'} Â· {t.experienceYears || 0}å¹´ç»éªŒ</p>
                      <div className="flex flex-wrap gap-1.5 mt-2">
                        {t.salary_range && (
                          <span className="px-2.5 py-0.5 bg-amber-50 border border-amber-200 rounded text-xs font-black text-amber-700">{t.salary_range}</span>
                        )}
                        {skills.slice(0, 4).map((sk: string, i: number) => (
                          <span key={i} className="px-2 py-0.5 bg-indigo-50 border border-indigo-100 rounded text-[10px] font-bold text-indigo-600">{sk}</span>
                        ))}
                        {skills.length > 4 && (
                          <span className="px-2 py-0.5 bg-slate-50 border border-slate-200 rounded text-[10px] font-bold text-slate-400">+{skills.length - 4}</span>
                        )}
                      </div>
                    </div>
                  </div>

                  <div className="flex items-center gap-2 flex-shrink-0">
                    {invitedIds.has(t.id) ? (
                      <div className="relative group/invite">
                        <span className="bg-emerald-50 border border-emerald-200 text-emerald-700 px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-1.5 cursor-default">
                          <CheckCircle2 size={13} /> å·²é‚€è¯·
                        </span>
                        {inviteDetails[t.id] && (
                          <div
                            onClick={(e) => { e.stopPropagation(); navigate(`/workbench/flow/${inviteDetails[t.id].flow_id}`); }}
                            className="absolute right-0 top-full mt-2 w-64 bg-slate-900 text-white rounded-xl shadow-2xl p-4 z-50 opacity-0 invisible group-hover/invite:opacity-100 group-hover/invite:visible transition-all duration-200 text-xs cursor-pointer hover:bg-slate-800"
                          >
                            <div className="flex items-center gap-1.5 font-bold mb-2 text-emerald-300">
                              <CheckCircle2 size={12} /> AI é‚€è¯·è¯¦æƒ…
                            </div>
                            <p className="text-slate-300 mb-1">å²—ä½ï¼š<span className="text-indigo-300 font-bold">{inviteDetails[t.id].job_title}</span></p>
                            <div className="flex items-center gap-2 mb-1">
                              <span className="bg-emerald-500/20 text-emerald-300 px-1.5 py-0.5 rounded text-[10px] font-bold">åŒ¹é…åº¦ {inviteDetails[t.id].match_score}%</span>
                            </div>
                            {inviteDetails[t.id].details && <p className="text-slate-400 mt-1">{inviteDetails[t.id].details}</p>}
                            <p className="text-indigo-400 mt-2 font-bold flex items-center gap-1">æŸ¥çœ‹æ‹›è˜é˜Ÿåˆ— <ChevronRight size={11} /></p>
                            <div className="absolute -top-1.5 right-6 w-3 h-3 bg-slate-900 rotate-45"></div>
                          </div>
                        )}
                      </div>
                    ) : (
                      <button
                        onClick={(e) => handleQuickInvite(e, t.id)}
                        disabled={invitingId === t.id}
                        className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-1.5 transition-all shadow-sm active:scale-95 disabled:opacity-60"
                      >
                        {invitingId === t.id ? <Loader2 size={13} className="animate-spin" /> : <Sparkles size={13} />} {invitingId === t.id ? 'AI åˆ†æä¸­...' : 'AI é‚€è¯·'}
                      </button>
                    )}
                    <button
                      onClick={(e) => { e.stopPropagation(); navigate(`/candidate/profile/${t.id}`); }}
                      className="bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-1.5 transition-all"
                    >
                      æŸ¥çœ‹ <ChevronRight size={12} />
                    </button>
                  </div>
                </div>

                {t.summary && (
                  <div className="mt-3 pt-3 border-t border-slate-100">
                    <p className="text-xs text-slate-400 font-medium flex items-center gap-1.5 line-clamp-2">
                      <Zap size={11} className="text-amber-500 flex-shrink-0" />
                      {t.summary}
                    </p>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}

      {/* åˆ†é¡µ */}
      {totalPages > 1 && (
        <div className="flex items-center justify-center gap-2 mt-8">
          <button
            disabled={page <= 1}
            onClick={() => setPage(p => Math.max(1, p - 1))}
            className="px-3 py-2 rounded-lg border border-slate-200 text-sm font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
          >
            <ChevronLeft size={14} />
          </button>
          {Array.from({ length: Math.min(totalPages, 7) }, (_, i) => {
            let pageNum: number;
            if (totalPages <= 7) {
              pageNum = i + 1;
            } else if (page <= 4) {
              pageNum = i + 1;
            } else if (page >= totalPages - 3) {
              pageNum = totalPages - 6 + i;
            } else {
              pageNum = page - 3 + i;
            }
            return (
              <button
                key={pageNum}
                onClick={() => setPage(pageNum)}
                className={`w-9 h-9 rounded-lg text-sm font-bold transition-all ${
                  page === pageNum
                    ? 'bg-indigo-600 text-white shadow-sm'
                    : 'border border-slate-200 text-slate-600 hover:bg-slate-50'
                }`}
              >
                {pageNum}
              </button>
            );
          })}
          <button
            disabled={page >= totalPages}
            onClick={() => setPage(p => Math.min(totalPages, p + 1))}
            className="px-3 py-2 rounded-lg border border-slate-200 text-sm font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
          >
            <ChevronRight size={14} />
          </button>
          <span className="text-xs text-slate-400 font-bold ml-3">å…± {total} ä½</span>
        </div>
      )}

      {/* AI é‚€è¯·ç»“æœ Toast */}
      {inviteResult && (
        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 animate-in fade-in slide-in-from-bottom-4 duration-300">
          {inviteResult.success ? (
            <div className="bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl text-sm max-w-md">
              <div className="flex items-center gap-2 font-bold mb-2">
                <Sparkles size={15} className="text-amber-400" />
                <span>AI æ™ºèƒ½é‚€è¯·å®Œæˆ</span>
              </div>
              <div className="space-y-1 text-slate-300 text-xs">
                <p>å€™é€‰äºº <span className="text-white font-bold">{inviteResult.candidate_name}</span> â†’ å²—ä½ã€Œ<span className="text-indigo-300 font-bold">{inviteResult.job_title}</span>ã€</p>
                <div className="flex items-center gap-3 mt-1.5">
                  <span className="bg-emerald-500/20 text-emerald-300 px-2 py-0.5 rounded text-xs font-bold">åŒ¹é…åº¦ {inviteResult.match_score}%</span>
                  <span className="bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded text-xs font-bold">åŠ å…¥{inviteResult.ai_queue || 'æ™ºèƒ½ç­›é€‰é˜Ÿåˆ—'}</span>
                </div>
                {inviteResult.ai_reason && <p className="text-slate-400 mt-1">ğŸ’¡ {inviteResult.ai_reason}</p>}
                {inviteResult.tokens_used > 0 && <p className="text-slate-500 mt-1 text-[10px]">æ¶ˆè€— {inviteResult.tokens_used} tokens Â· {inviteResult.model_name || 'AI'}</p>}
              </div>
            </div>
          ) : (
            <div className="bg-slate-900 text-white px-6 py-3 rounded-xl shadow-2xl text-sm font-bold flex items-center gap-2">
              <XCircle size={16} className="text-red-400" />
              {inviteResult.message}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// --- éšç§æ”¿ç­–é¡µé¢ ---
const PrivacyPolicyView = () => {
  const navigate = useNavigate();
  return (
    <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 max-w-4xl mx-auto animate-in fade-in duration-500">
      <div className="mb-10">
        <button onClick={() => navigate(-1)} className="inline-flex items-center gap-1.5 text-sm text-indigo-600 hover:text-indigo-800 font-medium transition-colors mb-8 group">
          <ChevronLeft size={16} className="group-hover:-translate-x-0.5 transition-transform" /> è¿”å›
        </button>
        <h1 className="text-3xl md:text-[40px] font-bold text-slate-900 tracking-tight leading-tight mb-3">éšç§æ”¿ç­–</h1>
        <p className="text-slate-400 text-sm font-medium tracking-wide">æ›´æ–°æ—¥æœŸï¼š2026 å¹´ 1 æœˆ 15 æ—¥ Â· ç”Ÿæ•ˆæ—¥æœŸï¼š2026 å¹´ 1 æœˆ 22 æ—¥</p>
        <div className="mt-8 h-px bg-gradient-to-r from-slate-200 via-slate-200 to-transparent" />
      </div>
      <div className="prose prose-slate max-w-none prose-headings:font-semibold prose-headings:tracking-tight prose-h2:text-[17px] prose-h2:mt-10 prose-h2:mb-5 prose-h2:pt-6 prose-h2:border-t prose-h2:border-slate-100 prose-h3:text-[15px] prose-h3:font-semibold prose-h3:mt-7 prose-h3:mb-3.5 prose-p:mb-5 prose-p:text-slate-500 prose-li:my-2 prose-li:text-slate-500 prose-ul:my-4 prose-ol:my-4 prose-li:marker:text-slate-300 prose-strong:text-slate-700 [&_p]:text-[15px] [&_p]:!leading-[2.1] [&_li]:text-[15px] [&_li]:!leading-[2.1]">
        <p className="text-[15px] text-slate-500 !leading-[2.1] mb-10 pb-8 border-b border-slate-100">
          æ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ï¼ˆä»¥ä¸‹ç®€ç§°"æˆ‘ä»¬"ï¼‰éå¸¸é‡è§†ç”¨æˆ·çš„éšç§ä¿æŠ¤ã€‚æœ¬éšç§æ”¿ç­–é€‚ç”¨äº Devnors å¾—è‹¥å¹³å°ï¼ˆåŒ…æ‹¬ç½‘é¡µç«¯ã€ç§»åŠ¨ç«¯åŠç›¸å…³æœåŠ¡ï¼Œä»¥ä¸‹ç®€ç§°"æœ¬å¹³å°"ï¼‰æä¾›çš„æ‰€æœ‰äº§å“å’ŒæœåŠ¡ã€‚è¯·æ‚¨åœ¨ä½¿ç”¨æˆ‘ä»¬çš„æœåŠ¡å‰ï¼Œä»”ç»†é˜…è¯»å¹¶å……åˆ†ç†è§£æœ¬æ”¿ç­–å…¨éƒ¨å†…å®¹ã€‚<strong>å¦‚æ‚¨ä¸åŒæ„æœ¬æ”¿ç­–ä¸­çš„ä»»ä½•æ¡æ¬¾ï¼Œè¯·åœæ­¢ä½¿ç”¨æœ¬å¹³å°æœåŠ¡ã€‚</strong>
        </p>

        <h2>ä¸€ã€é€‚ç”¨èŒƒå›´</h2>
        <p>æœ¬éšç§æ”¿ç­–é€‚ç”¨äº Devnors å¾—è‹¥å¹³å°åŠå…¶å…³è”äº§å“æä¾›çš„æ‰€æœ‰æœåŠ¡ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š</p>
        <ul>
          <li>Devnors å¾—è‹¥ç½‘é¡µç«¯ï¼ˆdevnors.com åŠç›¸å…³å­åŸŸåï¼‰</li>
          <li>Devnors å¾—è‹¥ç§»åŠ¨ç«¯ï¼ˆå¦‚æœ‰ï¼‰</li>
          <li>é€šè¿‡ API æ¥å£å‘ç¬¬ä¸‰æ–¹æä¾›çš„æœåŠ¡</li>
        </ul>
        <p>æœ¬æ”¿ç­–ä¸é€‚ç”¨äºé€šè¿‡æˆ‘ä»¬çš„æœåŠ¡é“¾æ¥åˆ°çš„ç¬¬ä¸‰æ–¹äº§å“æˆ–æœåŠ¡ã€‚ç¬¬ä¸‰æ–¹å¦‚ä½•æ”¶é›†ã€ä½¿ç”¨æ‚¨çš„ä¿¡æ¯ï¼Œè¯·å‚é˜…å…¶å„è‡ªçš„éšç§æ”¿ç­–ã€‚</p>

        <h2>äºŒã€ä¿¡æ¯æ”¶é›†</h2>
        <h3>2.1 æ‚¨ä¸»åŠ¨æä¾›çš„ä¿¡æ¯</h3>
        <p>åœ¨æ‚¨æ³¨å†Œã€ä½¿ç”¨æœ¬å¹³å°å„é¡¹åŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
        <ul>
          <li><strong>è´¦å·æ³¨å†Œä¿¡æ¯</strong>ï¼šæ‰‹æœºå·ç ï¼ˆç”¨äºæ³¨å†ŒéªŒè¯å’Œç™»å½•ï¼‰ã€ç™»å½•å¯†ç ï¼ˆå“ˆå¸ŒåŠ å¯†å­˜å‚¨ï¼Œä¸å¯é€†ï¼‰ã€ç”¨æˆ·æ˜µç§°</li>
          <li><strong>èº«ä»½è®¤è¯ä¿¡æ¯</strong>ï¼šçœŸå®å§“åã€èº«ä»½è¯å·ç ï¼ˆä»…ç”¨äºå®åè®¤è¯åœºæ™¯ï¼ŒAES åŠ å¯†å­˜å‚¨ï¼Œä»…åœ¨è®¤è¯å®¡æ ¸æ—¶è§£å¯†ä½¿ç”¨ï¼‰</li>
          <li><strong>æ±‚èŒè€…ä¿¡æ¯</strong>ï¼šç®€å†å†…å®¹ï¼ˆæ•™è‚²ç»å†ã€å·¥ä½œç»å†ã€é¡¹ç›®ç»éªŒï¼‰ã€æŠ€èƒ½æ ‡ç­¾ã€æ±‚èŒæ„å‘ã€æœŸæœ›è–ªèµ„ã€ä¸ªäººç®€ä»‹ã€å¤´åƒ</li>
          <li><strong>ä¼ä¸šæ–¹ä¿¡æ¯</strong>ï¼šä¼ä¸šåç§°ã€ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ã€è¥ä¸šæ‰§ç…§å½±åƒã€æ³•å®šä»£è¡¨äººä¿¡æ¯ã€ä¼ä¸šè§„æ¨¡ã€è¡Œä¸šç±»åˆ«ã€åŠå…¬åœ°å€ã€è”ç³»æ–¹å¼ã€ä¼ä¸šç®€ä»‹</li>
          <li><strong>èŒä½ä¿¡æ¯</strong>ï¼šèŒä½åç§°ã€å²—ä½æè¿°ã€ä»»èŒè¦æ±‚ã€è–ªèµ„èŒƒå›´ã€å·¥ä½œåœ°ç‚¹</li>
          <li><strong>è®°å¿†æ•°æ®</strong>ï¼šæ‚¨ä¸»åŠ¨å½•å…¥çš„æ±‚èŒåå¥½ã€æ‹›è˜åå¥½ã€æŠ€èƒ½ç‰¹é•¿ã€èŒä¸šç›®æ ‡ç­‰ä¸ªæ€§åŒ–ä¿¡æ¯</li>
          <li><strong>å¯¹è¯å†…å®¹</strong>ï¼šæ‚¨ä¸ AI åŠ©æ‰‹çš„å¯¹è¯è®°å½•ï¼ˆç”¨äºæä¾›è¿ç»­çš„å¯¹è¯æœåŠ¡ï¼‰</li>
          <li><strong>åé¦ˆä¿¡æ¯</strong>ï¼šæ‚¨é€šè¿‡å·¥å•ç³»ç»Ÿæäº¤çš„åé¦ˆæ ‡é¢˜ã€æè¿°å†…å®¹ã€è”ç³»æ–¹å¼</li>
        </ul>

        <h3>2.2 è‡ªåŠ¨æ”¶é›†çš„ä¿¡æ¯</h3>
        <p>åœ¨æ‚¨ä½¿ç”¨æœ¬å¹³å°æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½è‡ªåŠ¨æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ä»¥ä¿éšœæœåŠ¡å®‰å…¨å’Œä¼˜åŒ–ä½“éªŒï¼š</p>
        <ul>
          <li><strong>è®¾å¤‡ä¿¡æ¯</strong>ï¼šè®¾å¤‡å‹å·ã€æ“ä½œç³»ç»Ÿç±»å‹å’Œç‰ˆæœ¬ã€æµè§ˆå™¨ç±»å‹å’Œç‰ˆæœ¬ã€å±å¹•åˆ†è¾¨ç‡ã€è®¾å¤‡è¯­è¨€è®¾ç½®</li>
          <li><strong>ç½‘ç»œä¿¡æ¯</strong>ï¼šIP åœ°å€ï¼ˆç”¨äºå®‰å…¨å®¡è®¡å’Œå¼‚å¸¸æ£€æµ‹ï¼‰ã€ç½‘ç»œè¿è¥å•†ç±»å‹</li>
          <li><strong>æ—¥å¿—ä¿¡æ¯</strong>ï¼šè®¿é—®æ—¶é—´ã€é¡µé¢åœç•™æ—¶é•¿ã€ç‚¹å‡»æ“ä½œè®°å½•ã€åŠŸèƒ½ä½¿ç”¨è®°å½•ï¼ˆç”¨äºå®‰å…¨å®¡è®¡æ—¥å¿—ï¼‰</li>
          <li><strong>æœåŠ¡ä½¿ç”¨ä¿¡æ¯</strong>ï¼šAI æœåŠ¡è°ƒç”¨æ¬¡æ•°å’Œç±»å‹ã€Token æ¶ˆè€—æ˜ç»†ã€åŠŸèƒ½ä½¿ç”¨é¢‘ç‡ç»Ÿè®¡</li>
        </ul>

        <h3>2.3 Cookie å’Œç±»ä¼¼æŠ€æœ¯</h3>
        <p>æœ¬å¹³å°ä½¿ç”¨ Cookie å’Œæœ¬åœ°å­˜å‚¨ï¼ˆLocalStorageï¼‰æŠ€æœ¯æ¥ç»´æŒæ‚¨çš„ç™»å½•çŠ¶æ€å’Œåå¥½è®¾ç½®ã€‚å…·ä½“åŒ…æ‹¬ï¼š</p>
        <ul>
          <li><strong>å¿…è¦ Cookie</strong>ï¼šç»´æŒç™»å½•ä¼šè¯ã€è®°å½•è®¤è¯çŠ¶æ€ï¼ˆæ— æ³•å…³é—­ï¼‰</li>
          <li><strong>åŠŸèƒ½ Cookie</strong>ï¼šè®°å½•æ‚¨çš„åå¥½è®¾ç½®ï¼ˆå¦‚ä¸»é¢˜æ¨¡å¼ã€è¯­è¨€é€‰æ‹©ï¼‰</li>
          <li><strong>åˆ†æ Cookie</strong>ï¼šç»Ÿè®¡é¡µé¢è®¿é—®é‡å’ŒåŠŸèƒ½ä½¿ç”¨ç‡ï¼Œç”¨äºæœåŠ¡æ”¹è¿›</li>
        </ul>
        <p>æ‚¨å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¾ç½®æ¸…é™¤æˆ–ç¦ç”¨ Cookieï¼Œä½†è¿™å¯èƒ½å¯¼è‡´éƒ¨åˆ†åŠŸèƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚</p>

        <h2>ä¸‰ã€ä¿¡æ¯ä½¿ç”¨</h2>
        <p>æˆ‘ä»¬ä¸¥æ ¼éµå¾ªåˆæ³•ã€æ­£å½“ã€å¿…è¦çš„åŸåˆ™ä½¿ç”¨æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼Œå…·ä½“ç”¨é€”åŒ…æ‹¬ï¼š</p>
        <ul>
          <li><strong>æä¾›æ ¸å¿ƒæœåŠ¡</strong>ï¼šè´¦å·æ³¨å†Œä¸ç™»å½•éªŒè¯ã€èº«ä»½è®¤è¯ã€å²—ä½å‘å¸ƒä¸å±•ç¤ºã€ç®€å†æŠ•é€’ä¸æ¥æ”¶</li>
          <li><strong>AI æ™ºèƒ½æœåŠ¡</strong>ï¼šåŸºäºæ‚¨çš„ç®€å†/å²—ä½/è®°å¿†ä¿¡æ¯è¿›è¡Œæ™ºèƒ½åŒ¹é…æ¨èã€AI å¯¹è¯æœåŠ¡ã€ç®€å†è§£æã€é¢è¯•è¾…å¯¼</li>
          <li><strong>æœåŠ¡è®¡è´¹</strong>ï¼šToken ä½™é¢ç®¡ç†ã€æ¶ˆè€—è®°å½•ã€å……å€¼ä¸æ‰£è´¹å¤„ç†</li>
          <li><strong>æ¶ˆæ¯é€šçŸ¥</strong>ï¼šå‘é€åŒ¹é…é€šçŸ¥ã€æµç¨‹çŠ¶æ€å˜æ›´ã€ç³»ç»Ÿå…¬å‘Šã€å®‰å…¨æé†’ç­‰é‡è¦é€šçŸ¥</li>
          <li><strong>å®‰å…¨ä¿éšœ</strong>ï¼šèº«ä»½éªŒè¯ã€å¼‚å¸¸è¡Œä¸ºæ£€æµ‹ã€åæ¬ºè¯ˆã€å®‰å…¨å®¡è®¡</li>
          <li><strong>æœåŠ¡ä¼˜åŒ–</strong>ï¼šåˆ†ææ±‡æ€»åçš„ä½¿ç”¨ç»Ÿè®¡æ•°æ®ï¼ˆä¸å«ä¸ªäººèº«ä»½ä¿¡æ¯ï¼‰ï¼Œç”¨äºæ”¹è¿›äº§å“åŠŸèƒ½å’Œç”¨æˆ·ä½“éªŒ</li>
          <li><strong>æ³•å¾‹åˆè§„</strong>ï¼šéµå®ˆæ³•å¾‹æ³•è§„è¦æ±‚ï¼Œé…åˆå¸æ³•æˆ–è¡Œæ”¿æœºå…³çš„ä¾æ³•æŸ¥è¯¢</li>
        </ul>
        <p><strong>æˆ‘ä»¬ä¸ä¼šå°†æ‚¨çš„ä¸ªäººä¿¡æ¯ç”¨äºä¸ä¸Šè¿°ç›®çš„æ— å…³çš„å…¶ä»–ç”¨é€”ã€‚</strong>å¦‚éœ€å˜æ›´ç”¨é€”ï¼Œå°†å†æ¬¡å¾å¾—æ‚¨çš„åŒæ„ã€‚</p>

        <h2>å››ã€ä¿¡æ¯å…±äº«ä¸æŠ«éœ²</h2>
        <p><strong>æˆ‘ä»¬æ‰¿è¯ºä¸ä¼šå°†æ‚¨çš„ä¸ªäººä¿¡æ¯å‡ºå”®ç»™ä»»ä½•ç¬¬ä¸‰æ–¹ã€‚</strong>åœ¨ä»¥ä¸‹æƒ…å½¢ä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½å…±äº«æˆ–æŠ«éœ²æ‚¨çš„ä¿¡æ¯ï¼š</p>
        <h3>4.1 åŸºäºæ‚¨çš„æˆæƒåŒæ„</h3>
        <ul>
          <li><strong>æ‹›è˜åŒ¹é…å±•ç¤º</strong>ï¼šç»æ‚¨æŠ•é€’æˆ–è¢«é‚€è¯·åï¼Œå‘åŒ¹é…çš„ä¼ä¸šæ–¹æˆ–æ±‚èŒè€…å±•ç¤ºæ‚¨çš„å…¬å¼€ä¿¡æ¯ã€‚å±•ç¤ºå†…å®¹ä¸å«æ‰‹æœºå·ã€èº«ä»½è¯å·ç­‰æ•æ„Ÿä¿¡æ¯</li>
          <li><strong>è”ç³»æ–¹å¼äº¤æ¢</strong>ï¼šä»…åœ¨åŒæ–¹å‡ç¡®è®¤æ„å‘ã€é€šè¿‡å¹³å°"è”ç³»æ–¹å¼äº¤æ¢"æµç¨‹åï¼Œæ–¹å¯äº’ç›¸æŸ¥çœ‹è”ç³»æ–¹å¼ã€‚æ­¤è¿‡ç¨‹éœ€åŒæ–¹æ˜ç¡®æ“ä½œç¡®è®¤</li>
        </ul>
        <h3>4.2 ä¸ç¬¬ä¸‰æ–¹æœåŠ¡å•†å…±äº«</h3>
        <ul>
          <li><strong>AI æ¨¡å‹æœåŠ¡å•†</strong>ï¼šæ‚¨çš„ç®€å†æ–‡æœ¬ã€å¯¹è¯å†…å®¹å¯èƒ½å‘é€è‡³ AI æ¨¡å‹æœåŠ¡å•†ï¼ˆå¦‚ MiniMaxï¼‰ç”¨äºå®æ—¶åˆ†æå¤„ç†ã€‚æˆ‘ä»¬å·²ä¸æœåŠ¡å•†ç­¾è®¢æ•°æ®ä¿æŠ¤åè®®ï¼Œç¡®ä¿å…¶ä¸ä¼šå­˜å‚¨æˆ–äºŒæ¬¡ä½¿ç”¨æ‚¨çš„æ•°æ®</li>
          <li><strong>æ”¯ä»˜æœåŠ¡å•†</strong>ï¼šåœ¨æ‚¨å……å€¼ Token æ—¶ï¼Œæ”¯ä»˜ä¿¡æ¯ç”±æŒç‰Œæ”¯ä»˜æœºæ„å¤„ç†ï¼Œæˆ‘ä»¬ä¸ç›´æ¥å­˜å‚¨æ‚¨çš„é“¶è¡Œå¡ç­‰æ”¯ä»˜è´¦æˆ·ä¿¡æ¯</li>
        </ul>
        <h3>4.3 åŸºäºæ³•å¾‹è¦æ±‚</h3>
        <ul>
          <li>æ ¹æ®æ³•å¾‹æ³•è§„çš„å¼ºåˆ¶æ€§è§„å®š</li>
          <li>æ ¹æ®å¸æ³•æœºå…³æˆ–è¡Œæ”¿æœºå…³çš„æœ‰æ•ˆæ³•å¾‹æ–‡ä¹¦</li>
          <li>ä¸ºä¿æŠ¤æœ¬å…¬å¸ã€ç”¨æˆ·æˆ–å…¬ä¼—çš„åˆæ³•æƒç›Šæ‰€å¿…éœ€</li>
        </ul>

        <h2>äº”ã€AI æœåŠ¡ä¸æ•°æ®å¤„ç†ä¸“é¡¹è¯´æ˜</h2>
        <p>é‰´äºæœ¬å¹³å°æ·±åº¦ä½¿ç”¨äººå·¥æ™ºèƒ½æŠ€æœ¯ï¼Œæˆ‘ä»¬ä½œå¦‚ä¸‹ä¸“é¡¹è¯´æ˜ï¼š</p>
        <h3>5.1 AI æ•°æ®å¤„ç†èŒƒå›´</h3>
        <ul>
          <li><strong>ç®€å†è§£æ</strong>ï¼šæ‚¨ä¸Šä¼ çš„ç®€å†æ–‡ä»¶å°†å‘é€è‡³ AI æ¨¡å‹è¿›è¡Œæ–‡æœ¬æå–å’Œç»“æ„åŒ–å¤„ç†</li>
          <li><strong>æ™ºèƒ½åŒ¹é…</strong>ï¼šå€™é€‰äººç®€å†æ‘˜è¦å’Œå²—ä½æè¿°å°†å‘é€è‡³ AI æ¨¡å‹è¿›è¡ŒåŒ¹é…åº¦åˆ†æ</li>
          <li><strong>AI å¯¹è¯</strong>ï¼šæ‚¨çš„å½“å‰å¯¹è¯æ¶ˆæ¯åŠæœ€è¿‘æ•°è½®å†å²æ¶ˆæ¯å°†å‘é€è‡³ AI æ¨¡å‹ç”Ÿæˆå›å¤</li>
          <li><strong>å¸®åŠ©é—®ç­”</strong>ï¼šæ‚¨åœ¨å¸®åŠ©ä¸­å¿ƒçš„æé—®å°†å‘é€è‡³ AI æ¨¡å‹ï¼Œç»“åˆå¹³å°æ–‡æ¡£ç”Ÿæˆå›ç­”</li>
        </ul>
        <h3>5.2 AI æ•°æ®ä¿æŠ¤æªæ–½</h3>
        <ul>
          <li>å‘é€è‡³ AI æœåŠ¡å•†çš„æ•°æ®ä»…ç”¨äºå®æ—¶è¯·æ±‚å¤„ç†ï¼Œå¤„ç†å®Œæˆåå³é‡Šæ”¾ï¼Œä¸ä¼šè¢«é•¿æœŸå­˜å‚¨</li>
          <li>AI æœåŠ¡å•†ä¸ä¼šå°†æ‚¨çš„æ•°æ®ç”¨äºæ¨¡å‹è®­ç»ƒæˆ–å…¶ä»–ç›®çš„</li>
          <li>ä¼ è¾“è¿‡ç¨‹å…¨ç¨‹ä½¿ç”¨ HTTPS åŠ å¯†</li>
          <li>æ¯æ¬¡ AI è°ƒç”¨å‡æœ‰å®Œæ•´çš„å®¡è®¡æ—¥å¿—è®°å½•ï¼ˆè°ƒç”¨æ—¶é—´ã€Token æ¶ˆè€—ã€æ¨¡å‹åç§°ï¼‰</li>
        </ul>
        <h3>5.3 AI ç»“æœå£°æ˜</h3>
        <ul>
          <li>AI ç”Ÿæˆçš„åŒ¹é…åˆ†æ•°ã€åˆ†ææŠ¥å‘Šå’Œå»ºè®®<strong>ä»…ä¾›å‚è€ƒ</strong>ï¼Œä¸æ„æˆä»»ä½•æ‰¿è¯ºæˆ–ä¿è¯</li>
          <li>å½•ç”¨ã€é¢è¯•ç­‰æœ€ç»ˆå†³ç­–æƒå®Œå…¨å½’ç”¨æˆ·æ‰€æœ‰</li>
          <li>AI ç”Ÿæˆå†…å®¹ä¸­æ ‡æ³¨"AI åˆ†æç»“æœ"å­—æ ·ä»¥ç¤ºåŒºåˆ†</li>
        </ul>

        <h2>å…­ã€ä¿¡æ¯å®‰å…¨</h2>
        <p>æˆ‘ä»¬é‡‡å–ä¸šç•Œé€šè¡Œçš„å¤šå±‚æ¬¡å®‰å…¨æªæ–½ä¿æŠ¤æ‚¨çš„ä¿¡æ¯ï¼š</p>
        <h3>6.1 æŠ€æœ¯æªæ–½</h3>
        <ul>
          <li>ç”¨æˆ·å¯†ç ä½¿ç”¨ bcrypt å“ˆå¸Œç®—æ³•åŠ å¯†å­˜å‚¨ï¼Œä¸å¯é€†è§£å¯†</li>
          <li>èº«ä»½è¯å·ã€è¥ä¸šæ‰§ç…§å·ç­‰æ•æ„Ÿä¿¡æ¯ä½¿ç”¨ AES-256 åŠ å¯†å­˜å‚¨</li>
          <li>æ•°æ®ä¼ è¾“å…¨ç¨‹ä½¿ç”¨ HTTPS/TLS åŠ å¯†</li>
          <li>æ•°æ®åº“è®¿é—®é‡‡ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œé˜²æ­¢ SQL æ³¨å…¥æ”»å‡»</li>
        </ul>
        <h3>6.2 ç®¡ç†æªæ–½</h3>
        <ul>
          <li>å®Œæ•´çš„å®‰å…¨å®¡è®¡æ—¥å¿—ç³»ç»Ÿï¼Œè®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œ</li>
          <li>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶æœºåˆ¶ï¼ˆRBACï¼‰ï¼Œæœ€å°æƒé™åŸåˆ™</li>
          <li>å‘˜å·¥è®¿é—®ç”¨æˆ·æ•°æ®éœ€ç»å®¡æ‰¹å¹¶ç•™å­˜è®°å½•</li>
          <li>å®šæœŸè¿›è¡Œå®‰å…¨é£é™©è¯„ä¼°å’Œæ¼æ´æ‰«æ</li>
        </ul>
        <h3>6.3 å®‰å…¨äº‹ä»¶å“åº”</h3>
        <p>å¦‚å‘ç”Ÿä¸ªäººä¿¡æ¯å®‰å…¨äº‹ä»¶ï¼Œæˆ‘ä»¬å°†æŒ‰ç…§æ³•å¾‹è§„å®šåŠæ—¶å‘æœ‰å…³éƒ¨é—¨æŠ¥å‘Šï¼Œå¹¶é€šè¿‡ç«™å†…é€šçŸ¥æˆ–æ¶ˆæ¯ä¸­å¿ƒå‘ŠçŸ¥å—å½±å“ç”¨æˆ·ï¼Œå†…å®¹åŒ…æ‹¬ï¼šäº‹ä»¶åŸå› ã€å·²é‡‡å–çš„è¡¥æ•‘æªæ–½ã€ç”¨æˆ·å¯é‡‡å–çš„é˜²æŠ¤å»ºè®®ã€‚</p>

        <h2>ä¸ƒã€ä¿¡æ¯å­˜å‚¨</h2>
        <ul>
          <li><strong>å­˜å‚¨åœ°ç‚¹</strong>ï¼šæ‚¨çš„ä¸ªäººä¿¡æ¯å­˜å‚¨åœ¨ä¸­åäººæ°‘å…±å’Œå›½å¢ƒå†…çš„äº‘æœåŠ¡å™¨ã€‚å¦‚æ¶‰åŠè·¨å¢ƒä¼ è¾“ï¼ˆå¦‚è°ƒç”¨å¢ƒå¤– AI æ¨¡å‹æœåŠ¡ï¼‰ï¼Œæˆ‘ä»¬å°†æŒ‰ç…§ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ç›¸å…³è§„å®šå¤„ç†</li>
          <li><strong>å­˜å‚¨æœŸé™</strong>ï¼šåœ¨æ‚¨ä½¿ç”¨æœ¬å¹³å°æœŸé—´æŒç»­ä¿å­˜ã€‚è´¦æˆ·æ³¨é”€åï¼Œæˆ‘ä»¬å°†åœ¨ 30 æ—¥å†…åˆ é™¤æˆ–åŒ¿ååŒ–å¤„ç†æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼Œæ³•å¾‹æ³•è§„å¦æœ‰è§„å®šçš„é™¤å¤–</li>
          <li><strong>è´¦æˆ·æ³¨é”€</strong>ï¼šæ‚¨å¯é€šè¿‡ã€Œåé¦ˆå»ºè®®ã€åŠŸèƒ½ç”³è¯·æ³¨é”€è´¦æˆ·ã€‚æ³¨é”€åï¼Œè´¦æˆ·æ•°æ®ä¸å¯æ¢å¤ï¼Œæœªä½¿ç”¨çš„ä»˜è´¹ Token å°†ä¸äºˆé€€è¿˜</li>
        </ul>

        <h2>å…«ã€æ‚¨çš„æƒåˆ©</h2>
        <p>æ ¹æ®ã€Šä¸­åäººæ°‘å…±å’Œå›½ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ï¼Œæ‚¨äº«æœ‰ä»¥ä¸‹æƒåˆ©ï¼š</p>
        <ul>
          <li><strong>çŸ¥æƒ…æƒä¸å†³å®šæƒ</strong>ï¼šäº†è§£æˆ‘ä»¬æ”¶é›†ã€ä½¿ç”¨ä¸ªäººä¿¡æ¯çš„è§„åˆ™ï¼Œå¹¶æœ‰æƒå†³å®šæ˜¯å¦åŒæ„</li>
          <li><strong>æŸ¥é˜…å¤åˆ¶æƒ</strong>ï¼šæ‚¨å¯åœ¨ã€Œç³»ç»Ÿè®¾ç½® â†’ è´¦å·ä¿¡æ¯ã€ä¸­æŸ¥é˜…å·²æäº¤çš„ä¸ªäººä¿¡æ¯</li>
          <li><strong>æ›´æ­£è¡¥å……æƒ</strong>ï¼šå‘ç°ä¸ªäººä¿¡æ¯ä¸å‡†ç¡®æˆ–ä¸å®Œæ•´æ—¶ï¼Œæœ‰æƒè¦æ±‚æ›´æ­£æˆ–è¡¥å……</li>
          <li><strong>åˆ é™¤æƒ</strong>ï¼šåœ¨ä»¥ä¸‹æƒ…å½¢ä¸­æœ‰æƒè¦æ±‚åˆ é™¤â€”â€”å¤„ç†ç›®çš„å·²å®ç°ã€æ‚¨æ’¤å›åŒæ„ã€æˆ‘ä»¬è¿åæ³•å¾‹æˆ–åè®®çº¦å®š</li>
          <li><strong>å¯æºå¸¦æƒ</strong>ï¼šæœ‰æƒè¯·æ±‚å°†ä¸ªäººä¿¡æ¯è½¬ç§»è‡³æ‚¨æŒ‡å®šçš„å…¶ä»–ä¸ªäººä¿¡æ¯å¤„ç†è€…ï¼ˆç¬¦åˆå›½å®¶ç½‘ä¿¡éƒ¨é—¨è§„å®šæ¡ä»¶æ—¶ï¼‰</li>
          <li><strong>æ’¤å›åŒæ„æƒ</strong>ï¼šæ‚¨å¯éšæ—¶æ’¤å›æ­¤å‰ç»™äºˆçš„åŒæ„ï¼Œæ’¤å›ä¸å½±å“æ’¤å›å‰å·²è¿›è¡Œçš„åˆæ³•å¤„ç†</li>
          <li><strong>è‡ªåŠ¨åŒ–å†³ç­–æ‹’ç»æƒ</strong>ï¼šå¯¹äº AI ç®—æ³•æ¨èç»“æœï¼Œæ‚¨æœ‰æƒè¦æ±‚è¯´æ˜å†³ç­–é€»è¾‘ï¼Œå¹¶æœ‰æƒæ‹’ç»ä»…åŸºäºè‡ªåŠ¨åŒ–å†³ç­–åšå‡ºçš„å¯¹æ‚¨æƒç›Šæœ‰é‡å¤§å½±å“çš„å†³å®š</li>
          <li><strong>é€è€…è¿‘äº²å±æƒåˆ©</strong>ï¼šè‡ªç„¶äººæ­»äº¡åï¼Œå…¶è¿‘äº²å±å¯ä¾æ³•å¯¹å…¶ä¸ªäººä¿¡æ¯è¡Œä½¿æŸ¥é˜…ã€å¤åˆ¶ã€æ›´æ­£ã€åˆ é™¤ç­‰æƒåˆ©</li>
        </ul>
        <p>å¦‚æ‚¨è¡Œä½¿ä¸Šè¿°æƒåˆ©ï¼Œè¯·é€šè¿‡ã€Œåé¦ˆå»ºè®®ã€åŠŸèƒ½æäº¤ç”³è¯·ï¼Œæˆ‘ä»¬å°†åœ¨ 15 ä¸ªå·¥ä½œæ—¥å†…å¤„ç†å¹¶å›å¤ã€‚</p>

        <h2>ä¹ã€æœªæˆå¹´äººä¿¡æ¯ä¿æŠ¤</h2>
        <p>æœ¬å¹³å°é¢å‘å¹´æ»¡ 18 å‘¨å²çš„æˆå¹´äººæä¾›æœåŠ¡ã€‚æˆ‘ä»¬ä¸ä¼šæ•…æ„æ”¶é›†æœªæ»¡ 14 å‘¨å²å„¿ç«¥çš„ä¸ªäººä¿¡æ¯ã€‚å¦‚æˆ‘ä»¬å‘ç°åœ¨æœªè·å¾—ç›‘æŠ¤äººåŒæ„çš„æƒ…å†µä¸‹æ”¶é›†äº†å„¿ç«¥ä¸ªäººä¿¡æ¯ï¼Œå°†å°½å¿«åˆ é™¤ã€‚è¯¦è§ã€Šæœªæˆå¹´äººä¿æŠ¤å£°æ˜ã€‹ã€‚</p>

        <h2>åã€æ”¿ç­–æ›´æ–°</h2>
        <p>æˆ‘ä»¬å¯èƒ½ä¼šé€‚æ—¶ä¿®è®¢æœ¬éšç§æ”¿ç­–ã€‚å¯¹äºé‡å¤§å˜æ›´ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºæ”¶é›†ä¿¡æ¯èŒƒå›´å˜åŒ–ã€ä½¿ç”¨ç›®çš„å˜æ›´ã€ç¬¬ä¸‰æ–¹å…±äº«è§„åˆ™è°ƒæ•´ï¼‰ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä»¥ä¸‹æ–¹å¼é€šçŸ¥æ‚¨ï¼š</p>
        <ul>
          <li>åœ¨å¹³å°æ˜¾è‘—ä½ç½®å‘å¸ƒå…¬å‘Š</li>
          <li>é€šè¿‡æ¶ˆæ¯ä¸­å¿ƒå‘é€é€šçŸ¥</li>
          <li>åœ¨æ‚¨ä¸‹æ¬¡ç™»å½•æ—¶å¼¹çª—æç¤º</li>
        </ul>
        <p>å¦‚æ‚¨åœ¨æ”¿ç­–æ›´æ–°ç”Ÿæ•ˆåç»§ç»­ä½¿ç”¨æœ¬å¹³å°ï¼Œå³è§†ä¸ºåŒæ„æ›´æ–°åçš„æ”¿ç­–ã€‚å¦‚æ‚¨ä¸åŒæ„ï¼Œåº”åœæ­¢ä½¿ç”¨å¹¶ç”³è¯·æ³¨é”€è´¦æˆ·ã€‚</p>

        <h2>åä¸€ã€è”ç³»æˆ‘ä»¬</h2>
        <p>å¦‚æ‚¨å¯¹æœ¬éšç§æ”¿ç­–æœ‰ä»»ä½•ç–‘é—®ã€å»ºè®®æˆ–æŠ•è¯‰ï¼Œæˆ–éœ€è¦è¡Œä½¿ä¸ªäººä¿¡æ¯æƒåˆ©ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æˆ‘ä»¬ï¼š</p>
        <ul>
          <li><strong>å…¬å¸å…¨ç§°</strong>ï¼šæ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸</li>
          <li><strong>å¹³å°åé¦ˆ</strong>ï¼šé€šè¿‡æœ¬å¹³å°ã€Œåé¦ˆå»ºè®®ã€åŠŸèƒ½æäº¤å·¥å•</li>
          <li><strong>å¤„ç†æ—¶é™</strong>ï¼šæˆ‘ä»¬å°†åœ¨ 15 ä¸ªå·¥ä½œæ—¥å†…å—ç†å¹¶å›å¤æ‚¨çš„è¯·æ±‚</li>
        </ul>
        <p>å¦‚æ‚¨å¯¹æˆ‘ä»¬çš„å›å¤ä¸æ»¡æ„ï¼Œå¯å‘æ­å·å¸‚äº’è”ç½‘ä¿¡æ¯åŠå…¬å®¤æˆ–ç›¸å…³ç›‘ç®¡éƒ¨é—¨æŠ•è¯‰ä¸¾æŠ¥ã€‚</p>
      </div>
    </div>
  );
};

// --- æœåŠ¡æ¡æ¬¾é¡µé¢ ---
const TermsOfServiceView = () => {
  const navigate = useNavigate();
  return (
    <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 max-w-4xl mx-auto animate-in fade-in duration-500">
      <div className="mb-10">
        <button onClick={() => navigate(-1)} className="inline-flex items-center gap-1.5 text-sm text-indigo-600 hover:text-indigo-800 font-medium transition-colors mb-8 group">
          <ChevronLeft size={16} className="group-hover:-translate-x-0.5 transition-transform" /> è¿”å›
        </button>
        <h1 className="text-3xl md:text-[40px] font-bold text-slate-900 tracking-tight leading-tight mb-3">æœåŠ¡æ¡æ¬¾</h1>
        <p className="text-slate-400 text-sm font-medium tracking-wide">æ›´æ–°æ—¥æœŸï¼š2026 å¹´ 1 æœˆ 15 æ—¥ Â· ç”Ÿæ•ˆæ—¥æœŸï¼š2026 å¹´ 1 æœˆ 22 æ—¥</p>
        <div className="mt-8 h-px bg-gradient-to-r from-slate-200 via-slate-200 to-transparent" />
      </div>
      <div className="prose prose-slate max-w-none prose-headings:font-semibold prose-headings:tracking-tight prose-h2:text-[17px] prose-h2:mt-10 prose-h2:mb-5 prose-h2:pt-6 prose-h2:border-t prose-h2:border-slate-100 prose-h3:text-[15px] prose-h3:font-semibold prose-h3:mt-7 prose-h3:mb-3.5 prose-p:mb-5 prose-p:text-slate-500 prose-li:my-2 prose-li:text-slate-500 prose-ul:my-4 prose-ol:my-4 prose-li:marker:text-slate-300 prose-strong:text-slate-700 [&_p]:text-[15px] [&_p]:!leading-[2.1] [&_li]:text-[15px] [&_li]:!leading-[2.1]">
        <p className="text-[15px] text-slate-500 !leading-[2.1] mb-10 pb-8 border-b border-slate-100">
          æ¬¢è¿ä½¿ç”¨ Devnors å¾—è‹¥å¹³å°ï¼ˆåŒ…æ‹¬ç½‘é¡µç«¯ã€ç§»åŠ¨ç«¯åŠç›¸å…³æœåŠ¡ï¼Œä»¥ä¸‹ç®€ç§°"æœ¬å¹³å°"ï¼‰ã€‚æœ¬ç”¨æˆ·æœåŠ¡åè®®ï¼ˆä»¥ä¸‹ç®€ç§°"æœ¬åè®®"ï¼‰æ˜¯æ‚¨ä¸æ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ï¼ˆä»¥ä¸‹ç®€ç§°"æˆ‘ä»¬"æˆ–"å¹³å°æ–¹"ï¼‰ä¹‹é—´å°±æ³¨å†Œã€ç™»å½•å’Œä½¿ç”¨æœ¬å¹³å°æœåŠ¡æ‰€è®¢ç«‹çš„åè®®ï¼Œå…·æœ‰åˆåŒæ•ˆåŠ›ã€‚<strong>è¯·æ‚¨åœ¨æ³¨å†Œæˆ–ä½¿ç”¨æœ¬å¹³å°å‰ï¼Œä»”ç»†é˜…è¯»å¹¶å……åˆ†ç†è§£æœ¬åè®®å…¨éƒ¨æ¡æ¬¾ã€‚ç‚¹å‡»"æ³¨å†Œ"æˆ–ä»¥å…¶ä»–æ–¹å¼ä½¿ç”¨æœ¬å¹³å°ï¼Œå³è§†ä¸ºæ‚¨å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„æ¥å—æœ¬åè®®çº¦æŸã€‚</strong>
        </p>

        <h2>ä¸€ã€å®šä¹‰</h2>
        <ul>
          <li><strong>"æœ¬å¹³å°"</strong>ï¼šæŒ‡ Devnors å¾—è‹¥æ™ºèƒ½æ‹›è˜å¹³å°ï¼ŒåŒ…æ‹¬ devnors.com ç½‘é¡µç«¯åŠç›¸å…³å­åŸŸåã€ç§»åŠ¨ç«¯åº”ç”¨ï¼ˆå¦‚æœ‰ï¼‰ã€API æ¥å£æœåŠ¡</li>
          <li><strong>"ç”¨æˆ·"</strong>ï¼šæŒ‡æ³¨å†Œå¹¶ä½¿ç”¨æœ¬å¹³å°æœåŠ¡çš„è‡ªç„¶äººæˆ–æ³•äººï¼ŒåŒ…æ‹¬æ±‚èŒè€…ç”¨æˆ·å’Œä¼ä¸šæ–¹ç”¨æˆ·</li>
          <li><strong>"æ±‚èŒè€…"</strong>ï¼šæŒ‡ä½¿ç”¨æœ¬å¹³å°æ±‚èŒç›¸å…³åŠŸèƒ½çš„ä¸ªäººç”¨æˆ·</li>
          <li><strong>"ä¼ä¸šæ–¹"</strong>ï¼šæŒ‡ä½¿ç”¨æœ¬å¹³å°å‘å¸ƒèŒä½ã€æ‹›è˜äººæ‰çš„ä¼ä¸šæˆ–ç»„ç»‡ç”¨æˆ·</li>
          <li><strong>"Token"</strong>ï¼šæŒ‡æœ¬å¹³å°çš„ AI æœåŠ¡æ¶ˆè€—è®¡é‡å•ä½</li>
          <li><strong>"AI æœåŠ¡"</strong>ï¼šæŒ‡æœ¬å¹³å°æä¾›çš„åŸºäºäººå·¥æ™ºèƒ½æŠ€æœ¯çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ™ºèƒ½åŒ¹é…ã€ç®€å†è§£æã€AI å¯¹è¯ã€å¸®åŠ©é—®ç­”ç­‰</li>
        </ul>

        <h2>äºŒã€æœåŠ¡å†…å®¹</h2>
        <p>æœ¬å¹³å°æä¾›ä»¥ä¸‹æœåŠ¡ï¼š</p>
        <h3>2.1 åŸºç¡€æœåŠ¡</h3>
        <ul>
          <li>ç”¨æˆ·æ³¨å†Œä¸è´¦æˆ·ç®¡ç†ã€èº«ä»½åˆ‡æ¢ï¼ˆæ±‚èŒè€…/ä¼ä¸šæ–¹ï¼‰</li>
          <li>èŒä½å‘å¸ƒä¸ç®¡ç†ã€ç®€å†åˆ›å»ºä¸æŠ•é€’</li>
          <li>æ‹›è˜é˜Ÿåˆ—ç®¡ç†ï¼ˆFlow å·¥ä½œæµï¼‰</li>
          <li>æ¶ˆæ¯é€šçŸ¥ä¸åé¦ˆå·¥å•ç³»ç»Ÿ</li>
        </ul>
        <h3>2.2 AI å¢å€¼æœåŠ¡ï¼ˆæ¶ˆè€— Tokenï¼‰</h3>
        <ul>
          <li>AI æ™ºèƒ½åŒ¹é…ä¸æ¨èï¼ˆå²—ä½æ¨èã€äººæ‰æ¨èï¼‰</li>
          <li>AI æ™ºèƒ½æŠ•é€’ä¸é‚€è¯·ï¼ˆè‡ªåŠ¨åŒ¹é…åˆ†æï¼‰</li>
          <li>AI åŠ©æ‰‹å¯¹è¯ï¼ˆæ‹›è˜å’¨è¯¢ã€ç®€å†ä¼˜åŒ–ã€é¢è¯•è¾…å¯¼ã€èŒä¸šè§„åˆ’ï¼‰</li>
          <li>AI ç®€å†è§£æï¼ˆPDF/Word æ–‡ä»¶è‡ªåŠ¨æå–ç»“æ„åŒ–æ•°æ®ï¼‰</li>
          <li>AI å¸®åŠ©ä¸­å¿ƒé—®ç­”</li>
        </ul>
        <h3>2.3 è®°å¿†ç³»ç»Ÿ</h3>
        <ul>
          <li>ä¸ªæ€§åŒ–åå¥½å­˜å‚¨ï¼Œç”¨äºæå‡ AI æ¨èç²¾å‡†åº¦</li>
        </ul>

        <h2>ä¸‰ã€è´¦æˆ·æ³¨å†Œä¸ç®¡ç†</h2>
        <h3>3.1 æ³¨å†Œèµ„æ ¼</h3>
        <ul>
          <li>æ‚¨é¡»å¹´æ»¡ 18 å‘¨å²ä¸”å…·æœ‰å®Œå…¨æ°‘äº‹è¡Œä¸ºèƒ½åŠ›ã€‚å¹´æ»¡ 16 å‘¨å²ä¸æ»¡ 18 å‘¨å²ã€ä»¥è‡ªå·±çš„åŠ³åŠ¨æ”¶å…¥ä¸ºä¸»è¦ç”Ÿæ´»æ¥æºçš„ï¼Œå¯åœ¨ç›‘æŠ¤äººåŒæ„ä¸‹æ³¨å†Œ</li>
          <li>æ³¨å†Œæ—¶åº”æä¾›çœŸå®ã€å‡†ç¡®ã€å®Œæ•´ã€æœ‰æ•ˆçš„èº«ä»½ä¿¡æ¯</li>
          <li>æ¯ä¸ªæ‰‹æœºå·ä»…å¯æ³¨å†Œä¸€ä¸ªè´¦æˆ·ï¼Œä¸å¾—ä½¿ç”¨ä»–äººæ‰‹æœºå·æ³¨å†Œ</li>
          <li>ä¼ä¸šæ–¹æ³¨å†Œååº”å°½å¿«å®Œæˆä¼ä¸šèµ„è´¨è®¤è¯</li>
        </ul>
        <h3>3.2 è´¦æˆ·ä½¿ç”¨è§„åˆ™</h3>
        <ul>
          <li>è´¦æˆ·ä»…é™æ‚¨æœ¬äººä½¿ç”¨ï¼Œ<strong>ç¦æ­¢èµ ä¸ã€å€Ÿç”¨ã€å‡ºç§Ÿã€è½¬è®©æˆ–å”®å–è´¦æˆ·</strong></li>
          <li>æ‚¨åº”å¦¥å–„ä¿ç®¡ç™»å½•å¯†ç ï¼Œå› ä¿ç®¡ä¸å–„å¯¼è‡´çš„è´¦æˆ·è¢«ç›—æˆ–å¯†ç æ³„éœ²ï¼Œç”±æ‚¨è‡ªè¡Œæ‰¿æ‹…æŸå¤±</li>
          <li>å¦‚å‘ç°è´¦æˆ·è¢«ä»–äººéæ³•ä½¿ç”¨æˆ–å­˜åœ¨å®‰å…¨é£é™©ï¼Œåº”ç«‹å³é€šè¿‡ã€Œåé¦ˆå»ºè®®ã€é€šçŸ¥æˆ‘ä»¬</li>
          <li>æˆ‘ä»¬æœ‰æƒåœ¨å‘ç°ä»¥ä¸‹è¡Œä¸ºæ—¶é™åˆ¶ã€å†»ç»“æˆ–ç»ˆæ­¢è´¦æˆ·ï¼šå¼‚å¸¸ç™»å½•ã€æ‰¹é‡æ“ä½œã€è¿è§„å†…å®¹ã€æ¬ºè¯ˆè¡Œä¸º</li>
        </ul>
        <h3>3.3 å®åè®¤è¯</h3>
        <ul>
          <li>éƒ¨åˆ†åŠŸèƒ½ï¼ˆå¦‚è”ç³»æ–¹å¼äº¤æ¢ã€ä¼ä¸šè®¤è¯ï¼‰éœ€è¦å®Œæˆå®åè®¤è¯</li>
          <li>è®¤è¯ä¿¡æ¯å¿…é¡»çœŸå®æœ‰æ•ˆï¼Œæä¾›è™šå‡è®¤è¯ä¿¡æ¯å°†å¯¼è‡´è®¤è¯æ’¤é”€å’Œè´¦æˆ·å¤„ç½®</li>
          <li>è®¤è¯ä¿¡æ¯åŠ å¯†å­˜å‚¨ï¼Œä»…åœ¨è®¤è¯å®¡æ ¸æµç¨‹ä¸­ä½¿ç”¨</li>
        </ul>
        <h3>3.4 è´¦æˆ·æ³¨é”€</h3>
        <ul>
          <li>æ‚¨å¯éšæ—¶é€šè¿‡ã€Œåé¦ˆå»ºè®®ã€åŠŸèƒ½ç”³è¯·æ³¨é”€è´¦æˆ·</li>
          <li>æ³¨é”€å‰è¯·ç¡®è®¤ï¼šå·²å¤„ç†å®Œæ‰€æœ‰è¿›è¡Œä¸­çš„æ‹›è˜é˜Ÿåˆ—ã€å·²çŸ¥æ™“æœªä½¿ç”¨çš„ä»˜è´¹ Token ä¸äºˆé€€è¿˜ã€è´¦æˆ·æ•°æ®åˆ é™¤åä¸å¯æ¢å¤</li>
          <li>æˆ‘ä»¬å°†åœ¨æ”¶åˆ°æ³¨é”€ç”³è¯·å 15 ä¸ªå·¥ä½œæ—¥å†…å®Œæˆå¤„ç†</li>
        </ul>

        <h2>å››ã€Token æœåŠ¡æ¡æ¬¾</h2>
        <h3>4.1 Token æ€§è´¨</h3>
        <p>Token æ˜¯æœ¬å¹³å° AI æœåŠ¡çš„æ¶ˆè€—è®¡é‡å•ä½ã€‚<strong>Token ä¸å…·æœ‰è´§å¸å±æ€§ï¼Œä¸å¯è½¬è®©ã€ä¸å¯èµ é€ã€ä¸å¯æç°ã€ä¸å¯å…‘æ¢ä¸ºæ³•å®šè´§å¸æˆ–å…¶ä»–è™šæ‹Ÿè´§å¸ã€‚</strong></p>
        <h3>4.2 è·å–æ–¹å¼</h3>
        <ul>
          <li><strong>æ³¨å†Œèµ é€</strong>ï¼šæ–°ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨èµ é€ä¸€å®šæ•°é‡çš„å…è´¹ Token</li>
          <li><strong>é‚€è¯·å¥–åŠ±</strong>ï¼šæˆåŠŸé‚€è¯·å¥½å‹æ³¨å†Œï¼Œé‚€è¯·äººå’Œè¢«é‚€è¯·äººå„è·å¾— Token å¥–åŠ±</li>
          <li><strong>ä»˜è´¹è´­ä¹°</strong>ï¼šé€šè¿‡å¹³å°ã€ŒToken ç®¡ç†ã€é¡µé¢é€‰æ‹©å¥—é¤ä»˜è´¹è´­ä¹°</li>
        </ul>
        <h3>4.3 æ¶ˆè€—è§„åˆ™</h3>
        <ul>
          <li>ä½¿ç”¨ AI æœåŠ¡å°†æ ¹æ®å®é™…è°ƒç”¨é‡æ‰£å‡ Tokenï¼Œå…·ä½“æ¶ˆè€—é‡å–å†³äº AI æ¨¡å‹ç±»å‹å’Œæ•°æ®å¤„ç†é‡</li>
          <li>å„åŠŸèƒ½çš„ Token æ¶ˆè€—å‚è€ƒå€¼åœ¨ã€Œå¸®åŠ©ä¸­å¿ƒã€å’Œã€ŒToken ç®¡ç†ã€é¡µé¢å…¬ç¤º</li>
          <li>Token ä½™é¢ä¸è¶³æ—¶å°†æ— æ³•ä½¿ç”¨ AI æœåŠ¡ï¼Œç³»ç»Ÿä¼šæå‰å‘é€ä½™é¢ä¸è¶³æé†’</li>
          <li>Token æ‰£å‡åä¸å¯æ’¤å›ï¼Œå³ä½¿ AI ç»“æœä¸ç¬¦åˆé¢„æœŸ</li>
        </ul>
        <h3>4.4 æœ‰æ•ˆæœŸä¸é€€æ¬¾</h3>
        <ul>
          <li>æ³¨å†Œèµ é€å’Œé‚€è¯·å¥–åŠ±çš„ Token æŒ‰å¥—é¤è§„åˆ™è®¾å®šæœ‰æ•ˆæœŸ</li>
          <li>ä»˜è´¹è´­ä¹°çš„ Token åœ¨æœ‰æ•ˆæœŸå†…ä¸ä¼šè¿‡æœŸ</li>
          <li><strong>å·²è´­ä¹°çš„ Token å¥—é¤åŸåˆ™ä¸Šä¸äºˆé€€æ¬¾ã€‚</strong>å¦‚å› å¹³å°æŠ€æœ¯æ•…éšœå¯¼è‡´ Token å¼‚å¸¸æ‰£å‡ï¼Œç»æ ¸å®åå°†è¡¥å¿ç­‰é¢ Token</li>
          <li>è´¦æˆ·æ³¨é”€æ—¶ï¼Œæœªä½¿ç”¨çš„ Tokenï¼ˆå«ä»˜è´¹è´­ä¹°ï¼‰å‡ä¸äºˆé€€è¿˜</li>
        </ul>

        <h2>äº”ã€ç”¨æˆ·è¡Œä¸ºè§„èŒƒ</h2>
        <h3>5.1 ä¿¡æ¯å‘å¸ƒè§„èŒƒ</h3>
        <p>æ‚¨åœ¨æœ¬å¹³å°å‘å¸ƒçš„æ‰€æœ‰ä¿¡æ¯ï¼ˆåŒ…æ‹¬ç®€å†ã€èŒä½æè¿°ã€ä¼ä¸šèµ„æ–™ã€å¯¹è¯å†…å®¹ç­‰ï¼‰é¡»éµå®ˆä»¥ä¸‹è§„èŒƒï¼š</p>
        <ul>
          <li>ä¿¡æ¯çœŸå®ã€å‡†ç¡®ã€å®Œæ•´ï¼Œä¸å¾—å«æœ‰è™šå‡ã€è¯¯å¯¼æ€§å†…å®¹</li>
          <li>ä¸å¾—å‘å¸ƒå«æœ‰å°±ä¸šæ­§è§†å†…å®¹çš„èŒä½ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºæ€§åˆ«ã€å¹´é¾„ã€æ°‘æ—ã€å®—æ•™ã€å©šè‚²çŠ¶å†µæ­§è§†ï¼‰</li>
          <li>ä¸å¾—å‘å¸ƒè¿åã€ŠåŠ³åŠ¨æ³•ã€‹ã€ŠåŠ³åŠ¨åˆåŒæ³•ã€‹ç­‰æ³•å¾‹æ³•è§„çš„å²—ä½ä¿¡æ¯</li>
          <li>ä¸å¾—ä»¥æ‹›è˜ä¸ºåæ”¶å–ä»»ä½•è´¹ç”¨ï¼ˆå¦‚æŠ¥åè´¹ã€åŸ¹è®­è´¹ã€æŠ¼é‡‘ç­‰ï¼‰</li>
          <li>ä¸å¾—å‘å¸ƒå«æœ‰è¿æ³•ã€æ·«ç§½ã€è‰²æƒ…ã€æš´åŠ›ã€ææ€–ã€èµŒåšç­‰å†…å®¹çš„ä¿¡æ¯</li>
          <li>ä¸å¾—ä¾µçŠ¯ä»–äººåèª‰æƒã€éšç§æƒã€è‚–åƒæƒã€çŸ¥è¯†äº§æƒç­‰åˆæ³•æƒç›Š</li>
        </ul>
        <h3>5.2 ç¦æ­¢è¡Œä¸º</h3>
        <ul>
          <li>å†’å……ä»–äººèº«ä»½æˆ–å†’ç”¨ä»–äºº/ä»–å…¬å¸ä¿¡æ¯æ³¨å†Œæˆ–å‘å¸ƒå†…å®¹</li>
          <li>ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ã€è„šæœ¬ã€çˆ¬è™«æˆ–æœºå™¨äººæ‰¹é‡æ“ä½œå¹³å°åŠŸèƒ½æˆ–é‡‡é›†å¹³å°æ•°æ®</li>
          <li>å¯¹å¹³å°è¿›è¡Œåå‘å·¥ç¨‹ã€åç¼–è¯‘ã€åæ±‡ç¼–ã€ç ´è§£æˆ–æ¶æ„æ”»å‡»</li>
          <li>åˆ©ç”¨ç³»ç»Ÿæ¼æ´è·å–ä¸æ­£å½“åˆ©ç›Šï¼ˆåŒ…æ‹¬ä½†ä¸é™äºåˆ·å– Tokenã€ä¼ªé€ é‚€è¯·ç­‰ï¼‰</li>
          <li>å¹²æ‰°æˆ–ç ´åå¹³å°æœåŠ¡å™¨ã€ç½‘ç»œçš„æ­£å¸¸è¿è¡Œ</li>
          <li>æ‰¹é‡æ³¨å†Œã€Œæ°´å†›ã€è´¦æˆ·æˆ–ä»äº‹åˆ·é‡è¡Œä¸º</li>
          <li>åˆ©ç”¨å¹³å°è¿›è¡Œä¼ é”€ã€è¯ˆéª—æˆ–å…¶ä»–éæ³•æ´»åŠ¨</li>
        </ul>
        <h3>5.3 è¿è§„å¤„ç†</h3>
        <p>å¯¹äºè¿åä¸Šè¿°è§„èŒƒçš„è¡Œä¸ºï¼Œæˆ‘ä»¬æœ‰æƒè§†æƒ…èŠ‚ä¸¥é‡ç¨‹åº¦é‡‡å–ä»¥ä¸‹æªæ–½ï¼š</p>
        <ul>
          <li>å‘é€è­¦å‘Šé€šçŸ¥</li>
          <li>åˆ é™¤è¿è§„å†…å®¹</li>
          <li>é™åˆ¶éƒ¨åˆ†æˆ–å…¨éƒ¨åŠŸèƒ½ä½¿ç”¨</li>
          <li>æš‚åœæˆ–æ°¸ä¹…å°ç¦è´¦æˆ·</li>
          <li>æ‰£é™¤è¿è§„è·å–çš„ Token æˆ–å¥–åŠ±</li>
          <li>æ¶‰å«Œè¿æ³•çŠ¯ç½ªçš„ï¼Œç§»äº¤å¸æ³•æœºå…³å¤„ç†</li>
        </ul>

        <h2>å…­ã€çŸ¥è¯†äº§æƒ</h2>
        <h3>6.1 å¹³å°çŸ¥è¯†äº§æƒ</h3>
        <ul>
          <li>æœ¬å¹³å°çš„å…¨éƒ¨å†…å®¹å’ŒæŠ€æœ¯ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºè½¯ä»¶ä»£ç ã€ç®—æ³•æ¨¡å‹ã€ç•Œé¢è®¾è®¡ã€å›¾æ ‡ã€æ–‡æ¡ˆã€å•†æ ‡ Logoã€æŠ€æœ¯æ–‡æ¡£ï¼‰çš„çŸ¥è¯†äº§æƒå½’æ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸æ‰€æœ‰</li>
          <li>"Devnors"ã€"å¾—è‹¥"åŠç›¸å…³æ ‡è¯†ä¸ºæ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸çš„å•†æ ‡ï¼Œæœªç»ä¹¦é¢æˆæƒä¸å¾—ä½¿ç”¨</li>
        </ul>
        <h3>6.2 ç”¨æˆ·å†…å®¹æˆæƒ</h3>
        <ul>
          <li>æ‚¨ä¸Šä¼ çš„å†…å®¹ï¼ˆç®€å†ã€èŒä½æè¿°ã€ä¼ä¸šèµ„æ–™ç­‰ï¼‰çš„çŸ¥è¯†äº§æƒä»å½’æ‚¨æ‰€æœ‰</li>
          <li>æ‚¨åœ¨ä¸Šä¼ æ—¶å³æˆäºˆæˆ‘ä»¬ä¸€é¡¹éæ’ä»–æ€§ã€å…¨çƒæ€§ã€å…è´¹çš„è®¸å¯ï¼Œå…è®¸æˆ‘ä»¬åœ¨æä¾›æ‹›è˜æœåŠ¡çš„èŒƒå›´å†…å­˜å‚¨ã€å±•ç¤ºã€å¤„ç†å’Œåˆ†æè¯¥å†…å®¹</li>
          <li>è¯¥æˆæƒè®¸å¯åœ¨æ‚¨åˆ é™¤ç›¸å…³å†…å®¹æˆ–æ³¨é”€è´¦æˆ·åç»ˆæ­¢ï¼ˆæ³•å¾‹æ³•è§„è¦æ±‚ä¿ç•™çš„é™¤å¤–ï¼‰</li>
        </ul>
        <h3>6.3 AI ç”Ÿæˆå†…å®¹</h3>
        <ul>
          <li>AI ç”Ÿæˆçš„åˆ†æç»“æœã€æ¨èæŠ¥å‘Šä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆä»»ä½•ä¸“ä¸šæ„è§æˆ–æ‰¿è¯º</li>
          <li>ç”¨æˆ·å¯è‡ªç”±ä½¿ç”¨ AI ç”Ÿæˆçš„é¢å‘è‡ªèº«çš„åˆ†æç»“æœ</li>
        </ul>

        <h2>ä¸ƒã€å…è´£å£°æ˜ä¸è´£ä»»é™åˆ¶</h2>
        <h3>7.1 AI æœåŠ¡å…è´£</h3>
        <ul>
          <li>AI ç”Ÿæˆçš„åŒ¹é…åˆ†æ•°ã€åˆ†ææŠ¥å‘Šã€æ¨èç»“æœ<strong>ä»…ä¾›å‚è€ƒ</strong>ï¼Œæˆ‘ä»¬ä¸å¯¹å…¶å‡†ç¡®æ€§ã€å®Œæ•´æ€§ã€æ—¶æ•ˆæ€§ä½œå‡ºä»»ä½•æ˜ç¤ºæˆ–æš—ç¤ºçš„ä¿è¯</li>
          <li>åŸºäº AI åˆ†æç»“æœåšå‡ºçš„å½•ç”¨ã€æŠ•é€’ã€é¢è¯•ç­‰å†³ç­–ï¼Œç”±ç”¨æˆ·è‡ªè¡Œæ‰¿æ‹…è´£ä»»</li>
        </ul>
        <h3>7.2 ç”¨æˆ·é—´çº çº·</h3>
        <ul>
          <li>æœ¬å¹³å°ä»…æä¾›æ‹›è˜ä¿¡æ¯å¯¹æ¥æœåŠ¡ï¼Œä¸ä»‹å…¥ã€ä¸å‚ä¸ç”¨æˆ·ä¹‹é—´çš„é¢è¯•ã€å½•ç”¨ã€åŠ³åŠ¨åˆåŒç­‰å®é™…é›‡ä½£å…³ç³»</li>
          <li>å› ç”¨æˆ·é—´äº¤æ˜“ã€é¢è¯•å®‰æ’ã€åŠ³åŠ¨å…³ç³»äº§ç”Ÿçš„çº çº·ï¼Œç”±å½“äº‹äººè‡ªè¡Œåå•†æˆ–é€šè¿‡æ³•å¾‹é€”å¾„è§£å†³</li>
        </ul>
        <h3>7.3 ä¿¡æ¯çœŸå®æ€§</h3>
        <ul>
          <li>æˆ‘ä»¬å°½åˆç†åŠªåŠ›å®¡æ ¸ç”¨æˆ·å‘å¸ƒçš„ä¿¡æ¯ï¼Œä½†æ— æ³•å®Œå…¨ä¿è¯å¹³å°ä¸Šæ‰€æœ‰ä¿¡æ¯çš„çœŸå®æ€§å’Œå‡†ç¡®æ€§</li>
          <li>ç”¨æˆ·åº”è‡ªè¡Œåˆ¤æ–­ä¿¡æ¯çš„å¯é æ€§ï¼Œå› ä¿¡èµ–æœªç»æ ¸å®çš„ä¿¡æ¯è€Œé­å—çš„æŸå¤±ï¼Œç”±ç”¨æˆ·è‡ªè¡Œæ‰¿æ‹…</li>
        </ul>
        <h3>7.4 ä¸å¯æŠ—åŠ›ä¸æœåŠ¡ä¸­æ–­</h3>
        <ul>
          <li>å› è‡ªç„¶ç¾å®³ã€æˆ˜äº‰ã€ç–«æƒ…ã€æ”¿ç­–å˜æ›´ã€ç½‘ç»œæ”»å‡»ã€ç”µä¿¡æ•…éšœç­‰ä¸å¯æŠ—åŠ›å¯¼è‡´çš„æœåŠ¡ä¸­æ–­ï¼Œæˆ‘ä»¬ä¸æ‰¿æ‹…è´£ä»»</li>
          <li>å› ç³»ç»Ÿç»´æŠ¤ã€å‡çº§éœ€è¦æš‚åœæœåŠ¡æ—¶ï¼Œæˆ‘ä»¬å°†æå‰é€šçŸ¥</li>
          <li>æˆ‘ä»¬ä¸ä¿è¯æœåŠ¡ç»å¯¹ä¸é—´æ–­ã€æ— é”™è¯¯æˆ–å®Œå…¨å®‰å…¨ï¼Œä½†å°†å°½æœ€å¤§å•†ä¸šåŠªåŠ›ç»´æŠ¤æœåŠ¡ç¨³å®š</li>
        </ul>

        <h2>å…«ã€æœåŠ¡å˜æ›´ä¸ç»ˆæ­¢</h2>
        <ul>
          <li>æˆ‘ä»¬æœ‰æƒæ ¹æ®ä¸šåŠ¡å‘å±•éœ€è¦ä¿®æ”¹ã€æš‚åœæˆ–ç»ˆæ­¢éƒ¨åˆ†æˆ–å…¨éƒ¨æœåŠ¡åŠŸèƒ½</li>
          <li>é‡å¤§æœåŠ¡å˜æ›´å°†æå‰ 7 ä¸ªå·¥ä½œæ—¥é€šè¿‡å¹³å°å…¬å‘Šå’Œæ¶ˆæ¯é€šçŸ¥æ–¹å¼å‘ŠçŸ¥ç”¨æˆ·</li>
          <li>å¯¹äºå…è´¹åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯éšæ—¶è°ƒæ•´æœåŠ¡å†…å®¹å’Œè§„åˆ™</li>
          <li>å¦‚å¹³å°æ•´ä½“ç»ˆæ­¢æœåŠ¡ï¼Œå°†æå‰ 30 æ—¥å…¬å‘Šï¼Œå¹¶å¯¹æœªæ¶ˆè€—çš„ä»˜è´¹ Token æŒ‰è´­ä¹°ä»·æ ¼æ¯”ä¾‹é€€è¿˜</li>
        </ul>

        <h2>ä¹ã€é€‚ç”¨æ³•å¾‹ä¸äº‰è®®è§£å†³</h2>
        <ul>
          <li>æœ¬åè®®çš„è®¢ç«‹ã€æ•ˆåŠ›ã€è§£é‡Šã€å±¥è¡Œã€ä¿®æ”¹å’Œç»ˆæ­¢ï¼Œå‡é€‚ç”¨ä¸­åäººæ°‘å…±å’Œå›½å¤§é™†åœ°åŒºæ³•å¾‹æ³•è§„</li>
          <li>å› æœ¬åè®®å¼•èµ·çš„æˆ–ä¸æœ¬åè®®æœ‰å…³çš„ä»»ä½•äº‰è®®ï¼ŒåŒæ–¹åº”é¦–å…ˆå‹å¥½åå•†è§£å†³</li>
          <li>åå•†ä¸æˆçš„ï¼Œä»»ä½•ä¸€æ–¹æœ‰æƒå°†äº‰è®®æäº¤è‡³<strong>æ­å·å¸‚è¥¿æ¹–åŒºäººæ°‘æ³•é™¢</strong>ç®¡è¾–</li>
          <li>æœ¬åè®®çš„ä»»ä½•æ¡æ¬¾è¢«è®¤å®šä¸ºæ— æ•ˆæˆ–ä¸å¯æ‰§è¡Œï¼Œä¸å½±å“å…¶ä½™æ¡æ¬¾çš„æ•ˆåŠ›</li>
        </ul>

        <h2>åã€å…¶ä»–æ¡æ¬¾</h2>
        <ul>
          <li>æœ¬åè®®è‡ªæ‚¨æ³¨å†Œè´¦æˆ·æ—¶ç”Ÿæ•ˆï¼Œè‡³è´¦æˆ·æ³¨é”€æ—¶ç»ˆæ­¢ï¼ˆæ³•å¾‹æ³•è§„å¦æœ‰è§„å®šçš„é™¤å¤–ï¼‰</li>
          <li>æˆ‘ä»¬ä¿ç•™åœ¨æ³•å¾‹å…è®¸çš„èŒƒå›´å†…ä¿®æ”¹æœ¬åè®®çš„æƒåˆ©ã€‚ä¿®æ”¹åçš„åè®®å°†åœ¨å¹³å°å…¬ç¤ºï¼Œè‡ªå…¬ç¤ºä¹‹æ—¥èµ· 7 æ—¥åç”Ÿæ•ˆ</li>
          <li>å¦‚æ‚¨ä¸åŒæ„ä¿®æ”¹åçš„åè®®æ¡æ¬¾ï¼Œåº”åœæ­¢ä½¿ç”¨æœ¬å¹³å°æœåŠ¡å¹¶ç”³è¯·æ³¨é”€è´¦æˆ·</li>
          <li>æœ¬åè®®çš„æ ‡é¢˜ä»…ä¸ºæ–¹ä¾¿é˜…è¯»è€Œè®¾ï¼Œä¸å½±å“æ¡æ¬¾çš„å«ä¹‰å’Œè§£é‡Š</li>
        </ul>

        <h2>åä¸€ã€è”ç³»æ–¹å¼</h2>
        <p>å¦‚æ‚¨å¯¹æœ¬åè®®æœ‰ä»»ä½•ç–‘é—®ã€å»ºè®®æˆ–æŠ•è¯‰ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æˆ‘ä»¬ï¼š</p>
        <ul>
          <li><strong>å…¬å¸å…¨ç§°</strong>ï¼šæ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸</li>
          <li><strong>å¹³å°åé¦ˆ</strong>ï¼šé€šè¿‡æœ¬å¹³å°ã€Œåé¦ˆå»ºè®®ã€åŠŸèƒ½æäº¤å·¥å•</li>
        </ul>
      </div>
    </div>
  );
};

// --- ç‰ˆæƒå£°æ˜é¡µé¢ ---
const CopyrightView = () => {
  const navigate = useNavigate();
  return (
    <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 max-w-4xl mx-auto animate-in fade-in duration-500">
      <div className="mb-10">
        <button onClick={() => navigate(-1)} className="inline-flex items-center gap-1.5 text-sm text-indigo-600 hover:text-indigo-800 font-medium transition-colors mb-8 group">
          <ChevronLeft size={16} className="group-hover:-translate-x-0.5 transition-transform" /> è¿”å›
        </button>
        <h1 className="text-3xl md:text-[40px] font-bold text-slate-900 tracking-tight leading-tight mb-3">ç‰ˆæƒå£°æ˜</h1>
        <p className="text-slate-400 text-sm font-medium tracking-wide">æ›´æ–°æ—¥æœŸï¼š2026 å¹´ 1 æœˆ 15 æ—¥</p>
        <div className="mt-8 h-px bg-gradient-to-r from-slate-200 via-slate-200 to-transparent" />
      </div>
      <div className="prose prose-slate max-w-none prose-headings:font-semibold prose-headings:tracking-tight prose-h2:text-[17px] prose-h2:mt-10 prose-h2:mb-5 prose-h2:pt-6 prose-h2:border-t prose-h2:border-slate-100 prose-h3:text-[15px] prose-h3:font-semibold prose-h3:mt-7 prose-h3:mb-3.5 prose-p:mb-5 prose-p:text-slate-500 prose-li:my-2 prose-li:text-slate-500 prose-ul:my-4 prose-ol:my-4 prose-li:marker:text-slate-300 prose-strong:text-slate-700 [&_p]:text-[15px] [&_p]:!leading-[2.1] [&_li]:text-[15px] [&_li]:!leading-[2.1]">

        <h2>ä¸€ã€ç‰ˆæƒå½’å±</h2>
        <p>Devnors å¾—è‹¥å¹³å°ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºç½‘ç«™ã€ç§»åŠ¨åº”ç”¨ã€API æ¥å£åŠç›¸å…³æœåŠ¡ï¼‰çš„å…¨éƒ¨å†…å®¹å’ŒæŠ€æœ¯ï¼Œå…¶çŸ¥è¯†äº§æƒå½’æ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸æ‰€æœ‰ï¼Œå—ä¸­åäººæ°‘å…±å’Œå›½è‘—ä½œæƒæ³•åŠç›¸å…³æ³•å¾‹æ³•è§„ä¿æŠ¤ã€‚</p>

        <h2>äºŒã€å—ä¿æŠ¤å†…å®¹</h2>
        <p>ä»¥ä¸‹å†…å®¹å‡å—ç‰ˆæƒä¿æŠ¤ï¼š</p>
        <ul>
          <li><strong>è½¯ä»¶ä¸ä»£ç </strong>ï¼šå¹³å°çš„æºä»£ç ã€ç›®æ ‡ä»£ç ã€ç®—æ³•ã€æ•°æ®ç»“æ„ã€AI æ¨¡å‹åŠå…¶è¡ç”Ÿä½œå“</li>
          <li><strong>ç•Œé¢è®¾è®¡</strong>ï¼šç”¨æˆ·ç•Œé¢è®¾è®¡ã€è§†è§‰å…ƒç´ ã€å›¾æ ‡ã€åŠ¨ç”»æ•ˆæœå’Œäº¤äº’æ–¹æ¡ˆ</li>
          <li><strong>å“ç‰Œæ ‡è¯†</strong>ï¼š"Devnors"ã€"å¾—è‹¥"åç§°ã€Logo åŠç›¸å…³å•†æ ‡</li>
          <li><strong>æ–‡æ¡£å†…å®¹</strong>ï¼šå¸®åŠ©æ–‡æ¡£ã€API æ–‡æ¡£ã€ä½¿ç”¨æŒ‡å—ã€è¥é”€æ–‡æ¡ˆ</li>
          <li><strong>æ•°æ®ä¸æ•°æ®åº“</strong>ï¼šå¹³å°ç¼–è¾‘æ•´ç†çš„æ•°æ®é›†åˆåŠå…¶ç¼–æ’æ–¹å¼</li>
        </ul>

        <h2>ä¸‰ã€ç”¨æˆ·å†…å®¹</h2>
        <h3>3.1 ç”¨æˆ·ä¿ç•™çš„æƒåˆ©</h3>
        <p>ç”¨æˆ·ä¸Šä¼ è‡³å¹³å°çš„å†…å®¹ï¼ˆåŒ…æ‹¬ç®€å†ã€èŒä½æè¿°ã€ä¼ä¸šèµ„æ–™ç­‰ï¼‰çš„çŸ¥è¯†äº§æƒä»å½’ç”¨æˆ·æ‰€æœ‰ã€‚</p>
        <h3>3.2 æˆæƒè®¸å¯</h3>
        <p>ç”¨æˆ·åœ¨ä¸Šä¼ å†…å®¹æ—¶ï¼Œå³æˆäºˆæ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ä¸€é¡¹éæ’ä»–æ€§çš„ã€å…¨çƒèŒƒå›´å†…çš„ã€å…è´¹çš„è®¸å¯ï¼Œå…è®¸æˆ‘ä»¬åœ¨æä¾›æ‹›è˜æœåŠ¡çš„èŒƒå›´å†…å­˜å‚¨ã€å±•ç¤ºã€å¤„ç†å’Œåˆ†æè¯¥å†…å®¹ã€‚æ­¤è®¸å¯åœ¨ç”¨æˆ·åˆ é™¤ç›¸å…³å†…å®¹æˆ–æ³¨é”€è´¦æˆ·åç»ˆæ­¢ã€‚</p>
        <h3>3.3 AI å¤„ç†å†…å®¹</h3>
        <p>ç”¨æˆ·å†…å®¹ç» AI å¤„ç†åç”Ÿæˆçš„åˆ†æç»“æœï¼ˆå¦‚åŒ¹é…æŠ¥å‘Šã€æŠ€èƒ½è¯„ä¼°ç­‰ï¼‰ç”±å¹³å°å’Œç”¨æˆ·å…±åŒäº«æœ‰ä½¿ç”¨æƒã€‚ç”¨æˆ·å¯è‡ªç”±ä½¿ç”¨è¯¥ç»“æœï¼Œå¹³å°å¯å°†åŒ¿ååŒ–åçš„ç»“æœç”¨äºæœåŠ¡æ”¹è¿›ã€‚</p>

        <h2>å››ã€ç¦æ­¢è¡Œä¸º</h2>
        <p>æœªç»æ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸äº‹å…ˆä¹¦é¢è®¸å¯ï¼Œä»»ä½•ç»„ç»‡æˆ–ä¸ªäººä¸å¾—ï¼š</p>
        <ul>
          <li>å¤åˆ¶ã€ä¿®æ”¹ã€åˆ†å‘ã€å±•ç¤ºæˆ–ä»¥å…¶ä»–æ–¹å¼ä½¿ç”¨æœ¬å¹³å°çš„å—ä¿æŠ¤å†…å®¹</li>
          <li>å¯¹æœ¬å¹³å°è¿›è¡Œåå‘å·¥ç¨‹ã€åç¼–è¯‘æˆ–åæ±‡ç¼–</li>
          <li>ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ï¼ˆçˆ¬è™«ã€è„šæœ¬ç­‰ï¼‰æ‰¹é‡é‡‡é›†å¹³å°å†…å®¹æˆ–æ•°æ®</li>
          <li>å°†æœ¬å¹³å°å†…å®¹ç”¨äºè®­ç»ƒå…¶ä»– AI æ¨¡å‹æˆ–æœºå™¨å­¦ä¹ ç³»ç»Ÿ</li>
          <li>ç§»é™¤ã€éšè—æˆ–ç¯¡æ”¹æœ¬å¹³å°ä¸Šçš„ç‰ˆæƒå£°æ˜æˆ–å…¶ä»–æƒåˆ©æ ‡è¯†</li>
          <li>ä»¥ä»»ä½•æ–¹å¼æš—ç¤ºä¸æ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸å­˜åœ¨å…³è”ã€åˆä½œæˆ–èƒŒä¹¦å…³ç³»</li>
        </ul>

        <h2>äº”ã€å“ç‰Œæ ‡è¯†ä½¿ç”¨è§„èŒƒ</h2>
        <p>ä»¥ä¸‹å“ç‰Œæ ‡è¯†ä¸ºæ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸çš„ä¸“æœ‰æ ‡è¯†ï¼š</p>
        <ul>
          <li>"Devnors"æ–‡å­—æ ‡è¯†åŠå…¶æ‰€æœ‰å˜ä½“</li>
          <li>"å¾—è‹¥"æ–‡å­—æ ‡è¯†</li>
          <li>Devnors å¾—è‹¥å¹³å° Logo åŠå›¾å½¢æ ‡è¯†</li>
          <li>å¹³å°ç‰¹æœ‰çš„ UI è®¾è®¡å…ƒç´ å’Œè§†è§‰é£æ ¼</li>
        </ul>
        <p>æœªç»ä¹¦é¢æˆæƒï¼Œä»»ä½•ç¬¬ä¸‰æ–¹ä¸å¾—åœ¨ä»¥ä¸‹åœºæ™¯ä¸­ä½¿ç”¨ä¸Šè¿°å“ç‰Œæ ‡è¯†ï¼š</p>
        <ul>
          <li>å•†ä¸šæ¨å¹¿ã€å¹¿å‘Šå®£ä¼ æˆ–è¥é”€ææ–™</li>
          <li>äº§å“åç§°ã€åŸŸåæˆ–ç¤¾äº¤åª’ä½“è´¦å·</li>
          <li>ä»¥ä»»ä½•æ–¹å¼æš—ç¤ºä¸æ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸å­˜åœ¨åˆä½œã€èƒŒä¹¦æˆ–å…³è”å…³ç³»</li>
        </ul>

        <h2>å…­ã€å¼€æºç»„ä»¶å£°æ˜</h2>
        <p>æœ¬å¹³å°åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨äº†éƒ¨åˆ†å¼€æºè½¯ä»¶ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶éµå¾ªå…¶å„è‡ªçš„å¼€æºè®¸å¯åè®®ã€‚æˆ‘ä»¬å¯¹è¿™äº›ç»„ä»¶çš„ä½¿ç”¨ä¸¥æ ¼éµå®ˆå¯¹åº”çš„å¼€æºåè®®æ¡æ¬¾ã€‚ä¸»è¦å¼€æºç»„ä»¶åŒ…æ‹¬ï¼š</p>
        <ul>
          <li><strong>React</strong>ï¼ˆMIT Licenseï¼‰â€” ç”¨æˆ·ç•Œé¢æ¡†æ¶</li>
          <li><strong>FastAPI</strong>ï¼ˆMIT Licenseï¼‰â€” åç«¯ API æ¡†æ¶</li>
          <li><strong>SQLAlchemy</strong>ï¼ˆMIT Licenseï¼‰â€” æ•°æ®åº“ ORM</li>
          <li><strong>Tailwind CSS</strong>ï¼ˆMIT Licenseï¼‰â€” CSS å·¥å…·æ¡†æ¶</li>
          <li><strong>Lucide Icons</strong>ï¼ˆISC Licenseï¼‰â€” å›¾æ ‡åº“</li>
        </ul>
        <p>ä¸Šè¿°å¼€æºç»„ä»¶çš„ç‰ˆæƒå½’å…¶åŸä½œè€…å’Œç»´æŠ¤è€…æ‰€æœ‰ã€‚å®Œæ•´çš„å¼€æºç»„ä»¶æ¸…å•å’Œè®¸å¯è¯æ–‡æœ¬å¯åœ¨é¡¹ç›®ä¾èµ–æ–‡ä»¶ä¸­æŸ¥é˜…ã€‚</p>

        <h2>ä¸ƒã€ç¬¬ä¸‰æ–¹æœåŠ¡</h2>
        <p>æœ¬å¹³å°ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹æœåŠ¡åŠå…¶çŸ¥è¯†äº§æƒå½’å±å¦‚ä¸‹ï¼š</p>
        <ul>
          <li><strong>MiniMax AI æ¨¡å‹æœåŠ¡</strong>ï¼šMiniMax å…¬å¸æ‰€æœ‰ï¼Œé€šè¿‡åˆæ³• API æ¥å£è°ƒç”¨</li>
          <li><strong>Google Gemini AI æ¨¡å‹æœåŠ¡</strong>ï¼šGoogle LLC æ‰€æœ‰ï¼Œé€šè¿‡åˆæ³• API æ¥å£è°ƒç”¨</li>
        </ul>
        <p>æˆ‘ä»¬ä¸å¯¹ç¬¬ä¸‰æ–¹æŠ€æœ¯æ‹¥æœ‰ä»»ä½•çŸ¥è¯†äº§æƒï¼Œä¸”ä¸å£°ç§°ä¸ä¸Šè¿°æœåŠ¡å•†å­˜åœ¨é™¤æ­£å¸¸å•†ä¸šåˆä½œå¤–çš„ä»»ä½•å…³ç³»ã€‚</p>

        <h2>å…«ã€ä¾µæƒé€šçŸ¥ä¸å¤„ç†ï¼ˆé€šçŸ¥-åˆ é™¤æœºåˆ¶ï¼‰</h2>
        <p>å¦‚æœæ‚¨è®¤ä¸ºæœ¬å¹³å°ä¸Šçš„ä»»ä½•å†…å®¹ä¾µçŠ¯äº†æ‚¨çš„çŸ¥è¯†äº§æƒï¼Œè¯·é€šè¿‡ã€Œåé¦ˆå»ºè®®ã€åŠŸèƒ½æäº¤ä¾µæƒæŠ•è¯‰å·¥å•ï¼Œå¹¶æä¾›ä»¥ä¸‹ææ–™ï¼š</p>
        <h3>8.1 æŠ•è¯‰ææ–™è¦æ±‚</h3>
        <ul>
          <li><strong>æƒåˆ©äººèº«ä»½è¯æ˜</strong>ï¼šä¸ªäººèº«ä»½è¯æˆ–ä¼ä¸šè¥ä¸šæ‰§ç…§å‰¯æœ¬æ‰«æä»¶</li>
          <li><strong>æƒåˆ©è¯æ˜æ–‡ä»¶</strong>ï¼šè‘—ä½œæƒç™»è®°è¯ä¹¦ã€å•†æ ‡æ³¨å†Œè¯ä¹¦ã€ä¸“åˆ©è¯ä¹¦æˆ–å…¶ä»–æƒå±è¯æ˜</li>
          <li><strong>ä¾µæƒå†…å®¹å®šä½</strong>ï¼šæ¶‰å«Œä¾µæƒå†…å®¹çš„å…·ä½“ URL æˆ–é¡µé¢ä½ç½®æˆªå›¾</li>
          <li><strong>ä¾µæƒè¯´æ˜</strong>ï¼šè¯¦ç»†è¯´æ˜æ„æˆä¾µæƒçš„ç†ç”±ï¼Œä»¥åŠåŸåˆ›å†…å®¹çš„æ¥æºè¯æ®</li>
          <li><strong>è”ç³»æ–¹å¼</strong>ï¼šç”¨äºæ¥æ”¶å¤„ç†ç»“æœåé¦ˆ</li>
          <li><strong>çœŸå®æ€§å£°æ˜</strong>ï¼šä¿è¯ä»¥ä¸Šææ–™çœŸå®æœ‰æ•ˆçš„ä¹¦é¢å£°æ˜</li>
        </ul>
        <h3>8.2 å¤„ç†æµç¨‹</h3>
        <ul>
          <li><strong>å—ç†</strong>ï¼šæ”¶åˆ°å®Œæ•´æŠ•è¯‰ææ–™å 3 ä¸ªå·¥ä½œæ—¥å†…ç¡®è®¤å—ç†</li>
          <li><strong>è°ƒæŸ¥</strong>ï¼š5 ä¸ªå·¥ä½œæ—¥å†…å®Œæˆåˆæ­¥è°ƒæŸ¥</li>
          <li><strong>å¤„ç½®</strong>ï¼šç»æ ¸å®ç¡®è®¤ä¾µæƒçš„ï¼Œç«‹å³é‡‡å–åˆ é™¤ã€å±è”½ã€æ–­å¼€é“¾æ¥ç­‰å¿…è¦æªæ–½</li>
          <li><strong>é€šçŸ¥</strong>ï¼šå°†å¤„ç†ç»“æœé€šçŸ¥æŠ•è¯‰äººå’Œè¢«æŠ•è¯‰äºº</li>
          <li><strong>åé€šçŸ¥</strong>ï¼šè¢«æŠ•è¯‰äººå¦‚è®¤ä¸ºä¸æ„æˆä¾µæƒï¼Œå¯åœ¨ 15 æ—¥å†…æäº¤åé€šçŸ¥å’Œä¸ä¾µæƒçš„åˆæ­¥è¯æ®</li>
        </ul>
        <p><strong>æ¶æ„æŠ•è¯‰è´£ä»»</strong>ï¼šå¦‚æŸ¥å®æŠ•è¯‰ä¸ºæ¶æ„è¡Œä¸ºï¼ˆæ˜çŸ¥ä¸ä¾µæƒä»æŠ•è¯‰ï¼‰ï¼ŒæŠ•è¯‰äººåº”æ‰¿æ‹…å› æ­¤ç»™è¢«æŠ•è¯‰äººé€ æˆçš„æŸå¤±ã€‚</p>

        <h2>ä¹ã€æ³•å¾‹è´£ä»»</h2>
        <p>ä»»ä½•æœªç»æˆæƒä½¿ç”¨æœ¬å¹³å°å—ä¿æŠ¤å†…å®¹çš„è¡Œä¸ºï¼Œå‡æ„æˆå¯¹æ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸çŸ¥è¯†äº§æƒçš„ä¾µçŠ¯ã€‚æˆ‘ä»¬ä¿ç•™é€šè¿‡æ³•å¾‹æ‰‹æ®µè¿½ç©¶ä¾µæƒè€…è´£ä»»çš„æƒåˆ©ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š</p>
        <ul>
          <li>è¦æ±‚ç«‹å³åœæ­¢ä¾µæƒè¡Œä¸º</li>
          <li>è¦æ±‚èµ”å¿ç»æµæŸå¤±å’Œç»´æƒåˆç†è´¹ç”¨</li>
          <li>è¦æ±‚æ¶ˆé™¤å½±å“ã€èµ”ç¤¼é“æ­‰</li>
          <li>å‘å¸æ³•æœºå…³æèµ·è¯‰è®¼</li>
        </ul>

        <h2>åã€è”ç³»æ–¹å¼</h2>
        <ul>
          <li><strong>ç‰ˆæƒæ‰€æœ‰è€…</strong>ï¼šæ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸</li>
          <li><strong>çŸ¥è¯†äº§æƒæŠ•è¯‰</strong>ï¼šé€šè¿‡æœ¬å¹³å°ã€Œåé¦ˆå»ºè®®ã€åŠŸèƒ½ï¼Œé€‰æ‹©"æŠ•è¯‰"ç±»å‹æäº¤</li>
          <li><strong>å¤„ç†æ—¶é™</strong>ï¼šæ”¶åˆ°å®Œæ•´ææ–™å 15 ä¸ªå·¥ä½œæ—¥å†…å›å¤</li>
        </ul>

        <p className="text-xs text-slate-400 mt-8 pt-6 border-t border-slate-100">Â© {new Date().getFullYear()} æ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸. All Rights Reserved. Devnors å¾—è‹¥ åŠç›¸å…³æ ‡è¯†ä¸ºæ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸çš„æ³¨å†Œå•†æ ‡ã€‚</p>
      </div>
    </div>
  );
};

// --- ç®—æ³•è¯´æ˜ä¸ AI ä½¿ç”¨è§„åˆ™é¡µé¢ ---
const AlgorithmDisclosureView = () => {
  const navigate = useNavigate();
  return (
    <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 max-w-4xl mx-auto animate-in fade-in duration-500">
      <div className="mb-10">
        <button onClick={() => navigate(-1)} className="inline-flex items-center gap-1.5 text-sm text-indigo-600 hover:text-indigo-800 font-medium transition-colors mb-8 group">
          <ChevronLeft size={16} className="group-hover:-translate-x-0.5 transition-transform" /> è¿”å›
        </button>
        <h1 className="text-3xl md:text-[40px] font-bold text-slate-900 tracking-tight leading-tight mb-3">ç®—æ³•è¯´æ˜ä¸ AI ä½¿ç”¨è§„åˆ™</h1>
        <p className="text-slate-400 text-sm font-medium tracking-wide">æ›´æ–°æ—¥æœŸï¼š2026 å¹´ 1 æœˆ 15 æ—¥</p>
        <div className="mt-8 h-px bg-gradient-to-r from-slate-200 via-slate-200 to-transparent" />
      </div>
      <div className="prose prose-slate max-w-none prose-headings:font-semibold prose-headings:tracking-tight prose-h2:text-[17px] prose-h2:mt-10 prose-h2:mb-5 prose-h2:pt-6 prose-h2:border-t prose-h2:border-slate-100 prose-h3:text-[15px] prose-h3:font-semibold prose-h3:mt-7 prose-h3:mb-3.5 prose-p:mb-5 prose-p:text-slate-500 prose-li:my-2 prose-li:text-slate-500 prose-ul:my-4 prose-ol:my-4 prose-li:marker:text-slate-300 prose-strong:text-slate-700 [&_p]:text-[15px] [&_p]:!leading-[2.1] [&_li]:text-[15px] [&_li]:!leading-[2.1]">
        <p className="text-[15px] text-slate-500 !leading-[2.1] mb-10 pb-8 border-b border-slate-100">
          æ ¹æ®ã€Šäº’è”ç½‘ä¿¡æ¯æœåŠ¡ç®—æ³•æ¨èç®¡ç†è§„å®šã€‹ã€Šç”Ÿæˆå¼äººå·¥æ™ºèƒ½æœåŠ¡ç®¡ç†æš‚è¡ŒåŠæ³•ã€‹ã€Šäº’è”ç½‘ä¿¡æ¯æœåŠ¡æ·±åº¦åˆæˆç®¡ç†è§„å®šã€‹åŠç›¸å…³æ³•å¾‹æ³•è§„ï¼Œæ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ï¼ˆä»¥ä¸‹ç®€ç§°"æˆ‘ä»¬"ï¼‰å°± Devnors å¾—è‹¥å¹³å°ï¼ˆä»¥ä¸‹ç®€ç§°"æœ¬å¹³å°"ï¼‰ä½¿ç”¨çš„ç®—æ³•æ¨èå’Œäººå·¥æ™ºèƒ½æŠ€æœ¯å‘ç”¨æˆ·åšå¦‚ä¸‹æŠ«éœ²è¯´æ˜ã€‚
        </p>

        <h2>ä¸€ã€ç®—æ³•æœåŠ¡åŸºæœ¬æƒ…å†µ</h2>
        <h3>1.1 æœåŠ¡æä¾›è€…ä¿¡æ¯</h3>
        <ul>
          <li><strong>å…¬å¸åç§°</strong>ï¼šæ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸</li>
          <li><strong>ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </strong>ï¼šä»¥å·¥å•†ç™»è®°ä¿¡æ¯ä¸ºå‡†</li>
          <li><strong>äº§å“åç§°</strong>ï¼šDevnors å¾—è‹¥æ™ºèƒ½æ‹›è˜å¹³å°</li>
          <li><strong>æœåŠ¡é¢†åŸŸ</strong>ï¼šäººåŠ›èµ„æºä¸æ‹›è˜ç§‘æŠ€ï¼ˆHRTechï¼‰</li>
          <li><strong>åˆè§„æ–¹å‘</strong>ï¼šéµå¾ªã€Šäº’è”ç½‘ä¿¡æ¯æœåŠ¡ç®—æ³•æ¨èç®¡ç†è§„å®šã€‹ç›¸å…³è¦æ±‚ï¼ŒæŒç»­å®Œå–„ç®—æ³•æ²»ç†ä½“ç³»</li>
        </ul>

        <h3>1.2 ç®—æ³•æœåŠ¡ç±»å‹åŠåº”ç”¨åœºæ™¯</h3>
        <p>æœ¬å¹³å°ä½¿ç”¨çš„ç®—æ³•æ¨èæœåŠ¡åŒ…æ‹¬ä»¥ä¸‹ç±»å‹ï¼š</p>
        <ul>
          <li><strong>å²—ä½æ¨èç®—æ³•</strong>ï¼šæ ¹æ®æ±‚èŒè€…ç®€å†ã€æŠ€èƒ½æ ‡ç­¾ã€æ±‚èŒæ„å‘ã€è®°å¿†ä¿¡æ¯å’Œå†å²è¡Œä¸ºæ•°æ®ï¼Œæ¨èåŒ¹é…åº¦é«˜çš„èŒä½ã€‚é€‚ç”¨äºæ±‚èŒè€…æµè§ˆæ¨èå²—ä½åˆ—è¡¨åœºæ™¯</li>
          <li><strong>äººæ‰æ¨èç®—æ³•</strong>ï¼šæ ¹æ®ä¼ä¸šå‘å¸ƒçš„å²—ä½éœ€æ±‚ã€ä¼ä¸šè®°å¿†ä¿¡æ¯ï¼Œæ¨èåŒ¹é…åº¦é«˜çš„å€™é€‰äººã€‚é€‚ç”¨äºä¼ä¸šæ–¹æµè§ˆäººæ‰åº“åœºæ™¯</li>
          <li><strong>æ™ºèƒ½åŒ¹é…ç®—æ³•</strong>ï¼šåŸºäº AI å¤§è¯­è¨€æ¨¡å‹ï¼Œå¯¹å²—ä½ä¸å€™é€‰äººè¿›è¡Œæ·±åº¦è¯­ä¹‰åŒ¹é…åˆ†æï¼Œè¾“å‡ºåŒ¹é…åˆ†æ•°å’Œåˆ†ææŠ¥å‘Šã€‚é€‚ç”¨äº AI æ™ºèƒ½é‚€è¯·ã€AI æ™ºèƒ½æŠ•é€’åŠŸèƒ½</li>
          <li><strong>AI å¯¹è¯ç®—æ³•</strong>ï¼šåŸºäºå¤§è¯­è¨€æ¨¡å‹çš„è‡ªç„¶è¯­è¨€ç†è§£å’Œç”Ÿæˆèƒ½åŠ›ï¼Œæä¾›æ‹›è˜å’¨è¯¢ã€ç®€å†ä¼˜åŒ–ã€é¢è¯•è¾…å¯¼ã€å¸®åŠ©é—®ç­”ç­‰å¯¹è¯æœåŠ¡</li>
          <li><strong>ç®€å†è§£æç®—æ³•</strong>ï¼šåŸºäºè‡ªç„¶è¯­è¨€å¤„ç†æŠ€æœ¯ï¼Œä»ç®€å†æ–‡ä»¶ä¸­æå–ç»“æ„åŒ–ä¿¡æ¯ï¼ˆå§“åã€å­¦å†ã€å·¥ä½œç»å†ã€æŠ€èƒ½ç­‰ï¼‰</li>
        </ul>

        <h2>äºŒã€ç®—æ³•è¿è¡Œæœºåˆ¶</h2>
        <h3>2.1 æ•°æ®è¾“å…¥</h3>
        <p>ç®—æ³•æ¨èä¾æ®ä»¥ä¸‹æ•°æ®è¿›è¡Œå¤„ç†ï¼š</p>
        <ul>
          <li><strong>ç”¨æˆ·ä¸»åŠ¨è¾“å…¥</strong>ï¼šç®€å†å†…å®¹ã€å²—ä½éœ€æ±‚æè¿°ã€åå¥½è®¾ç½®ã€è®°å¿†ä¿¡æ¯ã€å¯¹è¯å†…å®¹</li>
          <li><strong>å¹³å°è¡Œä¸ºæ•°æ®</strong>ï¼šæµè§ˆè®°å½•ã€æŠ•é€’è®°å½•ã€é‚€è¯·è®°å½•ã€æ”¶è—è®°å½•ç­‰æ“ä½œæ—¥å¿—ï¼ˆä¸å«ç²¾ç¡®åœ°ç†ä½ç½®ï¼‰</li>
          <li><strong>å…¬å¼€å±æ€§ä¿¡æ¯</strong>ï¼šèŒä½å’Œå€™é€‰äººçš„å…¬å¼€å±æ€§ï¼ˆæŠ€èƒ½æ ‡ç­¾ã€å·¥ä½œå¹´é™ã€è–ªèµ„èŒƒå›´ã€å­¦å†ã€è¡Œä¸šç­‰ï¼‰</li>
        </ul>
        <p><strong>æœ¬å¹³å°ä¸æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ç”¨äºç®—æ³•æ¨è</strong>ï¼šé€šè®¯å½•ã€çŸ­ä¿¡ã€é€šè¯è®°å½•ã€ç²¾ç¡®åœ°ç†ä½ç½®ã€ç”Ÿç‰©ç‰¹å¾ä¿¡æ¯ï¼ˆå¦‚é¢éƒ¨è¯†åˆ«æ•°æ®ï¼‰ã€‚</p>

        <h3>2.2 æ¨èé€»è¾‘ä¸æ’åºè§„åˆ™</h3>
        <ul>
          <li>æ¨èç»“æœåŸºäºå¤šç»´åº¦ç‰¹å¾å‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—å’Œ AI è¯­ä¹‰æ·±åº¦åˆ†æ</li>
          <li>æ¨èæ’åºä¸»è¦ä¾æ®ï¼š<strong>åŒ¹é…åº¦å¾—åˆ†</strong>ï¼ˆæƒé‡æœ€é«˜ï¼‰ã€ä¿¡æ¯æ–°é²œåº¦ã€å†…å®¹å¤šæ ·æ€§</li>
          <li><strong>æ˜ç¡®æ‰¿è¯ºï¼šä¸ä»¥ç”¨æˆ·æ¶ˆè´¹èƒ½åŠ›ã€Token ä½™é¢ã€ä¼šå‘˜ç­‰çº§ä½œä¸ºæ’åºä¾æ®</strong></li>
          <li><strong>æ˜ç¡®æ‰¿è¯ºï¼šä¸è¿›è¡Œå¤§æ•°æ®ã€Œæ€ç†Ÿã€æˆ–å·®å¼‚åŒ–å®šä»·</strong></li>
          <li>ä¸åŸºäºç”¨æˆ·çš„æ€§åˆ«ã€å¹´é¾„ã€æ°‘æ—ã€å®—æ•™ä¿¡ä»°ã€æ®‹ç–¾çŠ¶å†µç­‰å—ä¿æŠ¤ç‰¹å¾è¿›è¡Œæ­§è§†æ€§æ’åº</li>
          <li>ä¸å‘ç”¨æˆ·è¿‡åº¦æ¨é€å¯èƒ½å¼•èµ·ä¸é€‚æˆ–ç„¦è™‘çš„ä¿¡æ¯</li>
        </ul>

        <h3>2.3 AI æ¨¡å‹æŠ€æœ¯è¯´æ˜</h3>
        <ul>
          <li><strong>æ¨¡å‹æ¥æº</strong>ï¼šæœ¬å¹³å°é€šè¿‡ API æ¥å£è°ƒç”¨ç¬¬ä¸‰æ–¹å¤§è¯­è¨€æ¨¡å‹ï¼ˆå¦‚ MiniMax abab6.5s-chatã€Google Gemini 2.0 Flash ç­‰ï¼‰ï¼Œä¸è‡ªè¡Œè®­ç»ƒåŸºç¡€å¤§æ¨¡å‹</li>
          <li><strong>æ¨¡å‹ç”¨é€”</strong>ï¼šæ–‡æœ¬ç†è§£ã€è¯­ä¹‰åˆ†æã€åŒ¹é…åº¦è¯„ä¼°ã€å†…å®¹ç”Ÿæˆï¼Œ<strong>ä¸ç›´æ¥åšå‡ºå½•ç”¨ã€æ·˜æ±°æˆ–æ­§è§†æ€§å†³ç­–</strong></li>
          <li><strong>è¾“å‡ºæ ‡æ³¨</strong>ï¼šæ‰€æœ‰ AI ç”Ÿæˆç»“æœå‡æ ‡æ³¨"AI åˆ†æç»“æœï¼Œä»…ä¾›å‚è€ƒ"æˆ–ç±»ä¼¼æç¤ºï¼Œæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·ä¸ºç®—æ³•ç”Ÿæˆå†…å®¹</li>
          <li><strong>æ•°æ®å¤„ç†</strong>ï¼šå‘é€è‡³ AI æ¨¡å‹çš„æ•°æ®ä»…ç”¨äºå®æ—¶è¯·æ±‚å¤„ç†ï¼Œä¸ä¼šè¢« AI æœåŠ¡å•†å­˜å‚¨æˆ–ç”¨äºæ¨¡å‹è®­ç»ƒ</li>
        </ul>

        <h3>2.4 ç”Ÿæˆå¼ AI ä¸“é¡¹è¯´æ˜</h3>
        <p>æ ¹æ®ã€Šç”Ÿæˆå¼äººå·¥æ™ºèƒ½æœåŠ¡ç®¡ç†æš‚è¡ŒåŠæ³•ã€‹ï¼š</p>
        <ul>
          <li>æœ¬å¹³å°ä½¿ç”¨çš„ç”Ÿæˆå¼ AI æœåŠ¡ä¸ºå¯¹è¯äº¤äº’å½¢å¼ï¼Œç”Ÿæˆå†…å®¹åŒ…æ‹¬æ–‡å­—å›å¤ã€åˆ†ææŠ¥å‘Šã€åŒ¹é…å»ºè®®ç­‰</li>
          <li>AI ç”Ÿæˆå†…å®¹å¯èƒ½å­˜åœ¨ä¸å‡†ç¡®ã€ä¸å®Œæ•´æˆ–äº§ç”Ÿ"å¹»è§‰"çš„é£é™©ï¼Œç”¨æˆ·åº”è‡ªè¡Œåˆ¤æ–­å’ŒéªŒè¯</li>
          <li>æˆ‘ä»¬å·²å»ºç«‹å†…å®¹å®‰å…¨è¿‡æ»¤æœºåˆ¶ï¼Œé˜²æ­¢ç”Ÿæˆè¿æ³•æœ‰å®³ä¿¡æ¯</li>
          <li>ç”¨æˆ·ä¸å¾—åˆ©ç”¨æœ¬å¹³å° AI æœåŠ¡ç”Ÿæˆè¿æ³•è¿è§„å†…å®¹</li>
        </ul>

        <h2>ä¸‰ã€ç”¨æˆ·æƒåˆ©ä¿éšœ</h2>
        <p>æ ¹æ®ã€Šäº’è”ç½‘ä¿¡æ¯æœåŠ¡ç®—æ³•æ¨èç®¡ç†è§„å®šã€‹ç¬¬åå…­æ¡è‡³ç¬¬äºŒåæ¡ï¼Œæ‚¨äº«æœ‰ä»¥ä¸‹æƒåˆ©ï¼š</p>
        <ul>
          <li><strong>çŸ¥æƒ…æƒ</strong>ï¼šæ‚¨æœ‰æƒäº†è§£æœ¬å¹³å°ä½¿ç”¨ç®—æ³•æ¨èæœåŠ¡çš„åŸºæœ¬åŸç†ã€ç›®çš„æ„å›¾å’Œä¸»è¦è¿è¡Œæœºåˆ¶</li>
          <li><strong>ç®—æ³•æ¨èå…³é—­æƒ</strong>ï¼šæ‚¨å¯ä»¥åœ¨ç³»ç»Ÿè®¾ç½®ä¸­é€‰æ‹©å…³é—­ä¸ªæ€§åŒ–æ¨èåŠŸèƒ½ã€‚å…³é—­åï¼Œå¹³å°å°†ä¸å†åŸºäºæ‚¨çš„è¡Œä¸ºæ•°æ®å’Œåå¥½è¿›è¡Œä¸ªæ€§åŒ–æ¨èï¼Œä½†ä»ä¼šå±•ç¤ºé€šç”¨å†…å®¹</li>
          <li><strong>ç”¨æˆ·æ ‡ç­¾ç®¡ç†æƒ</strong>ï¼šæ‚¨å¯ä»¥æŸ¥çœ‹å’Œåˆ é™¤å¹³å°ä¸ºæ‚¨è®¾å®šçš„ç”¨æˆ·æ ‡ç­¾ï¼ˆå³è®°å¿†æ•°æ®ï¼‰ï¼Œç›¸å…³æ ‡ç­¾åˆ é™¤åä¸å†ç”¨äºæ¨èè®¡ç®—</li>
          <li><strong>åˆ é™¤æƒ</strong>ï¼šæ‚¨å¯ä»¥åˆ é™¤è®°å¿†æ•°æ®å’Œå†å²è¡Œä¸ºæ•°æ®ï¼Œç®—æ³•å°†ä¸å†åŸºäºå·²åˆ é™¤æ•°æ®è¿›è¡Œæ¨è</li>
          <li><strong>ç”³è¯‰æƒ</strong>ï¼šå¦‚æ‚¨è®¤ä¸ºç®—æ³•æ¨èç»“æœå­˜åœ¨åè§ã€æ­§è§†æˆ–å…¶ä»–ä¸åˆç†æƒ…å†µï¼Œå¯é€šè¿‡ã€Œåé¦ˆå»ºè®®ã€æäº¤ç®—æ³•ç”³è¯‰å·¥å•ã€‚æˆ‘ä»¬å°†åœ¨ 15 ä¸ªå·¥ä½œæ—¥å†…æ ¸æŸ¥å¹¶å›å¤</li>
          <li><strong>äººå·¥å¹²é¢„è¯·æ±‚æƒ</strong>ï¼šå¯¹äº AI è‡ªåŠ¨åšå‡ºçš„åŒ¹é…å»ºè®®æˆ–æ¨èç»“æœï¼Œæ‚¨æœ‰æƒè¦æ±‚äººå·¥å®¡æ ¸å’Œå¹²é¢„</li>
        </ul>

        <h2>å››ã€ç®—æ³•å®‰å…¨ä¸å…¬å¹³ä¿éšœ</h2>
        <h3>4.1 åæ­§è§†æªæ–½</h3>
        <ul>
          <li>åœ¨ç®—æ³•è®¾è®¡ä¸­æ˜ç¡®æ’é™¤å°±ä¸šæ­§è§†å› ç´ ï¼ˆæ€§åˆ«ã€å¹´é¾„ã€æ°‘æ—ã€å®—æ•™ã€å©šè‚²çŠ¶å†µã€æ®‹ç–¾çŠ¶å†µç­‰ï¼‰</li>
          <li>å®šæœŸè¿›è¡Œç®—æ³•å…¬å¹³æ€§è¯„ä¼°ï¼Œæ£€æµ‹æ¨èç»“æœä¸­æ˜¯å¦å­˜åœ¨ç»Ÿè®¡æ€§æ­§è§†</li>
          <li>å¯¹ä¼ä¸šå‘å¸ƒçš„å«æ­§è§†æ€§å†…å®¹çš„å²—ä½æè¿°è¿›è¡Œæ£€æµ‹å’Œæ ‡è®°</li>
        </ul>
        <h3>4.2 å†…å®¹å®‰å…¨ä¿éšœ</h3>
        <ul>
          <li>AI ç”Ÿæˆå†…å®¹ç»è¿‡å¤šå±‚å®‰å…¨è¿‡æ»¤ï¼Œé˜²æ­¢è¾“å‡ºè¿æ³•ã€æœ‰å®³ã€ä¸è‰¯ä¿¡æ¯</li>
          <li>å»ºç«‹äººå·¥å®¡æ ¸æœºåˆ¶ï¼Œå¯¹è¢«ä¸¾æŠ¥çš„ AI ç”Ÿæˆå†…å®¹è¿›è¡Œäººå·¥å¤æŸ¥</li>
          <li>å»ºç«‹ç”Ÿæˆå†…å®¹çº é”™å’ŒæŠ•è¯‰æ¸ é“</li>
        </ul>
        <h3>4.3 å®‰å…¨è¯„ä¼°ä¸å®¡è®¡</h3>
        <ul>
          <li>å®šæœŸå¯¹ç®—æ³•æ¨¡å‹è¿›è¡Œå®‰å…¨é£é™©è¯„ä¼°</li>
          <li>å»ºç«‹ç®—æ³•å®‰å…¨å®¡è®¡æ—¥å¿—ï¼Œè®°å½•ç®—æ³•è¿è¡Œå…³é”®æŒ‡æ ‡</li>
          <li>ä¿å­˜ç®—æ³•è¿è¡Œæ—¥å¿—ä¸å°‘äºå…­ä¸ªæœˆ</li>
          <li>é…åˆå›½å®¶äº’è”ç½‘ä¿¡æ¯åŠå…¬å®¤çš„ç®—æ³•å®‰å…¨è¯„ä¼°å’Œç›‘ç®¡æ£€æŸ¥</li>
        </ul>

        <h2>äº”ã€æœªæˆå¹´äººç®—æ³•ä¿æŠ¤</h2>
        <p>æœ¬å¹³å°çš„æœåŠ¡å¯¹è±¡ä¸ºå¹´æ»¡ 18 å‘¨å²çš„æˆå¹´äººã€‚å¦‚å‘ç°æœªæˆå¹´äººä½¿ç”¨æœ¬å¹³å°ï¼š</p>
        <ul>
          <li>ä¸ä¼šåŸºäºæœªæˆå¹´äººç”¨æˆ·ç”»åƒå‘å…¶æ¨èå¯èƒ½å½±å“èº«å¿ƒå¥åº·çš„å†…å®¹</li>
          <li>ä¸ä¼šå‘æœªæˆå¹´äººæ¨é€è¯±å¯¼æ¶ˆè´¹çš„ä¿¡æ¯</li>
          <li>è¯¦è§ã€Šæœªæˆå¹´äººä¿æŠ¤å£°æ˜ã€‹</li>
        </ul>

        <h2>å…­ã€åŠ³åŠ¨è€…æƒç›Šä¿æŠ¤</h2>
        <p>æ ¹æ®ç›¸å…³åŠ³åŠ¨æ³•è§„å’Œæ”¿ç­–è¦æ±‚ï¼š</p>
        <ul>
          <li>ç®—æ³•æ¨èä¸ä¼šå¯¹åŠ³åŠ¨è€…çš„å°±ä¸šæœºä¼šäº§ç”Ÿä¸åˆç†é™åˆ¶</li>
          <li>ä¸ä¼šåˆ©ç”¨ç®—æ³•å¯¹æ±‚èŒè€…è¿›è¡Œä¸åˆç†çš„å·®åˆ«å¾…é‡</li>
          <li>æ¨èç»“æœä»…ä½œä¸ºå‚è€ƒï¼Œæœ€ç»ˆé¢è¯•å’Œå½•ç”¨å†³ç­–ç”±ä¼ä¸šæ–¹å’Œæ±‚èŒè€…åŒæ–¹è‡ªä¸»åšå‡º</li>
          <li>ä¿éšœæ±‚èŒè€…å¹³ç­‰è·å–å°±ä¸šä¿¡æ¯çš„æƒåˆ©</li>
        </ul>

        <h2>ä¸ƒã€è”ç³»æ–¹å¼ä¸ç›‘ç£</h2>
        <p>å¦‚æ‚¨å¯¹æœ¬å¹³å°çš„ç®—æ³•æ¨èæœåŠ¡æœ‰ç–‘é—®ã€å»ºè®®æˆ–æŠ•è¯‰ï¼š</p>
        <ul>
          <li><strong>å¹³å°åé¦ˆ</strong>ï¼šé€šè¿‡ã€Œåé¦ˆå»ºè®®ã€åŠŸèƒ½æäº¤å·¥å•ï¼Œé€‰æ‹©"ç®—æ³•ç›¸å…³"ç±»å‹</li>
          <li><strong>ç›‘ç®¡æŠ•è¯‰</strong>ï¼šæ‚¨ä¹Ÿå¯å‘å›½å®¶äº’è”ç½‘ä¿¡æ¯åŠå…¬å®¤æˆ–æµ™æ±Ÿçœç½‘ä¿¡åŠè¿›è¡ŒæŠ•è¯‰ä¸¾æŠ¥</li>
          <li><strong>å¤„ç†æ—¶é™</strong>ï¼šæˆ‘ä»¬å°†åœ¨ 15 ä¸ªå·¥ä½œæ—¥å†…å—ç†å¹¶å›å¤</li>
        </ul>
        <p>æˆ‘ä»¬æ¬¢è¿ç¤¾ä¼šå„ç•Œå¯¹æœ¬å¹³å°çš„ç®—æ³•æœåŠ¡è¿›è¡Œç›‘ç£ï¼Œå…±åŒç»´æŠ¤å…¬å¹³ã€é€æ˜ã€å¯ä¿¡èµ–çš„ç®—æ³•æœåŠ¡ç¯å¢ƒã€‚</p>
      </div>
    </div>
  );
};

// --- ä¸ªäººä¿¡æ¯ä¿æŠ¤æŒ‡å¼•é¡µé¢ ---
const PersonalInfoProtectionView = () => {
  const navigate = useNavigate();
  return (
    <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 max-w-4xl mx-auto animate-in fade-in duration-500">
      <div className="mb-10">
        <button onClick={() => navigate(-1)} className="inline-flex items-center gap-1.5 text-sm text-indigo-600 hover:text-indigo-800 font-medium transition-colors mb-8 group">
          <ChevronLeft size={16} className="group-hover:-translate-x-0.5 transition-transform" /> è¿”å›
        </button>
        <h1 className="text-3xl md:text-[40px] font-bold text-slate-900 tracking-tight leading-tight mb-3">ä¸ªäººä¿¡æ¯ä¿æŠ¤æŒ‡å¼•</h1>
        <p className="text-slate-400 text-sm font-medium tracking-wide">æ›´æ–°æ—¥æœŸï¼š2026 å¹´ 1 æœˆ 15 æ—¥</p>
        <div className="mt-8 h-px bg-gradient-to-r from-slate-200 via-slate-200 to-transparent" />
      </div>
      <div className="prose prose-slate max-w-none prose-headings:font-semibold prose-headings:tracking-tight prose-h2:text-[17px] prose-h2:mt-10 prose-h2:mb-5 prose-h2:pt-6 prose-h2:border-t prose-h2:border-slate-100 prose-h3:text-[15px] prose-h3:font-semibold prose-h3:mt-7 prose-h3:mb-3.5 prose-p:mb-5 prose-p:text-slate-500 prose-li:my-2 prose-li:text-slate-500 prose-ul:my-4 prose-ol:my-4 prose-li:marker:text-slate-300 prose-strong:text-slate-700 [&_p]:text-[15px] [&_p]:!leading-[2.1] [&_li]:text-[15px] [&_li]:!leading-[2.1]">
        <p className="text-[15px] text-slate-500 !leading-[2.1] mb-10 pb-8 border-b border-slate-100">
          æœ¬æŒ‡å¼•ä¾æ®ã€Šä¸­åäººæ°‘å…±å’Œå›½ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ã€Šä¸­åäººæ°‘å…±å’Œå›½æ•°æ®å®‰å…¨æ³•ã€‹ã€Šä¸­åäººæ°‘å…±å’Œå›½ç½‘ç»œå®‰å…¨æ³•ã€‹åŠç›¸å…³æ³•è§„åˆ¶å®šï¼Œæ—¨åœ¨å¸®åŠ©æ‚¨è¯¦ç»†äº†è§£ Devnors å¾—è‹¥å¹³å°ï¼ˆä»¥ä¸‹ç®€ç§°"æœ¬å¹³å°"ï¼‰å¦‚ä½•æ”¶é›†ã€ä½¿ç”¨ã€å­˜å‚¨å’Œä¿æŠ¤æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼Œä»¥åŠæ‚¨ä¾æ³•äº«æœ‰çš„å„é¡¹æƒåˆ©ã€‚æœ¬æŒ‡å¼•æ˜¯ã€Šéšç§æ”¿ç­–ã€‹çš„è¡¥å……ç»†åˆ™ã€‚
        </p>

        <h2>ä¸€ã€ä¸ªäººä¿¡æ¯æ”¶é›†æ¸…å•</h2>
        <p>ä¸‹åˆ—ä¸ºæœ¬å¹³å°æ”¶é›†çš„ä¸ªäººä¿¡æ¯ç±»åˆ«ã€å…·ä½“å­—æ®µã€å¤„ç†ç›®çš„åŠå¤„ç†æ–¹å¼ï¼š</p>

        <h3>1.1 å¿…è¦ä¿¡æ¯ï¼ˆæ‹’ç»æä¾›å°†å½±å“æ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨ï¼‰</h3>
        <ul>
          <li><strong>æ‰‹æœºå·ç </strong> â€” ç›®çš„ï¼šæ³¨å†Œç™»å½•ã€èº«ä»½éªŒè¯ã€æ‰¾å›å¯†ç ã€æ¥æ”¶éªŒè¯ç ã€‚å­˜å‚¨ï¼šåŠ å¯†å­˜å‚¨ã€‚ä¿ç•™æœŸé™ï¼šè´¦æˆ·å­˜ç»­æœŸé—´åŠæ³¨é”€å 30 æ—¥</li>
          <li><strong>ç™»å½•å¯†ç </strong> â€” ç›®çš„ï¼šè´¦æˆ·å®‰å…¨éªŒè¯ã€‚å­˜å‚¨ï¼šbcrypt å“ˆå¸ŒåŠ å¯†ï¼Œä¸å¯é€†ã€‚ä¿ç•™æœŸé™ï¼šè´¦æˆ·å­˜ç»­æœŸé—´</li>
          <li><strong>ç”¨æˆ·åç§°/æ˜µç§°</strong> â€” ç›®çš„ï¼šå¹³å°å†…å±•ç¤ºã€èº«ä»½è¯†åˆ«ã€‚å­˜å‚¨ï¼šæ˜æ–‡å­˜å‚¨ã€‚ä¿ç•™æœŸé™ï¼šè´¦æˆ·å­˜ç»­æœŸé—´</li>
        </ul>
        <h3>1.2 åŠŸèƒ½ä¿¡æ¯ï¼ˆå¢å€¼æœåŠ¡ï¼Œç”¨æˆ·è‡ªæ„¿æä¾›ï¼‰</h3>
        <ul>
          <li><strong>ç®€å†ä¿¡æ¯</strong>ï¼ˆå§“åã€æ•™è‚²ç»å†ã€å·¥ä½œç»å†ã€é¡¹ç›®ç»éªŒã€æŠ€èƒ½æ ‡ç­¾ã€æ±‚èŒæ„å‘ã€æœŸæœ›è–ªèµ„ã€å¤´åƒã€ä¸ªäººç®€ä»‹ï¼‰â€” ç›®çš„ï¼šAI æ™ºèƒ½åŒ¹é…ã€å²—ä½æ¨èã€ç®€å†å±•ç¤ºã€‚å­˜å‚¨ï¼šæ˜æ–‡å­˜å‚¨ã€‚ä¿ç•™æœŸé™ï¼šè´¦æˆ·å­˜ç»­æœŸé—´ï¼Œå¯éšæ—¶åˆ é™¤</li>
          <li><strong>å²—ä½ä¿¡æ¯</strong>ï¼ˆèŒä½åç§°ã€æè¿°ã€è¦æ±‚ã€è–ªèµ„èŒƒå›´ã€å·¥ä½œåœ°ç‚¹ï¼‰â€” ç›®çš„ï¼šäººæ‰æ¨èã€å²—ä½å±•ç¤ºã€‚ä¿ç•™æœŸé™ï¼šå²—ä½å­˜ç»­æœŸé—´ï¼Œå¯éšæ—¶å…³é—­æˆ–åˆ é™¤</li>
          <li><strong>ä¼ä¸šä¿¡æ¯</strong>ï¼ˆä¼ä¸šåç§°ã€è¡Œä¸šã€è§„æ¨¡ã€ç®€ä»‹ã€è”ç³»æ–¹å¼ï¼‰â€” ç›®çš„ï¼šä¼ä¸šè®¤è¯ã€ä¼ä¸šä¸»é¡µå±•ç¤ºã€‚ä¿ç•™æœŸé™ï¼šè´¦æˆ·å­˜ç»­æœŸé—´</li>
          <li><strong>è®°å¿†æ•°æ®</strong>ï¼ˆæ±‚èŒåå¥½ã€æ‹›è˜åå¥½ã€æŠ€èƒ½ç‰¹é•¿ã€èŒä¸šç›®æ ‡ç­‰è‡ªç”±æ–‡æœ¬ï¼‰â€” ç›®çš„ï¼šAI ä¸ªæ€§åŒ–æ¨èä¼˜åŒ–ã€‚ä¿ç•™æœŸé™ï¼šç”¨æˆ·å¯éšæ—¶æŸ¥çœ‹ã€ä¿®æ”¹æˆ–åˆ é™¤</li>
          <li><strong>å¯¹è¯è®°å½•</strong>ï¼ˆä¸ AI åŠ©æ‰‹çš„å¯¹è¯å†…å®¹ï¼‰â€” ç›®çš„ï¼šæä¾›è¿ç»­å¯¹è¯æœåŠ¡ã€‚ä¿ç•™æœŸé™ï¼šè´¦æˆ·å­˜ç»­æœŸé—´ï¼Œå¯é€šè¿‡æ¸…ç©ºå¯¹è¯è®°å½•åˆ é™¤</li>
        </ul>
        <h3>1.3 æ•æ„Ÿä¸ªäººä¿¡æ¯ï¼ˆéœ€å•ç‹¬åŒæ„ï¼‰</h3>
        <ul>
          <li><strong>èº«ä»½è¯å·ç </strong> â€” ç›®çš„ï¼šä»…ç”¨äºå®åè®¤è¯ã€‚å­˜å‚¨ï¼šAES-256 åŠ å¯†å­˜å‚¨ã€‚è®¿é—®é™åˆ¶ï¼šä»…è®¤è¯å®¡æ ¸æµç¨‹ä¸­è§£å¯†ä½¿ç”¨ï¼Œä¸å¯¹å¤–å±•ç¤ºã€‚ä¿ç•™æœŸé™ï¼šè®¤è¯æœ‰æ•ˆæœŸå†…</li>
          <li><strong>è¥ä¸šæ‰§ç…§ä¿¡æ¯</strong>ï¼ˆç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ã€æ³•å®šä»£è¡¨äººç­‰ï¼‰â€” ç›®çš„ï¼šä»…ç”¨äºä¼ä¸šèµ„è´¨è®¤è¯å®¡æ ¸ã€‚å­˜å‚¨ï¼šåŠ å¯†å­˜å‚¨ã€‚ä¿ç•™æœŸé™ï¼šè®¤è¯æœ‰æ•ˆæœŸå†…</li>
          <li><strong>è”ç³»æ–¹å¼</strong>ï¼ˆé‚®ç®±ã€æ‰‹æœºå·ç”¨äºè”ç³»äº¤æ¢ï¼‰â€” ç›®çš„ï¼šä»…åœ¨åŒæ–¹é€šè¿‡å¹³å°ç¡®è®¤æ„å‘åï¼Œç»æ˜ç¡®æ“ä½œåŒæ„æ‰å¯äº’ç›¸æŸ¥çœ‹ã€‚ä¿ç•™æœŸé™ï¼šè´¦æˆ·å­˜ç»­æœŸé—´</li>
        </ul>
        <h3>1.4 è‡ªåŠ¨æ”¶é›†ä¿¡æ¯</h3>
        <ul>
          <li><strong>è®¾å¤‡ä¿¡æ¯</strong>ï¼ˆè®¾å¤‡å‹å·ã€æ“ä½œç³»ç»Ÿã€æµè§ˆå™¨ç±»å‹ï¼‰â€” ç›®çš„ï¼šå…¼å®¹æ€§é€‚é…ã€å®‰å…¨é˜²æŠ¤</li>
          <li><strong>ç½‘ç»œä¿¡æ¯</strong>ï¼ˆIP åœ°å€ï¼‰â€” ç›®çš„ï¼šå®‰å…¨å®¡è®¡ã€å¼‚å¸¸ç™»å½•æ£€æµ‹ã€‚ä¿ç•™æœŸé™ï¼šæ—¥å¿—ä¿ç•™ä¸å°‘äº 6 ä¸ªæœˆ</li>
          <li><strong>æ“ä½œæ—¥å¿—</strong>ï¼ˆè®¿é—®æ—¶é—´ã€åŠŸèƒ½ä½¿ç”¨è®°å½•ï¼‰â€” ç›®çš„ï¼šå®‰å…¨å®¡è®¡ã€æœåŠ¡æ”¹è¿›ã€‚ä¿ç•™æœŸé™ï¼šæ—¥å¿—ä¿ç•™ä¸å°‘äº 6 ä¸ªæœˆ</li>
          <li><strong>Token æ¶ˆè€—è®°å½•</strong>ï¼ˆAI è°ƒç”¨æ¬¡æ•°ã€æ¶ˆè€—é‡ã€æ¨¡å‹ç±»å‹ï¼‰â€” ç›®çš„ï¼šè®¡è´¹ç®¡ç†ã€ä½¿ç”¨ç»Ÿè®¡</li>
        </ul>

        <h2>äºŒã€ä¸ªäººä¿¡æ¯å¤„ç†è§„åˆ™</h2>
        <h3>2.1 åˆæ³•æ€§åŸºç¡€</h3>
        <p>æˆ‘ä»¬åŸºäºä»¥ä¸‹åˆæ³•æ€§åŸºç¡€å¤„ç†æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼š</p>
        <ul>
          <li><strong>çŸ¥æƒ…åŒæ„</strong>ï¼šåœ¨æ”¶é›†ä¸ªäººä¿¡æ¯å‰ï¼Œé€šè¿‡éšç§æ”¿ç­–å¼¹çª—æˆ–åŠŸèƒ½é¡µé¢è¯´æ˜ç­‰æ–¹å¼å–å¾—æ‚¨çš„æ˜ç¡®åŒæ„</li>
          <li><strong>åˆåŒå±¥è¡Œ</strong>ï¼šä¸ºå±¥è¡Œæ‹›è˜æœåŠ¡åˆåŒæ‰€å¿…éœ€çš„ä¿¡æ¯å¤„ç†</li>
          <li><strong>æ³•å®šä¹‰åŠ¡</strong>ï¼šåŸºäºç½‘ç»œå®‰å…¨æ³•ã€åç”µä¿¡ç½‘ç»œè¯ˆéª—æ³•ç­‰æ³•å¾‹æ³•è§„çš„å¼ºåˆ¶æ€§è¦æ±‚</li>
          <li><strong>åˆç†éœ€è¦</strong>ï¼šä¸ºç»´æŠ¤å¹³å°å®‰å…¨ã€é˜²èŒƒæ¬ºè¯ˆæ‰€å¿…éœ€çš„ä¿¡æ¯å¤„ç†</li>
        </ul>
        <h3>2.2 å¤„ç†åŸåˆ™</h3>
        <ul>
          <li><strong>åˆæ³•æ­£å½“å¿…è¦åŸåˆ™</strong>ï¼šæœ‰æ˜ç¡®ã€åˆç†çš„å¤„ç†ç›®çš„ï¼Œä¸è¶…å‡ºå®ç°ç›®çš„æ‰€å¿…éœ€çš„èŒƒå›´</li>
          <li><strong>æœ€å°å¿…è¦åŸåˆ™</strong>ï¼šä»…æ”¶é›†å®ç°æœåŠ¡åŠŸèƒ½æ‰€å¿…éœ€çš„æœ€å°‘ä¿¡æ¯ï¼Œä¸å¼ºåˆ¶è¦æ±‚éå¿…è¦ä¿¡æ¯</li>
          <li><strong>å…¬å¼€é€æ˜åŸåˆ™</strong>ï¼šä¸ªäººä¿¡æ¯å¤„ç†è§„åˆ™å…¬å¼€é€æ˜ï¼Œæ˜ç¤ºå¤„ç†ç›®çš„ã€æ–¹å¼å’ŒèŒƒå›´</li>
          <li><strong>å‡†ç¡®æ€§åŸåˆ™</strong>ï¼šä¿è¯ä¸ªäººä¿¡æ¯å‡†ç¡®ï¼ŒåŠæ—¶æ›´æ–°å’Œçº æ­£</li>
          <li><strong>å­˜å‚¨æœŸé™æœ€çŸ­åŸåˆ™</strong>ï¼šä»…åœ¨å®ç°å¤„ç†ç›®çš„æ‰€å¿…è¦çš„æœ€çŸ­æ—¶é—´å†…ä¿å­˜ä¸ªäººä¿¡æ¯</li>
        </ul>
        <h3>2.3 åŒæ„ä¸æ‹’ç»</h3>
        <ul>
          <li>å¿…è¦ä¿¡æ¯æ‹’ç»æä¾›å°†å½±å“æ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨ï¼ˆå¦‚æ— æ³•æ³¨å†Œç™»å½•ï¼‰</li>
          <li>åŠŸèƒ½ä¿¡æ¯æ‹’ç»æä¾›ä»…å½±å“å¯¹åº”å¢å€¼åŠŸèƒ½ï¼Œä¸å½±å“åŸºç¡€æœåŠ¡</li>
          <li>æ•æ„Ÿä¿¡æ¯éœ€å•ç‹¬å–å¾—æ‚¨çš„æ˜ç¡®åŒæ„ï¼Œæ‹’ç»ä¸å½±å“éæ•æ„ŸåŠŸèƒ½ä½¿ç”¨</li>
        </ul>

        <h2>ä¸‰ã€ä¸ªäººä¿¡æ¯ä¸»ä½“æƒåˆ©</h2>
        <p>æ ¹æ®ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ç¬¬å››ç« ï¼Œæ‚¨ä¾æ³•äº«æœ‰ä»¥ä¸‹æƒåˆ©ï¼š</p>
        <ul>
          <li><strong>çŸ¥æƒ…æƒä¸å†³å®šæƒ</strong>ï¼ˆç¬¬44æ¡ï¼‰ï¼šäº†è§£ä¸ªäººä¿¡æ¯å¤„ç†æƒ…å†µï¼Œæœ‰æƒé™åˆ¶æˆ–æ‹’ç»ä»–äººå¤„ç†æ‚¨çš„ä¸ªäººä¿¡æ¯</li>
          <li><strong>æŸ¥é˜…å¤åˆ¶æƒ</strong>ï¼ˆç¬¬45æ¡ï¼‰ï¼šæ‚¨å¯åœ¨ã€Œç³»ç»Ÿè®¾ç½® â†’ è´¦å·ä¿¡æ¯ã€ä¸­æŸ¥çœ‹å·²æäº¤çš„ä¸ªäººä¿¡æ¯ã€‚å¦‚éœ€è·å–ä¸ªäººä¿¡æ¯å‰¯æœ¬ï¼Œè¯·é€šè¿‡åé¦ˆå·¥å•æå‡ºç”³è¯·ï¼Œæˆ‘ä»¬å°†åœ¨ 15 ä¸ªå·¥ä½œæ—¥å†…ä»¥ç”µå­æ–‡ä»¶å½¢å¼æä¾›</li>
          <li><strong>æ›´æ­£è¡¥å……æƒ</strong>ï¼ˆç¬¬46æ¡ï¼‰ï¼šæ‚¨å¯éšæ—¶åœ¨ç›¸åº”é¡µé¢ä¿®æ”¹æ‚¨çš„ä¸ªäººä¿¡æ¯ã€‚å¦‚å› æŠ€æœ¯åŸå› æ— æ³•è‡ªè¡Œä¿®æ”¹ï¼Œå¯æäº¤å·¥å•ç”±æˆ‘ä»¬ååŠ©å¤„ç†</li>
          <li><strong>åˆ é™¤æƒ</strong>ï¼ˆç¬¬47æ¡ï¼‰ï¼šåœ¨ä»¥ä¸‹æƒ…å½¢ä¸­æ‚¨æœ‰æƒè¦æ±‚åˆ é™¤ä¸ªäººä¿¡æ¯â€”â€”(1) å¤„ç†ç›®çš„å·²å®ç°ã€å·²ä¸å­˜åœ¨ï¼›(2) æˆ‘ä»¬åœæ­¢æä¾›ç›¸å…³äº§å“æˆ–æœåŠ¡ï¼›(3) è¶…å‡ºçº¦å®šä¿å­˜æœŸé™ï¼›(4) æ‚¨æ’¤å›åŒæ„ï¼›(5) æˆ‘ä»¬è¿åæ³•å¾‹æˆ–åè®®çº¦å®šå¤„ç†æ‚¨çš„ä¸ªäººä¿¡æ¯</li>
          <li><strong>å¯æºå¸¦æƒ</strong>ï¼ˆç¬¬45æ¡ç¬¬3æ¬¾ï¼‰ï¼šç¬¦åˆå›½å®¶ç½‘ä¿¡éƒ¨é—¨è§„å®šæ¡ä»¶æ—¶ï¼Œæ‚¨æœ‰æƒè¯·æ±‚å°†ä¸ªäººä¿¡æ¯è½¬ç§»è‡³æ‚¨æŒ‡å®šçš„å…¶ä»–ä¸ªäººä¿¡æ¯å¤„ç†è€…ã€‚è¯·é€šè¿‡åé¦ˆå·¥å•æå‡ºç”³è¯·</li>
          <li><strong>æ’¤å›åŒæ„æƒ</strong>ï¼ˆç¬¬15æ¡ï¼‰ï¼šæ‚¨å¯éšæ—¶æ’¤å›æ­¤å‰ç»™äºˆçš„å¤„ç†åŒæ„ã€‚æ’¤å›åŒæ„çš„æ–¹å¼åŒ…æ‹¬ï¼šåˆ é™¤è®°å¿†æ•°æ®ã€å…³é—­ä¸ªæ€§åŒ–æ¨èã€æäº¤æ³¨é”€ç”³è¯·ç­‰ã€‚æ’¤å›ä¸å½±å“æ’¤å›å‰å·²è¿›è¡Œçš„åˆæ³•å¤„ç†</li>
          <li><strong>è‡ªåŠ¨åŒ–å†³ç­–æ‹’ç»æƒ</strong>ï¼ˆç¬¬24æ¡ï¼‰ï¼šå¯¹äº AI ç®—æ³•æ¨èç»“æœï¼Œæ‚¨æœ‰æƒè¦æ±‚è¯´æ˜å†³ç­–é€»è¾‘å’Œæ¨èä¾æ®ã€‚å¦‚æ¨èç»“æœå¯¹æ‚¨çš„æƒç›Šäº§ç”Ÿé‡å¤§å½±å“ï¼Œæ‚¨æœ‰æƒæ‹’ç»ä»…åŸºäºè‡ªåŠ¨åŒ–å†³ç­–åšå‡ºçš„å†³å®š</li>
          <li><strong>è´¦æˆ·æ³¨é”€æƒ</strong>ï¼šæ‚¨æœ‰æƒéšæ—¶æ³¨é”€è´¦æˆ·ï¼Œæˆ‘ä»¬å°†åœ¨æ”¶åˆ°æ³¨é”€ç”³è¯·å 15 ä¸ªå·¥ä½œæ—¥å†…å®Œæˆè´¦æˆ·åˆ é™¤åŠä¸ªäººä¿¡æ¯æ¸…é™¤ï¼ˆæ³•å¾‹æ³•è§„è¦æ±‚ä¿ç•™çš„é™¤å¤–ï¼‰</li>
          <li><strong>é€è€…è¿‘äº²å±æƒåˆ©</strong>ï¼ˆç¬¬49æ¡ï¼‰ï¼šè‡ªç„¶äººæ­»äº¡åï¼Œå…¶è¿‘äº²å±ä¸ºäº†è‡ªèº«åˆæ³•ã€æ­£å½“åˆ©ç›Šï¼Œå¯ä¾æ³•å¯¹æ­»è€…çš„ä¸ªäººä¿¡æ¯è¡Œä½¿æŸ¥é˜…ã€å¤åˆ¶ã€æ›´æ­£ã€åˆ é™¤ç­‰æƒåˆ©</li>
        </ul>
        <p><strong>æƒåˆ©è¡Œä½¿æ–¹å¼</strong>ï¼šé€šè¿‡ã€Œåé¦ˆå»ºè®®ã€åŠŸèƒ½æäº¤"ä¸ªäººä¿¡æ¯æƒåˆ©"ç±»å‹å·¥å•ï¼Œæˆ–åœ¨ã€Œç³»ç»Ÿè®¾ç½®ã€ä¸­è‡ªè¡Œæ“ä½œã€‚æˆ‘ä»¬å°†åœ¨ 15 ä¸ªå·¥ä½œæ—¥å†…å—ç†å¹¶å›å¤ã€‚</p>

        <h2>å››ã€ä¸ªäººä¿¡æ¯å…±äº«ä¸å§”æ‰˜å¤„ç†</h2>
        <h3>4.1 ç¬¬ä¸‰æ–¹å…±äº«æ¸…å•</h3>
        <ul>
          <li><strong>MiniMaxï¼ˆç¨€å®‡ç§‘æŠ€ï¼‰</strong>ï¼šå…±äº«ç®€å†æ–‡æœ¬ã€å¯¹è¯å†…å®¹ç”¨äº AI æ¨¡å‹å®æ—¶å¤„ç†ã€‚æ•°æ®ä¸è¢«å­˜å‚¨æˆ–ç”¨äºè®­ç»ƒ</li>
          <li><strong>Googleï¼ˆè°·æ­Œï¼‰</strong>ï¼šå…±äº«å¯¹è¯å†…å®¹ç”¨äº Gemini AI æ¨¡å‹å¤‡é€‰å¤„ç†ã€‚æ•°æ®ä¸è¢«å­˜å‚¨æˆ–ç”¨äºè®­ç»ƒ</li>
          <li><strong>æ”¯ä»˜æœåŠ¡å•†</strong>ï¼šToken å……å€¼æ—¶å…±äº«è®¢å•é‡‘é¢ä¿¡æ¯ï¼Œä¸å…±äº«ä¸ªäººèº«ä»½ä¿¡æ¯</li>
        </ul>
        <h3>4.2 å…±äº«åŸåˆ™</h3>
        <ul>
          <li>ä»…åœ¨ä¸ºæ‚¨æä¾›æœåŠ¡æ‰€å¿…éœ€çš„èŒƒå›´å†…å…±äº«</li>
          <li>å·²ä¸ç¬¬ä¸‰æ–¹ç­¾è®¢æ•°æ®å¤„ç†åè®®ï¼Œçº¦æŸå…¶æ•°æ®ä½¿ç”¨è¡Œä¸º</li>
          <li>ç¬¬ä¸‰æ–¹ä¸å¾—å°†å…±äº«æ•°æ®ç”¨äºåè®®çº¦å®šä»¥å¤–çš„ç”¨é€”</li>
        </ul>

        <h2>äº”ã€ä¸ªäººä¿¡æ¯è·¨å¢ƒä¼ è¾“</h2>
        <p>æœ¬å¹³å°ä¼˜å…ˆä½¿ç”¨å¢ƒå†… AI æ¨¡å‹æœåŠ¡ï¼ˆå¦‚ MiniMaxï¼‰ã€‚å½“ä½¿ç”¨å¢ƒå¤– AI æ¨¡å‹ï¼ˆå¦‚ Google Geminiï¼‰æ—¶ï¼Œå¯èƒ½å‘ç”Ÿä¸ªäººä¿¡æ¯è·¨å¢ƒä¼ è¾“ã€‚æˆ‘ä»¬å·²é‡‡å–ä»¥ä¸‹æªæ–½ï¼š</p>
        <ul>
          <li>ä»…ä¼ è¾“å®ç°æœåŠ¡åŠŸèƒ½æ‰€å¿…éœ€çš„æœ€å°‘æ•°æ®ï¼ˆç®€å†æ–‡æœ¬æˆ–å¯¹è¯å†…å®¹çš„ç‰‡æ®µï¼‰</li>
          <li>ä¼ è¾“å…¨ç¨‹ä½¿ç”¨ HTTPS/TLS åŠ å¯†</li>
          <li>å¢ƒå¤–æ¥æ”¶æ–¹ä¸ä¼šé•¿æœŸå­˜å‚¨æˆ–äºŒæ¬¡ä½¿ç”¨æ‚¨çš„æ•°æ®</li>
          <li>æŒ‰ç…§ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ç¬¬ä¸‰ç« ç›¸å…³è§„å®šï¼Œå¯¹è·¨å¢ƒä¼ è¾“è¿›è¡Œä¸ªäººä¿¡æ¯ä¿æŠ¤å½±å“è¯„ä¼°</li>
          <li>æ‚¨å¯åœ¨ã€Œç³»ç»Ÿè®¾ç½® â†’ è‡ªå®šä¹‰å¤§æ¨¡å‹ã€ä¸­é€‰æ‹©ä»…ä½¿ç”¨å¢ƒå†…æ¨¡å‹ï¼Œé¿å…è·¨å¢ƒä¼ è¾“</li>
        </ul>

        <h2>å…­ã€ä¸ªäººä¿¡æ¯å­˜å‚¨ä¸åˆ é™¤</h2>
        <h3>6.1 å­˜å‚¨åœ°ç‚¹</h3>
        <p>æ‚¨çš„ä¸ªäººä¿¡æ¯å­˜å‚¨åœ¨ä¸­åäººæ°‘å…±å’Œå›½å¢ƒå†…çš„æœåŠ¡å™¨ã€‚</p>
        <h3>6.2 å­˜å‚¨æœŸé™</h3>
        <ul>
          <li>è´¦å·åŸºæœ¬ä¿¡æ¯ï¼šè´¦æˆ·å­˜ç»­æœŸé—´åŠæ³¨é”€å 30 æ—¥</li>
          <li>ç®€å†å’Œå²—ä½ä¿¡æ¯ï¼šç”¨æˆ·å¯éšæ—¶åˆ é™¤ï¼Œåˆ é™¤åç«‹å³ä»æ´»è·ƒæ•°æ®åº“ç§»é™¤</li>
          <li>æ“ä½œæ—¥å¿—å’Œå®‰å…¨å®¡è®¡æ—¥å¿—ï¼šä¿ç•™ä¸å°‘äº 6 ä¸ªæœˆï¼ˆç½‘ç»œå®‰å…¨æ³•è¦æ±‚ï¼‰</li>
          <li>Token æ¶ˆè€—è®°å½•ï¼šä¿ç•™ 3 å¹´ï¼ˆè´¢åŠ¡åˆè§„è¦æ±‚ï¼‰</li>
        </ul>
        <h3>6.3 åˆ é™¤æœºåˆ¶</h3>
        <ul>
          <li>ç”¨æˆ·ä¸»åŠ¨åˆ é™¤å†…å®¹åï¼Œä»æ´»è·ƒæ•°æ®åº“ä¸­ç«‹å³åˆ é™¤</li>
          <li>è´¦æˆ·æ³¨é”€å 30 æ—¥å†…å®Œæˆæ‰€æœ‰ä¸ªäººä¿¡æ¯åˆ é™¤æˆ–åŒ¿ååŒ–å¤„ç†</li>
          <li>å¤‡ä»½ç³»ç»Ÿä¸­çš„æ•°æ®åœ¨å¤‡ä»½è½®è½¬å‘¨æœŸå†…è‡ªåŠ¨è¦†ç›–æ¸…é™¤</li>
          <li>æ³•å¾‹æ³•è§„è¦æ±‚ä¿ç•™çš„ä¿¡æ¯é™¤å¤–</li>
        </ul>

        <h2>ä¸ƒã€ä¸ªäººä¿¡æ¯å®‰å…¨äº‹ä»¶åº”æ€¥å“åº”</h2>
        <h3>7.1 åº”æ€¥é¢„æ¡ˆ</h3>
        <ul>
          <li>å·²å»ºç«‹ä¸ªäººä¿¡æ¯å®‰å…¨äº‹ä»¶åˆ†çº§å“åº”æœºåˆ¶ï¼ˆä¸€èˆ¬/é‡è¦/é‡å¤§/ç‰¹åˆ«é‡å¤§ï¼‰</li>
          <li>æˆç«‹åº”æ€¥å“åº”å°ç»„ï¼Œæ˜ç¡®èŒè´£åˆ†å·¥å’Œå¤„ç½®æµç¨‹</li>
        </ul>
        <h3>7.2 äº‹ä»¶å¤„ç†æµç¨‹</h3>
        <ul>
          <li><strong>å‘ç°é˜¶æ®µ</strong>ï¼šé€šè¿‡å®‰å…¨ç›‘æ§ç³»ç»Ÿã€ç”¨æˆ·ä¸¾æŠ¥ã€ç¬¬ä¸‰æ–¹é€šçŸ¥ç­‰æ¸ é“å‘ç°å®‰å…¨äº‹ä»¶</li>
          <li><strong>æ­¢æŸé˜¶æ®µ</strong>ï¼šç«‹å³é‡‡å–éš”ç¦»ã€å°å µã€æ—¥å¿—å›ºåŒ–ç­‰æªæ–½é˜²æ­¢å½±å“æ‰©å¤§</li>
          <li><strong>è¯„ä¼°é˜¶æ®µ</strong>ï¼šè¯„ä¼°äº‹ä»¶å½±å“èŒƒå›´ã€å—å½±å“ç”¨æˆ·æ•°é‡å’Œå¯èƒ½é€ æˆçš„å±å®³</li>
          <li><strong>é€šçŸ¥é˜¶æ®µ</strong>ï¼šæŒ‰ç…§æ³•å¾‹è§„å®šæ—¶é™å‘æœ‰å…³ä¸»ç®¡éƒ¨é—¨æŠ¥å‘Šï¼Œå¹¶é€šè¿‡ç«™å†…æ¶ˆæ¯ã€çŸ­ä¿¡ç­‰æ–¹å¼é€šçŸ¥å—å½±å“ç”¨æˆ·</li>
          <li><strong>æ•´æ”¹é˜¶æ®µ</strong>ï¼šä¿®å¤å®‰å…¨æ¼æ´ï¼Œå®Œå–„å®‰å…¨é˜²æŠ¤æªæ–½</li>
        </ul>
        <h3>7.3 ç”¨æˆ·é€šçŸ¥å†…å®¹</h3>
        <p>å®‰å…¨äº‹ä»¶é€šçŸ¥å°†åŒ…æ‹¬ï¼šäº‹ä»¶åŸºæœ¬æƒ…å†µå’ŒåŸå› ã€å·²æ³„éœ²çš„ä¿¡æ¯ç±»å‹ã€å¯èƒ½é€ æˆçš„é£é™©ã€å·²é‡‡å–å’Œå°†è¦é‡‡å–çš„è¡¥æ•‘æªæ–½ã€ç”¨æˆ·å¯è‡ªè¡Œé‡‡å–çš„é˜²æŠ¤å»ºè®®ã€æˆ‘ä»¬çš„è”ç³»æ–¹å¼ã€‚</p>

        <h2>å…«ã€ä¸ªäººä¿¡æ¯ä¿æŠ¤å½±å“è¯„ä¼°</h2>
        <p>æ ¹æ®ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ç¬¬55æ¡ï¼Œæˆ‘ä»¬åœ¨ä»¥ä¸‹æƒ…å½¢ä¸­å¼€å±•ä¸ªäººä¿¡æ¯ä¿æŠ¤å½±å“è¯„ä¼°ï¼š</p>
        <ul>
          <li>å¤„ç†æ•æ„Ÿä¸ªäººä¿¡æ¯ï¼ˆå¦‚èº«ä»½è¯å·ç ã€è¥ä¸šæ‰§ç…§ä¿¡æ¯ï¼‰</li>
          <li>åˆ©ç”¨ä¸ªäººä¿¡æ¯è¿›è¡Œè‡ªåŠ¨åŒ–å†³ç­–ï¼ˆAI åŒ¹é…æ¨èï¼‰</li>
          <li>å‘ç¬¬ä¸‰æ–¹æä¾›ä¸ªäººä¿¡æ¯ï¼ˆAI æ¨¡å‹æœåŠ¡å•†æ•°æ®ä¼ è¾“ï¼‰</li>
          <li>å‘å¢ƒå¤–æä¾›ä¸ªäººä¿¡æ¯ï¼ˆä½¿ç”¨å¢ƒå¤– AI æ¨¡å‹æ—¶ï¼‰</li>
        </ul>
        <p>è¯„ä¼°æŠ¥å‘Šå’Œå¤„ç†æƒ…å†µè®°å½•ä¿å­˜ä¸å°‘äº 3 å¹´ã€‚</p>

        <h2>ä¹ã€ä¸ªäººä¿¡æ¯ä¿æŠ¤è´Ÿè´£äºº</h2>
        <ul>
          <li>æ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸å·²ä¾æ³•æŒ‡å®šä¸ªäººä¿¡æ¯ä¿æŠ¤è´Ÿè´£äººï¼Œè´Ÿè´£ç›‘ç£ä¸ªäººä¿¡æ¯å¤„ç†æ´»åŠ¨å’Œä¿æŠ¤æªæ–½</li>
          <li>ä¸ªäººä¿¡æ¯ä¿æŠ¤è´Ÿè´£äººè”ç³»æ–¹å¼ï¼šé€šè¿‡ã€Œåé¦ˆå»ºè®®ã€åŠŸèƒ½æäº¤"ä¸ªäººä¿¡æ¯ä¿æŠ¤"ç±»å‹å·¥å•</li>
          <li>æˆ‘ä»¬å°†åœ¨ 15 ä¸ªå·¥ä½œæ—¥å†…å—ç†å¹¶å›å¤æ‚¨çš„è¯·æ±‚</li>
          <li>å¦‚å¯¹å¤„ç†ç»“æœä¸æ»¡æ„ï¼Œæ‚¨æœ‰æƒå‘<strong>æµ™æ±Ÿçœç½‘ä¿¡åŠ</strong>æˆ–<strong>æ­å·å¸‚å¸‚åœºç›‘ç£ç®¡ç†å±€</strong>æŠ•è¯‰ä¸¾æŠ¥</li>
        </ul>
      </div>
    </div>
  );
};

// --- æœªæˆå¹´äººä¿æŠ¤å£°æ˜é¡µé¢ ---
const MinorProtectionView = () => {
  const navigate = useNavigate();
  return (
    <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 max-w-4xl mx-auto animate-in fade-in duration-500">
      <div className="mb-10">
        <button onClick={() => navigate(-1)} className="inline-flex items-center gap-1.5 text-sm text-indigo-600 hover:text-indigo-800 font-medium transition-colors mb-8 group">
          <ChevronLeft size={16} className="group-hover:-translate-x-0.5 transition-transform" /> è¿”å›
        </button>
        <h1 className="text-3xl md:text-[40px] font-bold text-slate-900 tracking-tight leading-tight mb-3">æœªæˆå¹´äººä¿æŠ¤å£°æ˜</h1>
        <p className="text-slate-400 text-sm font-medium tracking-wide">æ›´æ–°æ—¥æœŸï¼š2026 å¹´ 1 æœˆ 15 æ—¥</p>
        <div className="mt-8 h-px bg-gradient-to-r from-slate-200 via-slate-200 to-transparent" />
      </div>
      <div className="prose prose-slate max-w-none prose-headings:font-semibold prose-headings:tracking-tight prose-h2:text-[17px] prose-h2:mt-10 prose-h2:mb-5 prose-h2:pt-6 prose-h2:border-t prose-h2:border-slate-100 prose-h3:text-[15px] prose-h3:font-semibold prose-h3:mt-7 prose-h3:mb-3.5 prose-p:mb-5 prose-p:text-slate-500 prose-li:my-2 prose-li:text-slate-500 prose-ul:my-4 prose-ol:my-4 prose-li:marker:text-slate-300 prose-strong:text-slate-700 [&_p]:text-[15px] [&_p]:!leading-[2.1] [&_li]:text-[15px] [&_li]:!leading-[2.1]">
        <p className="text-[15px] text-slate-500 !leading-[2.1] mb-10 pb-8 border-b border-slate-100">
          æ­å·åŠ¿è¡Œç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ï¼ˆä»¥ä¸‹ç®€ç§°"æˆ‘ä»¬"ï¼‰é«˜åº¦é‡è§†æœªæˆå¹´äººä¿æŠ¤ã€‚æœ¬å£°æ˜ä¾æ®ã€Šä¸­åäººæ°‘å…±å’Œå›½æœªæˆå¹´äººä¿æŠ¤æ³•ã€‹ã€Šä¸­åäººæ°‘å…±å’Œå›½é¢„é˜²æœªæˆå¹´äººçŠ¯ç½ªæ³•ã€‹ã€Šå„¿ç«¥ä¸ªäººä¿¡æ¯ç½‘ç»œä¿æŠ¤è§„å®šã€‹åŠç›¸å…³æ³•å¾‹æ³•è§„åˆ¶å®šï¼Œé€‚ç”¨äº Devnors å¾—è‹¥å¹³å°ï¼ˆä»¥ä¸‹ç®€ç§°"æœ¬å¹³å°"ï¼‰æä¾›çš„æ‰€æœ‰äº§å“å’ŒæœåŠ¡ã€‚
        </p>

        <h2>ä¸€ã€æœåŠ¡å¯¹è±¡è¯´æ˜</h2>
        <p>Devnors å¾—è‹¥æ˜¯é¢å‘æˆå¹´äººï¼ˆå¹´æ»¡ 18 å‘¨å²ä¸”å…·æœ‰å®Œå…¨æ°‘äº‹è¡Œä¸ºèƒ½åŠ›ï¼‰çš„ä¸“ä¸šæ‹›è˜æœåŠ¡å¹³å°ã€‚æœ¬å¹³å°çš„æ ¸å¿ƒä¸šåŠ¡ä¸ºæ±‚èŒæ‹›è˜å¯¹æ¥ï¼Œæ¶‰åŠåŠ³åŠ¨åˆåŒå’Œå°±ä¸šå…³ç³»ï¼Œä¾æ³•è¦æ±‚ç”¨æˆ·å…·å¤‡å®Œå…¨æ°‘äº‹è¡Œä¸ºèƒ½åŠ›ã€‚</p>
        <ul>
          <li>æœ¬å¹³å°<strong>ä¸é¢å‘æœªæ»¡ 18 å‘¨å²çš„æœªæˆå¹´äºº</strong>æä¾›æ³¨å†Œå’Œæ ¸å¿ƒæœåŠ¡</li>
          <li>æ³¨å†Œè´¦æˆ·æ—¶éœ€éªŒè¯æ‰‹æœºå·ï¼Œç”¨æˆ·é¡»æ˜ç¡®ç¡®è®¤å·²å¹´æ»¡ 18 å‘¨å²</li>
          <li>å¹´æ»¡ 16 å‘¨å²ä¸æ»¡ 18 å‘¨å²ã€ä»¥è‡ªå·±çš„åŠ³åŠ¨æ”¶å…¥ä¸ºä¸»è¦ç”Ÿæ´»æ¥æºçš„å…¬æ°‘ï¼Œä¾ç…§ã€Šæ°‘æ³•å…¸ã€‹è§†ä¸ºå®Œå…¨æ°‘äº‹è¡Œä¸ºèƒ½åŠ›äººï¼Œå¯åœ¨ç›‘æŠ¤äººçŸ¥æƒ…åŒæ„ä¸‹ä½¿ç”¨æœ¬å¹³å°</li>
          <li>ä¸æ»¡ 16 å‘¨å²çš„æœªæˆå¹´äººä¸å¾—æ³¨å†Œæˆ–ä½¿ç”¨æœ¬å¹³å°</li>
        </ul>

        <h2>äºŒã€æœªæˆå¹´äººä¸ªäººä¿¡æ¯ä¿æŠ¤</h2>
        <h3>2.1 å„¿ç«¥ä¸ªäººä¿¡æ¯æ”¶é›†é™åˆ¶</h3>
        <ul>
          <li>æˆ‘ä»¬<strong>ä¸ä¼šä¸»åŠ¨æ”¶é›†æœªæ»¡ 14 å‘¨å²å„¿ç«¥</strong>çš„ä»»ä½•ä¸ªäººä¿¡æ¯</li>
          <li>å¦‚å‘ç°è¯¯æ”¶é›†äº†æœªæ»¡ 14 å‘¨å²å„¿ç«¥çš„ä¸ªäººä¿¡æ¯ï¼Œæˆ‘ä»¬å°†<strong>ç«‹å³åœæ­¢å¤„ç†å¹¶åœ¨ 48 å°æ—¶å†…åˆ é™¤</strong></li>
          <li>åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šå°†å„¿ç«¥ä¸ªäººä¿¡æ¯æä¾›ç»™ç¬¬ä¸‰æ–¹ï¼ˆæ³•å¾‹å¼ºåˆ¶è¦æ±‚é™¤å¤–ï¼‰</li>
        </ul>
        <h3>2.2 14-18 å‘¨å²æœªæˆå¹´äºº</h3>
        <ul>
          <li>å¯¹äº 14-18 å‘¨å²çš„æœªæˆå¹´äººï¼Œåœ¨ç¡®æœ‰ä½¿ç”¨æœ¬å¹³å°æœåŠ¡éœ€è¦çš„æƒ…å†µä¸‹ï¼ˆå¦‚å‹¤å·¥ä¿­å­¦ã€å®ä¹ ï¼‰ï¼Œéœ€<strong>å–å¾—å…¶ç›‘æŠ¤äººçš„æ˜ç¡®ä¹¦é¢åŒæ„</strong></li>
          <li>ç›‘æŠ¤äººåŒæ„åï¼Œä»…æ”¶é›†æä¾›æœåŠ¡æ‰€å¿…éœ€çš„æœ€å°‘ä¿¡æ¯</li>
          <li>ä¸å¯¹æœªæˆå¹´äººç”¨æˆ·ç”»åƒè¿›è¡Œä¸ªæ€§åŒ–æ¨è</li>
          <li>é™åˆ¶ AI å¯¹è¯æœåŠ¡ä¸­å¯èƒ½å½±å“æœªæˆå¹´äººèº«å¿ƒå¥åº·çš„å†…å®¹è¾“å‡º</li>
        </ul>
        <h3>2.3 æœªæˆå¹´äººä¿¡æ¯ä¸“é¡¹ä¿æŠ¤</h3>
        <ul>
          <li>å·²æŒ‡å®šä¸“äººè´Ÿè´£æœªæˆå¹´äººä¸ªäººä¿¡æ¯ä¿æŠ¤å·¥ä½œ</li>
          <li>å¯¹æ¶‰åŠæœªæˆå¹´äººä¸ªäººä¿¡æ¯çš„æ“ä½œè¿›è¡Œä¸¥æ ¼çš„è®¿é—®æ§åˆ¶å’Œå®¡è®¡</li>
          <li>æœªæˆå¹´äººåŠå…¶ç›‘æŠ¤äººæœ‰æƒéšæ—¶è¦æ±‚æŸ¥é˜…ã€æ›´æ­£æˆ–åˆ é™¤æœªæˆå¹´äººçš„ä¸ªäººä¿¡æ¯</li>
        </ul>

        <h2>ä¸‰ã€ç›‘æŠ¤äººæƒåˆ©ä¸ä¹‰åŠ¡</h2>
        <p>è‹¥æ‚¨æ˜¯æœªæˆå¹´äººçš„ç›‘æŠ¤äººï¼Œè¯·ç‰¹åˆ«æ³¨æ„ä»¥ä¸‹äº‹é¡¹ï¼š</p>
        <h3>3.1 ç›‘æŠ¤äººæƒåˆ©</h3>
        <ul>
          <li><strong>çŸ¥æƒ…æƒ</strong>ï¼šäº†è§£è¢«ç›‘æŠ¤äººåœ¨æœ¬å¹³å°ä¸Šçš„æ´»åŠ¨æƒ…å†µ</li>
          <li><strong>åŒæ„æƒ</strong>ï¼šè¢«ç›‘æŠ¤äººæ³¨å†Œä½¿ç”¨æœ¬å¹³å°éœ€å–å¾—æ‚¨çš„åŒæ„</li>
          <li><strong>æŸ¥é˜…æƒ</strong>ï¼šæŸ¥é˜…è¢«ç›‘æŠ¤äººåœ¨æœ¬å¹³å°çš„ä¸ªäººä¿¡æ¯</li>
          <li><strong>æ›´æ­£åˆ é™¤æƒ</strong>ï¼šæ›´æ­£æˆ–è¦æ±‚åˆ é™¤è¢«ç›‘æŠ¤äººçš„ä¸ªäººä¿¡æ¯</li>
          <li><strong>æ³¨é”€æƒ</strong>ï¼šè¦æ±‚æ³¨é”€è¢«ç›‘æŠ¤äººçš„è´¦æˆ·</li>
        </ul>
        <h3>3.2 ç›‘æŠ¤äººä¹‰åŠ¡</h3>
        <ul>
          <li>è¯·æ•™è‚²å’Œå¼•å¯¼è¢«ç›‘æŠ¤äººæ­£ç¡®ä½¿ç”¨äº’è”ç½‘æœåŠ¡</li>
          <li>è¯·æŒ‡å¯¼è¢«ç›‘æŠ¤äººåœ¨ä½¿ç”¨ä»»ä½•äº’è”ç½‘æœåŠ¡å‰å…ˆé˜…è¯»å¹¶ç†è§£ç›¸å…³åè®®</li>
          <li>åˆç†å®‰æ’è¢«ç›‘æŠ¤äººä¸Šç½‘æ—¶é—´ï¼Œå…³æ³¨å…¶ç½‘ç»œè¡Œä¸º</li>
        </ul>
        <h3>3.3 ç›‘æŠ¤äººä¸¾æŠ¥å¤„ç†</h3>
        <ul>
          <li>å¦‚æ‚¨å‘ç°è¢«ç›‘æŠ¤äººæœªç»æ‚¨åŒæ„åœ¨æœ¬å¹³å°æ³¨å†Œäº†è´¦æˆ·ï¼Œè¯·<strong>ç«‹å³</strong>é€šè¿‡ã€Œåé¦ˆå»ºè®®ã€è”ç³»æˆ‘ä»¬ï¼Œå¹¶æä¾›ç›‘æŠ¤å…³ç³»è¯æ˜</li>
          <li>æˆ‘ä»¬å°†åœ¨æ ¸å®èº«ä»½å <strong>24 å°æ—¶å†…å†»ç»“</strong>è¯¥è´¦æˆ·</li>
          <li>åœ¨ <strong>7 ä¸ªå·¥ä½œæ—¥å†…</strong>åˆ é™¤è¯¥è´¦æˆ·å…¨éƒ¨ä¸ªäººä¿¡æ¯</li>
          <li>æ­¤ç±»ä¸¾æŠ¥å°†ä½œä¸º<strong>æœ€é«˜ä¼˜å…ˆçº§</strong>å¤„ç†</li>
        </ul>

        <h2>å››ã€å†…å®¹å®‰å…¨ä¿æŠ¤</h2>
        <h3>4.1 ç¦æ­¢å†…å®¹</h3>
        <ul>
          <li>ä¸¥ç¦å‘å¸ƒä»»ä½•å±å®³æœªæˆå¹´äººèº«å¿ƒå¥åº·çš„å†…å®¹</li>
          <li>ä¸¥ç¦å‘å¸ƒæ¶‰åŠéæ³•é›‡ä½£æœªæˆå¹´äººçš„å²—ä½ä¿¡æ¯ï¼ˆè¿åã€Šç¦æ­¢ä½¿ç”¨ç«¥å·¥è§„å®šã€‹ç­‰æ³•è§„ï¼‰</li>
          <li>ä¸¥ç¦å‘å¸ƒå¼•è¯±ã€æ•™å”†ã€èƒè¿«æœªæˆå¹´äººä»äº‹è¿æ³•æ´»åŠ¨çš„ä¿¡æ¯</li>
          <li>ä¸¥ç¦å‘å¸ƒä¾®è¾±ã€æ¬ºå‡Œã€è™å¾…æœªæˆå¹´äººçš„ä¿¡æ¯</li>
          <li>ä¸¥ç¦å‘å¸ƒå¯èƒ½å¼•è¯±æœªæˆå¹´äººæ²‰è¿·ç½‘ç»œçš„ä¿¡æ¯</li>
        </ul>
        <h3>4.2 æŠ€æœ¯ä¿æŠ¤æªæ–½</h3>
        <ul>
          <li>AI å¯¹è¯æœåŠ¡å†…ç½®å¤šå±‚å†…å®¹å®‰å…¨è¿‡æ»¤æœºåˆ¶ï¼Œè‡ªåŠ¨æ‹¦æˆªä¸é€‚å®œå†…å®¹</li>
          <li>ç”¨æˆ·å‘å¸ƒçš„å†…å®¹ç»è¿‡è‡ªåŠ¨å®¡æ ¸å’Œäººå·¥å·¡æŸ¥åŒé‡æœºåˆ¶</li>
          <li>å»ºç«‹æœªæˆå¹´äººç›¸å…³å†…å®¹çš„ä¼˜å…ˆå·¡æŸ¥å’Œå¿«é€Ÿå¤„ç½®é€šé“</li>
        </ul>
        <h3>4.3 ç”¨å·¥åˆè§„æ£€æµ‹</h3>
        <ul>
          <li>ç³»ç»Ÿå¯¹å²—ä½ä¿¡æ¯è¿›è¡Œåˆè§„æ€§æ£€æµ‹ï¼Œæ ‡è®°å¯èƒ½æ¶‰åŠè¿æ³•ç”¨å·¥ï¼ˆå¦‚è¶…æ—¶å·¥ä½œã€æœ‰å®³å·¥ç§ç­‰ï¼‰çš„å²—ä½</li>
          <li>å‘ç°æ¶‰å«Œéæ³•é›‡ä½£æœªæˆå¹´äººçš„è¡Œä¸ºï¼Œå°†ä¿ç•™è¯æ®å¹¶å‘åŠ³åŠ¨ç›‘å¯Ÿéƒ¨é—¨æŠ¥å‘Š</li>
        </ul>

        <h2>äº”ã€ç®—æ³•æ¨èä¸æœªæˆå¹´äºº</h2>
        <ul>
          <li>å¦‚è¯†åˆ«åˆ°ç”¨æˆ·å¯èƒ½ä¸ºæœªæˆå¹´äººï¼Œå°†<strong>ä¸å¯¹å…¶å¯ç”¨</strong>åŸºäºç”¨æˆ·ç”»åƒçš„ä¸ªæ€§åŒ–æ¨è</li>
          <li>ä¸å‘å¯èƒ½çš„æœªæˆå¹´äººç”¨æˆ·æ¨é€è¯±å¯¼æ¶ˆè´¹ï¼ˆå¦‚ Token å……å€¼ï¼‰çš„ä¿¡æ¯</li>
          <li>ä¸åˆ©ç”¨ç®—æ³•å‘å¯èƒ½çš„æœªæˆå¹´äººç”¨æˆ·æ¨é€å¯èƒ½å½±å“å…¶ä»·å€¼è§‚å½¢æˆçš„å†…å®¹</li>
        </ul>

        <h2>å…­ã€ç½‘ç»œæ²‰è¿·é˜²æŠ¤</h2>
        <p>è™½ç„¶æœ¬å¹³å°ä¸ºä¸“ä¸šå·¥å…·å‹äº§å“ï¼Œä½†æˆ‘ä»¬ä»å…³æ³¨é˜²æ²‰è¿·é—®é¢˜ï¼š</p>
        <ul>
          <li>å¹³å°ä¸è®¾è®¡æ¸¸æˆåŒ–æœºåˆ¶æˆ–æˆç˜¾æ€§åŠŸèƒ½æ¥è¯±å¯¼ç”¨æˆ·æŒç»­ä½¿ç”¨</li>
          <li>ä¸åœ¨å¤œé—´ï¼ˆ22:00-8:00ï¼‰å‘æœªæˆå¹´äººæ¨é€é€šçŸ¥æ¶ˆæ¯</li>
          <li>ä¸è®¾è®¡åˆºæ¿€æ€§æ¶ˆè´¹å¼•å¯¼æœºåˆ¶è¯±å¯¼æœªæˆå¹´äººå……å€¼</li>
        </ul>

        <h2>ä¸ƒã€æŠ•è¯‰ä¸ä¸¾æŠ¥</h2>
        <p>å¦‚æ‚¨å‘ç°æœ¬å¹³å°ä¸Šå­˜åœ¨ä»»ä½•ä¾µå®³æœªæˆå¹´äººåˆæ³•æƒç›Šçš„è¡Œä¸ºï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¸¾æŠ¥ï¼š</p>
        <h3>7.1 å¹³å°ä¸¾æŠ¥æ¸ é“</h3>
        <ul>
          <li>é€šè¿‡æœ¬å¹³å°ã€Œåé¦ˆå»ºè®®ã€åŠŸèƒ½ï¼Œé€‰æ‹©"æŠ•è¯‰"ç±»å‹æäº¤ï¼Œè¯·åœ¨æ ‡é¢˜ä¸­æ³¨æ˜"æœªæˆå¹´äººä¿æŠ¤"</li>
          <li>æ¶‰åŠæœªæˆå¹´äººä¿æŠ¤çš„ä¸¾æŠ¥å°†ä½œä¸º<strong>æœ€é«˜ä¼˜å…ˆçº§</strong>å¤„ç†</li>
          <li>æˆ‘ä»¬æ‰¿è¯ºåœ¨<strong> 24 å°æ—¶å†…</strong>å—ç†å¹¶å“åº”æ¶‰åŠæœªæˆå¹´äººä¿æŠ¤çš„ä¸¾æŠ¥</li>
        </ul>
        <h3>7.2 å¤–éƒ¨ä¸¾æŠ¥æ¸ é“</h3>
        <ul>
          <li><strong>å…¨å›½ç½‘ä¿¡ç³»ç»Ÿä¸¾æŠ¥ä¸­å¿ƒ</strong>ï¼šwww.12377.cn</li>
          <li><strong>å…¨å›½æœªæˆå¹´äººä¿æŠ¤çƒ­çº¿</strong>ï¼š12309</li>
          <li><strong>åŠ³åŠ¨ä¿éšœç›‘å¯ŸæŠ•è¯‰</strong>ï¼š12333</li>
        </ul>
        <h3>7.3 ä¸¾æŠ¥ä¿æŠ¤</h3>
        <ul>
          <li>æˆ‘ä»¬ä¸¥æ ¼ä¿æŠ¤ä¸¾æŠ¥äººä¿¡æ¯ï¼Œä¸å‘è¢«ä¸¾æŠ¥æ–¹é€éœ²ä¸¾æŠ¥äººèº«ä»½</li>
          <li>ç¦æ­¢å¯¹ä¸¾æŠ¥äººè¿›è¡Œä»»ä½•å½¢å¼çš„æ‰“å‡»æŠ¥å¤</li>
        </ul>

        <h2>å…«ã€æ³•å¾‹è´£ä»»</h2>
        <p>æˆ‘ä»¬ä¸¥æ ¼éµå®ˆã€Šæœªæˆå¹´äººä¿æŠ¤æ³•ã€‹ã€Šé¢„é˜²æœªæˆå¹´äººçŠ¯ç½ªæ³•ã€‹ã€Šå„¿ç«¥ä¸ªäººä¿¡æ¯ç½‘ç»œä¿æŠ¤è§„å®šã€‹ç­‰æ³•å¾‹æ³•è§„ã€‚å¦‚å› æˆ‘ä»¬çš„è¿‡å¤±å¯¼è‡´æœªæˆå¹´äººæƒç›Šå—åˆ°ä¾µå®³ï¼Œå°†ä¾æ³•æ‰¿æ‹…æ³•å¾‹è´£ä»»ã€‚</p>
      </div>
    </div>
  );
};

// --- æŠ•è¯‰ä¸¾æŠ¥æŒ‡å¼•é¡µé¢ ---
const ComplaintGuideView = () => {
  const navigate = useNavigate();
  return (
    <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 max-w-4xl mx-auto animate-in fade-in duration-500">
      <div className="flex items-center gap-4 mb-8">
        <button onClick={() => navigate(-1)} className="p-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 transition-all"><ChevronLeft size={20} className="text-slate-600" /></button>
        <div>
          <h1 className="text-2xl font-black text-slate-900">æŠ•è¯‰ä¸¾æŠ¥æŒ‡å¼•</h1>
          <p className="text-slate-500 text-sm">æ›´æ–°æ—¥æœŸï¼š2026 å¹´ 1 æœˆ 15 æ—¥</p>
        </div>
      </div>
      <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-8 md:p-12 prose prose-slate max-w-none prose-headings:font-black prose-h2:text-lg prose-h2:mt-8 prose-h2:mb-3 prose-h3:text-base prose-h3:mt-5 prose-h3:mb-2 prose-p:text-sm prose-p:leading-relaxed prose-p:text-slate-600 prose-li:text-sm prose-li:text-slate-600">
        <p className="text-sm text-slate-500 bg-slate-50 rounded-lg p-4 border border-slate-100 mb-8">
          Devnors å¾—è‹¥å¹³å°è‡´åŠ›äºä¸ºç”¨æˆ·æä¾›å®‰å…¨ã€åˆè§„çš„æ‹›è˜æœåŠ¡ç¯å¢ƒã€‚å¦‚æ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°è¿æ³•è¿è§„è¡Œä¸ºï¼Œæ¬¢è¿é€šè¿‡ä»¥ä¸‹æ¸ é“è¿›è¡ŒæŠ•è¯‰ä¸¾æŠ¥ã€‚
        </p>

        <h2>ä¸€ã€å¯ä¸¾æŠ¥çš„è¿è§„è¡Œä¸º</h2>
        <h3>1.1 ä¿¡æ¯ç±»è¿è§„</h3>
        <ul>
          <li>å‘å¸ƒè™šå‡æ‹›è˜ä¿¡æ¯æˆ–æ¬ºè¯ˆæ€§å²—ä½</li>
          <li>å‘å¸ƒå«æœ‰æ­§è§†æ€§å†…å®¹çš„èŒä½ï¼ˆæ€§åˆ«ã€å¹´é¾„ã€æ°‘æ—ã€å®—æ•™ç­‰æ­§è§†ï¼‰</li>
          <li>å†’ç”¨ä»–äººæˆ–ä»–å…¬å¸èº«ä»½å‘å¸ƒä¿¡æ¯</li>
          <li>å‘å¸ƒè¿æ³•ã€è‰²æƒ…ã€æš´åŠ›ç­‰ä¸å½“å†…å®¹</li>
        </ul>
        <h3>1.2 è¡Œä¸ºç±»è¿è§„</h3>
        <ul>
          <li>ä»¥æ‹›è˜ä¸ºåå®æ–½è¯ˆéª—ï¼ˆæ”¶å–è´¹ç”¨ã€éª—å–ä¸ªäººä¿¡æ¯ç­‰ï¼‰</li>
          <li>éªšæ‰°ã€å¨èƒå…¶ä»–ç”¨æˆ·</li>
          <li>éæ³•æ”¶é›†ã€ä¹°å–ä¸ªäººä¿¡æ¯</li>
          <li>åˆ©ç”¨å¹³å°ä»äº‹ä¼ é”€æˆ–å…¶ä»–éæ³•æ´»åŠ¨</li>
        </ul>
        <h3>1.3 æŠ€æœ¯ç±»è¿è§„</h3>
        <ul>
          <li>æ¶æ„æ”»å‡»å¹³å°ç³»ç»Ÿæˆ–å¹²æ‰°æ­£å¸¸è¿è¡Œ</li>
          <li>ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·è¿è§„é‡‡é›†æ•°æ®</li>
          <li>åˆ©ç”¨ç³»ç»Ÿæ¼æ´è·å–ä¸æ­£å½“åˆ©ç›Š</li>
        </ul>

        <h2>äºŒã€ä¸¾æŠ¥æ¸ é“</h2>
        <h3>2.1 å¹³å°å†…ä¸¾æŠ¥</h3>
        <p>é€šè¿‡æœ¬å¹³å°ã€Œåé¦ˆå»ºè®®ã€åŠŸèƒ½æäº¤å·¥å•ï¼Œé€‰æ‹©"æŠ•è¯‰"ç±»å‹ï¼š</p>
        <ul>
          <li>æ ‡é¢˜ä¸­æ³¨æ˜"ä¸¾æŠ¥"å­—æ ·</li>
          <li>è¯¦ç»†æè¿°è¿è§„è¡Œä¸ºã€æ¶‰åŠçš„ç”¨æˆ·æˆ–èŒä½ä¿¡æ¯</li>
          <li>å¦‚æœ‰æˆªå›¾ç­‰è¯æ®ææ–™ï¼Œå¯åœ¨æè¿°ä¸­è¯´æ˜</li>
        </ul>
        <h3>2.2 å¤–éƒ¨ä¸¾æŠ¥æ¸ é“</h3>
        <ul>
          <li>å…¨å›½äº’è”ç½‘è¿æ³•å’Œä¸è‰¯ä¿¡æ¯ä¸¾æŠ¥ä¸­å¿ƒï¼šwww.12377.cn</li>
          <li>å›½å®¶ç½‘ä¿¡åŠä¸¾æŠ¥ç”µè¯ï¼š12377</li>
          <li>å½“åœ°äººåŠ›èµ„æºå’Œç¤¾ä¼šä¿éšœéƒ¨é—¨</li>
          <li>å…¬å®‰æœºå…³ç½‘ç»œå®‰å…¨ä¿å«éƒ¨é—¨</li>
        </ul>

        <h2>ä¸‰ã€ä¸¾æŠ¥å¤„ç†æµç¨‹</h2>
        <ul>
          <li><strong>å—ç†</strong>ï¼šæ”¶åˆ°ä¸¾æŠ¥å 24 å°æ—¶å†…ç¡®è®¤å—ç†å¹¶å‘é€é€šçŸ¥</li>
          <li><strong>è°ƒæŸ¥</strong>ï¼š3 ä¸ªå·¥ä½œæ—¥å†…å®Œæˆåˆæ­¥è°ƒæŸ¥æ ¸å®</li>
          <li><strong>å¤„ç½®</strong>ï¼šæ ¹æ®è¿è§„ä¸¥é‡ç¨‹åº¦é‡‡å–è­¦å‘Šã€ä¸‹æ¶å†…å®¹ã€å°ç¦è´¦æˆ·ç­‰æªæ–½</li>
          <li><strong>åé¦ˆ</strong>ï¼šåœ¨å¤„ç†å®Œæˆå 5 ä¸ªå·¥ä½œæ—¥å†…å‘ä¸¾æŠ¥äººåé¦ˆå¤„ç†ç»“æœ</li>
          <li><strong>ç§»äº¤</strong>ï¼šæ¶‰å«Œè¿æ³•çŠ¯ç½ªçš„ï¼Œä¾æ³•ç§»äº¤å…¬å®‰æœºå…³æˆ–ç›¸å…³éƒ¨é—¨å¤„ç†</li>
        </ul>

        <h2>å››ã€ä¸¾æŠ¥äººä¿æŠ¤</h2>
        <ul>
          <li>æˆ‘ä»¬å¯¹ä¸¾æŠ¥äººä¿¡æ¯ä¸¥æ ¼ä¿å¯†ï¼Œä¸å‘è¢«ä¸¾æŠ¥æ–¹é€éœ²ä¸¾æŠ¥äººèº«ä»½</li>
          <li>ç¦æ­¢ä»»ä½•å½¢å¼çš„æ‰“å‡»æŠ¥å¤è¡Œä¸º</li>
          <li>ä¸¾æŠ¥äººä¸ä¼šå› å–„æ„ä¸¾æŠ¥è¡Œä¸ºå—åˆ°ä¸åˆ©å¤„ç†</li>
        </ul>

        <h2>äº”ã€æ¶æ„ä¸¾æŠ¥è´£ä»»</h2>
        <p>å¦‚æŸ¥å®ä¸¾æŠ¥ä¸ºæ¶æ„è¡Œä¸ºï¼ˆæé€ äº‹å®ã€è¯½è°¤ä»–äººï¼‰ï¼Œæˆ‘ä»¬ä¿ç•™å¯¹æ¶æ„ä¸¾æŠ¥äººé‡‡å–é™åˆ¶æªæ–½å’Œè¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚</p>
      </div>
    </div>
  );
};

// --- ç‰ˆæœ¬æ›´æ–°é¡µé¢ ---
const ChangelogView = () => {
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState<'web' | 'app' | 'agent'>('web');
  const [changelog, setChangelog] = useState<any[]>([]);
  const [loadingChangelog, setLoadingChangelog] = useState(true);

  useEffect(() => {
    const fetchChangelog = async () => {
      try {
        setLoadingChangelog(true);
        const { getChangelog } = await import('./services/apiService');
        const data = await getChangelog();
        setChangelog(data);
      } catch (err) {
        console.error('Failed to load changelog:', err);
      } finally {
        setLoadingChangelog(false);
      }
    };
    fetchChangelog();
  }, []);

  const appChangelog = [
    {
      version: 'v1.0.1',
      date: '2026-02-14',
      tag: 'æœ€æ–°',
      tagColor: 'bg-emerald-100 text-emerald-700',
      items: [
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'å…¨é¢é‡‡ç”¨è‡ªå®šä¹‰ PageHeader æ›¿ä»£ iOS åŸç”Ÿå¯¼èˆªæ ï¼Œå½»åº•è§£å†³è¿”å›æŒ‰é’®ç™½è‰²èƒŒæ™¯é—®é¢˜ï¼Œ15 ä¸ª common é¡µé¢ + auth é¡µå…¨éƒ¨ç»Ÿä¸€' },
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'ç”¨æˆ·èµ„æ–™é¡µå¯¹é½ Web ç«¯ï¼šå¤´åƒï¼ˆavatar_url å›¾ç‰‡ / æ¸å˜é¦–å­—æ¯å…œåº•ï¼‰ã€UIDã€è„±æ•æ‰‹æœºå·ï¼ˆ138****1234ï¼‰ã€è®¤è¯çŠ¶æ€ã€é‚€è¯·ç å®Œæ•´å±•ç¤º' },
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'ç»Ÿä¸€ Avatar å¤´åƒç»„ä»¶ï¼šexpo-linear-gradient æ¸å˜èƒŒæ™¯ï¼ˆindigoâ†’purpleï¼Œä¸ Web ä¸€è‡´ï¼‰ã€ç›¸å¯¹è·¯å¾„è‡ªåŠ¨æ‹¼æ¥ç»å¯¹ URLã€å›¾ç‰‡åŠ è½½å¤±è´¥è‡ªåŠ¨å…œåº•' },
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'èº«ä»½åˆ‡æ¢åŠŸèƒ½ä¸Šçº¿ï¼šå€™é€‰äºº/æ‹›è˜æ–¹ Profile é¡µæ–°å¢"åˆ‡æ¢ä¸ºæ‹›è˜æ–¹/æ±‚èŒè€…"æŒ‰é’®ï¼ŒModal é®ç½©åŠ¨ç”» + ç¡®è®¤å¯¹è¯æ¡†' },
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'ç™»å½•é¡µæµ‹è¯•è´¦å·å¯¹é½ Webï¼šæ±‚èŒè€…æµ‹è¯•ï¼ˆtest@example.comï¼‰ã€ä¼ä¸šæ–¹æµ‹è¯•ï¼ˆhr@devnors.comï¼‰' },
        { type: 'ä¿®å¤', color: 'text-amber-600 bg-amber-50', desc: 'ä¿®å¤æ¶ˆæ¯é€šçŸ¥å§‹ç»ˆä¸ºç©ºçš„ä¸¥é‡ bugï¼šåç«¯è¿”å› notifications å­—æ®µï¼ŒAPP é”™è¯¯ä½¿ç”¨ items è§£æï¼Œå¯¼è‡´æ•°æ®æ— æ³•å±•ç¤º' },
        { type: 'ä¿®å¤', color: 'text-amber-600 bg-amber-50', desc: 'ä¿®å¤ Notification ç±»å‹å®šä¹‰ç¼ºå¤±ï¼šè¡¥å…¨ typeã€importanceã€iconã€timeã€senderã€read ç­‰åç«¯å®é™…è¿”å›å­—æ®µ' },
        { type: 'ä¿®å¤', color: 'text-amber-600 bg-amber-50', desc: 'ä¿®å¤æ‹›è˜æ–¹ Profile é¡µ AI åŠ©æ‰‹èœå•é¡¹ç‚¹å‡»æ— å“åº”ï¼šonPress å›è°ƒæœªè¢«è°ƒç”¨' },
        { type: 'ä¼˜åŒ–', color: 'text-indigo-600 bg-indigo-50', desc: 'æ¶ˆæ¯ä¸­å¿ƒå®Œå…¨å¯¹é½ Web ç«¯ï¼šç±»å‹ç­›é€‰ Tabï¼ˆå…¨éƒ¨/ç³»ç»Ÿ/åŒ¹é…/é¢è¯•/äº’åŠ¨ï¼‰ã€é‡è¦æ€§æ ‡è®°ã€ç›¸å¯¹æ—¶é—´ã€å›¾æ ‡æ˜ å°„ã€å…¨éƒ¨å·²è¯»' },
        { type: 'ä¼˜åŒ–', color: 'text-indigo-600 bg-indigo-50', desc: 'ç¼–è¾‘èµ„æ–™é¡µå¢å¼ºï¼š80px å¤´åƒå¤§å›¾å±•ç¤ºã€UID æ˜¾ç¤ºã€è®¤è¯çŠ¶æ€ã€ä¸Šæ¬¡ç™»å½•æ—¶é—´ã€å¤´åƒé“¾æ¥ç¼–è¾‘å­—æ®µ' },
        { type: 'ä¼˜åŒ–', color: 'text-indigo-600 bg-indigo-50', desc: 'é€šçŸ¥å¡ç‰‡è§†è§‰é‡æ„ï¼šcritical çº¢è‰²è¾¹æ¡†+é‡è¦æ ‡ç­¾+è„‰å†²çº¢ç‚¹ã€unread indigo èƒŒæ™¯+è“ç‚¹ã€sender æ¥æºæ ‡ç­¾ã€é•¿æŒ‰åˆ é™¤ç¡®è®¤' },
      ],
    },
    {
      version: 'v1.0.0',
      date: '2026-02-13',
      tag: 'é¦–å‘',
      tagColor: 'bg-indigo-100 text-indigo-700',
      items: [
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'Devnors ç§»åŠ¨ç«¯ App é¦–ä¸ªç‰ˆæœ¬å‘å¸ƒï¼ˆReact Native + Expo Routerï¼‰' },
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'æ”¯æŒæ±‚èŒè€…å’Œæ‹›è˜æ–¹åŒè§’è‰²æ³¨å†Œç™»å½•ä¸èº«ä»½åˆ‡æ¢' },
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'æ±‚èŒè€…åŠŸèƒ½ä¸Šçº¿ï¼šå²—ä½æ¨èæµè§ˆã€AI åŠ©æ‰‹å¯¹è¯ã€æŠ•é€’ç®¡ç†ã€æ¶ˆæ¯ä¸­å¿ƒã€ä¸ªäººæ¡£æ¡ˆç¼–è¾‘' },
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'æ‹›è˜æ–¹åŠŸèƒ½ä¸Šçº¿ï¼šå·¥ä½œå°æ•°æ®çœ‹æ¿ã€å²—ä½å‘å¸ƒç®¡ç†ã€äººæ‰æ± æµè§ˆã€AI åŠ©æ‰‹ã€æ¶ˆæ¯ä¸­å¿ƒ' },
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'AI åŠ©æ‰‹é›†æˆï¼šæ”¯æŒå¤šæ¨¡å‹é€‰æ‹©ã€å¿«æ·æ“ä½œé¢æ¿ã€ä»»åŠ¡åˆ—è¡¨ç®¡ç†' },
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'é€šç”¨åŠŸèƒ½æ¨¡å—ï¼šé€šçŸ¥ä¸­å¿ƒã€Token ç®¡ç†ä¸å……å€¼ã€ç³»ç»Ÿè®¾ç½®ã€å²—ä½/å€™é€‰äºº/å·¥ä½œæµè¯¦æƒ…é¡µ' },
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'NativeWind (Tailwind CSS) æ ·å¼ç³»ç»Ÿï¼ŒåŸç”Ÿä½“éªŒä¸ Web è®¾è®¡è¯­è¨€ç»Ÿä¸€' },
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'Expo Router æ–‡ä»¶ç³»ç»Ÿè·¯ç”±ï¼Œæ”¯æŒ (auth)/(candidate)/(employer)/(common) å››å¤§è·¯ç”±åˆ†ç»„' },
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'Zustand çŠ¶æ€ç®¡ç†ï¼šè®¤è¯çŠ¶æ€æŒä¹…åŒ–ï¼ˆAsyncStorageï¼‰ã€ä¸»é¢˜åˆ‡æ¢' },
        { type: 'æ–°åŠŸèƒ½', color: 'text-emerald-600 bg-emerald-50', desc: 'å®Œæ•´ API æœåŠ¡å±‚ï¼šauthã€jobsã€candidatesã€flowsã€aiã€tokensã€notifications ç­‰æ¨¡å—' },
      ],
    },
  ];

  const agentMajorVersions = [
    {
      version: 'Devnors 1.0',
      date: '2026-02-02',
      tag: 'å½“å‰ç‰ˆæœ¬',
      tagColor: 'bg-emerald-100 text-emerald-700',
      summary: 'é¦–ä¸ªæ­£å¼ç‰ˆæœ¬ï¼ŒAI åŸç”Ÿæ‹›è˜æ™ºèƒ½ä½“',
      tiers: [
        {
          name: 'Ultra',
          label: 'æ——èˆ°ç‰ˆ',
          gradient: 'from-amber-500 to-orange-500',
          specs: [
            { label: 'ä¸Šä¸‹æ–‡', value: '128K tokens Â· 8K è¾“å‡º Â· 20+ è½®å¯¹è¯' },
            { label: 'åŒ¹é…', value: 'å‡†ç¡®ç‡ â‰¥ 95%ï¼Œç®€å†è§£æ 98%' },
          ],
          highlights: [
            'å…¨æµç¨‹ Agent ç¼–æ’ï¼Œè®°å¿†ç³»ç»Ÿæ·±åº¦èåˆ',
            'ç»“æ„åŒ– JSON è¾“å‡ºï¼Œå¯å¯¹æ¥ä¼ä¸š ATS',
          ],
        },
        {
          name: 'Pro',
          label: 'ä¸“ä¸šç‰ˆ',
          gradient: 'from-indigo-500 to-purple-500',
          specs: [
            { label: 'ä¸Šä¸‹æ–‡', value: '64K tokens Â· 4K è¾“å‡º Â· 10 è½®å¯¹è¯' },
            { label: 'åŒ¹é…', value: 'å‡†ç¡®ç‡ â‰¥ 88%ï¼Œç®€å†è§£æ 92%' },
          ],
          highlights: [
            'æ™ºèƒ½åŒ¹é…ã€ç®€å†è§£æã€AI å¯¹è¯ã€æ™ºèƒ½é‚€è¯·/æŠ•é€’',
          ],
        },
        {
          name: 'é»˜è®¤',
          label: 'åŸºç¡€ç‰ˆ',
          gradient: 'from-slate-400 to-slate-500',
          specs: [
            { label: 'ä¸Šä¸‹æ–‡', value: '16K tokens Â· 2K è¾“å‡º Â· 5 è½®å¯¹è¯' },
            { label: 'åŒ¹é…', value: 'å‡†ç¡®ç‡ â‰¥ 80%ï¼Œç®€å†è§£æ 85%' },
          ],
          highlights: [
            'åŸºç¡€ AI å¯¹è¯ã€å²—ä½æ¨èã€å¸®åŠ©ä¸­å¿ƒé—®ç­”',
          ],
        },
      ],
    },
  ];

  return (
    <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 max-w-4xl mx-auto animate-in fade-in duration-500">
      <div className="flex items-center gap-4 mb-8">
        <button onClick={() => navigate(-1)} className="p-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 transition-all">
          <ChevronLeft size={20} className="text-slate-600" />
        </button>
        <div>
          <h1 className="text-2xl font-black text-slate-900">ç‰ˆæœ¬æ›´æ–°</h1>
          <p className="text-slate-500 text-sm">Devnors å¾—è‹¥ Web Â· APP Â· Agent æ›´æ–°æ—¥å¿—</p>
        </div>
      </div>

      {/* Tab åˆ‡æ¢ */}
      <div className="flex gap-2 mb-8">
        <button
          onClick={() => setActiveTab('web')}
          className={`px-5 py-2.5 rounded-lg font-bold text-sm transition-all ${activeTab === 'web' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-100' : 'bg-white text-slate-500 border border-slate-200 hover:border-indigo-200 hover:text-indigo-600'}`}
        >
          Webæ›´æ–°
        </button>
        <button
          onClick={() => setActiveTab('app')}
          className={`px-5 py-2.5 rounded-lg font-bold text-sm transition-all flex items-center gap-2 ${activeTab === 'app' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-100' : 'bg-white text-slate-500 border border-slate-200 hover:border-indigo-200 hover:text-indigo-600'}`}
        >
          <Smartphone size={16} /> APPæ›´æ–°
        </button>
        <button
          onClick={() => setActiveTab('agent')}
          className={`px-5 py-2.5 rounded-lg font-bold text-sm transition-all flex items-center gap-2 ${activeTab === 'agent' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-100' : 'bg-white text-slate-500 border border-slate-200 hover:border-indigo-200 hover:text-indigo-600'}`}
        >
          <Bot size={16} /> Agent æ›´æ–°
        </button>
      </div>

      {activeTab === 'web' ? (
        loadingChangelog ? (
          <div className="flex items-center justify-center py-20">
            <div className="animate-spin rounded-full h-8 w-8 border-2 border-indigo-200 border-t-indigo-600" />
            <span className="ml-3 text-sm text-slate-500">åŠ è½½æ›´æ–°è®°å½•...</span>
          </div>
        ) : changelog.length === 0 ? (
          <div className="text-center py-20 text-slate-400 text-sm">æš‚æ— æ›´æ–°è®°å½•</div>
        ) : (
        <div className="relative">
          {/* æ—¶é—´è½´çº¿ */}
          <div className="absolute left-[19px] top-0 bottom-0 w-px bg-slate-200" />

          <div className="space-y-12">
            {changelog.map((release: any, idx: number) => (
              <div key={release.version} className="relative pl-12">
                {/* æ—¶é—´è½´åœ†ç‚¹ */}
                <div className={`absolute left-2.5 top-1 w-4 h-4 rounded-full border-2 ${idx === 0 ? 'bg-indigo-600 border-indigo-600' : 'bg-white border-slate-300'}`} />

                <div className="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
                  <div className="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <span className="text-lg font-black text-slate-900">{release.version}</span>
                      {release.tag && (
                        <span className={`px-2 py-0.5 rounded-full text-[11px] font-bold ${release.tagColor}`}>{release.tag}</span>
                      )}
                    </div>
                    <span className="text-xs text-slate-400 font-medium">{release.date}</span>
                  </div>
                  <div className="p-6 space-y-3">
                    {release.items.map((item, i) => (
                      <div key={i} className="flex items-start gap-3">
                        <span className={`px-2 py-0.5 rounded text-[11px] font-bold shrink-0 mt-0.5 ${item.color}`}>{item.type}</span>
                        <p className="text-sm text-slate-600">{item.desc}</p>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
        )
      ) : activeTab === 'app' ? (
        <div className="relative">
          {/* æ—¶é—´è½´çº¿ */}
          <div className="absolute left-[19px] top-0 bottom-0 w-px bg-slate-200" />

          <div className="space-y-12">
            {appChangelog.map((release, idx) => (
              <div key={release.version} className="relative pl-12">
                {/* æ—¶é—´è½´åœ†ç‚¹ */}
                <div className={`absolute left-2.5 top-1 w-4 h-4 rounded-full border-2 ${idx === 0 ? 'bg-indigo-600 border-indigo-600' : 'bg-white border-slate-300'}`} />

                <div className="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
                  <div className="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <span className="text-lg font-black text-slate-900">{release.version}</span>
                      {release.tag && (
                        <span className={`px-2 py-0.5 rounded-full text-[11px] font-bold ${release.tagColor}`}>{release.tag}</span>
                      )}
                    </div>
                    <span className="text-xs text-slate-400 font-medium">{release.date}</span>
                  </div>
                  <div className="p-6 space-y-3">
                    {release.items.map((item, i) => (
                      <div key={i} className="flex items-start gap-3">
                        <span className={`px-2 py-0.5 rounded text-[11px] font-bold shrink-0 mt-0.5 ${item.color}`}>{item.type}</span>
                        <p className="text-sm text-slate-600">{item.desc}</p>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      ) : (
        <div className="space-y-12">
          {agentMajorVersions.map((major, mIdx) => (
            <div key={major.version}>
              {/* å¤§ç‰ˆæœ¬å·å¤´éƒ¨ */}
              <div className="flex items-center gap-4 mb-6">
                <div className="w-14 h-14 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-100">
                  <Bot size={28} />
                </div>
                <div className="flex-1">
                  <div className="flex items-center gap-3">
                    <h2 className="text-2xl font-black text-slate-900">{major.version}</h2>
                    {major.tag && <span className={`px-2.5 py-0.5 rounded-full text-[11px] font-bold ${major.tagColor}`}>{major.tag}</span>}
                  </div>
                  <p className="text-sm text-slate-500 mt-0.5">{major.summary}</p>
                </div>
                <span className="text-xs text-slate-400 font-medium shrink-0">{major.date}</span>
              </div>

              {/* å­å‹å· */}
              <div className="space-y-4">
                {major.tiers.map((tier: any) => (
                  <div key={tier.name} className="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden p-5">
                    <div className="flex items-center gap-2.5 mb-3">
                      <span className={`px-3 py-1 rounded-md text-xs font-black text-white bg-gradient-to-r ${tier.gradient} shadow-sm`}>
                        {tier.name === 'é»˜è®¤' ? major.version : `${major.version} ${tier.name}`}
                      </span>
                      <span className="text-xs text-slate-400 font-medium">{tier.label}</span>
                    </div>
                    <div className="space-y-1.5">
                      {tier.specs.map((s: any, si: number) => (
                        <div key={`s-${si}`} className="flex items-start gap-3">
                          <span className="px-2 py-0.5 rounded text-[11px] font-bold shrink-0 mt-0.5 text-slate-500 bg-slate-100">{s.label}</span>
                          <p className="text-sm text-slate-600">{s.value}</p>
                        </div>
                      ))}
                      {tier.highlights.map((h: string, i: number) => (
                        <div key={`h-${i}`} className="flex items-start gap-3">
                          <span className="px-2 py-0.5 rounded text-[11px] font-bold shrink-0 mt-0.5 text-indigo-600 bg-indigo-50">ç‰¹æ€§</span>
                          <p className="text-sm text-slate-600">{h}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

// --- å¸®åŠ©ä¸­å¿ƒé¡µé¢ (HelpCenterView) ---
const HelpCenterView = () => {
  const navigate = useNavigate();
  const { user, isLoggedIn } = useAuth();
  const userId = user?.id || 0;

  // FAQ æ•°æ®
  const faqCategories = [
    {
      title: 'å¹³å°ä»‹ç»', icon: <Compass size={16} className="text-indigo-500" />,
      items: [
        { q: 'Devnors æ˜¯ä»€ä¹ˆï¼Ÿ', a: 'Devnorsï¼ˆå¾—è‹¥ï¼‰æ˜¯ä¸€æ¬¾ AI é©±åŠ¨çš„æ™ºèƒ½æ‹›è˜å¹³å°ï¼Œè¿æ¥æ±‚èŒè€…ä¸ä¼ä¸šæ–¹ï¼Œé€šè¿‡ AI æŠ€æœ¯å®ç°ç®€å†è§£æã€æ™ºèƒ½åŒ¹é…ã€è‡ªåŠ¨ç­›é€‰ã€é¢è¯•è¾…åŠ©ç­‰å…¨æµç¨‹æ™ºèƒ½æ‹›è˜æœåŠ¡ã€‚' },
        { q: 'å¹³å°æ”¯æŒå“ªäº›è§’è‰²ï¼Ÿ', a: 'æ”¯æŒã€Œæ±‚èŒè€…ã€å’Œã€Œä¼ä¸šæ–¹ã€ä¸¤ç§è§’è‰²ã€‚æ³¨å†Œåé¦–æ¬¡ç™»å½•éœ€é€‰æ‹©è§’è‰²ï¼Œä¹‹åå¯åœ¨å³ä¸Šè§’å¤´åƒèœå•éšæ—¶åˆ‡æ¢ï¼Œä¸¤ç§èº«ä»½æ•°æ®ç‹¬ç«‹ã€‚' },
        { q: 'å·¥ä½œå°æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ', a: 'å·¥ä½œå°æ˜¯ç»Ÿä¸€ç®¡ç†æ‹›è˜/æ±‚èŒæµç¨‹çš„æ ¸å¿ƒé¡µé¢ï¼Œå±•ç¤ºæ‰€æœ‰æ‹›è˜é˜Ÿåˆ—ï¼ˆFlowï¼‰ã€‚æ¯ä¸ªé˜Ÿåˆ—ä»£è¡¨ä¸€ä¸ªå€™é€‰äººä¸å²—ä½çš„åŒ¹é…æµç¨‹ï¼ŒåŒ…å«çŠ¶æ€æµè½¬ï¼šAI ç­›é€‰ â†’ ç®€å†é€šè¿‡ â†’ æ„å‘ç¡®è®¤ â†’ è”ç³»æ–¹å¼äº¤æ¢ â†’ é¢è¯•å®‰æ’ â†’ å…¥èŒ/æ·˜æ±°ã€‚' },
        { q: 'è®°å¿†ç³»ç»Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ', a: 'è®°å¿†ç³»ç»Ÿè®© AI æ›´äº†è§£ä½ ã€‚æ±‚èŒè€…å¯ä»¥è®°å½•æ±‚èŒåå¥½ã€æŠ€èƒ½ç‰¹é•¿ã€èŒä¸šç›®æ ‡ï¼›ä¼ä¸šæ–¹å¯ä»¥è®°å½•ä¼ä¸šæ–‡åŒ–ã€æ‹›è˜åå¥½ã€‚è®°å¿†ä¼šåœ¨ AI å¯¹è¯å’Œæ™ºèƒ½åŒ¹é…ä¸­è¢«è‡ªåŠ¨å¼•ç”¨ï¼Œæå‡åŒ¹é…ç²¾å‡†åº¦ã€‚' },
      ]
    },
    {
      title: 'æ±‚èŒè€…æŒ‡å—', icon: <UserIcon size={16} className="text-emerald-500" />,
      items: [
        { q: 'å¦‚ä½•æŠ•é€’å²—ä½ï¼Ÿ', a: 'è¿›å…¥ã€Œå²—ä½æ¨èã€é¡µé¢ï¼Œç‚¹å‡»å²—ä½å¡ç‰‡ä¸Šçš„ã€ŒAI æŠ•é€’ã€æŒ‰é’®ã€‚AI ä¼šåˆ†æä½ çš„ç®€å†ä¸å²—ä½åŒ¹é…åº¦ï¼Œè‡ªåŠ¨æŠ•é€’å¹¶å±•ç¤ºåŒ¹é…åˆ†æ•°å’Œåˆ†æç†ç”±ã€‚å·²æŠ•é€’çš„å²—ä½ä¼šå§‹ç»ˆæ ‡è®°ä¸ºã€Œå·²æŠ•é€’ã€ã€‚' },
        { q: 'å¦‚ä½•æŸ¥çœ‹æŠ•é€’çŠ¶æ€ï¼Ÿ', a: 'åœ¨å·¥ä½œå°ï¼ˆ/workbenchï¼‰å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ‹›è˜é˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—æ˜¾ç¤ºå½“å‰çŠ¶æ€å’Œè¯¦ç»†æµç¨‹ã€‚ä¹Ÿå¯ä»¥åœ¨å²—ä½æ¨èé¡µï¼Œhoverã€Œå·²æŠ•é€’ã€æ ‡ç­¾æŸ¥çœ‹æŠ•é€’è¯¦æƒ…ã€‚' },
        { q: 'å¦‚ä½•ç¼–è¾‘ä¸ªäººèµ„æ–™ï¼Ÿ', a: 'è¿›å…¥ã€Œä¸ªäººæ¡£æ¡ˆã€é¡µé¢ç¼–è¾‘èµ„æ–™ï¼Œæˆ–é€šè¿‡ AI åŠ©æ‰‹ç”¨å¯¹è¯æ–¹å¼å®Œå–„ä¸ªäººä¿¡æ¯ã€‚å®Œå–„èµ„æ–™æœ‰åŠ©äºæé«˜å²—ä½åŒ¹é…ç²¾å‡†åº¦ã€‚' },
        { q: 'AI æŠ•é€’å¤±è´¥æ€ä¹ˆåŠï¼Ÿ', a: 'æ£€æŸ¥ Token ä½™é¢æ˜¯å¦å……è¶³ï¼ˆæŠ•é€’çº¦æ¶ˆè€— 1000-3000 Tokenï¼‰ã€‚å¦‚æœæç¤ºã€Œå·²æŠ•é€’ã€è¯´æ˜ä¹‹å‰å·²æ“ä½œè¿‡ï¼Œæ— éœ€é‡å¤ã€‚å¦‚ä»æœ‰é—®é¢˜ï¼Œè¯·é€šè¿‡ã€Œåé¦ˆå»ºè®®ã€æäº¤å·¥å•ã€‚' },
      ]
    },
    {
      title: 'ä¼ä¸šæ–¹æŒ‡å—', icon: <Building2 size={16} className="text-blue-500" />,
      items: [
        { q: 'å¦‚ä½•å‘å¸ƒèŒä½ï¼Ÿ', a: 'è¿›å…¥ã€ŒèŒä½ç®¡ç†ã€é¡µé¢ï¼Œç‚¹å‡»æ·»åŠ æ–°èŒä½ã€‚å¡«å†™èŒä½æ ‡é¢˜ã€è–ªèµ„ã€å·¥ä½œåœ°ç‚¹ã€èŒä½æè¿°ç­‰ä¿¡æ¯åå‘å¸ƒã€‚ä¹Ÿå¯ä»¥é€šè¿‡ AI åŠ©æ‰‹å¯¹è¯å¼åˆ›å»ºèŒä½ã€‚' },
        { q: 'å¦‚ä½•é‚€è¯·å€™é€‰äººï¼Ÿ', a: 'åœ¨ã€Œäººæ‰æ± ã€é¡µé¢æµè§ˆå€™é€‰äººï¼Œç‚¹å‡»ã€ŒAI é‚€è¯·ã€æŒ‰é’®ã€‚AI ä¼šåˆ†æå€™é€‰äººç®€å†ä¸æ‚¨çš„å²—ä½åŒ¹é…åº¦ï¼Œè‡ªåŠ¨é‚€è¯·åˆ°æœ€åˆé€‚çš„å²—ä½ï¼Œå¹¶å±•ç¤ºåŒ¹é…åˆ†æ•°å’Œåˆ†æç†ç”±ã€‚' },
        { q: 'å¦‚ä½•ç®¡ç†æ‹›è˜æµç¨‹ï¼Ÿ', a: 'åœ¨å·¥ä½œå°æŸ¥çœ‹æ‰€æœ‰æ‹›è˜é˜Ÿåˆ—ã€‚å¯ä»¥æŒ‰çŠ¶æ€ç­›é€‰ï¼ˆå¾…ç­›é€‰/é¢è¯•ä¸­/å·²å½•ç”¨ç­‰ï¼‰ã€‚åœ¨èŒä½è¯¦æƒ…é¡µå¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”³è¯·è€…ï¼Œæ¨è¿›æµç¨‹æˆ–å‘é€åé¦ˆã€‚' },
        { q: 'ä¼ä¸šè®¤è¯æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ', a: 'é€šè¿‡ä¼ä¸šè®¤è¯åè·å¾—ã€Œå·²è®¤è¯ã€æ ‡è¯†ï¼Œæé«˜æ‹›è˜ä¿¡æ¯å¯ä¿¡åº¦ï¼Œå¢åŠ å€™é€‰äººæŠ•é€’æ„æ„¿ã€‚åœ¨è®¾ç½®é¡µé¢æäº¤è¥ä¸šæ‰§ç…§ã€æ³•äººèº«ä»½è¯ç­‰ææ–™å³å¯ç”³è¯·ã€‚' },
      ]
    },
    {
      title: 'Token ä¸è®¡è´¹', icon: <Coins size={16} className="text-amber-500" />,
      items: [
        { q: 'Token æ˜¯ä»€ä¹ˆï¼Ÿ', a: 'Token æ˜¯å¹³å°çš„ AI æœåŠ¡æ¶ˆè€—å•ä½ã€‚ä½¿ç”¨ AI åŠŸèƒ½ï¼ˆå¯¹è¯ã€ç®€å†è§£æã€æ™ºèƒ½åŒ¹é…ã€æŠ•é€’ã€é‚€è¯·ç­‰ï¼‰éƒ½ä¼šæ¶ˆè€— Tokenã€‚ä½™é¢ä¸è¶³æ—¶æ— æ³•ä½¿ç”¨ AI åŠŸèƒ½ã€‚' },
        { q: 'å¦‚ä½•è·å– Tokenï¼Ÿ', a: 'ä¸‰ç§æ–¹å¼ï¼šâ‘  æ³¨å†Œèµ é€å…è´¹ Tokenï¼›â‘¡ é‚€è¯·å¥½å‹æ³¨å†Œï¼ŒåŒæ–¹å„è·å¥–åŠ±ï¼ˆ/invite é¡µé¢ï¼‰ï¼›â‘¢ åœ¨ Token ç®¡ç†é¡µé¢ï¼ˆ/tokensï¼‰ä»˜è´¹å……å€¼ã€‚' },
        { q: 'å„åŠŸèƒ½æ¶ˆè€—å¤šå°‘ Tokenï¼Ÿ', a: 'AI å¯¹è¯ï¼šçº¦ 500-2000ï¼›ç®€å†è§£æï¼šçº¦ 4000ï¼›æ™ºèƒ½æŠ•é€’/é‚€è¯·ï¼šçº¦ 1000-3000ï¼›å¸‚åœºåˆ†æï¼šçº¦ 6000ã€‚æ‰€æœ‰æ¶ˆè€—è®°å½•å¯åœ¨ Token ç®¡ç†é¡µé¢æŸ¥çœ‹æ˜ç»†ã€‚' },
        { q: 'Token ä¼šè¿‡æœŸå—ï¼Ÿ', a: 'æœ‰æ•ˆæœŸå†…æœªä½¿ç”¨çš„ Token ä¸ä¼šè¿‡æœŸï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚å…·ä½“æœ‰æ•ˆæœŸä»¥å……å€¼å¥—é¤è¯´æ˜ä¸ºå‡†ã€‚' },
      ]
    },
    {
      title: 'è´¦å·ä¸è®¾ç½®', icon: <Settings size={16} className="text-slate-500" />,
      items: [
        { q: 'å¦‚ä½•ä¿®æ”¹å¯†ç ï¼Ÿ', a: 'è¿›å…¥ç³»ç»Ÿè®¾ç½® â†’ è´¦å·ä¿¡æ¯ï¼Œç‚¹å‡»ä¿®æ”¹å¯†ç ï¼Œè¾“å…¥æ—§å¯†ç å’Œæ–°å¯†ç å³å¯ã€‚' },
        { q: 'å¦‚ä½•åˆ‡æ¢æ±‚èŒè€…/ä¼ä¸šæ–¹ï¼Ÿ', a: 'ç‚¹å‡»å³ä¸Šè§’å¤´åƒï¼Œåœ¨å¼¹å‡ºèœå•ä¸­ç‚¹å‡»ã€Œåˆ‡æ¢ä¸ºæ±‚èŒè€…ã€æˆ–ã€Œåˆ‡æ¢ä¸ºä¼ä¸šæ–¹ã€ï¼Œå³å¯ç¬é—´åˆ‡æ¢èº«ä»½ã€‚' },
        { q: 'æ¶ˆæ¯é€šçŸ¥æ€ä¹ˆç®¡ç†ï¼Ÿ', a: 'åœ¨æ¶ˆæ¯ä¸­å¿ƒï¼ˆ/notificationsï¼‰æŸ¥çœ‹æ‰€æœ‰é€šçŸ¥ï¼Œæ”¯æŒæŒ‰ç±»å‹ç­›é€‰ï¼ˆç³»ç»Ÿ/åŒ¹é…/é¢è¯•/æ¶ˆæ¯ï¼‰ï¼Œå¯æ ‡è®°å·²è¯»æˆ–åˆ é™¤ã€‚é‡è¦é€šçŸ¥ä¼šç‰¹æ®Šæ ‡è®°ç¡®ä¿ä¸é—æ¼ã€‚' },
        { q: 'å¦‚ä½•æäº¤åé¦ˆï¼Ÿ', a: 'ç‚¹å‡»é¡µé¢åº•éƒ¨ã€Œåé¦ˆå»ºè®®ã€æˆ–å³ä¸Šè§’èœå•ä¸­çš„ã€Œåé¦ˆå·¥å•ã€ï¼Œé€‰æ‹©ç±»å‹ï¼ˆå’¨è¯¢/å»ºè®®/ç¼ºé™·/æŠ•è¯‰ï¼‰ï¼Œå¡«å†™æ ‡é¢˜å’Œæè¿°å³å¯æäº¤ã€‚' },
      ]
    },
  ];

  // FAQ å±•å¼€çŠ¶æ€
  const [expandedCat, setExpandedCat] = useState<number>(0);
  const [expandedQ, setExpandedQ] = useState<string | null>(null);

  // AI é—®ç­”çŠ¶æ€
  const [chatMessages, setChatMessages] = useState<{role: string; content: string}[]>([]);
  const [chatInput, setChatInput] = useState('');
  const [chatLoading, setChatLoading] = useState(false);
  const chatEndRef = useRef<HTMLDivElement>(null);
  const chatScrollRef = useRef<HTMLDivElement>(null);

  // èŠå¤©æ¶ˆæ¯å˜åŒ–æ—¶ï¼Œåœ¨èŠå¤©å®¹å™¨å†…éƒ¨æ»šåˆ°åº•éƒ¨ï¼ˆä¸å½±å“é¡µé¢æ»šåŠ¨ï¼‰
  useEffect(() => {
    if (chatMessages.length > 0 && chatScrollRef.current) {
      chatScrollRef.current.scrollTop = chatScrollRef.current.scrollHeight;
    }
  }, [chatMessages, chatLoading]);

  const quickQuestions = [
    'å¦‚ä½•å‘å¸ƒèŒä½ï¼Ÿ',
    'Token æ€ä¹ˆå……å€¼ï¼Ÿ',
    'AI æŠ•é€’æ˜¯æ€ä¹ˆè¿ä½œçš„ï¼Ÿ',
    'æ€ä¹ˆåˆ‡æ¢èº«ä»½ï¼Ÿ',
  ];

  const handleAsk = async (question: string) => {
    if (!question.trim() || chatLoading) return;
    const q = question.trim();
    setChatInput('');
    setChatMessages(prev => [...prev, { role: 'user', content: q }]);
    setChatLoading(true);
    try {
      const historyToSend = chatMessages.slice(-6).map(m => ({ role: m.role, content: m.content }));
      const res = await fetch('/api/v1/public/helpdesk/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId, question: q, history: historyToSend }),
      });
      const data = await res.json();
      if (data.error === 'insufficient_tokens') {
        setChatMessages(prev => [...prev, { role: 'assistant', content: 'Token ä½™é¢ä¸è¶³ï¼Œæ— æ³•ä½¿ç”¨ AI é—®ç­”ã€‚è¯·å‰å¾€ [Token ç®¡ç†](/tokens) é¡µé¢å……å€¼ã€‚' }]);
      } else if (data.response) {
        setChatMessages(prev => [...prev, { role: 'assistant', content: data.response }]);
      } else {
        setChatMessages(prev => [...prev, { role: 'assistant', content: data.error || 'AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚' }]);
      }
    } catch (err) {
      console.error('[helpdesk] error:', err);
      setChatMessages(prev => [...prev, { role: 'assistant', content: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚' }]);
    }
    setChatLoading(false);
  };

  return (
    <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 max-w-7xl mx-auto animate-in fade-in duration-500">
      {/* Header */}
      <div className="flex items-center gap-4 mb-8">
        <button onClick={() => navigate(-1)} className="p-2 rounded-lg bg-white border border-slate-200 hover:bg-slate-50 transition-all">
          <ChevronLeft size={20} className="text-slate-600" />
        </button>
        <div>
          <h1 className="text-2xl font-black text-slate-900 flex items-center gap-2">
            <BookOpen size={24} className="text-indigo-600" /> å¸®åŠ©ä¸­å¿ƒ
          </h1>
          <p className="text-slate-500 text-sm">æŸ¥çœ‹å¸¸è§é—®é¢˜æˆ–å‘ AI æé—®ï¼Œå¿«é€Ÿè·å–å¸®åŠ©</p>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
        {/* å·¦ä¾§ï¼šå¸¸è§é—®é¢˜é€ŸæŸ¥ */}
        <div className="lg:col-span-5">
          <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
            <div className="p-5 border-b border-slate-100">
              <h2 className="font-black text-slate-900 flex items-center gap-2">
                <MessageCircleQuestion size={18} className="text-indigo-500" /> å¸¸è§é—®é¢˜
              </h2>
            </div>
            <div className="divide-y divide-slate-100">
              {faqCategories.map((cat, ci) => (
                <div key={ci}>
                  <button
                    onClick={() => setExpandedCat(expandedCat === ci ? -1 : ci)}
                    className={`w-full flex items-center justify-between px-5 py-3.5 text-sm font-bold transition-all hover:bg-slate-50 ${expandedCat === ci ? 'bg-slate-50 text-indigo-700' : 'text-slate-700'}`}
                  >
                    <span className="flex items-center gap-2.5">{cat.icon} {cat.title}</span>
                    <ChevronDown size={14} className={`text-slate-400 transition-transform ${expandedCat === ci ? 'rotate-180' : ''}`} />
                  </button>
                  {expandedCat === ci && (
                    <div className="bg-slate-50/50 animate-in fade-in duration-200">
                      {cat.items.map((item, qi) => {
                        const qKey = `${ci}-${qi}`;
                        return (
                          <div key={qi} className="border-t border-slate-100/80">
                            <button
                              onClick={() => setExpandedQ(expandedQ === qKey ? null : qKey)}
                              className={`w-full text-left px-6 py-3 text-sm transition-all hover:bg-white flex items-start gap-2 ${expandedQ === qKey ? 'text-indigo-700 font-bold' : 'text-slate-600'}`}
                            >
                              <ChevronRight size={13} className={`mt-0.5 flex-shrink-0 transition-transform ${expandedQ === qKey ? 'rotate-90 text-indigo-500' : 'text-slate-400'}`} />
                              {item.q}
                            </button>
                            {expandedQ === qKey && (
                              <div className="px-6 pb-4 pl-11 animate-in fade-in duration-150">
                                <p className="text-sm text-slate-600 leading-relaxed bg-white rounded-lg p-3 border border-slate-100">{item.a}</p>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* å³ä¾§ï¼šAI æ™ºèƒ½é—®ç­” */}
        <div className="lg:col-span-7 sticky top-28">
          <div className="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col" style={{ height: 'calc(100dvh - 160px)' }}>
            {/* æ ‡é¢˜æ  */}
            <div className="p-5 border-b border-slate-100 flex items-center justify-between flex-shrink-0">
              <h2 className="font-black text-slate-900 flex items-center gap-2">
                <Sparkles size={18} className="text-indigo-500" /> AI æ™ºèƒ½é—®ç­”
              </h2>
              <span className="text-[10px] text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">åŸºäºå…¨ç«™æ–‡æ¡£ Â· æ¶ˆè€— Token</span>
            </div>

            {/* èŠå¤©åŒºåŸŸ */}
            <div ref={chatScrollRef} className="flex-1 overflow-y-auto p-5 space-y-4 min-h-0">
              {chatMessages.length === 0 && !chatLoading && (
                <div className="flex flex-col items-center justify-center h-full text-center">
                  <div className="w-16 h-16 rounded-2xl bg-indigo-50 flex items-center justify-center mb-4">
                    <Bot size={32} className="text-indigo-400" />
                  </div>
                  <p className="text-slate-500 font-bold text-sm mb-1">æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ ï¼Ÿ</p>
                  <p className="text-slate-400 text-xs mb-6">æˆ‘ç†Ÿæ‚‰ Devnors å¹³å°çš„æ‰€æœ‰åŠŸèƒ½ï¼Œéšæ—¶ä¸ºä½ è§£ç­”</p>
                  {!isLoggedIn && (
                    <p className="text-xs text-amber-600 bg-amber-50 px-3 py-1.5 rounded-lg mb-4">ç™»å½•åå³å¯ä½¿ç”¨ AI é—®ç­”åŠŸèƒ½</p>
                  )}
                  <div className="flex flex-wrap justify-center gap-2">
                    {quickQuestions.map((qq, i) => (
                      <button
                        key={i}
                        onClick={() => isLoggedIn && handleAsk(qq)}
                        disabled={!isLoggedIn}
                        className="text-xs px-3 py-1.5 rounded-full border border-indigo-200 text-indigo-600 hover:bg-indigo-50 transition-all disabled:opacity-40 disabled:cursor-not-allowed"
                      >
                        {qq}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {chatMessages.map((msg, i) => (
                <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[85%] rounded-xl px-4 py-3 text-sm leading-relaxed ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-br-sm' : 'bg-slate-100 text-slate-700 rounded-bl-sm'}`}>
                    {msg.role === 'assistant' ? (
                      <div className="prose prose-sm prose-slate max-w-none [&_p]:mb-1 [&_ul]:mb-1 [&_ol]:mb-1 [&_li]:mb-0.5 [&_a]:text-indigo-600">
                        <ReactMarkdown remarkPlugins={[remarkGfm]}>
                          {msg.content}
                        </ReactMarkdown>
                      </div>
                    ) : msg.content}
                  </div>
                </div>
              ))}

              {chatLoading && (
                <div className="flex justify-start">
                  <div className="bg-slate-100 rounded-xl px-4 py-3 rounded-bl-sm flex items-center gap-2 text-sm text-slate-500">
                    <Loader2 size={14} className="animate-spin" /> æ­£åœ¨æŸ¥æ‰¾ç­”æ¡ˆ...
                  </div>
                </div>
              )}
              <div ref={chatEndRef} />
            </div>

            {/* è¾“å…¥åŒºåŸŸ */}
            <div className="p-4 border-t border-slate-100 flex-shrink-0">
              {chatMessages.length > 0 && (
                <div className="flex flex-wrap gap-1.5 mb-3">
                  {quickQuestions.filter(qq => !chatMessages.some(m => m.role === 'user' && m.content === qq)).slice(0, 3).map((qq, i) => (
                    <button
                      key={i}
                      onClick={() => isLoggedIn && handleAsk(qq)}
                      disabled={!isLoggedIn || chatLoading}
                      className="text-[10px] px-2.5 py-1 rounded-full border border-slate-200 text-slate-500 hover:bg-slate-50 transition-all disabled:opacity-40"
                    >
                      {qq}
                    </button>
                  ))}
                </div>
              )}
              <div className="flex gap-2">
                <input
                  type="text"
                  value={chatInput}
                  onChange={e => setChatInput(e.target.value)}
                  onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); isLoggedIn && handleAsk(chatInput); } }}
                  placeholder={isLoggedIn ? "è¾“å…¥ä½ çš„é—®é¢˜..." : "è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨ AI é—®ç­”"}
                  disabled={!isLoggedIn || chatLoading}
                  className="flex-1 px-4 py-2.5 rounded-lg border border-slate-200 text-sm font-medium focus:border-indigo-300 focus:ring-2 focus:ring-indigo-100 outline-none transition-all disabled:bg-slate-50 disabled:text-slate-400"
                />
                <button
                  onClick={() => handleAsk(chatInput)}
                  disabled={!isLoggedIn || chatLoading || !chatInput.trim()}
                  className="px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold text-sm flex items-center gap-1.5 transition-all disabled:opacity-50 active:scale-95"
                >
                  {chatLoading ? <Loader2 size={15} className="animate-spin" /> : <Send size={15} />}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// --- åé¦ˆå»ºè®®é¡µé¢ (FeedbackView) ---
const FeedbackView = () => {
  const navigate = useNavigate();
  const { user, isLoggedIn } = useAuth();
  const userId = user?.id || 0;

  // è¡¨å•çŠ¶æ€
  const [ticketType, setTicketType] = useState('question');
  const [priority, setPriority] = useState('normal');
  const [title, setTitle] = useState('');
  const [content, setContent] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const [submitResult, setSubmitResult] = useState<any>(null);

  // Tab åˆ‡æ¢
  const [activeTab, setActiveTab] = useState<'submit' | 'tickets'>('submit');

  // å·¥å•åˆ—è¡¨
  const [tickets, setTickets] = useState<any[]>([]);
  const [ticketsLoading, setTicketsLoading] = useState(true);
  const [filterStatus, setFilterStatus] = useState('');
  const [expandedId, setExpandedId] = useState<number | null>(null);

  // åŠ è½½å·¥å•åˆ—è¡¨
  const loadTickets = async () => {
    if (!userId) return;
    setTicketsLoading(true);
    try {
      const params = new URLSearchParams({ user_id: String(userId) });
      if (filterStatus) params.append('status', filterStatus);
      const res = await fetch(`/api/v1/public/tickets?${params}`);
      const data = await res.json();
      if (data.success) setTickets(data.tickets || []);
    } catch { /* ignore */ }
    setTicketsLoading(false);
  };

  useEffect(() => { loadTickets(); }, [userId, filterStatus]);

  // æäº¤å·¥å•
  const handleSubmit = async () => {
    if (!title.trim() || title.trim().length < 2) {
      setSubmitResult({ success: false, message: 'è¯·å¡«å†™æ ‡é¢˜ï¼ˆè‡³å°‘ 2 ä¸ªå­—ï¼‰' });
      return;
    }
    if (!content.trim() || content.trim().length < 5) {
      setSubmitResult({ success: false, message: 'è¯·å¡«å†™è¯¦ç»†æè¿°ï¼ˆè‡³å°‘ 5 ä¸ªå­—ï¼‰' });
      return;
    }
    setSubmitting(true);
    setSubmitResult(null);
    try {
      const res = await fetch('/api/v1/public/tickets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId, type: ticketType, priority, title: title.trim(), content: content.trim(), contact: user?.phone || undefined }),
      });
      const data = await res.json();
      if (data.success) {
        setSubmitResult({ success: true, message: data.message });
        setTitle(''); setContent(''); setTicketType('question'); setPriority('normal');
        loadTickets();
      } else {
        setSubmitResult({ success: false, message: data.error || 'æäº¤å¤±è´¥' });
      }
    } catch {
      setSubmitResult({ success: false, message: 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•' });
    }
    setSubmitting(false);
    setTimeout(() => setSubmitResult(null), 4000);
  };

  const typeOptions = [
    { value: 'question', label: 'å’¨è¯¢', icon: 'ğŸ’¬', desc: 'ä½¿ç”¨é—®é¢˜æˆ–åŠŸèƒ½ç–‘é—®' },
    { value: 'feature', label: 'å»ºè®®', icon: 'ğŸ’¡', desc: 'åŠŸèƒ½æ”¹è¿›æˆ–æ–°éœ€æ±‚' },
    { value: 'bug', label: 'ç¼ºé™·', icon: 'ğŸ›', desc: 'åŠŸèƒ½å¼‚å¸¸æˆ–é”™è¯¯' },
    { value: 'complaint', label: 'æŠ•è¯‰', icon: 'ğŸ“¢', desc: 'æœåŠ¡è´¨é‡åé¦ˆ' },
  ];

  const priorityOptions = [
    { value: 'low', label: 'ä½', color: 'text-slate-500 bg-slate-100' },
    { value: 'normal', label: 'æ™®é€š', color: 'text-indigo-600 bg-indigo-50' },
    { value: 'high', label: 'é«˜', color: 'text-amber-600 bg-amber-50' },
    { value: 'urgent', label: 'ç´§æ€¥', color: 'text-rose-600 bg-rose-50' },
  ];

  const statusLabels: Record<string, { label: string; color: string }> = {
    open: { label: 'å¾…å¤„ç†', color: 'bg-blue-100 text-blue-700' },
    processing: { label: 'å¤„ç†ä¸­', color: 'bg-amber-100 text-amber-700' },
    resolved: { label: 'å·²è§£å†³', color: 'bg-emerald-100 text-emerald-700' },
    closed: { label: 'å·²å…³é—­', color: 'bg-slate-100 text-slate-500' },
  };

  const typeLabels: Record<string, { label: string; icon: string }> = {
    question: { label: 'å’¨è¯¢', icon: 'ğŸ’¬' },
    feature: { label: 'å»ºè®®', icon: 'ğŸ’¡' },
    bug: { label: 'ç¼ºé™·', icon: 'ğŸ›' },
    complaint: { label: 'æŠ•è¯‰', icon: 'ğŸ“¢' },
  };

  if (!isLoggedIn) {
    return (
      <div className="pt-20 text-center">
        <MessageSquare className="mx-auto text-slate-300 mb-4" size={64} />
        <p className="text-slate-500 font-bold mb-4">è¯·å…ˆç™»å½•æäº¤åé¦ˆ</p>
        <button onClick={() => navigate('/login')} className="bg-indigo-600 text-white px-8 py-3 rounded font-black">å»ç™»å½•</button>
      </div>
    );
  }

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto animate-in fade-in duration-500">
      {/* Header */}
      <div className="mb-6">
        <h1 className="text-2xl font-black text-slate-900">åé¦ˆå»ºè®®</h1>
        <p className="text-slate-500 text-sm">æäº¤å·¥å•ï¼Œæˆ‘ä»¬ä¼šè®¤çœŸå¯¹å¾…æ¯ä¸€æ¡åé¦ˆ</p>
      </div>

      {/* Tab å¯¼èˆª */}
      <div className="flex gap-2 mb-8 bg-white rounded-xl p-1.5 border border-slate-100 shadow-sm">
        <button
          onClick={() => setActiveTab('submit')}
          className={`flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg font-bold text-sm transition-all ${
            activeTab === 'submit' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-50 hover:text-indigo-600'
          }`}
        >
          <Edit3 size={15} /> åé¦ˆæ„è§
        </button>
        <button
          onClick={() => setActiveTab('tickets')}
          className={`flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg font-bold text-sm transition-all ${
            activeTab === 'tickets' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-50 hover:text-indigo-600'
          }`}
        >
          <Inbox size={15} /> æˆ‘çš„å·¥å• {tickets.length > 0 && <span className={`text-[10px] px-1.5 py-0.5 rounded-full ${activeTab === 'tickets' ? 'bg-white/20' : 'bg-slate-100'}`}>{tickets.length}</span>}
        </button>
      </div>

      {/* æäº¤è¡¨å• */}
      {activeTab === 'submit' && (
        <div>
          <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">

            {/* ç±»å‹é€‰æ‹© */}
            <div className="mb-5">
              <label className="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">åé¦ˆç±»å‹</label>
              <div className="grid grid-cols-2 gap-2">
                {typeOptions.map(opt => (
                  <button
                    key={opt.value}
                    onClick={() => setTicketType(opt.value)}
                    className={`p-3 rounded-lg border text-left transition-all ${ticketType === opt.value ? 'border-indigo-300 bg-indigo-50 ring-1 ring-indigo-200' : 'border-slate-200 hover:border-slate-300'}`}
                  >
                    <span className="text-lg">{opt.icon}</span>
                    <span className={`ml-2 text-sm font-bold ${ticketType === opt.value ? 'text-indigo-700' : 'text-slate-700'}`}>{opt.label}</span>
                    <p className="text-[10px] text-slate-400 mt-0.5">{opt.desc}</p>
                  </button>
                ))}
              </div>
            </div>

            {/* ä¼˜å…ˆçº§ */}
            <div className="mb-5">
              <label className="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">ä¼˜å…ˆçº§</label>
              <div className="flex gap-2">
                {priorityOptions.map(opt => (
                  <button
                    key={opt.value}
                    onClick={() => setPriority(opt.value)}
                    className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${priority === opt.value ? opt.color + ' ring-1 ring-current' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}`}
                  >
                    {opt.label}
                  </button>
                ))}
              </div>
            </div>

            {/* æ ‡é¢˜ */}
            <div className="mb-4">
              <label className="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">æ ‡é¢˜</label>
              <input
                type="text"
                value={title}
                onChange={e => setTitle(e.target.value)}
                placeholder="ç®€è¦æè¿°æ‚¨çš„é—®é¢˜æˆ–å»ºè®®"
                maxLength={200}
                className="w-full px-4 py-2.5 rounded-lg border border-slate-200 text-sm font-medium focus:border-indigo-300 focus:ring-2 focus:ring-indigo-100 outline-none transition-all"
              />
            </div>

            {/* æè¿° */}
            <div className="mb-4">
              <label className="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">è¯¦ç»†æè¿°</label>
              <textarea
                value={content}
                onChange={e => setContent(e.target.value)}
                placeholder="è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜ã€æœŸæœ›çš„æ”¹è¿›ã€æˆ–å…·ä½“çš„ä½¿ç”¨åœºæ™¯..."
                rows={5}
                maxLength={5000}
                className="w-full px-4 py-2.5 rounded-lg border border-slate-200 text-sm font-medium focus:border-indigo-300 focus:ring-2 focus:ring-indigo-100 outline-none transition-all resize-none"
              />
              <p className="text-right text-[10px] text-slate-300 mt-1">{content.length}/5000</p>
            </div>

            {/* æäº¤ */}
            <button
              onClick={handleSubmit}
              disabled={submitting}
              className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-lg shadow-indigo-100 disabled:opacity-60 active:scale-[0.98]"
            >
              {submitting ? <Loader2 size={16} className="animate-spin" /> : <Send size={16} />}
              {submitting ? 'æäº¤ä¸­...' : 'æäº¤å·¥å•'}
            </button>

            {/* æäº¤ç»“æœ toast */}
            {submitResult && (
              <div className={`mt-4 p-3 rounded-lg text-sm font-bold flex items-center gap-2 ${submitResult.success ? 'bg-emerald-50 text-emerald-700 border border-emerald-200' : 'bg-rose-50 text-rose-700 border border-rose-200'}`}>
                {submitResult.success ? <CheckCircle2 size={15} /> : <AlertCircle size={15} />}
                {submitResult.message}
              </div>
            )}
          </div>
        </div>
      )}

      {/* å·¥å•åˆ—è¡¨ */}
      {activeTab === 'tickets' && (
        <div>
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-black text-slate-900 flex items-center gap-2">
              <Inbox size={18} className="text-slate-400" /> æˆ‘çš„å·¥å•
              {tickets.length > 0 && <span className="text-xs text-slate-400 font-bold bg-slate-100 px-2 py-0.5 rounded-full">{tickets.length}</span>}
            </h2>
            <div className="flex gap-1.5">
              {[{ v: '', l: 'å…¨éƒ¨' }, { v: 'open', l: 'å¾…å¤„ç†' }, { v: 'processing', l: 'å¤„ç†ä¸­' }, { v: 'resolved', l: 'å·²è§£å†³' }].map(f => (
                <button
                  key={f.v}
                  onClick={() => setFilterStatus(f.v)}
                  className={`px-3 py-1 rounded-lg text-xs font-bold transition-all ${filterStatus === f.v ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                >
                  {f.l}
                </button>
              ))}
            </div>
          </div>

          {ticketsLoading ? (
            <div className="flex justify-center py-16"><Loader2 className="animate-spin text-indigo-600" size={28} /></div>
          ) : tickets.length === 0 ? (
            <div className="bg-white rounded-xl border border-slate-200 p-16 text-center">
              <Inbox size={48} className="mx-auto text-slate-200 mb-3" />
              <p className="text-slate-400 font-bold text-sm">æš‚æ— å·¥å•è®°å½•</p>
              <p className="text-slate-300 text-xs mt-1">æäº¤æ‚¨çš„ç¬¬ä¸€æ¡åé¦ˆå§</p>
            </div>
          ) : (
            <div className="space-y-3">
              {tickets.map(t => {
                const st = statusLabels[t.status] || statusLabels.open;
                const tp = typeLabels[t.type] || typeLabels.question;
                const isExpanded = expandedId === t.id;
                return (
                  <div
                    key={t.id}
                    onClick={() => setExpandedId(isExpanded ? null : t.id)}
                    className={`bg-white rounded-xl border p-5 cursor-pointer transition-all hover:shadow-md ${isExpanded ? 'border-indigo-200 shadow-md' : 'border-slate-100'}`}
                  >
                    <div className="flex items-start justify-between gap-3">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 flex-wrap mb-1">
                          <span className="text-sm">{tp.icon}</span>
                          <h3 className="font-bold text-slate-900 text-sm truncate">{t.title}</h3>
                          <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${st.color}`}>{st.label}</span>
                        </div>
                        <p className="text-xs text-slate-400">#{t.id} Â· {t.created_at ? parseUTC(t.created_at).toLocaleDateString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : ''}</p>
                      </div>
                      <ChevronDown size={16} className={`text-slate-300 transition-transform flex-shrink-0 ${isExpanded ? 'rotate-180' : ''}`} />
                    </div>

                    {isExpanded && (
                      <div className="mt-4 pt-4 border-t border-slate-100 space-y-3 animate-in fade-in duration-200">
                        <div>
                          <p className="text-xs font-bold text-slate-500 mb-1">æè¿°</p>
                          <p className="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">{t.content}</p>
                        </div>
                        {t.contact && (
                          <div>
                            <p className="text-xs font-bold text-slate-500 mb-1">è”ç³»æ–¹å¼</p>
                            <p className="text-sm text-slate-600">{t.contact}</p>
                          </div>
                        )}
                        {t.reply ? (
                          <div className="bg-emerald-50 rounded-lg p-4 border border-emerald-100">
                            <p className="text-xs font-bold text-emerald-700 mb-1 flex items-center gap-1"><MessageSquare size={12} /> å®˜æ–¹å›å¤</p>
                            <p className="text-sm text-emerald-800 whitespace-pre-wrap">{t.reply}</p>
                            {t.replied_at && <p className="text-[10px] text-emerald-500 mt-2">{parseUTC(t.replied_at).toLocaleString('zh-CN')}</p>}
                          </div>
                        ) : (
                          <div className="bg-slate-50 rounded-lg p-3 border border-slate-100">
                            <p className="text-xs text-slate-400 flex items-center gap-1"><Clock size={11} /> ç­‰å¾…å¤„ç†ä¸­ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å›å¤</p>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// --- Token ä½™é¢ä¸è¶³å…¨å±€æç¤º ---
const TokenInsufficientModal = ({ show, balance, onClose }: { show: boolean; balance: number; onClose: () => void }) => {
  const navigate = useNavigate();
  const { user } = useAuth();
  if (!show) return null;
  return (
    <div className="fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4 animate-in fade-in duration-200">
      <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-8 relative animate-in zoom-in-95 duration-300">
        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X size={20} /></button>
        <div className="text-center mb-6">
          <div className="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <Gem size={28} className="text-amber-500" />
          </div>
          <h3 className="text-xl font-bold text-slate-900 mb-2">Token ä½™é¢ä¸è¶³</h3>
          <p className="text-sm text-slate-500">å½“å‰ä½™é¢ <span className="font-bold text-amber-600">{(balance || 0).toLocaleString()}</span> Tokensï¼Œä¸è¶³ä»¥å®Œæˆæœ¬æ¬¡æ“ä½œ</p>
        </div>
        <div className="space-y-3">
          <button onClick={() => { onClose(); navigate('/tokens'); }} className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition-all flex items-center justify-center gap-2">
            <CreditCard size={18} /> ç«‹å³å……å€¼
          </button>
          <button onClick={() => { onClose(); navigate('/pricing'); }} className="w-full py-3 bg-white border-2 border-indigo-200 hover:border-indigo-400 text-indigo-600 font-bold rounded-xl transition-all flex items-center justify-center gap-2">
            <Sparkles size={18} /> å‡çº§ä¼šå‘˜è·å–æ›´å¤šé¢åº¦
          </button>
          {user?.invite_code && (
            <div className="mt-4 p-3 bg-emerald-50 rounded-xl border border-emerald-100">
              <p className="text-xs text-emerald-700 font-medium mb-1">é‚€è¯·å¥½å‹ï¼ŒåŒæ–¹å„å¾— Token å¥–åŠ±</p>
              <div className="flex items-center gap-2">
                <code className="flex-1 text-sm font-mono bg-white px-3 py-1.5 rounded-lg border border-emerald-200 text-emerald-800 select-all">{user.invite_code}</code>
                <button onClick={() => { navigator.clipboard.writeText(user.invite_code || ''); }} className="px-3 py-1.5 bg-emerald-500 text-white text-xs font-bold rounded-lg hover:bg-emerald-600 transition-all">
                  å¤åˆ¶
                </button>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// å…¨å±€ token ä¸è¶³äº‹ä»¶
const tokenInsufficientEvent = {
  _listeners: [] as Array<(balance: number) => void>,
  emit(balance: number) { this._listeners.forEach(fn => fn(balance)); },
  on(fn: (balance: number) => void) { this._listeners.push(fn); return () => { this._listeners = this._listeners.filter(l => l !== fn); }; }
};

// å¯¼å‡ºä¾› API å±‚è°ƒç”¨
(window as any).__showTokenInsufficient = (balance: number) => tokenInsufficientEvent.emit(balance);

/**
 * DashboardLayout â€” å·¦å³ç»“æ„å¸ƒå±€ï¼šå·¦ä¾§å¯¼èˆª + å³ä¾§å†…å®¹åŒº
 * ç”¨äº workbench / employer / candidate é¡µé¢
 */
const DashboardLayout = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const { userRole } = useAuth();
  const [sidebarOpen, setSidebarOpen] = useState(false);
  
  const currentPath = location.pathname;
  
  // é€šç”¨å¯¼èˆªé¡¹
  const commonNavItems = [
    { path: '/ai-assistant', label: 'AI Agent', icon: Bot },
    { path: '/workbench', label: 'æ§åˆ¶é¢æ¿', icon: LayoutDashboard },
  ];
  
  // æ ¹æ®è§’è‰²çš„ä¸“å±å¯¼èˆª
  const roleNavItems = userRole === 'employer' ? [
    { path: '/workbench', label: 'æ§åˆ¶é¢æ¿', icon: LayoutDashboard },
    { path: '/employer', label: 'ä¼ä¸šä¸­å¿ƒ', icon: Building2 },
    { path: '/employer/post', label: 'èŒä½ç®¡ç†', icon: Briefcase },
    { path: '/employer/talent-pool', label: 'äººæ‰åº“', icon: Users },
    { path: '/employer/memory', label: 'ä¼ä¸šè®°å¿†', icon: Brain },
  ] : userRole === 'candidate' ? [
    { path: '/workbench', label: 'æ§åˆ¶é¢æ¿', icon: LayoutDashboard },
    { path: '/candidate', label: 'äººæ‰ä¸­å¿ƒ', icon: UserIcon },
    { path: '/candidate/jobs', label: 'èŒä½æ¨è', icon: Briefcase },
    { path: '/candidate/memory', label: 'ä¸ªäººè®°å¿†', icon: Brain },
  ] : [];
  
  // åº•éƒ¨å·¥å…·å¯¼èˆª
  const toolNavItems = [
    { path: '/tokens', label: 'Token ç®¡ç†', icon: Coins },
    { path: '/invite', label: 'é‚€è¯·å¥½å‹', icon: Gift },
    { path: '/feedback', label: 'åé¦ˆæ„è§', icon: MessageSquare },
    { path: '/settings', label: 'è®¾ç½®', icon: Settings },
  ];

  // æµè§ˆå™¨å¯¼èˆªï¼ˆæ ¹æ®è§’è‰²æ˜¾ç¤ºï¼‰
  const browserNavItems = [
    ...(userRole === 'candidate' ? [{ path: '/candidate/profile', label: 'ä¸ªäººä¸»é¡µ', icon: UserIcon }] : []),
    ...(userRole === 'employer' ? [{ path: '/employer/home', label: 'ä¼ä¸šä¸»é¡µ', icon: Building2 }] : []),
  ];

  const isActive = (path: string) => {
    if (path === '/workbench') return currentPath === '/workbench' || currentPath.startsWith('/workbench/');
    if (path === '/employer') return currentPath === '/employer';
    if (path === '/candidate') return currentPath === '/candidate';
    return currentPath === path || currentPath.startsWith(path + '/');
  };

  const NavItem = ({ item }: { item: { path: string; label: string; icon: any } }) => {
    const IconComp = item.icon;
    const active = isActive(item.path);
    return (
      <button
        onClick={() => { navigate(item.path); setSidebarOpen(false); }}
        className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
          active 
            ? 'bg-indigo-50 text-indigo-700 font-semibold' 
            : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900'
        }`}
      >
        <IconComp size={18} className={active ? 'text-indigo-600' : 'text-slate-400'} />
        <span>{item.label}</span>
      </button>
    );
  };

  return (
    <div className="pt-[52px] md:pt-[60px] flex min-h-screen">
      {/* ç§»åŠ¨ç«¯é®ç½© */}
      {sidebarOpen && (
        <div 
          className="fixed inset-0 bg-black/30 z-40 md:hidden" 
          onClick={() => setSidebarOpen(false)} 
        />
      )}
      
      {/* å·¦ä¾§å¯¼èˆªæ  */}
      <aside className={`
        fixed md:sticky top-[52px] md:top-[60px] left-0 z-40 md:z-auto
        w-[240px] h-[calc(100vh-52px)] md:h-[calc(100vh-60px)]
        bg-white border-r border-slate-200/60
        flex flex-col flex-shrink-0
        transition-transform duration-300 ease-out
        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}
        overflow-y-auto scrollbar-hide
      `}>
        <div className="flex-1 p-3 space-y-1">
          {/* è§’è‰²å¯¼èˆª */}
          {roleNavItems.length > 0 && (
            <div className="mb-3">
              <p className="px-3 py-1.5 text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                {userRole === 'employer' ? 'ä¼ä¸šç®¡ç†' : 'ä¸ªäººç®¡ç†'}
              </p>
              {roleNavItems.map(item => <NavItem key={item.path} item={item} />)}
            </div>
          )}
          
          {/* å·¥å…· */}
          <div className="pt-3 border-t border-slate-100">
            <p className="px-3 py-1.5 text-[11px] font-bold text-slate-400 uppercase tracking-wider">å·¥å…·</p>
            {toolNavItems.map(item => <NavItem key={item.path} item={item} />)}
          </div>
          
          {/* æµè§ˆå™¨ */}
          {browserNavItems.length > 0 && (
            <div className="pt-3 border-t border-slate-100">
              <p className="px-3 py-1.5 text-[11px] font-bold text-slate-400 uppercase tracking-wider">æµè§ˆå™¨</p>
              {browserNavItems.map(item => <NavItem key={item.path} item={item} />)}
            </div>
          )}
        </div>
      </aside>
      
      {/* ç§»åŠ¨ç«¯èœå•æŒ‰é’® */}
      <button
        onClick={() => setSidebarOpen(true)}
        className="fixed bottom-20 left-4 z-30 md:hidden w-10 h-10 bg-indigo-600 text-white rounded-full shadow-lg flex items-center justify-center"
      >
        <Menu size={20} />
      </button>
      
      {/* å³ä¾§å†…å®¹åŒº */}
      <div className="flex-1 min-w-0 overflow-y-auto">
        <Outlet />
      </div>
    </div>
  );
};

/**
 * CompactFooter â€” ç™»å½•åçš„å¯æŠ˜å é¡µè„šï¼Œå†…å®¹ä¸æœªç™»å½•ä¸€è‡´ï¼Œé»˜è®¤æŠ˜å 
 */
const CompactFooter = () => {
  const [expanded, setExpanded] = useState(false);
  
  const handleToggle = useCallback(() => {
    setExpanded(prev => !prev);
  }, []);
  
  return (
    <footer className="border-t border-slate-100 bg-white relative z-10">
      {/* æŠ˜å è§¦å‘æ  */}
      <div className="px-2 md:px-4">
        <div className="max-w-full mx-auto flex items-center justify-between h-10">
          {!expanded && <p className="text-xs text-slate-400">Â© 2026 Devnors å¾—è‹¥æ™ºèƒ½ä½“. All rights reserved.</p>}
          <button 
            type="button"
            onClick={handleToggle}
            className={`flex items-center gap-1.5 text-xs text-slate-400 hover:text-indigo-600 transition-colors cursor-pointer select-none ${expanded ? 'ml-auto' : ''}`}
          >
            {expanded ? 'æ”¶èµ·' : 'å±•å¼€æ›´å¤š'}
            <ChevronDown size={12} className={`transition-transform duration-200 ${expanded ? 'rotate-180' : ''}`} />
          </button>
        </div>
      </div>
      
      {/* å®Œæ•´ footer å†…å®¹ â€” ä¸æœªç™»å½•æ—¶ä¸€è‡´ */}
      <div 
        className="overflow-hidden transition-all duration-300 ease-in-out"
        style={{ maxHeight: expanded ? '600px' : '0px', opacity: expanded ? 1 : 0 }}
      >
        <div className="pt-8 pb-6 border-t border-slate-100">
          <div className="max-w-full mx-auto px-2 md:px-4">
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-12 mb-8 md:mb-12">
              <div className="lg:col-span-4">
                <Link to="/" className="flex items-center gap-3 mb-6 group">
                  <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg group-hover:rotate-12 transition-transform">
                    <Zap className="text-white w-6 h-6" />
                  </div>
                  <span className="text-2xl font-black text-slate-900">Devnors <span className="text-indigo-600 text-sm font-normal">å¾—è‹¥</span></span>
                </Link>
                <p className="text-slate-500 text-sm leading-relaxed mb-6">AI åŸç”Ÿæ‹›è˜å¹³å°ã€‚åŠ©åŠ›äººæ‰å®ç°èŒä¸šæ¢¦æƒ³ï¼Œä¸ºä¼ä¸šç²¾å‡†æ¨èå…¨çƒç²¾è‹±ã€‚</p>
                <div className="flex items-center gap-4">
                  <a href="#" title="å¾®ä¿¡" className="w-10 h-10 bg-slate-100 rounded flex items-center justify-center text-slate-600 hover:bg-emerald-500 hover:text-white transition-all group">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 0 1 .213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.326.326 0 0 0 .167-.054l1.903-1.114a.864.864 0 0 1 .717-.098 10.16 10.16 0 0 0 2.837.403c.276 0 .543-.027.811-.05a6.582 6.582 0 0 1-.261-1.816c0-3.733 3.571-6.764 7.975-6.764.259 0 .51.02.761.04C17.46 4.539 13.46 2.188 8.69 2.188zm-2.6 4.408a1.09 1.09 0 0 1 1.092 1.089 1.09 1.09 0 0 1-1.092 1.089 1.09 1.09 0 0 1-1.093-1.09 1.09 1.09 0 0 1 1.093-1.088zm5.502 0a1.09 1.09 0 0 1 1.093 1.089 1.09 1.09 0 0 1-1.093 1.089 1.09 1.09 0 0 1-1.092-1.09 1.09 1.09 0 0 1 1.092-1.088zM16.216 9.05c-3.862 0-6.994 2.67-6.994 5.962 0 3.293 3.132 5.962 6.994 5.962.68 0 1.34-.086 1.975-.243a.723.723 0 0 1 .6.082l1.57.917a.271.271 0 0 0 .14.045c.132 0 .241-.11.241-.245 0-.06-.024-.118-.04-.176l-.322-1.218a.493.493 0 0 1 .177-.554C22.196 18.39 23.21 16.61 23.21 15.012c0-3.293-3.132-5.962-6.994-5.962zm-2.393 3.478a.907.907 0 1 1 0 1.814.907.907 0 0 1 0-1.814zm4.785 0a.907.907 0 1 1 0 1.814.907.907 0 0 1 0-1.814z"/></svg>
                  </a>
                  <a href="#" title="æŠ–éŸ³" className="w-10 h-10 bg-slate-100 rounded flex items-center justify-center text-slate-600 hover:bg-slate-900 hover:text-white transition-all group">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19.589 6.686a4.793 4.793 0 0 1-3.77-4.245V2h-3.445v13.672a2.896 2.896 0 0 1-5.201 1.743l-.002-.001a2.895 2.895 0 0 1 3.183-4.51v-3.5a6.329 6.329 0 0 0-5.394 10.692 6.33 6.33 0 0 0 10.857-4.424V8.687a8.182 8.182 0 0 0 4.773 1.526V6.79a4.831 4.831 0 0 1-1.001-.104z"/></svg>
                  </a>
                  <a href="#" title="å°çº¢ä¹¦" className="w-10 h-10 bg-slate-100 rounded flex items-center justify-center text-slate-600 hover:bg-rose-500 hover:text-white transition-all group">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.5 7h-2.03l.52-2.5H13.4l-.52 2.5h-1.86l.52-2.5H9.95l-.52 2.5H7.5v1.5h1.57l-.42 2H6.5v1.5h1.8L7.77 16.5h1.59l.52-2.5h1.86l-.52 2.5h1.59l.52-2.5H16.5V13h-2.03l.42-2H16.5V9.5zm-4.09 4h-1.86l.42-2h1.86l-.42 2z"/></svg>
                  </a>
                  <a href="#" title="è½»è¯†" className="w-10 h-10 bg-slate-100 rounded flex items-center justify-center text-slate-600 hover:bg-indigo-500 hover:text-white transition-all group">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/></svg>
                  </a>
                </div>
              </div>
              <div className="lg:col-span-7 lg:col-start-7">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-12">
                  <div>
                    <h4 className="text-sm font-black text-slate-900 mb-4 uppercase tracking-wider">äº§å“</h4>
                    <div className="space-y-3">
                      <Link to="/products" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">Hire Agent</Link>
                      <Link to="/solutions" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">è§£å†³æ–¹æ¡ˆ</Link>
                      <Link to="/models" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">Agent æŠ€æœ¯</Link>
                      <Link to="/pricing" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">å®šä»·æ–¹æ¡ˆ</Link>
                    </div>
                  </div>
                  <div>
                    <h4 className="text-sm font-black text-slate-900 mb-4 uppercase tracking-wider">æ³•å¾‹</h4>
                    <div className="space-y-3">
                      <Link to="/terms" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">æœåŠ¡æ¡æ¬¾</Link>
                      <Link to="/privacy" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">éšç§æ”¿ç­–</Link>
                      <Link to="/personal-info" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">ä¸ªäººä¿¡æ¯ä¿æŠ¤</Link>
                      <Link to="/algorithm" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">ç®—æ³•è¯´æ˜</Link>
                      <Link to="/copyright" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">ç‰ˆæƒå£°æ˜</Link>
                      <Link to="/minor-protection" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">æœªæˆå¹´äººä¿æŠ¤</Link>
                    </div>
                  </div>
                  <div>
                    <h4 className="text-sm font-black text-slate-900 mb-4 uppercase tracking-wider">æ”¯æŒ</h4>
                    <div className="space-y-3">
                      <Link to="/about" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">å…³äºæˆ‘ä»¬</Link>
                      <Link to="/tokens" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">èµ„é‡‘è´¦æˆ·</Link>
                      <Link to="/help" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">å¸®åŠ©ä¸­å¿ƒ</Link>
                      <Link to="/feedback" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">åé¦ˆå»ºè®®</Link>
                      <Link to="/changelog" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">ç‰ˆæœ¬æ›´æ–°</Link>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div className="pt-6 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
              <p className="text-xs text-slate-400">Â© 2026 Devnors å¾—è‹¥æ™ºèƒ½ä½“. All rights reserved.</p>
              <p className="text-xs text-slate-400 uppercase tracking-tighter">Powered by Devnors Multi-Agent Synergy</p>
            </div>
          </div>
        </div>
      </div>
    </footer>
  );
};

// ä¸»åº”ç”¨å†…å®¹ç»„ä»¶
// è·¯ç”±åˆ‡æ¢æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
const ScrollToTop = () => {
  const { pathname } = useLocation();
  useEffect(() => {
    window.scrollTo(0, 0);
  }, [pathname]);
  return null;
};

const AppContent = () => {
  const [isDarkMode, setIsDarkMode] = useState(() => {
    try { return localStorage.getItem('devnors_dark_mode') === 'true'; } catch { return false; }
  });
  const [tokenModalShow, setTokenModalShow] = useState(false);
  const [tokenModalBalance, setTokenModalBalance] = useState(0);
  const { isLoggedIn, userRole, user } = useAuth();

  useEffect(() => {
    const unsub = tokenInsufficientEvent.on((balance) => {
      setTokenModalBalance(balance);
      setTokenModalShow(true);
    });
    return unsub;
  }, []);

  useEffect(() => {
    if (isDarkMode) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
    localStorage.setItem('devnors_dark_mode', String(isDarkMode));
  }, [isDarkMode]);

  const toggleDarkMode = () => {
    // æ·»åŠ è¿‡æ¸¡ classï¼Œè®©æ‰€æœ‰é¢œè‰²å¹³æ»‘åˆ‡æ¢
    document.documentElement.classList.add('theme-transition');
    // è§¦å‘å›¾æ ‡åŠ¨ç”»
    document.querySelectorAll('.theme-icon-spin').forEach(el => {
      el.classList.remove('theme-icon-animate');
      void (el as HTMLElement).offsetWidth; // å¼ºåˆ¶ reflow é‡æ–°è§¦å‘
      el.classList.add('theme-icon-animate');
    });
    const newVal = !isDarkMode;
    setIsDarkMode(newVal);
    // è¿‡æ¸¡ç»“æŸåç§»é™¤ class
    setTimeout(() => {
      document.documentElement.classList.remove('theme-transition');
      document.querySelectorAll('.theme-icon-spin').forEach(el => el.classList.remove('theme-icon-animate'));
    }, 600);
    if (user?.id) {
      import('./services/apiService').then(m => {
        m.updateSettings({ dark_mode: newVal }, user.id).catch(() => {});
      });
    }
  };

  // éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„è·¯ç”±å®ˆå«
  const RequireAuth = ({ children }: { children: React.ReactElement }) => {
    const { isLoggedIn } = useAuth();
    const navigate = useNavigate();
    if (!isLoggedIn) {
      return (
        <div className="pt-20 pb-12 px-4 md:pt-32 md:pb-20 md:px-6 max-w-lg mx-auto animate-in fade-in duration-500">
          <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-10 text-center">
            <div className="w-16 h-16 rounded-2xl bg-indigo-50 flex items-center justify-center mx-auto mb-5">
              <Lock size={28} className="text-indigo-400" />
            </div>
            <h2 className="text-xl font-black text-slate-900 mb-2">éœ€è¦ç™»å½•</h2>
            <p className="text-sm text-slate-500 mb-6">è¯·å…ˆç™»å½•åæŸ¥çœ‹æ­¤é¡µé¢å†…å®¹</p>
            <button
              onClick={() => navigate('/login')}
              className="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-sm transition-all shadow-lg shadow-indigo-200/50"
            >
              å‰å¾€ç™»å½•
            </button>
          </div>
        </div>
      );
    }
    return children;
  };

  return (
    <div className={`min-h-screen flex flex-col ${isDarkMode ? 'dark' : ''}`}>
      <ScrollToTop />
      <TokenInsufficientModal show={tokenModalShow} balance={tokenModalBalance} onClose={() => setTokenModalShow(false)} />
      <Navbar isDarkMode={isDarkMode} toggleDarkMode={toggleDarkMode} />
      <main className="flex-1">
        <Routes>
          {/* å…¬å¼€é¡µé¢ */}
          <Route path="/" element={<LandingPage />} />
          <Route path="/login" element={<LoginView />} />
          <Route path="/register" element={<LoginView />} />
          <Route path="/select-role" element={<RoleSelectionView />} />
          <Route path="/changelog" element={<ChangelogView />} />
          <Route path="/privacy" element={<PrivacyPolicyView />} />
          <Route path="/terms" element={<TermsOfServiceView />} />
          <Route path="/copyright" element={<CopyrightView />} />
          <Route path="/algorithm" element={<AlgorithmDisclosureView />} />
          <Route path="/personal-info" element={<PersonalInfoProtectionView />} />
          <Route path="/minor-protection" element={<MinorProtectionView />} />
          <Route path="/complaint" element={<ComplaintGuideView />} />
          <Route path="/about" element={<AboutUsView />} />
          <Route path="/pricing" element={<PricingView />} />
          <Route path="/products" element={<ProductsPage />} />
          <Route path="/solutions" element={<SolutionsPage />} />
          <Route path="/models" element={<ModelsPage />} />
          <Route path="/help" element={<HelpCenterView />} />
          {/* éœ€è¦ç™»å½•çš„é¡µé¢ â€”â€” å·¦å³ç»“æ„å¸ƒå±€ */}
          <Route element={<RequireAuth><DashboardLayout /></RequireAuth>}>
            <Route path="/workbench" element={<WorkbenchView />} />
            <Route path="/workbench/todos" element={<TodoListView />} />
            <Route path="/workbench/todo/:todoId" element={<TodoDetailView />} />
            <Route path="/workbench/flow/:flowId" element={<FlowDetailView />} />
            <Route path="/candidate" element={<CandidateView />} />
            <Route path="/candidate/resume" element={<CandidateResumeDetail />} />
            <Route path="/candidate/home" element={<CandidateHomeView />} />
            <Route path="/candidate/memory" element={<CandidateMemoryView />} />
            <Route path="/candidate/profile" element={<CandidateProfileView />} />
            <Route path="/candidate/apply" element={<ApplyDetailView />} />
            <Route path="/candidate/jobs" element={<JobRecommendListView />} />
            <Route path="/candidate/job/:jobId" element={<JobDetailView />} />
            <Route path="/candidate/delivery" element={<AIDeliveryView />} />
            <Route path="/employer" element={<EmployerDashboard />} />
            <Route path="/employer/memory" element={<EnterpriseMemoryView />} />
            <Route path="/employer/home" element={<EnterpriseHomeView />} />
            <Route path="/employer/talent/:talentId" element={<TalentDetailView />} />
            <Route path="/employer/post" element={<JobManagementView />} />
            <Route path="/employer/post/:postId" element={<JobPostDetailView />} />
            <Route path="/employer/talent-pool" element={<TalentPoolView />} />
            <Route path="/invite" element={<InviteFriendView />} />
            <Route path="/memory/input" element={<MemoryInputView />} />
            <Route path="/tokens" element={<TokenManagementView />} />
            <Route path="/notifications" element={<NotificationCenterView />} />
            <Route path="/feedback" element={<FeedbackView />} />
            <Route path="/settings" element={<SettingsManagementView isDarkMode={isDarkMode} toggleDarkMode={toggleDarkMode} />} />
          </Route>
          {/* å…¬å¼€çš„å€™é€‰äºº profile é¡µé¢ */}
          <Route path="/candidate/profile/:candidateId" element={<PublicCandidateProfileView />} />
          {/* AI Assistant ä¿æŒç‹¬ç«‹å…¨å±å¸ƒå±€ */}
          <Route path="/ai-assistant" element={<RequireAuth><AIAssistantView /></RequireAuth>} />
        </Routes>
      </main>
        
        {isLoggedIn ? (
          <CompactFooter />
        ) : (
          <footer className="pt-12 pb-6 border-t border-slate-100 bg-white">
            <div className="max-w-7xl mx-auto px-4 md:px-6">
              <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-12 mb-8 md:mb-12">
                <div className="lg:col-span-4">
                  <Link to="/" className="flex items-center gap-3 mb-6 group">
                    <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg group-hover:rotate-12 transition-transform">
                      <Zap className="text-white w-6 h-6" />
                    </div>
                    <span className="text-2xl font-black text-slate-900">Devnors <span className="text-indigo-600 text-sm font-normal">å¾—è‹¥</span></span>
                  </Link>
                  <p className="text-slate-500 text-sm leading-relaxed mb-6">AI åŸç”Ÿæ‹›è˜å¹³å°ã€‚åŠ©åŠ›äººæ‰å®ç°èŒä¸šæ¢¦æƒ³ï¼Œä¸ºä¼ä¸šç²¾å‡†æ¨èå…¨çƒç²¾è‹±ã€‚</p>
                  <div className="flex items-center gap-4">
                    <a href="#" title="å¾®ä¿¡" className="w-10 h-10 bg-slate-100 rounded flex items-center justify-center text-slate-600 hover:bg-emerald-500 hover:text-white transition-all group">
                      <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 0 1 .213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.326.326 0 0 0 .167-.054l1.903-1.114a.864.864 0 0 1 .717-.098 10.16 10.16 0 0 0 2.837.403c.276 0 .543-.027.811-.05a6.582 6.582 0 0 1-.261-1.816c0-3.733 3.571-6.764 7.975-6.764.259 0 .51.02.761.04C17.46 4.539 13.46 2.188 8.69 2.188zm-2.6 4.408a1.09 1.09 0 0 1 1.092 1.089 1.09 1.09 0 0 1-1.092 1.089 1.09 1.09 0 0 1-1.093-1.09 1.09 1.09 0 0 1 1.093-1.088zm5.502 0a1.09 1.09 0 0 1 1.093 1.089 1.09 1.09 0 0 1-1.093 1.089 1.09 1.09 0 0 1-1.092-1.09 1.09 1.09 0 0 1 1.092-1.088zM16.216 9.05c-3.862 0-6.994 2.67-6.994 5.962 0 3.293 3.132 5.962 6.994 5.962.68 0 1.34-.086 1.975-.243a.723.723 0 0 1 .6.082l1.57.917a.271.271 0 0 0 .14.045c.132 0 .241-.11.241-.245 0-.06-.024-.118-.04-.176l-.322-1.218a.493.493 0 0 1 .177-.554C22.196 18.39 23.21 16.61 23.21 15.012c0-3.293-3.132-5.962-6.994-5.962zm-2.393 3.478a.907.907 0 1 1 0 1.814.907.907 0 0 1 0-1.814zm4.785 0a.907.907 0 1 1 0 1.814.907.907 0 0 1 0-1.814z"/></svg>
                    </a>
                    <a href="#" title="æŠ–éŸ³" className="w-10 h-10 bg-slate-100 rounded flex items-center justify-center text-slate-600 hover:bg-slate-900 hover:text-white transition-all group">
                      <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19.589 6.686a4.793 4.793 0 0 1-3.77-4.245V2h-3.445v13.672a2.896 2.896 0 0 1-5.201 1.743l-.002-.001a2.895 2.895 0 0 1 3.183-4.51v-3.5a6.329 6.329 0 0 0-5.394 10.692 6.33 6.33 0 0 0 10.857-4.424V8.687a8.182 8.182 0 0 0 4.773 1.526V6.79a4.831 4.831 0 0 1-1.001-.104z"/></svg>
                    </a>
                    <a href="#" title="å°çº¢ä¹¦" className="w-10 h-10 bg-slate-100 rounded flex items-center justify-center text-slate-600 hover:bg-rose-500 hover:text-white transition-all group">
                      <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.5 7h-2.03l.52-2.5H13.4l-.52 2.5h-1.86l.52-2.5H9.95l-.52 2.5H7.5v1.5h1.57l-.42 2H6.5v1.5h1.8L7.77 16.5h1.59l.52-2.5h1.86l-.52 2.5h1.59l.52-2.5H16.5V13h-2.03l.42-2H16.5V9.5zm-4.09 4h-1.86l.42-2h1.86l-.42 2z"/></svg>
                    </a>
                    <a href="#" title="è½»è¯†" className="w-10 h-10 bg-slate-100 rounded flex items-center justify-center text-slate-600 hover:bg-indigo-500 hover:text-white transition-all group">
                      <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/></svg>
                    </a>
                  </div>
                </div>
                <div className="lg:col-span-7 lg:col-start-7">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-12">
                    <div>
                      <h4 className="text-sm font-black text-slate-900 mb-4 uppercase tracking-wider">äº§å“</h4>
                      <div className="space-y-3">
                        <Link to="/products" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">Hire Agent</Link>
                        <Link to="/solutions" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">è§£å†³æ–¹æ¡ˆ</Link>
                        <Link to="/models" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">Agent æŠ€æœ¯</Link>
                        <Link to="/pricing" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">å®šä»·æ–¹æ¡ˆ</Link>
                      </div>
                    </div>
                    <div>
                      <h4 className="text-sm font-black text-slate-900 mb-4 uppercase tracking-wider">æ³•å¾‹</h4>
                      <div className="space-y-3">
                        <Link to="/terms" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">æœåŠ¡æ¡æ¬¾</Link>
                        <Link to="/privacy" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">éšç§æ”¿ç­–</Link>
                        <Link to="/personal-info" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">ä¸ªäººä¿¡æ¯ä¿æŠ¤</Link>
                        <Link to="/algorithm" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">ç®—æ³•è¯´æ˜</Link>
                        <Link to="/copyright" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">ç‰ˆæƒå£°æ˜</Link>
                        <Link to="/minor-protection" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">æœªæˆå¹´äººä¿æŠ¤</Link>
                      </div>
                    </div>
                    <div>
                      <h4 className="text-sm font-black text-slate-900 mb-4 uppercase tracking-wider">æ”¯æŒ</h4>
                      <div className="space-y-3">
                        <Link to="/about" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">å…³äºæˆ‘ä»¬</Link>
                        <Link to="/tokens" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">èµ„é‡‘è´¦æˆ·</Link>
                        <Link to="/help" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">å¸®åŠ©ä¸­å¿ƒ</Link>
                        <Link to="/feedback" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">åé¦ˆå»ºè®®</Link>
                        <Link to="/changelog" className="block text-sm text-slate-500 hover:text-indigo-600 transition-colors">ç‰ˆæœ¬æ›´æ–°</Link>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div className="pt-6 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                <p className="text-xs text-slate-400">Â© 2026 Devnors å¾—è‹¥æ™ºèƒ½ä½“. All rights reserved.</p>
                <p className="text-xs text-slate-400 uppercase tracking-tighter">Powered by Devnors Multi-Agent Synergy</p>
              </div>
            </div>
          </footer>
        )}
      </div>
  );
};

// App ç»„ä»¶ - åŒ…è£¹ AuthProvider å’Œ Router
const App = () => {
  return (
    <Router>
      <AuthProvider>
        <AppContent />
      </AuthProvider>
    </Router>
  );
};

// --- æ±‚èŒç®€å†ç®¡ç†é¡µ (ä¾›äººæ‰ç«¯ä½¿ç”¨) ---
const CandidateResumeDetail = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const profile = location.state?.profile as CandidateProfile;

  if (!profile) return (
    <div className="pt-20 text-center">
       <p className="text-slate-400 font-bold mb-4">æœªæ‰¾åˆ°ç®€å†æ•°æ®</p>
       <button onClick={() => navigate('/candidate')} className="bg-indigo-600 text-white px-6 py-2 rounded">è¿”å›ä¸Šä¼ </button>
    </div>
  );

  return (
    <div className="py-6 px-4 md:py-8 md:px-6 max-w-5xl mx-auto">
      <div className="flex justify-between items-center mb-8">
        <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-slate-500 hover:text-indigo-600 font-black transition-colors">
          <ChevronLeft size={20} /> è¿”å›
        </button>
        <div className="flex gap-4">
          <button onClick={() => window.print()} className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold">
            <Download size={16} /> å¯¼å‡º PDF
          </button>
        </div>
      </div>
      <div className="bg-white rounded border border-slate-100 shadow-2xl overflow-hidden p-16">
        <div className="flex items-center gap-8 mb-12">
           <div className="w-24 h-24 bg-indigo-600 text-white flex items-center justify-center text-4xl font-black rounded-lg">{profile.name.charAt(0)}</div>
           <div>
              <h1 className="text-5xl font-black mb-2">{profile.name}</h1>
              <p className="text-indigo-600 font-black text-xl">{profile.role}</p>
           </div>
        </div>
        <div className="space-y-12">
           <section>
              <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">ä¸ªäººç®€è¿°</h3>
              <p className="text-xl text-slate-700 leading-relaxed font-medium">{profile.summary}</p>
           </section>
           <section className="grid grid-cols-1 md:grid-cols-2 gap-10">
              <div>
                 <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">ä¸“ä¸šæŠ€èƒ½æ¸…å•</h3>
                 <div className="flex flex-wrap gap-2">
                    {profile.skills.map((s, i) => <span key={i} className="px-3 py-1 bg-slate-50 text-slate-500 text-xs font-bold rounded-lg border border-slate-100">{s}</span>)}
                 </div>
              </div>
              <div>
                 <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">ç”»åƒæ”¹è¿›æ–¹å‘</h3>
                 <ul className="space-y-2">
                    {profile.optimizationSuggestions?.map((s, i) => (
                      <li key={i} className="text-sm text-slate-600 font-medium flex items-center gap-2">
                         <div className="w-1.5 h-1.5 bg-indigo-500 rounded-full"></div> {s}
                      </li>
                    ))}
                 </ul>
              </div>
           </section>
        </div>
      </div>
    </div>
  );
};

export default App;
